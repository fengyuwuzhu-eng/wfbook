# 使用

## 守护进程

ClamAV 守护程序 （[`clamd`](https://docs.clamav.net/manual/Usage/Scanning.html#clamd) ）是一个多线程守护程序，它使用 *libclamav* [ 扫描文件以查找病毒 ](https://docs.clamav.net/manual/Usage/Scanning.html)。ClamAV 提供了许多与此守护进程交互的工具。它们是：

- [`clamdscan`](https://docs.clamav.net/manual/Usage/Scanning.html#clamdscan) - 一个简单的扫描客户端
- [`on-access scanning`](https://docs.clamav.net/manual/Usage/Scanning.html#On-access-scanning) - 通过 `clamd` 实例提供实时保护
- [`clamdtop`](https://docs.clamav.net/manual/Usage/Scanning.html#clamdtop) - `Clamd` 的资源监控接口

## Scanner 扫描器

ClamAV 还提供了一个命令行工具，用于使用 *libclamav* [ 进行简单的扫描](https://docs.clamav.net/manual/Usage/Scanning.html)任务，称为 [`clamscan`](https://docs.clamav.net/manual/Usage/Scanning.html#clamscan)。与守护程序不同，`clamscan` 不是一个持久性进程，最适合需要以最少设置进行一次性扫描的使用案例。

## Signature Testing and Management 签名测试和管理

许多工具允许[对签名进行测试和管理 ](https://docs.clamav.net/manual/Usage/SignatureManagement.html)。值得注意的是以下内容：

- [`clambc`](https://docs.clamav.net/manual/Usage/SignatureManagement.html#clambc) - 专门用于测试字节码
- [`sigtool`](https://docs.clamav.net/manual/Usage/SignatureManagement.html#sigtool) - 用于一般特征测试和分析
- [`Freshclam`](https://docs.clamav.net/manual/Usage/SignatureManagement.html#freshclam) - 用于将签名数据库集更新到最新版本

## 配置

ClamAV 提供的更复杂的工具都需要一定程度的[配置 ](https://docs.clamav.net/manual/Usage/Configuration.html)。ClamAV 提供了两个示例配置文件：

- [`clamd.conf`](https://docs.clamav.net/manual/Usage/Configuration.html#clamdconf) - 用于配置 ClamAV 守护程序 `clamd` 和相关工具的行为
- [`freschclam.conf`](https://docs.clamav.net/manual/Usage/Configuration.html#freshclamconf) - 用于配置签名数据库更新工具 `freshclam` 的行为

ClamAV 还提供了一个名为 [`clamav-milter`](https://docs.clamav.net/manual/Usage/Configuration.html#clamav-milterconf) 的邮件过滤工具，该工具可以附加到 `clamd` 实例以进行邮件扫描。

此外，一个名为 [`clamconf`](https://docs.clamav.net/manual/Usage/Configuration.html#clamconf) 的工具允许用户检查其他工具使用的配置，从上面列出的配置文件中提取信息以及其他相关信息。

### 首次设置

根据安装方法和操作系统，某些配置选项可能已预先配置。例如，在 Ubuntu 上使用 `apt install` 安装 clamav 会将配置放在 `/etc/clamav` 中。

但是，可能需要创建新的配置文件或使用最适合您的使用案例的自定义设置修改现有配置文件。从源安装需要先创建 `freshclam.conf` 才能使用 FreshClam ，先创建 `clamd.conf` 才能使用 ClamD，先创建 `clamav-milter.conf` 才能使用 ClamAV-Milter 。

从源码进行默认安装会将示例配置放在 Unix/Linux 系统的 `/usr/local/etc/` 中，以及 Windows 上安装目录下的 `conf_examples` 中。这些示例演示了每个选项，并可能有助于您决定如何配置 ClamAV 以满足您的需要。但同样，这些示例的位置可能会因您安装 ClamAV 的方式而异。继续以 Ubuntu 示例，可以在 `apt install` 的 `/usr/share/doc/clamav-freshclam/examples/` 中找到 FreshClam 配置。因此，如果你不确定这些示例配置在你的系统上的位置，可能希望使用 [ClamConf](https://docs.clamav.net/manual/Usage/Configuration.html#clamconf) 来生成它们。

#### Unix

如果需要，运行这些以生成示例配置：

```bash
clamconf -g freshclam.conf > freshclam.conf
clamconf -g clamd.conf > clamd.conf
clamconf -g clamav-milter.conf > clamav-milter.conf
```

或者，如果已经有示例，请复制它们以删除 `.example` 扩展名：

```bash
cp freshclam.conf.example freshclam.conf
cp clamd.conf.example clamd.conf
cp clamav-milter.conf.example clamav-milter.conf
```

接下来，编辑您需要的配置。以下是针对 [freshclam.conf](https://docs.clamav.net/manual/Usage/Configuration.html#freshclamconf)、[clamd.conf](https://docs.clamav.net/manual/Usage/Configuration.html#clamdconf) 和 [clamav-milter](https://docs.clamav.net/manual/Usage/Configuration.html#clamav-milterconf) 的提示。

#### Windows

在安装目录的 PowerShell 终端中，执行以下任务：

```powershell
copy .\conf_examples\freshclam.conf.sample .\freshclam.conf
copy .\conf_examples\clamd.conf.sample .\clamd.conf
write.exe .\freshclam.conf
```

写字板将弹出。删除显示 “Example” 的行。您可能还希望设置其他选项来启用功能或更改默认行为，例如 receive-timeout 。保存文件并关闭写字板。

```powershell
write.exe .\clamd.conf
```

写字板将弹出。删除显示 “Example” 的行。您可能还希望设置其他选项以启用功能或更改默认行为，例如启用日志记录。保存文件并关闭写字板。

##### 有关配置文件和数据库目录的其他说明

安装目录只是 ClamAV 可能搜索配置和签名数据库的少数几个位置之一。

配置文件路径搜索顺序：

1. 注册表项的内容：“HKEY_LOCAL_MACHINE/Software/ClamAV/ConfDir”
2. libclamav.dll 所在的目录：“C:\Program Files\ClamAV”
3. "C:\ClamAV"

数据库文件路径搜索顺序：

1. 注册表项的内容：“HKEY_LOCAL_MACHINE/Software/ClamAV/DataDir”
2. libclamav.dll 所在目录内的 “database” 目录：“C:\Program Files\ClamAV\database”
3. "C:\ClamAV\db"

### freshclam.conf

`freshclam` 是 Clam AntiVirus 的自动数据库更新工具。它可以配置为在两种模式下工作：

- interactive - on demand from command line从命令行按需提供
- daemon - 在后台静默

it supports scripted updates (instead of  transferring the whole CVD file at each update it only transfers the  differences between the latest and the current database via a special  script), database version checks through DNS, proxy servers (with  authentication), digital signatures and various error scenarios.
`freshclam` 是一个高级工具：它支持脚本更新（而不是在每次更新时传输整个 CVD 文件，它只通过特殊脚本传输最新数据库和当前数据库之间的差异）、通过 DNS 检查数据库版本、代理服务器（带身份验证）、数字签名和各种错误场景。

**快速测试：不带参数运行 freshclam （以超级用户身份） 并检查输出。**

```bash
freshclam
```

> *提示* ：根据 Freshclam 的安装方式以及 ClamAV 的版本，首次运行 Freshclam 时可能会遇到错误。

If everything is OK you may create the log file in /var/log (ensure the directory is owned either by *clamav* or whichever user `freshclam` will be running as):
如果一切正常，可以在 /var/log 中创建日志文件（确保该目录由 *clamav* 或任何 `freshclam` 将要运行的用户拥有）：

```bash
touch /var/log/freshclam.log
chmod 600 /var/log/freshclam.log
chown clamav /var/log/freshclam.log
```

> *Tip*: If SELinux is enabled you probably need to set the right SELinux  context on this newly created file, otherwise freshclam service won't be able to access this file. On Redhat-like systems, you should do `restorecon /var/log/freshclam.log`.
> *提示* ： 如果启用了 SELinux，可能需要在这个新创建的文件上设置正确的 SELinux 上下文，否则 freshclam 服务将无法访问这个文件。在类似 Redhat 的系统上，应该执行 `restorecon /var/log/freshclam.log` 。

Now you *should* edit the configuration file `freshclam.conf` and point the *UpdateLogFile* directive to the log file. Finally, to run `freshclam` in the daemon mode, execute:
现在*你应该编辑*配置文件 `freshclam.conf` 并将 *UpdateLogFile* 指令指向日志文件。最后，要在守护进程模式下运行 `freshclam`，请执行：

```
freshclam -d
```

另一种方法是使用 *cron* 守护进程。必须将以下行添加到 **root** 或 **clamav** 用户的 *crontab* 中：

```bash
N * * * *   /usr/local/bin/freshclam --quiet
```

to check for a new database every hour. **N should be a number between 3 and 57 of your choice. Please don’t choose any multiple of 10, because there are already too many clients using  those time slots.** Proxy settings are only configurable via the configuration file and `freshclam` will require strict permission settings for the config file when `HTTPProxyPassword` is turned on.
以每小时检查一次新数据库。**N 应该是您选择的介于 3 和 57 之间的数字。请不要选择 10 的倍数，因为使用这些时间段的客户已经太多了。** 代理设置只能通过配置文件进行配置，当 `HTTPProxyPassword` 开启时，`freshclam` 将需要对配置文件进行严格的权限设置。

```ini
HTTPProxyServer myproxyserver.com
HTTPProxyPort 1234
HTTPProxyUsername myusername
HTTPProxyPassword mypass
```

#### 其他 freshclam.conf 设置

如果你的 `freshclam.conf` 是从 `freshclam.conf.sample` 衍生而来的，应该会发现很多其他选项都被简单地注释掉了。如果没有，请查找 `freshclam.conf.sample` 文件，或者在 Linux/Unix 系统上运行 `man freshclam.conf` 。

花点时间浏览一下选项。可以通过删除 `#` 注释字符来启用示例选项。

一些流行的启用选项包括：

- `LogTime`
- `LogRotate`
- `NotifyClamd`
- `DatabaseOwner`

### clamd.conf

目前，ClamAV 要求用户先编辑 `clamd.conf.example` 文件，然后才能运行守护进程。用户至少需要注释掉 “Example” 这一行，否则 `clamd` 会认为配置无效：

```bash
# Comment or remove the line below.
#Example
```

还需要通过以下方式将 `clamd.conf.example` 重命名为 `clamd.conf`：

```bash
mv ./clamd.conf.example ./clamd.conf
```

If you are setting up a simple, local [`clamd` instance](https://docs.clamav.net/manual/Usage/Scanning.html#clamd) then some other configuration options of interests to you will be as follows:
如果您正在设置一个简单的本地 [`clamd` 实例 ](https://docs.clamav.net/manual/Usage/Scanning.html#clamd)，那么您感兴趣的其他一些配置选项将如下所示：

```

# Path to a local socket file the daemon will listen on.
# Default: disabled (must be specified by a user)
LocalSocket /tmp/clamd.socket

...

# Sets the permissions on the unix socket to the specified mode.
# Default: disabled (socket is world accessible)
LocalSocketMode 660
```

Beyond that, `clamd.conf` is well commented and configuration should be straightforward.
除此之外，`clamd.conf` 的注释也很好，配置应该很简单。

If needed, you can find out even more about the formatting and options available in `clamd.conf` with the command:
如果需要，您可以使用以下命令了解有关 `clamd.conf` 中可用的格式和选项的更多信息：

```

man clamd.conf
```

#### 其他 clamd.conf 设置

If your `clamd.conf` was derived from the `clamd.conf.sample`, you should find many other options that are simply commented out. If not, seek out the `clamd.conf.sample` file, or on Linux/Unix systems run `man clamd.conf`.
如果您的 `clamd.conf` 是从 `clamd.conf.sample` 派生而来的，您应该会发现许多其他选项都被简单地注释掉了。如果没有，请查找 `clamd.conf.sample` 文件，或者在 Linux/Unix 系统上运行 `man clamd.conf`。

Take the time to look through the options. You can enable the sample options by deleting the `#` comment characters.
花点时间浏览一下选项。您可以通过删除 `#` 注释字符来启用示例选项。

Some popular options to enable include:
一些流行的启用选项包括：

- `LogTime` `日志时间`

- `LogClean` `日志清理`

- `LogRotate` `对数旋转`

- `User` `用户`

- ```
  ScanOnAccess
  ```

   `ScanOnAccess` 扫描

  - `OnAccessIncludePath`
  - `OnAccessExcludePath`
  - `OnAccessPrevention`

#### [On-Access Scanning 按访问扫描](https://docs.clamav.net/manual/Usage/Configuration.html#on-access-scanning)

You can configure On-Access Scanning through `clamd.conf`. Configuration for On-Access Scanning starts in the second half of `clamd.conf.sample` starting with "On-access Scan Settings". All options are grouped  acording to use and roughly ordered by importance in those groupings.  Please carefully read the explanation of each option to see if it might  be of use to you.
您可以通过 `clamd.conf` 配置按访问扫描。按访问扫描的配置从 `clamd.conf.sample` 的后半部分开始，从“按访问扫描设置”开始。所有选项都根据使用进行分组，并在这些分组中按重要性大致排序。请仔细阅读每个选项的解释，看看它是否对您有用。

Also read the [on-access](https://docs.clamav.net/manual/OnAccess.html) section of the Usage manual for further details on using On-Access Scanning.
另请参阅使用手册的[按访问](https://docs.clamav.net/manual/OnAccess.html)部分，了解有关使用按访问扫描的更多详细信息。

### clamav-milter.conf

ClamAV includes a mail filtering tool called `clamav-milter`. This tool interfaces directly with `clamd`, and thus requires a working [`clamd` instance](https://docs.clamav.net/manual/Usage/Scanning.html#clamd) to run. However, `clamav-milter`'s configuration and log files are separate from that of `clamd`.
ClamAV 包括一个名为 `clamav-milter` 的邮件过滤工具。此工具直接与 `clamd` 交互，因此需要一个正常工作的 [`clamd` 实例](https://docs.clamav.net/manual/Usage/Scanning.html#clamd)才能运行。但是，`clamav-milter` 的配置和日志文件与 `clamd` 的配置文件是分开的。

Ensuring ClamAV compiles with `clamav-milter` must be done at configure time with the command:
确保 ClamAV 与 `clamav-milter` 一起编译必须在 configure 时使用命令完成：

```

./configure [options] --enable-milter
```

This requires having the milter library installed on your system. If *libmilter* is not installed, `./configure` will exit with this error message:
这需要在系统上安装 milter 库。如果未安装 *libmilter*，`./configure` 将退出并显示以下错误消息：

```

checking for mi_stop in -lmilter... no
configure: error: Cannot find libmilter
```

While not necessarily *complicated*, setting up the `clamav-milter` is an involved process. Thus, we recommend consulting your MTA’s manual on how to best connect ClamAV with the `clamav-milter`.
虽然不一定*复杂* ，但设置 `clamav-milter` 是一个复杂的过程。因此，我们建议您查阅 MTA 的手册，了解如何最好地将 ClamAV 与 `clamav-milter` 连接起来。

#### [Users and on user privileges 用户和用户权限](https://docs.clamav.net/manual/Usage/Configuration.html#users-and-on-user-privileges)

If you are running `freshclam` and `clamd` as root or with `sudo`, and you did not explicitly configure with `--disable-clamav`, you will want to ensure that the `DatabaseOwner` user specified in `freshclam.conf` owns the database directory so it can download signature updates.
如果你以 root 或 `sudo` 身份运行 `freshclam` 和 `clamd`，并且没有明确使用 `--disable-clamav` 进行配置，你需要确保 `freshclam.conf` 中指定的 `DatabaseOwner` 用户拥有数据库目录，以便它可以下载签名更新。

The user that `clamd`, `clamdscan`, and `clamscan` run as may be the same user, but if it isn't -- it merely needs *read* access to the database directory.
运行 `clamd`、`clamdscan` 和 `clamscan` 的用户可能是同一个用户，但如果不是 -- 它只需要对数据库目录的*读取*权限。

If you choose to use the default `clamav` user to run `freshclam` and `clamd`, you'll need to create the clamav group and the clamav user account the first time you install ClamAV.
如果你选择使用默认的 `clamav` 用户来运行 `freshclam` 和 `clamd`，则需要在第一次安装 ClamAV 时创建 clamav 组和 clamav 用户账户。

```

groupadd clamav
useradd -g clamav -s /bin/false -c "Clam Antivirus" clamav
```

Finally, you will want to set user ownership of the database directory. For example:
最后，您需要设置数据库目录的用户所有权。例如：

```

sudo chown -R clamav:clamav /usr/local/share/clamav
```

### 为 ClamAV 配置 SELinux

Certain distributions (notably RedHat variants) when operating with SELinux enabled use the non-standard `antivirus_can_scan_system` SELinux option instead of `clamd_can_scan_system`.
某些发行版（特别是 RedHat 变体）在启用 SELinux 的情况下运行时，使用非标准 `antivirus_can_scan_system` SELinux 选项，而不是 `clamd_can_scan_system`。

At this time, libclamav only sets the `clamd_can_scan_system` option, so you may need to manually enable `antivirus_can_scan_system`. If you don't perform this step, `freshclam` will log something like this when it tests the newly downloaded signature databases:
此时 libclamav 只设置`了 clamd_can_scan_system` 选项，因此你可能需要手动启用 `antivirus_can_scan_system`。如果你不执行此步骤，`freshclam` 在测试新下载的签名数据库时，会记录如下内容：

```

During database load : LibClamAV Warning: RWX mapping denied: Can't allocate RWX Memory: Permission denied
```

To allow ClamAV to operate under SELinux, run the following:
要允许 ClamAV 在 SELinux 下运行，请运行以下命令：

```

setsebool -P antivirus_can_scan_system 1
```

### ClamConf

`clamconf` is a tool ClamAV provides for checking your entire system  configuration, as it relates to your ClamAV installation. When run, it  displays values used when configuring ClamAV at compilation time,  important OS details, the contents (and validity) of both `clamd.conf` and `freshclam.conf`, along with other important engine, database, platform, and build information.
`clamconf` 是 ClamAV 提供的一个工具，用于检查你的整个系统配置，因为它与你的 ClamAV 安装有关。运行时，它会显示在编译时配置 ClamAV 时使用的值、重要的作系统详细信息、`clamd.conf` 和 `freshclam.conf` 的内容（和有效性），以及其他重要的引擎、数据库、平台和构建信息。

It can also generate example configuration files for [`clamd.conf`](https://docs.clamav.net/manual/Usage/Configuration.html#clamdconf) and [`freshclam.conf`](https://docs.clamav.net/manual/Usage/Configuration.html#freshclamconf).
它还可以为 [`clamd.conf`](https://docs.clamav.net/manual/Usage/Configuration.html#clamdconf) 和 [`freshclam.conf`](https://docs.clamav.net/manual/Usage/Configuration.html#freshclamconf) 生成示例配置文件。

To use `clamconf`, and see all the information it provides, simply run the following command:
要使用 `clamconf` 并查看它提供的所有信息，只需运行以下命令：

```

clamconf
```

For more detailed information on `clamconf`, run:
有关 `clamconf` 的更多详细信息，请运行：

```

clamconf --help
```

or on Unix systems: 或在 Unix 系统上：

```

man clamconf
```