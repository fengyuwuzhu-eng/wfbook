# NTP 版本 4 发行说明

[TOC]

NTP 已经开发了近 30 年，但油漆现在还没有干。此版本的 Unix、VMS 和 Windows 的 NTP 版本 4 （NTPv4）  发行版包含新功能和改进，但保留了与旧版本（包括 NTPv3 和 NTPv2）的向后兼容性，但不包括 NTPv1。 由于某些安全漏洞，已停止对  NTPv1 的支持。

## 新功能

- 守护程序在启动时的行为已得到显著改进。The  time to measure the frequency and correct an initial offset error when  started for the first time is now no more than ten minutes. 首次启动时测量频率并校正初始失调误差的时间现在不超过十分钟。重新启动后，it takes no more than five minutes to reduce the initial offset to less than one millisecond without adversely affecting the frequency.将初始偏移量减少到不到一毫秒的时间不超过五分钟，而不会对频率产生不利影响。This avoids a subsequent frequency correction which could take up to  several hours.这避免了随后可能需要几个小时的频率校正。
- A new feature called interleaved mode can be used in NTP symmetric and  broadcast modes. It is designed to improve accuracy by minimizing errors due to queuing and transmission delays. It is described on the [NTP Interleaved Modes](https://www.ntp.org/documentation/4.2.8-series/xleave/) page.
  一种称为交错模式的新功能可用于 NTP 对称和广播模式。它旨在通过最大限度地减少由于排队和传输延迟引起的错误来提高准确性。NTP 交错模式页面上对此进行了介绍。
- The huff-n'-puff filter is designed to avoid large errors with DSL circuits and highly asymmetrical traffic, as when downloading large files. 
  huff-n'-puff 滤波器旨在避免 DSL 电路和高度不对称流量出现大错误，例如下载大文件时。
- A new feature called orphan mode provides an automatic, subnet-wide  synchronization feature with multiple sources. It provides reliable  backup in isolated networks or in pr when Internet sources have become  unavailable. See the [Orphan Mode](https://www.ntp.org/documentation/4.2.8-series/orphan/) page for further information.
  一项名为“孤立模式”的新功能提供了具有多个源的自动子网范围同步功能。当 Internet 源不可用时，它可以在隔离网络或公关中提供可靠的备份。有关详细信息，请参阅孤立模式页面。
- This release includes comprehensive packet rate management tools to help  reduce the level of spurious network traffic and protect the busiest  servers from overload. There is support for the optional Kiss-o'-Death  (KoD) packet intended to slow down an abusive client. See the [Rate Management and the Kiss-o'-Death Packet](https://www.ntp.org/documentation/4.2.8-series/rate/) page for further information.
  此版本包括全面的数据包速率管理工具，可帮助降低虚假网络流量级别并保护最繁忙的服务器免受过载影响。支持可选的 Kiss-o'-Death （KoD） 数据包，旨在减慢滥用客户端的速度。有关详细信息，请参阅费率管理和 Kiss-o'-Death  Packet 页面。
- There are two new burst mode features available where special conditions apply. One of these is enabled by the `iburst` keyword in the `server` configuration command. It is intended for cases where it is important  to set the clock quickly when an association is first mobilized. The  other is enabled by the `burst` keyword in the `server` configuration command. It is intended for cases where the network  attachment requires an initial calling or training procedure. See the [Association Management](https://www.ntp.org/documentation/4.2.8-series/assoc/) page for further information.
  在特殊条件下，有两种新的突发模式功能可用。其中之一由 `server` 配置命令中 `iburst` 的关键字启用。它适用于在首次动员协会时快速设置时钟很重要的情况。另一个由 `server` 配置命令中 `burst` 的关键字启用。它适用于网络连接需要初始呼叫或训练过程的情况。有关详细信息，请参阅关联管理页面。
- The OpenSSL cryptographic library has replaced the library formerly  available from RSA Laboratories. All cryptographic routines except a  version of the MD5 message digest algorithm have been removed from the  base distribution. All 128-bit and 160-bit message digests algorithms  are now supported for both symmetric key and public key cryptosystems.  See the [Authentication Support](https://www.ntp.org/documentation/4.2.8-series/authentic/) page for further information and the [Authentication Options](https://www.ntp.org/documentation/4.2.8-series/authopt/) page for a list of supported digest algorithms.
  OpenSSL 加密库取代了以前从 RSA Laboratories 提供的库。除 MD5  消息摘要算法版本之外的所有加密例程都已从基本分发中删除。对称密钥和公钥密码系统现在都支持所有 128 位和 160  位消息摘要算法。有关详细信息，请参阅“身份验证支持”页，有关支持的摘要算法列表，请参阅“身份验证选项”页。
- This release includes support for Autokey public-key cryptography for authenticating public servers to clients, as described in [RFC 5906](https://www.ntp.org/reflib/rfc/rfc5906.txt). This support requires the `--enable-autokey` option when building the distribution, which is the default if OpenSSL  is available. The deployment of Autokey subnets is now considerably  simpler than in earlier versions. A subnet naming scheme is now  available to filter manycast and pool configurations. Additional  information about Autokey is on the [Autokey Public Key Authentication](https://www.ntp.org/documentation/4.2.8-series/autokey/) page and links from there.
  此版本包括对自动密钥公钥加密的支持，用于向客户端验证公共服务器，如 RFC 5906 中所述。此支持在构建发行版时需要该 `--enable-autokey` 选项，如果 OpenSSL 可用，则该选项是默认选项。与早期版本相比，Autokey 子网的部署现在要简单得多。子网命名方案现在可用于筛选manycast和池配置。有关自动密钥的其他信息，请参阅自动密钥公钥身份验证页面以及该页的链接。
- The NTP discrete event simulator has been substantially upgraded, now  including scenarios with multiple servers and time-sensitive scripts.  This allows the NTP algorithms to be tested in an embedded environment  with systematic and pseudo-random network delay and oscillator wander  distributions. This has been used to verify correct operation under  conditions of extreme error and misconfiguration. See the [`ntpdsim` - Network Time Protocol (NTP) simulator](https://www.ntp.org/documentation/4.2.8-series/ntpdsim/) page. A technical description and performance analysis is given in the [white paper](https://www.ntp.org/reflib/ntpsim/).
  NTP 离散事件模拟器已大幅升级，现在包括具有多个服务器和时间敏感脚本的场景。这允许在具有系统和伪随机网络延迟和振荡器漂移分布的嵌入式环境中测试NTP算法。这已用于验证在极端错误和错误配置条件下的正确操作。请参阅 `ntpdsim` - 网络时间协议 （NTP） 模拟器页面。白皮书中给出了技术说明和性能分析。
- NTPv4 includes three new server discovery schemes, which in most applications can avoid per-host configuration altogether. Two of these are based on  IP multicast technology, while the remaining one is based on crafted DNS lookups. 
  NTPv4 包括三种新的服务器发现方案，在大多数应用程序中，这些方案可以完全避免每主机配置。其中两个基于 IP 组播技术，而其余一个基于构建的 DNS 查找。
- The status display and event report monitoring functions have been  considerably expanded, including new statistics files and event  reporting to files and the system log. 
  状态显示和事件报告监控功能已大大扩展，包括新的统计文件以及文件和系统日志的事件报告。
- Several new options have been added for the `ntpd` command line. For the inveterate knob twiddlers several of the more  important performance variables can be changed to fit actual or  perceived special conditions. In particular, the `tinker` and `tos` commands can be used to adjust thresholds, throw switches and change limits.
  为 `ntpd` 命令行添加了几个新选项。对于根深蒂固的旋钮摆动器，可以更改几个更重要的性能变量以适应实际或感知的特殊条件。特别是， `tinker` 和 `tos` 命令可用于调整阈值、抛出开关和更改限制。
- The `ntpd` daemon can be operated in a one-time mode similar to `ntpdate`, which program is headed for retirement. See the [`ntpd` - Network Time Protocol (NTP) daemon](https://www.ntp.org/documentation/4.2.8-series/ntpd/) page for the new features.
   `ntpd` 守护程序可以以类似于 `ntpdate` 的一次性模式运行，该程序即将退役。有关新功能， `ntpd` 请参阅 - 网络时间协议 （NTP） 守护程序页面。
- A number of white papers have been added to the [Reference Library](https://www.ntp.org/reflib/papers/).
  参考图书馆中增加了许多白皮书。

## 自 NTPv3 版本 （xntp3-5） 以来的更改和升级

This section summarizes general changes since the publication of [RFC 1305](https://www.ntp.org/reflib/rfc/rfc1305/rfc1305b.pdf). Specific changes made during the code upgrade of 2007-2008 are summarized in [Historical Notes](https://www.ntp.org/documentation/4.2.8-series/history/).
本节总结了自 RFC 1305 发布以来的一般更改。2007-2008 年代码升级期间所做的具体更改总结在历史注释中。

- If the [Basic Socket Interface Extensions for IPv6 (RFC 2553)](https://datatracker.ietf.org/doc/html/rfc2553/) is detected, support for the IPv6 address family is supported in  addition to the default support for the IPv4 address family. In contexts where a host name is expected, a `-4` qualifier preceding the host name forces DNS resolution to the IPv4 namespace, while a `-6` qualifier forces DNS resolution to the IPv6 namespace.
  如果检测到 IPv6 的基本套接字接口扩展 （RFC 2553），则除了默认支持 IPv4 地址系列外，还支持对 IPv6 地址系列的支持。在需要主机名的上下文中，主机名前面的 `-4` 限定符强制将 DNS 解析到 IPv4 命名空间，而 `-6` 限定符将 DNS 解析强制到 IPv6 命名空间。
- Many changes have been made in the NTP algorithms to improve performance and reliability. A clock state machine has been incorporated to improve  behavior under transient conditions. The clock discipline algorithm has  been redesigned to improve accuracy, reduce the impact of network  disruptions and allow increased poll intervals to 36 hours with only  moderate sacrifice in accuracy. The clock select, cluster and combine  algorithms have been overhauled as the result of a thorough statistical  analysis.
  对 NTP  算法进行了许多更改，以提高性能和可靠性。已合并时钟状态机以改善瞬态条件下的行为。时钟规则算法经过重新设计，以提高准确性，减少网络中断的影响，并允许将轮询间隔增加到 36 小时，而准确性仅略有牺牲。时钟选择、聚类和组合算法经过彻底的统计分析后进行了全面修改。
- In all except a very few cases, all timing intervals are randomized, so  that the tendency for NTPv3 to self-synchronize and bunch messages,  especially with a large number of configured associations, is minimized.
  除极少数情况外，所有计时间隔都是随机的，因此 NTPv3 自同步和捆绑消息的趋势最小化，尤其是在配置了大量关联的情况下。
- Support for the precision time kernel modifications, which are now in stock  FreeBSD and optional in Linux kernels, is included. With this support  the system clock can be disciplined to the order of one nanosecond. The  older microtime kernel modifications in Digital/Compaq/HP Tru64, Digital Ultrix and Sun Microsystems SunOS and Solaris, continue to be  supported. In either case the support eliminates sawtooth error, which  can be in the hundreds of microseconds. Further information is on the [Kernel Model for Precision Timekeeping](https://www.ntp.org/documentation/4.2.8-series/kern/) page.
  包括对精确时间内核修改的支持，这些修改现在是 FreeBSD 的库存，在 Linux 内核中是可选的。有了这种支持，系统时钟可以被控制到一纳秒的量级。继续支持  Digital/Compaq/HP Tru64、Digital Ultrix 和 Sun Microsystems SunOS 和  Solaris 中较旧的微时内核修改。无论哪种情况，支架都消除了锯齿误差，锯齿误差可能在数百微秒内。有关更多信息，请访问精确计时的内核模型页面。
- New reference clock drivers have been added for several GPS receivers now  on the market for a total of 44 drivers. The reference clock driver  interface is smaller, more rational, more flexible and more accurate.  Most of the drivers in NTPv3 have been converted to the NTPv4 interface  and continue to operate as before. A summary of the supported drivers is on the [Reference Clock Support](https://www.ntp.org/documentation/4.2.8-series/refclock/) page. Audio drivers for the Canadian standard time and frequency  station CHU, the US standard time and frequency stations WWV/H and for  IRIG signals have been updated and capabilities added to allow direct  connection of these signals to an audio port. See the [Reference Clock Audio Drivers](https://www.ntp.org/documentation/4.2.8-series/audio/) page for further information.
  目前市场上的几种GPS接收器都添加了新的参考时钟驱动器，总共有44个驱动器。参考时钟驱动器接口更小、更合理、更灵活、更准确。NTPv3 中的大多数驱动程序已转换为 NTPv4 接口，并继续像以前一样运行。支持的驱动程序的摘要位于参考时钟支持页面上。加拿大标准时间和频率电台  CHU、美国标准时间和频率电台 WWV/H 以及 IRIG  信号的音频驱动程序已更新，并添加了允许将这些信号直接连接到音频端口的功能。有关详细信息，请参阅参考时钟音频驱动程序页面。
- Support for pulse-per-second (PPS) signals has been extended to all drivers as  an intrinsic function. Further information is on the [Pulse-Per-Second (PPS) Signal Interfacing](https://www.ntp.org/documentation/4.2.8-series/pps/) page. Typical performance with the PPS interface and a fast machine are in the low microseconds.
  对每秒脉冲 （PPS） 信号的支持已作为一项固有功能扩展到所有驱动器。有关更多信息，请访问每秒脉冲 （PPS） 信号接口页面。PPS接口和快速机器的典型性能在低微秒内。
- Several small changes have been made to make administration and maintenance  more convenience. The entire distribution has been converted to gnu `automake`, which greatly eases the task of porting to new and different  programming environments, as well as reduces the incidence of bugs due  to improper handling of idiosyncratic kernel functions. Version control  is provided by Bitkeeper using an online repository at https://bk.ntp.org/. Trouble ticket reporting is provided using Bugzilla. If `ntpd` is configured with NetInfo support, it will attempt to read its configuration from the NetInfo service if the default `ntp.conf` file cannot be read and no file is specified by the `-c` option. When `ntpd` starts it looks at the value of `umask`, and if zero `ntpd` will set the `umask` to `022`.
  为了使管理和维护更加方便，进行了一些小的更改。整个发行版已转换为 gnu `automake` ，这大大简化了移植到新的和不同的编程环境的任务，并减少了由于特殊内核函数处理不当而导致的错误发生率。版本控制由 Bitkeeper 使用 https://bk.ntp.org/ 的在线存储库提供。使用 Bugzilla 提供故障单报告。如果 `ntpd` 配置了 NetInfo 支持，则如果无法读取默认 `ntp.conf` 文件且该 `-c` 选项未指定任何文件，它将尝试从 NetInfo 服务读取其配置。启动时 `ntpd` ，它会查看 的 `umask` 值，如果为零 `ntpd` ，则将 设置为 `umask` `022` 。

## Nasty Surprises 令人讨厌的惊喜

There are a few things different about this release that have changed since  the latest NTP Version 3 release. Following are a few things to worry  about:
自最新的 NTP 版本 3 版本以来，此版本有一些不同之处。以下是一些需要担心的事项：

- Some configuration commands have been removed, others added and some changed in minor ways. See the collection of Commands and Options on the [Command Index](https://www.ntp.org/documentation/4.2.8-series/comdex/) page.
  删除了一些配置命令，添加了其他配置命令，并进行了一些细微的更改。请参阅“命令索引”页上的“命令和选项”集合。
- When both IPv4 and IPv6 address families are in use, the host’s resolver  library may not choose the intended address family if a server has an  IPv4 and IPv6 address associated with the same DNS name. The solution is to use the IPv4 or IPv6 address directly in such cases or use another  DNS name that resolves to the intended address family. Older versions of `ntpdc` will show only the IPv4 associations with the `peers` and some other commands. Older versions of `ntpq` will show `0.0.0.0` for IPv6 associations with the `peers` and some other commands.
  当同时使用 IPv4 和 IPv6 地址系列时，如果服务器具有与同一 DNS 名称关联的 IPv4 和 IPv6  地址，则主机的解析器库可能不会选择预期的地址系列。在这种情况下，解决方案是直接使用 IPv4 或 IPv6  地址，或者使用另一个解析为预期地址系列的 DNS 名称。旧版本 `ntpdc` 将仅显示与 的 `peers` IPv4 关联和其他一些命令。旧版本 `ntpq` 将显示 `0.0.0.0` 与 的 IPv6 关联和 `peers` 其他一些命令。
- There is a minor change to the reference ID field of the NTP packet header  when operating with IPv6 associations. In IPv4 associations this field  contains the 32-bit IPv4 address of the server, in order to detect and  avoid loops. In IPv6 associations this field contains the first 32-bits  of a MD5 hash formed from the IPv6 address. All programs in the  distribution have been modified to work with both address families.
  使用 IPv6 关联操作时，NTP 数据包报头的引用 ID 字段略有更改。在 IPv4 关联中，此字段包含服务器的 32 位 IPv4  地址，以便检测和避免环路。在 IPv6 关联中，此字段包含从 IPv6 地址形成的 MD5 哈希的前 32  位。发行版中的所有程序都经过修改，可以同时使用这两个地址系列。
- The `tty_clk` and `ppsclock` pulse-per-second (PPS) line discipline/streams modules are no longer supported. The PPS function is now handled by the [PPS Clock Discipline](https://www.ntp.org/documentation/drivers/driver22/) driver, which uses the new PPSAPI application program interface adopted by the IETF. Note that the `pps` configuration file command has been obsoleted by the driver. See the [Pulse-Per-Second (PPS) Signal Interfacing](https://www.ntp.org/documentation/4.2.8-series/pps/) page for further information.
  不再支持 `tty_clk` 每 `ppsclock` 秒脉冲 （PPS） 线路规则/流模块。PPS 函数现在由 PPS 时钟规则驱动程序处理，该驱动程序使用 IETF 采用的新 PPSAPI 应用程序接口。请注意，驱动程序已废弃配置文件 `pps` 命令。有关详细信息，请参阅每秒脉冲 （PPS） 信号接口页面。
- Support for the NTPv1 symmetric mode has been discontinued, since it hasn’t  worked for years. Support continues for the NTPv1 client mode, which is  used by some SNTP clients.
  对 NTPv1 对称模式的支持已停止，因为它已经多年没有工作了。继续支持某些 SNTP 客户端使用的 NTPv1 客户端模式。
- The `authstuff` directory, intended as a development and testing aid for porting  cryptographic routines to exotic architectures, has been removed.  Testing and conformance validation tools are available in the OpenSSL  software distribution.
  该 `authstuff` 目录旨在作为将加密例程移植到异国情调的架构的开发和测试辅助工具，现已删除。OpenSSL 软件发行版中提供了测试和一致性验证工具。