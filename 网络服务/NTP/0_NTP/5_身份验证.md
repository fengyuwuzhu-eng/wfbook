# Authentication Support 身份验证支持

Last update: November 23, 2022 17:49 UTC ([1b4d24aef](https://git.nwtime.org/websites/ntpwww/commit/1b4d24aef65c630791ad0f89d6c09ec258781c2c))
最后更新： 2022年11月23日 17：49 UTC （ 1b4d24aef）



  ![gif](https://www.ntp.org/documentation/pic/alice44.gif)

[from *Alice’s Adventures in Wonderland*, Lewis Carroll
摘自《爱丽丝梦游仙境》，刘易斯·卡罗尔](https://www.ntp.org/reflib/pictures/)



Our resident cryptographer; now you see him, now you don’t.
我们的常驻密码学家;现在你看到他，现在你看不到。

------

#### Table of Contents 目录

- [Introduction 介绍](https://www.ntp.org/documentation/4.2.8-series/authentic/#introduction)
- [Symmetric Key Cryptography
  对称密钥加密](https://www.ntp.org/documentation/4.2.8-series/authentic/#symmetric-key-cryptography)
- [Microsoft Windows Authentication
  Microsoft Windows 身份验证](https://www.ntp.org/documentation/4.2.8-series/authentic/#microsoft-windows-authentication)
- [Public Key Cryptography 公钥加密](https://www.ntp.org/documentation/4.2.8-series/authentic/#public-key-cryptography)

------

#### Introduction 介绍

This page describes the various cryptographic authentication provisions in  NTPv4. Authentication support allows the NTP client to verify that  servers are in fact known and trusted and not intruders intending  accidentally or intentionally to masquerade as a legitimate server. A  detailed discussion of the NTP multi-layer security model and  vulnerability analysis is in the white paper [NTP Security Analysis](https://www.ntp.org/reflib/security/).
本页介绍 NTPv4 中的各种加密身份验证规定。 身份验证支持允许 NTP 客户端验证服务器是否确实是已知的和受信任的，而不是有意或有意伪装成合法服务器的入侵者。有关 NTP 多层安全模型和漏洞分析的详细讨论，请参阅白皮书 NTP 安全分析。

The NTPv3 specification ([RFC-1305](https://www.ntp.org/reflib/rfc/rfc1305/rfc1305b.pdf)) defined an authentication scheme properly described as *symmetric key cryptography*. It used the Data Encryption Standard (DES) algorithm operating in  cipher-block chaining (CBC) mode. Subsequently, this algorithm was  replaced by the RSA Message Digest 5 (MD5) algorithm commonly called  keyed-MD5. Either algorithm computes a message digest or one-way hash  which can be used to verify the client has the same message digest as  the server. The MD5 message digest algorithm is included in the  distribution, so without further cryptographic support, the distribution can be freely exported.
NTPv3 规范 （RFC-1305） 定义了一种身份验证方案，该方案被正确描述为对称密钥加密。它使用在密码块链接 （CBC） 模式下运行的数据加密标准  （DES） 算法。随后，该算法被 RSA 消息摘要 5 （MD5） 算法（通常称为  keyed-MD5）所取代。任一算法都会计算消息摘要或单向哈希，可用于验证客户端是否与服务器具有相同的消息摘要。MD5  消息摘要算法包含在分发中，因此无需进一步的加密支持，即可自由导出分发。

If the OpenSSL cryptographic library is installed prior to building the  distribution, all message digest algorithms included in the library may  be used, including SHA and SHA1. However, if conformance to FIPS 140-2  is required, only a limited subset of these algorithms can be used. This library is available from [here](https://www.openssl.org) and can be installed using the procedures outlined in the [Building and Installing the Distribution](https://www.ntp.org/documentation/4.2.8-series/build/) page. Once installed, the configure and build process automatically  detects the library and links the library routines required.
如果在构建发行版之前安装了 OpenSSL 加密库，则可以使用库中包含的所有消息摘要算法，包括 SHA 和 SHA1。但是，如果需要符合 FIPS  140-2，则只能使用这些算法的有限子集。此库可从此处获得，并且可以使用“构建和安装分发”页面中概述的过程进行安装。安装后，配置和构建过程会自动检测库并链接所需的库例程。

In addition to the symmetric key algorithms, this distribution includes  support for the Autokey public key algorithms and protocol specified in [RFC-5906 “Network Time Protocol Version 4: Autokey Specification”](https://www.ntp.org/reflib/rfc/rfc5906.txt). This support is available only if the OpenSSL library has been installed and the `--enable-autokey` option is used when the distribution is built.
除了对称密钥算法外，此发行版还包括对 RFC-5906“网络时间协议版本 4：自动密钥规范”中指定的自动密钥公钥算法和协议的支持。仅当已安装 OpenSSL 库并在构建发行版时使用该 `--enable-autokey` 选项时，此支持才可用。

Public key cryptography is generally considered more secure than symmetric key cryptography, since the security is based on private and public values  which are generated by each participant and where the private value is  never revealed. Autokey uses X.509 public certificates, which can be  produced by commercial services, the OpenSSL application program, or the [`ntp-keygen`](https://www.ntp.org/documentation/4.2.8-series/keygen/) utility program in the NTP software distribution.
公钥加密通常被认为比对称密钥加密更安全，因为安全性基于每个参与者生成的私有和公共值，并且私有值永远不会泄露。Autokey 使用 X.509 公共证书，这些证书可以由商业服务、OpenSSL 应用程序或 NTP 软件发行版中的 `ntp-keygen` 实用程序生成。

> **NOTE:** According to US law, NTP binaries including OpenSSL library components, including the OpenSSL library itself, cannot be exported outside the US without license from the US Department of Commerce. Builders outside  the US are advised to obtain the OpenSSL library directly from OpenSSL,  which is outside the US, and build outside the US.
> 注意：根据美国法律，未经美国商务部许可，包括 OpenSSL 库组件（包括 OpenSSL 库本身）的 NTP 二进制文件不得出口到美国境外。建议美国以外的构建者直接从美国境外的 OpenSSL 获取 OpenSSL 库，并在美国境外构建。

Authentication is configured separately for each association using the `key` or `autokey` option of the `server` configuration command, as described in the [Server Options](https://www.ntp.org/documentation/4.2.8-series/confopt/#server-command-options) page. The [`ntp-keygen`](https://www.ntp.org/documentation/4.2.8-series/keygen/) page describes the files required for the various authentication  schemes. Further details are in the briefings, papers and reports in the [Reference Library](https://www.ntp.org/reflib/).
使用 `server` 配置命令的 `key` or `autokey` 选项为每个关联单独配置身份验证，如“服务器选项”页面中所述。该 `ntp-keygen` 页面描述了各种身份验证方案所需的文件。详情见参考图书馆的简报、文件和报告。

By default, the client sends non-authenticated packets and the server  responds with non-authenticated packets. If the client sends  authenticated packets, the server responds with authenticated packets if correct, or a crypto-NAK packet if not. In the case of unsolicited  packets which might consume significant resources, such as broadcast or  symmetric mode packets, authentication is required, unless overridden by a `disable auth` command. In the current climate of targeted broadcast or “letterbomb”  attacks, defeating this requirement would be decidedly dangerous. In any case, the `notrust` flag, described on the [Access Control Options](https://www.ntp.org/documentation/4.2.8-series/accopt/) page, can be used to disable access to all but correctly authenticated clients.
默认情况下，客户端发送未经身份验证的数据包，服务器使用未经身份验证的数据包进行响应。如果客户端发送经过身份验证的数据包，则服务器使用经过身份验证的数据包（如果正确）进行响应，如果不正确，则使用加密 NAK 数据包进行响应。对于可能消耗大量资源（如广播或对称模式数据包）的未经请求的数据包，除非 `disable auth` 被命令覆盖，否则需要身份验证。在当前有针对性的广播或“信件炸弹”攻击的环境下，打破这一要求绝对是危险的。在任何情况下，“访问控制选项”页上描述的标志 `notrust` 都可用于禁用对除正确身份验证的客户端之外的所有客户端的访问。

------

#### Symmetric Key Cryptography 对称密钥加密

The original NTPv3 specification ([RFC-1305](https://www.ntp.org/reflib/rfc/rfc1305/rfc1305b.pdf)), as well as the current NTPv4 specification ([RFC-5905](https://www.ntp.org/reflib/rfc/rfc5905.txt)), allows any one of possibly 65,535 message digest keys (excluding zero), each distinguished by a 32-bit key ID, to authenticate an association.  The servers and clients involved must agree on the key ID, key type and  key to authenticate NTP packets.
原始 NTPv3 规范 （RFC-1305） 以及当前的 NTPv4 规范 （RFC-5905） 允许 65,535  个消息摘要密钥（不包括零）中的任何一个（每个密钥由 32 位密钥 ID 区分）对关联进行身份验证。所涉及的服务器和客户端必须就密钥  ID、密钥类型和密钥达成一致，以验证 NTP 数据包。

The message digest is a cryptographic hash computed by an algorithm such as MD5, SHA, or AES-128 CMAC. When authentication is specified, a message  authentication code (MAC) is appended to the NTP packet header. The MAC  consists of a 32-bit key identifier (key ID) followed by a 128- or  160-bit message digest. The algorithm computes the digest as the hash of a 128- or 160- bit message digest key concatenated with the NTP packet  header fields with the exception of the MAC. On transmit, the message  digest is computed and inserted in the MAC. On receive, the message  digest is computed and compared with the MAC. The packet is accepted  only if the two MACs are identical. If a discrepancy is found by the  client, the client ignores the packet, but raises an alarm. If this  happens at the server, the server returns a special message called a *crypto-NAK*. Since the crypto-NAK is protected by the loopback test, an intruder cannot disrupt the protocol by sending a bogus crypto-NAK.
消息摘要是由 MD5、SHA 或 AES-128 CMAC 等算法计算的加密哈希。指定身份验证时，消息身份验证代码 （MAC） 将附加到 NTP  数据包报头。MAC 由 32 位密钥标识符（密钥 ID）后跟 128 位或 160 位消息摘要组成。该算法将摘要计算为与 NTP  数据包标头字段连接的 128 位或 160 位消息摘要密钥的哈希值，但 MAC 除外。在传输时，将计算消息摘要并将其插入 MAC  中。接收时，将计算消息摘要并与 MAC 进行比较。仅当两个 MAC  相同时，才接受数据包。如果客户端发现差异，客户端将忽略该数据包，但会发出警报。如果这种情况发生在服务器上，服务器将返回一条称为  crypto-NAK 的特殊消息。由于 crypto-NAK 受环回测试保护，因此入侵者无法通过发送虚假的 crypto-NAK 来破坏协议。

Keys and related information are specified in a keys file, which must be  distributed and stored using secure means beyond the scope of the NTP  protocol itself. Besides the keys used for ordinary NTP associations,  additional keys can be used as passwords for the [`ntpq`](https://www.ntp.org/documentation/4.2.8-series/ntpq/) and [`ntpdc`](https://www.ntp.org/documentation/4.2.8-series/ntpdc/) utility programs. Ordinarily, the `ntp.keys` file is generated by the [`ntp-keygen`](https://www.ntp.org/documentation/4.2.8-series/keygen/) program, but it can be constructed and edited using an ordinary text editor.
密钥和相关信息在密钥文件中指定，必须使用超出 NTP 协议本身范围的安全方式进行分发和存储。除了用于普通 NTP 关联的密钥外，其他密钥还可以用作 `ntpq` 和 `ntpdc` 实用程序的密码。通常， `ntp.keys` 文件是由 `ntp-keygen` 程序生成的，但可以使用普通的文本编辑器进行构建和编辑。

Each line of the keys file consists of three or four fields: a key ID in the range 1 to 65,535, inclusive, a key type, a message digest key  consisting of a printable ASCII string less than 40 characters or a  40-character hex digit string, and an optional comma-separated list of  IPs that are allowed to serve time. If the OpenSSL library is installed, the key type can be any message digest algorithm supported by the  library. If the OpenSSL library is not installed, the only permitted key type is MD5.
密钥文件的每一行由三个或四个字段组成：范围为 1 到 65,535（含）的密钥 ID、密钥类型、由少于 40 个字符的可打印 ASCII 字符串或 40  个字符的十六进制数字字符串组成的消息摘要密钥，以及允许提供服务时间的可选逗号分隔 IP 列表。如果安装了 OpenSSL  库，则密钥类型可以是该库支持的任何消息摘要算法。如果未安装 OpenSSL 库，则唯一允许的密钥类型是 MD5。

**Figure 1: Typical Symmetric Key File
图 1：典型的对称密钥文件**



  ![webp](https://www.ntp.org/documentation/pic/md5.webp)



Figure 1 shows a typical symmetric keys file used by the reference  implementation when the OpenSSL library is installed. Each line of the  file contains three or four fields. The first field is an integer  between 1 and 65535, inclusive, representing the key identifier. The  second field is the digest algorithm, which in the absence of the  OpenSSL library must be `MD5`, which designates the MD5 message digest algorithm. The third field is  the key. The optional fourth field is one or more comma-separated IPs.  An IP may end with an optional `/subnetbits` suffix, which limits the acceptance of the key identifier to packets  claiming to be from the described IP space. In this example, for the key IDs in the range 1-10 the key is interpreted as a printable ASCII  string. For the key IDs in the range 11-20, the key is a 40-character  hex digit string. In either case, the key is truncated or zero-filled  internally to either 128 or 160 bits, depending on the key type. The  line can be edited later or new lines can be added to change any field.  The key can be changed to a password, such as `2late4Me` for key ID 10. Note that two or more keys files can be combined in any order as long as the key IDs are distinct.
图 1 显示了安装 OpenSSL 库时参考实现使用的典型对称密钥文件。文件的每一行都包含三个或四个字段。第一个字段是介于 1 和 65535  之间的整数（含 1 和 65535），表示密钥标识符。第二个字段是摘要算法，在没有 OpenSSL 库的情况下，它必须是 `MD5` ，它指定 MD5 消息摘要算法。第三个字段是关键。可选的第四个字段是一个或多个逗号分隔的 IP。IP 可能以可选 `/subnetbits` 后缀结尾，该后缀将密钥标识符的接受限制为声称来自所述 IP 空间的数据包。在此示例中，对于范围为 1-10 的密钥 ID，密钥被解释为可打印的 ASCII 字符串。对于范围为 11-20 的密钥 ID，密钥是 40 个字符的十六进制数字字符串。无论哪种情况，密钥都会被截断或内部填充为  128 位或 160 位，具体取决于密钥类型。可以稍后编辑该行，也可以添加新行以更改任何字段。密钥可以更改为密码，例如 `2late4Me` 密钥 ID 10。请注意，只要密钥 ID 不同，就可以按任意顺序组合两个或多个密钥文件。

When `ntpd` is started, it reads the keys file specified by the `keys` command and installs the keys in the key cache. However, individual keys must be activated with the `trustedkey` configuration command before use. This allows, for instance, the  installation of possibly several batches of keys and then activating a  key remotely using `ntpq` or `ntpdc`. The `requestkey` command selects the key ID used as the password for the `ntpdc` utility, while the `controlkey` command selects the key ID used as the password for the `ntpq` utility.
启动时 `ntpd` ，它会读取 `keys` 命令指定的密钥文件，并将密钥安装在密钥缓存中。但是，在使用之前，必须使用 `trustedkey` 配置命令激活单个密钥。例如，这允许安装几批密钥，然后使用 `ntpq` 或 `ntpdc` 远程激活密钥。该 `requestkey` 命令选择用作 `ntpdc` 实用程序密码的密钥 ID，而 `controlkey` 该命令选择用作 `ntpq` 实用程序密码的密钥 ID。

------

#### Microsoft Windows Authentication Microsoft Windows 身份验证

In addition to the above means, `ntpd` now supports Microsoft Windows MS-SNTP authentication using Active  Directory services. This support was contributed by the Samba Team and  is still in development. It is enabled using the `mssntp` flag of the `restrict` command described on the [Access Control Options](https://www.ntp.org/documentation/4.2.8-series/accopt/#commands-and-options) page.
除上述方法外， `ntpd` 现在还支持使用Active Directory服务的Microsoft Windows MS-SNTP身份验证。此支持由 Samba 团队提供，目前仍在开发中。它是使用“访问控制选项”页面上描述 `restrict` 的命令 `mssntp` 的标志启用的。

> **NOTE:** Potential users should be aware that these services involve a TCP  connection to another process that could potentially block, denying  services to other users. Therefore, this flag should be used only for a  dedicated server with no clients other than MS-SNTP.
> 注意：潜在用户应注意，这些服务涉及与另一个进程的 TCP 连接，该进程可能会阻止，从而拒绝向其他用户提供服务。因此，此标志应仅用于除 MS-SNTP 之外没有客户端的专用服务器。

------

#### Public Key Cryptography 公钥加密

See the [Autokey Public-Key Authentication](https://www.ntp.org/documentation/4.2.8-series/autokey/) page.
请参阅“自动密钥公钥身份验证”页面。