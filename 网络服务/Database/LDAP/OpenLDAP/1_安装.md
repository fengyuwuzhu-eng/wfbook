# 安装

[TOC]

## CentOS

## Ubuntu

## 源代码

1. 获取软件

   可以按照 OpenLDAP software 下载页面上的说明获取该软件的副本 (http://www.openldap.org/software/download/)。建议新用户从最新版本开始使用。

2. 解压源码包

   选择源码包所在的目录，将目录更改为该目录，然后使用以下命令解压缩分发：

   ```bash
   gunzip -c openldap-VERSION.tgz | tar xvfB -
   ```

   进入解压后生成的源码目录中

   ```bash
   cd openldap-VERSION
   ```

3. 审查文件
   现在应该查看随发行版提供的 `COPYRIGHT` 、 `LICENSE` 、`README` 和 `INSTALL` 文档。版权和许可证提供了有关 OpenLDAP 软件的可接受使用、复制和保修限制的信息。

4. 运行 `configure`

   You will need to run the provided configure script to configure the distribution for building on your system.  您将需要运行提供的配置脚本来配置在您的系统上构建的分发。

   ```bash
   ./configure
   ```

   配置脚本接受许多启用或禁用可选软件功能的命令行选项。通常情况下，默认值是可以的，但您可能需要更改它们。要获得配置接受的选项的完整列表，请使用 `--help` 选项：

   ```bash
   ./configure --help
   ```

5. 构建软件

   这个步骤有两个部分，首先构建依赖关系，然后编译软件：

   ```bash
   make depend
   make
   ```

   两个 make 都应无错误地完成。

6. 测试

   为了确保正确的构建，应该运行测试套件（只需要几分钟）：

   ```bash
   make test
   ```

   应用于您的配置的测试将运行，并且应该通过。某些测试（如复制测试）可能会被跳过。

7. 安装软件

   通常需要超级用户权限。

   ```bash
   su root -c 'make install'
   ```

   所有东西都应该安装在 `/usr/local` 下（或者 `configure` 使用的任何安装前缀）。

8. 编辑配置文件

   编辑提供的 slapd.ldif 示例（通常安装为 `/usr/local/etc/openldap/slapd.ldif` ），以包含以下形式的 MDB 数据库定义：

   ```ini
   dn: olcDatabase=mdb,cn=config
   objectClass: olcDatabaseConfig
   objectClass: olcMdbConfig
   olcDatabase: mdb
   OlcDbMaxSize: 1073741824
   olcSuffix: dc=<MY-DOMAIN>,dc=<COM>
   olcRootDN: cn=Manager,dc=<MY-DOMAIN>,dc=<COM>
   olcRootPW: secret
   olcDbDirectory: /usr/local/var/openldap-data
   olcDbIndex: objectClass eq
   ```

   请确保将 `<MY-DOMAIN>`和 `<COM>` 替换为域名的相应域组件。例如，例如 `example.com`，请使用：

   ```ini
   dn: olcDatabase=mdb,cn=config
   objectClass: olcDatabaseConfig
   objectClass: olcMdbConfig
   olcDatabase: mdb
   OlcDbMaxSize: 1073741824
   olcSuffix: dc=example,dc=com
   olcRootDN: cn=Manager,dc=example,dc=com
   olcRootPW: secret
   olcDbDirectory: /usr/local/var/openldap-data
   olcDbIndex: objectClass eq
   ```

   如果您的域包含其他组件，如 `eng.uni.edu.eu` ，请使用：

   ```ini
   dn: olcDatabase=mdb,cn=config
   objectClass: olcDatabaseConfig
   objectClass: olcMdbConfig
   olcDatabase: mdb
   OlcDbMaxSize: 1073741824
   olcSuffix: dc=eng,dc=uni,dc=edu,dc=eu
   olcRootDN: cn=Manager,dc=eng,dc=uni,dc=edu,dc=eu
   olcRootPW: secret
   olcDbDirectory: /usr/local/var/openldap-data
   olcDbIndex: objectClass eq
   ```

   请注意，在启动slapd（8）之前，指定的 olcDbDriectory 必须存在。

9. 导入配置数据库

   可以通过运行以下命令导入配置数据库供 slapd（8）使用：

   ```bash
   /usr/local/sbin/slapadd -n 0 -F /usr/local/etc/slapd.d -l /usr/local/etc/openldap/slapd.ldif
   ```

10. 启动 SLAPD

    可以通过运行以下命令启动独立 LDAP 守护程序 slapd（8）：

    ```bash
    /usr/local/libexec/slapd -F /usr/local/etc/slapd.d
    ```

    要检查服务器是否正在运行和配置正确，可以使用 ldapsearch（1）对其进行搜索。默认情况下，ldapsearch 安装为 /usr/local/bin/ldapsearch :

    ```bash
    ldapsearch -x -b '' -s base '(objectclass=*)' namingContexts
    ```

    请注意在命令参数周围使用单引号，以防止特殊字符被 shell 解释。这应该返回：

    ```ini
    dn:
    namingContexts: dc=example,dc=com
    ```

11. 将初始条目添加到目录中

    可以使用 ldapadd（1）将条目添加到 LDAP 目录中。ldapadd 需要 LDIF 形式的输入。分两步完成：

    1. 创建 LDIF 文件

       ```ini
       dn: dc=<MY-DOMAIN>,dc=<COM>
       objectclass: dcObject
       objectclass: organization
       o: <MY ORGANIZATION>
       dc: <MY-DOMAIN>
       
       dn: cn=Manager,dc=<MY-DOMAIN>,dc=<COM>
       objectclass: organizationalRole
       cn: Manager
       ```

       请确保将 `<MY-DOMAIN>` 和 `<COM>` 替换为域名的相应域组件。`<MY ORGANIZATION>` 应替换为您的组织名称。

    2. 运行 ldapadd

       可以运行 ldapadd（1）将这些条目插入到您的目录中。

       ```bash
       ldapadd -x -D "cn=Manager,dc=<MY-DOMAIN>,dc=<COM>" -W -f example.ldif
       ```

       确保将 `<MY-DOMAIN>`  和 `<COM>` 替换为域名的相应域组件。系统将提示您输入 `slapd.conf` 中指定的 `secret` 。例如，`example.com` ，请使用：

       ```bash
       ldapadd -x -D "cn=Manager,dc=example,dc=com" -W -f example.ldif
       ```

       其中 `example.ldif` 是您在上面创建的文件。

12. 验证

    验证添加的条目是否在您的目录中。可以使用任何 LDAP 客户端来执行此操作，示例中使用 ldapsearch（1）工具。请记住将 `dc=example,dc=com` 替换为您站点的正确值：

    ```bash
    ldapsearch -x -b 'dc=example,dc=com' '(objectclass=*)'
    ```

    此命令将搜索和检索数据库中的每个条目。


    > 请注意，默认情况下，slapd（8）数据库将读取访问权限授予除超级用户之外的所有人（由 `rootdn` 配置指令指定）。强烈建议您建立控制措施，以限制授权用户的访问权限。

# 4. Building and Installing OpenLDAP Software

This chapter details how to build and install the [OpenLDAP](https://www.openldap.org/) Software package including *slapd*(8), the Standalone LDAP Daemon.  Building and installing OpenLDAP Software requires several  steps: installing prerequisite software, configuring OpenLDAP Software  itself, making, and finally installing.  The following sections describe this process in detail.

------

## 4.1. Obtaining and Extracting the Software

You can obtain OpenLDAP Software from the project's download page at http://www.openldap.org/software/download/ or directly from the project's FTP service at [ftp://ftp.openldap.org/pub/OpenLDAP/](ftp://ftp.openldap.org/pub/OpenLDAP/).

The project makes available two series of packages for *general use*.  The project makes *releases* as new features and bug fixes come available.  Though the project takes steps to improve stability of these releases, it is common for problems to arise only after *release*.  The *stable* release is the latest *release* which has demonstrated stability through general use.

Users of OpenLDAP Software can choose, depending on their desire for the *latest features* versus *demonstrated stability*, the most appropriate series to install.

After downloading OpenLDAP Software, you need to extract the  distribution from the compressed archive file and change your working  directory to the top directory of the distribution:

`gunzip -c openldap-VERSION.tgz | tar xf -`   `cd openldap-VERSION`

You'll have to replace `VERSION` with the version name of the release.

You should now review the `COPYRIGHT`, `LICENSE`, `README` and `INSTALL` documents provided with the distribution.  The `COPYRIGHT` and `LICENSE` provide information on acceptable use, copying, and limitation of warranty of OpenLDAP Software. The `README` and `INSTALL` documents provide detailed information on prerequisite software and installation procedures.

------

## 4.2. Prerequisite software

OpenLDAP Software relies upon a number of software packages  distributed by third parties.  Depending on the features you intend to  use, you may have to download and install a number of additional  software packages.  This section details commonly needed third party  software packages you might have to install.  However, for an up-to-date prerequisite information, the `README` document should be  consulted.  Note that some of these third party packages may depend on  additional software packages.  Install each package per the installation instructions provided with it.

### 4.2.1. Transport Layer Security

OpenLDAP clients and servers require installation of [OpenSSL](https://www.openssl.org/) or [GnuTLS](https://gnutls.org/) TLS libraries to provide Transport Layer Security services.  Though some operating systems may provide these libraries as part of the base system or as an optional software component, OpenSSL  and GnuTLS often require separate installation.

OpenSSL is available from http://www.openssl.org/. GnuTLS is available from http://www.gnu.org/software/gnutls/.

OpenLDAP Software will not be fully LDAPv3 compliant unless OpenLDAP's `configure` detects a usable TLS library.

### 4.2.2. Simple Authentication and Security Layer

OpenLDAP clients and servers require installation of [Cyrus SASL](https://www.cyrusimap.org/sasl/) libraries to provide Simple Authentication and Security Layer services.  Though some operating systems may provide this library as  part of the base system or as an optional software component, Cyrus SASL often requires separate installation.

Cyrus SASL is available from http://asg.web.cmu.edu/sasl/sasl-library.html. Cyrus SASL will make use of OpenSSL and Kerberos/GSSAPI libraries if preinstalled.

OpenLDAP Software will not be fully LDAPv3 compliant unless OpenLDAP's configure detects a usable Cyrus SASL installation.

### 4.2.3. Kerberos Authentication Service

OpenLDAP clients and servers support Kerberos authentication services.  In particular, OpenLDAP supports the Kerberos V GSS-API SASL authentication mechanism known as the GSSAPI mechanism.  This feature requires, in addition to Cyrus SASL libraries, either [Heimdal](https://github.com/heimdal/) or [MIT Kerberos](https://web.mit.edu/kerberos/) V libraries.

Heimdal Kerberos is available from https://github.com/heimdal/heimdal/. MIT Kerberos is available from http://web.mit.edu/kerberos/www/.

Use of strong authentication services, such as those provided by Kerberos, is highly recommended.

### 4.2.4. Database Software

OpenLDAP's *slapd*(8) MDB primary database backend uses the LMDB software included with the OpenLDAP source.  There is no need to download any additional software to have *MDB* support.

### 4.2.5. Threads

OpenLDAP is designed to take advantage of threads.  OpenLDAP supports POSIX *pthreads*, NT threads and a number of other varieties.  `configure` will complain if it cannot find a suitable thread subsystem.   If this occurs, please consult the `Software|Installation|Platform Hints` section of the OpenLDAP FAQ http://www.openldap.org/faq/.

### 4.2.6. TCP Wrappers

*slapd*(8) supports TCP Wrappers (IP level access control  filters) if preinstalled.  Use of TCP Wrappers or other IP-level access  filters (such as those provided by an IP-level firewall) is recommended  for servers containing non-public information.

------

## 4.3. Running configure

Now you should probably run the `configure` script with the `--help` option. This will give you a list of options that you can change when  building OpenLDAP.  Many of the features of OpenLDAP can be enabled or  disabled using this method.

```
        ./configure --help
```

The `configure` script also looks for certain variables on the command line and in the environment.  These include:

| **Variable** | **Description**                   |
| ------------ | --------------------------------- |
| `CC`         | Specify alternative C Compiler    |
| `CFLAGS`     | Specify additional compiler flags |
| `CPPFLAGS`   | Specify C Preprocessor flags      |
| `LDFLAGS`    | Specify linker flags              |
| `LIBS`       | Specify additional libraries      |

Now run the configure script with any desired configuration options or variables.

```
        ./configure [options] [variable=value ...]
```

As an example, let's assume that we want to install OpenLDAP with MDB backend and TCP Wrappers support.  By default, MDB is enabled and TCP  Wrappers is not.  So, we just need to specify `--enable-wrappers` to include TCP Wrappers support:

```
        ./configure --enable-wrappers
```

However, this will fail to locate dependent software not installed in system directories.  For example, if TCP Wrappers headers and libraries are installed in `/usr/local/include` and `/usr/local/lib` respectively, the `configure` script should typically be called as follows:

```
        ./configure --enable-wrappers \
                CPPFLAGS="-I/usr/local/include" \
                LDFLAGS="-L/usr/local/lib -Wl,-rpath,/usr/local/lib"
```

The `configure` script will normally auto-detect appropriate  settings.  If you have problems at this stage, consult any platform  specific hints and check your `configure` options, if any.

------

## 4.4. Building the Software

Once you have run the `configure` script the last line of output should be:

```
        Please "make depend" to build dependencies
```

If the last line of output does not match, `configure` has failed, and you will need to review its output to determine what went wrong. You should not proceed until `configure` completes successfully.

To build dependencies, run:

```
        make depend
```

Now build the software, this step will actually compile OpenLDAP.

```
        make
```

You should examine the output of this command carefully to make sure  everything is built correctly.  Note that this command builds the LDAP  libraries and associated clients as well as *slapd*(8).

------

## 4.5. Testing the Software

Once the software has been properly configured and successfully made, you should run the test suite to verify the build.

```
        make test
```

Tests which apply to your configuration will run and they should  pass. Some tests, such as the replication test, may be skipped if not  supported by your configuration.

------

## 4.6. Installing the Software

Once you have successfully tested the software, you are ready to  install it.  You will need to have write permission to the installation  directories you specified when you ran configure.  By default OpenLDAP  Software is installed in `/usr/local`.  If you changed this setting with the `--prefix` configure option, it will be installed in the location you provided.

Typically, the installation requires *super-user* privileges. From the top level OpenLDAP source directory, type:

```
        su root -c 'make install'
```

and enter the appropriate password when requested.

You should examine the output of this command carefully to make sure  everything is installed correctly. You will find the configuration files for *slapd*(8) in `/usr/local/etc/openldap` by default.  See the chapter [Configuring slapd](https://openldap.org/doc/admin26/slapdconf2.html) for additional information.