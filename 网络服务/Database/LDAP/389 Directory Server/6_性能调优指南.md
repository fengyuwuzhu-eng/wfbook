[Skip to navigation](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#pfe-navigation)[Skip to main content](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#doc-wrapper)

​                Utilities                                                                            [Subscriptions                         ](https://access.redhat.com/management/)                                                                [Downloads                         ](https://access.redhat.com/downloads/)                                                                [Containers                         ](https://catalog.redhat.com/software/containers/explore/)                                                                [Support Cases                         ](https://access.redhat.com/support/cases/)                                                

​                    

​                                                                                                                                                                                                             

- 

- 

  

- 

- 

------

- ## 

  - [                                                                                                      ](https://www.ansible.com?intcmp=701f20000012k6TAAQ)

- ## 

  - [                                                                                                      ](https://cloud.redhat.com)
  - [                                                                                                      ](https://www.redhat.com/store?intcmp=701f20000012k6nAAA)
  - [                                                                                                      ](https://marketplace.redhat.com)

- ## 

  - [                                                                                                      ](https://enterprisersproject.com?intcmp=701f20000012k6sAAA)
  - [                                                                                                      ](https://opensource.com?intcmp=701f20000012k6OAAQ)

- ## 

  - [                                                                                                      ](https://www.redhat.com/summit?intcmp=701f20000012k6xAAA)
  - [                                                                                                      ](https://catalog.redhat.com/)

- [Products & Services](https://access.redhat.com/products/)
- [Product Documentation](https://access.redhat.com/documentation)
- [Red Hat Directory Server](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server)
- [11](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11)
- [性能调优指南](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html/performance_tuning_guide)
- 性能调优指南

​                                                                                                                       

​                  

##     Table of contents  

1. ​                                         [     性能调优指南   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#doc-wrapper)            
2. ​                                         [     使开源更具 Incsive   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#making-open-source-more-inclusive)            
3. ​                                           [     1. Directory 服务器性能调优简介   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#tuning-Preface)                    

​            

​                                           [     2. 跟踪服务器和数据库性能   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#tracking-performance)                    

​            

​                                           [     3. 调整锁定数   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#locks)                    

​            

​                                           [     4. 提高搜索性能（及平衡读取性能）   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#improving-search-performance)                    

​            

​                                           [     5. 调整事务日志记录   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#Tuning_Database_Performance-Tuning_Transaction_Logging)                    

​            

​                                           [     6. 管理数据库缓存设置   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#memoryusage)                    

​            

​                                           [     7. 设置目录服务器线程的数量   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#ds-threads)                    

​            

​                                           [     8. 调优复制性能   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#Tuning_Replication_Performance)                    

​            

​                                           [     9. 调优数据库链路性能   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#Creating_and_Maintaining_Database_Links-Advanced_Feature_Tuning_Database_Link_Performance)                    

​            

​                                           [     10. 提高导入性能   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#import)                    

1. ​            
2. ​                                         [     A. 修订历史记录   ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#revhistory)            

Focus mode

- ​                  Language:            

​      

​          Format:        

-   

# 性能调优指南

Red Hat Directory Server 11

## 调整目录服务器的性能

**摘要**

​				本指南为提高服务器和数据库性能提供了提示。 		

------

# 使开源更具 Incsive

​			红帽致力于替换我们的代码、文档和 Web 属性中有问题的语言。我们从这四个术语开始：master、slave、黑名单和白名单。由于此项工作十分艰巨，这些更改将在即将推出的几个发行版本中逐步实施。详情请查看 [“CTO Chris Wright”](https://www.redhat.com/en/blog/making-open-source-more-inclusive-eradicating-problematic-language) 的信息。 	

# 第 1 章 Directory 服务器性能调优简介

​			本文提供了一些流程和选项，管理员可用于优化其红帽目录服务器部署的性能。性能调优目录服务器实例对每台服务器而言是唯一的，因为对机器环境中的每台服务器、目录大小和数据类型、负载和网络使用情况的差异，即使用户和客户端执行的操作类型也是如此。 	

​			本指南的目的是强调红帽目录服务器为跟踪和评估服务器和数据库性能提供的功能。还提供了一些有助于调优服务器性能的步骤。但是，请参阅红帽目录服务器 [*管理指南，查看红帽目录服务器部署指南*](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/deployment_guide/)，以及有关基于命令行和 UI 的管理命令，请参阅 [*红帽目录服务器管理指南*](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/)。 	

## 1.1. 为 Directory 服务器性能设置目标

​				*性能调优* 只是识别服务器正常操作环境中潜在的（或真实）瓶颈的方法，然后采取措施缓解这些瓶颈。 		

​				性能调优的一般计划是： 		

1. ​						评估环境。查看目录服务器的一切信息：其使用情况、负载、网络连接和可靠性、最常见的操作、其物理机器及其所在的物理机器，以及竞争其资源的所有服务。 				
2. ​						测量当前目录服务器性能并建立基线。 				
3. ​						识别可改进的服务器区域。 				
4. ​						对 Directory 服务器设置进行任何更改，并可能对主机机器进行修改。 				
5. ​						再次测量 Directory 服务器性能，以查看影响性能的变化。 				

​				目录服务器在三个区域提供某种监控： 		

- ​						服务器进程（计数和日志） 				
- ​						数据库（计数器） 				
- ​						任何数据库链接（计数） 				

​				在 Directory Server 中，大多数性能测量将如何检索并提供给客户端。考虑到这一点，它们是可以针对最佳 Directory 服务器性能调整的服务器区域（以及本文中涵盖的领域）： 		

- ​						搜索操作 				
- ​						索引性能（影响搜索和写操作） 				
- ​						数据库事务 				
- ​						数据库和条目缓存设置 				
- ​						数据库链接 				

​				可以对主机机器的设置或硬件进行其他更改，也可以影响 Directory 服务器性能： 		

- ​						可用内存（基于目录大小） 				
- ​						在同一计算机上运行的其他服务器（资源竞争） 				
- ​						在其他机器上的其他目录服务器实例中分发用户数据库 				
- ​						由于网络性能而平衡服务器负载 				

​				与可以对实例所做的更改相比，这些更改更多地规划有效目录服务器部署。*《部署指南》* 可以提供更多有关如何规划最佳企业部署的详细信息。 		

# 第 2 章 跟踪服务器和数据库性能

​			红帽目录服务器有两种记录和跟踪性能数据的方法：性能计数器和日志。计数器用于确定目录服务器的性能如何，特别是数据库性能；日志用于诊断服务器和 LDAP 操作和配置的任何问题区域。 	

​			性能计数器专注于服务器、所有配置的数据库和数据库链接（链数据库）的操作和信息。 	

​			有三种日志类型：访问（用于客户端连接）、错误（用于错误、警告和事件详情）和 audit（更改目录服务器配置）。默认运行的访问和错误日志（以及服务器运行需要错误日志）。由于开销，必须手动启用审计日志记录。 	

注意

​				访问日志已被缓冲。即使加载的服务器也允许完全访问记录，但在服务器中发生事件以及事件写入日志时之间会有一个时间滞后。 		

## 2.1. 监控服务器活动

​				可通过 Web 控制台或命令行监控目录服务器的当前活动。也可以监控所有数据库缓存的活动。 		

注意

​					由服务器监控的目录服务器数据库属性的一些计数器使用 64 位整数，即使在 32 位系统中，即使是 32 位系统（启动的连接、操作完成、操作完成、发送条目和字节数发送）。在高容量系统上，这可防止滚动的计数器的速度过快，并造成监控数据。 			

### 2.1.1. 使用命令行监控目录服务器

​					使用命令行监控服务器： 			



```none
# dsconf -D "cn=Directory Manager" ldap://server.example.com monitor server
```

​					下表描述了命令返回的属性： 			

表 2.1. 服务器监控属性

| 属性                           | 描述                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| version                        | 标识目录的当前版本号。                                       |
| threads                        | 用于处理请求的当前活动线程数量。额外的线程可以由内部服务器任务创建，如复制或串联。 |
| *连接*                         | 为每个打开的连接提供以下摘要信息（仅在作为 Directory Manager 的绑定到目录时才可用）：  							 *fd* - 此连接的文件描述符。 *opentime* - 打开此连接的时间。 *opsinitiated* - 此连接启动的操作数量。 *opscompleted* - 已完成的操作数量。 *bindDN* - 此连接用于连接的目录的可分辨名称。 *rw* - 如果连接被阻止进行读取或写入，显示的字段。 							 默认情况下，此信息可供 Directory Manager 使用。但是，可以编辑与此信息关联的 ACI，以允许其他人访问信息。 |
| currentconnections             | 按目录确定服务当前在服务中的连接数。                         |
| totalconnections               | 识别从目录启动以来所处理的连接数量。                         |
| currentconnectionsatmaxthreads | 显示所有当前处于 **max 线程** 状态的连接。                   |
| maxthreadsperconnhits          | 显示连接达到最大 **线程的次数**。                            |
| dtablesize                     | 显示可用于目录的文件描述符数量。每个连接都需要一个文件描述符：一个用于每个打开索引，一个用于日志文件管理，一个用于 **ns-slapd** 本身。本质上，这个值显示 目录中可以服务多少个额外的并发连接。有关文件描述符的更多信息，请参阅操作系统文档。 |
| readwaiters                    | 标识等待从客户端读取数据的线程数量。                         |
| opsinitiated                   | 标识服务器启动以来启动的操作数量。                           |
| opscompleted                   | 标识服务器启动以来已完成的操作数量。                         |
| entriessent                    | 标识在服务器启动时发送到客户端的条目数量。                   |
| bytessent                      | 标识在服务器启动后发送到客户端的字节数。                     |
| currenttime                    | 标识执行服务器快照的时间。时间以 UTC 格式显示 Greenwich Mean Time(GMT)。 |
| starttime                      | 标识服务器启动的时间。时间以 UTC 格式显示 Greenwich Mean Time(GMT)。 |
| nbackends                      | 标识服务器服务的后端数量（数据库）。                         |

### 2.1.2. 使用 Web 控制台监控服务器

​					使用 Web 控制台监控服务器： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					

2. ​							选择 实例。 					

3. ​							在 Monitoring 选项卡上，选择 Server Statistics。 					

   [![img](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/401f8c2627b5c89a94e8c56889b70795/server-statistics.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/401f8c2627b5c89a94e8c56889b70795/server-statistics.png)

   ​							下表描述了此菜单中可见的字段： 					

   表 2.2. 常规信息（服务器）

   | 字段                  | 描述                                                         |
   | --------------------- | ------------------------------------------------------------ |
   | 服务器实例            | 显示 Directory 服务器实例的名称。                            |
   | 版本                  | 标识当前服务器版本。                                         |
   | 服务器已启动          | 服务器启动的日期和时间。                                     |
   | server Uptime         | 实例运行的时间。                                             |
   | Worker Threads        | 用于处理请求的当前活动线程数量。额外的线程可以由内部服务器任务创建，如复制或串联。 |
   | 线程等待读取          | 等待从客户端读取的线程总数。如果服务器开始从客户端接收请求，则线程可能不会立即读取，然后因某种原因停止该请求的传输。通常，等待读取的线程表示网络或客户端慢的问题。 |
   | conns At Max Threads  | 显示所有当前处于 **max 线程** 状态的连接。                   |
   | conns Hit Max Threads | 显示连接达到最大 **线程的次数**。                            |
   | 连接总数              | 为这个目录服务器实例建立的连接总数。                         |
   | 当前连接              | 开放连接总数。每个连接都可以考虑多个操作，因此多个线程。     |
   | 操作已启动            | 此连接启动的操作数量。                                       |
   | 操作完成              | 服务器为此连接完成的操作数量。                               |
   | 返回客户端的条目      | 自服务器启动以来发送到客户端的条目数量。                     |
   | 客户端的字节数        | 自服务器启动以来发送到客户端的字节数。                       |

## 2.2. 监控数据库活动

注意

​					由服务器监控的目录服务器数据库属性的一些计数器使用 64 位整数，即使在 32 位系统中（条目缓存点击、条目缓存尝试、当前缓存大小和最大缓存大小）。在高容量系统上，这可防止滚动的计数器的速度过快，并造成监控数据。 			

### 2.2.1. 使用命令行监控数据库活动

​					监控数据库的当前活动： 			



```none
# dsconf -D "cn=Directory Manager" ldap://server.example.com monitor backend
```

​					下表描述了命令返回的属性： 			

表 2.3. 数据库监控属性

| 属性                   | 描述                                                         |
| ---------------------- | ------------------------------------------------------------ |
| ReadOnly               | 指明数据库是否处于只读模式(**1)**或以读写模式(0)。           |
| entrycachehits         | 成功条目缓存查找的总数。该值是服务器从条目缓存检索条目的次数，而不必从数据库重新加载它。 |
| entrycachetries        | 从您启动实例以来，条目缓存查找总数。值是实例启动以来的总数，{DS} 尝试从条目缓存中检索条目。 |
| entrycachehitratio     | 条目缓存会尝试成功条目缓存查找的数量。此数字基于自上次启动实例以来的总查询和点击。条目缓存的点击率越接近为 100%，这越好。 							 							  								每当操作尝试查找条目查询时，服务器都需要访问数据库来获取条目。因此，随着这种比例下降到零，磁盘访问数量会增加，并且目录搜索性能会降低。要提高此比率，增大数据库条目缓存的大小。 							 							  								要提高此比率，通过增加 **cn=***database_name* 中的 *`nsslapd-cachememsize`* 属性的值、**cn=ldbm database,cn=plugins,cn=config** 条目来增加条目缓存的大小。 |
| currententrycachesize  | 条目缓存中当前存在的目录条目的总大小（以字节为单位）。 							 							  								要增加缓存中存在的条目的大小，增大 **cn=***database_name* 中的 *`nsslapd-cachememsize`* 属性的值，**cn=ldbm database,cn=plugins,cn=config** 条目。 |
| maxentrycachesize      | {DS} 可在条目缓存中维护的目录条目的最大大小，以字节为单位。 							 							  								要增加缓存中存在的条目的大小，增大 **cn=***database_name* 中的 *`nsslapd-cachememsize`* 属性的值，**cn=ldbm database,cn=plugins,cn=config** 条目。 |
| currententrycachecount | 存储在给定后端条目缓存中的当前条目数。                       |
| maxentrycachecount     | 存储在数据库条目缓存中的最大条目数。 							 							  								要调整这个值，增大 **cn=\*database_name\*,cn=ldbm database,cn=plugins,cn=config**中的 *`nsslapd-cachesize`* 属性的值 |
| dncachehits            | 服务器通过从 DN 缓存中获取规范化区分名称(DN)来处理请求的次数，而不是对它进行规范化。 |
| dncachetries           | 自启动实例以来，DN 缓存访问总数。                            |
| dncachehitratio        | 缓存的比例试图成功进行 DN 缓存命中。更接近这个值是 100%，越好。 |
| currentdncachesize     | DN 缓存中当前存在的 DN 的总大小（以字节为单位）。 							 							  								要增加 DN 缓存中可能存在的条目的大小，增大 **cn=***database_name* 中的 *`nsslapd-dncachememsize`* 属性的值，**cn=ldbm database,cn=plugins,cn=config** 条目。 |
| maxdncachesize         | {DS} 可以在 DN 缓存中维护的最大大小，以字节为单位。 							 							  								要增加缓存中存在的条目的大小，增大 **cn=***database_name* 中的 *`nsslapd-dncachememsize`* 属性的值，**cn=ldbm database,cn=plugins,cn=config** 条目。 |
| currentdncachecount    | DN 缓存中当前存在的 DN 数量。                                |
| maxdncachecount        | DN 缓存中允许的最大 DN 数量。                                |

### 2.2.2. 使用 Web 控制台监控数据库活动

​					使用 Web 控制台监控数据库活动： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					

2. ​							选择 实例。 					

3. ​							在 Monitoring 选项卡上，选择要显示的数据库条目。 					

4. ​							选择 Entry Cache 显示条目缓存的性能值： 					

   [![img](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/0340be1c8ba4c33408bfac28de0a5da6/db-statistics-entry-cache.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/0340be1c8ba4c33408bfac28de0a5da6/db-statistics-entry-cache.png)

   ​							下表描述了此标签页中可见的字段： 					

   表 2.4. Entry Cache 选项卡上的字段

   | 字段名称              | 描述                                                         |
   | --------------------- | ------------------------------------------------------------ |
   | entry Cache Hit Ratio | 表示条目缓存次数的比例是成功条目缓存查找。此数字基于自 目录上次启动以来的的总查询和点击。更接近这个值是  100%，越好。每当操作试图查找条目在条目缓存中时，目录都必须执行磁盘访问权限来获取条目。因此，随着这种比例下降到零，磁盘访问数量会增加，并且目录搜索性能会下降。 									 									  										要提高此比率，通过增加 **cn=***database_name* 中的 *`nsslapd-cachememsize`* 属性的值、**cn=ldbm database,cn=plugins,cn=config** 条目来增加条目缓存的大小。 |
   | entry Cache Tries     | 从目录上次启动以来条目缓存查找的总数。也就是说，自服务器启动以来请求的条目总数。 |
   | 条目缓存 Hits         | 成功条目缓存查找的总数。也就是说，服务器可以通过从缓存中获取数据而不是访问磁盘来处理搜索请求的次数。 |
   | 条目缓存最大大小      | 条目缓存的大小（以字节为单位），由 目录维护。 									 									  										此值由 database 的 **cn=***database_name*,**cn=ldbm database,cn=plugins,cn=config** 条目中的 *`nsslapd-cachememsize`* 属性管理。 |
   | 条目缓存当前大小      | 条目缓存中当前存在的目录条目数。                             |
   | 条目缓存最大条目      | *已弃用。* 									 									  										在条目缓存中维护的最大目录条目数。 									 									  										不要尝试通过设置最大允许条目数来管理缓存大小。这使得主机难以有效地分配 RAM。使用 *`nsslapd-cachememsize`* 属性设置可用于缓存的 RAM 大小来管理缓存大小。 |
   | 条目缓存数            | 条目缓存中当前存在的目录条目数。                             |

5. ​							为 DN 缓存 上的性能值选择 DN 缓存。 					

   [![img](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/9cd8f0cde22719b67b7b080034ad9a5b/db-statistics-dn-cache.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/9cd8f0cde22719b67b7b080034ad9a5b/db-statistics-dn-cache.png)

## 2.3. 监控数据库链接活动

​				也可以显示数据库链接（链数据库）的活动，但只能使用命令行： 		



```none
# dsconf -D "cn=Directory Manager" ldap://server.example.com monitor chaining
```

​				下表描述了命令返回的属性： 		

表 2.5. 数据库链路监控属性

| 属性名称                   | 描述                     |
| -------------------------- | ------------------------ |
| nsAddCount                 | 接收的添加操作数量。     |
| nsDeleteCount              | 收到删除操作的数量。     |
| nsModifyCount              | 收到修改操作的数量。     |
| nsRenameCount              | 收到的重命名操作数量。   |
| nsSearchBaseCount          | 收到的基础级搜索数量。   |
| nsSearchOneLevelCount      | 收到的一级搜索数。       |
| nsSearchSubtreeCount       | 接收的子树搜索数量。     |
| nsAbandonCount             | 接收的带外操作数。       |
| nsBindCount                | 收到的绑定请求数量。     |
| nsUnbindCount              | 收到的未绑定数量。       |
| nsCompareCount             | 收到的比较操作数量。     |
| nsOperationConnectionCount | 正常操作的打开连接数量。 |
| nsBindConnectionCount      | 绑定操作的开放连接数。   |

## 2.4. 监控本地磁盘 Graceful Shutdown

​				当系统中的磁盘空间太小时，目录服务器进程会终止。因此，数据库或松散数据存在损坏风险。 		

​				要防止这个问题，您可以配置 Directory 服务器来监控可用磁盘空间。监控线程检查包含配置、事务日志和数据库目录的文件系统上的可用空间。 		

​				根据剩余的可用磁盘空间，Directory 服务器的行为有所不同： 		

- ​						如果可用磁盘空间达到定义的阈值，Directory 服务器： 				

  - ​								禁用详细日志记录 						
  - ​								禁用访问日志 						
  - ​								删除存档的日志文件 						

  注意

  ​							目录服务器总是继续编写错误日志，即使达到阈值也是如此。 					

- ​						如果可用磁盘空间低于配置的阈值的一半，Directory 服务器会在定义的宽限期内关闭。 				

- ​						如果可用磁盘空间小于 4 KB，则目录服务器会立即关闭。 				

​				如果释放了磁盘空间，则 Directory Server 将中止关闭过程并重新启用之前禁用的所有日志设置。 		

### 2.4.1. 使用命令行配置本地磁盘监控

​					使用命令行配置本地磁盘监控： 			

1. ​							启用磁盘监控功能，设置阈值和宽限期： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com config replace nsslapd-disk-monitoring=on nsslapd-disk-monitoring-threshold=3000000000 nsslapd-disk-monitoring-grace-period=60
   ```

   ​							这个命令将可用磁盘空间的阈值设置为 3 GB，宽限期设置为 60 秒。 					

2. ​							另外，还可启用 *`nsslapd-disk-monitoring-logging-critical`* 参数，配置 Directory 服务器并不禁用访问日志或删除归档的日志： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com config replace nsslapd-disk-monitoring-logging-critical=on
   ```

3. ​							重启 Directory 服务器实例： 					

   

   ```none
   # dsctl instance_name restart
   ```

### 2.4.2. 使用 Web 控制台配置本地磁盘监控

​					使用 Web 控制台配置本地磁盘监控： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					

2. ​							选择 实例。 					

3. ​							打开 Server Settings 菜单，然后选择 Server Configuration。 					

4. ​							启用 启用磁盘空间监控，并以字节和宽限期（以分钟为单位）设置阈值。 					

   [![img](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/464c954361d8df7ad97e1663885d63af/configure-local-disk-space-monitoring.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/464c954361d8df7ad97e1663885d63af/configure-local-disk-space-monitoring.png)

   ​							这个示例将监控阈值设置为 3 GB（3,221,225,472 字节），并在 Directory 服务器达到阈值 **60** 分钟后关闭实例前的时间。 					

5. ​							另外，还可选择 Preserve Logs 来配置 Directory 服务器都无法禁用访问日志或删除归档的日志。 					

6. ​							点 Save Configuration。 					

7. ​							点 Actions 按钮，然后选择 Restart Instance。 					

## 2.5. 提高日志记录性能

​				大型目录服务器部署可以创建大量日志内容。要提高负载较重的性能，禁用访问日志缓冲。禁用访问日志缓冲后，目录服务器将日志条目直接写入磁盘。 		

重要

​					访问日志有助于调试服务器中的问题，并监控客户端连接以及失败的连接尝试。不要在正常操作环境中禁用访问日志。 			

### 2.5.1. 使用命令行禁用访问日志缓冲

​					使用命令行禁用日志缓冲： 			

1. ​							将 *`nsslapd-accesslog-logbuffering`* 参数设置为 **off** ： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com config replace nsslapd-accesslog-logbuffering=off
   ```

2. ​							重启 Directory 服务器实例： 					

   

   ```none
   # dsctl instance_name restart
   ```

### 2.5.2. 使用 Web 控制台禁用访问日志缓冲

​					使用 Web 控制台禁用访问日志缓冲： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					
2. ​							选择 实例。 					
3. ​							打开 Server Settings → Logging → Access Log。 					
4. ​							选择 Disable Access Log Buffering。 					
5. ​							点 Save Configuration。 					
6. ​							点 Actions 按钮，然后选择 Restart Instance。 					

# 第 3 章 调整锁定数

​			锁定目录服务器中的机制控制目录服务器进程可以同时运行多少个副本。例如，在导入作业的过程中，Directory 服务器会在 `/run/lock/dirsrv/slapd-*instance_name*/imports/` 目录中设置一个锁定，以防止 **ns-slapd** （Directory 服务器）进程、另一个导入或导出操作。 	

​			如果服务器没有可用锁定，则会在 `/var/log/dirsrv/slapd-*instance_name*/errors` 文件中记录以下错误： 	



```none
libdb: Lock table is out of available locks
```

​			如果错误消息显示锁定表没有可用锁定，请加倍锁定的数量。如果问题仍然存在，请再次双倍。 	

## 3.1. 手动监控锁定数

​				要使用命令行监控锁定数量，请输入： 		



```none
# ldapsearch -D "cn=Directory Manager" -W -p 389 -h server.example.com -x
     -s sub -b "cn=database,cn=monitor,cn=ldbm database,cn=plugins,cn=config"
     nsslapd-db-current-locks nsslapd-db-max-locks
```

​				有关监控属性的详情，请查看 [目录服务器配置、命令和文件参考中的](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/configuration_command_and_file_reference/plug_in_implemented_server_functionality_reference#Database_Attributes_under_cnbdb_cnconfig_cnldbm_database_cnplugins_cnconfig) 描述。 		

## 3.2. 通过监控自由数据库锁定来避免数据崩溃

​				不使用数据库锁定可能会导致数据崩溃。要避免这种情况，默认情况下 Directory 服务器会监控剩余的可用数据库数量，且主动数据库锁定数量等于或大于 90% 时，目录服务器会中止所有搜索。 		

​				您可以更改间隔和阈值： 		

1. ​						例如，要将间隔设置为 **600** 毫秒，并将阈值设置为 **85%**，请输入： 				

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com backend config set --locks-monitoring-enabled on --locks-monitoring-pause 600 --locks-monitoring-threshold 85
   ```

   ​						`--locks-monitoring-enabled on` 选项确保已启用该功能。 				

   注意

   ​							如果您设置太高的间隔，服务器可以在下一次监控检查发生前耗尽锁定。设置太短的间隔可能会减慢服务器的速度。 					

2. ​						重启实例： 				

   

   ```none
   # dsctl instance_name restart
   ```

## 3.3. 使用命令行设置锁定数

​				使用命令行设置锁定数量： 		

1. ​						使用 **dsconf backend config set** 命令更新锁定数量。例如，要将值设为 **20000** ： 				

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com backend config set --locks=20000
   ```

2. ​						重启 Directory 服务器实例： 				

   

   ```none
   # dsctl instance_name restart
   ```

## 3.4. 使用 Web 控制台设置锁定数

​				使用 Web 控制台设置锁定数量： 		

1. ​						在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 				
2. ​						选择 实例。 				
3. ​						打开 Database 菜单，然后选择 Global Database Configuration。 				
4. ​						单击 Show Advanced Settings。 				
5. ​						更新 Database Locks 字段中的值。 				
6. ​						点 Save Configuration。 				
7. ​						点 Actions 按钮，然后选择 Restart Instance。 				

# 第 4 章 提高搜索性能（及平衡读取性能）

​			为目录改进搜索操作的最有效方法是，为条目配置全面的索引，以及对搜索结果的合理限制。 	

## 4.1. 使用索引

​				索引（如它表示）是一个标签，显示特定条目包含特定属性，而不必包含与条目相关的任何其他详情（这样可节省空间并更快返回搜索结果）。每个索引都围绕 Directory Server 属性进行组织，并以某种方式与该属性匹配： 		

- ​						*存在索引（已弃用）* 只是显示哪个条目包含属性。 				
- ​						*等性索引(eq)* 显示与特定搜索字符串匹配的属性值。 				
- ​						*大约索引(approx)* 用于高效的声音搜索，显示具有可手机与字符串匹配的值的条目。 				
- ​						子字符串 *索引(sub)* 将属性值的任何子字符串与给定的搜索字符串匹配。（如果服务器维护非常昂贵，此索引就会非常昂贵。） 				
- ​						*国际索引* 使用匹配规则来匹配目录中的字符串，其中包含英语以外的语言值。 				

注意

​					*Red Hat Directory Server Administration Guide* 中的 [*管理索引*](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/managing_indexes) 章节中包括了更详细的信息。 			

​				但是，只创建索引不会直接提高服务器性能。维护索引通过针对服务器维护的每个索引验证更改中的每个属性，从而在每次修改、添加和删除操作方面都造成负担： 		

1. ​						目录服务器收到一项添加或修改操作。 				
2. ​						目录服务器检查索引属性，以确定是否为属性值维护索引。 				
3. ​						如果创建的属性值被索引，则 Directory 服务器会生成新的索引条目。 				
4. ​						服务器完成后，会根据客户端请求创建实际属性值。 				

​				例如，Directory 服务器添加该条目： 		



```none
dn: cn=John Doe, ou=People,dc=example,dc=com
objectclass: top
objectClass: person
objectClass: orgperson
objectClass: inetorgperson
cn: John Doe
cn: John
sn: Doe
ou: Manufacturing
ou: people
telephoneNumber: 408 555 8834
description: Manufacturing lead for the Z238 line of widgets.
```

​				Directory 服务器正在维护以下索引： 		

- ​						等于性、approximate 和 substring 索引用于 *`cn`* （通用名称）和 *`sn`* (surname)属性。 				
- ​						平板和子字符串索引，用于电话编号属性。 				
- ​						description 属性的子字符串索引。 				

​				当在目录中添加该条目时，Directory 服务器必须执行以下步骤： 		

1. ​						为 **John** 和 **John Doe** 创建 *`cn`* equality 索引条目。 				
2. ​						为 **John** 和 **John Doe** 创建适当的 *`cn`* approximate 索引条目。 				
3. ​						为 **John** 和 **John Doe** 创建适当的 *`cn`* 子字符串索引条目。 				
4. ​						为 **Doe** 创建相等的索引条目。*``* 				
5. ​						为 **Doe** 创建适当的 *`sn`* approximate 索引条目。 				
6. ​						为 **Doe** 创建适当的 *`sn`* 子字符串索引条目。 				
7. ​						为 **408 555 8834** 创建电话号码等索引条目。 				
8. ​						为 **408 555 8834** 创建合适的电话号码子字符串索引条目。 				
9. ​						为 **Z238 行的小部件** 创建适当的描述子字符串索引条目。为字符串生成大量子字符串条目。 				

​				在创建新索引前，请确定平衡索引的开销与搜索性能的潜在改进。特别重要的是，请将您维护的索引类型与目录中存储的信息类型以及用户通常搜索的信息类型匹配。 		

- ​						对于通常包含数字（如电话号码）的属性而言，大约索引效率不高。 				
- ​						子字符串索引无法用于二进制属性。 				
- ​						如果值较大（例如旨在包含摄影或含有加密数据的密码的属性），则应避免使用相等的索引。 				
- ​						在搜索中，维护不使用的属性的索引会增加开销，而不会提高全局搜索性能。 				
- ​						没有索引的属性仍可在搜索请求中指定，但根据搜索类型，搜索性能可能会有很大降级。 				
- ​						您维护的索引越大，所需的磁盘空间就越高。 				

注意

​					创建索引对于具有高搜索操作负载和低修改操作负载的目录更有效。 			

## 4.2. 调优 Directory 服务器资源设置

​				您可以配置多个参数来管理并改进 Directory 服务器使用的资源数量。 		

### 4.2.1. 使用命令行更新目录服务器资源设置

​					使用命令行更新服务器资源设置： 			

1. ​							更新性能设置： 					

   

   ```none
    dsconf -D "cn=Directory Manager" ldap://server.example.com config replace parameter_name=setting
   ```

   ​							您可以设置以下参数： 					

   - ​									*`nsslapd-threadnumber`*: 设置 worker 线程的数量。 							
   - ​									*`nsslapd-maxdescriptors`* ：设置最大文件描述符数。 							
   - ​									*`nsslapd-timelimit`* ：设置搜索时间限制。 							
   - ​									*`nsslapd-sizelimit`* ：设置搜索大小限制。 							
   - ​									*`nsslapd-pagedsizelimit`*: 设置页面的搜索大小限制。 							
   - ​									*`nsslapd-idletimeout`* ：设置闲置连接超时。 							
   - ​									*`nsslapd-ioblocktimeout`* ：设置输入/输出(I/O)块超时。 							
   - ​									*`nsslapd-ndn-cache-enabled`*: enableds 或禁用规范化 DN 缓存。 							
   - ​									*`nsslapd-ndn-cache-max-size`*: 设置规范化 DN 缓存大小，如果启用了 *`nsslapd-ndn-cache-enabled`*。 							
   - ​									*`nsslapd-outbound-ldap-io-timeout`* ：设置出站 I/O 超时。 							
   - ​									*`nsslapd-maxbersize`*: 设置最大基本编码规则(BER)大小。 							
   - ​									*`nsslapd-maxsasliosize`* ：设置最大 Simple Authentication 和 Security Layer(SASL)I/O 大小。 							
   - ​									*`nsslapd-listen-backlog-size`* ：设置可用于接收进入的连接的最大套接字数。 							
   - ​									*`nsslapd-max-filter-nest-level`*: 设置最大嵌套过滤器级别。 							
   - ​									*`nsslapd-ignore-virtual-attrs`* ：启用或禁用虚拟属性查找。 							
   - ​									*`nsslapd-connection-nocanon`*: Enables 或 disable revers DNS 查找。 							
   - ​									*`nsslapd-enable-turbo-mode`*: enableds 或禁用 turbo 模式功能。 							

   ​							有关这些参数的详情，请查看其在 [*Red Hat Directory Server Configuration、命令和文件参考中的描述。*](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/configuration_command_and_file_reference/i) 					

2. ​							重启 Directory 服务器实例： 					

   

   ```none
   # dsctl instance_name restart
   ```

### 4.2.2. 使用 Web 控制台更新目录服务器资源设置

​					使用 Web 控制台更新服务器资源设置： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					

2. ​							选择 实例。 					

3. ​							打开 Server Settings 菜单，然后选择 Tuning & Limits。 					

4. ​							更新设置。（可选）点击 Show Advanced Settings 显示所有设置。 					

   [![img](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/1b0be130c3e66e8e6d541820928c9cc2/tuning-and-limits.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/1b0be130c3e66e8e6d541820928c9cc2/tuning-and-limits.png)

   ​							要显示一个参数提示和 **cn=config** 条目中的对应属性名称，请将鼠标光标悬停在设置中。详情请查看 [*红帽目录服务器配置、命令和文件参考中的参数描述。*](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/configuration_command_and_file_reference/core_server_configuration_reference#cnconfig-nsslapd_ndn_cache_max-size) 					

5. ​							点 Save Configuration。 					

6. ​							点 Actions 按钮，然后选择 Restart Instance。 					

## 4.3. 设置索引扫描限制

​				在大型目录中，搜索结果列表会变得非常大。具有一百万级生产人条目的目录将具有像 **(objectclass= \**inetorgperson\** )** 等过滤器的一百万条目，而 *`sn`* 属性的索引将至少有一百万个条目。 		

​				从数据库加载长 ID 列表可显著降低搜索性能。配置参数 **nsslapd-idlistscanlimit** 会为在键考虑与整个主索引前读取的 ID 数量设置一个限制（将搜索被视为一个未索引搜索，具有不同一组资源限制）。 		

​				对于大型索引，实际上，将与索引匹配的搜索视为未索引搜索时更有效。搜索操作只能查找处理结果（整个目录）的一个位置，而不要搜索几乎是目录大小的索引，加上目录本身。 		

​				**nsslapd-idlistscanlimit** 属性的默认值为 **4000**，它为常见数据库大小和访问模式提供良好的性能。通常不需要更改此值。如果数据库索引的小于 4000 条目，但仍然小于总体目录，则增加扫描限制可提高搜索，否则达到 4000 的默认限制。 		

​				另一方面，降低限制可能会显著提高搜索速度，否则按 4000 条目限制，但不需要扫描每个条目的位置。 		

### 4.3.1. 使用命令行设置索引扫描限制

​					使用命令行设置索引扫描限制： 			

1. ​							例如，要将目录服务器在搜索操作期间搜索的条目 ID 数设置为 **8000** ： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com backend config set --idlistscanlimit=8000
   ```

2. ​							重启 Directory 服务器实例： 					

   

   ```none
   # dsctl instance_name restart
   ```

### 4.3.2. 使用 Web 控制台设置索引扫描限制

​					使用 Web 控制台设置索引扫描限制： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					
2. ​							选择 实例。 					
3. ​							在 Database 选项卡中，选择 Global Database Configuration。 					
4. ​							更新 ID List Scan Limit 字段中的值。 					
5. ​							点 Save Configuration。 					
6. ​							点 Actions 按钮，然后选择 Restart Instance。 					

## 4.4. 精细约束 ID 列表大小

​				在大型数据库中，一些查询可能会消耗大量 CPU 和 RAM 资源。要提高性能，您可以使用 **nsslapd-idlistscanlimit** 属性设置默认 ID 扫描限制。但是，在某些情况下，为特定索引定义限制或不使用 ID 列表非常有用。您可以使用 **nsIndexIDListScanLimit** 属性为不同类型的搜索过滤器设置单独的 ID 列表扫描限制。 		

​				要设置限制，例如 *`objectClass`* 属性，将 **nsIndexIDListScanLimit** 参数添加到 DN `cn=objectclass,cn=index,cn=userRoot,cn=ldbm 数据库,cn=plugins,cn=config`。 		

​				**nsIndexIDListScanLimit** 属性被多值，并将以下参数列表作为值取： 		



```none
nsIndexIDListScanLimit: limit=NNN [type=eq[,sub,...]] [flags=AND[,XXX,...]] [values=val[,val,...]]
```

- ​						`limit`: ID 列表的最大大小。有效值为： 				

  - ​								`-1`:无限. 						
  - ​								`0` ：不要使用索引。 						
  - ​								`1 到最大 32 位整数(2147483647)`: 最大 ID 数。 						

- ​						`键入`: 可选。索引的类型。`EQ`、`sub`、`pres` 等等。该值必须是为索引定义指定的实际 *`nsIndexType`* 之一。例如，如果没有定义 **nsIndexType=eq**，则无法使用 **type=eq**。 				

- ​						`标志` ：可选。更改应用扫描限制行为的标记。有效值为： 				

  - ​								`AND` ：仅应用扫描限制，以搜索哪个属性出现在 **AND** 子句中。 						
  - ​								`或` ：仅应用扫描限制，以搜索在 **OR** 子句中出现的属性。 						

- ​						`值` ：可选。要应用限制，以逗号分隔的值列表必须与搜索过滤器匹配。由于匹配一次是一次的，因此如果任何值匹配，值将会匹配。 				

  ​						值必须一次只用于一种类型。 				

  ​						值必须与索引类型对应，且必须与应用索引的属性的语法对应。例如，如果您指定了基于整数的属性 *`uidNumber`* 且为 `eq` 索引，则无法使用 **type=eq 值=abc**。 				

  ​						如果值包含需要转义的空格、逗号、NULL 或其他值，则应使用 LDAP 过滤器转义语法：反斜杠(\)，后接该字符的 2 位数字代码。在以下示例中，DN 值中的逗号使用 `\2C` 转义。 				

  

  ```none
  nsIndexIDListScanLimit: limit=0 type=eq values=uid=user\2Cou=People\2Cdc=example\2Cdc=com
  ```

例 4.1. Setting nsIndexIDListScanLimit

​					在包含对象类 `inetOrgPerson` 的一大数据库中，搜索 **（&(objectClass=inetOrgPerson)(uid=user)**，首先创建一个包含所有 1,000万 ID 匹配 **objectClass=inetOrgPerson** 的 ID 列表。当数据库应用过滤器的第二部分时，它会搜索与 **uid=user** 匹配的对象结果列表。在这种情况下，定义特定索引的限制或全部不使用 ID 列表非常有用。 			

​					要在 **AND** 子句中为 **objectClass=inetOrgPerson** 创建 ID 列表，请添加以下 **nsIndexIDListScanLimit**: 			



```none
# ldapmodify -D "cn=Directory Manager" -W -p 389 -h server.example.com -x
dn: cn=objectclass,cn=index,cn=userRoot,cn=ldbm database,cn=plugins,cn=config
changetype: modify
replace: nsIndexIDListScanLimit
nsIndexIDListScanLimit: limit=0 type=eq flags=AND values=inetOrgPerson

modifying entry "cn=objectclass,cn=index,cn=userRoot,cn=ldbm database,cn=plugins,cn=config"
```

​					在 **AND** 中使用时，不会为 **objectClass=inetOrgPerson** 创建 ID 列表。在所有其他情况下，应用 *`nsslapd-idlistscanlimit`* 的值。 			

## 4.5. 为搜索调整数据库缓存

​				影响搜索性能的数据库属性主要定义供服务器使用的内存量。可以为数据库缓存大小属性设置的最大值取决于机器上的实际内存量。粗略地说，计算机上的可用内存量始终应大于默认数据库缓存大小的总和，以及每个条目缓存大小的总和。 		

​				在更改这些缓存大小属性时要小心。使用这些属性提高服务器性能取决于数据库的大小、机器上可用的物理内存以及目录搜索是否随机（也就是说，如果目录客户端正在搜索随机且广泛分散的目录数据）。 		

​				如果数据库不适合于内存，如果搜索是随机的，请尝试增加这些属性上设置的值不会帮助目录性能。实际上，更改这些属性可能会给整体性能造成负面影响。 		

​				用于存储目录数据的每个数据库的属性可以调整大小。 		

​				要提高搜索操作的缓存命中率，请通过编辑 *`nsslapd-dbcachesize`* 参数的值来增加 Directory 服务器在数据库缓存中维护的数据量，如 [第 6.5 节 “设置数据库缓存大小”](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#tuning-db-cache) 所述。 		

## 4.6. 管理特殊条目

​				目录服务器将 **cn=config** 条目存储在 `/etc/dirsrv/slapd-*instance_name*/dse.ldif` 配置文件中，而不会像常规条目一样在同一高度可扩展的数据库中。因此，不要将常规用户或组存储在 **cn=config** 中。 		

# 第 5 章 调整事务日志记录

​			每个目录服务器包含一个事务日志，负责编写它所管理的所有数据库的操作。每当执行修改等目录数据库操作时，服务器都会为该 LDAP  操作调用的所有数据库操作创建一个数据库事务。这包括更新条目索引文件中的条目数据，并更新所有属性索引。如果所有操作都成功，服务器会提交事务，将操作写入事务日志，并验证整个事务是否已写入到磁盘。*如果其中任何* 这些操作失败，服务器会回滚事务，并且丢弃所有操作。在服务器上，这种方法以原子方式保证更新操作是 *原子* 的。整个操作会永久成功，且不可避免，或者失败。 	

​			目录服务器（通过内部托管线程）将事务日志的内容刷新到实际数据库索引文件中，并检查事务日志是否需要修剪。 	

​			如果服务器遇到失败（如关机），并正常关闭，则有关最近目录更改的信息仍由事务日志保存。服务器重启时，目录会自动检测到错误条件，并使用数据库事务日志来恢复数据库。 	

​			虽然数据库事务日志和数据库恢复是无需干预的自动过程，但建议您调优一些数据库事务日志属性来优化性能。 	

警告

​					事务日志记录属性仅适用于系统修改和诊断。这些设置应该只在红帽技术支持的指导下修改。设置这些属性和其他配置属性不一致，可能会导致目录不稳定。 			

## 5.1. 将数据库目录移到 9 月磁盘或分区中

​				要实现更高的性能，在快速驱动器中存储目录服务器数据库和事务日志，如非易失性内存 express(NVMe)驱动器或 SSD。 		

​				例如，如果您已经运行 Directory 服务器实例，并希望将 `/dev/nvme0n1p1` 分区挂载到 `/var/lib/dirsrv/slapd-*instance_name*/db/` 目录： 		

1. ​						停止实例： 				

   

   ```none
   # systemctl stop dirsrv@instance_name
   ```

2. ​						将 `/dev/nvme0n1p1` 分区挂载到一个临时目录中。例如： 				

   

   ```none
   # mount /dev/nvme0n1p1 /mnt/
   ```

3. ​						将 `/var/lib/dirsrv/slapd-*instance_name*/db/` 目录中的内容复制到临时挂载点： 				

   

   ```none
   # mv /var/lib/dirsrv/slapd-instance_name/db/* /mnt/
   ```

4. ​						卸载临时目录： 				

   

   ```none
   # umount /mnt/
   ```

5. ​						如果 `/var/lib/dirsrv/slapd-*instance_name*/db/` 也是一个单独的挂载点，卸载该目录： 				

   

   ```none
   # umount /var/lib/dirsrv/slapd-instance_name/db/
   ```

6. ​						当系统引导时，更新 `/etc/fstab` 文件，以将 `/dev/nvme0n1p1` 分区自动挂载到 `/var/lib/dirsrv/slapd-*instance_name*/db/`。详情请查看 [*Red Hat System Administrator 指南中的对应*](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-access_control_lists#s1-acls-mounting) 部分。 				

7. ​						挂载文件系统。如果您将条目添加到 `/etc/fstab` 中： 				

   

   ```none
   # mount /var/lib/dirsrv/slapd-instance_name/db/
   ```

8. ​						如果 SELinux 在 **enforcing** 模式下运行，请恢复 SELinux 上下文： 				

   

   ```none
   # restorecon -Rv /var/lib/dirsrv/slapd-instance_name/db/
   ```

9. ​						启动实例： 				

   

   ```none
   # systemctl start dirsrv@instance_name
   ```

## 5.2. 更改数据库检查点 Interval

​				在常规时间段内，Directory 服务器会将操作写入事务日志中的数据库索引文件，并在数据库事务日志中记录检查点条目。通过指示已将哪些更改写入数据库索引，检查点条目表示从事务日志开始恢复的位置，从而加快恢复过程。 		

​				默认情况下，Directory 服务器设置为每 60  秒向数据库事务日志发送检查点条目。增加检查点间隔可能会增加目录写入操作的性能。但是，增加检查点间隔可能会增加在关闭后恢复目录数据库所需的时间，并且由于数据库事务日志文件而需要更多磁盘空间。因此，如果您熟悉数据库优化，且可以完全评估更改的影响，才修改此属性。 		

### 5.2.1. 使用命令行更改数据库检查点 Interval

​					要使用命令行更改数据库检查点间隔，请输入： 			



```none
# dsconf -D "cn=Directory Manager" ldap://server.example.com backend config set --checkpoint-interval=120
```

​					这个示例将间隔更改为 120 秒。 			

### 5.2.2. 使用 Web 控制台更改数据库检查点 Interval

​					使用 Web 控制台更改数据库检查点间隔： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					
2. ​							选择 实例。 					
3. ​							在 Database 选项卡中，选择 Global Database Configuration。 					
4. ​							单击 Show Advanced Settings。 					
5. ​							更新 Database Checkpoint Interval 字段中的值。 					
6. ​							点 Save Configuration。 					

## 5.3. 禁用 Durable Transactions

​				持久的事务日志记录意味着每个 LDAP 更新操作（由事务中的一系列数据库操作组成）是物理写入磁盘。尽管每个 LDAP  操作都可以由多个数据库操作组成，但每个 LDAP 操作都被视为一个数据库事务。每个 LDAP 操作既是 atomic 和 durable。 		

警告

​					关闭 durable 事务可让您提高 Directory Server 的写入性能，而出现数据丢失的风险。 			

​				 禁用持久的事务日志记录时，每个目录数据库操作都会写入数据库事务日志文件，但可能不会立即实际写入磁盘。如果目录更改被写入逻辑数据库事务日志文件，但没有在系统崩溃时物理写入磁盘，则无法恢复更改。禁用持久事务后，恢复的数据库是一致的，但不反映在系统崩溃之前完成的任何 LDAP 写入操作的结果。 		

​				默认情况下启用持久的数据库事务日志记录。禁用持久的事务日志： 		

1. ​						停止 Directory 服务器实例： 				

   

   ```none
   # dsctl instance_name stop
   ```

2. ​						编辑 `/etc/dirsrv/slapd-*instance_name*/dse.ldif` 文件，并将 **cn=config,cn=ldbm database,cn=plugins,cn=config** 条目中的 *`nsslapd-db-durable-transaction`* 参数设置为 **off** ： 				

   

   ```none
   dn: cn=config,cn=ldbm database,cn=plugins,cn=config
   ...
   nsslapd-db-durable-transaction: off
   ...
   ```

3. ​						启动 Directory 服务器实例： 				

   

   ```none
   # dsctl instance_name start
   ```

## 5.4. 指定事务批处理

​				要在不需要完全事务持久性时提高更新性能，请使用以下命令： 		



```none
# dsconf -D "cn=Directory Manager" ldap://server.example.com backend config set --txn-batch-val=value
```

​				*`--txn-batch-val`* 指定在目录服务器提交到事务日志中之前批量的事务数量。将此值设置为大于 **0** 的值会导致服务器延迟提交事务，直到排队的事务数量等于这个值。 		

# 第 6 章 管理数据库缓存设置

​			目录服务器使用以下缓存： 	

- ​					*Entry cache*，其中包含单个目录条目。 			
- ​					*DN 缓存* 用于将 DN 和 RDN 与条目相关联。 			
- ​					数据库缓存，其中包含数据库索引文件 `*.db` 和 `*.db4` 文件。 			

​			为了提高性能，所有缓存大小都必须能够存储其所有记录。如果不使用推荐的自动大小功能，且没有足够可用的 RAM，请在前面显示的顺序为缓存分配可用内存。 	

## 6.1. Database 和 Entry Cache Auto-Sizing 功能

​				默认情况下，Directory 服务器会自动决定数据库和条目缓存的最佳大小。在实例启动时，自动大小会根据服务器的硬件资源优化这两个缓存的大小。 		

重要

​					红帽建议使用自动调整设置。不要手动设置条目缓存大小。 			

### 6.1.1. 手动重新启用数据库和条目缓存自动大小

​					如果您从 10.1.1 之前的版本升级实例，或者之前手动设置条目缓存大小，您可以为条目缓存启用自动调整。 			

​					**cn=config,cn=ldbm database,cn=plugins,cn=config** 条目中的以下参数控制自动大小： 			

- *`nsslapd-cache-autosize`*

  ​								这个设置控制是否为数据库和条目缓存启用自动大小。自动大小被启用：  						 									对于数据库和条目缓存，如果 *`nsslapd-cache-autosize`* 参数设置为大于 **0** 的值。 								 									对于数据库缓存，如果 *`nsslapd-cache-autosize`* 和 *`nsslapd-dbcachesize`* 参数设置为 **0。** 								 									对于条目缓存，如果 *`nsslapd-cache-autosize`* 和 *`nsslapd-cachememsize`* 参数设置为 **0。** 								

- *`nsslapd-cache-autosize-split`*

  ​								该值设定用于数据库缓存的 RAM 百分比。剩余百分比用于条目缓存。 						 							将 1.5 GB RAM 用于数据库缓存不会提高性能。因此，Directory 服务器会限制数据库缓存 1.5 GB。 						

​					启用数据库和条目缓存自动大小： 			

1. ​							停止 Directory 服务器实例： 					

   

   ```none
   # systemctl stop dirsrv@instance_name
   ```

2. ​							备份 `/etc/dirsrv/slapd-*instance_name*/dse.ldif` 文件： 					

   

   ```none
   # cp /etc/dirsrv/slapd-instance_name/dse.ldif \
        /etc/dirsrv/slapd-instance_name/dse.ldif.bak.$(date "+%F_%H-%M-%S")
   ```

3. ​							编辑 `/etc/dirsrv/slapd-*instance_name*/dse.ldif` 文件：  					

   1. ​									设置用于数据库和条目缓存的可用系统 RAM 百分比。例如，设置 10%： 							

      

      ```none
      nsslapd-cache-autosize: 10
      ```

      注意

      ​										如果将 *`nsslapd-cache-autosize`* 参数设置为 **0，** 则必须额外设置： 								

      - ​												*`nsslapd-dbcachesize`* in the **cn=config,cn=ldbm database,cn=plugins,cn=config** entry to **0** 以启用自动化数据库缓存。 										
      - ​												*`nsslapd-cachememsize`* in the **cn=\*database_name\*,cn=ldbm database,cn=plugins,cn=config** 条目为 **0** 启用一个数据库的 auto-sized 条目缓存。 										

   2. ​									另外，还可为数据库缓存设置可用系统 RAM 中所使用的百分比。例如，设置 40%： 							

      

      ```none
      nsslapd-cache-autosize-split: 40
      ```

      ​									目录服务器将剩余的 60% 的可用内存用于条目缓存。 							

   3. ​									保存更改。 							

4. ​							启动 Directory 服务器实例： 					

   

   ```none
   # systemctl start dirsrv@instance_name
   ```

例 6.1. nsslapd-cache-autosize 和 nsslapd-cache-autosize-split Parameter

​						以下设置是这两个参数的默认设置： 				



```none
nsslapd-cache-autosize: 10
nsslapd-cache-autosize-split: 40
```

​						使用这些设置时，将使用系统的可用 RAM 的 10%(*`nsslapd-cache-autosize`*)。在这个内存中，40% 用于数据库缓存(*`nsslapd-cache-autosize-split`*)和剩余的 60% 用于条目缓存。 				

​						根据可用 RAM，这会导致以下缓存大小： 				

| 可用 RAM 的 GB                                               | 数据库缓存大小                                               | 条目缓存大小 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------ |
| 1 GB                                                         | 40 MB                                                        | 62 MB        |
| 2 GB                                                         | 82 MB                                                        | 122 MB       |
| 4 GB                                                         | 164 MB                                                       | 245 MB       |
| 8 GB                                                         | 328 MB                                                       | 492 MB       |
| 16 GB                                                        | 512 MB[[a\]](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#ftn.fn.512mb_dbcache_limit) | 1,126 MB     |
| 32 GB                                                        | 512 MB [[a\]](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#ftn.fn.512mb_dbcache_limit) | 2,764 MB     |
| 64 GB                                                        | 512 MB [[a\]](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#ftn.fn.512mb_dbcache_limit) | 6,042 MB     |
| 128 GB                                                       | 512 MB [[a\]](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#ftn.fn.512mb_dbcache_limit) | 12,596 MB    |
| [[a\] ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#fn.512mb_dbcache_limit) 										目录服务器为 *`nsslapd-dbcachesize`* 参数应用 512 MB 限制。 |                                                              |              |

## 6.2. 确定所需的缓存大小

​				**dsconf 监控 dbmon** 命令可让您在运行时监控缓存统计信息。 		

​				要显示统计信息，请输入： 		



```none
# dsconf -D "cn=Directory Manager" ldap://server.example.com monitor dbmon
DB Monitor Report: 2020-06-24 11:31:27
--------------------------------------------------------
Database Cache:
 - Cache Hit Ratio:     50%
 - Free Space:          397.31 KB
 - Free Percentage:     2.2%
 - RO Page Drops:       0
 - Pages In:            2934772
 - Pages Out:           219075

Normalized DN Cache:
 - Cache Hit Ratio:     60%
 - Free Space:          19.98 MB
 - Free Percentage:     99.9%
 - DN Count:            100000
 - Evictions:           9282348

Backends:
  - dc=example,dc=com (userroot):
    - Entry Cache Hit Ratio:        66%
    - Entry Cache Count:            50000
    - Entry Cache Free Space:       2.0 KB
    - Entry Cache Free Percentage:  0.8%
    - Entry Cache Average Size:     8.9 KB
    - DN Cache Hit Ratio:           21%
    - DN Cache Count:               100000
    - DN Cache Free Space:          4.29 MB
    - DN Cache Free Percentage:     69.8%
    - DN Cache Average Size:        130.0 B
```

​				（可选）将 `-b *back_end*` 或 `-x` 选项传递给命令，以显示特定后端或索引的统计信息。 		

​				如果您的缓存大小足够大小，则 `DN 缓存计数` 中的数字与 `Cache Count` 后端条目中的值匹配。另外，如果所有条目和 DN 适合在其各自的缓存中，则 `Entry Cache Count` 值与 `DN Cache Count` 值匹配。 		

​				示例输出显示： 		

- ​						只有 2.2% 的空闲数据库缓存才会保留： 				

  

  ```none
  Database Cache:
   ...
   - Free Space:          397.31 KB
   - Free Percentage:     2.2%
  ```

  ​						但是，为了有效地操作，至少需要 15% 免费数据库缓存。要确定数据库缓存的最佳大小，请计算 `/var/lib/dirsrv/slapd-*instance_name*/db/` 目录中的所有 `*.db` 和 `*.db4` 文件的大小，包括子目录和 changelog 数据库，以及为开销添加 12%。 				

  ​						要设置数据库缓存，请参阅 [第 6.5 节 “设置数据库缓存大小”](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#tuning-db-cache)。 				

- ​						`userroot` 数据库的 DN 缓存良好： 				

  

  ```none
  Backends:
    - dc=example,dc=com (userroot):
      ...
      - DN Cache Count:               100000
      - DN Cache Free Space:          4.29 MB
      - DN Cache Free Percentage:     69.8%
      - DN Cache Average Size:        130.0 B
  ```

  ​						数据库的 DN 缓存包含 100000 记录，即缓存的 69,8% 可用，内存中的每个 DN 平均需要 130 字节。 				

  ​						要设置 DN 缓存，请参阅 [第 6.4 节 “设置 DN 缓存的大小”](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#tuning-dn-cache)。 				

- ​						`userroot` 数据库条目缓存的统计表示应提高条目缓存值，以获得更好的性能： 				

  

  ```none
  Backends:
    - dc=example,dc=com (userroot):
    ...
      - Entry Cache Count:            50000
      - Entry Cache Free Space:       2.0 KB
      - Entry Cache Free Percentage:  0.8%
      - Entry Cache Average Size:     8.9 KB
  ```

  ​						条目缓存包含在这个数据库 50000 记录中，仅保留有 2 个千字节可用空间。要启用目录服务器缓存所有 100000  DN，缓存必须增加到最小 890 MB（100000 DNs * 8,9 KB 平均条目大小）。但是，红帽建议将最低要求大小调整到下一个最高  GB 并加倍。在这个示例中，条目缓存应设置为 2 千兆字节。 				

  ​						要设置条目缓存，请参阅 [第 6.3 节 “手动设置 Entry Cache Size”](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#tuning-entry-cache)。 				

## 6.3. 手动设置 Entry Cache Size

​				条目缓存用于存储搜索和读取操作中使用的目录条目。将条目缓存设置为可让 Directory 服务器存储所有记录的最高性能影响。 		

​				如果没有配置条目缓存，Directory 服务器会从 `id2entry.db` 数据库文件中读取条目，并将 on-disk 格式的 DN 转换为 in-memory 格式。存储在缓存中的条目可让服务器跳过磁盘 I/O 和转换步骤。 		

注意

​					红帽建议自动根据硬件资源优化设置，而不是手动设置条目缓存大小。详情请查看 [第 6.1.1 节 “手动重新启用数据库和条目缓存自动大小”](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#enable_db_and_entry_cache_auto-sizing)。 			

### 6.3.1. 使用命令行手动设置条目缓存大小

​					使用命令行手动设置条目缓存大小： 			

1. ​							禁用自动缓存调整： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com backend config set --cache-autosize=0
   ```

2. ​							显示后缀及其对应的后端： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com suffix list
   dc=example,dc=com (userroot)
   ```

   ​							这个命令显示每个后缀旁的后端数据库名称。下一步需要后缀的数据库名称。 					

3. ​							为数据库设置条目缓存大小： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com backend suffix set --cache-memsize=2147483648 userRoot
   ```

   ​							此命令将条目缓存设置为 2GB。 					

4. ​							重启 Directory Service 实例： 					

   

   ```none
   # dsctl instance_name restart
   ```

### 6.3.2. 使用 Web 控制台手动设置 Entry Cache Size

​					使用 Web 控制台手动设置条目缓存大小： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					
2. ​							选择 实例。 					
3. ​							在 Database 选项卡中，选择 Global Database Configuration。 					
4. ​							禁用自动缓存调整。 					
5. ​							点 Save Configuration。 					
6. ​							点 Actions 按钮，然后选择 Restart Instance。 					
7. ​							在 Entry Cache Size（字节） 字段中设置数据库缓存的大小。 					
8. ​							点 Save Configuration。 					
9. ​							点 Actions 按钮，然后选择 Restart Instance。 					

## 6.4. 设置 DN 缓存的大小

​				`entryrdn` 索引用于将 DN 和 RDN 与条目相关联。它使服务器能够有效地执行子树 **重命名**、条目 **移动和** **moddn** 操作。DN 缓存用于缓存 `entryrdn` 索引的内存表示，以避免昂贵的文件 I/O 和转换操作。为了获得最佳性能，尤其是仅限于条目 **重命名** **和移动** 操作，将 DN 缓存设置为启用目录服务器在数据库中缓存所有 DN 的大小。 		

​				如果缓存中没有存储 DN，目录服务器会从 `entryrdn.db` 索引数据库文件中读取 DN，并将磁盘上的格式的 DN 转换为 in-memory 格式。存储在缓存中的 DNS 可让服务器跳过磁盘 I/O 和转换步骤。 		

### 6.4.1. 使用命令行设置 DN 缓存的大小

​					使用命令行设置数据库的 DN 缓存大小： 			

1. ​							显示后缀及其对应的后端： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com suffix list
   dc=example,dc=com (userroot)
   ```

   ​							这个命令显示每个后缀旁的后端数据库名称。下一步需要后缀的数据库名称。 					

2. ​							使用以下命令设定 DN 缓存大小： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com backend suffix set --dncache-memsize=20971520 userRoot
   ```

   ​							此命令将 `用户Root` 数据库的 DN 缓存设置为 20MB。 					

3. ​							重启 Directory Service 实例： 					

   

   ```none
   # dsctl instance_name restart
   ```

### 6.4.2. 使用 Web 控制台设置 DN 缓存的大小

​					使用 Web 控制台设置数据库的 DN 缓存大小： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					
2. ​							选择 实例。 					
3. ​							在 Database 选项卡中，选择要设置 DN 缓存大小的后缀。 					
4. ​							在 DN 缓存大小（字节）字段中输入大小（以字节为单位 ）。 					
5. ​							点 Save Configuration。 					
6. ​							点 Actions 按钮，然后选择 Restart Instance。 					

## 6.5. 设置数据库缓存大小

​				数据库缓存包含 数据库的 Berkeley 数据库索引文件，即数据库用于属性索引的所有 `*.db` 和其他文件。这个值被传递给 Berkeley DB API 功能 **set_cachesize（）**。 		

​				这个缓存大小对 Directory 服务器性能的影响低于条目缓存大小，但如果设定了条目缓存大小后有可用的 RAM，增加分配给数据库缓存的内存量。 		

​				操作系统还具有文件系统缓存，与 RAM 使用量的数据库缓存竞争。请参阅操作系统文档，以查找有关文件系统缓存设置和监控文件系统缓存的信息。 		

注意

​					红帽建议自动根据硬件资源优化设置，而不是手动设置条目缓存大小。详情请查看 [第 6.1.1 节 “手动重新启用数据库和条目缓存自动大小”](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#enable_db_and_entry_cache_auto-sizing)。 			

### 6.5.1. 使用命令行手动设置数据库缓存大小

​					使用命令行手动设置数据库缓存大小： 			

1. ​							禁用自动缓存调整，并设置数据库缓存大小： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com backend config set --cache-autosize=0 --dbcachesize=268435456
   ```

   ​							此命令将数据库缓存设置为 256MB。 					

2. ​							重启 Directory Service 实例： 					

   

   ```none
   # dsctl instance_name restart
   ```

### 6.5.2. 使用 Web 控制台手动设置数据库缓存大小

​					使用 Web 控制台手动设置数据库缓存大小： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					
2. ​							选择 实例。 					
3. ​							在 Database 选项卡中，选择 Global Database Configuration。 					
4. ​							禁用自动缓存调整。 					
5. ​							点 Save Configuration。 					
6. ​							将 Database Cache Size（字节） 字段设置为数据库缓存大小。 					
7. ​							点 Save Configuration。 					
8. ​							点 Actions 按钮，然后选择 Restart Instance。 					

### 6.5.3. 将数据库缓存存储在 RAM 磁盘上

​					如果运行 Directory 服务器实例的系统有足够的可用 RAM，则可选择性地将数据库缓存存储在 RAM 磁盘上，以进一步提高性能： 			

1. ​							在 RAM 磁盘上为数据库缓存和元数据创建一个目录： 					

   

   ```none
   # mkdir -p /dev/shm/slapd-instance_name/
   ```

2. ​							在目录中设置以下权限： 					

   

   ```none
   # chown dirsrv:dirsrv /dev/shm/slapd-instance_name/
   # chmod 770 /dev/shm/slapd-instance_name/
   ```

3. ​							停止 Directory 服务器实例： 					

   

   ```none
   # systemctl stop dirsrv@instance_name
   ```

4. ​							编辑 `/etc/dirsrv/slapd-*instance_name*/dse.ldif` 文件，并在 nsslapd-db-home-directory 属性中设置 *`nsslapd-db-home-directory`* 属性中的 nsslapd-db-home-directory 属性 **，cn=ldbm database,cn=plugins,cn=config** 条目： 					

   

   ```none
   dn: cn=bdb,cn=config,cn=ldbm database,cn=plugins,cn=config
   ...
   nsslapd-db-home-directory: /dev/shm/slapd-instance_name/
   ```

   ​							如果 *`nsslapd-db-home-directory`* 属性不存在，请将新值添加到 **cn=bdb,cn=config,cn=ldbm 数据库,cn=plugins,cn=config** 条目中。 					

5. ​							启动 Directory 服务器实例： 					

   

   ```none
   # systemctl start dirsrv@instance_name
   ```

注意

​						当数据库缓存存储在 RAM 磁盘上时，Directory 服务器需要在每次重启后重新创建它。因此，在重新创建缓存前，服务启动和初始操作会较慢。 				

# 第 7 章 设置目录服务器线程的数量

​			目录服务器用来同时处理连接数量会影响服务器的性能。例如，如果所有线程都忙于处理耗时的任务（如 **添加操作** ），则新传入的连接会排队，直到可用的线程可以处理请求。 	

​			如果服务器提供较少的 CPU 线程，配置更多线程数量可能会提高性能。但是，在有多个 CPU 线程的服务器上，设置太高的值不会进一步提高性能。 	

​			默认情况下，Directory 服务器会自动计算线程数量。此数值基于实例启动时服务器的硬件资源。 	

注意

​				红帽建议使用自动调整设置。不要手动设置线程数量。 		

## 7.1. 自动线程调优

​				如果您启用自动线程调整，Directory 服务器将使用以下优化的线程数量： 		

| CPU 线程数                                                   | Directory Server Threads 的数量                              |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1                                                            | 16                                                           |
| 2                                                            | 16                                                           |
| 4                                                            | 24                                                           |
| 8                                                            | 32                                                           |
| 16                                                           | 48                                                           |
| 32                                                           | 64                                                           |
| 64                                                           | 96                                                           |
| 128                                                          | 192                                                          |
| 256                                                          | 384                                                          |
| 512                                                          | 512 						 						 [[a\]](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#ftn.fn.512_threads_limit) |
| 1024                                                         | 512 [[a\]](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#ftn.fn.512_threads_limit) |
| 2048                                                         | 512 [[a\]](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#ftn.fn.512_threads_limit) |
| [[a\] ](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#fn.512_threads_limit) 							应用推荐的最大线程数量。 |                                                              |

### 7.1.1. 使用命令行启用自动线程调优

​					目录服务器可以根据可用的硬件线程自动设置线程数量。启用此功能： 			

1. ​							启用自动设置线程数量： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com config replace nsslapd-threadnumber="-1"
   ```

2. ​							重启 Directory 服务器实例： 					

   

   ```none
   # dsctl instance_name restart
   ```

重要

​						如果您启用了线程数的自动设置，*`nsslapd-threadnumber`* 参数显示了在 Directory 服务器运行时计算的线程数量。 				

### 7.1.2. 使用 Web 控制台启用自动线程调整

​					目录服务器可以根据可用的硬件线程自动设置线程数量。启用此功能： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					
2. ​							选择 实例。 					
3. ​							打开 Server Settings 菜单，然后选择 Tuning & Limits。 					
4. ​							将 Number Of Worker Threads 字段设置为 **-1**。 					
5. ​							点击 Save。 					
6. ​							点 Actions 按钮，然后选择 Restart Instance。 					

重要

​						如果您启用了自动设置，则 Number Of Worker Threads 字段显示了在 Directory 服务器运行时计算的线程数量。 				

## 7.2. 手动设置线程数

​				在某些情况下，可能需要手动设置固定数量的目录服务器线程，而不是使用自动线程调整。 		

注意

​					例如，如果硬件线程数量发生变化，因为您增加了运行 Directory 服务器实例的虚拟机的 CPU 内核，您必须手动更新线程数量。有关使用优化和自动设置的详情，请参考 [第 7.1 节 “自动线程调优”](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#automatic-thread-tuning)。 			

### 7.2.1. 使用命令行手动设置线程数

​					使用命令行手动设置线程数量： 			

1. ​							设置线程数量： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com config replace nsslapd-threadnumber="64"
   ```

   ​							此命令将线程数量设置为 **64**。 					

2. ​							重启 Directory 服务器实例： 					

   

   ```none
   # dsctl instance_name restart
   ```

### 7.2.2. 使用 Web 控制台手动设置线程数量

​					使用 Web 控制台手动设置线程数量： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					
2. ​							选择 实例。 					
3. ​							打开 Server Settings 菜单，然后选择 Tuning & Limits。 					
4. ​							将 Number Of Worker Threads 字段设置为线程数量。 					
5. ​							点击 Save。 					
6. ​							点 Actions 按钮，然后选择 Restart Instance。 					

# 第 8 章 调优复制性能

## 8.1. 提高多层次复制效率

​				在多分配复制环境中复制延迟，特别是在服务器使用广域网(WAN)连接时，当多个供应商同时接收更新时，可能很高。当一个供应商仅访问一个副本时，不会长时间释放副本。在这种情况下，其他供应商无法向这个消费者发送更新，这会增加复制延迟。 		

​				要在固定的时间后发布副本，请在复制供应商和 hub 中设置 *`nsds5ReplicaReleaseTimeout`* 参数。 		

注意

​					**60** 秒默认值适用于大多数环境。设定太大或太低的值可能会对复制性能造成负面影响。如果值设置太低，复制服务器会持续重新分配另一个服务器，并且服务器无法发送多个更新。在高流量复制环境中，更长的超时可以改进供应商独有访问副本的情况。但是，在多数情况下，超过 **120** 秒的值会减慢复制速度。 			

### 8.1.1. 使用命令行设置复制发行超时

​					使用命令行设置复制发行超时： 			

1. ​							设置超时值： 					

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://supplier.example.com replication set --suffix="dc=example,dc=com" --repl-release-timeout=70
   ```

   ​							此命令将 **dc=example,dc=com** 后缀的复制发行超时值设置为 **70** 秒。 					

2. ​							重启 Directory 服务器实例： 					

   

   ```none
   # dsctl instance_name restart
   ```

### 8.1.2. 使用 Web 控制台设置复制发行超时

​					使用 Web 控制台设置复制发行超时： 			

1. ​							在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 					
2. ​							选择 实例。 					
3. ​							打开 Replication 菜单，然后选择 Configuration。 					
4. ​							单击 Show Advanced Settings。 					
5. ​							在 Replication Release Timeout 字段中设置超时值。 					
6. ​							点击 Save。 					
7. ​							点 Actions 按钮，然后选择 Restart Instance。 					

# 第 9 章 调优数据库链路性能

​			通过更改 Directory 服务器的连接和线程管理，可以改进数据库链接性能。 	

## 9.1. 管理到远程服务器的连接

​				每个数据库链接维护一个到远程服务器的连接池。这部分论述了如何优化它们。 		

### 9.1.1. 使用命令行管理与远程服务器的连接

​					本节论述了如何更新特定数据库的设置以及默认设置。 			

#### 9.1.1.1. 更新特定数据库的数据库链接连接管理设置

​						为特定数据库更新数据库连接管理设置： 				

1. ​								使用以下命令为数据库链接更新设置： 						

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com chaining link-set parameter=value link_name
   ```

   ​								有关您可以设置的参数列表，请输入： 						

   

   ```none
   # dsconf -D "cn=Directory Manager" ldap://server.example.com chaining link-set --help
   ```

2. ​								重启 Directory 服务器实例： 						

   

   ```none
   # dsctl instance_name restart
   ```

#### 9.1.1.2. 更新默认数据库链路连接管理设置

​						要更新默认数据库连接管理设置，请使用以下命令： 				



```none
# dsconf -D "cn=Directory Manager" ldap://server.example.com chaining config-set-def parameter=value
```

​						有关您可以设置的参数列表，请输入： 				



```none
# dsconf -D "cn=Directory Manager" ldap://server.example.com chaining config-set-def --help
```

### 9.1.2. 使用 Web 控制台管理到远程服务器的连接

​					本节论述了如何更新特定数据库的设置以及默认设置。 			

#### 9.1.2.1. 更新特定数据库的数据库链接连接管理设置

​						为特定数据库更新数据库连接管理设置： 				

1. ​								在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 						

2. ​								选择 实例。 						

3. ​								在 Database 选项卡中，选择您要更新的数据库链接配置。 						

4. ​								单击 Show Advanced Settings。 						

5. ​								更新高级设置区域中的字段： 						

   [![img](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/5bc4cac3abf65869547beca96be37220/db-link-settings.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/5bc4cac3abf65869547beca96be37220/db-link-settings.png)

   ​								要显示一个参数提示和 **cn=config** 条目中的对应属性名称，请将鼠标光标悬停在设置中。详情请查看 [*Red Hat Directory Server Configuration、命令和文件参考中的参数描述。*](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/configuration_command_and_file_reference/i) 						

6. ​								点 Save Configuration。 						

7. ​								点 Actions 按钮，然后选择 Restart Instance。 						

#### 9.1.2.2. 更新默认数据库链路连接管理设置

​						更新默认数据库连接管理设置： 				

1. ​								在 web 控制台中打开 Directory Server 用户界面。详情请参阅 *Red Hat [Directory Server Administration Guide](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/administration_guide/logging_into_directory_server_using_the_web_console) 中的使用 Web 控制台登录到* 目录服务器一节。 						

2. ​								选择 实例。 						

3. ​								在 Database 选项卡中，选择 链配置。 						

4. ​								更新 Default Database Link Creation Settings 区域中的字段： 						

   [![img](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/214cd2f8a86e086e9fc6313780abbd60/global-db-link-settings.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Directory_Server-11-Performance_Tuning_Guide-zh-CN/images/214cd2f8a86e086e9fc6313780abbd60/global-db-link-settings.png)

   ​								要显示一个参数提示和 **cn=config** 条目中的对应属性名称，请将鼠标光标悬停在设置中。详情请查看 [*Red Hat Directory Server Configuration、命令和文件参考中的参数描述。*](https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html/configuration_command_and_file_reference/i) 						

5. ​								单击 Save Default Settings。 						

6. ​								点 Actions 按钮，然后选择 Restart Instance。 						

## 9.2. 在正常处理过程中检测错误

​				通过检测数据库链接和远程服务器之间的正常链操作期间检测服务器性能，从而保护服务器性能。数据库链接有两个属性： *`nsMaxResponseDelay`* 和 *`nsMaxTestResponseDelay`* - 它一起确定远程服务器是否不再响应。 		

​				第一个属性 *`nsMaxResponseDelay`* 设置为要完成 LDAP 操作的最长时间。如果操作所需的时间超过此属性中指定的时间，则数据库链接的服务器会怀疑远程服务器不再在线。 		

​				满足 *`nsMaxResponseDelay`* 周期后，数据库链接会 ping 远程服务器。在 ping 中，数据库链接会发出另一个 LDAP 请求，即远程服务器中不存在的对象的简单搜索请求。ping 的持续时间使用 *`nsMaxTestResponseDelay`* 设置。 		

​				如果远程服务器在 *`nsMaxTestResponseDelay`* 周期前没有响应，则返回错误，连接标记为 down。数据库链接和远程服务器之间的所有连接都将在 30 秒内被阻止，从而防止服务器性能下降。30 秒后，数据库链接向远程服务器发出的操作请求会正常继续。 		

​				两个属性都存储在 **cn=config,cn=chaining database,cn=plugins,cn=config** 条目中。下表描述了更详细的属性： 		

表 9.1. 数据库链路处理错误检测参数

| 属性名称               | 描述                                                         |
| ---------------------- | ------------------------------------------------------------ |
| nsMaxResponseDelay     | 在怀疑错误之前，能够让远程服务器响应数据库链接提出的 LDAP 操作请求的最大时间。这个周期以秒为单位指定。默认延迟周期为 **60** 秒。满足这个延迟周期后，数据库链接会测试与远程服务器的连接。 |
| nsMaxTestResponseDelay | 数据库链接发布的测试持续时间，以检查远程服务器是否响应。如果在此周期通过前没有返回来自远程服务器的响应，数据库链接会假定远程服务器停机，并且连接不会用于后续的操作。这个周期以秒为单位指定。默认测试响应延迟周期为 **15** 秒。 |

# 第 10 章 提高导入性能

​			大量条目大小或大量条目在导入操作过程中会对服务器性能造成负面影响。这部分论述了如何调整目录服务器设置和操作系统设置来提高导入性能。 	

## 10.1. 为大型数据库导入和利用大量属性导入来调优目录服务器

​				在以下情况下更新条目缓存： 		

- ​						您需要导入非常大的数据库。 				
- ​						您需要导入具有大属性的数据库，如存储证书链或镜像的二进制属性。 				

​				有关设置条目缓存大小的详情，请参考 [第 6.1 节 “Database 和 Entry Cache Auto-Sizing 功能”](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#DB_and_entry_cache_RAM_usage) 和 [第 6.3 节 “手动设置 Entry Cache Size”](https://access.redhat.com/documentation/zh-cn/red_hat_directory_server/11/html-single/performance_tuning_guide/index#tuning-entry-cache)。 		

## 10.2. 调优目录服务器以导入大量条目

​				当您导入大量条目时，最多用户进程数的操作系统设置可以限制目录服务器的性能。 		

​			

- ​						要临时增加最大进程数，请输入： 				

  

  ```none
  # ulimit -u 32000
  ```

  ​						当用户注销时，更改将返回到默认设置。 				

- ​						要永久增加进程的最大数量，请参阅 [“如何设置 ulimit 值”](https://access.redhat.com/solutions/1346533)。 				

# 附录 A. 修订历史记录

​			请注意，修订号与该手册版本相关，而不是与 Red Hat Directory Server 的版本号相关。 	

| **修订历史**                                      |                 |                |
| :------------------------------------------------ | --------------- | -------------- |
| 修订 11.5-1                                       | Tue May 10 2022 | Marc Muehlfeld |
| 本指南的 Red Hat Directory Server 11.5 发行版本。 |                 |                |
| 修订 11.4-1                                       | Tue Nov 09 2021 | Marc Muehlfeld |
| 本指南的 Red Hat Directory Server 11.4 发行版本。 |                 |                |
| 修订 11.3-1                                       | Tue May 11 2021 | Marc Muehlfeld |
| 本指南的 Red Hat Directory Server 11.3 发行版本。 |                 |                |
| 修订 11.2-1                                       | Tue Nov 03 2020 | Marc Muehlfeld |
| 本指南的 Red Hat Directory Server 11.2 发行版本。 |                 |                |
| 修订 11.1-1                                       | Tue Apr 28 2020 | Marc Muehlfeld |
| 本指南的 Red Hat Directory Server 11.1 发行版本。 |                 |                |

| **修订历史**                                      |                 |                |
| :------------------------------------------------ | --------------- | -------------- |
| 修订 11.0-1                                       | Tue Nov 05 2019 | Marc Muehlfeld |
| 本指南的 Red Hat Directory Server 11.0 发行版本。 |                 |                |

​                

​                      

​                [                                                                                                                              ](https://redhat.com)

[                       ](https://redhat.com)[                       ](https://redhat.com)

[                                    ](https://redhat.com)              

### Quick Links

- [Downloads](https://access.redhat.com/downloads/)
- [Subscriptions](https://access.redhat.com/management)
- [Support Cases](https://access.redhat.com/support)
- [Customer Service](https://access.redhat.com/support/customer-service)
- [Product Documentation](https://access.redhat.com/documentation)

### Help

- [Contact Us](https://access.redhat.com/support/contact/)
- [Customer Portal FAQ](https://access.redhat.com/articles/33844)
- [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

- [Trust Red Hat](https://www.redhat.com/en/trust)
- [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
- [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
- [Awards and Recognition](https://access.redhat.com/recognition/)
- [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

- [redhat.com](https://www.redhat.com/)
- [developers.redhat.com](http://developers.redhat.com/)
- [connect.redhat.com](https://connect.redhat.com/)
- [cloud.redhat.com](https://cloud.redhat.com/)

### About

- [Red Hat Subscription Value](https://access.redhat.com/subscription-value)
- [About Red Hat](https://www.redhat.com/about/)
- [Red Hat Jobs](http://jobs.redhat.com)

[                         All systems operational                                              ](https://status.redhat.com)

Copyright © 2023 Red Hat, Inc.

- [Privacy Statement](http://www.redhat.com/en/about/privacy-policy)
- [Customer Portal Terms of Use](https://access.redhat.com/help/terms/)
- [All Policies and Guidelines](http://www.redhat.com/en/about/all-policies-guidelines)
- Cookie 偏好设置

[                         ![Red Hat Summit](https://access.redhat.com/chrome_themes/nimbus/img/rh-summit-red-a.svg)                     ](http://www.redhat.com/summit/)

​                        [Twitter](https://twitter.com/RedHatSupport)                                            

![img](moz-extension://e2e4c729-fe25-403a-a8cb-e6b819e0ad9b/assets/img/T.svg)