# 镜像

[TOC]

## 概述

镜像有两个重要原则：

1. 镜像是不可变的。镜像一经创建，便无法修改您只能制作新镜像或在其上添加更改。
2. 容器镜像由多个层组成。每一层代表一组文件系统更改，用于添加、删除或修改文件。

这两个原则允许您扩展或添加到现有镜像中。例如，如果正在构建 Python 应用程序，则可以从 Python 镜像开始并添加其他层以安装应用程序的依赖项并添加代码。这使您可以专注于您的应用程序，而不是 Python 本身。

## 搜索镜像

打开终端并使用 `docker search` 命令搜索镜像：

```bash
docker search docker/welcome-to-docker
```

将看到如下所示的输出：

```bash
NAME                       DESCRIPTION                                     STARS     OFFICIAL
docker/welcome-to-docker   Docker image for new users getting started w…   20
```

此输出显示有关 Docker Hub 上可用相关图像的信息。

## 下载镜像

使用 `docker pull` 命令拉取图像。

```bash
docker pull docker/welcome-to-docker
```

将看到如下所示的输出：

```bash
Using default tag: latest
latest: Pulling from docker/welcome-to-docker
579b34f0a95b: Download complete
d11a451e6399: Download complete
1c2214f9937c: Download complete
b42a2f288f4d: Download complete
54b19e12c655: Download complete
1fb28e078240: Download complete
94be7e780731: Download complete
89578ce72c35: Download complete
Digest: sha256:eedaff45e3c78538087bdd9dc7afafac7e110061bbdd836af4104b10f10ab693
Status: Downloaded newer image for docker/welcome-to-docker:latest
docker.io/docker/welcome-to-docker:latest
```

每一行代表镜像的不同下载层。请记住，每一层都是一组文件系统更改，并提供镜像的功能。

## 查看图像

使用 `docker image ls` 命令列出您下载的镜像：

```bash
docker image ls
```

将看到如下所示的输出：

```bash
REPOSITORY                 TAG       IMAGE ID       CREATED        SIZE
docker/welcome-to-docker   latest    eedaff45e3c7   4 months ago   29.7MB
```

The command shows a list of Docker images currently available on your system. The `docker/welcome-to-docker` has a total size of approximately 29.7MB.
该命令显示系统上当前可用的 Docker 映像列表。`docker/welcome-to-docker` 总大小约为 29.7MB。

> **镜像尺寸**
>
> The image size represented here reflects the uncompressed size of the image, not the download size of the layers.
> 此处表示的镜像大小反映了镜像的未压缩大小，而不是图层的下载大小。

使用以下 `docker image history` 命令列出镜像的图层：

```bash
docker image history docker/welcome-to-docker
```

将看到如下所示的输出：

```bash
IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT
648f93a1ba7d   4 months ago   COPY /app/build /usr/share/nginx/html # buil…   1.6MB     buildkit.dockerfile.v0
<missing>      5 months ago   /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon…   0B
<missing>      5 months ago   /bin/sh -c #(nop)  STOPSIGNAL SIGQUIT           0B
<missing>      5 months ago   /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>      5 months ago   /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entr…   0B
<missing>      5 months ago   /bin/sh -c #(nop) COPY file:9e3b2b63db9f8fc7…   4.62kB
<missing>      5 months ago   /bin/sh -c #(nop) COPY file:57846632accc8975…   3.02kB
<missing>      5 months ago   /bin/sh -c #(nop) COPY file:3b1b9915b7dd898a…   298B
<missing>      5 months ago   /bin/sh -c #(nop) COPY file:caec368f5a54f70a…   2.12kB
<missing>      5 months ago   /bin/sh -c #(nop) COPY file:01e75c6dd0ce317d…   1.62kB
<missing>      5 months ago   /bin/sh -c set -x     && addgroup -g 101 -S …   9.7MB
<missing>      5 months ago   /bin/sh -c #(nop)  ENV PKG_RELEASE=1            0B
<missing>      5 months ago   /bin/sh -c #(nop)  ENV NGINX_VERSION=1.25.3     0B
<missing>      5 months ago   /bin/sh -c #(nop)  LABEL maintainer=NGINX Do…   0B
<missing>      5 months ago   /bin/sh -c #(nop)  CMD ["/bin/sh"]              0B
<missing>      5 months ago   /bin/sh -c #(nop) ADD file:ff3112828967e8004…   7.66MB
```

此输出显示所有图层、其大小以及用于创建图层的命令。

> **查看完整命令**
>
> Note that, since  the output is in a table-like format, longer commands will cause the  output to be very difficult to navigate.
> 如果将标志 `--no-trunc` 添加到命令中，将看到完整的命令。请注意，由于输出采用类似表格的格式，因此较长的命令将导致输出非常难以导航。

## 构建并推送镜像

现在，已经更新了应用，可以为应用程序创建容器镜像并将其共享到 Docker Hub。为此，需要执行以下操作：

1. 使用 Docker 帐户登录。
2. 在 Docker Hub 上创建镜像仓库。
3. 构建容器镜像。
4. 将镜像推送到 Docker Hub 。

### 使用 Docker 帐户登录

要将映像推送到 Docker Hub，需要使用 Docker 帐户登录。

1. 打开 Docker 仪表板。
2. 选择右上角的“登录”。
3. 如果需要，请创建一个帐户，然后完成登录流程。

完成后，应该会看到“登录”按钮变成个人资料图片。

### 创建镜像仓库

现在已经有了一个帐户，可以创建镜像存储库。

1. 转到 Docker Hub。
2. 选择“创建存储库”。
3. 在“创建存储库”页上，输入以下信息：
   - **Repository name** - `getting-started-todo-app` 
   - **Short description** - 简短描述 - 如果您愿意，请随时输入描述
   - **Visibility** - 可见性 - 选择“公共”以允许其他人拉取您自定义的应用
4. 选择“创建”以创建存储库。

### 构建并推送镜像

#### CLI

首先，将项目克隆或下载为 [ZIP](https://github.com/docker/getting-started-todo-app/archive/refs/heads/main.zip) 文件到本地计算机。

```bash
git clone https://github.com/docker/getting-started-todo-app
```

克隆项目后，导航到克隆创建的新目录：

```bash
cd getting-started-todo-app
```

通过运行以下命令来生成项目，并使用您的用户名替换 `DOCKER_USERNAME` 。

```bash
docker build -t DOCKER_USERNAME/getting-started-todo-app .
```

例如，如果 Docker 用户名是 `mobydock` ，将运行以下命令：

```bash
docker build -t mobydock/getting-started-todo-app .
```

要验证映像在本地是否存在，可以使用以下 `docker image ls` 命令：

```bash
docker image ls
```

将看到类似于以下内容的输出：

```bash
REPOSITORY                          TAG       IMAGE ID       CREATED          SIZE
mobydock/getting-started-todo-app   latest    1543656c9290   2 minutes ago    1.12GB
...
```

要推送映像，请使用 `docker push` 命令。请务必替换 `DOCKER_USERNAME` 为您的用户名：

```bash
docker push DOCKER_USERNAME/getting-started-todo-app
```

根据您的上传速度，这可能需要一些时间才能推送。

#### VS Code


在“文件”菜单中，选择“打开文件夹”。选择 Clone Git Repository 并粘贴此 URL：https://github.com/docker/getting-started-todo-app

 <img src="../../../Image/c/clone-the-repo.webp" style="zoom:50%;" />

右键单击 `Dockerfile` 并选择 Build Image... 菜单项。

<img src="../../../Image/b/build-vscode-menu-item.webp" style="zoom:50%;" />

在显示的对话框中，输入名称 `DOCKER_USERNAME/getting-started-todo-app` ，替换 `DOCKER_USERNAME` 为您的 Docker 用户名。

按 Enter 键后，会看到一个终端出现在将进行构建的位置。完成后，请随时关闭终端。

通过在左侧导航菜单中选择 Docker 徽标，打开 VS Code 的 Docker 扩展。

找到创建的镜像。它的名称为 `docker.io/DOCKER_USERNAME/getting-started-todo-app` 。

展开图像以查看镜像的标签（或不同版本）。应该看到一个名为 `latest` 的标签，这是为镜像提供的默认标签。

右键单击最新项目，然后选择 Push...选择。

<img src="../../../Image/b/build-vscode-push-image.webp" style="zoom:50%;" />

Press **Enter** to confirm and then watch as your image is pushed to Docker Hub.  Depending on your upload speeds, it might take a moment to push the  image.
按 Enter 键确认，然后镜像将被推送到 Docker Hub。根据上传速度，可能需要一些时间才能完成。上传完成后，请随时关闭终端。