# 虚拟化技术

## 技术对比

![](../../Image/c/container_evolution.svg)

**传统部署时代：**

早期，各个组织机构在物理服务器上运行应用程序。无法为物理服务器中的应用程序定义资源边界，这会导致资源分配问题。 例如，如果在物理服务器上运行多个应用程序，则可能会出现一个应用程序占用大部分资源的情况， 结果可能导致其他应用程序的性能下降。 一种解决方案是在不同的物理服务器上运行每个应用程序，但是由于资源利用不足而无法扩展， 并且维护许多物理服务器的成本很高。

**虚拟化部署时代：**

作为解决方案，引入了虚拟化。虚拟化技术允许你在单个物理服务器的 CPU 上运行多个虚拟机（VM）。 虚拟化允许应用程序在 VM 之间隔离，并提供一定程度的安全，因为一个应用程序的信息 不能被另一应用程序随意访问。

虚拟化技术能够更好地利用物理服务器上的资源，并且因为可轻松地添加或更新应用程序 而可以实现更好的可伸缩性，降低硬件成本等等。

每个 VM 是一台完整的计算机，在虚拟化硬件之上运行所有组件，包括其自己的操作系统。

**容器部署时代：**

容器类似于 VM，但是它们具有被放宽的隔离属性，可以在应用程序之间共享操作系统（OS）。 因此，容器被认为是轻量级的。容器与 VM 类似，具有自己的文件系统、CPU、内存、进程空间等。 由于它们与基础架构分离，因此可以跨云和 OS 发行版本进行移植。

容器因具有许多优势而变得流行起来。下面列出的是容器的一些好处：

- 敏捷应用程序的创建和部署：与使用 VM 镜像相比，提高了容器镜像创建的简便性和效率。
- 持续开发、集成和部署：通过快速简单的回滚（由于镜像不可变性），支持可靠且频繁的 容器镜像构建和部署。
- 关注开发与运维的分离：在构建/发布时而不是在部署时创建应用程序容器镜像， 从而将应用程序与基础架构分离。
- 可观察性：不仅可以显示操作系统级别的信息和指标，还可以显示应用程序的运行状况和其他指标信号。
- 跨开发、测试和生产的环境一致性：在便携式计算机上与在云中相同地运行。
- 跨云和操作系统发行版本的可移植性：可在 Ubuntu、RHEL、CoreOS、本地、 Google Kubernetes Engine 和其他任何地方运行。
- 以应用程序为中心的管理：提高抽象级别，从在虚拟硬件上运行 OS 到使用逻辑资源在 OS 上运行应用程序。
- 松散耦合、分布式、弹性、解放的微服务：应用程序被分解成较小的独立部分， 并且可以动态部署和管理 - 而不是在一台大型单机上整体运行。
- 资源隔离：可预测的应用程序性能。
- 资源利用：高效率和高密度。

## 种类
>* 全虚拟化
>* 半虚拟化
>* 操作系统级虚拟化  
>* 原生虚拟化  

全虚拟化：VMware ESX  
半虚拟化：Xen  
操作系统级虚拟化:AIX workload partition / Solaris zone  
原生虚拟化：Intel AMD
## 虚拟化使用场景
### 适用
>* 利用率已经很高的服务器
>* 资源密集型的备份服务器或者日志主机
>* 高带宽的应用，如入侵检测系统
>* 繁忙且受限于I/O的数据库服务器
>* 基于硬件防拷贝的专用应用
>* 需要专门硬件的应用  

### 不适用
>* 面向Internet，且需要查询中间件系统或者数据库的Web服务器
>* 使用不充分的独立应用服务器
>* 开发人员使用的系统，如编译服务器或者版本控制服务器
>* QA测试主机和过渡环境
>* 核心基础设施的系统，如LDAP目录，DHCP和DNS服务器，时间服务器以及SSH网关。






VT

EPT

VPID

VT-d

SR-IOV

APIC-v

Shadow VMCS
=======
## 分类

**虚拟化层次种类：**

（1）**完全虚拟化** ---  最流行的虚拟化方法，使用名为 hypervisor 的一种软件，在虚拟服务器和底层硬件之间建立一个抽象层。 VMware  和微软的VirtualPC 是代表该方法的两个商用产品，而基于核心的虚拟机 (KVM) 是面向 Linux 系统的开源产品hypervisor  可以捕获 CPU  指令，为指令访问硬件控制器和外设充当中介。因而，完全虚拟化技术几乎能让任何一款操作系统不用改动就能安装到虚拟服务器上，而它们不知道自己运行在虚拟化环境下。主要缺点是， hypervisor 给处理器带来开销。
（2）**准虚拟化** --- 完全虚拟化是处理器密集型技术，因为它要求  hypervisor管理各个虚拟服务器，并让它们彼此独立。减轻这种负担的一种方法就是，改动客户端操作系统，让它以为自己运行在虚拟环境下，能够与hypervisor 协同工作。这种方法就叫准虚拟化 (para-virtualization)。Xen 是开源准虚拟化技术的一个例子。操作系统作为虚拟服务器在  Xen hypervisor 上运行之前，它必须在核心层面进行某些改变。因此， Xen 适用于 BSD 、 Linux 、 Solaris  及其他开源操作系统，但不适合对像Windows  这些专有的操作系统进行虚拟化处理，因为它们无法改动。准虚拟化技术的优点是性能高。经过准虚拟化处理的服务器可与hypervisor  协同工作，其响应能力几乎不亚于未经过虚拟化处理的服务器。准虚拟化与完全虚拟化相比优点明显，以至于微软和 VMware  都在开发这项技术，以完善各自的产品。
（3）**系统虚拟化** ---  就操作系统层的虚拟化而言，没有独立的hypervisor  层。相反，主机操作系统本身就负责在多个虚拟服务器之间分配硬件资源，并且让这些服务器彼此独立。一个明显的区别是，如果使用操作系统层虚拟化，所有虚拟服务器必须运行同一操作系统 ( 不过每个实例有各自的应用程序和用户 ) 。虽然操作系统层虚拟化的灵活性比较差，但本机速度性能比较高。此外，由于架构在所有虚拟服务器上使用单一、标准的操作系统，管理起来比异构环境要容易。
（4）**桌面虚拟化** ---  桌面虚拟化主要功能是将分散的桌面环境集中保存并管理起来，包括桌面环境的集中下发，集中更新，集中管理。桌面虚拟化使得桌面管理变得简单，不用每台终端单独进行维护，每台终端进行更新。终端数据可以集中存储在中心机房里，安全性相对传统桌面应用要高很多。桌面虚拟化可以使得一个人拥有多个桌面环境，也可以把一个桌面环境供多人使用。

**虚拟化架构分类:**
​（1）**1型虚拟化**
​      ![img](../../Image\k\1618472-20190329134603647-370306872.png)

​       Hypervisor 直接安装在物理机上，多个虚拟机在 Hypervisor 上运行。Hypervisor 实现方式一般是一个特殊定制的 Linux 系统。Xen 和 VMware 的 ESXi 都属于这个类型。

（2）**2型虚拟化**

​      ![img](D:\wfbook\Image\k\1618472-20190329135045351-342284420.png)

​      物理机上首先安装常规的操作系统，比如 Redhat、Ubuntu 和 Windows。Hypervisor 作为  OS 上的一个程序模块运行，并对管理虚拟机进行管理。KVM、VirtualBox 和 VMware Workstation 都属于这个类型。