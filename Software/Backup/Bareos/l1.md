## 添加CentOS客户端

客户端防火墙配置

 firewall-cmd --permanent --add-port 9102/tcp
  firewall-cmd --reload
  firewall-cmd --list-all

安装客户端软件包

 配置yum源

 curl http://download.bareos.org/bareos/release/latest/CentOS_7/bareos.repo > /etc/yum.repos.d/bareos.repo

安装相关包

 yum install -y bareos-filedaemon

启动并配置自启服务

 systemctl start bareos-fd
  systemctl enable bareos-fd

服务端：

 [root@localhost ~]#bconsole
  Connecting to Director localhost:9101
  1000 OK: bareos-dir Version: 16.2.4 (01 July 2016)
  Enter a period to cancel a command.
  *configure add client name=bareos-client-fd address=192.168.0.31 password=eisoo.com #这个ip是你客户端的ip
  *reload
  Reloaded

当然我们建立了客户端后会自动创建如下两个文件/etc/bareos/bareos-dir.d/client/ bareos-client-fd.conf内容为：

 Client {
  Name = bareos-client-fd
  Address = 192.168.0.31
  Password = eisoo.com
  }

/etc/bareos/bareos-dir-export/client/bareos-client-fd/bareos-fd.d/director/bareos-dir.conf
 内容如下：

> Director {
> Name = bareos-dir
> Password = “[md5]f4a43f6600da9afe39bd76f6fb1f435b”
> }

注：手动配置请使用以下方法

> vim /etc/bareos/bareos-dir.d/client/bareos-client.conf

输入如下配置：

> Client {
> Name = bareos-client-fd
> Address = 192.168.0.31
> Password = eisoo.com
> }

重启服务使配置生效

> [root@localhost ~]#bconsole
> Connecting to Director localhost:9101
>
> 1000 OK: bareos-dir Version: 16.2.4 (01 July 2016) Enter a period to
> cancel a command.
> *reload reloaded
> *

复制导出目录配置到客户端

> scp  /etc/bareos/bareos-dir-export/client/你添加的客户端名/bareos-fd.d/director/bareos-dir.conf root@192.168.0.31:/etc/bareos/bareos-fd.d/director/
> 如：scp /etc/bareos/bareos-dir-export/client/win-fd/bareos-fd.d/director/bareos-dir.conf

修改客户端名字声明

> vim /etc/bareos/bareos-fd.d/client/myself.conf

修改如下名字与添加客户端名字一致

> Name = bareos-client-fd

修改客户端如何发消息

> cat /etc/bareos/bareos-fd.d/messages/Standard.conf

参数如下：

> Messages {
> Name = Standard
> Director = bareos-dir = all, !skipped, !restored
> Description = “Send relevant messages to the Director.”
> }

注：以上将消息发给Direcotr

重启客户端服务

> systemctl restart bareos-fd

测试客户端连接

> [root@localhost ~]#bconsole
>
> *show clients
> *status client=bareos-client-fd

添加客户端作业
 添加作业资源

默认备份的目录为/usr/sbin/，如果你想备份别的目录需要去/etc/bareos/bareos-dir.d/fileset/SelfTest.conf配置文件中修改，修改完成后重启BareOS的三个服务

> *configure add job name=bareos-client-job-fd client=bareos-client-fd jobdefs=DefaultJob

信息显示如下：

> Created resource config file “/etc/bareos/bareos-dir.d/job/bareos-client-job.conf”:
> Job {
> Name = bareos-client-job-fd
> Client = bareos-client-fd
> JobDefs = DefaultJob
> }

预演作业

> *estimate listing job=bareos-client-job-fd

注：以上只是预估备份的文件列表
 运行作业

> *run job=bareos-client-job-fd

注：这个时候会备份失败
 排除故障
 查阅故障

> *list joblog jobid=…

发现如下错误：

> 2017-08-31 14:40:46 bareos-dir JobId 15: Start Backup JobId 15,
> Job=bareos-client-job-fd.2017-08-31_14.40.44_00 2017-08-31 14:40:46
> bareos-dir JobId 15: Using Device “FileStorage” to write. 2017-08-31
> 14:40:56 bareos-client JobId 15: Warning: bsock_tcp.c:128 Could not
> connect to Storage daemon on localhost:9103. ERR=Connection refused
> Retrying … 2017-08-31 14:46:06 bareos-client JobId 15: Warning:
> bsock_tcp.c:128 Could not connect to Storage daemon on localhost:9103.
> ERR=Connection refused Retrying … 2017-08-31 14:51:16 bareos-client
> JobId 15: Warning: bsock_tcp.c:128 Could not connect to Storage daemon
> on localhost:9103. ERR=Connection refused Retrying … 2017-08-31
> 14:56:26 bareos-client JobId 15: Warning: bsock_tcp.c:128 Could not
> connect to Storage daemon on localhost:9103. ERR=Connection refused
> Retrying … 2017-08-31 15:01:36 bareos-client JobId 15: Warning:
> bsock_tcp.c:128 Could not connect to Storage daemon on localhost:9103.
> ERR=Connection refused Retrying … 2017-08-31 15:06:46 bareos-client
> JobId 15: Warning: bsock_tcp.c:128 Could not connect to Storage daemon
> on localhost:9103. ERR=Connection refused Retrying … 2017-08-31
> 15:10:46 bareos-client JobId 15: Fatal error: bsock_tcp.c:134 Unable
> to connect to Storage daemon on localhost:9103. ERR=Connection refused
> 2017-08-31 15:10:46 bareos-client JobId 15: Fatal error: Failed to
> connect to Storage daemon: localhost:9103 2017-08-31 15:10:46
> bareos-dir JobId 15: Fatal error: Bad response to Storage command:
> wanted 2000 OK storage , got 2902 Bad storage
>
> 2017-08-31 15:10:46 bareos-dir JobId 15: Error: Bareos bareos-dir
> 16.2.4 (01Jul16): Build OS: x86_64-redhat-linux-gnu redhat CentOS Linux release 7.0.1406 (Core) JobId:
> 15 Job:
> bareos-client-job-fd.2020-02-25_14.40.44_00 Backup Level:
> Full Client: “bareos-client” 16.2.4 (01Jul16)
> x86_64-redhat-linux-gnu,redhat,CentOS Linux release 7.0.1406 (Core)
> ,CentOS_7,x86_64 FileSet: “SelfTest” 2017-08-29
> 05:01:45 Pool: “Full” (From command line)
> Catalog: “MyCatalog” (From Client resource) Storage:
> “File” (From Job resource) Scheduled time: 31-Aug-2017
> 14:40:43 Start time: 31-Aug-2017 14:40:46 End time:
> 31-Aug-2017 15:10:46 Elapsed time: 30 mins Priority:
> 10 FD Files Written: 0 SD Files Written: 0 FD Bytes
> Written: 0 (0 B) SD Bytes Written: 0 (0 B) Rate:
> 0.0 KB/s Software Compression: None VSS: no Encryption: no Accurate: no Volume
> name(s): Volume Session Id: 3 Volume Session Time:
> 1504157857 Last Volume Bytes: 0 (0 B) Non-fatal FD errors:
> 2 SD Errors: 0 FD termination status: Fatal Error
> SD termination status: Waiting on FD Termination: ***
> Backup Error ***

更正存储配置文件
 修改以下配置文件：

> vim /etc/bareos/bareos-dir.d/storage/File.conf

修改如下参数：

> Address = 192.168.0.30 #注意：这个ip是服务端dir的ip

重启服务使配置生效

> systemctl restart bareos-dir bareos-fd bareos-sd

测试配置文件
 方法运行适当的守护进程，可以测试配置文件在语法上是否正确。-t选择。守护进程将处理配置文件并打印任何错误消息，然后终止。
 当Bareos Director和Bareos存储守护进程以用户身份运行时赤裸，测试配置应按照赤裸.
 这对于测试BareosDirector尤其必要，因为它还连接到数据库，并检查目录模式版本是否正确。取决于数据库，只有赤裸有权访问它。
 重新运行作业

> *run job=bareos-client-job-fd

等待作业完成

> *wait jobid=…

验证作业

> *list joblog jobid=…
> *list files jobid=…
> *list volumes

备份完成后登陆web端
 会在首页看到你的任务success为成功的。Failure为失败的
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200618165546188.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1ODk2MjUz,size_16,color_FFFFFF,t_70)
 然后点击clients
 如果你的客户端添加成功这里会显示客户端的系统，以及版本，状态等信息
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200618165611808.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1ODk2MjUz,size_16,color_FFFFFF,t_70)
 点击restore-client下拉选择你的客户端
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200618165626597.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1ODk2MjUz,size_16,color_FFFFFF,t_70)
 在backup jobs这会自动选择你备份过的文件目录，如果你有多个备份可以下拉选择你想恢复的备份。
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/2020061816563875.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1ODk2MjUz,size_16,color_FFFFFF,t_70)
 往下滑动Restore location on client这里输入一个位置，指定你的文件恢复到哪个位置。然后点击restore
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200618165649696.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1ODk2MjUz,size_16,color_FFFFFF,t_70)
 然后点击ok，然后去客户端切到你指定的目录去查看是否完成恢复

# 增客Windows客户机

> 这里是引用[root@localhost ~]# bconsole
> *configure add client name=win-fd address=192.168.0.35 password=eisoo.com #客户端的ip
> Exported resource file “/etc/bareos/bareos-dir-export/client/win-fd/bareos-fd.d/director/bareos-dir.conf”:
> Director {
> Name = bareos-dir
> Password = “[md5]f4a43f6600da9afe39bd76f6fb1f435b” #注意这个密码一会要用到
> }
> Created resource config file “/etc/bareos/bareos-dir.d/client/win-fd.conf”:
> Client {
> Name = win-fd
> Address = 192.168.0.35
> Password = eisoo.com
> }
> *q
> [root@localhost ~]# cat /etc/bareos/bareos-dir.d/console/bareos-mon.conf
> Console {
> Name = bareos-mon
> Description = “Restricted console used by tray-monitor to get the status of the director.”
> Password = “y15fQiwuwqU/mCtCmUwAE2eln2DOf4PNIBrEhhItOfPV” #这个密码也要用到
> CommandACL = status, .status
> JobACL = *all*
> }
> [root@localhost ~]#

在Windows客户机上安装bareos-fd软件包
 下载地址：

> http://download.bareos.org/bareos/release/latest/windows/opsi/

安装Bareos File Daemon

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200618170731457.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1ODk2MjUz,size_16,color_FFFFFF,t_70)
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200618170740179.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1ODk2MjUz,size_16,color_FFFFFF,t_70)
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200618170753903.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1ODk2MjUz,size_16,color_FFFFFF,t_70)
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200618170803248.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1ODk2MjUz,size_16,color_FFFFFF,t_70)
 这时候就需要用到两个密码了
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200618170840156.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1ODk2MjUz,size_16,color_FFFFFF,t_70)
 Client name：这里填你在服务端添加客户端时设置的名字，一定要保持一致
 Director name 保持默认就行
 Password 这里填你在服务端添加客户端时给出的md5的密码，连带[md5]一同复制过来
 Network address 保持默认就行
 Client monitor password 这里填写/etc/bareos/bareos-dir.d/console/bareos-mon.conf文件中的密码

到此为止Bareos的Director，Storage和Client都已经配置完成，可以使用了。

> [root@localhost ~]#bconsole
> *Connecting to Director  localhost:9101 Encryption: PSK-AES256-CBC-SHA 1000 OK: bareos-dir  Version: 19.2.6 (11 February 2020) bareos.org
> build binary bareos.org binaries are UNSUPPORTED by bareos.com. Get
> official binaries and vendor support on https://www.bareos.com You are
> connected using the default console
> Enter a period (.) to cancel a command.
> *reload reloaded
> *status client=win-fd Connecting to Client win-fd at 192.168.0.35:9102  Probing client protocol… (result will be saved until config reload)
> Handshake: Immediate TLS, Encryption: PSK-AES256-CBC-SHA
> win-fd Version: 20.0.0~pre255.bddd6c0b8 (18 February 2020) VSS Linux
> Cross-compile Win64 Daemon started 27-Feb-20 16:01. Jobs: run=0
> running=0, pre-release version binary Microsoft Windows 7 Ultimate
> Edition Service Pack 1 (build 7601), 64-bit Sizeof: boffset_t=8
> size_t=8 debug=0 trace=1 bwlimit=0kB/s
>
> Running Jobs: win-mon (director) connected at: 27-Feb-20 16:03
> bareos-dir (director) connected at: 27-Feb-20 16:03
>
> No Jobs running.
>
> ====
> Terminated Jobs:
> *show client
> Client {
> Name = “win-fd”
> Address = “192.168.0.35”
> Password = “[md5]f4a43f6600da9afe39bd76f6fb1f435b”
> Catalog = “MyCatalog”
> }
> Client {
> Name = “bareos-fd”
> Description = “Client resource of the Director itself.”
> Address = “localhost”
> Password = “[md5]7a0b5f3a138070aae8badd647030ca4c”
> Catalog = “MyCatalog”
> }

默认备份的目录为空，如果你想备份目录需要去/etc/bareos/bareos-dir.d/fileset/ Windows All Drives.conf配置文件中修改，修改完成后重启BareOS的三个服务

> [root@localhost ~]#vim /etc/bareos/bareos-dir.d/fileset/Windows All
> Drives.conf

备份Windows电脑

> FileSet { Name = “Windows电脑备份[A-Z]:/QMDownload” Enable VSS = yes
>
> # 当YES时，当文件正在被写时也能被备份；如NO，被写文件不会被备份 Include {
>
> ```
> Options {
> Signature = MD5
> Drive Type = fixed                            # 只备份固定磁盘
> IgnoreCase = yes                              # 忽略字母的大小写
> WildFile = "[A-Z]:/pagefile.sys"              # 指定文件：从磁盘A到Z下的/pagefile.sys
> WildDir = "[A-Z]:/RECYCLER"                   # 指定文件：从磁盘A到Z下的
> WildDir = "[A-Z]:/$RECYCLE.BIN"               # 指定文件：从磁盘A到Z下的
> WildDir = "[A-Z]:/System Volume Information"  # 指定文件：从磁盘A到Z下的
> Exclude = yes                                 # 另一种方式指定不备份上述指定文件
> }
> File ="C: / QMDownload "                    # 备份目录C:/QMDownload   } }
> 1234567891011
> ```

如您需要备份不同的文件，只需要修改 File =C: /QMDownload 即可。
 如：

> File = D:/Data # 备份D:/Data目录

用户可根据不同的需求来定义不同的fileset。

> [root@localhost ~]#bconsole
> *run Automatically selected Catalog: MyCatalog Using Catalog “MyCatalog” A job name must be specified. The defined Job resources
> are:
> 1: backup-bareos-fd #选项调用的是/etc/bareos/bareos-dir.d/job/backup-bareos-fd.conf
> 2: BackupCatalog #选项调用的是/etc/bareos/bareos-dir.d/job/BackupCatalog.conf
> 3: RestoreFiles #选项调用的是/etc/bareos/bareos-dir.d/job/RestoreFiles.conf
> Select Job resource (1-3): 1 Run Backup job JobName: backup-bareos-fd
> Level: Incremental Client: bareos-fd Format: Native FileSet:
> SelfTest Pool: Incremental (From Job IncPool override) Storage:
> File (From Job resource) When: 2020-02-27 03:07:05 Priority: 10 OK
> to run? (yes/mod/no): mod Parameters to modify:
> 1: Level #级别
> 2: Storage #（存储）选项调用/etc/bareos/bareos-dir.d/storage/File.conf
> 3: Job #（工作）选项调用/etc/bareos/bareos-dir.d/job/*.conf
> 4: FileSet #（文件集）选项调用/etc/bareos/bareos-dir.d/fileset/*.conf
> 5: Client #（客户）选项调用/etc/bareos/bareos-dir.d/client/*.conf
> 6: Backup Format #备份格式
> 7: When #什么时候（可以定时备份）
> 8: Priority #优先
> 9: Pool #（池）选项调用/etc/bareos/bareos-dir.d/pool/*.conf
> 10: Plugin Options #插件选项 Select parameter to modify (1-10): 1 Levels:
> 1: Full #完整
> 2: Incremental #递增
> 3: Differential #差异
> 4: Since #以来
> 5: VirtualFull #虚拟全 Select level (1-5): 1 Run Backup job JobName: backup-bareos-fd Level: Full Client: bareos-fd Format:
> Native FileSet: SelfTest Pool: Full (From Job FullPool override)
> Storage: File (From Job resource) When: 2020-02-27 03:07:05
> Priority: 10 OK to run? (yes/mod/no): mod Parameters to modify:
> 1: Level #级别
> 2: Storage #（存储）选项调用/etc/bareos/bareos-dir.d/storage/File.conf
> 3: Job #（工作）选项调用/etc/bareos/bareos-dir.d/job/*.conf
> 4: FileSet #（文件集）选项调用/etc/bareos/bareos-dir.d/fileset/*.conf
> 5: Client #（客户）选项调用/etc/bareos/bareos-dir.d/client/*.conf
> 6: Backup Format #备份格式
> 7: When #什么时候（可以定时备份）
> 8: Priority #优先
> 9: Pool #（池）选项调用/etc/bareos/bareos-dir.d/pool/*.conf
> 10: Plugin Options #插件选项 Select parameter to modify (1-10): 5 The defined Client resources are:
> 1: bareos-fd
> 2: win-fd #这个是win客户端的调用的是/etc/bareos/bareos-dir.d/client/win-fd.conf
> Select Client (File daemon) resource (1-2): 2 Run Backup job JobName:
> backup-bareos-fd Level: Full Client: win-fd Format: Native
> FileSet: SelfTest Pool: Full (From Job FullPool override)
> Storage: File (From Job resource) When: 2020-02-27 03:07:05
> Priority: 10 OK to run? (yes/mod/no): mod Parameters to modify:
> 1: Level #级别
> 2: Storage #（存储）选项调用/etc/bareos/bareos-dir.d/storage/File.conf
> 3: Job #（工作）选项调用/etc/bareos/bareos-dir.d/job/*.conf
> 4: FileSet （文件集）选项调用/etc/bareos/bareos-dir.d/fileset/*.conf
> 5: Client ##（客户）选项调用/etc/bareos/bareos-dir.d/client/*.conf
> 6: Backup Format #备份格式
> 7: When #什么时候（可以定时备份）
> 8: Priority #优先
> 9: Pool #（池）选项调用/etc/bareos/bareos-dir.d/pool/*.conf
> 10: Plugin Options #插件选项 Select parameter to modify (1-10): 4 The defined FileSet resources are:
> 1: Catalog #（目录）调用/etc/bareos/bareos-dir.d/fileset/Catalog.conf
> 2: LinuxAll #全部Linux 调用/etc/bareos/bareos-dir.d/fileset/LinuxAll.conf
> 3: SelfTest #（测试）调用/etc/bareos/bareos-dir.d/fileset/SelfTest.conf
> 4: Windows All Drives #（所有Windows驱动）调用/bareos-dir.d/fileset/*.conf Select FileSet
> resource (1-4): 4 Run Backup job JobName: backup-bareos-fd Level:
> Full Client: win-fd Format: Native FileSet: Windows All Drives
> Pool: Full (From Job FullPool override) Storage: File (From Job
> resource) When: 2020-02-27 03:07:05 Priority: 10 OK to run?
> (yes/mod/no): yes Job queued. JobId=1
>
> - You have new mail in /var/spool/mail/root [root@localhost ~]#

可以去web界面查看备份的状态了

## 添加Ubuntu客户端

软件仓库的URL是：

> http://download.bareos.org/bareos/release/latest/Debian_9.0

建立/etc/apt/sources.list.d/bareos.list文件，文件内容为：

> deb http://download.bareos.org/bareos/release/latest/Debian_9.0 /

添加bareos软件仓库的apt键值

> root@bareos:~# wget -q
> http://download.bareos.org/bareos/release/latest/Debian_9.0/Release.key
> -O- | apt-key add -

更新APT源列表

> root@bareos:~# apt update apt-get install bareos-filedaemon

备份文件组（fileset）配置文件

> /etc/bareos/bareos-dir.d/fileset/*.conf

该目录下有一系列配置文件，这些文件用于定义如何备份一组文件（fileset）。
 这是最重要的配置之一，而又只能通过终端手工配置，所以我们在此将详细介绍。

备份Linux电脑

> FileSet { # fileset 开始标志
> Name = “LinuxAll” # 该 fileset
> 的名字，这个名字会在备份任务中使用 Description = “备份所有系统，除了不需要备份的。” Include {
>
> # 备份中需要包含的文件
>
> ```
> Options {                                 # 选项
> Signature = MD5                         # 每个文件产生MD5校验文件
> One FS = No                             # 所有指定的文件（含子目录）都会被备份
> # One FS = Yes                          # 指定的文件（含子目录）如不在同一文件系统下不会被备份
> #
> # 需要备份的文件系统类型列表
> FS Type = btrfs                         # btrfs 文件系统需要备份
> FS Type = ext2                          # ext2 文件系统需要备份
> FS Type = ext3                          # ext3 文件系统需要备份
> FS Type = ext4                          # ext4 文件系统需要备份
> FS Type = reiserfs                      # reiserfs 文件系统需要备份
> FS Type = jfs                           # jfs 文件系统需要备份
> FS Type = xfs                           # xfs 文件系统需要备份
> FS Type = zfs                           # zfs 文件系统需要备份
> }
> File = /                                  # 所有目录和文件   }   # 定义不需要备份的文件和目录   Exclude {                                   #
> 12345678910111213141516
> ```
>
> 备份中不应该包含的文件
> \# 无需备份文件/目录列表
> File = /var/lib/bareos # /var/lib/bareos 下放的是bareos的临时文件
> File = /var/lib/bareos/storage # /var/lib/bareos/storage 下放的是备份文件
> File = /proc # /proc 无需备份
> File = /tmp # /tmp无需备份
> File = /var/tmp # /var/tmp无需备份
> File = /.journal # /.journal 无需备份
> File = /.fsck # /.fsck无需备份 } }

一般情况下，您只需要修改该文件来达到不同的备份需求。如子备份/home目录：

> …
> FS Type = xfs # xfs 文件系统需要备份
> FS Type = zfs # zfs 文件系统需要备份
> }
> File = /home # /home下的所有目录和文件 } # 定义不需要备份的文件和目录 Exclude { #
> 备份中不应该包含的文件
> \# 无需备份文件/目录列表
> File = /var/lib/bareos # /var/lib/bareos 下放的是bareos的临时文件 …

下面我们定义一个用于测试任务的fileset（TestSet）

> FileSet { # fileset 开始标志
>
> ```
> Name = "TestSet"                            # 该 fileset 的名字，这个名字会在备份任务中使用
> Description = "备份/usr/sbin（用于测试任务）"
> Include {                                   # 备份中需要包含的文件
>  Options {                                 # 选项
>    Signature = MD5                         # 每个文件产生MD5校验文件
>    One FS = No                             # 所有指定的文件（含子目录）都会被备份
>    # One FS = Yes                          # 指定的文件（含子目录）如不在同一文件系统下不会被备份
>    #
>    # 需要备份的文件系统类型列表
>    FS Type = btrfs                         # btrfs 文件系统需要备份
>    FS Type = ext2                          # ext2 文件系统需要备份
>    FS Type = ext3                          # ext3 文件系统需要备份
>    FS Type = ext4                          # ext4 文件系统需要备份
>    FS Type = reiserfs                      # reiserfs 文件系统需要备份
>    FS Type = jfs                           # jfs 文件系统需要备份
>    FS Type = xfs                           # xfs 文件系统需要备份
>    FS Type = zfs                           # zfs 文件系统需要备份
>  }
>  File = /"/usr/sbin"                       # 所有目录和文件
> }
> }
> 123456789101112131415161718192021
> ```

因为没有不需要备份的文件，所以我们移除了Exclude。

备份任务定义（jobdefs）配置文件

> /etc/bareos/bareos-dir.d/jobdefs/*.conf

实例：测试任务（TestJob）

> JobDefs { Name = “TestJob”
>
> # 测试任务 Type = Backup # 类型：备份（Backup） Level = Incremental
>
> # 方式：递进（Incremental） Client = bareos-fd # 被备份客户端：bareos-fd （在Client中定义） FileSet = “TestSet” # 备份文件组：TesetSet （在FileSet中定义） Schedule = “WeeklyCycle” #  备份周期：WeeklyCy（在schedule中定义） Storage = File # 备份媒体： File（在Storage中定义）  Messages = Standard # 消息方式：Standard（在Message中定义） Pool = Incremental #  存储池：Incremental（在pool中定义） Priority = 10 # 优先级：10 Write Bootstrap =  “/var/lib/bareos/%c.bsr” # Full Backup Pool = Full # Full备份，使用 “Full”
>
> 池（在storage中定义） Differential Backup Pool = Differential #
> Differential备份，使用 “Differential” 池（在storage中定义） Incremental Backup
> Pool = Incremental # Incremental备份，使用 “Incremental” 池（在storage中定义）
> }

任务（job）配置文件

> /etc/bareos/bareos-dir.d/job/*.conf

配置备份任务：实例：在客户端bareos-fa上运行TestJob（备份/usr/sbin下的所有文件）

> Job { Name = “backup-test-on-bareos-fd” # 任务名 JobDefs
> = “TestJob” # 使用已定义的备份任务TestJob （在jobdefs中定义） Client = “bareos-fd” #
> 客户端名称： bareos-fd（在client中定义） } 存储媒体（storage）配置文件
> /etc/bareos/bareos-dir.d/storage/*.conf
>
> Storage { Name = File Address = bareos #
> director-sd名字，使用FQDN (不要使用 “localhost” ). Password =
> “JgwtSYloo93DlXnt/cjUfPJIAD9zocr920FEXEV0Pn+S” Device = FileStorage
> \#在bareos-sd中定义 Media Type = File }

注意：Device是在Bareos的Storage Daemon中定义的，Device的名字和Media Type必须一致。

这是在安装时自动生成的存储媒体配置文件，如使用本地硬盘文件系统做存储媒体，不需要做任何修改。

存储池（pool）配置文件

> /etc/bareos/bareos-dir.d/pool/*.conf

一般情况下，我们需要四个存储池。分别是：

> Full：用于完整备份【Full：备份所有文件】 Incremental：用于递增备份【Incremental：备份所有状态变化的文件】
> Differential：用于差异备份【Differential：备份所有修改了（modified标志变化）的文件】
> Scratch：当系统找不到需要的Volume时，自动使用该存储池。 Scratch名称不可修改，其他存储池名字可修改。

下面是系统安装时生成的pool定义文件，一般情况下无需修改。

> Differential.conf
>
> Pool { Name = Differential Pool Type = Backup Recycle = yes
> Bareos 自动回收重复使用 Volumes（Volume备份文件标记） AutoPrune = yes # 自动清除过期的Volumes Volume Retention = 90 days # Volume有效时间 Maximum Volume
> Bytes = 10G # Volume最大尺寸 Maximum Volumes = > 100 # 单个存储池允许的Volume数量
> Label Format = “Differential-” > # Volumes 将被标记为
> “Differential-” } Full.conf > > > Pool { Name = Full Pool
> Type = Backup Recycle = yes > > > Bareos 自动回收重复使用
> Volumes（Volume备份文件标记） AutoPrune = yes # 自动清除过期的Volumes Volume
> Retention = 365 days # Volume有效时间 Maximum Volume Bytes = 50G #
> Volume最大尺寸 Maximum Volumes = > 100 # 单个存储池允许的Volume数量 Label Format =
> “Full-” > > > # > Volumes 将被标记为 “Differential-” }
> Incremental.conf > > > > Pool { Name = Incremental Pool Type = Backup
> Recycle = yes > # Bareos 自动回收重复使用 Volumes（Volume备份文件标记） AutoPrune =
> yes # 自动清除过期的Volumes Volume Retention = 30 days # Volume有效时间 Maximum
> Volume Bytes = 1G # Volume最大尺寸 Maximum Volumes = > 100 #
> 单个存储池允许的Volume数量 Label Format = “Incremental-” > # Volumes 将被标记为
> “Differential-” } Scratch.conf
>
> Pool { Name = Scratch Pool Type = Scratch }

修改bareos-dir的配置后，必须重启Director。在重启Director前，请首先使用bareos-dir -t  -v检查bareos-dir配置文件。如bareos-dir -t -v没有任何输出，说明配置文件没有任何语法问题，可以重启Director。

计划（schedule）配置文件

> /etc/bareos/bareos-dir.d/schedule/*.conf

实例：
 一、每月第一个周六晚9点做完整备份；
 二、其余周六晚9点做差异备份；
 三、周一至周五晚九点做递增备份。

> Schedule { Name = “WeeklyCycle” Run = Full 1st sat at 21:00
> 每月第一个周六/晚九点，完整备份 Run = Differential 2nd-5th sat at 21:00 # 其余周六/晚九点，差异备份 Run = Incremental mon-fri at 21:00 #
> 周一至周五，递增备份 }

提示信息（message）配置文件

> /etc/bareos/bareos-dir.d/message/*.conf

用于配置任务（job）完成后如何发送提示信息
 示例：

##

> Messages { Name = Standard Description = “Reasonable message delivery
> – send most everything to email address and to the console.” # operatorcommand = “/usr/bin/bsmtp -h localhost -f “(Bareos)
> <%r>” -s “Bareos: Intervention needed for %j” %r” # mailcommand =
> “/usr/bin/bsmtp -h localhost -f “(Bareos) <%r>” -s “Bareos: %t
> %e of %c %l” %r” operator = root@localhost = mount #
> 执行operatorcommand命令，用户：root@localhost，操作：mount mail = root@localhost =
> all, !skipped, !saved, !audit #
> 执行mailcommand，用户：root@localhost，操作：所有（除skipped，saved和audit） console =
> all, !skipped, !saved, !audit # 所有操作，除skipped，saved和audit append =
> “/var/log/bareos/bareos.log” = all, !skipped, !saved, !audit #
> 所有操作，除skipped，saved和audit catalog = all, !skipped, !saved, !audit #
> 所有操作，除skipped，saved和audit # 可用参数 # %% = % # %c = Client’s name # %d =
> Director’s name # %e = Job Exit code (OK, Error, …) # %h = Client
> address # %i = Job Id # %j = Unique Job name # %l = Job level # %n =
> Job name # %r = Recipients # %s = Since time # %t = Job type (e.g.
> Backup, …) # %v = Read Volume name (Only on director side) # %V =
> Write Volume name (Only on director side) # console：定义发送到console的信息 #
> append：定义发送到日志文件的信息 # catalog：定义发送到数据库的信息 }

bsmtp只适用于有本地SMTP服务器，一般情况并不适用。我们将另文介绍如何使用外部SMTP邮件服务器发送bareos的信息邮件。

Bareos的Director已配置完成，在开始备份任务前，我们还需要配置客户端（File Daemon）。

配置Bareos客户端（File Daemon）模块
 Bareos客户端（File Daemon）模块的配置文件位于/etc/bareos/bareos-dir.d目录下。









#### **配置Bareos存储服务（Storage Daemon）模块**

Bareos存储服务（Storage）模块为bareos系统提供数据存储服务模块。它的配置文件位于/etc/bareos/bareos-sd.d目录下。

```
root@bareos:/etc/bareos/bareos-sd.d# ls -l
total 16
drwxr-x--- 2 bareos bareos 4096 Sep 16 11:37 device
drwxr-x--- 2 bareos bareos 4096 Sep 16 11:37 director
drwxr-x--- 2 bareos bareos 4096 Sep 16 11:44 messages
drwxr-x--- 2 bareos bareos 4096 Sep 16 11:43 storage
root@bareos:/etc/bareos/bareos-sd.d#
1234567
```

***配置Storage的存储设备***

device下放的是存储媒体配置文件，bareos系统是基于文件的备份/恢复系统，device下只有一个配置文件FileStorage.conf。

可能的FileStorage.conf如下：

```
# HDD 存储设备
Device {
  Name = FileStorage                  # 设备名称
  Media Type = File                   # 类型，bareos是基于文件的备份/恢复系统，类型永远是文件
  Archive Device = /bareos/hdd        # Ubuntu下的备份文件目录（或mount point）
  LabelMedia = yes;                   # lets Bareos label unlabeled media
  Random Access = yes;                # 可随机读写
  AutomaticMount = yes;               # 自动加载
  RemovableMedia = no;                # 媒体介质不可移除
  AlwaysOpen = yes;                   # 总是打开
}

# 磁带存储设备
Device {
  Name = TapeStorage                  # 设备名称
  Media Type = File                   # 类型，bareos是基于文件的备份/恢复系统，类型永远是文件
  Archive Device = /bareos/tape       # Ubuntu下的mount point
  LabelMedia = yes;                   # lets Bareos label unlabeled media
  Random Access = no;                 # 不能随机读写
  AutomaticMount = no;                # 不自动加载
  RemovableMedia = yes;               # 媒体介质可移除
  AlwaysOpen = no;                    # 按需打开
}
1234567891011121314151617181920212223
```

在上述配置文件中，我们配置了二种存储设备，分别是硬盘和磁带。在配置时，请注意被配置存储设备的物理属性。硬盘类的存储设备是可随机读写，磁带类的是不可随机读写。
 现在公司一般很少配磁带备份，我们的备份方案是：在/bareos/hdd下挂载SAN设备，然后通过rsync将/bareos/hdd目录下的内容同步到远程SAN上，从而保证数据的安全。

实例中的FileStorage.conf文件：

```
/etc/bareos/bareos-sd.d/device/FileStorage.conf
# HDD 存储设备
Device {
  Name = FileStorage                  # 设备名称
  Media Type = File                   # 类型，bareos是基于文件的备份/恢复系统，类型永远是文件
  Archive Device = /bareos/hdd        # Ubuntu下的mount point
  LabelMedia = yes;                   # lets Bareos label unlabeled media
  Random Access = yes;                # 可随机读写
  AutomaticMount = yes;               # 自动加载
  RemovableMedia = no;                # 媒体介质不可移除
  AlwaysOpen = yes;                   # 总是打开
}
1234567891011
```

***配置Storage的ACL***
 director下有二个配置文件`bareos-dir.conf`和`bareos-mon.conf`，分别用于管理director和monitor对storage模块的授权。

**`/etc/bareos/bareos-sd.d/director/bareos-dir.conf`**

```
Director {
  Name = bareos-dir                                             # 名字
  Password = "JgwtSYloo93DlXnt/cjUfPJIAD9zocr920FEXEV0Pn+S"     # 密码
  Description = "允许操作此storage的Director设置"
}

123456
```

**`/etc/bareos/bareos-sd.d/director/bareos-mon.conf`**

```
Director {
  Name = bareos-mon
  Password = "4wdzVcvZAFgTz+IWlB4C5hd09czTXhsAd8SnZQ1VZn4X"
  Monitor = yes
  Description = "允许读取此storage状态的Monitor设置"
}
123456
```

monitor是bareos的GUI监视程序。

***配置 storage 相关信息服务***

```
/etc/bareos/bareos-sd.d/messages/Standard.conf
Messages {
  Name = Standard
  Director = bareos-dir = all # bareos-dir：发送信息到bareis-dir，all：所有信息
  # mailcommand =  # 可执行命令或脚本
  # operatorcommand = # 可执行命令或脚本
  Description = "Send all messages to the Director."
  # 可用参数
  # %% = %
  # %c = Client’s name
  # %d = Director’s name
  # %e = Job Exit code (OK, Error, ...)
  # %h = Client address
  # %i = Job Id
  # %j = Unique Job name
  # %l = Job level
  # %n = Job name
  # %r = Recipients
  # %s = Since time
  # %t = Job type (e.g. Backup, ...)
  # %v = Read Volume name (Only on director side)
  # %V = Write Volume name (Only on director side)
}
12345678910111213141516171819202122
```

***配置 storage 相关特性或功能***

```
Storage {
  Name = bareos-sd
  Maximum Concurrent Jobs = 20

  # remove comment from "Plugin Directory" to load plugins from specified directory.
  # if "Plugin Names" is defined, only the specified plugins will be loaded,
  # otherwise all storage plugins (*-sd.so) from the "Plugin Directory".
  #
  # Plugin Directory = /usr/lib/bareos/plugins
  # Plugin Names = ""
}

123456789101112
```

一般情况下，我们只需要修改FileStorage.conf配置文件中的`Archive Device`，默认的`Archive Device`是`/var/lib/bareos/storage`，默认的`bareos-sd`配置能满足一般需求。

修改`bareos-sd`的配置后，必须重启`bareos-sd`。在重启`bareos-sd`前，请首先使用`bareos-sd -t -v`检查`bareos-sd`配置文件。如`bareos-sd -t -v`没有任何输出，说明配置文件没有任何语法问题，可以重启`bareos-sd`。

------

#### **配置Bareos管理（Director）模块**

Bareos管理（Director）模块为bareos系统管理模块。它的配置文件位于/etc/bareos/bareos-dir.d目录下。

```
root@bareos:/etc/bareos/bareos-dir.d# ls -l
total 48
drwxr-x--- 2 bareos bareos 4096 Sep 11 09:13 catalog
drwxr-x--- 2 bareos bareos 4096 Sep 11 09:13 client
drwxr-x--- 2 bareos bareos 4096 Sep 11 11:08 console
drwxr-x--- 2 bareos bareos 4096 Sep 15 20:42 director
drwxr-x--- 2 bareos bareos 4096 Sep 11 09:13 fileset
drwxr-x--- 2 bareos bareos 4096 Sep 11 09:13 job
drwxr-x--- 2 bareos bareos 4096 Sep 11 09:13 jobdefs
drwxr-x--- 2 bareos bareos 4096 Sep 18 17:18 messages
drwxr-x--- 2 bareos bareos 4096 Sep 11 09:13 pool
drwxr-x--- 2 bareos bareos 4096 Sep 15 20:45 profile
drwxr-x--- 2 bareos bareos 4096 Sep 11 09:13 schedule
drwxr-x--- 2 bareos bareos 4096 Sep 11 09:13 storage
root@bareos:/etc/bareos/bareos-dir.d#
123456789101112131415
```

配置文件的文件名可任意，但必须以`.conf`结尾。

***目录（catalog）数据库链接方式配置文件***
 `/etc/bareos/bareos-dir.d/MyCatalog.conf`

```
Catalog {
  Name = MyCatalog          # catalog名字
  dbdriver = mysql          # 使用MySQL驱动（兼容MariaDB）
  dbname = bareos           # 数据库名
  dbuser = bareos           # 该数据库之用户名
  dbpassword = bareos       # 该用户之密码
}

12345678
```

该文件在安装bareos-mysql时已被初始化，一般情况下无需修改。

***客户端（File Daemon）配置文件***
 `/etc/bareos/bareos-dir.d/client/clientname-fd.conf`

下面是bareos服务器的默认File Daemon配置文件：

```
Client {
  Name = bareos-fd                                                   # Director中使用的客户端名字
  Description = "Client resource of the Director itself."            # 解释
  Address = localhost                                                # 客户端FQDN或IP地址
  Password = "QGSqraVyf7kQfpdTxv+j/h27nesW7ypmGP5wLPLXltE9"          # 密码
}

1234567
```

配置客户端可以直接建立/修改配置文件，也可以通过bconsole来完成。

下面是使用bconsole建立客户端示例：
 root@bareos:~# bconsole
 Connecting to Director localhost:9101
 1000 OK: bareos-dir Version: 17.2.4 (21 Sep 2017)
 Enter a period to cancel a command.
 `*configure add client name=lscms-fd address=lscms.lswin.cn password=lscmsFdPasswd`

我们可以在/etc/bareos/bareos-dir.d/client下见到新的客户端配置文件`lscms-fd.conf`。内容为：

```
Client {
  Name = lscms-fd
  Address = lscms.lswin.cn
  Password = lscmsFdPasswd
}
12345
```

***终端（console）配置文件***
 在该目录（`/etc/bareos/bareos-dir.d/console`）下有二个配置文件：admin.conf 和 bareos-mon.conf
 `/etc/bareos/bareos-dir.d/console/admin.conf`：Web GUI 配置文件
 `/etc/bareos/bareos-dir.d/console/bareos-mon.conf`：Bareos 托盘监测配置文件

Web GUI 配置文件 `/etc/bareos/bareos-dir.d/console/admin.conf`：

```
Console {
  Name = admin
  Password = pwd111111
  Profile = webui-admin             # 指明是为WebGUI，该名字必须是webui-admin
}
12345
```

托盘监测配置文件`/etc/bareos/bareos-dir.d/console/bareos-mon.conf`

```
Console {
  Name = bareos-mon
  Description = "Restricted console used by tray-monitor to get the status of the director."
  Password = "8ipdQxiufhgskdNWk4ydvVWZfXGa9SmVBG690X+Mh9Ph"
  CommandACL = status, .status             # 只有 status 命令或 .status命令被授权
  JobACL = *all*                           # 所有任务都被授权
}
1234567
```

一般情况下，这些文件无需修改。

***控制端（Director）配置文件***
 `/etc/bareos/bareos-dir.d/director/bareos-dir.conf`

```
Director {                                                          # 配置控制端
  Name = bareos-dir
  QueryFile = "/usr/lib/bareos/scripts/query.sql"
  Maximum Concurrent Jobs = 10                                      # 同时可执行10个任务，更多任务需排队
  Password = "LiYwqsOHIEhfjPts14Pvenk9YMfmWEN81PxugpdOHt3C"         # 控制端 password
  Messages = Daemon                                                 # 只接受驻留任务消息
  Auditing = yes                                                    # 开启审计

  # Enable the Heartbeat if you experience connection losses
  # Heartbeat Interval = 1 min                                      # 如Director不在本地，可能需要开启    
}
```

一般情况，无需修改。

***备份文件组（fileset）配置文件***
 `/etc/bareos/bareos-dir.d/fileset/*.conf`

该目录下有一系列配置文件，这些文件用于定义如何备份一组文件（fileset）。
 这是最重要的配置之一，而又只能通过终端手工配置，所以我们在此将详细介绍。

一、备份Linux电脑

```
FileSet {                                     # fileset 开始标志                                
  Name = "LinuxAll"                           # 该 fileset 的名字，这个名字会在备份任务中使用
  Description = "备份所有系统，除了不需要备份的。"
  Include {                                   # 备份中需要包含的文件
    Options {                                 # 选项
      Signature = MD5                         # 每个文件产生MD5校验文件
      One FS = No                             # 所有指定的文件（含子目录）都会被备份
      # One FS = Yes                          # 指定的文件（含子目录）如不在同一文件系统下不会被备份
      #
      # 需要备份的文件系统类型列表
      FS Type = btrfs                         # btrfs 文件系统需要备份
      FS Type = ext2                          # ext2 文件系统需要备份
      FS Type = ext3                          # ext3 文件系统需要备份
      FS Type = ext4                          # ext4 文件系统需要备份
      FS Type = reiserfs                      # reiserfs 文件系统需要备份
      FS Type = jfs                           # jfs 文件系统需要备份
      FS Type = xfs                           # xfs 文件系统需要备份
      FS Type = zfs                           # zfs 文件系统需要备份
    }
    File = /                                  # 所有目录和文件
  }
  # 定义不需要备份的文件和目录
  Exclude {                                   # 备份中不应该包含的文件
    # 无需备份文件/目录列表
    File = /var/lib/bareos                    # /var/lib/bareos 下放的是bareos的临时文件
    File = /var/lib/bareos/storage            # /var/lib/bareos/storage 下放的是备份文件
    File = /proc                              # /proc 无需备份
    File = /tmp                               # /tmp无需备份
    File = /var/tmp                           # /var/tmp无需备份
    File = /.journal                          # /.journal 无需备份
    File = /.fsck                             # /.fsck无需备份
  }
}
```

一般情况下，您只需要修改该文件来达到不同的备份需求。如子备份`/home`目录：

```
......
      FS Type = xfs                           # xfs 文件系统需要备份
      FS Type = zfs                           # zfs 文件系统需要备份
    }
    File = /home                              # /home下的所有目录和文件
  }
  # 定义不需要备份的文件和目录
  Exclude {                                   # 备份中不应该包含的文件
    # 无需备份文件/目录列表
    File = /var/lib/bareos                    # /var/lib/bareos 下放的是bareos的临时文件
......
1234567891011
```

二、备份Windows电脑

```
FileSet {
  Name = "Windows电脑备份[A-Z]:/QMDownload"
  Enable VSS = yes                                  # 当YES时，当文件正在被写时也能被备份；如NO，被写文件不会被备份
  Include {
    Options {
      Signature = MD5
      Drive Type = fixed                            # 只备份固定磁盘
      IgnoreCase = yes                              # 忽略字母的大小写
      WildFile = "[A-Z]:/pagefile.sys"              # 指定文件：从磁盘A到Z下的/pagefile.sys
      WildDir = "[A-Z]:/RECYCLER"                   # 指定文件：从磁盘A到Z下的
      WildDir = "[A-Z]:/$RECYCLE.BIN"               # 指定文件：从磁盘A到Z下的
      WildDir = "[A-Z]:/System Volume Information"  # 指定文件：从磁盘A到Z下的
      Exclude = yes                                 # 另一种方式指定不备份上述指定文件
    }
    File ="C: / QMDownload "                    # 备份目录C:/QMDownload
  }
}
1234567891011121314151617
```

如您需要备份不同的文件，只需要修改 `File =C: /QMDownload` 即可。
 如：
 `File = D:/Data # 备份D:/Data目录`

用户可根据不同的需求来定义不同的fileset。

三、下面我们定义一个用于测试任务的fileset（`TestSet`）

```
    FileSet {                                     # fileset 开始标志                                
      Name = "TestSet"                            # 该 fileset 的名字，这个名字会在备份任务中使用
      Description = "备份/usr/sbin（用于测试任务）"
      Include {                                   # 备份中需要包含的文件
        Options {                                 # 选项
          Signature = MD5                         # 每个文件产生MD5校验文件
          One FS = No                             # 所有指定的文件（含子目录）都会被备份
          # One FS = Yes                          # 指定的文件（含子目录）如不在同一文件系统下不会被备份
          #
          # 需要备份的文件系统类型列表
          FS Type = btrfs                         # btrfs 文件系统需要备份
          FS Type = ext2                          # ext2 文件系统需要备份
          FS Type = ext3                          # ext3 文件系统需要备份
          FS Type = ext4                          # ext4 文件系统需要备份
          FS Type = reiserfs                      # reiserfs 文件系统需要备份
          FS Type = jfs                           # jfs 文件系统需要备份
          FS Type = xfs                           # xfs 文件系统需要备份
          FS Type = zfs                           # zfs 文件系统需要备份
        }
        File = /"/usr/sbin"                       # 所有目录和文件
      }
    }
12345678910111213141516171819202122
```

因为没有不需要备份的文件，所以我们移除了Exclude。

***备份任务定义（jobdefs）配置文件***
 `/etc/bareos/bareos-dir.d/jobdefs/*.conf`

实例：测试任务（TestJob）

```
JobDefs {
  Name = "TestJob"                                          # 测试任务
  Type = Backup                                             # 类型：备份（Backup）
  Level = Incremental                                       # 方式：递进（Incremental）
  Client = bareos-fd                                        # 被备份客户端：bareos-fd （在Client中定义）
  FileSet = "TestSet"                                       # 备份文件组：TesetSet （在FileSet中定义）
  Schedule = "WeeklyCycle"                                  # 备份周期：WeeklyCy（在schedule中定义）
  Storage = File                                            # 备份媒体： File（在Storage中定义）
  Messages = Standard                                       # 消息方式：Standard（在Message中定义）
  Pool = Incremental                                        # 存储池：Incremental（在pool中定义）
  Priority = 10                                             # 优先级：10
  Write Bootstrap = "/var/lib/bareos/%c.bsr"                #
  Full Backup Pool = Full                  # Full备份，使用 "Full" 池（在storage中定义）
  Differential Backup Pool = Differential  # Differential备份，使用 "Differential" 池（在storage中定义）
  Incremental Backup Pool = Incremental    # Incremental备份，使用 "Incremental" 池（在storage中定义）
}
12345678910111213141516
```

***任务（job）配置文件***
 `/etc/bareos/bareos-dir.d/job/*.conf`
 配置备份任务：实例：在客户端bareos-fa上运行TestJob（备份/usr/sbin下的所有文件）

```
Job {
  Name = "backup-test-on-bareos-fd"              # 任务名
  JobDefs = "TestJob"                            # 使用已定义的备份任务TestJob （在jobdefs中定义）
  Client = "bareos-fd"                           # 客户端名称： bareos-fd（在client中定义）
}
12345
```

***存储媒体（storage）配置文件***
 `/etc/bareos/bareos-dir.d/storage/*.conf`

```
Storage {
  Name = File
  Address = bareos                # director-sd名字，使用FQDN (不要使用 "localhost" ).
  Password = "JgwtSYloo93DlXnt/cjUfPJIAD9zocr920FEXEV0Pn+S"
  Device = FileStorage            # 在bareos-sd中定义
  Media Type = File
}
1234567
```

注意：Device是在Bareos的Storage Daemon中定义的，Device的名字和Media Type必须一致。

这是在安装时自动生成的存储媒体配置文件，如使用本地硬盘文件系统做存储媒体，不需要做任何修改。

***存储池（pool）配置文件***
 `/etc/bareos/bareos-dir.d/pool/*.conf`
 一般情况下，我们需要四个存储池。分别是：
 Full：用于完整备份【Full：备份所有文件】
 Incremental：用于递增备份【Incremental：备份所有状态变化的文件】
 Differential：用于差异备份【Differential：备份所有修改了（modified标志变化）的文件】
 Scratch：当系统找不到需要的Volume时，自动使用该存储池。
 Scratch名称不可修改，其他存储池名字可修改。
 下面是系统安装时生成的pool定义文件，一般情况下无需修改。

***Differential.conf***

```
Pool {
  Name = Differential
  Pool Type = Backup
  Recycle = yes                       # Bareos 自动回收重复使用 Volumes（Volume备份文件标记）
  AutoPrune = yes                     # 自动清除过期的Volumes
  Volume Retention = 90 days          # Volume有效时间
  Maximum Volume Bytes = 10G          # Volume最大尺寸
  Maximum Volumes = 100               # 单个存储池允许的Volume数量
  Label Format = "Differential-"      # Volumes 将被标记为 "Differential-<volume-id>"
}
12345678910
```

***Full.conf***

```
Pool {
  Name = Full
  Pool Type = Backup
  Recycle = yes                       # Bareos 自动回收重复使用 Volumes（Volume备份文件标记）
  AutoPrune = yes                     # 自动清除过期的Volumes
  Volume Retention = 365 days         # Volume有效时间
  Maximum Volume Bytes = 50G          # Volume最大尺寸
  Maximum Volumes = 100               # 单个存储池允许的Volume数量
  Label Format = "Full-"              # Volumes 将被标记为 "Differential-<volume-id>"
}
1234567891011
```

***Incremental.conf***

```
Pool {
  Name = Incremental
  Pool Type = Backup
  Recycle = yes                       # Bareos 自动回收重复使用 Volumes（Volume备份文件标记）
  AutoPrune = yes                     # 自动清除过期的Volumes
  Volume Retention = 30 days          # Volume有效时间
  Maximum Volume Bytes = 1G           # Volume最大尺寸
  Maximum Volumes = 100               # 单个存储池允许的Volume数量
  Label Format = "Incremental-"       # Volumes 将被标记为 "Differential-<volume-id>"
}
12345678910
```

***Scratch.conf***

```
Pool {
  Name = Scratch
  Pool Type = Scratch
}
```

修改`bareos-dir`的配置后，必须重启Director。在重启Director前，请首先使用`bareos-dir -t -v`检查`bareos-dir`配置文件。如`bareos-dir -t -v`没有任何输出，说明配置文件没有任何语法问题，可以重启Director。

***计划（schedule）配置文件***
 `/etc/bareos/bareos-dir.d/schedule/*.conf`
 实例：
 一、每月第一个周六晚9点做完整备份；
 二、其余周六晚9点做差异备份；
 三、周一至周五晚九点做递增备份。

```
Schedule {
  Name = "WeeklyCycle"
  Run = Full 1st sat at 21:00                   # 每月第一个周六/晚九点，完整备份
  Run = Differential 2nd-5th sat at 21:00       # 其余周六/晚九点，差异备份
  Run = Incremental mon-fri at 21:00            # 周一至周五，递增备份
}
```

***提示信息（message）配置文件***
 `/etc/bareos/bareos-dir.d/message/*.conf`
 用于配置任务（job）完成后如何发送提示信息
 示例：

```
Messages {
  Name = Standard
  Description = "Reasonable message delivery -- send most everything to email address and to the console."
  # operatorcommand = "/usr/bin/bsmtp -h localhost -f \"\(Bareos\) \<%r\>\" -s \"Bareos: Intervention needed for %j\" %r"
  # mailcommand = "/usr/bin/bsmtp -h localhost -f \"\(Bareos\) \<%r\>\" -s \"Bareos: %t %e of %c %l\" %r"
  operator = root@localhost = mount                                 # 执行operatorcommand命令，用户：root@localhost，操作：mount
  mail = root@localhost = all, !skipped, !saved, !audit             # 执行mailcommand，用户：root@localhost，操作：所有（除skipped，saved和audit）
  console = all, !skipped, !saved, !audit                           # 所有操作，除skipped，saved和audit
  append = "/var/log/bareos/bareos.log" = all, !skipped, !saved, !audit  # 所有操作，除skipped，saved和audit
  catalog = all, !skipped, !saved, !audit                           # 所有操作，除skipped，saved和audit
   # 可用参数
  # %% = %
  # %c = Client’s name
  # %d = Director’s name
  # %e = Job Exit code (OK, Error, ...)
  # %h = Client address
  # %i = Job Id
  # %j = Unique Job name
  # %l = Job level
  # %n = Job name
  # %r = Recipients
  # %s = Since time
  # %t = Job type (e.g. Backup, ...)
  # %v = Read Volume name (Only on director side)
  # %V = Write Volume name (Only on director side)
  # console：定义发送到console的信息
  # append：定义发送到日志文件的信息
  # catalog：定义发送到数据库的信息
}
```

bsmtp只适用于有本地SMTP服务器，一般情况并不适用。我们将另文介绍如何使用外部SMTP邮件服务器发送bareos的信息邮件。

Bareos的Director已配置完成，在开始备份任务前，我们还需要配置客户端（File Daemon）。

------

#### **配置Bareos客户端（File Daemon）模块**

Bareos客户端（File Daemon）模块的配置文件位于/etc/bareos/bareos-dir.d目录下。

***一、添加/配置客户机***

需要在Director和客户机上分别配置。

首先在Director上有 bconsole 新增客户机 [scm.lswin.cn](http://scm.lswin.cn)（这是示例用Ubuntu客户机）

```
root@bareos:~# bconsole
Connecting to Director localhost:9101
1000 OK: bareos-dir Version: 17.2.4 (21 Sep 2017)
Enter a period to cancel a command.
*
You have messages.
*configure add client name=scm-fd address=scm.lswin.cn password=scmFdPass
Exported resource file "/etc/bareos/bareos-dir-export/client/scm-fd/bareos-fd.d/director/bareos-dir.conf":
Director {
  Name = bareos-dir
  Password = "[md5]94d9e38bace980feecc1be983f379823"
}
Created resource config file "/etc/bareos/bareos-dir.d/client/scm-fd.conf":
Client {
  Name = scm-fd
  Address = scm.lswin.cn
  Password = scmFdPass
}
*
```

再新增客户机 [lswin7-1.lswin.cn](http://lswin7-1.lswin.cn)（这是示例用Windows客户机）

```
root@bareos:~# bconsole
Connecting to Director localhost:9101
1000 OK: bareos-dir Version: 17.2.4 (21 Sep 2017)
Enter a period to cancel a command.
*
You have messages.
*configure add client name=lswin7-1-fd address=lswin7-1.lswin.cn password=lswin7-1FdPass
Exported resource file "/etc/bareos/bareos-dir-export/client/lswin7-1-fd/bareos-fd.d/director/bareos-dir.conf":
Director {
  Name = bareos-dir
  Password = "[md5]c25dfe0e029bfcebc4feb30c0d68f857"
}
Created resource config file "/etc/bareos/bareos-dir.d/client/lswin7-1-fd.conf":
Client {
  Name = lswin7-1-fd
  Address = lswin7-1.lswin.cn
  Password = lswin7-1FdPass
}
*
12345678910111213141516171819
```

新增客户机配置后，需要重启Director，否则新增的客户机不会出现在客户机列表中。

***二、在Ubuntu客户机上安装bareos-fd软件包。***

*添加 Bareos 库的APT健*

```
root@scm:~#
root@scm:~# wget -q http://download.bareos.org/bareos/release/latest/Debian_9.0/Release.key -O- | apt-key add -
OK
root@scm:~#
1234
```

*添加 Bareos 库定义（/etc/apt/sources.list.d/bareos.list）*

```
 deb http://download.bareos.org/bareos/release/latest/Debian_9.0 /
1
```

*更新 APT 库*

```
root@scm:~# apt update
1
```

*在Ubuntu安装 bareos-fd软件包*

```
root@scm:~# apt install bareos-filedaemon
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  bareos-common libfastlz libjansson4
The following NEW packages will be installed:
  bareos-common bareos-filedaemon libfastlz libjansson4
0 upgraded, 4 newly installed, 0 to remove and 2 not upgraded.
Need to get 756 kB of archives.
After this operation, 2,369 kB of additional disk space will be used.
Do you want to continue? [Y/n]
Get:1 http://mirrors.aliyun.com/ubuntu bionic/main amd64 libjansson4 amd64 2.11-1 [29.3 kB]
......
......
......
Processing triggers for systemd (237-3ubuntu10.3) ...
Processing triggers for ureadahead (0.100.0-20) ...
root@scm:~#
12345678910111213141516171819
```

然后将Director机器上的`/etc/bareos/bareos-dir-export/client/scm-fd/bareos-fd.d/director/bareos-dir.conf`文件复制到本地，文件为`/etc/bareos/bareos-fd.d`。复制完成后需重启Bareos 的 FileDaemon，否则新的配置不会取作用。

***三、在Windows客户机上安装bareos-fd软件包。***

软件包下载地址：
 [64位Bareos File Daemon软件包](http://download.bareos.org/bareos/release/latest/windows/winbareos-17.2.4-postvista-64-bit-r8.1.exe)
 [32位Bareos File Daemon软件包](http://download.bareos.org/bareos/release/latest/windows/winbareos-17.2.4-postvista-32-bit-r8.1.exe)

安装Bareos File Daemon
 ![在这里插入图片描述](https://img-blog.csdn.net/20181004194501412?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xhb3RvdTE5NjM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

![在这里插入图片描述](https://img-blog.csdn.net/20181004194634517?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xhb3RvdTE5NjM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
 ![在这里插入图片描述](https://img-blog.csdn.net/2018100419473766?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xhb3RvdTE5NjM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
 ![在这里插入图片描述](https://img-blog.csdn.net/20181004194813891?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xhb3RvdTE5NjM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
 ![在这里插入图片描述](https://img-blog.csdn.net/20181004195341920?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xhb3RvdTE5NjM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

将Director机器上文件`/etc/bareos# /etc/bareos/bareos-dir-export/client/lswin7-1-fd/bareos-fd.d/director/bareos-dir.conf`中的Password复制到Password中；再将`/etc/bareos/bareos-dir.d/bareos-dir.d/console/bareos-mon.conf`文件中的Password复制到`Client Monitor Password`中。如不需要Monitor，可忽略复制`Client Monitor Password`这一步。

后面的只需要按提示进行直到完成即可。

到此为止Bareos的Director，Storage和Client都已经配置完成，可以使用了。

------

## **Bareos系统测试**

在此我们使用bconsole对已配置的Bareos系统进行测试。

***检查安装的版本***

```
root@bareos:~# bconsole
Connecting to Director localhost:9101
1000 OK: bareos-dir Version: 17.2.4 (21 Sep 2017)
Enter a period to cancel a command.
*version
bareos-dir Version: 17.2.4 (21 Sep 2017) x86_64-pc-linux-gnu debian Debian GNU/Linux 9.3 (stretch) Debian_9.0 x86_64
*
```

安装的bareos-dir版本是 17.2.4 的 Debian_9.0版，ubuntu 18.04是基于Debian_9.0。

***检查配置的客户机***

```
*show client
Client {
  Name = "scm-fd"
  Address = "scm.lswin.cn"
  Password = "[md5]94d9e38bace980feecc1be983f379823"
  Catalog = "MyCatalog"
}

Client {
  Name = "lswin7-1-fd"
  Address = "lswin7-1.lswin.cn"
  Password = "[md5]c25dfe0e029bfcebc4feb30c0d68f857"
  Catalog = "MyCatalog"
}

Client {
  Name = "bareos-fd"
  Description = "Client resource of the Director itself."
  Address = "localhost"
  Password = "[md5]33e11c4e5a631bf5620f66e4b4e18e76"
  Catalog = "MyCatalog"
}

*
```

***测试备份任务（backup-test-on-bareos-fd）***

```
*
*run
A job name must be specified.
The defined Job resources are:
     1: RestoreFiles
     2: backup-test-on-bareos-fd
     3: BackupCatalog
     4: backup-bareos-fd
Select Job resource (1-4): 2
Run Backup job
JobName:  backup-test-on-bareos-fd
Level:    Incremental
Client:   bareos-fd
Format:   Native
FileSet:  TestSet
Pool:     Incremental (From Job IncPool override)
Storage:  File (From Job resource)
When:     2018-10-04 18:39:17
Priority: 10
OK to run? (yes/mod/no): mod
Parameters to modify:
     1: Level
     2: Storage
     3: Job
     4: FileSet
     5: Client
     6: Backup Format
     7: When
     8: Priority
     9: Pool
    10: Plugin Options
Select parameter to modify (1-10): 1
Levels:
     1: Full
     2: Incremental
     3: Differential
     4: Since
     5: VirtualFull
Select level (1-5): 1
Run Backup job
JobName:  backup-test-on-bareos-fd
Level:    Full
Client:   bareos-fd
Format:   Native
FileSet:  TestSet
Pool:     Full (From Job FullPool override)
Storage:  File (From Job resource)
When:     2018-10-04 18:39:17
Priority: 10
OK to run? (yes/mod/no): mod
Parameters to modify:
     1: Level
     2: Storage
     3: Job
     4: FileSet
     5: Client
     6: Backup Format
     7: When
     8: Priority
     9: Pool
    10: Plugin Options
Select parameter to modify (1-10): 5
The defined Client resources are:
     1: scm-fd
     2: bareos-fd
Select Client (File daemon) resource (1-3): 1
Run Backup job
JobName:  backup-test-on-bareos-fd
Level:    Full
Client:   scm-fd
Format:   Native
FileSet:  TestSet
Pool:     Full (From Job FullPool override)
Storage:  File (From Job resource)
When:     2018-10-04 18:39:17
Priority: 10
OK to run? (yes/mod/no):
Job queued. JobId=13
*status
Status available for:
     1: Director
     2: Storage
     3: Client
     4: Scheduler
     5: All
Select daemon type for status (1-5): 1
bareos-dir Version: 17.2.4 (21 Sep 2017) x86_64-pc-linux-gnu debian Debian GNU/Linux 9.3 (stretch)
Daemon started 04-Oct-18 18:03. Jobs: run=2, running=0 mode=0 db=mysql
 Heap: heap=409,600 smbytes=260,292 max_bytes=302,389 bufs=1,044 max_bufs=1,458

Scheduled Jobs:
Level          Type     Pri  Scheduled          Name               Volume
===================================================================================
Incremental    Backup    10  04-Oct-18 21:00    backup-test-on-bareos-fd Incremental-0002
Incremental    Backup    10  04-Oct-18 21:00    backup-bareos-fd   Incremental-0002
Full           Backup    11  04-Oct-18 21:10    BackupCatalog      Incremental-0002
====

Running Jobs:
Console connected at 04-Oct-18 18:32
No Jobs running.
====

Terminated Jobs:
 JobId  Level    Files      Bytes   Status   Finished        Name
====================================================================
     4  Incr          0         0   OK       20-Sep-18 21:00 backup-bareos-fd
     5  Full         62    84.23 K  OK       20-Sep-18 21:10 BackupCatalog
     6  Incr          0         0   OK       24-Sep-18 21:00 backup-bareos-fd
     7  Full         67    96.19 K  OK       24-Sep-18 21:10 BackupCatalog
    10  Full        202    32.57 M  OK       03-Oct-18 15:08 backup-test-on-bareos-fd
    11                1    83.58 K  OK       03-Oct-18 15:17 RestoreFiles
    13  Full        175    30.33 M  OK       04-Oct-18 18:40 backup-test-on-bareos-fd


Client Initiated Connections (waiting for jobs):
Connect time        Protocol            Authenticated       Name                                    
====================================================================================================
====
You have messages.
*messages
04-Oct 18:40 bareos-dir JobId 13: Start Backup JobId 13, Job=backup-test-on-bareos-fd.2018-10-04_18.40.45_37
04-Oct 18:40 bareos-dir JobId 13: Using Device "FileStorage" to write.
04-Oct 18:40 bareos-sd JobId 13: Volume "Full-0001" previously written, moving to end of data.
04-Oct 18:40 bareos-sd JobId 13: Ready to append to end of Volume "Full-0001" size=95925221
04-Oct 18:40 bareos-sd JobId 13: Elapsed time=00:00:01, Transfer rate=30.35 M Bytes/second
04-Oct 18:40 bareos-dir JobId 13: sql_create.c:872 Insert of attributes batch table done
04-Oct 18:40 bareos-dir JobId 13: Bareos bareos-dir 17.2.4 (21Sep17):
  Build OS:               x86_64-pc-linux-gnu debian Debian GNU/Linux 9.3 (stretch)
  JobId:                  13
  Job:                    backup-test-on-bareos-fd.2018-10-04_18.40.45_37
  Backup Level:           Full
  Client:                 "scm-fd" 17.2.4 (21Sep17) x86_64-pc-linux-gnu,debian,Debian GNU/Linux 9.3 (stretch),Debian_9.0,x86_64
  FileSet:                "TestSet" 2018-10-03 15:08:15
  Pool:                   "Full" (From Job FullPool override)
  Catalog:                "MyCatalog" (From Client resource)
  Storage:                "File" (From Job resource)
  Scheduled time:         04-Oct-2018 18:39:17
  Start time:             04-Oct-2018 18:40:47
  End time:               04-Oct-2018 18:40:48
  Elapsed time:           1 sec
  Priority:               10
  FD Files Written:       175
  SD Files Written:       175
  FD Bytes Written:       30,336,281 (30.33 MB)
  SD Bytes Written:       30,354,503 (30.35 MB)
  Rate:                   30336.3 KB/s
  Software Compression:   None
  VSS:                    no
  Encryption:             no
  Accurate:               no
  Volume name(s):         Full-0001
  Volume Session Id:      2
  Volume Session Time:    1538647406
  Last Volume Bytes:      126,307,760 (126.3 MB)
  Non-fatal FD errors:    0
  SD Errors:              0
  FD termination status:  OK
  SD termination status:  OK
  Termination:            Backup OK

*
```

信息显示备份已成功完成。

***测试恢复任务（backup-test-on-bareos-fd）***

```
*restore

First you select one or more JobIds that contain files
to be restored. You will be presented several methods
of specifying the JobIds. Then you will be allowed to
select which files from those JobIds are to be restored.

To select the JobIds, you have the following choices:
     1: List last 20 Jobs run
     2: List Jobs where a given File is saved
     3: Enter list of comma separated JobIds to select
     4: Enter SQL list command
     5: Select the most recent backup for a client
     6: Select backup for a client before a specified time
     7: Enter a list of files to restore
     8: Enter a list of files to restore before a specified time
     9: Find the JobIds of the most recent backup for a client
    10: Find the JobIds for a backup for a client before a specified time
    11: Enter a list of directories to restore for found JobIds
    12: Select full restore to a specified Job date
    13: Cancel
Select item:  (1-13): 5
Defined Clients:
     1: bareos-fd
     2: scm-fd
Select the Client (1-3): 3
Automatically selected FileSet: TestSet
+-------+-------+----------+------------+---------------------+------------+
| JobId | Level | JobFiles | JobBytes   | StartTime           | VolumeName |
+-------+-------+----------+------------+---------------------+------------+
|    13 | F     |      175 | 30,336,281 | 2018-10-04 18:40:47 | Full-0001  |
+-------+-------+----------+------------+---------------------+------------+
You have selected the following JobId: 13

Building directory tree for JobId(s) 13 ...  +++++++++++++++++++++++++++++++++++++++++++
174 files inserted into the tree.

You are now entering file selection mode where you add (mark) and
remove (unmark) files to be restored. No files are initially added, unless
you used the "all" keyword on the command line.
Enter "done" to leave this mode.

cwd is: /
$
$ ls
usr/
$ mark usr
175 files marked.
$ done
Bootstrap records written to /var/lib/bareos/bareos-dir.restore.1.bsr

The job will require the following
   Volume(s)                 Storage(s)                SD Device(s)
===========================================================================

    Full-0001                 File                      FileStorage              

Volumes marked with "*" are online.

175 files selected to be restored.

Run Restore job
JobName:         RestoreFiles
Bootstrap:       /var/lib/bareos/bareos-dir.restore.1.bsr
Where:           /tmp/bareos-restores
Replace:         Always
FileSet:         LinuxAll
Backup Client:   scm-fd
Restore Client:  scm-fd
Format:          Native
Storage:         File
When:            2018-10-04 18:56:40
Catalog:         MyCatalog
Priority:        10
Plugin Options:  *None*
OK to run? (yes/mod/no):
Job queued. JobId=16
*status
Status available for:
     1: Director
     2: Storage
     3: Client
     4: Scheduler
     5: All
Select daemon type for status (1-5): 1
bareos-dir Version: 17.2.4 (21 Sep 2017) x86_64-pc-linux-gnu debian Debian GNU/Linux 9.3 (stretch)
Daemon started 04-Oct-18 18:03. Jobs: run=5, running=0 mode=0 db=mysql
 Heap: heap=311,296 smbytes=535,619 max_bytes=836,693 bufs=1,209 max_bufs=1,792

Scheduled Jobs:
Level          Type     Pri  Scheduled          Name               Volume
===================================================================================
Incremental    Backup    10  04-Oct-18 21:00    backup-test-on-bareos-fd Incremental-0002
Incremental    Backup    10  04-Oct-18 21:00    backup-bareos-fd   Incremental-0002
Full           Backup    11  04-Oct-18 21:10    BackupCatalog      Incremental-0002
====

Running Jobs:
Console connected at 04-Oct-18 18:32
No Jobs running.
====

Terminated Jobs:
 JobId  Level    Files      Bytes   Status   Finished        Name
====================================================================
     7  Full         67    96.19 K  OK       24-Sep-18 21:10 BackupCatalog
    10  Full        202    32.57 M  OK       03-Oct-18 15:08 backup-test-on-bareos-fd
    11                1    83.58 K  OK       03-Oct-18 15:17 RestoreFiles
    13  Full        175    30.33 M  OK       04-Oct-18 18:40 backup-test-on-bareos-fd
    16              175    30.33 M  OK       04-Oct-18 18:56 RestoreFiles


Client Initiated Connections (waiting for jobs):
Connect time        Protocol            Authenticated       Name                                    
====================================================================================================
====
You have messages.
*
*messages
04-Oct 18:56 bareos-dir JobId 16: Start Restore Job RestoreFiles.2018-10-04_18.56.47_55
04-Oct 18:56 bareos-dir JobId 16: Using Device "FileStorage" to read.
04-Oct 18:56 bareos-sd JobId 16: Ready to read from volume "Full-0001" on device "FileStorage" (/var/lib/bareos/storage).
04-Oct 18:56 bareos-sd JobId 16: Forward spacing Volume "Full-0001" to file:block 0:95925221.
04-Oct 18:56 bareos-sd JobId 16: End of Volume at file 0 on device "FileStorage" (/var/lib/bareos/storage), Volume "Full-0001"
04-Oct 18:56 bareos-sd JobId 16: End of all volumes.
04-Oct 18:56 bareos-dir JobId 16: Bareos bareos-dir 17.2.4 (21Sep17):
  Build OS:               x86_64-pc-linux-gnu debian Debian GNU/Linux 9.3 (stretch)
  JobId:                  16
  Job:                    RestoreFiles.2018-10-04_18.56.47_55
  Restore Client:         scm-fd
  Start time:             04-Oct-2018 18:56:49
  End time:               04-Oct-2018 18:56:49
  Elapsed time:           0 secs
  Files Expected:         175
  Files Restored:         175
  Bytes Restored:         30,336,281
  Rate:                   0.0 KB/s
  FD Errors:              0
  FD termination status:  OK
  SD termination status:  OK
  Termination:            Restore OK

*

```

信息显示文件恢复已成功完成。

***测试备份Windows电脑（backup-test-on-bareos-fd）***

```
root@bareos:~#
root@bareos:~# bconsole
Connecting to Director localhost:9101
1000 OK: bareos-dir Version: 17.2.4 (21 Sep 2017)
Enter a period to cancel a command.
*run
Automatically selected Catalog: MyCatalog
Using Catalog "MyCatalog"
A job name must be specified.
The defined Job resources are:
     1: RestoreFiles
     2: backup-test-on-bareos-fd
     3: BackupCatalog
     4: backup-bareos-fd
Select Job resource (1-4): 2
Run Backup job
JobName:  backup-test-on-bareos-fd
Level:    Incremental
Client:   bareos-fd
Format:   Native
FileSet:  TestSet
Pool:     Incremental (From Job IncPool override)
Storage:  File (From Job resource)
When:     2018-10-05 10:39:59
Priority: 10
OK to run? (yes/mod/no): mod
Parameters to modify:
     1: Level
     2: Storage
     3: Job
     4: FileSet
     5: Client
     6: Backup Format
     7: When
     8: Priority
     9: Pool
    10: Plugin Options
Select parameter to modify (1-10): 1
Levels:
     1: Full
     2: Incremental
     3: Differential
     4: Since
     5: VirtualFull
Select level (1-5): 1
Run Backup job
JobName:  backup-test-on-bareos-fd
Level:    Full
Client:   bareos-fd
Format:   Native
FileSet:  TestSet
Pool:     Full (From Job FullPool override)
Storage:  File (From Job resource)
When:     2018-10-05 10:39:59
Priority: 10
OK to run? (yes/mod/no): mod
Parameters to modify:
     1: Level
     2: Storage
     3: Job
     4: FileSet
     5: Client
     6: Backup Format
     7: When
     8: Priority
     9: Pool
    10: Plugin Options
Select parameter to modify (1-10): 5
The defined Client resources are:
     1: scm-fd
     2: lswin7-1-fd
     3: lscms-fd
     4: bareos-fd
Select Client (File daemon) resource (1-4): 2
Run Backup job
JobName:  backup-test-on-bareos-fd
Level:    Full
Client:   lswin7-1-fd
Format:   Native
FileSet:  TestSet
Pool:     Full (From Job FullPool override)
Storage:  File (From Job resource)
When:     2018-10-05 10:39:59
Priority: 10
OK to run? (yes/mod/no): mod
Parameters to modify:
     1: Level
     2: Storage
     3: Job
     4: FileSet
     5: Client
     6: Backup Format
     7: When
     8: Priority
     9: Pool
    10: Plugin Options
Select parameter to modify (1-10): 4
The defined FileSet resources are:
     1: Windows Test Fileset
     2: Windows All Drives
     3: TestSet
     4: SelfTest
     5: LinuxAll
     6: Catalog
Select FileSet resource (1-6): 1
Run Backup job
JobName:  backup-test-on-bareos-fd
Level:    Full
Client:   lswin7-1-fd
Format:   Native
FileSet:  Windows Test Fileset
Pool:     Full (From Job FullPool override)
Storage:  File (From Job resource)
When:     2018-10-05 10:39:59
Priority: 10
OK to run? (yes/mod/no):
Job queued. JobId=19
You have messages.
*messages
05-Oct 10:18 bareos-dir JobId 19: Start Backup JobId 18, Job=backup-test-on-bareos-fd.2018-10-05_10.18.57_06
05-Oct 10:18 bareos-dir JobId 19: Using Device "FileStorage" to write.
05-Oct 10:18 bareos-sd JobId 19: Volume "Full-0001" previously written, moving to end of data.
05-Oct 10:18 bareos-sd JobId 19: Ready to append to end of Volume "Full-0001" size=126308232
05-Oct 10:18 lswin7-1-fd JobId 19: Created 28 wildcard excludes from FilesNotToBackup Registry key
05-Oct 10:19 lswin7-1-fd JobId 19: Generate VSS snapshots. Driver="Win64 VSS", Drive(s)="C"
05-Oct 10:19 lswin7-1-fd JobId 19: VolumeMountpoints are not processed as onefs = yes.
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "Task Scheduler Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "VSS Metadata Store Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "Performance Counters Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "System Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "ASR Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "Registry Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "Shadow Copy Optimization Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "BITS Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "COM+ REGDB Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "WMI Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 lswin7-1-fd JobId 19: VSS Writer (BackupComplete): "MSSearch Service Writer", State: 0x1 (VSS_WS_STABLE)
05-Oct 10:19 bareos-sd JobId 19: Elapsed time=00:00:18, Transfer rate=2.182 M Bytes/second
05-Oct 10:19 bareos-dir JobId 19: sql_create.c:872 Insert of attributes batch table done
05-Oct 10:19 bareos-dir JobId 19: Bareos bareos-dir 17.2.4 (21Sep17):
  Build OS:               x86_64-pc-linux-gnu debian Debian GNU/Linux 9.3 (stretch)
  JobId:                  19
  Job:                    backup-test-on-bareos-fd.2018-10-05_10.18.57_06
  Backup Level:           Full
  Client:                 "lswin7-1-fd" 17.2.4 (21Sep17) Microsoft Windows 7 Ultimate Edition Service Pack 1 (build 7601), 64-bit,Cross-compile,Win64
  FileSet:                "Windows Test Fileset" 2018-10-05 10:18:57
  Pool:                   "Full" (From command line)
  Catalog:                "MyCatalog" (From Client resource)
  Storage:                "File" (From Job resource)
  Scheduled time:         05-Oct-2018 10:18:57
  Start time:             05-Oct-2018 10:18:59
  End time:               05-Oct-2018 10:19:17
  Elapsed time:           18 secs
  Priority:               10
  FD Files Written:       6
  SD Files Written:       6
  FD Bytes Written:       39,284,012 (39.28 MB)
  SD Bytes Written:       39,285,181 (39.28 MB)
  Rate:                   2182.4 KB/s
  Software Compression:   None
  VSS:                    yes
  Encryption:             no
  Accurate:               no
  Volume name(s):         Full-0001
  Volume Session Id:      2
  Volume Session Time:    1538702289
  Last Volume Bytes:      165,623,141 (165.6 MB)
  Non-fatal FD errors:    0
  SD Errors:              0
  FD termination status:  OK
  SD termination status:  OK
  Termination:            Backup OK

*
```

备份Windows电脑已成功备份。



## 为Bareos配置外部SMTP邮件服务器

Bareos可以用电子邮件将有关信息发送到邮箱，并提供了bsmtp邮件发送工具。bsmtp工具很简单，并不适用一般中小微企业情况。



### 安装配置postfix服务



#### 安装Postfix

```shell
root@bareos:~# apt install libsasl2-modules postfix mailutils
Reading package lists... Done
Building dependency tree       
Reading state information... Done
libsasl2-modules is already the newest version (2.1.27~101-g0780600+dfsg-3ubuntu2).
The following additional packages will be installed:
  guile-2.0-libs libgc1c2 libgsasl7 libkyotocabinet16v5 libltdl7 libmailutils5 libmysqlclient20 libntlm0 libpython2.7 libpython2.7-minimal
  libpython2.7-stdlib mailutils-common mysql-common ssl-cert
Suggested packages:
  mailutils-mh mailutils-doc procmail postfix-mysql postfix-pgsql postfix-ldap postfix-pcre postfix-lmdb postfix-sqlite sasl2-bin
  dovecot-common resolvconf postfix-cdb postfix-doc openssl-blacklist
The following NEW packages will be installed:
  guile-2.0-libs libgc1c2 libgsasl7 libkyotocabinet16v5 libltdl7 libmailutils5 libmysqlclient20 libntlm0 libpython2.7 libpython2.7-minimal
  libpython2.7-stdlib mailutils mailutils-common mysql-common postfix ssl-cert
0 upgraded, 16 newly installed, 0 to remove and 0 not upgraded.
Need to get 8,916 kB of archives.
After this operation, 43.1 MB of additional disk space will be used.
Do you want to continue? [Y/n]
......
......
......
Processing triggers for systemd (237-3ubuntu10.3) ...
Processing triggers for ureadahead (0.100.0-20) ...
Processing triggers for rsyslog (8.32.0-1ubuntu4) ...
Processing triggers for ufw (0.35-5) ...
root@bareos:~#
```

当询问邮件设置类型时，暂时选择“No configuration”，我们将在后面手工配置。

![这里写图片描述](https://img-blog.csdn.net/20180915175825514?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xhb3RvdTE5NjM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)



#### 配置postfix

现在的SMTP服务，一般都会有严格的安全控制，包括QQ邮箱、阿里邮箱。如以前经常使用的方式：以account1授权发送邮件，在邮件头使用From：account2或Reply-to：account3的方式来说明不同的邮件来源，现在已不可行，account2和account3都必须独立验证授权。为此，我们需要为postfix配置三个文件，分别是`main.cf`、`sasl_passwd`和`sender_relay`。


**配置 [main.cf](http://main.cf)**

**`/etc/postfix/main.cf`**

```bash
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Bareos)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

readme_directory = no

# See http://www.postfix.org/COMPATIBILITY_README.html -- default to 2 on
# fresh installs.
compatibility_level = 2

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = lswin.cn
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = localhost
mynetworks = localhost
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = ipv4
smtputf8_enable = no
# 使用TLS
smtp_use_tls = yes
# 启用SASL授权
smtp_sasl_auth_enable = yes
smtp_sasl_security_options = noanonymous
smtp_sender_dependent_authentication = yes
# accounts独立授权
sender_dependent_relayhost_maps = hash:/etc/postfix/sender_relay
# accounts信息
smtp_sasl_password_maps = hash:/etc/postfix/sasl/sasl_passwd
smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt
```



**配置 sasl_passwd**

**`/etc/postfix/sasl/sasl_passwd`**

```shell
admin@lswin.cn admin@lswin.cn:admin-passwd
bareos@lswin.cn bareos@lswin.cn:bareos-passwd

[smtp.mxhichina.com]:587 admin@lswin.cn:admin-passwd
1234
```

因sasl_passwd含有明码密码，我们需要修改它的属性为600（只有root能读写）
 最后产生hash文件（sasl_passwd.db)

```shell
root@bareos:~# chmod 600 /etc/postfix/sasl/sasl_passwd
root@bareos:~# postmap /etc/postfix/sasl/sasl_passwd
12
```



**配置 sender_relay**

**`/etc/postfix/sender_relay`**

```shell
admin@lswin.cn [smtp.mxhichina.com]:587
bareos@lswin.cn [smtp.mxhichina.com]:587
12
```

该文件也需要hash。

```shell
root@bareos:~# postmap /etc/postfix/sender_reply
1
```

文件中邮件账号的密码在sasl_passwd中。


**配置 mailname**

将下列行加入/etc/mailname文件

```
lswin.cn
1
```

[这个文件指明邮件域名是lswin.cn](http://xn--lswin-mn1hs1ca148iosjt35anjghxbknv472cs1c.cn)。

***注意：这里使用的 [lswin.cn](http://lswin.cn) 和 邮件账号都是虚拟的，您必须使用真实的邮件域名和相对应的邮件账号。***


**检查postfix**

至此，postfix已设置安装完成，需要重启postfix服务，然后再检查postfix是否正常运行。

```shell
root@bareos:~#
root@bareos:~# systemctl status postfix
● postfix.service - Postfix Mail Transport Agent
   Loaded: loaded (/lib/systemd/system/postfix.service; enabled; vendor preset: enabled)
   Active: active (exited) since Sat 2018-09-15 20:04:04 CST; 12s ago
  Process: 5713 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
 Main PID: 5713 (code=exited, status=0/SUCCESS)

Sep 15 20:04:04 bareos systemd[1]: Starting Postfix Mail Transport Agent...
Sep 15 20:04:04 bareos systemd[1]: Started Postfix Mail Transport Agent.
root@bareos:~#


```

如您能见到类似上面的结果，说明postfix运行正常。



#### 检查邮件发送

```shell
root@bareos:~# echo “This is a test email body.” | mail -s "Subject: BAREOS相关提示！" s.zhang@lswin.cn
1
```

这里我们没有指定发送者，邮件客户端会自动使用当前用户（root）@本地domain（[lscm.lswin.cn](http://lscm.lswin.cn)）作为发送者，授权使用admin@lswin.cn（在sasl_passwd中配置的默认值）。

下面是/var/log/mail.log中显示的信息：

```shell
Sep 15 20:07:33 bareos postfix/pickup[5711]: 715DE41696: uid=0 from=<root@bareos.lswin.cn>
Sep 15 20:07:33 bareos postfix/cleanup[5755]: 715DE41696: message-id=<20180915120733.715DE41696@lswin.cn>
Sep 15 20:07:33 bareos postfix/qmgr[5712]: 715DE41696: from=<root@bareos.lswin.cn>, size=381, nrcpt=1 (queue active)
Sep 15 20:07:33 bareos postfix/smtp[5748]: 715DE41696: host smtp.mxhichina.com[42.120.219.29] said: 440 mail from account doesn't conform with authentication (Auth Account:admin@lswin.cn|Mail Account:root@bareos.lswin.cn) (in reply to MAIL FROM command)
1234
```

我们可以清楚看到出错原因：发送用的账号（admin@lswin.cn）和发送者账号（root@bareos.lswin.cn）不符，已被拒绝（错误码：440）。

```
root@bareos:~# echo “This is a test email body.” | mail -s "Subject: BAREOS相关提示！" -r admin@lswin.cn s.zhang@lswin.cn
1
```

这里我们指定Reply-to为admin@lswin.cn（-r admin@lswin.cn），postfix根据sasl_passwd和sender_relay中的配置，选择正确的用户信息来发送邮件。

下面是/var/log/mail.log中显示的信息：

```shell
Sep 15 20:25:05 bareos postfix/pickup[5711]: ACBD541698: uid=0 from=<admin@lswin.cn>
Sep 15 20:25:05 bareos postfix/cleanup[5784]: ACBD541698: message-id=<20180915122505.ACBD541698@lswin.cn>
Sep 15 20:25:05 bareos postfix/qmgr[5712]: ACBD541698: from=<admin@lswin.cn>, size=373, nrcpt=1 (queue active)
Sep 15 20:25:35 bareos postfix/smtp[5786]: connect to smtp.mxhichina.com[42.120.226.4]:587: Connection timed out
Sep 15 20:25:36 bareos postfix/smtp[5786]: ACBD541698: to=<s.zhang@lswin.cn>, relay=smtp.mxhichina.com[42.120.219.29]:587, delay=31, delays=0.02/0.01/30/0.23, dsn=2.0.0, status=sent (250 Data Ok: queued as freedom)
Sep 15 20:25:36 bareospostfix/qmgr[5712]: ACBD541698: removed
123456
```

当您看到类似上面的结果，邮件发送请求已被SMTP服务器接受。到此，Postfix安装/配置已完成。



### 修改Director邮件发送命令

在Director的信息配置中，发送邮件使用的bsmtp，由于bsmtp的局限性，无法使用一般外部商业SMTP服务，我们必须对此进行修改。在示例中，我们对`/etc/bareos/bareos-dir.d/message/Standard.conf`做修改，您可以参照示例，对其他的邮件发送配置做对应的修改。

在配置文件中的邮件命令为：

```
mailcommand = "/usr/bin/bsmtp -h localhost -f \"\(Bareos\) \<%r\>\" -s \"Bareos: %t %e of %c %l\" %r"
1
```

默认使用BSMTP发送邮件。我们将其修改为：

```
mailcommand = "/usr/local/bin/sendmail -c %c -d %d -e %e -h %h -i %i -j %j -n %n -r %r -t %t -s \"%s\"  -l %l -v \"%v\" -V \"%V\%"
1
```

`/user/local/bin/sendmail` 是我们自定义的发送邮件脚本程序。
 以`%`开头的是在Bareos中可用的参数，我们把所有可用参数全部传递到脚本程序。%s、%v和%V用" "包起来的原因是，这些参数有可能为空，如不把它们包起来，当它们为空时，会造成参数处理问题。

```bash
#!/bin/bash
# available mailcommand parameters
# %% = %
# %c = Client’s name
# %d = Director’s name
# %e = Job Exit code (OK, Error, ...)
# %h = Client address
# %i = Job Id
# %j = Unique Job name
# %l = Job level
# %n = Job name
# %r = Recipients
# %s = Since time
# %t = Job type (e.g. Backup, ...)
# %v = Read Volume name (Only on director side)
# %V = Write Volume name (Only on director side)

bareos_admin="admin@lswin.cn"
mail_receiver="s.zhang@lswin.cn"

# get input opts
while getopts ":c:d:e:h:i:j:l:n:r:s:t:v:V:" o; do
  case "${o}" in
    c)
       client_name=${OPTARG}
       ;;
    d)
       director_name=${OPTARG}
       ;;
    e)
       job_exit_code=${OPTARG}
       ;;
    h)
       client_address=${OPTARG}
       ;;
    i)
       job_id=${OPTARG}
       ;;
    j)
       unique_job_name=${OPTARG}
       ;;
    l)
       job_level=${OPTARG}
       ;;
    n)
       job_name=${OPTARG}
       ;;
    r)
       recipients=${OPTARG}
       ;;
    s)
       since_time=${OPTARG}
       ;;
    t)
       job_type=${OPTARG}
       ;;
    v)
       read_volume_name=${OPTARG}
       ;;
    V)
       write_volume_name=${OPTARG}
       ;;
    *)
       ;;
    esac
done

# 建立邮件 Subject
ubject="BAREOS任务执行"
if [[ "$job_exit_code" == "OK" ]]
then
  Subject=$Subject"完成通知"
else
  Subject=$Subject"失败通知！"
fi

# 建立邮件内容
Content="\"任务 "$job_name" 执行简况:\n 任务ID："$job_id"\n 任务名字："$unique_job_name"\n 任务类型："$job_type
if [[ ! -z "$job_level" && "$job_type" == "Backup" ]]; then Content=$Content"\n 备份级别："$job_level; fi
Content=$Content"\n 完成情况："$job_exit_code"\n 主控端名字："$director_name"\n 客户端名字："$client_name"\n 客户端地址："$client_address
if [[ ! -z "$read_volume_name" && "$job_type" == "RestoreFiles" ]]; then Content=$Content"\n 读取卷名字："$read_volume_name; fi
if [[ ! -z "$write_volume_name" && "$job_type" == "Backup" ]]; then Content=$Content"\n 写入卷名字："$write_volume_name; fi
Content=$Content"\""

# 建立邮件发送命令
cmd="echo -e $Content | /usr/bin/mail -s \"Subject: $Subject\" -r $bareos_admin $mail_receiver"

# 执行邮件发送命令
eval $cmd

exit 0
```

然后修改`/usr/local/bin/sendmail`属性，将其改为可执行。

```shell
root@bareos:~# chmod + x /usr/local/bin/sendmail
1
```

最后重启Bareos，为Bareos配置外部SMTP（阿里企业邮箱）在重启后即可正常工作。



### 邮件示例

下面是几个Bareos在备份/恢复成功或失败后发送的邮件示例。

**备份成功邮件**

```shell
Subject: BAREOS任务执行完成通知

发件人：admin <admin@lswin.cn>    	
时   间：2018年10月18日(星期四) 上午10:26	纯文本 |  
收件人：
S Zhang<s.zhang@lswin.cn>
任务 backup-bareos-fd 执行简况:
 任务ID：52
 任务名字：backup-bareos-fd.2018-10-18_10.26.39_12
 任务类型：Backup
 备份级别：Full
 完成情况：OK
 主控端名字：bareos-dir
 客户端名字：bareos-fd
 客户端地址：localhost
 写入卷名字：Full-0001
```



**备份失败邮件**

```shell
Subject: BAREOS任务执行失败通知！

发件人：admin <admin@lswin.cn>    	
时   间：2018年10月18日(星期四) 上午10:45	纯文本 |  
收件人：
S Zhang<s.zhang@lswin.cn>
任务 backup-test-on-bareos-fd 执行简况:
 任务ID：53
 任务名字：backup-test-on-bareos-fd.2018-10-18_10.42.13_17
 任务类型：Backup
 备份级别：Full
 完成情况：Error
 主控端名字：bareos-dir
 客户端名字：lscms-fd
 客户端地址：lscms.lswin.cn
```



**恢复成功邮件**

```shell
Subject: BAREOS任务执行完成通知

发件人：admin <admin@lswin.cn>    	
时   间：2018年10月18日(星期四) 上午10:45	纯文本 |  
收件人：
S Zhang <s.zhang@lswin.cn>
任务 RestoreFiles 执行简况:
 任务ID：54
 任务名字：RestoreFiles.2018-10-18_10.43.18_37
 任务类型：Restore
 完成情况：OK
 主控端名字：bareos-dir
 客户端名字：bareos-fd
 客户端地址：localhos
```



**恢复失败邮件**

Subject: BAREOS任务执行失败通知！

发件人：admin <admin@lswin.cn>    	
时   间：2018年10月18日(星期四) 上午10:45	纯文本 |  
收件人：
S Zhang<s.zhang@lswin.cn>
任务 RestoreFiles 执行简况:
 任务ID：55
 任务名字：RestoreFiles.2018-10-18_10.44.20_01
 任务类型：Restore
 完成情况：Error
 主控端名字：bareos-dir
 客户端名字：lswin7-1-fd
 客户端地址：lswin7-1.lswin.cn