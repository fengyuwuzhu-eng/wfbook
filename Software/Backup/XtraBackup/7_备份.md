# 备份

[]

## 完整备份

# Create a full backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-full-backup.html#create-a-full-backup) 创建完整备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-full-backup.html#create-a-full-backup)

To create a backup, run xtrabackup with the `--backup` option. You also must specify the `--target-dir` option, which is where the backup is stored. If the InnoDB data or log files are not stored in the same directory, you must specify their location. If the target directory does not exist, xtrabackup creates it. If the directory does exist and is empty, xtrabackup succeeds.
要创建备份，请使用 `--backup` 选项运行 xtrabackup。您还必须指定 `--target-dir` 选项，这是存储备份的位置。如果 InnoDB 数据或日志文件未存储在同一目录中，则必须指定它们的位置。如果目标目录不存在，则 xtrabackup 将创建该目录。如果目录存在且为空，则 xtrabackup 成功。

xtrabackup does not overwrite existing files. It will fail with operating system error 17, `file exists`.
xtrabackup 不会覆盖现有文件。它将失败，并显示操作系统错误 17，`文件存在`。

The following command starts the process:
以下命令将启动该进程：

```
$ xtrabackup --backup --target-dir=/data/backups/
```

This operation stores the backup at `/data/backups/`. If you specify a relative path, the target directory is relative to the current directory.
此操作将备份存储在 `/data/backups/` 中。如果指定相对路径，则目标目录是相对于当前目录的。

During the backup process, the output shows the copied data files, and a log file thread that scans and copies from the log files.
在备份过程中，输出显示复制的数据文件，以及扫描和复制日志文件的日志文件线程。

The following is an example of the output:
以下是输出的示例：

<details class="example" data-immersive-translate-walked="c1a5c94d-413d-4ed7-a976-d81398f4bba1"><summary data-immersive-translate-walked="c1a5c94d-413d-4ed7-a976-d81398f4bba1" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="c1a5c94d-413d-4ed7-a976-d81398f4bba1"><pre><span></span><code></code></pre></div></details>

The process ends with the following statement; the value of the `<LSN>` depends on your system:
该过程以以下语句结束;`<LSN>` 的值取决于您的系统：

```
$ xtrabackup: Transaction log of lsn (<LSN>) to (<LSN>) was copied.
```

Note 注意

Log copying thread checks the transactional log every second to see if  there were any new log records written that need to be copied, but there is a chance that the log copying thread might not be able to keep up  with the amount of writes that go to the transactional logs, and will  hit an error when the log records are overwritten before they could be  read.
日志复制线程每秒检查一次事务日志，以查看是否有任何需要复制的新日志记录写入，但日志复制线程可能无法跟上进入事务日志的写入量，并且在日志记录被覆盖之前被读取时遇到错误。

After the backup is finished, the target directory will contain files such as the following, assuming you have a single InnoDB table `test.tbl1` and you are using MySQL’s innodb_file_per_table option:
备份完成后，目标目录将包含如下文件，假设您有一个 InnoDB 表 `test.tbl1` 并且您使用的是 MySQL 的 innodb_file_per_table 选项：

```
$ ls -lh /data/backups/
```

The result should look like this:
结果应如下所示：

<details class="example" data-immersive-translate-walked="c1a5c94d-413d-4ed7-a976-d81398f4bba1"><summary data-immersive-translate-walked="c1a5c94d-413d-4ed7-a976-d81398f4bba1" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="c1a5c94d-413d-4ed7-a976-d81398f4bba1"><pre><span></span><code></code></pre></div></details>

The backup can take a long time, depending on how large the database is. It is safe to cancel at any time, because xtrabackup does not modify the  database.
备份可能需要很长时间，具体取决于数据库的大小。随时取消都是安全的，因为 xtrabackup 不会修改数据库。

# Prepare a full backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-full-backup.html#prepare-a-full-backup) 准备完整备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-full-backup.html#prepare-a-full-backup)

After creating a backup with the `--backup` option, you need to prepare the backup and then [restore](https://docs.percona.com/percona-xtrabackup/8.4/restore-a-backup.html) it. Data files are not point-in-time consistent until they are prepared, because they were copied at  different times as the program ran, and they might have been changed  while this was happening.
使用 `--backup` 选项创建备份后，您需要准备备份，然后[还原](https://docs.percona.com/percona-xtrabackup/8.4/restore-a-backup.html)它。数据文件在准备好之前不是时间点一致的，因为它们是在程序运行的不同时间复制的，并且它们可能已在发生这种情况时发生更改。

If you try to start InnoDB with these data files, it will detect  corruption and stop working to avoid running on damaged data. The `--prepare` step makes the files perfectly consistent at a single instant in time, so you can run InnoDB on them.
如果您尝试使用这些数据文件启动 InnoDB，它将检测到损坏并停止工作以避免在损坏的数据上运行。`--prepare` 步骤使文件在单个时刻完全一致，因此您可以在它们上运行 InnoDB。

You can run the prepare operation on any machine; it does not need to be on the originating server or the server to which you intend to restore.  You can copy the backup to a utility server and prepare it there.
您可以在任何计算机上运行 prepare 操作;它不需要位于原始服务器或要还原到的服务器上。您可以将备份复制到实用程序服务器并在其中进行准备。

Note that Percona XtraBackup 8.4 can only prepare backups of MySQL 8.4 and Percona Server for MySQL 8.4 databases. Releases prior to 8.4 are not supported.
请注意，Percona XtraBackup 8.4 只能为 MySQL 8.4 和 Percona Server for MySQL 8.4 数据库准备备份。不支持 8.4 之前的版本。

During the prepare operation, xtrabackup boots up a kind of modified embedded  InnoDB (the libraries xtrabackup was linked against). The modifications  are necessary to disable InnoDB standard safety checks, such as  complaining about the log file not being the right size. This warning is not appropriate for working with backups. These modifications are only  for the xtrabackup binary; you do not need a modified InnoDB to use  xtrabackup for your backups.
在 prepare 操作期间，xtrabackup 会启动一种修改后的嵌入式 InnoDB（xtrabackup 链接的库）。这些修改对于禁用  InnoDB 标准安全检查是必要的，例如抱怨日志文件的大小不正确。此警告不适用于处理备份。这些修改仅适用于 xtrabackup  二进制文件;您不需要修改后的 InnoDB 即可使用 xtrabackup 进行备份。

The prepare step uses this “embedded InnoDB” to perform crash recovery on the copied data files, using the copied log file. The `prepare` step is very simple to use: you simply run xtrabackup with the `--prepare` option and tell it which directory to prepare, for example, to prepare the previously taken backup run:
准备步骤使用此“嵌入式 InnoDB”使用复制的日志文件对复制的数据文件执行崩溃恢复。`准备`步骤使用起来非常简单：你只需使用 `--prepare` 选项运行 xtrabackup 并告诉它要准备哪个目录，例如，准备之前进行的备份运行：

```
$ xtrabackup --prepare --target-dir=/data/backups/
```

When this finishes, you should see an `InnoDB shutdown` with a message such as the following, where again the value of LSN will depend on your system:
完成后，您应该会看到 `InnoDB 关闭`，并显示如下消息，其中 LSN 的值将再次取决于您的系统：

<details class="example" data-immersive-translate-walked="67189339-0d3a-450d-86e0-49638546a084"><summary data-immersive-translate-walked="67189339-0d3a-450d-86e0-49638546a084" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="67189339-0d3a-450d-86e0-49638546a084"><pre><span></span><code></code></pre></div></details>

All following prepares will not change the already prepared data files, you’ll see that output says:
以下所有准备都不会更改已经准备好的数据文件，您会看到输出显示：

<details class="example" data-immersive-translate-walked="67189339-0d3a-450d-86e0-49638546a084"><summary data-immersive-translate-walked="67189339-0d3a-450d-86e0-49638546a084" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="67189339-0d3a-450d-86e0-49638546a084"><pre><span></span><code></code></pre></div></details>

It is not recommended to interrupt xtrabackup process while preparing  backup because it may cause data files corruption and backup will become unusable. Backup validity is not guaranteed if prepare process was  interrupted.
不建议在准备备份时中断 xtrabackup 进程，因为这可能会导致数据文件损坏，备份将变得不可用。如果 prepare 过程中断，则无法保证备份有效性。

Note 注意

If you intend the backup to be the basis for further incremental backups, you should use the `--apply-log-only` option when preparing the backup, or you will not be able to apply  incremental backups to it. See the documentation on preparing  incremental backups for more details.
如果您打算将备份作为进一步增量备份的基础，则应在准备备份时使用 `--apply-log-only` 选项，否则将无法对其应用增量备份。有关更多详细信息，请参阅有关准备增量备份的文档。

## 增量备份

# 创建增量备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-incremental-backup.html#create-an-incremental-backup)

xtrabackup supports incremental backups, which means that they can copy only all  the data that has changed since the last backup.
Xtrabackup 支持增量备份，这意味着它们只能复制自上次备份以来更改的所有数据。

Note 注意

Incremental backups on the MyRocks storage engine do not determine if an earlier  full backup or incremental backup contains the same files. Percona  XtraBackup copies all the MyRocks files each time it takes a backup.
MyRocks 存储引擎上的增量备份不会确定早期的完整备份或增量备份是否包含相同的文件。Percona XtraBackup 每次备份时都会复制所有 MyRocks 文件。

You can perform many incremental backups between each full backup, so you  can set up a backup process such as a full backup once a week and an  incremental backup every day, or full backups every day and incremental  backups every hour.
您可以在每个完整备份之间执行多个增量备份，因此您可以设置一个备份过程，例如每周一次完整备份和每天一次增量备份，或者每天一次完整备份和每小时增量备份。

Incremental backups work because each InnoDB page contains a log sequence number, or LSN. The LSN is the system version number for the entire database. Each page’s LSN shows how recently it was changed.
增量备份之所以有效，是因为每个 InnoDB 页面都包含一个日志序列号 （LSN）。LSN 是整个数据库的系统版本号。每个页面的 LSN 显示它最近更改的时间。

An incremental backup copies each page which LSN is newer than the previous incremental or full backup’s LSN. An algorithm finds the pages  that match the criteria. The algorithm reads the data pages and checks  the page LSN.
增量备份会复制 LSN 比上一个增量备份或完整备份的 LSN 更新的每个页面。算法会查找符合条件的页面。该算法读取数据页并检查页 LSN。

## Create an incremental backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-incremental-backup.html#create-an-incremental-backup_1) 创建增量备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-incremental-backup.html#create-an-incremental-backup_1)

To make an incremental backup, begin with a full backup as usual. The xtrabackup binary writes a file called `xtrabackup_checkpoints` into the backup’s target directory. This file contains a line showing the `to_lsn`, which is the database’s LSN at the end of the backup. Create the full backup with a following command:
要进行增量备份，请像往常一样从完整备份开始。xtrabackup 二进制文件将名为 `xtrabackup_checkpoints` 的文件写入备份的目标目录。此文件包含一行显示 `to_lsn`，即备份结束时数据库的 LSN。使用以下命令创建完整备份：

```
$ xtrabackup --backup --target-dir=/data/backups/base
```

If you look at the `xtrabackup_checkpoints` file, you should see similar content depending on your LSN nuber:
如果您查看 `xtrabackup_checkpoints` 文件，您应该会看到类似的内容，具体取决于您的 LSN nuber：

<details class="example" data-immersive-translate-walked="e97e84f4-2b76-47be-8341-63b9fe0034c2"><summary data-immersive-translate-walked="e97e84f4-2b76-47be-8341-63b9fe0034c2" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="e97e84f4-2b76-47be-8341-63b9fe0034c2"><pre><span></span><code></code></pre></div></details>

Now that you have a full backup, you can make an incremental backup based on it. Use the following command:
现在，您已拥有完整备份，可以基于它进行增量备份。使用以下命令：

```
$ xtrabackup --backup --target-dir=/data/backups/inc1 \
--incremental-basedir=/data/backups/base
```

The `/data/backups/inc1/` directory should now contain delta files, such as `ibdata1.delta` and `test/table1.ibd.delta`. These represent the changes since the `LSN 1626007`. If you examine the `xtrabackup_checkpoints` file in this directory, you should see similar content to the following:
`/data/backups/inc1/` 目录现在应包含 delta 文件，例如 `ibdata1.delta` 和 `test/table1.ibd.delta`。这些表示自 `LSN 1626007`以来的变化。如果检查此目录中的 `xtrabackup_checkpoints` 文件，您应该会看到与以下内容类似的内容：

<details class="example" data-immersive-translate-walked="e97e84f4-2b76-47be-8341-63b9fe0034c2"><summary data-immersive-translate-walked="e97e84f4-2b76-47be-8341-63b9fe0034c2" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="e97e84f4-2b76-47be-8341-63b9fe0034c2"><pre><span></span><code></code></pre></div></details>

`from_lsn` is the starting LSN of the backup and for incremental it has to be the same as `to_lsn` (if it is the last checkpoint) of the previous/base backup.
`from_lsn` 是备份的起始 LSN，对于增量备份，它必须与上一个/基本备份的 `to_lsn` 相同（如果它是最后一个检查点）。

It’s now possible to use this directory as the base for yet another incremental backup:
现在可以将此目录用作另一个增量备份的基础：

```
$ xtrabackup --backup --target-dir=/data/backups/inc2 \
--incremental-basedir=/data/backups/inc1
```

This folder also contains the `xtrabackup_checkpoints`:
此文件夹还包含 `xtrabackup_checkpoints`：

<details class="example" data-immersive-translate-walked="e97e84f4-2b76-47be-8341-63b9fe0034c2"><summary data-immersive-translate-walked="e97e84f4-2b76-47be-8341-63b9fe0034c2" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="e97e84f4-2b76-47be-8341-63b9fe0034c2"><pre><span></span><code></code></pre></div></details>

Note 注意

In this case you can see that there is a difference between the `to_lsn` (last checkpoint LSN) and `last_lsn` (last copied LSN), this means that there was some traffic on the server during the backup process.
在这种情况下，您可以看到 `to_lsn` （最后一个检查点 LSN） 和 `last_lsn` （最后复制的 LSN） 之间存在差异，这意味着在备份过程中服务器上有一些流量。

# Prepare an incremental backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-incremental-backup.html#prepare-an-incremental-backup) 准备增量备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-incremental-backup.html#prepare-an-incremental-backup)

The `--prepare` step for incremental backups is not the same as for full backups. In full backups, two types of operations are performed to make the database consistent: committed transactions are replayed from the log file against the data files, and uncommitted transactions are rolled back. You must skip the rollback of uncommitted transactions when preparing an incremental backup, because transactions that were uncommitted at the time of your backup may be in progress, and it’s likely that they will be committed in the next incremental backup. You should use the `--apply-log-only` option to prevent the rollback phase.
增量备份的 `--prepare`  步骤与完整备份的步骤不同。在完整备份中，执行两种类型的操作以使数据库一致：根据数据文件从日志文件重放已提交的事务，以及回滚未提交的事务。在准备增量备份时，您必须跳过未提交的事务的回滚，因为备份时未提交的事务可能正在进行中，并且它们很可能会在下一次增量备份中提交。您应该使用 `--apply-log-only` 选项来阻止回滚阶段。

Warning 警告

If you do not use the `--apply-log-only` option to prevent the rollback phase, then your incremental backups  will be useless. After transactions have been rolled back, further  incremental backups cannot be applied.
如果您不使用 `--apply-log-only` 选项来阻止回滚阶段，那么您的增量备份将毫无用处。回滚事务后，无法应用进一步的增量备份。

Beginning with the full backup you created, you can prepare it, and then apply the incremental differences to it. Recall that you have the following backups:
从您创建的完整备份开始，您可以准备它，然后将增量差异应用于它。回想一下，您有以下备份：

```
/data/backups/base
/data/backups/inc1
/data/backups/inc2
```

To prepare the base backup, you need to run `--prepare` as usual, but prevent the rollback phase:
要准备基本备份，您需要像往常一样运行 `--prepare`，但要阻止回滚阶段：

```
$ xtrabackup --prepare --apply-log-only --target-dir=/data/backups/base
```

The output should end with text similar to the following:
输出应以类似于以下内容的文本结尾：

<details class="example" data-immersive-translate-walked="5edb7f15-79a2-4657-9913-e075fda0677e"><summary data-immersive-translate-walked="5edb7f15-79a2-4657-9913-e075fda0677e" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="5edb7f15-79a2-4657-9913-e075fda0677e"><pre><span></span><code></code></pre></div></details>

The log sequence number should match the `to_lsn` of the base backup, which you saw previously.
日志序列号应与您之前看到的基本备份的 `to_lsn` 匹配。

Warning 警告

This backup is actually safe to restore as-is now, even though the rollback  phase has been skipped. If you restore it and start MySQL, InnoDB will  detect that the rollback phase was not performed, and it will do that in the background, as it usually does for a crash recovery upon start. It  will notify you that the database was not shut down normally.
此备份现在实际上是可以安全地按原样还原的，即使已跳过回滚阶段。如果还原它并启动 MySQL，InnoDB 将检测到未执行回滚阶段，并且它将在后台执行此操作，就像通常在启动时进行崩溃恢复一样。它将通知您数据库未正常关闭。

To apply the first incremental backup to the full backup, run the following command:
要将第一个增量备份应用于全量备份，请运行以下命令：

```
$ xtrabackup --prepare --apply-log-only --target-dir=/data/backups/base \
--incremental-dir=/data/backups/inc1
```

This applies the delta files to the files in `/data/backups/base`, which rolls them forward in time to the time of the incremental backup. It then applies the redo log as usual to the result. The final data is in `/data/backups/base`, not in the incremental directory. You should see an output similar to:
这会将 delta 文件应用于 `/data/backups/base` 中的文件，从而将它们及时前滚到增量备份的时间。然后，它会像往常一样将重做日志应用于结果。最终数据位于 `/data/backups/base` 中，而不是 incremental 目录中。您应该会看到类似于以下内容的输出：

<details class="example" data-immersive-translate-walked="5edb7f15-79a2-4657-9913-e075fda0677e"><summary data-immersive-translate-walked="5edb7f15-79a2-4657-9913-e075fda0677e" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="5edb7f15-79a2-4657-9913-e075fda0677e"><pre><span></span><code></code></pre></div></details>

Again, the LSN should match what you saw from your earlier inspection of the first incremental backup. If you restore the files from `/data/backups/base`, you should see the state of the database as of the first incremental backup.
同样，LSN 应与您之前检查第一次增量备份时看到的内容相匹配。如果从 `/data/backups/base` 还原文件，您应该会看到第一次增量备份时的数据库状态。

Warning 警告

Percona XtraBackup does not support using the same incremental backup directory to prepare two copies of backup. Do not run `--prepare` with the same incremental backup directory (the value of –incremental-dir) more than once.
Percona XtraBackup 不支持使用相同的增量备份目录来准备两个备份副本。请勿多次使用同一增量备份目录（–incremental-dir 的值）运行 `--prepare`。

Preparing the second incremental backup is a similar process: apply the deltas to the (modified) base backup, and you will roll its data forward in time to the point of the second incremental backup:
准备第二个增量备份的过程与此类似：将增量应用于（修改后的）基本备份，然后将其数据及时前滚到第二个增量备份的时间点：

```
$ xtrabackup --prepare --target-dir=/data/backups/base \
--incremental-dir=/data/backups/inc2
```

Note 注意

`--apply-log-only` should be used when merging the incremental backups except the last one. That’s why the previous line does not contain the `--apply-log-only` option. Even if the `--apply-log-only` was used on the last step, backup would still be consistent but in that case server would perform the rollback phase.
`--apply-log-only` 应在合并除最后一个备份之外的增量备份时使用。这就是为什么上一行不包含 `--apply-log-only` 选项的原因。即使在最后一步中使用了 `--apply-log-only`，备份仍将是一致的，但在这种情况下，服务器将执行回滚阶段。

# 使用页面跟踪进行增量备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#take-an-incremental-backup-using-page-tracking)

To create an incremental backup with page tracking, Percona XtraBackup uses the MySQL `mysqlbackup` component. This component provides a list of pages modified since the last backup, and Percona XtraBackup copies only those pages. This operation removes the need to scan the pages in the database. If the majority of pages have not been modified, the page tracking feature can improve the speed of incremental backups.
要创建具有页面跟踪的增量备份，Percona XtraBackup 使用 MySQL `mysqlbackup` 组件。此组件提供自上次备份以来修改的页面列表，Percona XtraBackup 仅复制这些页面。此操作消除了扫描数据库中页面的需要。如果大多数页面尚未修改，则页面跟踪功能可以提高增量备份的速度。

## Install the component[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#install-the-component) 安装组件[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#install-the-component)

To start using the page tracking functionality, do the following:
要开始使用页面跟踪功能，请执行以下操作：

1. Install the `mysqlbackup` component and enable it on the server:
   安装 `mysqlbackup` 组件并在服务器上启用它：

   ```
   
   ```

```
$ INSTALL COMPONENT "file://component_mysqlbackup";
```

Check whether the `mysqlbackup` component is installed successfully:
检查 `mysqlbackup` 组件是否安装成功：

1. ```
   $ SELECT COUNT(1) FROM mysql.component WHERE component_urn='file://component_mysqlbackup';
   ```

## Use page tracking[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#use-page-tracking) 使用页面跟踪[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#use-page-tracking)

You can enable the page tracking functionality for the full and incremental backups with the `--page-tracking` option.
您可以使用 `--page-tracking` 选项为完整备份和增量备份启用页面跟踪功能。

The option has the following benefits:
该选项具有以下优势：

- Resets page tracking to the start of the backup. This reset allows the next incremental backup to use page tracking.
  将页面跟踪重置为备份的开始时间。此重置允许下一个增量备份使用页面跟踪。
- Allows the use of page tracking for an incremental backup if the page tracking data is available from the backup’s start checkpoint LSN.
  如果页面跟踪数据可从备份的起始检查点 LSN 获得，则允许将页面跟踪用于增量备份。

Percona XtraBackup processes a list of all the tracked pages in memory. If  Percona XtraBackup does not have enough available memory to process this list, the process throws an error and exits. For example, if an  incremental backup uses 200GB, Percona XtraBackup can use an additional  100MB of memory to process and store the page tracking data. 
Percona XtraBackup 会处理内存中所有被跟踪页面的列表。如果 Percona XtraBackup  没有足够的可用内存来处理此列表，该进程将引发错误并退出。例如，如果增量备份使用 200GB，Percona XtraBackup 可以使用额外的 100MB 内存来处理和存储页面跟踪数据。

The examples of creating full and incremental backups using the `--page-tracking` option:
使用 `--page-tracking` 选项创建完整备份和增量备份的示例：

[Full backup 完全备份](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#__tabbed_1_1)[Incremental backup 增量备份](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#__tabbed_1_2)

```
$ xtrabackup --backup --target-dir=$FULL_BACK --page-tracking
```

After enabling the functionality, the next incremental backup finds changed pages using page tracking.
启用该功能后，下一个增量备份会使用页面跟踪查找已更改的页面。

The first full backup using page tracking, Percona XtraBackup may have a delay. The following is an example of the message:
使用页面跟踪的第一次完整备份 Percona XtraBackup 可能会有延迟。以下是该消息的示例：

<details class="example" data-immersive-translate-walked="81ff8177-dc2b-4046-8282-9f10db44def5"><summary data-immersive-translate-walked="81ff8177-dc2b-4046-8282-9f10db44def5" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="81ff8177-dc2b-4046-8282-9f10db44def5"><pre><span></span><code></code></pre></div></details>

Enable page tracking before creating the first backup to avoid this delay.  This method ensures that the page tracking log sequence number (LSN) is  higher than the checkpoint LSN of the server.
在创建第一个备份之前启用页面跟踪，以避免此延迟。该方法确保页面跟踪日志序列号 （LSN） 高于服务器的检查点 LSN。

## Start page tracking manually[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#start-page-tracking-manually) 手动开始页面跟踪[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#start-page-tracking-manually)

After the mysqlbackup component is loaded and active on the server, you can start page tracking manually with the following option:
在服务器上加载并激活 mysqlbackup 组件后，您可以使用以下选项手动启动页面跟踪：

```
$ SELECT mysqlbackup_page_track_set(true);
```

## Check the LSN value[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#check-the-lsn-value) 检查 LSN 值[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#check-the-lsn-value)

Check the LSN value starting from which changed pages are tracked with the following option:
使用以下选项检查 LSN 值，从该值开始跟踪已更改的页面：

```
$ SELECT mysqlbackup_page_track_get_start_lsn();
```

## Stop page tracking[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#stop-page-tracking) 停止页面跟踪[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#stop-page-tracking)

To stop page tracking, use the following command:
要停止页面跟踪，请使用以下命令：

```
$ SELECT mysqlbackup_page_track_set(false);
```

## Purge page tracking data[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#purge-page-tracking-data) 清除页面跟踪数据[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#purge-page-tracking-data)

When you start page tracking, it creates a file under the server’s datadir to collect data about changed pages. This file grows until you stop the page tracking. If you stop the server and then restart it, page tracking creates a new file but also keeps the old one. The old file continues to grow until you stop the page tracking explicitly.
当您开始页面跟踪时，它会在服务器的数据目录下创建一个文件，以收集有关已更改页面的数据。此文件会一直增长，直到您停止页面跟踪。如果停止服务器，然后重新启动它，页面跟踪会创建一个新文件，但也会保留旧文件。旧文件会继续增长，直到您明确停止页面跟踪。

If you purge the page tracking data, you should create a full backup afterward. To purge the page tracking data, do the following steps:
如果您清除页面跟踪数据，则应在之后创建完整备份。要清除页面跟踪数据，请执行以下步骤：

```
$ SELECT mysqlbackup_page_track_set(false);
$ SELECT mysqlbackup_page_track_purge_up_to(9223372036854775807);
/* Specify the LSN up to which you want to purge page tracking data. /
9223372036854775807 is the highest possible LSN which purges all page tracking files.*/
$ SELECT mysqlbackup_page_track_set(true);
```

## Known issue[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#known-issue) 

If the index is built in place using an exclusive algorithm and then is added to a table after the last LSN checkpoint, you may generate a bad incremental backup using page tracking. For more details see [PS-8032](https://jira.percona.com/browse/PS-8032).
如果索引是使用独占算法就地构建的，然后在最后一个 LSN 检查点之后添加到表中，则可能会使用页面跟踪生成错误的增量备份。有关详细信息，请参阅 [PS-8032](https://jira.percona.com/browse/PS-8032)。

## Uninstall the mysqlbackup component[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#uninstall-the-mysqlbackup-component) 卸载 mysqlbackup 组件[¶](https://docs.percona.com/percona-xtrabackup/8.4/page-tracking.html#uninstall-the-mysqlbackup-component)

To uninstall the mysqlbackup component, use the following statement:
要卸载 mysqlbackup 组件，请使用以下语句：

```
$ UNINSTALL COMPONENT "file://component_mysqlbackup"
```

## 压缩备份

# Create a compressed backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-compressed-backup.html#create-a-compressed-backup) 创建压缩备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-compressed-backup.html#create-a-compressed-backup)

Percona XtraBackup supports compressed backups. To make a compressed backup, use the `--compress` option along with the `--backup` and `--target-dir` options. A local or streaming backup can be compressed or decompressed with [xbstream](https://docs.percona.com/percona-xtrabackup/8.4/xbstream-binary-overview.html).
Percona XtraBackup 支持压缩备份。要进行压缩备份，请使用 `--compress` 选项以及 `--backup` 和 `--target-dir` 选项。可以使用 [xbstream](https://docs.percona.com/percona-xtrabackup/8.4/xbstream-binary-overview.html) 压缩或解压缩本地或流式备份。

By default, the `--compress` option uses the `zstandard` tool that you can install with the `percona-release` package configuration tool as follows:
默认情况下，`--compress` 选项使用 `zstandard` 工具，您可以使用 `percona-release` 软件包配置工具安装该工具，如下所示：

```
$ sudo percona-release enable tools
$ sudo apt update
$ sudo apt install zstandard
```

Note 注意

Enable the repository: `percona-release enable-only tools release`.
启用存储库 。 `percona-release enable-only tools release` 

If Percona XtraBackup is intended to be used in combination with the upstream MySQL Server, you only need to enable the `tools` repository: `percona-release enable-only tools`.
如果 Percona XtraBackup 打算与上游 MySQL Server 结合使用，则只需启用`工具`存储库： `percona-release enable-only tools` 。

Percona XtraBackup supports the following compression algorithms:
Percona XtraBackup 支持以下压缩算法：

## Zstandard (ZSTD)[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-compressed-backup.html#zstandard-zstd) Zstandard （ZSTD） [¶](https://docs.percona.com/percona-xtrabackup/8.4/create-compressed-backup.html#zstandard-zstd)

The Zstandard (ZSTD) is a fast lossless compression algorithm that targets  real-time compression scenarios and better compression ratios. `ZSTD` is the default compression algorithm for the `--compress` option.
Zstandard （ZSTD） 是一种快速无损压缩算法，适用于实时压缩场景和更好的压缩比。`ZSTD` 是 `--compress` 选项的默认压缩算法。

To compress files using the `ZSTD` compression algorithm, use the `--compress` option:
要使用 `ZSTD` 压缩算法压缩文件，请使用 `--compress` 选项：

```
$ xtrabackup --backup --compress --target-dir=/data/backup
```

The resulting files have the `\*.zst` format.
生成的文件具有 `\*.zst` 格式。

You can specify `ZSTD` compression level with the [`--compress-zstd-level(=#)`](https://docs.percona.com/percona-xtrabackup/8.4/xtrabackup-option-reference.html#compress-zstd-level) option. The default value is `1`.
您可以使用 [`--compress-zstd-level（=#）`](https://docs.percona.com/percona-xtrabackup/8.4/xtrabackup-option-reference.html#compress-zstd-level) 选项指定 `ZSTD` 压缩级别。默认值为 `1`。

```
$ xtrabackup –backup –compress –compress-zstd-level=1 –target-dir=/data/backup
```

## lz4[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-compressed-backup.html#lz4)

To compress files using the `lz4` compression algorithm, set the `--compress` option to `lz4`:
要使用 `lz4` 压缩算法压缩文件，请将 `--compress` 选项设置为 `lz4`：

```
$ xtrabackup --backup --compress=lz4 --target-dir=/data/backup
```

The resulting files have the `\*.lz4` format. 
生成的文件具有 `\*.lz4` 格式。

If you want to speed up the compression you can use the parallel compression, which can be enabled with `--compress-threads` option. Following example will use four threads for compression:
如果要加快压缩速度，可以使用并行压缩，可以通过 `--compress-threads` 选项启用。以下示例将使用 4 个线程进行压缩：

```
$ xtrabackup --backup --compress --compress-threads=4 \
--target-dir=/data/compressed/
```

<details class="example" data-immersive-translate-walked="1ab0f072-b105-4078-b232-d35613268d55"><summary data-immersive-translate-walked="1ab0f072-b105-4078-b232-d35613268d55" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary></details>

# Decompress and prepare a backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-compressed-backup.html#decompress-and-prepare-a-backup) 解压缩并准备备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-compressed-backup.html#decompress-and-prepare-a-backup)

Before you can prepare the backup you need to decompress all the files.
在准备备份之前，您需要解压缩所有文件。

## Decompress a backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-compressed-backup.html#decompress-a-backup) 解压缩备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-compressed-backup.html#decompress-a-backup)

- To decompress backups made using `LZ4` or `ZSTD` compression algorithm, install the corresponding package.
  要解压缩使用 `LZ4` 或 `ZSTD` 压缩算法创建的备份，请安装相应的软件包。

  `Install on APT systems`
  `在 APT 系统上安装`

  [Install the `lz4` package
  安装 `lz4` 软件包](https://docs.percona.com/percona-xtrabackup/8.4/prepare-compressed-backup.html#__tabbed_1_1)[Install the `zstd` package
  安装 `zstd` 软件包](https://docs.percona.com/percona-xtrabackup/8.4/prepare-compressed-backup.html#__tabbed_1_2)

```
$ sudo apt install lz4
Install on YUM systems`
`在 YUM 系统上安装
```

[Install the `lz4` package
安装 `lz4` 软件包](https://docs.percona.com/percona-xtrabackup/8.4/prepare-compressed-backup.html#__tabbed_2_1)[Install the `zstd` package
安装 `zstd` 软件包](https://docs.percona.com/percona-xtrabackup/8.4/prepare-compressed-backup.html#__tabbed_2_2)

```
$ sudo yum install lz4
```

Use the `--decompress` option to decompress the backup.
使用 `--decompress` 选项解压缩备份。

- ```
  $ xtrabackup --decompress --target-dir=/data/compressed/
  ```

  Note 注意

  `--parallel` can be used with `--decompress` option to decompress multiple files simultaneously. 
  `--parallel` 可以与 `--decompress` 选项一起使用，以同时解压缩多个文件。

  Percona XtraBackup does not automatically delete compressed files. To clean up the backup directory, use the `--remove-original` option. If you do not remove the compressed files, these files will not be copied or moved to the datadir when using the `--copy-back` or `--move-back` options.
  Percona XtraBackup 不会自动删除压缩文件。要清理备份目录，请使用 `--remove-original` 选项。如果不删除压缩文件，则在使用 `--copy-back` 或 `--move-back` 选项时，这些文件将不会被复制或移动到 datadir。

## Prepare the backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-compressed-backup.html#prepare-the-backup) 准备备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-compressed-backup.html#prepare-the-backup)

When the files are decompressed you can prepare the backup with the `--prepare` option.
解压缩文件时，您可以使用 `--prepare` 选项准备备份。

```
$ xtrabackup --prepare --target-dir=/data/compressed/
```

<details class="example" data-immersive-translate-walked="1f75b103-e0f9-447b-aa3a-753ef864260f"><summary data-immersive-translate-walked="1f75b103-e0f9-447b-aa3a-753ef864260f" data-immersive-translate-paragraph="1">Confirmation message<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">确认消息</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="1f75b103-e0f9-447b-aa3a-753ef864260f"><pre><span></span><code></code></pre></div></details>

Now the files in `/data/compressed/` are ready to be used by the server.
现在 `/data/compressed/` 中的文件已准备好供服务器使用。

# 加密的 InnoDB 表空间备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#encrypted-innodb-tablespace-backups)

InnoDB supports [data encryption for InnoDB tables](https://dev.mysql.com/doc/refman/8.4/en/innodb-data-encryption.html) stored in file-per-table tablespaces. This feature provides an at-rest encryption for physical tablespace data files.
InnoDB 支持对存储在逐表文件表空间中的 [InnoDB 表进行数据加密](https://dev.mysql.com/doc/refman/8.4/en/innodb-data-encryption.html)。此功能为物理表空间数据文件提供静态加密。

For an authenticated user or an application to access an encrypted F  tablespace, InnoDB uses the master encryption key to decrypt the  tablespace key. The master encryption key is stored in a keyring. 
对于经过身份验证的用户或应用程序访问加密的 F 表空间，InnoDB使用主加密密钥解密表空间密钥。主加密密钥存储在密钥环中。

Percona XtraBackup supports the following keyring components which are stored in the `plugin` directory: 
Percona XtraBackup 支持以下存储在`插件`目录中的密钥环组件：

- [keyring_vault](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#use-the-keyring-vault-component) component
  [keyring_vault](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#use-the-keyring-vault-component) 组件
- [keyring_file](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#use-the-keyring-file-component) component
  [keyring_file](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#use-the-keyring-file-component) 组件
- [Key Management Interoperability Protocol (KMIP)
  密钥管理互操作性协议 （Key Management Interoperability Protocol， KMIP）](https://docs.percona.com/percona-server/innovation-release/using-kmip.html?h=kmip)
- [Amazon Key Management Service (AWS KMS)
  Amazon Key Management Service （AWS KMS）](https://docs.percona.com/percona-server/innovation-release/using-amz-kms.html)

Percona XtraBackup 8.4 and later versions do not support any plugin versions of the security features.
Percona XtraBackup 8.4 及更高版本不支持任何插件版本的安全功能。

Note 注意

Enable only one keyring component simultaneously for each server instance.  Enabling multiple keyring components is not supported and may result in  data loss.
同时为每个服务器实例启用一个密钥环组件。不支持启用多个密钥环组件，这可能会导致数据丢失。

## Use the keyring vault component[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#use-the-keyring-vault-component) 使用 keyring vault 组件[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#use-the-keyring-vault-component)

The `keyring_vault` component extends the server capabilities. The server uses a manifest  to load the component and the component has its own configuration file.
`keyring_vault` 组件扩展了服务器功能。服务器使用清单加载组件，组件有自己的配置文件。

The following example is a global manifest file that does not use local manifests:
以下示例是不使用本地清单的全局清单文件：

```
{
 "read_local_manifest": false,
 "components": "file://component_keyring_vault"
}
```

The following example of a global manifest file that points to a local manifest file:
以下指向本地清单文件的全局清单文件示例：

```
{
 "read_local_manifest": true
}
```

The following example of a local manifest file:
本地清单文件示例如下：

```
{
 "components": "file://component_keyring_vault"
}
```

The configuration settings can be in either a global or a local configuration file.
配置设置可以位于全局或本地配置文件中。

<details class="example" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><summary data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009" data-immersive-translate-paragraph="1">Example of a configuration file in JSON format<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">JSON 格式的配置文件示例</font></font></font></summary><div class="highlight" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><pre id="__code_3"><span></span></pre></div></details>

<details class="example" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><div class="highlight" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><pre id="__code_3"><code><span class="p"></span><span class="w"></span><span class="nt"></span><span class="p"></span><span class="w"></span><span class="mi"></span><span class="p"></span><span class="w"></span><span class="nt"></span><span class="p"></span><span class="w"></span><span class="s2"></span><span class="p"></span><span class="w"></span><span class="nt"></span><span class="p"></span><span class="w"></span><span class="s2"></span><span class="p"></span><span class="w"></span><span class="nt"></span><span class="p"></span><span class="w"></span><span class="s2"></span><span class="p"></span><span class="w"></span><span class="nt"></span><span class="p"></span><span class="w"></span><span class="s2"></span><span class="p"></span><span class="w"></span><span class="nt"></span><span class="p"></span><span class="w"></span><span class="s2"></span><span class="p"></span></code></pre></div></details>

Find more information on configuring the `keyring_vault` component in [Use the keyring vault component](https://docs.percona.com/percona-server/innovation-release/use-keyring-vault-component.html).
有关配置 `keyring_vault` 组件的更多信息，请参阅[使用密钥环保险库组件](https://docs.percona.com/percona-server/innovation-release/use-keyring-vault-component.html)。

The component has no special requirements for backing up a database that contains encrypted InnoDB tablespaces.
该组件对备份包含加密的 InnoDB 表空间的数据库没有特殊要求。

The following command creates a backup in the `/data/backup` directory:
以下命令在 `/data/backup` 目录中创建备份：

```
$ xtrabackup --backup --target-dir=/data/backup --user=root
```

After xtrabackup completes the action, the following message confirms the action:
在 xtrabackup 完成操作后，以下消息确认该操作：

<details class="example" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><summary data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009" data-immersive-translate-paragraph="1">Confirmation message<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">确认消息</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><pre><span></span><code></code></pre></div></details>

### Prepare the backup with the keyring vault component[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#prepare-the-backup-with-the-keyring-vault-component) 使用 keyring vault 组件准备备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#prepare-the-backup-with-the-keyring-vault-component)

To prepare the backup, the xtrabackup binary must access the keyring. The  xtrabackup binary does not communicate with the MySQL server or read the default `my.cnf` configuration file. Specify the keyring settings in the command line:
要准备备份，xtrabackup 二进制文件必须访问密钥环。xtrabackup 二进制文件不与 MySQL 服务器通信，也不读取默认的 `my.cnf` 配置文件。在命令行中指定密钥环设置：

```
$ xtrabackup --prepare --target-dir=/data/backup --component-keyring-config==/etc/vault.cnf
```

The following message confirms that the xtrabackup binary completed the action:
以下消息确认 xtrabackup 二进制文件已完成操作：

<details class="example" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><summary data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009" data-immersive-translate-paragraph="1">Confirmation message<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">确认消息</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><pre><span></span><code></code></pre></div></details>

### Restore the backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#restore-the-backup) 恢复备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#restore-the-backup)

As soon as the backup is prepared, you can restore it with the `--copy-back` option:
准备好备份后，您可以使用 `--copy-back` 选项恢复它：

```
$ xtrabackup --copy-back --target-dir=/data/backup --datadir=/data/mysql \
--transition-key=MySecretKey --generate-new-master-key \
--component-keyring-config=/etc/vault.cnf
```

## Use the keyring file component[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#use-the-keyring-file-component) 使用 keyring 文件组件[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#use-the-keyring-file-component)

The `keyring_file` component is part of the component-based MySQL infrastructure which extends the server capabilities.
`keyring_file` 组件是基于组件的 MySQL 基础架构的一部分，它扩展了服务器功能。

The server uses a manifest to load the component, and the component has its own configuration file. See the [MySQL documentation on the component  installation](https://dev.mysql.com/doc/refman/8.4/en/keyring-component-installation.html) for more information.
服务器使用 manifest 加载组件，组件有自己的配置文件。有关更多信息[，请参阅有关组件安装的 MySQL 文档](https://dev.mysql.com/doc/refman/8.4/en/keyring-component-installation.html)。

An example of a manifest and a configuration file follows:
清单和配置文件的示例如下：

An example of `./bin/mysqld.my`:
`./bin/mysqld.my` 的示例：

```
{
   "components": "file://component_keyring_file"
}
```

An example of `/lib/plugin/component_keyring_file.cnf`: 示例： `/lib/plugin/component_keyring_file.cnf` 

```
{
   "path": "/var/lib/mysql-keyring/keyring_file", "read_only": false
}
```

For more information, see [Keyring Component Installation](https://dev.mysql.com/doc/refman/8.4/en/keyring-component-installation.html).
有关更多信息，请参阅 [Keyring 组件安装](https://dev.mysql.com/doc/refman/8.4/en/keyring-component-installation.html)。

With the appropriate privilege, you can `SELECT` on the [performance_schema.keyring_component_status table](https://dev.mysql.com/doc/refman/8.4/en/performance-schema-keyring-component-status-table.html) to view the attributes and status of the installed keyring component  when in use.
使用适当的权限，您可以在 [performance_schema.keyring_component_status 表](https://dev.mysql.com/doc/refman/8.4/en/performance-schema-keyring-component-status-table.html)`上执行 SELECT` 操作，以便在使用时查看已安装的密钥环组件的属性和状态。

The component has no special requirements for backing up a database that contains encrypted InnoDB tablespaces.
该组件对备份包含加密的 InnoDB 表空间的数据库没有特殊要求。

```
$ xtrabackup --backup --target-dir=/data/backup --user=root
```

The following message confirms that the xtrabackup binary completed the action:
以下消息确认 xtrabackup 二进制文件已完成操作：

<details class="example" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><summary data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009" data-immersive-translate-paragraph="1">Confirmation message<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">确认消息</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><pre><span></span><code></code></pre></div></details>

Warning 警告

xtrabackup does not copy the keyring file into the backup directory. To prepare  the backup, you must copy the keyring file manually.
xtrabackup 不会将密钥环文件复制到 backup 目录中。要准备备份，您必须手动复制密钥环文件。

### Prepare the backup with the keyring_file component[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#prepare-the-backup-with-the-keyring_file-component) 使用 keyring_file 组件准备备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#prepare-the-backup-with-the-keyring_file-component)

xtrabackup reads the `keyring_file` component configuration from `xtrabackup_component_keyring_file.cnf`. You must specify the keyring_file data path if the `--component-keyring-config` is not located in the attribute `PATH` from the `xtrabackup_component_keyring_file.cnf`.
xtrabackup 从 `xtrabackup_component_keyring_file.cnf` 中读取 `keyring_file` 组件配置。如果 `--component-keyring-config 不在 的属性` `PATH` 中，则必须指定 keyring_file 数据路径 `xtrabackup_component_keyring_file.cnf` 。

The following is an example of adding the location for the –component-keyring-config:
以下是为 –component-keyring-config 添加位置的示例：

```
$ xtrabackup --prepare --target-dir=/data/backup \
--component-keyring-config=/var/lib/mysql-keyring/keyring
```

xtrabackup attempts to read `xtrabackup_component_keyring_file.cnf`. You can assign another keyring file component configuration by passing the `--component-keyring-config` option.
xtrabackup 尝试读取 `xtrabackup_component_keyring_file.cnf` 。您可以通过传递 `--component-keyring-config` 选项来分配另一个密钥环文件组件配置。

The following message confirms that the xtrabackup binary completed the action:
以下消息确认 xtrabackup 二进制文件已完成操作：

<details class="example" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><summary data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009" data-immersive-translate-paragraph="1">Confirmation message<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">确认消息</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><pre><span></span><code></code></pre></div></details>

The backup is prepared. To restore the backup use the `--copy-back` option. If the keyring has been rotated, you must restore the specific keyring used to take and prepare the backup.
备份已准备就绪。要恢复备份，请使用 `--copy-back` 选项。如果密钥环已轮换，则必须恢复用于获取和准备备份的特定密钥环。

## Incremental encrypted InnoDB tablespace backups with keyring file component[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#incremental-encrypted-innodb-tablespace-backups-with-keyring-file-component) 使用密钥环文件组件进行增量加密 InnoDB 表空间备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#incremental-encrypted-innodb-tablespace-backups-with-keyring-file-component)

The process of taking incremental backups with InnoDB tablespace encryption is similar to taking incremental backups with unencrypted tablespace.
使用 InnoDB 表空间加密进行增量备份的过程类似于使用未加密的表空间进行增量备份。

### Create an incremental backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#create-an-incremental-backup) 创建增量备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#create-an-incremental-backup)

To make an incremental backup, begin with a full backup. The xtrabackup binary writes `xtrabackup_checkpoints` into the backup’s target directory. This file contains a line showing the `to_lsn`, which is the LSN of the database at the end of the backup. First, you need to create a full backup with the following command:
要进行增量备份，请从完整备份开始。xtrabackup 二进制文件将`xtrabackup_checkpoints`写入备份的目标目录。此文件包含一行显示 `to_lsn`，即备份结束时数据库的 LSN。首先，您需要使用以下命令创建完整备份：

```
$ xtrabackup --backup --target-dir=/data/backups/base
```

If you look at the `xtrabackup_checkpoints` file, you should see the output similar to the following:
如果查看 `xtrabackup_checkpoints` 文件，应会看到类似于以下内容的输出：

<details class="example" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><summary data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><pre><span></span><code></code></pre></div></details>

Now that you have a full backup, you can make an incremental backup based on it. Use a command such as the following:
现在，您已拥有完整备份，可以基于它进行增量备份。使用如下命令：

```
$ xtrabackup --backup --target-dir=/data/backups/inc1 \
--incremental-basedir=/data/backups/base \
```

The `/data/backups/inc1/` directory should now contain delta files, such as `ibdata1.delta` and `test/table1.ibd.delta`. These represent the changes since the `LSN 7666625`. If you examine the `xtrabackup_checkpoints` file in this directory, you should see  the output similar to the following:
`/data/backups/inc1/` 目录现在应包含 delta 文件，例如 `ibdata1.delta` 和 `test/table1.ibd.delta`。这些表示自 `LSN 7666625`以来的变化。如果检查此目录中的 `xtrabackup_checkpoints` 文件，您应该会看到类似于以下内容的输出：

<details class="example" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><summary data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><pre><span></span><code></code></pre></div></details>

Use this directory as the base for yet another incremental backup:
使用此目录作为另一个增量备份的基础：

```
$ xtrabackup --backup --target-dir=/data/backups/inc2 \
--incremental-basedir=/data/backups/inc1 \
```

### Prepare incremental backups[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#prepare-incremental-backups) 准备增量备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#prepare-incremental-backups)

The `--prepare` step for incremental backups is not the same as for normal backups. In normal backups, two types of operations are performed to make the database consistent: 
增量备份的 `--prepare` 步骤与普通备份不同。在正常备份中，将执行两种类型的操作来使数据库保持一致：

- Committed transactions are replayed from the log file against the data files
  提交的事务将从日志文件中针对数据文件重放
- Uncommitted transactions are rolled back
  未提交的事务将回滚

You must skip the rollback of uncommitted transactions when preparing a  backup because transactions that were uncommitted at the time of your  backup may be in progress, and they will likely be committed in the next incremental backup. Use the `--apply-log-only` option to prevent the rollback phase. Your incremental backups are useless if you do not use the `--apply-log-only` option to prevent the rollback phase. After transactions have been rolled back, further incremental backups cannot be applied.
在准备备份时，必须跳过未提交的事务的回滚，因为在备份时未提交的事务可能正在进行中，并且它们可能会在下一次增量备份中提交。使用 `--apply-log-only` 选项来阻止回滚阶段。如果您不使用 `--apply-log-only` 选项来阻止回滚阶段，则增量备份将毫无用处。回滚事务后，无法应用进一步的增量备份。

Beginning with the full backup you created, you can prepare it and then apply the incremental differences. Recall that you have the following backups:
从您创建的完整备份开始，您可以准备它，然后应用增量差异。回想一下，您有以下备份：

```
/data/backups/base
/data/backups/inc1
/data/backups/inc2
```

To prepare the backup, you must copy the keyring file manually. The  xtrabackup binary does not copy the keyring file into the backup  directory. 
要准备备份，您必须手动复制密钥环文件。xtrabackup 二进制文件不会将密钥环文件复制到备份目录中。

If the keyring has not been rotated you can use the same one you’ve backed-up with the base backup. If the keyring has been rotated, or you have  upgraded the plugin to a component, you must back up the keyring file.  Otherwise, you cannot prepare the backup.
如果密钥环尚未轮换，您可以使用与基本备份一起备份的密钥环。如果密钥环已轮换，或者您已将插件升级为组件，则必须备份密钥环文件。否则，您将无法准备备份。

To prepare the base backup, you need to run `--prepare` as usual, but prevent the rollback phase:
要准备基本备份，您需要像往常一样运行 `--prepare`，但要阻止回滚阶段：

```
$ xtrabackup --prepare --apply-log-only --target-dir=/data/backups/base \
--component-keyring-config=/var/lib/mysql-keyring/keyring
```

<details class="example" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><summary data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="074245bf-2a46-475c-afe8-1a5e338eb009"><pre><span></span><code></code></pre></div></details>

To apply the first incremental backup to the full backup, you should use the following command:
要将第一个增量备份应用于完整备份，您应该使用以下命令：

```
$ xtrabackup --prepare --apply-log-only --target-dir=/data/backups/base \
--incremental-dir=/data/backups/inc1 \
--component-keyring-config=/var/lib/mysql-keyring/keyring
```

The backup should be prepared with the keyring file and type that was used  when the backup was being taken. This means that if the keyring has been rotated, or you have upgraded from a plugin to a component between the  base and incremental backup, you must use the keyring used when the  first incremental backup was taken.
备份应使用备份时使用的密钥环文件和类型进行准备。这意味着，如果密钥环已轮换，或者您已从插件升级到基本备份和增量备份之间的组件，则必须使用在进行第一次增量备份时使用的密钥环。

Preparing the second incremental backup is a similar process: apply the deltas to the (modified) base backup, and you will roll its data forward in time  to the point of the second incremental backup:
准备第二个增量备份的过程与此类似：将增量应用于（修改后的）基本备份，然后将其数据及时前滚到第二个增量备份的时间点：



```
$ xtrabackup --prepare --target-dir=/data/backups/base \
--incremental-dir=/data/backups/inc2 \
--component-keyring-config=/var/lib/mysql-keyring/keyring
```

Use `--apply-log-only` when merging all incremental backups except the last one. The previous line does not contain the `--apply-log-only` option. Even if the `--apply-log-only` option was used on the last step, the backup would still be consistent, but in that case, the server would perform the rollback phase.
在合并除最后一个增量备份之外的所有增量备份时，请使用 `--apply-log-only`。上一行不包含 `--apply-log-only` 选项。即使在最后一步中使用了 `--apply-log-only` 选项，备份仍将是一致的，但在这种情况下，服务器将执行回滚阶段。



The backup is now prepared and can be restored with `--copy-back` option. In case the keyring has been rotated you’ll need to restore the keyring which was used to take and prepare the backup.
备份现已准备好，可以使用 `--copy-back` 选项进行恢复。如果密钥环已轮换，则需要恢复用于获取和准备备份的密钥环。

## Restore a backup when the keyring is not available[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#restore-a-backup-when-the-keyring-is-not-available) 当密钥环不可用时恢复备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#restore-a-backup-when-the-keyring-is-not-available)

While this works, the method requires access to the same keyring that the  server is using. It may not be possible if the backup is prepared on a different server or at a much later time, when keys in the keyring are purged, or, in the case of a malfunction, when the keyring vault server  is unavailable.
虽然这有效，但该方法需要访问服务器使用的相同密钥环。如果在不同的服务器上准备备份，或者在很晚的时间准备备份，当密钥环中的密钥被清除时，或者在发生故障的情况下，当密钥环保险库服务器不可用时，可能无法备份。

The `--transition-key=<passphrase>` option should be used to make it possible for the xtrabackup binary to  process the backup without access to the keyring vault server. In this  case, the binary derives the AES encryption key from the specified  passphrase and will use it to encrypt tablespace keys of tablespaces  being backed up.
应该使用 `--transition-key=<passphrase>` 选项，使 xtrabackup 二进制文件可以在不访问密钥环保险库服务器的情况下处理备份。在这种情况下，二进制文件从指定的密码派生 AES 加密密钥，并将使用它来加密正在备份的表空间的表空间密钥。

### Create a backup with a passphrase[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#create-a-backup-with-a-passphrase) 使用密码创建备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#create-a-backup-with-a-passphrase)

The following example illustrates how the backup can be created in this case:
以下示例说明了在这种情况下如何创建备份：

```
$ xtrabackup --backup --user=root -p --target-dir=/data/backup \
--transition-key=MySecretKey
```

If `--transition-key` is specified without a value, xtrabackup will ask for it.
如果指定了 `--transition-key` 但没有值，xtrabackup 将要求它。

xtrabackup scrapes `--transition-key` so that its value is not visible in the `ps` command output.
xtrabackup 会抓取 `--transition-key`，使其值在 `ps` 命令输出中不可见。

### Prepare a backup with a passphrase[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#prepare-a-backup-with-a-passphrase) 使用密码准备备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#prepare-a-backup-with-a-passphrase)

The same passphrase should be specified for the prepare command:
应为 prepare 命令指定相同的密码：

```
$ xtrabackup --prepare --target-dir=/data/backup \
--transition-key=MySecretKey
```

There are no `--keyring-vault...`,``–keyring-file…``, or `--component-keyring-config` options here, because xtrabackup does not talk to the keyring in this case.
这里没有 `--keyring-vault...`，''–keyring-file...'' 或 `--component-keyring-config` 选项，因为在这种情况下 xtrabackup 不与密钥环通信。

### Restore a backup with a generated key[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#restore-a-backup-with-a-generated-key) 使用生成的密钥恢复备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#restore-a-backup-with-a-generated-key)

When restoring a backup you need to generate a new master key. 
还原备份时，您需要生成新的主密钥。

The example for `keyring_file` component:
`keyring_file`组件的示例：

```
$ xtrabackup --copy-back --target-dir=/data/backup --datadir=/data/mysql \
--transition-key=MySecretKey --generate-new-master-key \
--component-keyring-config=/var/lib/mysql-keyring/keyring
```

The example for `keyring_vault` component:
`keyring_vault`组件的示例：

```
$ xtrabackup --copy-back --target-dir=/data/backup --datadir=/data/mysql \
--transition-key=MySecretKey --generate-new-master-key \
--component-keyring-config=/etc/vault.cnf
```

xtrabackup generates a new master key, stores it in the target keyring vault server, and re-encrypts the tablespace keys using this key.
XtraBackup 生成一个新的主密钥，将其存储在目标密钥环保险库服务器中，并使用此密钥重新加密表空间密钥。

### Make a backup with a stored transition key[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#make-a-backup-with-a-stored-transition-key) 使用存储的 transition key 进行备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/encrypted-innodb-tablespace-backups.html#make-a-backup-with-a-stored-transition-key)

Finally, there is an option to store a transition key in the keyring. In this  case, xtrabackup must access the same keyring file or vault server  during prepare and copy-back steps, but does not depend on whether the  server keys have been purged.
最后，还有一个选项可以在密钥环中存储转换密钥。在这种情况下，xtrabackup 必须在准备和复制回步骤期间访问相同的密钥环文件或 Vault 服务器，但不取决于服务器密钥是否已清除。

In this scenario, the three stages of the backup process look as follows.
在此方案中，备份过程的三个阶段如下所示。

- Back up 退后

```
$ xtrabackup --backup --user=root -p --target-dir=/data/backup \
--generate-transition-key
```

- Prepare 准备

  - `keyring_file` component variant:
    `keyring_file`组件变体：

  ```
  
  ```

```
$ xtrabackup --prepare --target-dir=/data/backup \
--component-keyring-config=/var/lib/mysql-keyring/keyring
```

- `keyring_vault` component variant:
  `keyring_vault`组件变体：

```
$ xtrabackup --prepare --target-dir=/data/backup \
--component-keyring-config=/etc/vault.cnf
```

Copy-back 复制回

- `keyring_file` component variant:
  `keyring_file`组件变体：

```
$ xtrabackup --copy-back --target-dir=/data/backup --datadir=/data/mysql \
--generate-new-master-key --component-keyring-config=/var/lib/mysql-keyring/keyring
```

- `keyring_vault` component variant:
  `keyring_vault`组件变体：

```
$ xtrabackup --copy-back --target-dir=/data/backup --datadir=/data/mysql \
--generate-new-master-key --component-keyring-config=/etc/vault.cnf
```

## partial backup

# Create a partial backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-partial-backup.html#create-a-partial-backup) 创建部分备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-partial-backup.html#create-a-partial-backup)

xtrabackup supports taking partial backups when the `innodb_file_per_table` option is enabled.
XtraBackup 支持在启用 `innodb_file_per_table` 选项时进行部分备份。

Warning 警告

Do not copy back the prepared backup.
不要复制回准备好的备份。

Restoring partial backups should be done by importing the tables. We do not by using the `–copy-back` option. This operation may lead to database inconsistencies.
应通过导入 table 来恢复部分备份。我们不使用 `–copy-back` 选项。此操作可能会导致数据库不一致。

We do not recommend running incremental backups after taking a partial backup.
我们不建议在进行部分备份后运行增量备份。

The xtrabackup binary fails if you delete any of the matched or listed tables during the backup.
如果在备份期间删除任何匹配或列出的 table，则 xtrabackup 二进制文件将失败。

There are multiple ways of specifying which part of the whole data is backed up:
有多种方法可以指定备份整个数据的哪一部分：

- Use the `--tables` option to list the table names
  使用 `--tables` 选项列出表名
- Use the `--tables-file` option to list the tables in a file
  使用 `--tables-file` 选项列出文件中的表
- Use the `--databases` option to list the databases
  使用 `--databases` 选项列出数据库
- Use the `--databases-file` option to list the databases
  使用 `--databases-file` 选项列出数据库

The following examples assume a database named `test` that contains tables named `t1` and `t2`.
以下示例假设一个名为 `test` 的数据库包含名为 `t1` 和 `t2` 的表。

[`–-tables` option `–-tables` 选项](https://docs.percona.com/percona-xtrabackup/8.4/create-partial-backup.html#__tabbed_1_1)[`-–tables-file` option
`-–tables-file` 选项](https://docs.percona.com/percona-xtrabackup/8.4/create-partial-backup.html#__tabbed_1_2)[`--databases` option
`--databases` 选项](https://docs.percona.com/percona-xtrabackup/8.4/create-partial-backup.html#__tabbed_1_3)[`--databases-file` option
`--databases-file` 选项](https://docs.percona.com/percona-xtrabackup/8.4/create-partial-backup.html#__tabbed_1_4)

The first method involves the xtrabackup `–tables` option. The option’s value is a regular expression that is matched against the fully-qualified database name and table name using the `databasename.tablename` format.
第一种方法涉及 xtrabackup `–tables` 选项。该选项的值是一个正则表达式，它使用 `databasename.tablename` 格式与完全限定的数据库名称和表名进行匹配。

To back up only tables in the `test` database, use the following command:
要仅备份 `test` 数据库中的 table，请使用以下命令：

```
$ xtrabackup --backup --datadir=/var/lib/mysql --target-dir=/data/backups/ \
--tables="^test[.].*"
```

To back up only the `test.t1` table, use the following command:
要仅备份 `test.t1` 表，请使用以下命令：

```
$ xtrabackup --backup --datadir=/var/lib/mysql --target-dir=/data/backups/ \
--tables="^test[.]t1"
```

# Prepare a partial backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-partial-backup.html#prepare-a-partial-backup) 准备部分备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-partial-backup.html#prepare-a-partial-backup)

The procedure is analogous to restoring individual tables: apply the logs and use the `--export` option:
该过程类似于恢复单个表：应用日志并使用 `--export` 选项：

```
$ xtrabackup --prepare --export --target-dir=/path/to/partial/backup
```

When you use the `--prepare` option on a partial backup, you will see warnings about tables that don’t exist. This is because these tables exist in the data dictionary inside InnoDB, but the corresponding .ibd files don’t exist. They were not copied into the backup directory. These tables will be removed from the data dictionary, and when you restore the backup and start InnoDB, they will no longer exist and will not cause any errors or warnings to be printed to the log file.
当您在部分备份上使用 `--prepare` 选项时，您将看到有关不存在的表的警告。这是因为这些表存在于 InnoDB 内的数据字典中，但相应的 .ibd  文件不存在。它们未复制到备份目录中。这些表将从数据字典中删除，当您恢复备份并启动 InnoDB  时，它们将不再存在，并且不会导致任何错误或警告打印到日志文件中。

Could not find any file associated with the tablespace ID: 5
找不到与表空间 ID： 5 关联的任何文件

Use `--innodb-directories` to find the tablespace files. If that fails then use `-–innodb-force-recovery=1` to ignore this and to permanently lose all changes to the missing tablespace(s).
使用 `--innodb-directories` 查找表空间文件。如果失败，则使用 `-–innodb-force-recovery=1` 忽略此情况并永久丢失对缺失表空间的所有更改。

## individual partitions backup

# Create an individual partitions backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-individual-partition-backup.html#create-an-individual-partitions-backup) 创建单个分区备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/create-individual-partition-backup.html#create-an-individual-partitions-backup)

Percona XtraBackup lets you back up individual partitions because partitions are regular tables with  specially formatted names. The only requirement for this feature is to  enable the `innodb_file_per_table` option on the server.
Percona XtraBackup 允许您备份单个分区，因为分区是具有特殊格式名称的常规表。此功能的唯一要求是在服务器上启用 `innodb_file_per_table` 选项。

There is one caveat about using this kind of backup: you can not copy back the prepared backup. Restoring partial backups should be done by importing the tables.
使用这种备份需要注意一点：您不能复制回准备好的备份。应通过导入 table 来恢复部分备份。

There are three ways of specifying which part of the whole data will be backed up: regular expressions (`--tables`), enumerating the tables in a file (`--tables-file`) or providing a list of databases (`--databases`).
有三种方法可以指定要备份整个数据的哪一部分：正则表达式 （`--tables`）、枚举文件中的表 （`--tables-file`） 或提供数据库列表 （`--databases`）。

The regular expression provided to this option will be matched against the fully qualified database name and table name, in the form of `database-name.table-name`.
提供给此选项的正则表达式将与完全限定的数据库名称和表名匹配，格式为 `database-name.table-name`。

If the partition 0 is not backed up, Percona XtraBackup cannot generate a  .cfg file. MySQL 8.0 stores the table metadata in partition 0.
如果分区 0 没有备份，Percona XtraBackup 将无法生成 .cfg 文件。MySQL 8.0 将表元数据存储在分区 0 中。

For example, this operation takes a back-up of the partition `p4` from  the table `name` located in the database `imdb`:
例如，此操作从位于数据库 `imdb` 中的表`名`中备份分区 `p4`：

```
$ xtrabackup --tables=^imdb[.]name#p#p4 --backup
```

If partition 0 is not backed up, the following errors may occur:
如果未备份分区 0，则可能会出现以下错误：

<details class="example" data-immersive-translate-walked="60895447-5d5b-4304-a47c-f1aa2119abab"><summary data-immersive-translate-walked="60895447-5d5b-4304-a47c-f1aa2119abab" data-immersive-translate-paragraph="1">The error message<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">错误消息</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="60895447-5d5b-4304-a47c-f1aa2119abab"><pre><span></span><code></code></pre></div></details>

Note that this option is passed to `xtrabackup --tables` and is matched against each table of each database, the directories of each database will be created even if they are empty.
请注意，此选项会传递给 `xtrabackup --tables` 并与每个数据库的每个表进行匹配，即使每个数据库的目录为空，也会创建这些目录。

# Prepare an individual partitions backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-individual-partitions-backup.html#prepare-an-individual-partitions-backup) 准备单个分区备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/prepare-individual-partitions-backup.html#prepare-an-individual-partitions-backup)

For preparing partial backups, the procedure is analogous to restoring individual tables. Apply the logs and use xtrabackup `--export`:
对于准备部分备份，该过程类似于还原单个 table。应用日志并使用 xtrabackup `--export`：

```
$ xtrabackup --apply-log --export /mnt/backup/2012-08-28_10-29-09
```

You may see warnings in the output about tables that do not exist. This happens because InnoDB-based engines stores its data dictionary inside the tablespace files. xtrabackup removes the missing tables (those that haven’t been selected in the partial backup) from the data dictionary in order to avoid future warnings or errors.
您可能会在输出中看到有关不存在的表的警告。发生这种情况是因为基于 InnoDB 的引擎将其数据字典存储在 table 空间文件中。XtraBackup 从数据字典中删除缺失的表（那些没有在部分备份中选择的表），以避免将来的警告或错误。