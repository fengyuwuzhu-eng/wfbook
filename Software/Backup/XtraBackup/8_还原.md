# 还原

[TOC]

## Restore full, incremental, compressed backups[¶](https://docs.percona.com/percona-xtrabackup/8.4/restore-a-backup.html#restore-full-incremental-compressed-backups) 恢复完整、增量、压缩的备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/restore-a-backup.html#restore-full-incremental-compressed-backups)

Warning 警告

Backup needs to be prepared before it can be restored.
需要先准备备份，然后才能恢复。

For convenience, *xtrabackup* binary has the `--copy-back` option to copy the backup to the datadir of the server:
为方便起见，*xtrabackup* 二进制文件具有 `--copy-back` 选项，用于将备份复制到服务器的 datadir：

```
$ xtrabackup --copy-back --target-dir=/data/backups/
```

If you don’t want to save your backup, you can use the `--move-back` option which will move the backed up data to the datadir.
如果您不想保存备份，可以使用 `--move-back` 选项，该选项会将备份的数据移动到 datadir。

If you don’t want to use any of the above options, you can additionally use rsync or cp to restore the files.
如果您不想使用上述任何选项，您还可以使用 rsync 或 cp 来恢复文件。

Note 注意

The datadir must be empty before restoring the backup. Also, it’s important to note that MySQL server needs to be shut down before restore is  performed. You cannot restore to a datadir of a running mysqld instance  (except when importing a partial backup).
在恢复备份之前，datadir 必须为空。此外，请务必注意，在执行还原之前，需要关闭 MySQL 服务器。您无法恢复到正在运行的 mysqld 实例的 datadir（导入部分备份时除外）。

Example of the rsync command that can be used to restore the backup can look like this:
可用于恢复备份的 rsync 命令示例如下所示：

```
$ rsync -avrP /data/backup/ /var/lib/mysql/
```

You should check that the restored files have the correct ownership and permissions.
您应该检查恢复的文件是否具有正确的所有权和权限。

As files’ attributes are preserved, in most cases you must change the files’ ownership to `mysql` before starting the database server, as the files are owned by the user who created the backup:
由于文件的属性被保留，在大多数情况下，您必须在启动数据库服务器之前将文件的所有权更改为 `mysql`，因为这些文件归创建备份的用户所有：

```
$ chown -R mysql:mysql /var/lib/mysql
```

Data is now restored, and you can start the server.
现在，数据已还原，您可以启动服务器。

# Restore a partial backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/restore-partial-backup.html#restore-a-partial-backup) 恢复部分备份[¶](https://docs.percona.com/percona-xtrabackup/8.4/restore-partial-backup.html#restore-a-partial-backup)

Restoring should be done by restoring individual tables in the partial backup to the server.
应通过将部分备份中的单个表还原到服务器来完成还原。

It can also be done by copying back the prepared backup to a “clean” datadir (in that case, make sure to include the `mysql` database) to the datadir you are moving the backup to. A system database can be created with the following:
也可以通过将准备好的备份复制回“干净”的 datadir （在这种情况下，请确保包含 `mysql` 数据库） 到您要将备份移动到的 datadir 来完成。可以使用以下内容创建 system 数据库：

```
$ sudo mysql --initialize --user=mysql
```

Once you start the server, you may see mysql complaining about missing tablespaces:
启动服务器后，您可能会看到 mysql 抱怨缺少表空间：

<details class="example" data-immersive-translate-walked="0c04cdb8-ba45-45b1-b04a-401b716b6c4c"><summary data-immersive-translate-walked="0c04cdb8-ba45-45b1-b04a-401b716b6c4c" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="0c04cdb8-ba45-45b1-b04a-401b716b6c4c"><pre><span></span><code tabindex="0"></code></pre></div></details>

In order to clean the orphan database from the data dictionary, you must  manually create the missing database directory and then `DROP` this database from the server.
要从数据字典中清除孤立数据库，必须手动创建缺少的数据库目录，然后从服务器`中 DROP` 此数据库。

Example of creating the missing database:
创建缺失数据库的示例：

```
$ mkdir /var/lib/mysql/test1/d2
```

Example of dropping the database from the server:
从服务器中删除数据库的示例：

```
mysql> DROP DATABASE d2;
```

<details class="example" data-immersive-translate-walked="0c04cdb8-ba45-45b1-b04a-401b716b6c4c"><summary data-immersive-translate-walked="0c04cdb8-ba45-45b1-b04a-401b716b6c4c" data-immersive-translate-paragraph="1">Expected output<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">预期输出</font></font></font></summary><div class="no-copy highlight" data-immersive-translate-walked="0c04cdb8-ba45-45b1-b04a-401b716b6c4c"><pre><span></span><code></code></pre></div></details>

# Restore the partition from the backup[¶](https://docs.percona.com/percona-xtrabackup/8.4/restore-individual-partitions.html#restore-the-partition-from-the-backup) 从备份中恢复分区[¶](https://docs.percona.com/percona-xtrabackup/8.4/restore-individual-partitions.html#restore-the-partition-from-the-backup)

Restoring should be done by importing the tables in the partial backup to the server.
应通过将部分备份中的表导入到服务器来完成还原。

First step is to create new table in which data will be restored.
第一步是创建新表，在其中还原数据。

```
mysql> CREATE TABLE `name_p4` (
`id` int(11) NOT NULL AUTO_INCREMENT,
`name` text NOT NULL,
`imdb_index` varchar(12) DEFAULT NULL,
`imdb_id` int(11) DEFAULT NULL,
`name_pcode_cf` varchar(5) DEFAULT NULL,
`name_pcode_nf` varchar(5) DEFAULT NULL,
`surname_pcode` varchar(5) DEFAULT NULL,
PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2812744 DEFAULT CHARSET=utf8
```

Note 注意

Generate a [.cfg metadata file](https://dev.mysql.com/doc/refman/8.4/en/innodb-table-import.html) by running `FLUSH TABLES ... FOR EXPORT`. The command can only be run on a table, not on the individual table partitions. The file is located in the table schema directory and is used for schema verification when importing the tablespace. 
[通过运行](https://dev.mysql.com/doc/refman/8.4/en/innodb-table-import.html) `FLUSH TABLES ...用于导出`。该命令只能在表上运行，而不能在单个表分区上运行。该文件位于表 schema 目录中，用于导入 table space 时的 schema 验证。

To restore the partition from the backup, the tablespace must be discarded for that table:
要从备份中恢复分区，必须丢弃该表的表空间：

```
mysql> ALTER TABLE name_p4 DISCARD TABLESPACE;
```

The next step is to copy the `.ibd` file from the backup to the MySQL data directory:
下一步是将 `.ibd` 文件从备份复制到 MySQL 数据目录：

```
cp /mnt/backup/2012-08-28_10-29-09/imdb/name#P#p4.ibd /var/lib/mysql/imdb/name_p4.ibd
```

Note 注意

Make sure that the copied files can be accessed by the user running MySQL. 
确保运行 MySQL 的用户可以访问复制的文件。

The last step is to import the tablespace:
最后一步是导入 tablespace：

```
mysql> ALTER TABLE name_p4 IMPORT TABLESPACE;
```