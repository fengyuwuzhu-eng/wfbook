# Scaling Jenkins 扩展 Jenkins

Chapter Sub-Sections 章节小节

- [ Architecting for Scale  为规模而构建](https://www.jenkins.io/doc/book/scaling/architecting-for-scale)
- [ Hardware Recommendations  硬件建议](https://www.jenkins.io/doc/book/scaling/hardware-recommendations)
- [ Architecting for Manageability 
  为可管理性构建架构](https://www.jenkins.io/doc/book/scaling/architecting-for-manageability)
- [ Scaling Jenkins on Kubernetes 
  在 Kubernetes 上扩展 Jenkins](https://www.jenkins.io/doc/book/scaling/scaling-jenkins-on-kubernetes)

This chapter covers topics related to using and managing large scale Jenkins configurations: large numbers of users, nodes, agents, folders, projects, concurrent jobs, job results and logs, and even large numbers of Jenkins controllers.
本章涵盖与使用和管理大规模 Jenkins 配置相关的主题：大量用户、节点、代理、文件夹、项目、并发作业、作业结果和日志，甚至大量 Jenkins 控制器。

The audience for this chapter is expert Jenkins users, administrators, and those planning large-scale installations.
本章的读者是 Jenkins 专家用户、管理员和计划大规模安装的用户。

If you are a Jenkins administrator and want to know more about managing Jenkins nodes and controllers, see [Managing Jenkins](https://www.jenkins.io/doc/book/managing/).
如果您是 Jenkins 管理员，并且想要了解有关管理 Jenkins 节点和控制器的更多信息，请参阅[管理 Jenkins](https://www.jenkins.io/doc/book/managing/)。

For an overview of content in the Jenkins User Handbook, see [User Handbook Overview](https://www.jenkins.io/doc/book/getting-started/).
有关 Jenkins 用户手册中内容的概述，请参阅[用户手册概述](https://www.jenkins.io/doc/book/getting-started/)。

# Architecting for Scale 为规模而构建

Table of Contents 目录

- [Introduction 介绍](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#introduction)
- Distributed Builds Architecture
  分布式构建架构
  - [Agent communications 代理通信](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#agent-communications)
- Creating fungible agents 创建可替代的试剂
  - [Configuring tools location on agents
    在代理上配置工具位置](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#configuring-tools-location-on-agents)
  - [Define a policy to share agent machines
    定义共享代理计算机的策略](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#define-a-policy-to-share-agent-machines)
  - [Setting up cloud agents 设置云代理](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#setting-up-cloud-agents)
- Right-sizing Jenkins controllers
  合理调整 Jenkins 控制器的大小
  - [Controller division strategies
    控制器划分策略](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#master-division-strategies)
  - [Calculating how many jobs, controllers, and executors are needed
    计算需要多少个 job、controller 和 executor](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#Calculating-how-many-jobs)
  - [Scalable storage for controllers
    控制器的可扩展存储](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#scalable-storage-for-master)
- Setting up a backup policy
  设置备份策略
  - [Finding your $JENKINS_HOME
    寻找您的 $JENKINS_HOME](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#finding-your-jenkins_home)
  - [Anatomy of a $JENKINS_HOME
    $JENKINS_HOME 剖析](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#anatomy-of-a-jenkins_home)
  - [Choosing a backup strategy
    选择备份策略](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#choosing-a-backup-strategy)
  - [Define a Jenkins controller to rollback to
    定义要回滚到的 Jenkins 控制器](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#define-a-jenkins-controller-to-rollback-to)
- [Resilient Jenkins Architecture
  弹性 Jenkins 架构](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#resilient-jenkins-architecture)

## Introduction 介绍

As an organization matures from a continuous delivery standpoint, its Jenkins requirements will similarly grow. This growth is often reflected in the Jenkins architecture, whether that be "vertical" or "horizontal" growth.
从持续交付的角度来看，随着组织的成熟，其 Jenkins 要求也将同样增长。这种增长通常反映在 Jenkins 架构中，无论是“垂直”还是“水平”增长。

**Vertical growth** is when the load on a Jenkins controller load is increased by having more configured jobs or orchestrating more frequent builds. This may also mean that more teams are depending on that one controller.
**垂直增长**是指通过配置更多作业或编排更频繁的构建来增加 Jenkins 控制器负载上的负载。这也可能意味着更多的团队依赖于这个控制器。

**Horizontal** growth is the creation of additional Jenkins controllers to accommodate new teams or projects, rather than adding new teams or projects to an existing controller.
**水平**增长是创建额外的 Jenkins 控制器来适应新的团队或项目，而不是向现有控制器添加新的团队或项目。

There are potential pitfalls associated with each approach to scaling Jenkins, but with careful planning, many of them can be avoided or managed. Here are some things to consider when choosing a strategy for scaling your organization’s Jenkins controllers:
每种扩展 Jenkins 的方法都存在潜在的陷阱，但通过仔细规划，可以避免或管理其中的许多陷阱。以下是在选择扩展组织的 Jenkins 控制器的策略时需要考虑的一些事项：

- **Do you have the resources to run a distributed build system?** If possible, it is recommended set up dedicated build nodes that run separately from the Jenkins controller. This frees up resources for the controller to improve its scheduling performance and prevents builds from being able to modify any potentially sensitive data in the *$JENKINS_HOME*. This also allows for a single controller to scale far more vertically than if that controller were both the job builder and scheduler.
  **您是否有足够的资源来运行分布式生成系统？**如果可能，建议设置独立于 Jenkins 控制器运行的专用构建节点。这为控制器释放了资源以提高其调度性能，并防止构建能够修改 *$JENKINS_HOME* 中的任何潜在敏感数据。这也允许单个控制器比该控制器同时是作业生成器和调度程序时更垂直地扩展。
- **Do you have the resources to maintain multiple controllers?** Jenkins controllers require regular plugin updates, semi-monthly core upgrades, and regular backups of configurations and build histories. Security settings and roles will have to be manually configured for each controller. Downed controllers will require manual restart of the Jenkins controller and any jobs that were killed by the outage.
  **您是否有足够的资源来维护多个控制器？**Jenkins 控制器需要定期更新插件、半月一次核心升级以及定期备份配置和构建历史。必须为每个控制器手动配置安全设置和角色。关闭的控制器将需要手动重启 Jenkins 控制器和因中断而终止的任何作业。
- **How mission critical are each team’s projects?** Consider segregating the most vital projects to separate controllers to minimize the impact of a single downed controller. Also consider converting any mission-critical project pipelines to Pipeline jobs, which continue executing even when the agent connection to the controller is lost.
  **每个团队的项目对任务的重要性如何？**考虑将最重要的项目隔离到单独的控制器，以最大程度地减少单个控制器停机的影响。此外，请考虑将任何任务关键型项目管道转换为 Pipeline 作业，即使代理与控制器的连接丢失，这些作业也会继续执行。
- **How important is a fast start-up time for your Jenkins controller?** The more jobs a controller has configured, the longer it takes to load Jenkins after an upgrade or a crash. The use of folders and views to organize jobs can limit the number of that need to be rendered on start up.
  **快速启动时间对您的 Jenkins 控制器有多重要？**控制器配置的作业越多，升级或崩溃后加载 Jenkins 所需的时间就越长。使用文件夹和视图来组织作业可以限制启动时需要渲染的作业数量。

## Distributed Builds Architecture 分布式构建架构

A Jenkins controller can operate by itself both managing the build environment and executing the builds with its own executors and resources. If you stick with this "standalone" configuration you will most likely run out of resources when the number or the load of your projects increase.
Jenkins 控制器可以自行运行，既可以管理构建环境，也可以使用自己的执行程序和资源执行构建。如果您坚持使用这种 “独立” 配置，那么当项目的数量或负载增加时，您很可能会耗尽资源。

To come back up and running with your Jenkins infrastructure you will need to enhance the controller (increasing memory, number of CPUs, etc). The time it takes to maintain and upgrade the machine, the controller together with all the build environment will be down, the jobs will be stopped and the whole Jenkins infrastructure will be unusable.
要重新启动并运行 Jenkins 基础设施，您需要增强控制器（增加内存、CPU 数量等）。维护和升级机器、控制器和所有构建环境所需的时间将关闭，作业将停止，整个 Jenkins 基础设施将无法使用。

Scaling Jenkins in such a scenario would be extremely painful and would introduce many "idle" periods where all the resources assigned to your build environment are useless.
在这种情况下扩展 Jenkins 将非常痛苦，并且会引入许多“空闲”期，其中分配给构建环境的所有资源都毫无用处。

Moreover, executing jobs on the controller introduces a "security" issue: the "jenkins" user that Jenkins uses to run the jobs would have full permissions on all Jenkins resources on the controller. This means that, with a simple script, a malicious user can have direct access to private information whose integrity and privacy could not be, thus,  guaranteed. See [Distributed Builds](https://www.jenkins.io/doc/book/security/controller-isolation/) in the [Securing Jenkins](https://www.jenkins.io/doc/book/security/) chapter for more information.
此外，在控制器上执行作业会引入一个“安全”问题：Jenkins 用于运行作业的“jenkins”用户将对控制器上的所有 Jenkins  资源拥有完全权限。这意味着，通过一个简单的脚本，恶意用户可以直接访问私人信息，而这些信息的完整性和隐私性无法得到保证。有关更多信息，请参阅[保护 Jenkins](https://www.jenkins.io/doc/book/security/) 一章中的 [分布式构建](https://www.jenkins.io/doc/book/security/controller-isolation/)。

For all these reasons Jenkins supports agents, where the workload of building projects are delegated to multiple agents.
出于所有这些原因，Jenkins 支持代理，其中构建项目的工作负载被委派给多个代理。

An agent is a machine set up to offload projects from the controller. The method with which builds are scheduled depends on the configuration given to each project. For example, some projects may be configured to "restrict where this project is run" which ties the project to a specific agent or set of labeled agents. Other projects which omit this configuration will select an agent from the available pool in Jenkins. Learn more about Agents in [Managing Nodes](https://www.jenkins.io/doc/book/managing/nodes/#creating-agents/)
代理是设置为从控制器卸载项目的机器。计划构建的方法取决于为每个项目提供的配置。例如，某些项目可能配置为 “限制此项目的运行位置” ，这会将项目绑定到一个特定的代理程序或一组标记的代理程序。省略此配置的其他项目将从 Jenkins  中的可用池中选择一个代理。在[管理节点](https://www.jenkins.io/doc/book/managing/nodes/#creating-agents/)中了解有关代理的更多信息

In a distributed builds environment, the Jenkins controller will use its resources to only handle HTTP requests and manage the build environment. Actual execution of builds will be delegated to the agents. With this configuration it is possible to horizontally scale an architecture, which allows a single Jenkins installation to host a large number of projects and build environments.
在分布式构建环境中，Jenkins 控制器将仅使用其资源来处理 HTTP 请求和管理构建环境。构建的实际执行将委托给代理。使用此配置，可以水平扩展架构，从而允许单个 Jenkins 安装托管大量项目和构建环境。

### Agent communications 代理通信

In order for a machine to be recognized as an agent, it needs to run a specific agent program to establish bi-directional communication with the controller.
为了使机器被识别为代理，它需要运行一个特定的代理程序来与控制器建立双向通信。

There are different ways to establish a connection between controller and agent:
有多种方法可以在 controller 和 agent 之间建立连接：

- **The SSH connector**: Configuring an agent to use the SSH connector is the preferred and the most stable way to establish controller-agent communication. Jenkins has a built-in SSH client implementation. This means that the Jenkins controller can easily communicate with any machine with an SSH server installed. The only requirement is that the public key of the controller is part of the set of the authorized keys on the agent. Once the host and SSH key is defined for a new agent, Jenkins will establish a connection to the machine and bootstrap the agent process.
  **SSH 连接器**：将代理配置为使用 SSH 连接器是建立控制器与代理通信的首选且最稳定的方式。Jenkins 具有内置的 SSH 客户端实现。这意味着 Jenkins  控制器可以轻松地与任何安装了 SSH 服务器的计算机通信。唯一的要求是控制器的公钥是代理上授权密钥集的一部分。为新代理定义主机和 SSH  密钥后，Jenkins 将建立与计算机的连接并引导代理进程。

- **The inbound connector**: In this case the communication is established starting the agent through a connection initiated by an agent program. With this connector the agent is launched in the machine in 2 different ways:
  **入站连接器**：在这种情况下，将通过代理程序启动的连接来建立通信。使用此连接器，代理可以通过 2 种不同的方式在机器中启动：
  1. Manually: by navigating to the Jenkins controller URL in a browser on the agent. Once the Java Web Start icon is clicked, the agent will be launched on the machine. The downside of this approach is that the agents cannot be centrally managed by the Jenkins controller and each/stop/start/update of the agent needs to be executed manually on the agent’s machine in versions of Jenkins older than 1.611. This approach is convenient when the controller cannot instantiate the connection with the client, for example: with agents running inside a firewalled network connecting to a controller located outside the firewall.
     手动：通过导航到代理上浏览器中的 Jenkins 控制器 URL。单击 Java Web Start 图标后，代理将在计算机上启动。这种方法的缺点是代理不能由 Jenkins  控制器集中管理，并且代理的每个/停止/启动/更新都需要在低于 1.611 的 Jenkins  版本的代理计算机上手动执行。当控制器无法实例化与客户端的连接时，此方法非常方便，例如：在防火墙网络内运行的代理连接到位于防火墙外部的控制器。
  2. As a service: First you’ll need to manually launch the agent using the above method. After manually launching it, *jenkins-slave.exe* and *jenkins-slave.xml* will be created in the agent’s work directory. Now go to the command line to execute the following command:
     作为服务：首先，您需要使用上述方法手动启动代理。手动启动后，将在代理的工作目录中创建*jenkins-slave.exe*和*jenkins-slave.xml*。现在转到命令行以执行以下命令：

```
sc.exe create "<serviceKey>" start= auto binPath= "<path to jenkins-slave.exe>" DisplayName= "<service display name>"
```

*<serviceKey>* is the name of the registry key to define this agent service and <service display name> is the label that will identify the service in the Service Manager interface.
*<serviceKey>* 是用于定义此代理服务的注册表项的名称，并且是将在 Service Manager 界面中标识服务的标签。

To ensure that restarts are automated, you will need to download a recent  agent jar and copy it to a permanent location on the machine. The_.jar_ file can be found at:
要确保自动重新启动，您需要下载最近的代理 jar 并将其复制到计算机上的永久位置。The_.jar_ 文件可以在以下位置找到：

```
http://<your-jenkins-host>/jnlpJars/agent.jar
```

If running a version of Jenkins newer than 1.559, the *.jar* will be kept up to date each time it connects to the controller.
如果运行的 Jenkins 版本高于 1.559，*则 .jar* 将在每次连接到控制器时保持最新。

- **The Inbound-HTTP connector**: This approach is quite similar to the Inbound-TCP Java Web Start approach, with the difference in this case being that the agent is executed as headless and the connection can be tunneled via HTTP(s). The exact command can be found on your Inbound agent’s configuration page:
  **入站 HTTP 连接器**：这种方法与入站 TCP Java Web Start 方法非常相似，在这种情况下的不同之处在于代理以无头方式执行，并且可以通过 HTTP（s） 通过隧道连接。确切的命令可以在 Inbound agent 的配置页面上找到：

![Inbound agent node screen](https://www.jenkins.io/doc/book/resources/hardware-recommendations/inbound-agent.png)

Figure 1. Inbound agent launch command
图 1.入站代理启动命令

This approach is convenient for an execution as a daemon on Unix.
这种方法便于在 Unix 上作为守护进程执行。

- **Custom-script**: It is also possible to create a custom script to initialize the communication between controller and agent if the other solutions do not provide enough flexibility for a specific use-case. The only requirement is that the script runs the java program as a *java -jar agent.jar* on the agent.
  **自定义脚本**：如果其他解决方案不能为特定用例提供足够的灵活性，也可以创建自定义脚本来初始化控制器和代理之间的通信。唯一的要求是脚本在代理上将 java 程序作为 *java -jar agent.jar*运行。

Windows agent set-up can follow the standard SSH and inbound agent approaches. Windows agents have the following options:
Windows 代理设置可以遵循标准的 SSH 和入站代理方法。Windows 代理程序有以下选项：

- **SSH-connector approach with Putty
  带 Putty 的 SSH 连接器方法**
- **SSH-connector approach with Cygwin and OpenSSH**: [This](https://wiki.jenkins.io/display/JENKINS/SSH+slaves+and+Cygwin) is the easiest to setup and recommended approach.
  **使用 Cygwin 和 OpenSSH 的 SSH 连接器方法**：[这是](https://wiki.jenkins.io/display/JENKINS/SSH+slaves+and+Cygwin)最容易设置和推荐的方法。
- **SSH-connector approach with Microsoft OpenSSH**: The [Microsoft OpenSSH server](https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse) works well for Microsoft operating systems that support the server. Refer to installation instructions in the [ssh build agents configuration guide](https://github.com/jenkinsci/ssh-slaves-plugin/blob/master/doc/CONFIGURE.md#launch-windows-agents-using-microsoft-openssh).
  **使用 Microsoft OpenSSH 的 SSH 连接器方法**：[Microsoft OpenSSH 服务器](https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse)适用于支持该服务器的 Microsoft 操作系统。请参阅 [ssh 生成代理配置指南](https://github.com/jenkinsci/ssh-slaves-plugin/blob/master/doc/CONFIGURE.md#launch-windows-agents-using-microsoft-openssh)中的安装说明。
- **Inbound agent approach**: With [this approach](https://wiki.jenkins.io/display/JENKINS/Installing+Jenkins+as+a+Windows+service) it is possible to manually register the agent as Windows service, but it will not be possible to centrally manage it from the controller. Each stop/start/update of the agent needs to be executed manually on the agent machine, unless running Jenkins 1.611 or newer.
  **入站代理方法**：使用[这种方法](https://wiki.jenkins.io/display/JENKINS/Installing+Jenkins+as+a+Windows+service)，可以手动将代理注册为 Windows 服务，但无法从控制器集中管理它。代理的每次停止/启动/更新都需要在代理计算机上手动执行，除非运行的是 Jenkins 1.611 或更高版本。

## Creating fungible agents 创建可替代的试剂

### Configuring tools location on agents 在代理上配置工具位置

The Jenkins Global configuration page lets you specify the tools needed during the builds (i.e. Ant, Maven, Java, etc).
Jenkins 全局配置页面允许您指定构建期间所需的工具（即 Ant、Maven、Java 等）。

When defining a tool, it is possible to create a pointer to an existing installation by giving the directory where the program is expected to be on the agent. Another option is to let Jenkins take care of the installation of a specific version in the given location. It is also possible to specify more than one installation for the same tool since different jobs may need different versions of the same tool.
定义工具时，可以通过提供程序在代理上预期所在的目录来创建指向现有安装的指针。另一种选择是让 Jenkins 负责在给定位置安装特定版本。也可以为同一工具指定多个安装，因为不同的作业可能需要同一工具的不同版本。

The pre-compiled "Default" option calls whatever is already installed on the agent and exists in the machine PATH, but this returns a failure if the tool is not installed and its location was not added to the PATH system variable.
预编译的 “Default” 选项调用代理上已安装且存在于计算机 PATH 中的任何内容，但如果未安装该工具且其位置未添加到 PATH 系统变量中，则会返回失败。

One best practice to avoid this failure is to configure a job with the assumption that the target agent does not have the necessary tools installed, and to include the tools' installation as part of the build process.
避免此失败的一种最佳实践是，在假设目标代理未安装必要工具的情况下配置作业，并将这些工具的安装作为构建过程的一部分包括在内。

### Define a policy to share agent machines 定义共享代理计算机的策略

As mentioned previously, agents should be interchangeable and standardized in order to make them sharable and to optimize resource usage.  Agents should not be customized for a particular set of jobs, nor for a particular team.
如前所述，代理应该是可互换的和标准化的，以便使它们可共享并优化资源使用。不应为一组特定的作业或特定团队自定义代理。

Lately Jenkins has become more and more popular not only in CI but also in CD, which means that it must orchestrate jobs and pipelines which involve different teams and technical profiles: developers, QA people and Dev-Ops people.
最近，Jenkins 不仅在 CI 领域越来越受欢迎，而且在 CD 领域也越来越受欢迎，这意味着它必须编排涉及不同团队和技术配置文件的工作和管道：开发人员、QA 人员和 Dev-Ops 人员。

In such a scenario, it might make sense to create customized and dedicated agents: different tools are usually required by different teams (i.e. Puppet/Chef for the Ops team) and teams' credentials are usually stored on the agent in order to ensure their protection and privacy.
在这种情况下，创建自定义和专用代理可能是有意义的：不同的团队通常需要不同的工具（例如，Ops 团队的 Puppet/Chef），并且团队的凭据通常存储在代理上，以确保他们的保护和隐私。

In order to ensure the execution of a job on a single/group of agents only (i.e. iOS builds on OSX agents only), it is possible to tie the job to the agent by specifying the agent’s label in the job configuration page. Note that the restriction has to be replicated in every single job to be tied and that the agent won’t be protected from being used by other teams.
为了确保仅在单个/一组代理上执行作业（即 iOS 仅在 OSX 代理上构建），可以通过在作业配置页面中指定代理的标签来将作业绑定到代理。请注意，必须在每个作业中复制限制才能绑定，并且不会保护代理被其他团队使用。

### Setting up cloud agents 设置云代理

Cloud build resources can be a solution for a case when it is necessary to maintain a reasonably small cluster of agents on-premises while still providing new build resources when needed.
云构建资源可以成为一种解决方案，适用于需要在本地维护一个相当小的代理集群，同时仍在需要时提供新的构建资源的情况。

In particular it is possible to offload the execution of the jobs to agents in the cloud thanks to ad-hoc plugins which will handle the creation of the cloud resources together with their destruction when they are not needed anymore:
特别是，由于 ad-hoc 插件，可以将作业的执行卸载到云中的代理，这些插件将处理云资源的创建以及不再需要时它们的销毁：

- The [EC2 Plugin](https://plugins.jenkins.io/ec2) lets Jenkins use AWS EC2 instances as cloud build resources when it runs out of on-premises agents. The EC2 agents will be dynamically created inside an AWS network and de-provisioned when they are not needed.
  [EC2 插件](https://plugins.jenkins.io/ec2)允许 Jenkins 在本地代理用完时使用 AWS EC2 实例作为云构建资源。EC2 代理将在 AWS 网络内动态创建，并在不需要时取消预置。
- The [Azure VM Agents Plugin](https://plugins.jenkins.io/azure-vm-agents) dynamically spins up Jenkins agents as Azure VMs per user provided configuration via templates, including support for virtual network integration and subnet placement. Idle agents can be configured for automatic shutdown to reduce costs.
  [Azure VM 代理插件](https://plugins.jenkins.io/azure-vm-agents)通过模板将 Jenkins 代理动态启动为每个用户提供的 Azure VM 配置，包括对虚拟网络集成和子网放置的支持。可以将空闲代理配置为自动关闭以降低成本。
- The [JCloud plugin](https://plugins.jenkins.io/jclouds-jenkins) creates the possibility of executing the jobs on any cloud provider supported by JCloud libraries
  [JCloud 插件](https://plugins.jenkins.io/jclouds-jenkins)创造了在 JCloud 库支持的任何云提供商上执行作业的可能性

## Right-sizing Jenkins controllers 合理调整 Jenkins 控制器的大小

Comprehensive hardware recommendations:
全面的硬件建议：

- Hardware: see the [Hardware Recommendations](https://www.jenkins.io/doc/book/hardware-recommendations/#hardware-recommendations) page
  硬件：请参阅[硬件建议](https://www.jenkins.io/doc/book/hardware-recommendations/#hardware-recommendations)页面

### Controller division strategies 控制器划分策略

Designing the best Jenkins architecture for your organization is dependent on how you stratify the development of your projects and can be constrained by limitations of the existing Jenkins plugins.
为您的组织设计最佳的 Jenkins 架构取决于您如何分层项目开发，并且可能会受到现有 Jenkins 插件的限制。

The 3 most common forms of stratifying development by controllers is:
控制器分层开发的 3 种最常见形式是：

1. **By environment (QA, DEV, etc)** - With this strategy, Jenkins controllers are populated by jobs based on what environment they are deploying to.
   **按环境（QA、DEV 等）**- 使用此策略，Jenkins 控制器根据它们要部署到的环境由作业填充。
   - **Pros 优点**
     - Can tailor plugins on controllers to be specific to that environment’s needs
       可以定制控制器上的插件以特定于该环境的需求
     - Can easily restrict access to an environment to only users who will be using that environment
       可以轻松地将对环境的访问限制为仅使用将使用该环境的用户
   - **Cons 缺点**
     - Reduces ability to create pipelines
       降低创建管道的能力
     - No way to visualize the complete flow across controllers
       无法可视化控制器之间的完整流程
     - Outage of a controller will block flow of all products
       控制器中断将阻止所有产品的流动
2. **By org chart** - This strategy is when controllers are assigned to divisions within an organization.
   **按组织结构图** - 此策略是指将控制器分配给组织内的部门。
   - **Pros 优点**
     - Can tailor plugins on controllers to be specific to that team’s needs
       可以定制控制器上的插件以特定于该团队的需求
     - Can easily restrict access to a division’s projects to only users who are within that division
       可以轻松地将对部门项目的访问限制为仅该部门内的用户
   - **Cons 缺点**
     - Reduces ability to create cross-division pipelines
       降低创建跨部门管道的能力
     - No way to visualize the complete flow across controllers
       无法可视化控制器之间的完整流程
     - Outage of a controller will block flow of all products
       控制器中断将阻止所有产品的流动
3. **Group controllers by product lines** - When a group of products, with on only critical product in each group, gets its own Jenkins controllers.
   **按产品线对控制器进行分组** - 当一组产品（每组中仅包含关键产品）获得自己的 Jenkins 控制器时。
   - **Pros 优点**
     - Entire flows can be visualized because all steps are on one controller
       整个流程可以可视化，因为所有步骤都在一个控制器上
     - Reduces the impact of one controller’s downtime on only affects a small subset of products
       减少一个控制器停机时间对仅影响一小部分产品的影响
   - **Cons 缺点**
     - A strategy for restricting permissions must be devised to keep all users from having access to all items on a controller.
       必须设计一种限制权限的策略，以防止所有用户访问控制器上的所有项目。

When evaluating these strategies, it is important to weigh them against the vertical and horizontal scaling pitfalls discussed in the introduction.
在评估这些策略时，重要的是要权衡它们与引言中讨论的垂直和水平扩展陷阱。

Another note is that a smaller number of jobs translates to faster recovery from failures and more importantly a higher mean time between failures.
另一个注意事项是，作业数量越少，从故障中恢复的速度就越快，更重要的是，故障之间的平均间隔时间更长。

### Calculating how many jobs, controllers, and executors are needed 计算需要多少个 job、controller 和 executor

Having the best possible estimate of necessary configurations for a Jenkins installation allows an organization to get started on the right foot with Jenkins and reduces the number of configuration iterations needed to achieve an optimal installation. The challenge for Jenkins architects is that true limit of vertical scaling on a Jenkins controller is constrained by whatever hardware is in place for the controller, as well as harder to quantify pieces like the types of builds and tests that will be run on the build nodes.
对 Jenkins 安装的必要配置进行最佳估计，使组织能够正确地开始使用 Jenkins，并减少实现最佳安装所需的配置迭代次数。Jenkins  架构师面临的挑战是，Jenkins  控制器上垂直扩展的真正限制受到控制器的任何硬件的限制，并且更难量化，例如将在构建节点上运行的构建和测试的类型。

There is a way to estimate roughly how many controllers, jobs and executors will be needed based on build needs and number of developers served. These equations assume that the Jenkins controller will have 5 cores with one core per 100 jobs (500 total jobs/controller) and that teams will be divided into groups of 40.
有一种方法可以根据构建需求和服务的开发人员数量来大致估计需要多少个 controller、job 和 executor。这些方程式假设 Jenkins 控制器将有 5 个内核，每 100  个作业有一个内核（每个控制器总共 500 个作业），并且团队将被分成 40 个团队的小组。

If you have information on the actual number of available cores on your planned controller, you can make adjustments to the "number of controllers" equations accordingly.
如果您有有关计划控制器上实际可用内核数的信息，则可以相应地调整 “number of controllers” 方程式。

The equation for **estimating the number of controllers and executors needed** when the number of configured jobs is known is as follows:
当已配置的作业数量已知时，**用于估计所需的 controller 和 executor 数量的**公式如下：

```
controllers = number of jobs/500
executors = number of jobs * 0.03
```

The equation for **estimating the maximum number of jobs, controllers, and executors needed** for an organization based on the number of developers is as follows:
根据开发人员的数量**估计组织所需的最大作业、控制器和执行程序数量的**公式如下：

```
number of jobs = number of developers * 3.333
number of controllers = number of jobs/500
number of executors = number of jobs * 0.03
```

These numbers will provide a good starting point for a Jenkins installation, but adjustments to actual installation size may be needed based on the types of builds and tests that an installation runs.
这些数字将为 Jenkins 安装提供一个很好的起点，但可能需要根据安装运行的构建和测试类型调整实际安装大小。

### Scalable storage for controllers 控制器的可扩展存储

It is also recommended to choose a controller with consideration for future growth in the number of plugins or jobs stored in your controller’s *$JENKINS_HOME*. Storage is cheap and Jenkins does not require fast disk access to run well, so it is more advantageous to invest in a larger machine for your controller over a faster one.
此外，建议在选择控制器时考虑到控制器 *$JENKINS_HOME* 中存储的插件或作业数量的未来增长。存储成本低廉，而且 Jenkins 不需要快速的磁盘访问即可正常运行，因此为控制器投资更大的机器比投资更快的机器更有利。

Different operating systems for the Jenkins controller will also allow for different approaches to expandable storage:
Jenkins 控制器的不同操作系统也允许采用不同的方法来扩展存储：

- **Spanned Volumes on Windows** - On NTFS devices like Windows, you can create a spanned volume that allows you to add new volumes to an existing one, but have them behave as a single volume. To do this, you will have to ensure that Jenkins is installed on a separate partition so that it can be converted to a spanned volume later.
  **Windows 上的跨区卷** - 在 Windows 等 NTFS 设备上，您可以创建一个跨区卷，该卷允许您将新卷添加到现有卷，但让它们作为单个卷运行。为此，您必须确保 Jenkins 安装在单独的分区上，以便以后可以将其转换为跨区卷。
- **Logical Volume Manager for Linux** - LVM manages disk drives and allows logical volumes to be resized on the fly. Many distributions of Linux use LVM when they are installed, but Jenkins should have its own LVM setup.
  **适用于 Linux 的逻辑卷管理器** - LVM 管理磁盘驱动器并允许动态调整逻辑卷的大小。许多 Linux 发行版在安装时使用 LVM，但 Jenkins 应该有自己的 LVM 设置。
- **ZFS for Solaris** - ZFS is even more flexible than LVM and spanned volumes and just requires that the *$JENKINS_HOME* be on its own filesystem. This makes it easier to create snapshots, backups, etc.
  **ZFS for Solaris** - ZFS 甚至比 LVM 和跨区卷更灵活，并且只要求 *$JENKINS_HOME* 位于其自己的文件系统上。这使得创建快照、备份等变得更加容易。
  - For systems with an existing Jenkins installation, there are at least two options:
    对于已安装 Jenkins 的系统，至少有两个选项：
    - The System Property [jenkins.model.Jenkins.buildsDir](https://www.jenkins.io/doc/book/managing/system-properties/#jenkins-model-jenkins-buildsdir)
      系统属性 [jenkins.model.Jenkins.buildsDir](https://www.jenkins.io/doc/book/managing/system-properties/#jenkins-model-jenkins-buildsdir)
    - **Symbolic Links** (symlinks) may be used instead to store job folders on separate volumes with symlinks to those directories.
      符号**链接**（符号链接）可用于将作业文件夹存储在单独的卷上，并带有指向这些目录的符号链接。

Additionally, to easily prevent a *$JENKINS_HOME* folder from becoming bloated, make it mandatory for jobs to discard build records after a specific time period has passed and/or after a specific number of builds have been run. This policy can be set on a job’s configuration page.
此外，为了轻松防止 *$JENKINS_HOME* 文件夹变得臃肿，请强制要求作业在经过特定时间段和/或运行特定数量的构建后丢弃构建记录。可以在作业的配置页面上设置此策略。

## Setting up a backup policy 设置备份策略

It is a best practice to take regular backups of your $JENKINS_HOME. A backup ensures that your Jenkins controller can be restored despite a misconfiguration, accidental job deletion, or data corruption. See the [Backup policies](https://www.jenkins.io/doc/book/system-administration/backing-up/) for more details.
最佳做法是定期备份 $JENKINS_HOME。备份可确保在配置错误、作业意外删除或数据损坏的情况下，您的 Jenkins 控制器可以恢复。有关更多详细信息，请参阅[备份策略](https://www.jenkins.io/doc/book/system-administration/backing-up/)。

### Finding your $JENKINS_HOME 寻找您的 $JENKINS_HOME

**Windows 窗户**

If you install Jenkins with the Windows installer, Jenkins is installed as a service and the default *$JENKINS_HOME* will be "C:\Program Files (x86)\jenkins". You can edit the location of your *$JENKINS_HOME* by opening the jenkins.xml file and editing the *$JENKINS_HOME* variable, or going to the "Manage Jenkins" screen, clicking on the "Install as Windows Service" option in the menu, and then editing the "Installation Directory" field to point to another existing directory.
如果使用 Windows 安装程序安装 Jenkins，则 Jenkins 将作为服务安装，默认 *$JENKINS_HOME* 将为“C：\Program Files （x86）\jenkins”。您可以通过打开 jenkins.xml 文件并编辑 *$JENKINS_HOME* 变量，或者转到“管理 Jenkins”屏幕，单击菜单中的“安装为 Windows 服务”选项，然后编辑“安装目录”字段以指向另一个现有目录来编辑 *$JENKINS_HOME* 的位置。

**Mac OSX**

If you install Jenkins with the OS X installer, you can find and edit the location of your *$JENKINS_HOME* by editing the "Macintosh HD/Library/LaunchDaemons" file’s *$JENKINS_HOME* property.
如果使用 OS X 安装程序安装 Jenkins，则可以通过编辑“Macintosh HD/Library/LaunchDaemons”文件的 *$JENKINS_HOME* 属性来查找和编辑 *$JENKINS_HOME* 的位置。

By default, the *$JENKINS_HOME* will be set to "Macintosh HD/Users/Shared/Jenkins".
默认情况下，*$JENKINS_HOME* 将设置为 “Macintosh HD/Users/Shared/Jenkins”。

**Linux Linux的**

By default, `$JENKINS_HOME` is set to `/var/lib/jenkins` and `$JENKINS_WAR` is set to `/usr/share/java/jenkins.war`.
默认情况下，`$JENKINS_HOME` 设置为 `/var/lib/jenkins`，`$JENKINS_WAR` 设置为 `/usr/share/java/jenkins.war`。

You can edit the location of `$JENKINS_HOME` by running `systemctl edit jenkins` and adding the following:
您可以通过运行 `systemctl edit jenkins` 并添加以下内容来编辑 `$JENKINS_HOME` 的位置：

```
[Service]
Environment="HOME=/var/lib/jenkins"
Environment="JENKINS_HOME=/var/lib/jenkins"
WorkingDirectory=/var/lib/jenkins
```

You can edit the location of `$JENKINS_WAR` by running `systemctl edit jenkins` and adding the following:
您可以通过运行 `systemctl edit jenkins` 并添加以下内容来编辑 `$JENKINS_WAR` 的位置：

```
[Service]
Environment="JENKINS_WAR=/usr/share/java/jenkins.war"
```

**FreeBSD FreeBSD 软件**

If installing Jenkins using a port, the *$JENKINS_HOME* will be located in whichever directory you run the "make" command in. It is recommended to create a "/usr/ports/devel/jenkins" folder and compile Jenkins in that directory.
如果使用端口安装 Jenkins，*则 $JENKINS_HOME* 将位于您运行 “make” 命令的任何目录中。建议创建一个 “/usr/ports/devel/jenkins” 文件夹并在该目录中编译 Jenkins。

You will be able to edit the *$JENKINS_HOME* by editing the "/usr/local/etc/jenkins".
您将能够通过编辑 “/usr/local/etc/jenkins” 来编辑 *$JENKINS_HOME*。

**OpenBSD OpenBSD 的**

If installing Jenkins using a package,the *$JENKINS_HOME* is set by default to "/var/jenkins".
如果使用软件包安装 Jenkins，*则 $JENKINS_HOME* 默认设置为 “/var/jenkins”。

If installing Jenkins using a port, the *$JENKINS_HOME* will be located in whichever directory you run the "make" command in. It is recommended to create a "/usr/ports/devel/jenkins" folder and compile Jenkins in that directory.
如果使用端口安装 Jenkins，*则 $JENKINS_HOME* 将位于您运行 “make” 命令的任何目录中。建议创建一个 “/usr/ports/devel/jenkins” 文件夹并在该目录中编译 Jenkins。

You will be able to edit the *$JENKINS_HOME* by editing the "/usr/local/etc/jenkins" file.
您将能够通过编辑 “/usr/local/etc/jenkins” 文件来编辑 *$JENKINS_HOME*。

**Solaris/OpenIndiana 索拉里斯/OpenIndiana**

The Jenkins project voted on September 17, 2014 to discontinue Solaris packages.
Jenkins 项目于 2014 年 9 月 17 日投票决定停止使用 Solaris 软件包。

### Anatomy of a $JENKINS_HOME $JENKINS_HOME 剖析

The folder structure for a *$JENKINS_HOME* directory is as follows:
*$JENKINS_HOME* 目录的文件夹结构如下：

```
JENKINS_HOME
 +- config.xml     (Jenkins root configuration file)
 +- *.xml          (other site-wide configuration files)
 +- identity.key   (RSA key pair that identifies an instance)
 +- secret.key     (deprecated key used for some plugins' secure operations)
 +- secret.key.not-so-secret  (used for validating _$JENKINS_HOME_ creation date)
 +- userContent    (files served under your https://server/userContent/)
 +- secrets        (root directory for the secret+key for credential decryption)
     +- hudson.util.Secret   (used for encrypting some Jenkins data)
     +- master.key           (used for encrypting the hudson.util.Secret key)
     +- InstanceIdentity.KEY (used to identity this instance)
 +- fingerprints   (stores fingerprint records, if any)
 +- plugins        (root directory for all Jenkins plugins)
     +- [PLUGINNAME]   (sub directory for each plugin)
         +- META-INF       (subdirectory for plugin manifest + pom.xml)
         +- WEB-INF        (subdirectory for plugin jar(s) and licenses.xml)
     +- [PLUGINNAME].jpi   (.jpi or .hpi file for the plugin)
 +- jobs           (root directory for all Jenkins jobs)
     +- [JOBNAME]      (sub directory for each job)
         +- config.xml     (job configuration file)
         +- workspace      (working directory for the version control system)
         +- latest         (symbolic link to the last successful build)
         +- builds         (stores past build records)
             +- [BUILD_ID]     (subdirectory for each build)
                 +- build.xml      (build result summary)
                 +- log            (log file)
                 +- changelog.xml  (change log)
     +- [FOLDERNAME]   (sub directory for each folder)
         +- config.xml     (folder configuration file)
         +- jobs           (sub directory for all nested jobs)
```

#### Segregating pure configuration from less durable data 将纯配置与持久性较差的数据隔离开来

|      | No data migration is handled by Jenkins when using those settings. So you either want to use them from the beginning, or make sure you take into consideration which data you would like to be moved to the right  place before using the following switches.  使用这些设置时，Jenkins 不会处理任何数据迁移。因此，您要么想从一开始就使用它们，要么确保在使用以下开关之前考虑要将哪些数据移动到正确的位置。 |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

It is possible to separate customize some of the layout to better separate pure job configurations from less durable data, like build data or  logs. [[1](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#_footnotedef_1)]
可以单独自定义一些布局，以更好地将纯作业配置与持久性较低的数据（如构建数据或日志）分开。[[1](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#_footnotedef_1)]

##### Configure a different *jobs build data* layout 配置不同的 *Job 构建数据*布局

Historically, the configuration of a given job is located under `$JENKINS_HOME/jobs/[JOB_NAME]/config.xml` and its builds are under `$JENKINS_HOME/jobs/[JOB_NAME]/builds`.
从历史上看，给定作业的配置位于 下 `$JENKINS_HOME/jobs/[JOB_NAME]/config.xml` ，其内部版本位于 下 `$JENKINS_HOME/jobs/[JOB_NAME]/builds` 。

This typically makes it more impractical to set up a different backup  policy, or set up a quicker disk for making builds potentially faster.
这通常使设置不同的备份策略或设置更快的磁盘以使构建速度可能更快变得更加不切实际。

For instance, if you would like to move builds under a different root, you can use the following value: `$JENKINS_VAR/${ITEM_FULL_NAME}/builds`.
例如，如果要将内部版本移动到其他根目录下，可以使用以下值： `$JENKINS_VAR/${ITEM_FULL_NAME}/builds` 。

Note that starting with Jenkins 2.119, the User Interface for this was replaced by the `jenkins.model.Jenkins.buildsDir` system property. See the [dedicated *Features Controlled with System Properties* wiki page](https://www.jenkins.io/doc/book/managing/system-properties/) for more details.
请注意，从 Jenkins 2.119 开始，此函数的用户界面已替换为 `jenkins.model.Jenkins.buildsDir` system 属性。有关更多详细信息，请参阅[*专门的 Features Controlled with System Properties* wiki 页面](https://www.jenkins.io/doc/book/managing/system-properties/)。

### Choosing a backup strategy 选择备份策略

All of your Jenkins-specific configurations that need to be backed up will live in the *$JENKINS_HOME*, but it is a best practice to back up only a subset of those files and folders.
所有需要备份的 Jenkins 特定配置都将位于 *$JENKINS_HOME* 中，但最佳实践是仅备份这些文件和文件夹的子集。

Below are a few guidelines to consider when planning your backup strategy.
以下是规划备份策略时需要考虑的一些准则。

Exclusions 排除

When it comes to creating a backup, it is recommended to exclude archiving the following folders to reduce the size of your backup:
在创建备份时，建议不存档以下文件夹以减小备份的大小：

```
/war      (the exploded Jenkins war directory)
/cache    (downloaded tools)
/tools    (extracted tools)
```

These folders will automatically be recreated the next time a build runs or Jenkins is launched.
这些文件夹将在下次运行构建或启动 Jenkins 时自动重新创建。

Jobs and Folders 作业和文件夹

Your job or folder configurations, build histories, archived artifacts, and workspace will exist entirely within the *jobs* folder.
您的作业或文件夹配置、构建历史记录、存档的构件和工作区将完全存在于*作业*文件夹中。

The *jobs* directory, whether nested within a folder or at the root level is as follows:
*jobs* 目录（无论是嵌套在文件夹中还是位于根级别）如下所示：

```
 +- jobs           (root directory for all Jenkins jobs)
     +- [JOBNAME]      (sub directory for each job)
         +- config.xml     (job configuration file)
         +- workspace      (working directory for the version control system)
         +- latest         (symbolic link to the last successful build)
         +- builds         (stores past build records)
             +- [BUILD_ID]     (subdirectory for each build)
                 +- build.xml      (build result summary)
                 +- log            (log file)
                 +- changelog.xml  (change log)
```

If you only need to backup your job configurations, you can opt to only backup the *config.xml* for each job. Generally build records and workspaces do not need to be backed up, as workspaces will be re-created when a job is run and build records are only as important as your organizations deems them.
如果您只需要备份任务配置，则可以选择仅备份每个任务的 *config.xml*。通常，构建记录和工作区不需要备份，因为在运行作业时将重新创建工作区，并且构建记录的重要性取决于您的组织认为它们的重要性。

System configurations 系统配置

Your controller’s system configurations exist in the root level of the *$JENKINS_HOME* folder:
控制器的系统配置位于 *$JENKINS_HOME* 文件夹的根级别中：

```
 +- config.xml     (Jenkins root configuration file)
 +- *.xml          (other site-wide configuration files)
```

The *config.xml* is the root configuration file for your Jenkins. It includes configurations for the paths of installed tools, workspace directory, and agent port.
*config.xml* 是 Jenkins 的根配置文件。它包括已安装工具的路径、工作区目录和代理端口的配置。

Any .xml other than that *config.xml* in the root Jenkins folder is a global configuration file for an installed tool or plugin (i.e. Maven, Git, Ant, etc). This includes the *credentials.xml* if the Credentials plugin is installed.
根 Jenkins 文件夹中除该*config.xml*以外的任何.xml都是已安装工具或插件（即 Maven、Git、Ant 等）的全局配置文件。这包括 *credentials.xml* （如果安装了 Credentials 插件）。

If you only want to backup your core Jenkins configuration, you only need to back up the *config.xml*.
如果您只想备份核心 Jenkins 配置，则只需备份 *config.xml*。

Plugins 插件

Your deployment’s plugin files (.hpi and .jpi) and any of their dependent resources (help files, *pom.xml* files, etc) will exist in the *plugins* folder in $JENKINS_HOME.
部署的插件文件（.hpi 和 .jpi）及其任何依赖资源（帮助文件、*pom.xml* 文件等）将存在于 $JENKINS_HOME 的 *plugins* 文件夹中。

```
 +- plugins        (root directory for all Jenkins plugins)
     +- [PLUGINNAME]     (sub directory for each plugin)
         +- META-INF       (subdirectory for plugin manifest + pom.xml)
         +- WEB-INF        (subdirectory for plugin jar(s) and licenses.xml)
     +- [PLUGINNAME].jpi (.jpi or .hpi file for the plugin)
```

It is recommended to back up the entirety of the plugins folder (.hpi/.jpis + folders).
建议备份整个 plugins 文件夹 （.hpi/.jpis + folders）。

Other data 其他数据

Other data that you are recommended to back up include the contents of your *secrets* folder, your *identity.key*, your *secret.key*, and your *secret.key.not-so-secret* file.
建议您备份的其他数据包括 *secrets* 文件夹的内容、*identity.key*、*secret.key* 和 *secret.key.not-so-secret* 文件。

```
+- identity.key   (RSA key pair that identifies an instance)
 +- secret.key     (used for various secure Jenkins operations)
 +- secret.key.not-so-secret  (used for validating _$JENKINS_HOME_ creation date)
 +- userContent    (files served in https://server/userContent/)
 +- secrets        (directory for the secret+key decryption)
     +- hudson.util.Secret   (used for encrypting some Jenkins data)
     +- master.key           (used for encrypting the hudson.util.Secret key)
     +- InstanceIdentity.KEY (used to identity this instance)
```

The *identity.key* is an RSA key pair that identifies and authenticates the current Jenkins controller.
*identity.key* 是一个 RSA 密钥对，用于识别和验证当前 Jenkins 控制器。

The *secret.key* is used to encrypt plugin and other Jenkins data, and to establish a secure connection between a controller and agent.
*secret.key* 用于加密插件和其他 Jenkins 数据，并在控制器和代理之间建立安全连接。

The *secret.key.not-so-secret* file is used to validate when the *$JENKINS_HOME* was created. It is also meant to be a flag that the secret.key file is a deprecated way of encrypting information.
*secret.key.not-so-secret* 文件用于验证 *$JENKINS_HOME* 的创建时间。它还意味着 secret.key 文件是一种已弃用的信息加密方式。

The files in the secrets folder are used by Jenkins to encrypt and decrypt your controller’s stored credentials, if any exist. Loss of these files will prevent recovery of any stored credentials. *hudson.util.Secret* is used for encrypting some Jenkins data like the credentials.xml, while the *master.key* is used for encrypting the hudson.util.Secret key. Finally, the *InstanceIdentity.KEY* is used to identity this controller and for producing digital signatures.
Jenkins 使用 secrets 文件夹中的文件来加密和解密控制器的存储凭证（如果存在）。丢失这些文件将阻止恢复任何存储的凭据。*hudson.util.Secret* 用于加密某些 Jenkins 数据（如 credentials.xml），而 *master.key* 用于加密 hudson.util.Secret 密钥。最后，*InstanceIdentity.KEY* 用于标识此控制器并生成数字签名。

### Define a Jenkins controller to rollback to 定义要回滚到的 Jenkins 控制器

In the case of a total machine failure, it is important to ensure that there is a plan in place to get Jenkins both back online and in its last good state.
在机器完全故障的情况下，重要的是要确保有一个计划来让 Jenkins 重新上线并处于最后的良好状态。

If a high availability set up has not been enabled and no back up of that controller’s filesystem has been taken, then an corruption of a machine running Jenkins means that all historical build data and artifacts, job and system configurations, etc. will be lost and the lost configurations will need to be recreated on a new controller.
如果尚未启用高可用性设置，并且没有备份该控制器的文件系统，则运行 Jenkins 的机器损坏意味着所有历史构建数据和工件、作业和系统配置等都将丢失，并且需要在新控制器上重新创建丢失的配置。

1. Backup policy - In addition to creating backups using the previous section’s backup guide, it is important to establish a policy for selecting which backup should be used when restoring a downed controller.
   备份策略—除了使用上一节的备份指南创建备份之外，还必须建立一个策略，以便在还原已关闭的控制器时选择应使用哪个备份。
2. Restoring from a backup - A plan must be put in place on whether the backup should be restored manually or with scripts when the primary goes down.
   从备份中恢复 - 必须制定一个计划，规定当主数据库出现故障时，是应该手动恢复备份，还是使用脚本恢复备份。

## Resilient Jenkins Architecture 弹性 Jenkins 架构

Administrators are constantly adding more and more teams to the software factory, making administrators in the business of making their controllers resilient to failures and scaling them in order to onboard more teams.
管理员不断向软件工厂添加越来越多的团队，使管理员能够使其控制器能够适应故障并扩展它们以加入更多团队。

Adding build nodes to a Jenkins controller while beefing up the machine that runs the Jenkins controller is the typical way to scale Jenkins. Said differently, administrators scale their Jenkins controller vertically. However, there is a limit to how much a controller can be scaled. These limitations are covered in the introduction to this chapter.
向 Jenkins 控制器添加构建节点，同时增强运行 Jenkins 控制器的机器是扩展 Jenkins 的典型方法。换句话说，管理员垂直扩展他们的 Jenkins 控制器。但是，控制器的缩放量是有限制的。本章的简介中介绍了这些限制。

Ideally, controllers will be set up to automatically recover from failures without human intervention. There are proxy servers monitoring active controllers and re-routing requests to backup controllers if the active controller goes down. There are additional factors that should be reviewed on the path to continuous delivery. These factors include componetizing the application under development, automating the entire pipeline (within reasonable limits) and freeing up contentious resources.
理想情况下，控制器将设置为无需人工干预即可自动从故障中恢复。有代理服务器监控主动控制器，并在主动控制器出现故障时将请求重新路由到备份控制器。在实现持续交付的道路上，还应考虑其他因素。这些因素包括组合正在开发的应用程序、自动化整个管道（在合理的范围内）以及释放有争议的资源。

Step 1: Make each controller highly available
第 1 步：使每个控制器都具有高可用性

Each Jenkins controller needs to be set up such that it is part of a Jenkins cluster.
每个 Jenkins 控制器都需要进行设置，使其成为 Jenkins 集群的一部分。

A proxy (typically HAProxy or F5) then fronts the primary controller. The proxy’s job is to continuously monitor the primary controller and route requests to the backup if the primary goes down. To make the infrastructure more resilient, you can have multiple backup controllers configured.
然后，代理（通常为 HAProxy 或 F5）位于主控制器的前面。代理的工作是持续监控主控制器，并在主控制器出现故障时将请求路由到备份控制器。为了提高基础设施的弹性，您可以配置多个备份控制器。

Step 2: Enable security 第 2 步：启用安全性

Set up an authentication realm that Jenkins will use for its user database.
设置 Jenkins 将用于其用户数据库的身份验证领域。

|      | If you are trying to set up a proof-of-concept, it is recommended to use the [Mock Security Realm plugin](https://plugins.jenkins.io/mock-security-realm) for authentication.  如果您正在尝试设置概念验证，建议使用 [Mock Security Realm 插件](https://plugins.jenkins.io/mock-security-realm)进行身份验证。 |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

Step 3: Add build nodes (agents) to controller
第 3 步：将构建节点（代理）添加到控制器

Add build servers to your controller to ensure you are conducting actual build execution off of the controller, which is meant to be an orchestration hub, and onto a "dumb" machine with sufficient memory and I/O for a given job or test.
将构建服务器添加到控制器中，以确保您从控制器（本应作为编排中心）和具有足够内存和 I/O 的“哑”计算机上执行实际的构建执行，以用于给定作业或测试。

Step 4: Setup a test controller
第 4 步：设置测试控制器

A test controller is typically used to test new plugin updates. When a plugin is ready to be used, it should be installed into the main production update center.
测试控制器通常用于测试新的插件更新。当插件准备好使用时，应将其安装到主生产更新中心。

------

[1](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#_footnoteref_1). These switches are used to configure out of the box [Jenkins Essentials](https://www.jenkins.io/blog/2018/04/06/jenkins-essentials/) instances. 
[1](https://www.jenkins.io/doc/book/scaling/architecting-for-scale/#_footnoteref_1). 这些开关用于配置开箱即用的 [Jenkins Essentials](https://www.jenkins.io/blog/2018/04/06/jenkins-essentials/) 实例。

# Hardware Recommendations 硬件建议

Table of Contents 目录

- [Introduction 介绍](https://www.jenkins.io/doc/book/scaling/hardware-recommendations/#introduction)
- Choosing the Right Hardware for Controllers
  为控制器选择合适的硬件
  - [Memory Requirements for the Controller
    控制器的内存要求](https://www.jenkins.io/doc/book/scaling/hardware-recommendations/#memory-requirements-for-the-controller)
- Choosing the Right Build Machines
  选择合适的构建机器
  - [Requirements for a Machine to be an agent
    Machine 成为代理的要求](https://www.jenkins.io/doc/book/scaling/hardware-recommendations/#requirements-for-a-machine-to-be-an-agent)

## Introduction 介绍

Sizing a Jenkins environment depends on a number of factors, which makes it a very inexact science. Achieving an optimal configuration requires some experience and experimentation. It is, however, possible to make a smart approximation to start - especially when designing with best practices in mind.
Jenkins 环境的大小取决于许多因素，这使得它成为一门非常不精确的科学。实现最佳配置需要一些经验和实验。但是，可以进行智能近似以开始 - 尤其是在考虑最佳实践的情况下进行设计时。

The following outlines these factors and how you can account for them when sizing your configuration. You are also provided sample configurations and the hardwares behind some of the largest Jenkins installations presented in a Jenkins Scalability Summit.
下面概述了这些因素以及在调整配置大小时如何考虑这些因素。此外，还为您提供了 Jenkins 可伸缩性峰会上介绍的一些最大 Jenkins 安装的示例配置和硬件。

## Choosing the Right Hardware for Controllers 为控制器选择合适的硬件

One of the greatest challenges of properly setting up a Jenkins controller is that there is no *one size fits all* answer - the exact specifications of the hardware that you will need will depend heavily on your organization’s current and future needs.
正确设置 Jenkins 控制器的最大挑战之一是没有*一个放之四海而皆准*的答案 - 您需要的硬件的确切规格在很大程度上取决于您组织当前和未来的需求。

Your Jenkins controller will be serving HTTP requests and storing all of the important information for your Jenkins controller in its *$JENKINS_HOME* folder (configurations, build histories and plugins).
您的 Jenkins 控制器将提供 HTTP 请求，并将 Jenkins 控制器的所有重要信息存储在其 *$JENKINS_HOME* 文件夹中（配置、构建历史和插件）。

More information on sizing controllers based on organizational needs can be found in the [Architecting for Scale](https://www.jenkins.io/doc/book/scaling/architecting-for-scale) section.
有关根据组织需求确定控制器大小的更多信息，请参阅 [Architecting for Scale](https://www.jenkins.io/doc/book/scaling/architecting-for-scale) 部分。

### Memory Requirements for the Controller 控制器的内存要求

The amount of memory Jenkins needs is largely dependent on many factors, which is why the RAM allotted for it can range from 200 MB for a small installation to 70+ GB for a single and massive Jenkins controller. However, you should be able to estimate the RAM required based on your project build needs.
Jenkins 需要的内存量在很大程度上取决于许多因素，这就是为什么分配给它的 RAM 范围可以从小型安装的 200 MB 到单个大型 Jenkins 控制器的 70+ GB。但是，您应该能够根据项目构建需求估算所需的 RAM。

Each build node connection will take 2-3 threads, which equals about 2 MB or more of memory. You will also need to factor in CPU overhead for Jenkins if there are a lot of users who will be accessing the Jenkins user interface.
每个构建节点连接将占用 2-3 个线程，这相当于大约 2 MB 或更多的内存。如果有很多用户将访问 Jenkins 用户界面，您还需要考虑 Jenkins 的 CPU 开销。

It is generally a bad practice to allocate executors on a controller, as builds can quickly overload a controller’s CPU/memory/etc and crash the controller, causing unnecessary downtime. Instead, it is advisable to set up agents that the Jenkins controller can delegate jobs to, keeping the bulk of the work off of the controller itself.
在控制器上分配 executor 通常是一种不好的做法，因为构建会迅速使控制器的 CPU/内存/等过载并使控制器崩溃，从而导致不必要的停机时间。相反，建议设置 Jenkins 控制器可以将作业委托给的代理，从而将大部分工作从控制器本身转移到之外。

## Choosing the Right Build Machines 选择合适的构建机器

The backbone of Jenkins is its ability to orchestrate builds, but installations which do not leverage Jenkins' distributed builds architecture are artificially limiting the number of builds that their controllers can orchestrate. More information on [a more distributed architecture](https://www.jenkins.io/doc/book/scaling/architecting-for-scale#distributed-builds-architecture) can be found in the [Architecting for Scale](https://www.jenkins.io/doc/book/scaling/architecting-for-scale) section.
Jenkins 的支柱是它能够编排构建，但不利用 Jenkins 的分布式构建架构的安装会人为地限制其控制器可以编排的构建数量。有关[分布式程度更高的架构](https://www.jenkins.io/doc/book/scaling/architecting-for-scale#distributed-builds-architecture)的更多信息，请参阅 [Architecting for Scale](https://www.jenkins.io/doc/book/scaling/architecting-for-scale) 部分。

### Requirements for a Machine to be an agent Machine 成为代理的要求

Agents are typically generic x86 machines with enough memory to run specific build types. The agent’s configuration depends on the builds it will be used for and on the tools required by the same builds.
代理通常是通用的 x86 计算机，具有足够的内存来运行特定的构建类型。代理的配置取决于它将用于的构建以及相同构建所需的工具。

Configuring a machine to act as an agent inside your infrastructure can be tedious and time consuming. This is especially true when the same set-up has to be replicated on a large pool of agents. Because of this, is ideal to have fungible agents, which are agents that are easily replaceable. Agents should be generic for all builds rather customized for a specific job or a set of jobs. The more generic the agents, the more easily they are interchanged, which in turn allows for a better use of resources and a reduced impact on productivity if some agents suffer an outage. Andrew Bayer introduced this concept of "fungibility" as applied to agents during his presentation ["Seven Habits of Highly Effective Jenkins Users" at the Jenkins User Conference (Europe, 2014)](https://www.slideshare.net/andrewbayer/seven-habits-of-highly-effective-jenkins-users-2014-edition).
将计算机配置为在基础结构中充当代理可能既乏味又耗时。当必须在大量代理上复制相同的设置时，尤其如此。因此，理想的做法是拥有可替代的可替代剂。代理对于所有构建都应该是通用的，而不是针对特定作业或一组作业进行自定义的。代理越通用，它们就越容易互换，这反过来又可以更好地利用资源，并减少某些代理发生中断时对生产力的影响。Andrew Bayer 在 [Jenkins 用户大会（欧洲，2014 年）上发表了题为“高效 Jenkins 用户的七个习惯”](https://www.slideshare.net/andrewbayer/seven-habits-of-highly-effective-jenkins-users-2014-edition)的演讲，介绍了应用于代理的“可替代性”概念。

The more automated the environment configuration is, the easier it is to replicate a configuration onto a new agent machine. Tools for configuration management or a pre-baked image can be excellent solutions to this end. Containers and virtualization are also popular tools for creating generic agent environments.
环境配置的自动化程度越高，就越容易将配置复制到新的代理计算机上。用于配置管理工具或预烘焙映像可能是实现此目的的绝佳解决方案。容器和虚拟化也是创建通用代理环境的常用工具。

More information on estimating the number of executors needed in a given environment can be found in the [Architecting for Scale](https://www.jenkins.io/doc/book/scaling/architecting-for-scale) section.
有关估计给定环境中所需的执行程序数量的更多信息，请参阅 [Architecting for Scale](https://www.jenkins.io/doc/book/scaling/architecting-for-scale) 部分。

# Architecting for Manageability  为可管理性构建架构

Table of Contents 目录

- [Introduction 介绍](https://www.jenkins.io/doc/book/scaling/architecting-for-manageability/#introduction)
- Test Controllers 测试控制器
  - [Configuring a test controller
    配置测试控制器](https://www.jenkins.io/doc/book/scaling/architecting-for-manageability/#setting-up-a-test-controller)
- Troubleshooting for Stability
  稳定性故障排除
  - [Using the Jenkins Metrics Plugin
    使用 Jenkins Metrics 插件](https://www.jenkins.io/doc/book/scaling/architecting-for-manageability/#using-the-jenkins-metrics-plugin)

## Introduction 介绍

With over 1,800 plugins and countless versions of said plugins in the open-source community, testing for all possible conflicts before upgrading one or more production Jenkins controllers is simply not feasible. While Jenkins itself will warn of potential incompatibility if it detects that a plugin requires a newer version of the Jenkins core, there is no automatic way to detect conflicts between plugins or to automatically quantify the impact of upgrading a plugin.
开源社区中有超过 1,800 个插件和所述插件的无数版本，因此在升级一个或多个生产 Jenkins 控制器之前测试所有可能的冲突是根本不可行的。虽然  Jenkins 本身会在检测到插件需要更新版本的 Jenkins  核心时警告潜在的不兼容，但没有自动方法可以检测插件之间的冲突或自动量化升级插件的影响。

Jenkins administrators test plugin and core version updates before performing them on the production controller. This kind of testing requires a copy or "test deployment" of the production server to act as the sandbox for such tests. Effective upgrade testing can prevent production downtime.
Jenkins 管理员在生产控制器上执行插件和核心版本更新之前会对其进行测试。这种测试需要 production 服务器的副本或“测试部署”来充当此类测试的沙箱。有效的升级测试可以防止生产停机。

## Test Controllers 测试控制器

A test controller is a Jenkins controller used solely for testing configurations and plugins in a non-production environment. A test controller is highly recommended for organizations with a mission-critical Jenkins controller.
测试控制器是仅用于在非生产环境中测试配置和插件的 Jenkins 控制器。对于具有任务关键型 Jenkins 控制器的组织，强烈建议使用测试控制器。

Upgrading or downgrading either the Jenkins core or any plugins can sometimes have the unintended side effect of crippling another plugin’s functionality or even crashing a controller. As of today, there is no better way to pre-test for such catastrophic conflicts than with a test controller.
升级或降级 Jenkins 核心或任何插件有时会产生意想不到的副作用，即削弱另一个插件的功能，甚至使控制器崩溃。截至今天，没有比使用测试控制器更好的方法来预先测试此类灾难性冲突了。

Test controllers should have identical configurations, jobs, and plugins as the production controller so that test upgrades  will most closely resemble the outcomes of a similar change on your production controller. For example, installing the Folders plugin while running a version of the Jenkins core older than 1.554.1 will cause the controller crash and be inaccessible until the plugin is manually uninstalled from the *plugin* folder.
测试控制器应具有与生产控制器相同的配置、作业和插件，以便测试升级与生产控制器上类似更改的结果最相似。例如，在运行低于 1.554.1 的 Jenkins 核心版本时安装 Folders 插件将导致控制器崩溃，并且在从*插件*文件夹中手动卸载插件之前无法访问。

### Configuring a test controller 配置测试控制器

There are many methods for setting up a test controller, but the commonality between them all is that the *$JENKINS_HOME* between them is nearly identical. Whether this means that most all of the  *$JENKINS_HOME* folders are version controlled in a service like GitHub and mounted manually or programmatically to a test server or Docker container, the result is nearly the same.
设置测试控制器的方法有很多，但它们之间的共同点是它们之间的 *$JENKINS_HOME* 几乎相同。无论这意味着大多数 *$JENKINS_HOME* 文件夹都在 GitHub 等服务中进行版本控制，并手动或以编程方式挂载到测试服务器或 Docker 容器，结果几乎相同。

It is ideal to first ensure the controller is idle (no running or queued jobs) before attempting to create a test controller.
在尝试创建测试控制器之前，最好先确保控制器处于空闲状态（没有正在运行或排队的作业）。

**With GitHub + manual commands
使用 GitHub + 手动命令**

You will simply need to open up your command-line interface and "cd" to the folder that contains the *$JENKINS_HOME* directory for your production controller and run the "git init" command. For the location of this folder, please refer to section 3.
您只需打开命令行界面，将 “cd” 打开到包含生产控制器的 *$JENKINS_HOME* 目录的文件夹，然后运行 “git init” 命令。有关此文件夹的位置，请参阅第 3 节。

It is recommended that before running the "git add" command that you create a good *.gitignore* file. This file will prevent you from accidentally version-controlling large binary files.
建议在运行 “git add” 命令之前创建一个好的 *.gitignore* 文件。此文件将防止您意外地对大型二进制文件进行版本控制。

Here is an example *.gitignore* file for a Jenkins controller running on OS X:
以下是在 OS X 上运行的 Jenkins 控制器的示例 *.gitignore* 文件：

```
.DS_Store
.AppleDouble
.LSOverride
Icon
._*
.Spotlight-V100
.Trashes
.AppleDB
.AppleDesktop
Network Trash Folder
Temporary Items
.apdisk
*.log
*.tmp
*.old
*.jar
*.son
.Xauthority
.bash_history
.bash_profile
.fontconfig
.gitconfig
.gem
.lesshst
.mysql_history
.owner
.ri
.rvm
.ssh
.viminfo
.vnc
bin/
tools/
**/.owner
**/queue.xml
**/fingerprints/
**/shelvedProjects/
**/updates/
**/jobs/*/workspace/
**/war/
/tools/
**/custom_deps/
**/cache/
**/caches/
fingerprints/
*.log
*.zip
*.rrd
*.gz
```

Once you have a good *.gitignore* file, you can run the following git commands to commit your *$JENKINS_HOME* to a git repository like GitHub:
一旦你有了一个好的 *.gitignore* 文件，你可以运行以下 git 命令将你的 *$JENKINS_HOME* 提交到像 GitHub 这样的 git 仓库：

```
git add -—all
git commit -m "first commit"
git push
```

Now you can install Jenkins to a fresh deployment and "git clone" this *$JENKINS_HOME* from the git repository to your new controller. You will need to replace the files in the new controller with your version-controlled files to complete the migration, whether through scripts or through a drag-and-drop process.
现在，您可以将 Jenkins 安装到新的部署中，并将此 *$JENKINS_HOME* 从 git 存储库“git clone”到您的新控制器。您需要将新控制器中的文件替换为版本控制文件以完成迁移，无论是通过脚本还是通过拖放过程。

Once this is done, you will need to restart the new test Jenkins service or reload its configuration from the Jenkins UI ("Manage Jenkins" >> "Reload Configuration").
完成此操作后，您将需要重新启动新的测试 Jenkins 服务或从 Jenkins UI 重新加载其配置（“管理 Jenkins” >> “重新加载配置”）。

**With GitHub + Docker (Linux-only)
使用 GitHub + Docker（仅限 Linux）**

When it comes to version controlling your $JENKINS_HOME, just follow the instructions in the previous section.
当涉及到对 $JENKINS_HOME 进行版本控制时，只需按照上一节中的说明进行操作即可。

The next step will be to create a Docker image with identical configurations to your production deployment’s - operating system (Linux-only), installed libraries/tools, and open ports. This can be accomplished through Dockerfiles.
下一步是创建与生产部署配置相同的 Docker 映像 - 操作系统（仅限 Linux）、已安装的库/工具和开放端口。这可以通过 Dockerfile 完成。

You will then just need to create mounted storage on your Docker server with a clone of your version-controlled *$JENKINS_HOME* home and a simple image to clone the *$JENKINS_HOME* into.
然后，您只需在 Docker 服务器上创建挂载的存储，其中包含版本控制的 *$JENKINS_HOME* 的克隆和用于将 *$JENKINS_HOME* 克隆到的简单映像。

For example, we can create a Docker image called *jenkins-storage* and version control our *$JENKINS_HOME* in a Github repository known as "demo-joc". The "jenkins-storage" Docker image can be built from a Dockerfile similar to this:
例如，我们可以创建一个名为 *jenkins-storage* 的 Docker 镜像，并在称为“demo-joc”的 Github 存储库中对我们的 *$JENKINS_HOME* 进行版本控制。“jenkins-storage” Docker 镜像可以从类似于以下内容的 Dockerfile 构建：

```
FROM eclipse-temurin:17-jdk-jammy
SHELL ["/bin/bash", "-o", "pipefail", "-c"]
RUN apt-get update && \
    apt-get -y upgrade && \
    apt-get install -y --no-install-recommends \
    curl \
    git \
    git-lfs \
    gpg \
    less \
    maven \
    ntp \
    ntpdate \
    openssh-server \
    vim && \
    mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
        gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
    echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] \
        https://download.docker.com/linux/ubuntu jammy stable" \
        >> /etc/apt/sources.list.d/docker.list 2> /dev/null && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    containerd.io \
    docker-ce \
    docker-ce-cli \
    docker-compose-plugin && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
RUN printf "AddressFamily inet" >> /etc/ssh/ssh_config
ENV MAVEN_HOME /usr/bin/mvn
ENV GIT_HOME /usr/bin/git
# Create Jenkins user
RUN useradd jenkins -d /home/jenkins
RUN echo "jenkins:jenkins" | chpasswd
# Make directories for JENKINS_HOME, jenkins.war lib
# and [agents] remote FS root, ssh privilege separation directory
RUN mkdir /usr/lib/jenkins /var/lib/jenkins /home/jenkins /var/run/sshd
# Set permissions
RUN chown -R jenkins:jenkins /usr/lib/jenkins /var/lib/jenkins /home/jenkins
#create data folder for cloning
RUN ["mkdir", "/data"]
RUN ["chown", "-R", "jenkins:jenkins", "/data"]
RUN usermod -a -G docker jenkins
USER jenkins
VOLUME ["/data"]
WORKDIR /data
# USER jenkins
CMD ["git", "clone", "https://github.com/MarkEWaite/docker-jenkins-storage.git", "."]
```

Creating mounted storage for containers would just require something similar to the following command:
为容器创建挂载的存储只需要类似于以下命令的内容：

```
docker run \
    --name storage \
    [your-dockerhub-id]/jenkins-storage \
    git clone https://github.com/[your-github-id]/docker-jenkins-storage.git .
```

And Jenkins images that rely on the mounted storage for their *$JENKINS_HOME* will then need to point to the mounted volume:
然后，依赖于 *$JENKINS_HOME* 挂载存储的 Jenkins 镜像将需要指向挂载的卷：

```
docker run -d \
       --dns=172.17.42.1 \
       --name joc-1 \
       --volumes-from storage \
       -e JENKINS_HOME=/data/var/lib/jenkins/jenkins \
       [your-dockerhub-id]/jenkins \
       --prefix=""
```

Test agents 测试代理

Test controllers can be connected to test agents, but this will require further configurations. Depending on your implementation of a test controller, you will either need to create a Jenkins Docker agent image or an agent VM. Of course, open-source plugins like the EC2 plugin also the option of spinning up new agents on-demand.
测试控制器可以连接到测试代理，但这需要进一步的配置。根据测试控制器的实现，您需要创建 Jenkins Docker 代理映像或代理 VM。当然，像 EC2 插件这样的开源插件也可以按需启动新的代理。

The agent connection information will also need to be edited in the config.xml located in your test *$JENKINS_HOME*.
还需要在位于测试 *$JENKINS_HOME* 的 config.xml 中编辑代理连接信息。

Rolling back plugins that cause failures
回滚导致失败的插件

If you discover that a plugin update is causing conflict within the test controller, you can rollback in several ways:
如果您发现插件更新在测试控制器中导致冲突，您可以通过多种方式回滚：

- For bad plugins, you can rollback the plugin from the UI by going to the plugin manager ("Manage Jenkins" >> "Plugins") and going to the "Available" tab. Jenkins will show a "downgrade" button next to any plugins that can be downgraded.
  对于不良插件，您可以通过转到插件管理器（“Manage Jenkins” >> “Plugins”）并转到“Available”选项卡，从 UI 回滚插件。Jenkins 将在任何可以降级的插件旁边显示一个 “downgrade” 按钮。
- If the UI is unavailable, then enter your *$JENKINS_HOME* folder and go to the plugins folder. From there, delete the .hpi or .jpi file for the offending plugin, then restart Jenkins. If you need to rollback to an older version, you will need to manually copy in an older version of that .jpi or .hpi. To do this, go to the plugin’s page on the [Jenkins updates site](https://updates.jenkins.io/download/plugins) and download one of its archived versions.
  如果 UI 不可用，请输入 *$JENKINS_HOME* 文件夹并转到 plugins 文件夹。从那里，删除有问题的插件的 .hpi 或 .jpi 文件，然后重新启动 Jenkins。如果需要回滚到旧版本，则需要手动复制该 .jpi 或 .hpi 的旧版本。为此，请转到 [Jenkins 更新站点](https://updates.jenkins.io/download/plugins)上的插件页面并下载其存档版本之一。

## Troubleshooting for Stability 稳定性故障排除

A Jenkins controller can suffer instability problems when it is not properly sized for its hardware or when a buggy plugin wastes resources. To combat this, Jenkins administrators should begin their troubleshooting by identifying which components are behaving abnormally and which resources are insufficient. The administrator can [take thread dumps](https://wiki.jenkins.io/display/JENKINS/Obtaining+a+thread+dump) and heap dumps to get some of this information, but in some cases where the controller has become non-operational and taking a thread dump is impossible, it is useful to have a persistent record outside of Jenkins itself to reference when such troubleshooting is required.
当 Jenkins 控制器的大小不适合其硬件或有问题的插件浪费资源时，它可能会遇到不稳定问题。为了解决这个问题，Jenkins 管理员应该通过识别哪些组件行为异常以及哪些资源不足来开始故障排除。管理员可以[进行线程转储](https://wiki.jenkins.io/display/JENKINS/Obtaining+a+thread+dump)和堆转储来获取其中一些信息，但在某些情况下，当控制器无法运行并且无法进行线程转储时，在 Jenkins 本身之外有一个持久记录来参考是很有用的。

### Using the Jenkins Metrics Plugin 使用 Jenkins Metrics 插件

The [metrics plugin](https://plugins.jenkins.io/metrics) is an open-source plugin that exposed Jenkins metrics. Metrics are exposed using the [Dropwizard Metrics API](https://dropwizard.github.io/metrics/3.1.0)
[指标插件](https://plugins.jenkins.io/metrics)是一个开源插件，用于公开 Jenkins 指标。指标使用 [Dropwizard Metrics API](https://dropwizard.github.io/metrics/3.1.0) 公开

Metrics exposed 公开的指标

The exact list of exposed metrics varies depending on your installed plugins. To get a full list of available metrics for your controller, run the following script on the [Jenkins script console](https://www.jenkins.io/doc/book/managing/script-console/):
公开指标的确切列表因您安装的插件而异。要获取控制器的可用指标的完整列表，请在 [Jenkins 脚本控制台](https://www.jenkins.io/doc/book/managing/script-console/)上运行以下脚本：

```
for (j in Jenkins.instance.getExtensionList(jenkins.metrics.api.MetricProvider.class)) {
     for (m in j.getMetricSet()) {
          for (i in m.metrics)
               { println i.getKey() }
     }
}
```

The [metrics plugin](https://plugins.jenkins.io/metrics) documentation describes the available metrics.
[指标插件](https://plugins.jenkins.io/metrics)文档介绍了可用的指标。

Metrics Usage 指标使用情况

Metrics are protected by a set of permissions for viewing, accessing the thread dump, and posting a health check. The Metrics Operational Menu can be accessed via the web UI by visiting <jenkins-url>/metrics/currentUser, and the 4 menu options (Metrics, Ping, Threads, Healthcheck) lead to a JSON string containing the requested metrics or thread dump.
指标受一组权限保护，用于查看、访问线程转储和发布运行状况检查。可以通过访问 <jenkins-url>/metrics/currentUser 通过 Web UI 访问指标操作菜单，4  个菜单选项（指标、Ping、线程、运行状况检查）指向包含请求的指标或线程转储的 JSON 字符串。

Access to the Metrics Servlet can also be provided by issuing API keys. API keys can be configured from the Jenkins global configuration screen (<jenkins-url>/configure) under the "Metrics" section. Multiple access can be generated and permissions associated with those keys can also be restricted at this level.
还可以通过颁发 API 密钥来提供对 Metrics Servlet 的访问。API 密钥可以从 Jenkins 全局配置屏幕  （<jenkins-url>/configure）  的“指标”部分进行配置。可以生成多个访问权限，并且还可以在此级别限制与这些密钥关联的权限。

Additional information on hardware recommendations can be be found on the [Hardware Recommendations](https://www.jenkins.io/doc/book/scaling/hardware-recommendations/) page
有关硬件建议的其他信息，请参阅 [Hardware Recommendations](https://www.jenkins.io/doc/book/scaling/hardware-recommendations/) 页面

# Scaling Jenkins on Kubernetes  在 Kubernetes 上扩展 Jenkins

Table of Contents 目录

- [Jenkins Scalability Jenkins 可扩展性](https://www.jenkins.io/doc/book/scaling/scaling-jenkins-on-kubernetes/#jenkins-scalability)
- Scaling Jenkins on Kubernetes
  在 Kubernetes 上扩展 Jenkins
  - [Advantages of scaling Jenkins on Kubernetes
    在 Kubernetes 上扩展 Jenkins 的优势](https://www.jenkins.io/doc/book/scaling/scaling-jenkins-on-kubernetes/#advantages-of-scaling-jenkins-on-kubernetes)
- Setting Up Scalable Jenkins on Kubernetes
  在 Kubernetes 上设置可扩展的 Jenkins
  - [Jenkins Controller Installation
    Jenkins 控制器安装](https://www.jenkins.io/doc/book/scaling/scaling-jenkins-on-kubernetes/#jenkins-controller-installation)
  - [Deploy Jenkins Controller
    部署 Jenkins Controller](https://www.jenkins.io/doc/book/scaling/scaling-jenkins-on-kubernetes/#deploy-jenkins-controller)
  - [Access Jenkins dashboard 访问 Jenkins 控制面板](https://www.jenkins.io/doc/book/scaling/scaling-jenkins-on-kubernetes/#access-jenkins-dashboard)
- Jenkins Agents Configuration
  Jenkins 代理配置
  - [Kubernetes Plugin Configuration
    Kubernetes 插件配置](https://www.jenkins.io/doc/book/scaling/scaling-jenkins-on-kubernetes/#kubernetes-plugin-configuration)
- [Using Jenkins Agents 使用 Jenkins 代理](https://www.jenkins.io/doc/book/scaling/scaling-jenkins-on-kubernetes/#using-jenkins-agents)

## Jenkins Scalability Jenkins 可扩展性

When using the standalone Jenkins server you don’t have to worry about multiple servers and nodes. However, the issue with this setup is that your server can become overloaded with numerous jobs running at the same time. There are ways to solve this problem by increasing the number of executors, but you soon end up hitting a performance limit.
使用独立 Jenkins 服务器时，您不必担心多个服务器和节点。但是，此设置的问题在于，由于同时运行大量作业，您的服务器可能会过载。有一些方法可以通过增加执行程序的数量来解决此问题，但您很快就会达到性能限制。

To overcome this problem, you can offload some of the jobs to different machines called Jenkins agents.
要解决此问题，您可以将一些作业卸载到称为 Jenkins 代理的不同计算机上。

Scalability is a measure that shows the ability of a system to expand its  capabilities to handle additional load. One of the strongest sides of Jenkins is that it has a scaling feature  out-of-the-box. Jenkins scaling is based on the controller/agents model, where you have a number of agents and one main Jenkins controller that is responsible  mainly for distributing jobs across the agents. Jenkins agents run a small program that communicates with the Jenkins  controller to check if there’s any job it can run. When Jenkins finds a job scheduled, it transfers the build to the agent.
可扩展性是显示系统扩展其处理额外负载的能力的度量。Jenkins 最强大的方面之一是它具有开箱即用的扩展功能。Jenkins 扩展基于控制器/代理模型，其中您有许多代理和一个主要负责在代理之间分配作业的主  Jenkins 控制器。Jenkins 代理运行一个小程序，该程序与 Jenkins 控制器通信，以检查是否有任何作业可以运行。当  Jenkins 找到已安排的作业时，它会将构建转移到代理。

## Scaling Jenkins on Kubernetes 在 Kubernetes 上扩展 Jenkins

Taking it a step further, running a container orchestrator such as Kubernetes, you can make Jenkins do smarter things. The Jenkins controller is responsible for the hosting configuration and the distribution of jobs to multiple agents. However, you don’t need the agents to be preexisting, they can be created on the fly, as in when they’re required.
更进一步，运行 Kubernetes 等容器编排器，您可以让 Jenkins 做更智能的事情。Jenkins 控制器负责托管配置和将作业分发给多个代理。但是，您不需要预先存在代理，它们可以动态创建，就像在需要时一样。

### Advantages of scaling Jenkins on Kubernetes 在 Kubernetes 上扩展 Jenkins 的优势

- Autohealing is possible 可以进行自愈

  If your build or your agent gets corrupted, you no longer need to  worry — Jenkins will remove the unhealthy instance and spin up a new one. 如果您的构建或代理损坏，您不再需要担心 — Jenkins 将删除运行状况不佳的实例并启动一个新实例。

- Run builds in parallel 并行运行构建

  You no longer have to plan the executors and limit them; instead, Jenkins  will spin up an agent instance and run your build in it. 您不再需要规划执行程序并限制它们;相反，Jenkins 将启动一个代理实例并在其中运行您的构建。

- Even load distribution 均匀的负载分布

  Kubernetes manages loads well, and it’ll make sure your Jenkins agents spin up in  the best available server, which makes your builds faster and more  efficient. Kubernetes 可以很好地管理负载，并确保您的 Jenkins 代理在最佳可用服务器中启动，从而使您的构建更快、更高效。

## Setting Up Scalable Jenkins on Kubernetes 在 Kubernetes 上设置可扩展的 Jenkins

### Jenkins Controller Installation Jenkins 控制器安装

To install a Jenkins controller, create your docker image based on the  base Jenkins image, which can be found in the official docker repository (keep in mind that Docker should be installed on your local machine,  see the installation steps [here](https://www.jenkins.io/doc/book/installing/docker/#installing-docker)). For this, you need to create a dockerfile. Having your Jenkins setup as a dockerfile is highly recommended to make  your continuous integration infrastructure replicable and have it ready  for setup from scratch. So let’s create our first example dockerfile for the Jenkins controller:
要安装 Jenkins 控制器，请根据基本 Jenkins 镜像创建 Docker 镜像，该镜像可在官方 docker 存储库中找到（请记住，Docker 应安装在本地计算机上，请参阅[此处](https://www.jenkins.io/doc/book/installing/docker/#installing-docker)的安装步骤）。为此，您需要创建一个 dockerfile。强烈建议将 Jenkins 设置作为 dockerfile，以使您的持续集成基础设施可复制，并准备好从头开始设置。因此，让我们为 Jenkins 控制器创建第一个示例 dockerfile：

Dockerfile Dockerfile 文件

```
FROM jenkins/jenkins:lts-slim-jdk17 
# Pipelines with Blue Ocean UI and Kubernetes
RUN jenkins-plugin-cli --plugins blueocean kubernetes 
```

|      | `FROM [image_name]:[tag]` - this line means that our dockerfile will be based on an existing  image. It is obvious that for our dockerfile, we take the Jenkins base  image, which you can find in the [official Docker repository](https://hub.docker.com/r/jenkins/jenkins). `FROM [image_name]：[tag]` - 此行表示我们的 dockerfile 将基于现有映像。很明显，对于我们的 dockerfile，我们采用了 Jenkins 基础镜像，您可以在[官方 Docker 存储库](https://hub.docker.com/r/jenkins/jenkins)中找到它。 |
| ---- | ------------------------------------------------------------ |
|      | `RUN [command]` - this line means that we are going to run this command inside the image during the build process. In our case we use the `RUN` command to install different common Jenkins plugins, which can be required for your Jenkins controller. `RUN [command]` - 此行表示我们将在构建过程中在映像内运行此命令。在我们的例子中，我们使用 `RUN` 命令来安装不同的常见 Jenkins 插件，您的 Jenkins 控制器可能需要这些插件。 |

You can install additional plugins just by adding similar commands inside your dockerfile like we did above. However, one of the plugins above is critical for installation. It is the [Kubernetes plugin](https://plugins.jenkins.io/kubernetes). This plugin is designed to implement Jenkins scaling on top of a Kubernetes cluster.
您只需在 dockerfile 中添加类似的命令即可安装其他插件，就像我们上面所做的那样。但是，上述插件之一对于安装至关重要。它是 [Kubernetes 插件](https://plugins.jenkins.io/kubernetes)。此插件旨在在 Kubernetes 集群之上实现 Jenkins 扩展。

Next, we need to build the image that can be used and run inside the Kubernetes cluster later on.
接下来，我们需要构建稍后可以在 Kubernetes 集群中使用和运行的镜像。

|      | Before building the image, if you use Minikube, then you need to keep in mind that Minikube runs on your local machine but inside a virtual  machine. That’s why Minikube doesn’t see the docker images you created on your  local machine. You can build your docker image right inside your Minikube virtual  machine, but for this you need to execute this command:  在构建映像之前，如果您使用 Minikube，则需要记住 Minikube 在本地计算机上运行，但在虚拟机内运行。这就是为什么 Minikube  看不到您在本地计算机上创建的 docker 镜像的原因。您可以直接在 Minikube 虚拟机中构建 docker  镜像，但为此您需要执行以下命令： |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

```
eval $(minikube docker-env)
```

This command doesn’t show any output after execution so if you didn’t get  any errors then everything should be fine. To build a docker image based on the dockerfile you created, all you  need is to run this command from the same folder where you have created  the dockerfile:
此命令在执行后不显示任何输出，因此如果您没有收到任何错误，那么一切都应该没问题。要基于您创建的 dockerfile 构建 docker 镜像，您只需从创建 dockerfile 的同一文件夹运行此命令即可：

```
docker build -t my-jenkins-image:1.1 .
```

After the build process is finished, let’s verify that the newly created image is there:
构建过程完成后，让我们验证新创建的映像是否在那里：

```
docker images
REPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE
my-jenkins-image              1.1                 d6e46aa2470d        10 minutes ago      969MB
```

Congratulations! Your Jenkins controller image is created and can be used inside your Kubernetes cluster.
祝贺！您的 Jenkins 控制器映像已创建，可以在 Kubernetes 集群中使用。

### Deploy Jenkins Controller 部署 Jenkins Controller

After successfully creating your Jenkins image, follow the steps explained in the [Jenkins installation doc](https://www.jenkins.io/doc/book/installing/kubernetes/#install-jenkins-with-yaml-files) to deploy your Jenkins controller.
成功创建 Jenkins 映像后，请按照 [Jenkins 安装文档中](https://www.jenkins.io/doc/book/installing/kubernetes/#install-jenkins-with-yaml-files)说明的步骤部署 Jenkins 控制器。

|      | Ensure to replace the image in the `jenkins-deployment.yaml` file with your locally built image above. 确保将 `jenkins-deployment.yaml` 文件中的镜像替换为上面本地构建的镜像。 |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

To validate that creating the deployment was successful you can invoke:
要验证创建部署是否成功，您可以调用：

```
kubectl get deployments -n jenkins
```

To validate that creating the service was successful you can run:
要验证创建服务是否成功，您可以运行：

```
kubectl get services -n jenkins
NAME       TYPE        CLUSTER-IP       EXTERNAL-IP    PORT(S)           AGE
jenkins    NodePort    10.103.31.217    <none>         8080:32664/TCP    59s
```

### Access Jenkins dashboard 访问 Jenkins 控制面板

So now we have created a deployment and service, how do we access our Jenkins controller?
那么现在我们已经创建了一个部署和服务，我们如何访问我们的 Jenkins 控制器呢？

From the output above we can see that the service has been exposed on port `32664`. In addition to that, we need to know the IP of the Kubernetes cluster itself. We can get it by using this command:
从上面的输出中，我们可以看到该服务已在端口 `32664` 上公开。除此之外，我们还需要知道 Kubernetes 集群本身的 IP。我们可以使用以下命令来获取它：

```
minikube ip
192.168.99.100
```

Now we can access the Jenkins controller at http://192.168.99.100:32664/
现在我们可以在 http://192.168.99.100:32664/ 访问 Jenkins 控制器

## Jenkins Agents Configuration Jenkins 代理配置

Now it’s time to configure Jenkins agents. As you might remember, we installed the Kubernetes plugin using the  controller dockerfile so we don’t need to install anything separately  and the required plugin should be already there.
现在是时候配置 Jenkins 代理了。您可能还记得，我们使用控制器 dockerfile 安装了 Kubernetes 插件，因此我们不需要单独安装任何内容，所需的插件应该已经存在。

In order to configure the Jenkins agents. We need to know the URL of the Kubernetes controller and the internal cluster URL of the Jenkins pod. You can get the Kubernetes controller URL by this specified command:
为了配置 Jenkins 代理。我们需要知道 Kubernetes 控制器的 URL 和 Jenkins Pod 的内部集群 URL。您可以通过以下指定命令获取 Kubernetes 控制器 URL：

```
kubectl cluster-info
Kubernetes control plane is running at https://192.168.49.2:8443
KubeDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

The Jenkins pod URL port is standard - `8080`, and you can get IP address following the steps below. First, we need to get the Jenkins pod id, which is the value of the output provided by this command:
Jenkins Pod URL 端口是标准的 - `8080`，您可以按照以下步骤获取 IP 地址。首先，我们需要获取 Jenkins Pod ID，这是此命令提供的输出值：

```
kubectl get pods -n jenkins | grep jenkins
<pod_id>   1/1       Running   0          9m
```

Second, we need to run the command that describes the pods passing the pod id  as an argument. You will find the IP address in the output:
其次，我们需要运行描述 Pod 的命令，将 Pod ID 作为参数传递。您将在输出中找到 IP 地址：

```
kubectl describe pod -n jenkins jenkins-5fdbf5d7c5-dj2rq
…..
IP:             172.17.0.4
```

### Kubernetes Plugin Configuration Kubernetes 插件配置

Now, we are ready to fill in the Kubernetes plugin configuration. In order  to do that, open the Jenkins UI and navigate to “Manage Jenkins → Nodes  and Clouds → Clouds → Add a new cloud → Kubernetes and fill in the `Kubernetes URL` and `Jenkins URL` appropriately, by using the values which we have just collected in the previous step.
现在，我们已准备好填写 Kubernetes 插件配置。为此，请打开 Jenkins UI 并导航到“管理 Jenkins → 节点和云 → 云 → → Kubernetes 添加新云，并使用我们刚刚在上一步中收集的值适当填写 `Kubernetes URL` 和 `Jenkins URL`。

![kubernetes-plugin-configuration](https://www.jenkins.io/doc/book/resources/scaling-jenkins-on-kubernetes/kubernetes-plugin-configuration.png)

In addition to that, in the `Kubernetes Pod Template` section, we need to configure the image that will be used to spin up  the agents. If you have some custom requirements for your agents, you can build one  more dockerfile with the appropriate changes the same way we did for the Jenkins controller. On the other hand, if you don’t have unique requirements for your  agents, you can use the default Jenkins agents image available on the [official Docker hub repository](https://hub.docker.com/r/jenkins/inbound-agent/). In the ‘Kubernetes Pod Template’ section you need to specify the following (the rest of the configuration is up to you):
除此之外，在 `Kubernetes Pod 模板`部分中，我们需要配置将用于启动代理的镜像。如果您对代理有一些自定义要求，您可以再构建一个 dockerfile，其中包含适当的更改，就像我们对 Jenkins 控制器所做的那样。另一方面，如果您对代理没有独特要求，则可以使用[官方 Docker Hub 存储库](https://hub.docker.com/r/jenkins/inbound-agent/)中提供的默认 Jenkins 代理镜像。在 'Kubernetes Pod Template' 部分，你需要指定以下内容（其余配置由你决定）：

Kubernetes Pod Template Name - can be any and will be shown as a prefix for unique generated agents' names, which will be run automatically during builds Docker image - the docker image name that will be used as a reference to spin up a new Jenkins agents.
Kubernetes Pod 模板名称 - 可以是任何名称，并将显示为唯一生成的代理名称的前缀，该名称将在构建期间自动运行Docker 镜像 - Docker 镜像名称，将用作启动新 Jenkins 代理的参考。

![pod-template-configuration](https://www.jenkins.io/doc/book/resources/scaling-jenkins-on-kubernetes/pod-template-configuration.png)

## Using Jenkins Agents 使用 Jenkins 代理

Now all the configuration seems to be in place and we are ready for some tests. Let’s create two different build plans.
现在，所有配置似乎都已准备就绪，我们已经准备好进行一些测试。让我们创建两个不同的构建计划。

![image](https://www.jenkins.io/doc/book/resources/scaling-jenkins-on-kubernetes/build-jobs.png)

Now let’s trigger the execution for both of the builds. You should see that both build plans appear in the `Build Queue` box almost immediately.
现在，让我们触发两个构建的执行。您应该看到两个构建计划几乎立即出现在 `Build Queue （构建队列`） 框中。

If you applied the correct configuration in the previous steps, you should see that you have two additional executors and both have the prefix `jenkins-agent`, in about 10-15 seconds. This means that these nodes were automatically launched inside the  Kubernetes cluster by using the Jenkins Kubernetes plugin, and, most  importantly, that they were run in parallel. You can also confirm this from the Kubernetes dashboard, which will show you a couple of new pods. After both builds are completed, you should see that both build  executors have been removed and are not available inside the cluster  anymore.
如果您在前面的步骤中应用了正确的配置，您应该会在大约 10-15 秒内看到您有两个额外的执行程序，并且都带有前缀 `jenkins-agent`。这意味着这些节点是使用 Jenkins Kubernetes 插件在 Kubernetes 集群内自动启动的，最重要的是，它们是并行运行的。您还可以从  Kubernetes 控制面板确认这一点，该控制面板将向您显示几个新的  pod。完成两个构建后，您应该会看到两个构建执行程序都已被删除，并且在集群中不再可用。

Congratulations! We’ve successfully set up scalable Jenkins on top of a Kubernetes cluster.
祝贺！我们已经成功地在 Kubernetes 集群上设置了可扩展的 Jenkins。