# 系统管理

[TOC]

## 概述

- [ Backing-up/Restoring Jenkins 
  备份/恢复 Jenkins](https://www.jenkins.io/doc/book/system-administration/backing-up)
- [ Monitoring Jenkins  监控 Jenkins](https://www.jenkins.io/doc/book/system-administration/monitoring)
- [ Administering Jenkins on Kubernetes 
  在 Kubernetes 上管理 Jenkins](https://www.jenkins.io/doc/book/system-administration/administering-jenkins-on-kubernetes)
- [ Managing Jenkins with Chef 
  使用 Chef 管理 Jenkins](https://www.jenkins.io/doc/book/system-administration/with-chef)
- [ Managing Jenkins with Puppet 
  使用 Puppet 管理 Jenkins](https://www.jenkins.io/doc/book/system-administration/with-puppet)
- [ Viewing logs  查看日志](https://www.jenkins.io/doc/book/system-administration/viewing-logs)
- [ Authenticating scripted clients 
  验证脚本化客户端](https://www.jenkins.io/doc/book/system-administration/authenticating-scripted-clients)
- [ Reverse proxy configuration 
  反向代理配置](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins)
- [ Reverse proxy - Issues  反向代理 - 问题](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting)
- [ Managing systemd services 
  管理 systemd 服务](https://www.jenkins.io/doc/book/system-administration/systemd-services)
- [ FIPS-140  FIPS-140 格式](https://www.jenkins.io/doc/book/system-administration/FIPS-140)
- [ Reset the Jenkins administrator password 
  重置 Jenkins 管理员密码](https://www.jenkins.io/doc/book/system-administration/admin-password-reset-instructions)

## 备份/恢复 Jenkins

拥有 Jenkins 控制器的良好备份至关重要。备份用于：

- 灾难恢复。
- Recovering an older configuration (an accidental configuration change may not be discovered for some time).
  恢复较旧的配置（可能在一段时间内无法发现意外的配置更改）。
- 恢复已损坏或被意外删除的文件。

### 创建备份

可以使用各种方案来创建备份。本节将讨论这些内容：

- 文件系统快照
- 备份插件
- 编写一个备份 Jenkins 控制器的 shell 脚本

#### 文件系统快照

文件系统快照为备份提供最大的一致性。它们的运行速度也比实时备份快，从而降低了在不同时间点复制不同数据的可能性。他们得到以下支持：

- Linux 逻辑卷管理器 （LVM）
- Linux btrfs
- Solaris ZFS（还支持增量备份）
- FreeBSD ZFS
- Linux 上的 OpenZFS
- 其他一些文件系统架构
- 许多云提供商
- 一些单独的存储设备还允许您在存储级别创建快照。

#### 备份插件

Several plugins are available for backup. From the main menu select *Manage Jenkins*, then go to *Plugins>Available* and search for **backup**. Note that only the [thinBackup Plugin](https://plugins.jenkins.io/thinBackup/) of the open source plugins is currently being maintained. You can try the other plugins but you may have problems with them.
有几个插件可用于备份。从主菜单中选择 *Manage Jenkins*，然后转到 *Plugins>Available* 并搜索 **backup**。请注意，目前仅维护开源插件的 [thinBackup 插件](https://plugins.jenkins.io/thinBackup/)。您可以尝试其他插件，但可能会遇到问题。

#### 编写用于备份的 shell 脚本

You can write your own shell script that copies the appropriate files and directories to a backup location. Use [cron](https://man7.org/linux/man-pages/man8/cron.8.html) to schedule when the backup script runs.
您可以编写自己的 shell 脚本，将相应的文件和目录复制到备份位置。使用 [cron](https://man7.org/linux/man-pages/man8/cron.8.html) 安排备份脚本的运行时间。

The shell script should create a directory such as `/mnt/backup` to which the backup will be written; be sure that you have write permissions to that directory. Consider creating `/mnt/backup` as a separate filesystem with its own mount point. An alternative method is to create a subdirectory in `/var`. Note that if you use this method, you might need to use the **sudo** command to execute the restore operation. Backing up to `/tmp` is not advised because `/tmp` may be cleaned on reboot.
shell 脚本应创建一个目录，例如 `/mnt/backup`，备份将写入该目录;确保您具有该目录的写入权限。考虑将 `/mnt/backup` 创建为具有自己的挂载点的单独文件系统。另一种方法是在 `/var` 中创建一个子目录。请注意，如果使用此方法，则可能需要使用 **sudo** 命令来执行还原操作。不建议备份到 `/tmp`，因为 `/tmp` 可能会在重新启动时被清理。

Create a unique identifier for each backup (use a timestamp, for example) to ensure that today’s backup does not overwrite yesterday’s backup.
为每个备份创建一个唯一标识符（例如，使用时间戳），以确保今天的备份不会覆盖昨天的备份。

Writing files to a local file system is the fastest way to take the backup. Consider copying the completed backup to a remote backup server or device for long term storage.
将文件写入本地文件系统是进行备份的最快方法。考虑将完成的备份复制到远程备份服务器或设备以进行长期存储。

### 单独备份 Controller Key

**Never include the controller key in your Jenkins backup!
切勿在 Jenkins 备份中包含控制器密钥！**

The controller key is used to encrypt data in the *secrets* directory that secures credentials. It is stored in the *$JENKINS_HOME/secrets/hudson.util.Secret* file in the *$JENKINS_HOME/secrets/* directory and encrypted with `master.key`. If you need to restore a system from a backup, you will need this file. And, if someone else accesses your backups and has this key, they have full access to all your information.
控制器密钥用于加密 *secrets* 目录中保护凭证的数据。它存储在 *$JENKINS_HOME/secrets/ 目录下的 $JENKINS_HOME/secrets/hudson.util.Secret* 文件中，并使用 `master.key` 进行加密。如果需要从备份还原系统，则需要此文件。而且，如果其他人访问您的备份并拥有此密钥，则他们拥有您所有信息的完全访问权限。

You should treat your controller key like you treat your SSH private key and NEVER include it in a regular backup. Instead, back up the `master.key` file separately and store it in a very secure location away from your other backups. It is a very small file that is seldom changed. If you need to do a full system restore, you will need to restore the rest of the system and then apply the backup of the `master.key` file separately.
您应该像对待 SSH 私钥一样对待控制器密钥，切勿将其包含在常规备份中。相反，请单独备份 `master.key` 文件，并将其存储在远离其他备份的非常安全的位置。这是一个非常小的文件，很少更改。如果需要执行完整的系统还原，则需要还原系统的其余部分，然后单独应用 `master.key` 文件的备份。

### 应该备份哪些文件？

The number of files you back up can affect both the time required to run the backup and the size of the resulting backup. It also impacts the complexity of restoring the system from the backup. Here we discuss why various files should be backed up and list some files that could safely be excluded from at least some backups.
备份的文件数会影响运行备份所需的时间和结果备份的大小。它还会影响从备份还原系统的复杂性。在这里，我们讨论为什么应该备份各种文件，并列出一些可以安全地从至少某些备份中排除的文件。

#### $JENKINS_HOME $JENKINS_首页

Backing up the entire `$JENKINS_HOME` directory preserves the entire Jenkins controller. To restore the system, just copy the entire backup to the new system.
备份整个 `$JENKINS_HOME` 目录会保留整个 Jenkins 控制器。要还原系统，只需将整个备份复制到新系统即可。

Note, however, that `JENKINS_HOME` includes a number of files that do not really need to be backed up. Selecting specific directories and files to back up yields smaller backups but may require a greater effort to restore a system. One approach is to back up different directories on different schedules.
但请注意，`JENKINS_HOME` 包括许多实际上不需要备份的文件。选择要备份的特定目录和文件会产生较小的备份，但可能需要更大的工作来还原系统。一种方法是按不同的计划备份不同的目录。

#### Configuration files 配置文件

Configuration files are stored directly in the `$JENKINS_HOME` directory. `./config.xml` is the main Jenkins configuration file. Other configuration files also have the `.xml` suffix. Specify `$JENKINS_HOME/*.xml` to back up all configuration files.
配置文件直接存储在 `$JENKINS_HOME` 目录中。`./config.xml` 是主要的 Jenkins 配置文件。其他配置文件也具有 `.xml` 后缀。指定 `$JENKINS_HOME/*.xml` 备份所有配置文件。

Configuration files can also be stored in an SCM repository. This keeps copies of all previous versions of each file that can be retrieved using standard SCM facilities.
配置文件也可以存储在 SCM 存储库中。这将保留每个文件的所有先前版本的副本，这些副本可以使用标准 SCM 工具进行检索。

#### ./jobs Subdirectory ./jobs 子目录

The `$JENKINS_HOME/jobs` directory contains information related to all the jobs you create in Jenkins.
`$JENKINS_HOME/jobs` 目录包含与您在 Jenkins 中创建的所有任务相关的信息。

- **./builds** — Contains build records
  **./builds** — 包含构建记录
- **./builds/archive** — Contains archived artifacts
  **./builds/archive** — 包含已存档的工件
  - Back this up if it is important to retain these artifacts long-term
    如果长期保留这些工件很重要，请备份这一点
  - These can be very large and may make your backups very large
    这些备份可能非常大，并且可能会使您的备份非常大
- **./workspace** — Contains files checked out from the SCM
  **./workspace** — 包含从 SCM 签出的文件
  - It is usually not necessary to back up these files. You can perform a clean checkout after restoring the system.
    通常不需要备份这些文件。您可以在恢复系统后执行干净检出。
- **./plugins/\*.hpi** — Plugin packages with specific versions used on your system
  **./plugins/\*.hpi** — 系统上使用的特定版本的插件包
- **./plugins/\*.jpi** — Plugin packages with specific versions used on your system
  **./plugins/\*.jpi** — 系统上使用的特定版本的插件包

### What may not need to be backed up 可能不需要备份的内容

The following files and directories do not usually need to be included in every routine backup because you can download the latest version when you are restoring a system. However, some disaster recovery experts recommend against doing any upgrades while restoring the system, to avoid delays caused by compatibility issues that might arise. If your disaster recovery plan specifies that you restore the system using the same software versions that were previously running, you can make an infrequent backup of the system and all downloaded tools and use that to restore the system..
通常不需要在每个例行备份中都包含以下文件和目录，因为您可以在还原系统时下载最新版本。但是，一些灾难恢复专家建议在还原系统时不要进行任何升级，以避免因可能出现的兼容性问题而导致延迟。如果您的灾难恢复计划指定使用以前运行的相同软件版本来还原系统，则可以不经常备份系统和所有下载的工具，并使用它来还原系统。

- **./war** — Exploded `war` file
  **./war** — 爆炸的 `war` 文件
  - To restore a system, download the latest `war` file.
    要恢复系统，请下载最新的 `war` 文件。
- **./cache** — Downloaded tools
  **./cache** — 下载的工具
  - To restore a system, download the current version of the tools.
    要还原系统，请下载工具的当前版本。
- **./tools** — Extracted tools
  **./tools** — 提取的工具
  - To restore a system, extract the tools again.
    要还原系统，请再次提取工具。
- **./plugins/xxx** — Subdirectories of installed plugins
  **./plugins/xxx** — 已安装插件的子目录
  - These will be automatically populated on the next restart.
    这些将在下次重新启动时自动填充。

### Validating a backup 验证备份

Your backup strategy should include validation of each backup. You do not want to learn that your backup is no good when you need it!
您的备份策略应包括对每个备份的验证。您不想在需要的时候知道您的备份没有用！

A simple way to validate a full backup is to restore it to a temporary location. Create a directory for the test validation (such as **/mnt/backup-test**) and restore the backup to that directory.
验证完整备份的一种简单方法是将其还原到临时位置。为测试验证创建一个目录（例如 **/mnt/backup-test**）并将备份还原到该目录。

Set $JENKINS_HOME to point to this directory, specifying a random HTTP port so you do not collide with the real Jenkins controller:
将 $JENKINS_HOME 设置为指向此目录，指定一个随机的 HTTP 端口，这样就不会与真正的 Jenkins 控制器发生冲突：

```
export JENKINS_HOME=/mnt/backup-test
```

Now execute the restored Jenkins controller:
现在执行还原的 Jenkins 控制器：

```
java -jar jenkins.war --httpPort=9999
```

### Summary 总结

- Making backups is a Jenkins best practice.
  进行备份是 Jenkins 的最佳实践。
- Backups are critical for disaster recovery.
  备份对于灾难恢复至关重要。
- Always set up a backup policy that defines:
  始终设置定义以下内容的备份策略：
  - The configurations and records that need to be saved from the controller
    控制器需要保存的配置和记录
  - How often backups should be taken
    应多久进行一次备份
  - Where backups should be stored
    备份的存储位置
- Validate your backups. 验证您的备份。
  - You should periodically check whether your backups are intact and can be used to meet your recovery objectives.
    您应该定期检查您的备份是否完好无损，以及是否可用于满足您的恢复目标。

# Monitoring Jenkins 监控 Jenkins

Table of Contents 目录

- [Monitoring with Datadog 使用 Datadog 进行监控](https://www.jenkins.io/doc/book/system-administration/monitoring/#monitoring-with-datadog)
- [Monitoring with Newrelic 使用 Newrelic 进行监控](https://www.jenkins.io/doc/book/system-administration/monitoring/#monitoring-with-newrelic)
- [Monitoring with Prometheus and Grafana
  使用 Prometheus 和 Grafana 进行监控](https://www.jenkins.io/doc/book/system-administration/monitoring/#monitoring-with-prometheus-and-grafana)
- [Monitoring with JavaMelody
  使用 JavaMelody 进行监控](https://www.jenkins.io/doc/book/system-administration/monitoring/#monitoring-with-javamelody)
- [Other Monitoring Plugins 其他监控插件](https://www.jenkins.io/doc/book/system-administration/monitoring/#other-monitoring-plugins)
- [Ping Thread Ping 线程](https://www.jenkins.io/doc/book/system-administration/monitoring/#ping-thread)
- [Disabling ping thread 禁用 ping 线程](https://www.jenkins.io/doc/book/system-administration/monitoring/#PingThread-Disablingpingthread)

|      | This page is under development, there will be more content added soon. See the [WEBSITE-738](https://issues.jenkins.io/browse/WEBSITE-738) EPIC for tasks related to this page, contributions are welcome!  此页面正在开发中，即将添加更多内容。有关与此页面相关的任务，请参阅 [WEBSITE-738](https://issues.jenkins.io/browse/WEBSITE-738) EPIC，欢迎贡献！ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

## Monitoring with Datadog 使用 Datadog 进行监控

- [Datadog plugin for Jenkins
  适用于 Jenkins 的 Datadog 插件](https://plugins.jenkins.io/datadog)
- [Metrics-Datadog plugin for Jenkins
  适用于 Jenkins 的 Metrics-Datadog 插件](https://plugins.jenkins.io/metrics-datadog)
- [Jenkins on Datadog Datadog 上的 Jenkins](https://www.datadoghq.com/blog/monitor-jenkins-datadog)

## Monitoring with Newrelic 使用 Newrelic 进行监控

- [Jenkins on Newrelic Newrelic 上的 Jenkins](https://opensource.newrelic.com/projects/newrelic/nr-jenkins-plugin)
- [Developing a Jenkins Integration Pipeline for the New Relic Infrastructure On-Host Integrations
  为 New Relic 基础架构主机集成开发 Jenkins 集成管道](https://newrelic.com/blog/best-practices/how-use-jenkins-integration-tests)

## Monitoring with Prometheus and Grafana 使用 Prometheus 和 Grafana 进行监控

- [Prometheus plugin for Jenkins
  适用于 Jenkins 的 Prometheus 插件](https://plugins.jenkins.io/prometheus)
- [How-To blog on Medium Medium 上的操作方法博客](https://medium.com/@eng.mohamed.m.saeed/monitoring-jenkins-with-grafana-and-prometheus-a7e037cbb376)

## Monitoring with JavaMelody 使用 JavaMelody 进行监控

- [Monitoring plugin for Jenkins
  Jenkins 的监控插件](https://plugins.jenkins.io/monitoring)

## Other Monitoring Plugins 其他监控插件

- [Versions Node Monitors 版本 节点监视器](https://plugins.jenkins.io/versioncolumn)
- [Agents Monitoring for unix nodes
  unix 节点的代理监视](https://plugins.jenkins.io/systemloadaverage-monitor)
- [Job/Queue/Slaves Monitoring
  作业/队列/从属监控](https://plugins.jenkins.io/jqs-monitoring)

## Ping Thread Ping 线程

Jenkins installs "ping thread" on every remoting connection, such as controller/agent connections, regardless of its transport mechanism (such as SSH, JNLP, etc.). The lower level of the Jenkins remoting protocol is a message oriented protocol, and a ping thread periodically sends a ping message that the receiving end will reply. The ping thread measures the time it takes for the reply to arrive, and if it’s taking excessive time (currently [4 minutes](https://github.com/jenkinsci/remoting/blob/master/src/main/java/hudson/remoting/Launcher.java) and configurable), then it assumes that the connection was lost and initiates the formal close down.
Jenkins 在每个远程连接上安装“ping 线程”，例如控制器/代理连接，而不管其传输机制（例如 SSH、JNLP 等）如何。Jenkins  远程协议的较低级别是面向消息的协议，ping 线程会定期发送接收端将回复的 ping 消息。ping  线程会测量回复到达所花费的时间，如果花费的时间过长（目前为 [4 分钟](https://github.com/jenkinsci/remoting/blob/master/src/main/java/hudson/remoting/Launcher.java)且可配置），则它会假定连接已丢失并启动正式关闭。

This is to avoid an infinite hang, as some of the failure modes in network cannot be detected otherwise. The timeout is also set to a long enough value so that a temporary surge in the load or a long garbage collection pause will not trip off the close down.
这是为了避免无限挂起，因为无法通过其他方式检测到网络中的某些故障模式。超时也被设置为足够长的值，以便负载的临时激增或长时间的垃圾回收暂停不会因关闭而跳闸。

Ping thread is installed on both controller & agent; each side pings the other and tries to detect the problem from their own sides.
Ping线程已安装在控制器和代理上;每一方都会对另一方执行 ping 操作，并尝试从自己的一侧检测问题。

The ping thread time out is reported through `java.util.logging`. In addition, the controller will also report this exception in the agent launch log. Note that some agent launchers, most notably SSH agents, writes all stdout/stderr outputs from the agent JVM into this same log file, so you need to be careful. See [JENKINS-25695](https://issues.jenkins.io/browse/JENKINS-25695).
ping 线程超时通过 `java.util.logging` 报告。此外，控制器还将在代理启动日志中报告此异常。请注意，某些代理启动器（尤其是 SSH 代理）会将代理 JVM 的所有 stdout/stderr 输出写入同一日志文件，因此您需要小心。请参阅 [JENKINS-25695](https://issues.jenkins.io/browse/JENKINS-25695)。

## Disabling ping thread 禁用 ping 线程

Sometimes, for example [to diagnose the agent connection loss problem](https://wiki.jenkins.io/display/JENKINS/Remoting+issue), you may want to disable the ping thread.  This needs to be done in two places.
有时，例如[，为了诊断代理连接丢失问题](https://wiki.jenkins.io/display/JENKINS/Remoting+issue)，您可能希望禁用 ping 线程。这需要在两个地方完成。

Disable the controller from pinging agents by setting `hudson.slaves.ChannelPinger.pingIntervalSeconds` on the controller JVM to -1.
通过在控制器 JVM 上设置为 `hudson.slaves.ChannelPinger.pingIntervalSeconds` -1 来禁用控制器对代理执行 ping 操作。

You can also change the value in memory for a running Jenkins, if you don’t want to restart Jenkins.
如果您不想重新启动 Jenkins，您还可以更改正在运行的 Jenkins 的内存中的值。

Set `pingIntervalSeconds` and `pingTimeoutSeconds on the controller` JVM to -1:
将 `pingIntervalSeconds` 和 `pingTimeoutSeconds on the controller` JVM 设置为 -1：

```
Jenkins.instance.injector.getInstance(hudson.slaves.ChannelPinger.class).@pingIntervalSeconds = -1
Jenkins.instance.injector.getInstance(hudson.slaves.ChannelPinger.class).@pingTimeoutSeconds = -1
The above will only affect newly connected agents. Existing connected agents will continue running pings.
```

To disable agents from pinging the controller, the system property
要禁用代理对控制器执行 ping 操作，请使用 system 属性

```
-Dhudson.remoting.Launcher.pingIntervalSec=-1
```

needs to be set to agents. How to do this depends on the launcher.
需要设置为 agents。如何执行此操作取决于启动器。

# Administering Jenkins on Kubernetes  在 Kubernetes 上管理 Jenkins

# Managing Jenkins with Chef  使用 Chef 管理 Jenkins

# Managing Jenkins with Puppet  使用 Puppet 管理 Jenkins

# Viewing logs 查看日志

Table of Contents 目录

- Logs on the system 系统上的日志
  - [Linux (rpm and deb) Linux（rpm 和 deb）](https://www.jenkins.io/doc/book/system-administration/viewing-logs/#linux-rpm-and-deb)
  - [Windows (msi) Windows （微星）](https://www.jenkins.io/doc/book/system-administration/viewing-logs/#windows-msi)
  - [macOS macOS 的](https://www.jenkins.io/doc/book/system-administration/viewing-logs/#macos)
  - [War file War 文件](https://www.jenkins.io/doc/book/system-administration/viewing-logs/#war-file)
  - [Docker 码头工人](https://www.jenkins.io/doc/book/system-administration/viewing-logs/#docker)
- [Logs in Jenkins Jenkins 中的日志](https://www.jenkins.io/doc/book/system-administration/viewing-logs/#logs-in-jenkins)
- [Making custom logs available outside of the web UI
  使自定义日志在 Web UI 之外可用](https://www.jenkins.io/doc/book/system-administration/viewing-logs/#making-custom-logs-available-outside-of-the-web-ui)
- [Debug logging in Jenkins 在 Jenkins 中调试日志记录](https://www.jenkins.io/doc/book/system-administration/viewing-logs/#debug-logging-in-jenkins)

## Logs on the system 系统上的日志

When running `jenkins.war` manually with `java -jar jenkins.war`, all logging information by default is output to standard out. Many Jenkins native packages modify this behavior to ensure logging  information is output in a more conventional location for the platform.
当使用 `java -jar jenkins.war` 手动运行 `jenkins.war` 时，默认情况下，所有日志记录信息都输出到 standard out。许多 Jenkins 本机软件包会修改此行为，以确保将日志记录信息输出到平台更传统的位置。

### Linux (rpm and deb) Linux（rpm 和 deb）

By default logs can be viewed by running `journalctl -u jenkins.service`.
默认情况下，可以通过运行 `journalctl -u jenkins.service` 来查看日志。

To customize the log location, run `systemctl edit jenkins` and add the following:
要自定义日志位置，请运行 `systemctl edit jenkins` 并添加以下内容：

```
[Service]
Environment="JENKINS_LOG=%L/jenkins/jenkins.log"
```

### Windows (msi) Windows （微星）

By default, logs should be at `%JENKINS_HOME%/jenkins.out` and `%JENKINS_HOME%/jenkins.err`, unless customized in `%JENKINS_HOME%/jenkins.xml`.
默认情况下，日志应位于 `%JENKINS_HOME%/jenkins.out` 和 `%JENKINS_HOME%/jenkins.err`，除非在 `%JENKINS_HOME%/jenkins.xml` 中自定义。

### macOS macOS 的

Log files should be at `/var/log/jenkins/jenkins.log`, unless customized in `org.jenkins-ci.plist`.
日志文件应位于 `/var/log/jenkins/jenkins.log`，除非在 `org.jenkins-ci.plist` 中自定义。

### War file War 文件

When Jenkins is started from a command line with `java -jar jenkins.war`, the log file will be written to the `JENKINS_HOME` directory. If no value is assigned to the `JENKINS_HOME` environment variable, the log file will be written to the `.jenkins/log` directory.
当使用 `java -jar jenkins.war` 从命令行启动 Jenkins 时，日志文件将被写入 `JENKINS_HOME` 目录。如果未为 `JENKINS_HOME` 环境变量分配任何值，则日志文件将写入 `.jenkins/log` 目录。

### Docker 码头工人

If you run Jenkins inside Docker as a detached container, you can use `docker logs <containerId>` to view the Jenkins logs.
如果您在 Docker 中将 Jenkins 作为分离容器运行，则可以使用 `docker logs <containerId>` 查看 Jenkins 日志。

## Logs in Jenkins Jenkins 中的日志

Jenkins uses `java.util.logging` for logging. The `java.util.logging` system by default sends every log above `INFO` to stdout.
Jenkins 使用 `java.util.logging` 进行日志记录。`默认情况下，java.util.logging` 系统将 `INFO` 以上的每个日志发送到 stdout。

Jenkins is equipped with a GUI for configuring/collecting/reporting log records of your choosing. This page shows you how to do this.
Jenkins 配备了一个 GUI，用于配置/收集/报告您选择的日志记录。本页介绍如何执行此操作。

First, select the "System Log" from the "Manage Jenkins" page:
首先，从 “Manage Jenkins” 页面中选择 “System Log”：

![Manage Jenkins](https://www.jenkins.io/doc/book/resources/managing/SystemLog.png)

From there, you can create a custom log recorder, which helps you group relevant logs together while filtering out the noise.
从那里，您可以创建自定义日志记录器，这可以帮助您将相关日志分组在一起，同时过滤掉噪音。

![Log Recorders](https://www.jenkins.io/doc/book/resources/managing/Log-recorder.png)

Choose a name that makes sense to you.
选择一个对您有意义的名称。

![Enter log recorder name](https://www.jenkins.io/doc/book/resources/managing/Example-logger.png)

You’ll be then asked to configure loggers and their levels whose output you’d  like to collect. Depending on which part of Jenkins you monitor, you’ll need to specify  different loggers. Tell us the symptom of your problem in the users list and we should be  able to tell you where you need to look. Also, this is really just a wrapper around the java.util.logging  package, so if you program in Java, you might be able to guess where to  look.
然后，系统会要求您配置要收集其输出的记录器及其级别。根据您监控的 Jenkins 部分，您需要指定不同的记录器。在用户列表中告诉我们您的问题的症状，我们应该能够告诉您需要查看的位置。此外，这实际上只是  java.util.logging 包的一个包装器，因此，如果您使用 Java 编程，则可能能够猜到要查找的位置。

![Specify loggers](https://www.jenkins.io/doc/book/resources/managing/Config-logger.png)

Once the set up is complete, Jenkins will start collecting data. The collected logs are available from the web UI.
设置完成后，Jenkins 将开始收集数据。收集的日志可从 Web UI 获取。

## Making custom logs available outside of the web UI 使自定义日志在 Web UI 之外可用

The simplest solution is to install the [Support Core Plugin](https://plugins.jenkins.io/support-core), which causes custom logs to be written to disk automatically.
最简单的解决方案是安装 [Support Core Plugin](https://plugins.jenkins.io/support-core)，这会导致自定义日志自动写入磁盘。

## Debug logging in Jenkins 在 Jenkins 中调试日志记录

1. Create a file `logging.properties`
   创建文件 `logging.properties`
2. Define the logging levels and a `ConsoleHandler`
   定义日志记录级别和 `ConsoleHandler`
3. Pass this file to the JVM by adding the system property `-Djava.util.logging.config.file=<pathTo>/logging.properties`.
   通过添加 system 属性 `-Djava.util.logging.config.file=<pathTo>/logging.properties` 将此文件传递给 JVM 。

An example **logging.properties** is included below.
下面包含一个示例 **logging.properties**。

|      | For a normal production environment the default level is INFO, it is not advised to have debug log in production.  对于正常的生产环境，默认级别为 INFO，不建议在生产中使用 debug log。 |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

```
handlers = java.util.logging.ConsoleHandler

# see https://docs.oracle.com/en/java/javase/17/docs/api/java.logging/java/util/logging/SimpleFormatter.html
java.util.logging.SimpleFormatter.format = [%1$tF %1$tT][%4$-6s][%2$s] %5$s %6$s %n

# Keep this level to ALL or FINEST or it will be filtered before applying other levels
java.util.logging.ConsoleHandler.level = ALL

# Default level
.level= INFO

# High verbosity for a dedicated package com.myplugin.*
com.myplugin.level = ALL
```

# Authenticating scripted clients  验证脚本化客户端

Table of Contents 目录

- [Shell with curl 带卷曲的外壳](https://www.jenkins.io/doc/book/system-administration/authenticating-scripted-clients/#shell-with-curl)
- [Shell with wget 带有 wget 的 Shell](https://www.jenkins.io/doc/book/system-administration/authenticating-scripted-clients/#shell-with-wget)
- [Groovy script using cdancy/jenkins-rest
  使用 cdancy/jenkins-rest 的 Groovy 脚本](https://www.jenkins.io/doc/book/system-administration/authenticating-scripted-clients/#groovy-script-using-cdancyjenkins-rest)
- [typescript script example using axios
  使用 Axios 的 TypeScript 脚本示例](https://www.jenkins.io/doc/book/system-administration/authenticating-scripted-clients/#typescript-script-example-using-axios)
- [Perl LWP example for a scripted client
  脚本化客户端的 Perl LWP 示例](https://www.jenkins.io/doc/book/system-administration/authenticating-scripted-clients/#Authenticatingscriptedclients-PerlLWPexampleforascriptedclient)
- [Java example with httpclient 4.3.x
  使用 httpclient 4.3.x 的 Java 示例](https://www.jenkins.io/doc/book/system-administration/authenticating-scripted-clients/#Authenticatingscriptedclients-Javaexamplewithhttpclient4.3.x)

To make scripted clients (such as wget) invoke operations that require authorization (such as scheduling a build), use HTTP BASIC authentication to specify the user name and the API token.
要使脚本化客户端（例如 wget）调用需要授权的操作（例如计划构建），请使用 HTTP BASIC 身份验证来指定用户名和 API 令牌。

Earlier versions of Jenkins require you to specify your real password, and it is only available when your security realm is password-based (for example, OpenID, Crowd and CAS plugins authenticate you without a password, so you simply don’t have any password!) Specifying the real password is still supported, but it is not recommended because the risk of revealing password, and the human tendency to reuse the same password in different places.
早期版本的 Jenkins 要求您指定真实密码，并且仅当您的安全域基于密码时才可用（例如，OpenID、Crowd 和 CAS  插件无需密码即可对您进行身份验证，因此您根本没有任何密码！仍然支持指定真实密码，但不建议这样做，因为存在泄露密码的风险，并且人为倾向于在不同位置重复使用相同的密码。

The API token is available in your personal configuration page. Click your name on the top right corner on every page, then click "Configure" to see your API token. (The URL `$root/me/configure` is a good shortcut.) You can also change your API token from here.
API 令牌位于您的个人配置页面中。单击每个页面右上角的名称，然后单击“配置”以查看您的 API 令牌。（URL `$root/me/configure` 是一个很好的快捷方式。您还可以从此处更改 API 令牌。

Note that Jenkins does not do any authorization negotiation. i.e. it immediately returns a 403 (Forbidden) response instead of a 401 (Unauthorized) response, so make sure to send the authentication information from the first request (aka "preemptive authentication").
请注意，Jenkins 不进行任何授权协商。即，它立即返回 403 （Forbidden） 响应，而不是 401 （Unauthorized） 响应，因此请确保从第一个请求发送身份验证信息（也称为“抢占式身份验证”）。

## Shell with curl 带卷曲的外壳

The `curl` command is available for most operating systems including Linux, macOS, Windows, FreeBSD, and more.
`curl` 命令适用于大多数操作系统，包括 Linux、macOS、Windows、FreeBSD 等。

```
curl -X POST -L --user your-user-name:apiToken \
    https://jenkins.example.com/job/your_job/build
```

## Shell with wget 带有 wget 的 Shell

|      | The `wget` command needs the `--auth-no-challenge` option to authenticate to Jenkins:  `wget` 命令需要 `--auth-no-challenge` 选项来向 Jenkins 进行身份验证： |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

```
wget --auth-no-challenge \
    --user=user --password=apiToken \
    http://jenkins.example.com/job/your_job/build
```

## Groovy script using cdancy/jenkins-rest 使用 cdancy/jenkins-rest 的 Groovy 脚本

The [cdancy/jenkins-rest client](https://github.com/cdancy/jenkins-rest) greatly simplifies REST API access. The following Groovy code shows how to authenticate to Jenkins and get some system info:
[cdancy/jenkins-rest 客户端](https://github.com/cdancy/jenkins-rest)大大简化了 REST API 访问。以下 Groovy 代码显示了如何向 Jenkins 进行身份验证并获取一些系统信息：

```
@Grab(group='com.cdancy', module='jenkins-rest', version='0.0.18')

import com.cdancy.jenkins.rest.JenkinsClient

JenkinsClient client = JenkinsClient.builder()
    .endPoint("http://127.0.0.1:8080") // Optional. Defaults to http://127.0.0.1:8080
    .credentials("user:apiToken") // Optional.
    .build()

println(client.api().systemApi().systemInfo())
```

For additional information, see the [cdancy/jenkins-rest wiki](https://github.com/cdancy/jenkins-rest/wiki).
有关更多信息，请参阅 [cdancy/jenkins-rest wiki](https://github.com/cdancy/jenkins-rest/wiki)。

## typescript script example using axios 使用 Axios 的 TypeScript 脚本示例

The following code shows how to create a job
以下代码演示如何创建任务

```
const credentials = `myusername:myapitoken`;
const baseJenkinsUrl = "http://myjenkins:8080";
async function getCrumb() {
    return axios({
      method: "get",
      url: baseJenkinsUrl + "/crumbIssuer/api/json",
      withCredentials: false,
    });
  }
getCrumb().then((response: any) => {
      let crumb = response.data;
     const base64Credentials = btoa(credentials);
    const authHeader = `Basic ${base64Credentials}`;
    // Create new job
    const requestConfig: AxiosRequestConfig = {
      method: "post",
      url: `${baseJenkinsUrl}/createItem?name=${jobName}`,
      headers: {
        Authorization: authHeader,
        [crumb.crumbRequestField]: crumb.crumb,
        "Content-Type": "application/xml",
      },
      data: xmlconfig,
    };
    axios(requestConfig);
});
```

## Perl LWP example for a scripted client 脚本化客户端的 Perl LWP 示例

The following Perl example uses the LWP module to start a Job via a "Trigger builds remotely" token:
下面的 Perl 示例使用 LWP 模块通过 “Trigger builds remotely” 令牌启动 Job：

```
#
# Use LWP to run a Jenkins job
# set authorization_basic on the request object
# to make use of BASIC HTTP authorization, apparently
# already handling the preemptive part correctly this
# way.
#
use strict;
use warnings;

use LWP;

my $server = 'srvname';
my $srvurl = "http://$server/jenkins";
my $uagent = LWP::UserAgent->new;
my $req = HTTP::Request->new(
  GET => "$srvurl/job/test/build?token=theTokenConfiguredForThisJob&cause=LWP+Test"
);
$req->authorization_basic('username@mydomain.com', 'apiToken');
my $res = $uagent->request($req);

# Check the outcome of the response
print "Result: " . $res->status_line . "\n";
print $res->headers->as_string;
print "\n";
if (!$res->is_success) {
  print "Failed\n";
}
else {
  print "Success!\n";
  # print $res->content, "\n";
}
```



## Java example with httpclient 4.3.x 使用 httpclient 4.3.x 的 Java 示例

This will cause httpclient 4.3 to issue authentication preemptively:
这将导致 httpclient 4.3 抢先发出身份验证：

```
import java.io.IOException;
import java.net.URI;

import org.apache.http.HttpHost;
import org.apache.http.HttpResponse;
import org.apache.http.auth.AuthScope;
import org.apache.http.auth.UsernamePasswordCredentials;
import org.apache.http.client.AuthCache;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.CredentialsProvider;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.protocol.HttpClientContext;
import org.apache.http.impl.auth.BasicScheme;
import org.apache.http.impl.client.BasicAuthCache;
import org.apache.http.impl.client.BasicCredentialsProvider;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;

public class JenkinsScraper {

    public String scrape(String urlString, String username, String password)
        throws ClientProtocolException, IOException {
        URI uri = URI.create(urlString);
        HttpHost host = new HttpHost(uri.getHost(), uri.getPort(), uri.getScheme());
        CredentialsProvider credsProvider = new BasicCredentialsProvider();
        credsProvider.setCredentials(new AuthScope(uri.getHost(), uri.getPort()),
            new UsernamePasswordCredentials(username, password));
        // Create AuthCache instance
        AuthCache authCache = new BasicAuthCache();
        // Generate BASIC scheme object and add it to the local auth cache
        BasicScheme basicAuth = new BasicScheme();
        authCache.put(host, basicAuth);
        CloseableHttpClient httpClient =
            HttpClients.custom().setDefaultCredentialsProvider(credsProvider).build();
        HttpGet httpGet = new HttpGet(uri);
        // Add AuthCache to the execution context
        HttpClientContext localContext = HttpClientContext.create();
        localContext.setAuthCache(authCache);

        HttpResponse response = httpClient.execute(host, httpGet, localContext);

        return EntityUtils.toString(response.getEntity());
    }

}
```

# Reverse proxy configuration  反向代理配置

Table of Contents 目录

- General Guidelines 一般准则
  - [Background 背景](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/#background)
- [Configuration Examples by Server Type
  按服务器类型划分的配置示例](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/#configuration-examples)

A '[reverse proxy](https://en.wikipedia.org/wiki/Reverse_proxy)' allows an alternate HTTP or HTTPS provider to communicate with web browsers on behalf of Jenkins. The alternate provider may offer additional capabilities, like SSL encryption. The alternate provider may offload some work from Jenkins, like delivering static images.
“[反向代理](https://en.wikipedia.org/wiki/Reverse_proxy)”允许备用 HTTP 或 HTTPS 提供商代表 Jenkins 与 Web 浏览器通信。备用提供商可能会提供其他功能，例如 SSL 加密。备用提供商可能会从 Jenkins 中分担一些工作，例如交付静态图像。

## General Guidelines 一般准则

Jenkins actively monitors reverse proxy configuration. Jenkins reports [“Your reverse proxy setup is broken”](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/) when it detects a reverse proxy configuration problem. Refer to the [troubleshooting](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/) section if Jenkins is reporting that your reverse proxy setup is broken.
Jenkins 会主动监控反向代理配置。Jenkins 在检测到反向代理配置问题时报告[“您的反向代理设置已损坏”。](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/)如果 Jenkins 报告您的反向代理设置已损坏，请参阅[故障排除](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/)部分。

### Background 背景

Reverse proxies receive inbound HTTP requests and forward those requests to Jenkins. It receives the outbound HTTP response from Jenkins and forwards those requests to the original requester. A correctly configured reverse proxy rewrites **both** the HTTP request and the HTTP response.
反向代理接收入站 HTTP 请求并将这些请求转发到 Jenkins。它接收来自 Jenkins 的出站 HTTP 响应，并将这些请求转发给原始请求者。正确配置的反向**代理会重写** HTTP 请求和 HTTP 响应。

When HTTP request rewriting is misconfigured, pages won’t be displayed at all. Refer to **[Configuration Examples by Server Type](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/#configuration-examples)** if your reverse proxy is not displaying any Jenkins pages.
当 HTTP 请求重写配置错误时，页面将根本不显示。如果您的反向代理未显示任何 Jenkins 页面，请参阅**[按服务器类型划分的配置示例](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/#configuration-examples)**。

A reverse proxy must handle the HTTP response by either rewriting the  response or setting HTTP headers on the forwarded request. When HTTP response handling is misconfigured, Jenkins may fail to show  updated information on a page or it may ignore changes submitted through web pages. Refer to the [troubleshooting](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/) section if Jenkins is reporting that your reverse proxy setup is broken or pages are not behaving as expected.
反向代理必须通过重写响应或在转发请求上设置 HTTP 标头来处理 HTTP 响应。当 HTTP 响应处理配置错误时，Jenkins  可能无法在页面上显示更新的信息，或者它可能会忽略通过网页提交的更改。如果 Jenkins 报告您的反向代理设置已损坏或页面未按预期运行，请参阅[故障排除](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/)部分。

## Configuration Examples by Server Type 按服务器类型划分的配置示例

Jenkins works with many different reverse proxies. This section provides examples for specific reverse proxies, though much of the information also applies to other reverse proxies.
Jenkins 适用于许多不同的反向代理。本节提供了特定反向代理的示例，但大部分信息也适用于其他反向代理。

- [Running Jenkins with Apache
  使用 Apache 运行 Jenkins](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache)
- [Running Jenkins with Nginx
  使用 Nginx 运行 Jenkins](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-nginx)
- [Running Jenkins with Lighttpd
  使用 Lighttpd 运行 Jenkins](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-lighttpd)
- [Running Jenkins with HAProxy
  使用 HAProxy 运行 Jenkins](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-haproxy)
- [Running Jenkins with Pomerium
  使用 Pomerium 运行 Jenkins](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium)
- [Running Jenkins with Squid
  使用 Squid 运行 Jenkins](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-squid)
- [Running Jenkins with IIS 使用 IIS 运行 Jenkins](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis)
- [Running Jenkins with iptables
  使用 iptables 运行 Jenkins](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iptables)

# Reverse proxy - Apache 反向代理 - Apache

Table of Contents 目录

- mod_proxy
  - [mod_proxy with HTTPS 使用 HTTPS mod_proxy](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#mod_proxy-with-https)
- [mod_rewrite](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#mod_rewrite)
- [Context path 上下文路径](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#context-path)
- [Proxying CLI commands with the HTTP(S) transport
  使用 HTTP（S） 传输代理 CLI 命令](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#proxying-cli-commands-with-the-https-transport)

In situations where you have existing web sites on your server, you may find it useful to run Jenkins (or the servlet container that Jenkins runs in) behind Apache, so that you can bind Jenkins to the part of a bigger website that you may have. This section discusses some of the approaches for doing this.
在服务器上已有 Web 站点的情况下，您可能会发现在 Apache 后面运行 Jenkins（或 Jenkins 运行的 servlet  容器）很有用，这样您就可以将 Jenkins 绑定到您可能拥有的更大 Web 站点的部分。本节讨论执行此操作的一些方法。

**Make sure that you change the Jenkins httpListenAddress from its default of 0.0.0.0 to 127.0.0.1 or any Apache-level restrictions can be easily bypassed by accessing the Jenkins port directly.
确保将 Jenkins httpListenAddress 从默认值 0.0.0.0 更改为 127.0.0.1，否则可以通过直接访问 Jenkins 端口轻松绕过任何 Apache 级别的限制。**

There are several different alternatives to configure Jenkins with Apache. Choose the technique that best meets your needs:
有几种不同的替代方法可以使用 Apache 配置 Jenkins。选择最符合您需求的技术：

- [mod_proxy](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#mod_proxy)
- [mod_proxy with HTTPS 使用 HTTPS mod_proxy](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#mod_proxy-with-https)
- [mod_rewrite](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#mod_rewrite)

This 6 minute tutorial from Darin Pope configures Apache httpd on Alma Linux as a reverse proxy with [mod_proxy](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#mod_proxy).
Darin Pope 的这个 6 分钟教程将 Alma Linux 上的 Apache httpd 配置为具有 [mod_proxy](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#mod_proxy) 的反向代理。

Configure Apache HTTP server as a reverse proxy
将 Apache HTTP 服务器配置为反向代理

<iframe width="640" height="360" src="https://www.youtube.com/embed/E3_g5wYZlfk?rel=0" frameborder="0" allowfullscreen=""></iframe>

## mod_proxy

[mod_proxy](http://httpd.apache.org/docs/2.0/mod/mod_proxy.html) works by making Apache perform "reverse proxy" — when a request arrives for certain URLs, Apache becomes a proxy and forwards that request to Jenkins, then forwards the response from Jenkins back to the client.
[mod_proxy](http://httpd.apache.org/docs/2.0/mod/mod_proxy.html)的工作原理是让 Apache 执行“反向代理”——当某些 URL 的请求到达时，Apache 成为代理并将该请求转发到 Jenkins，然后将来自 Jenkins 的响应转发回客户端。

The following Apache modules must be installed :
必须安装以下 Apache 模块：

```
a2enmod proxy
a2enmod proxy_http
a2enmod headers
```

A typical set up for mod_proxy would look like this:
mod_proxy的典型设置如下所示：

```
ProxyPass         /jenkins  http://localhost:8081/jenkins nocanon
ProxyPassReverse  /jenkins  http://localhost:8081/jenkins
ProxyRequests     Off
AllowEncodedSlashes NoDecode

# Local reverse proxy authorization override
# Most unix distribution deny proxy by default
# See /etc/apache2/mods-enabled/proxy.conf in Ubuntu
<Proxy http://localhost:8081/jenkins*>
  Order deny,allow
  Allow from all
</Proxy>
```

This assumes that you run Jenkins on port 8081.
这假设您在端口 8081 上运行 Jenkins。

[Context path](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#context-path) provides more details on reverse proxy requires for the Jenkins context path.
[Context path](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#context-path) 提供有关 Jenkins 上下文路径的反向代理要求的更多详细信息。

When running on a dedicated server and you are using / as context, make sure you add a slash at the end of all URLs in proxy params in apache. Otherwise you might run into proxy errors. So
在专用服务器上运行时，并且你使用 / 作为上下文，请确保在 apache 的代理参数中所有 URL 的末尾添加斜杠。否则，您可能会遇到代理错误。所以

```
ProxyPass / http://localhost:8080/ nocanon
```

instead of 而不是

```
ProxyPass / http://localhost:8080 nocanon     # wont work
```

Note that this does **not** apply to the `ProxyPassMatch` directive, which behaves differently than `ProxyPass`. Below is an example of `ProxyPassMatch` to proxy all URLs other than `/.well-known` (a URL required by letsencrypt):
请注意，**这不适用于** `ProxyPassMatch` 指令，该指令的行为与 `ProxyPass` 不同。下面是`一个 ProxyPassMatch` 示例，用于代理除 `/.well-known`（letsencrypt 所需的 URL）之外的所有 URL：

```
ProxyPassMatch  ^/(?\!.well-known)  http://localhost:8080 nocanon
```

The *ProxyRequests Off* prevents Apache from functioning as a forward proxy server (except for *ProxyPass*), it is advised to include it unless the server should function as a proxy.
*ProxyRequests Off* 阻止 Apache 作为转发代理服务器（*ProxyPass* 除外），建议包含它，除非服务器应该作为代理。

Both the `nocanon` option to `ProxyPass`, *and* `AllowEncodedSlashes NoDecode`, are required for certain Jenkins features to work.
`ProxyPass` 的 `nocanon` 选项*和*`AllowEncodedSlashes NoDecode` 都是某些 Jenkins 功能正常工作所必需的。

If you are running Apache on a Security-Enhanced Linux (SE-Linux) machine it is essential to make SE-Linux do the right thing by issuing as root
如果您在安全增强型 Linux （SE-Linux） 计算机上运行 Apache，则必须通过以 root 身份发出命令来使 SE-Linux 执行正确的操作

```
setsebool -P httpd_can_network_connect true
```

If this is not issued Apache will not be allowed to forward proxy requests to Jenkins and only an error message will be displayed.
如果未发出此通知，则不允许 Apache 将代理请求转发到 Jenkins，并且只会显示错误消息。

Because Jenkins already compress its output, you can not use the normal proxy-html filter to modify urls:
因为 Jenkins 已经压缩了它的输出，所以你不能使用普通的 proxy-html 过滤器来修改 urls：

```
SetOutputFilter proxy-html
```

Instead you can use the following:
相反，您可以使用以下内容：

```
SetOutputFilter INFLATE;proxy-html;DEFLATE
ProxyHTMLURLMap http://your_server:8080/jenkins /jenkins
```

But since Jenkins seems to be well behaved it’s even better to just not use SetOutputFilter and ProxyHTMLURLMap.
但是由于 Jenkins 似乎表现良好，因此最好不要使用 SetOutputFilter 和 ProxyHTMLURLMap。

If there are problems with Jenkins sometimes servicing random garbage pages, then the following may help:
如果 Jenkins 有时为随机垃圾页提供服务时出现问题，那么以下方法可能会有所帮助：

```
SetEnv proxy-nokeepalive 1
```

Some plug-ins determine URLs from client requests from Host header, so if you experience some problems with wrong URLs, you can try to switch on `ProxyPreserveHost` directive, which is switched off by default:
一些插件从 Host 标头的客户端请求中确定 URL，因此如果您遇到错误 URL 的问题，您可以尝试打开 `ProxyPreserveHost` 指令，该指令默认处于关闭状态：

```
ProxyPreserveHost On
```

### mod_proxy with HTTPS 使用 HTTPS mod_proxy

You can add an additional `ProxyPassReverse` directive to redirect non-SSL URLs generated by Jenkins to the SSL side. Assuming that your webserver is `your.host.com`, placing the following within the SSL virtual host definition will do the trick:
您可以添加额外的 `ProxyPassReverse` 指令，以将 Jenkins 生成的非 SSL URL 重定向到 SSL 端。假设您的 Web 服务器是 `your.host.com` 的，将以下内容放在 SSL 虚拟主机定义中就可以了：

```
ProxyRequests     Off
ProxyPreserveHost On
AllowEncodedSlashes NoDecode

<Proxy http://localhost:8081/jenkins*>
  Order deny,allow
  Allow from all
</Proxy>

ProxyPass         /jenkins  http://localhost:8081/jenkins nocanon
ProxyPassReverse  /jenkins  http://localhost:8081/jenkins
ProxyPassReverse  /jenkins  http://your.host.com/jenkins
```

Yet another option is to rewrite the Location headers that contain non-ssl URL’s generated by Jenkins. If you want to access Jenkins from https://www.example.com/jenkins, placing the following within the SSL virtual host definition also works:
另一种选择是重写包含 Jenkins 生成的非 ssl URL 的 Location 标头。如果要从 https://www.example.com/jenkins 访问 Jenkins，也可以在 SSL 虚拟主机定义中放置以下内容：

```
ProxyRequests     Off
ProxyPreserveHost On
ProxyPass /jenkins/ http://localhost:8081/jenkins/ nocanon
AllowEncodedSlashes NoDecode

<Location /jenkins/>
  ProxyPassReverse /
  Order deny,allow
  Allow from all
</Location>

Header edit Location ^http://www.example.com/jenkins/ https://www.example.com/jenkins/
```

But it may also work fine to just use simple forwarding as above (the first HTTPS snippet), and add
但是，只使用上述简单转发（第一个 HTTPS 代码段）并添加

```
RequestHeader set X-Forwarded-Proto "https"
RequestHeader set X-Forwarded-Port "443"
```

in the HTTPS site configuration, as the Docker demo (below) does. (`X-Forwarded-Port` is not interpreted by Jenkins prior to [JENKINS-23294](https://issues.jenkins.io/browse/JENKINS-23294) so it may also be desirable to configure the servlet container to specify the originating port.)
在 HTTPS 站点配置中，就像 Docker 演示（下面）一样。（[JENKINS-23294](https://issues.jenkins.io/browse/JENKINS-23294) 之前的 Jenkins 不会解释 `X-Forwarded-Port`，因此可能还需要配置 servlet 容器以指定原始端口。

```
NameVirtualHost *:80
NameVirtualHost *:443

<VirtualHost *:80>
    ServerAdmin  webmaster@localhost
    Redirect permanent / https://www.example.com/
</VirtualHost>

<VirtualHost *:443>
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/cert.pem
    ServerAdmin  webmaster@localhost
    ProxyRequests     Off
    ProxyPreserveHost On
    AllowEncodedSlashes NoDecode
    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>
    ProxyPass         /  http://localhost:8080/ nocanon
    ProxyPassReverse  /  http://localhost:8080/
    ProxyPassReverse  /  http://www.example.com/
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
</VirtualHost>
```



## mod_rewrite

The Apache mod_rewrite module can be used to configure an Apache reverse proxy for Jenkins.
Apache mod_rewrite 模块可用于为 Jenkins 配置 Apache 反向代理。

The following Apache modules must be installed :
必须安装以下 Apache 模块：

```
a2enmod rewrite
a2enmod proxy
a2enmod proxy_http
```

A typical mod_rewrite configuration would look like this:
典型的 mod_rewrite 配置如下所示：

```
# Use last flag because no more rewrite can be applied after proxy pass
# NE makes sure slashes are not re-encoded.
# Apache does not re-encode spaces though, we ask Apache to encode it again with the B flag
# BNP tells apache to use %20 instead of + to re-encode the space
RewriteRule       ^/jenkins(.*)$  http://localhost:8081/jenkins$1 [P,L,NE,B=\,BNP]
ProxyPassReverse  /jenkins        http://localhost:8081/jenkins
ProxyRequests     Off

AllowEncodedSlashes NoDecode

# Local reverse proxy authorization override
# Most unix distribution deny proxy by default
# See /etc/apache2/mods-enabled/proxy.conf in Ubuntu
<Proxy http://localhost:8081/jenkins*>
  Order deny,allow
  Allow from all
</Proxy>

# If using HTTPS, add the following directives
# RequestHeader set X-Forwarded-Proto "https"
# RequestHeader set X-Forwarded-Port "443"
```

This assumes that you run Jenkins on port 8081. The context path of Jenkins must be the same between Apache and Jenkins. Jenkins can’t run on http://example.com:8081/ci and be reverse proxied at http://example.com/jenkins . [Context path](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#context-path) provides more details on reverse proxy requires for the Jenkins context path.
这假设您在端口 8081 上运行 Jenkins。Apache 和 Jenkins 之间 Jenkins 的上下文路径必须相同。Jenkins 不能在  http://example.com:8081/ci 上运行并在 http://example.com/jenkins 处反向代理。[Context path](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/#context-path) 提供有关 Jenkins 上下文路径的反向代理要求的更多详细信息。

The *ProxyRequests Off* prevents Apache from functioning as a forward proxy server (except for *ProxyPass*), it is advised to include it unless the server should function as a proxy.
*ProxyRequests Off* 阻止 Apache 作为转发代理服务器（*ProxyPass* 除外），建议包含它，除非服务器应该作为代理。

## Context path 上下文路径

The context path is the prefix of a URL path. The Jenkins controller and the reverse proxy **must use the same context path**. For example, if the Jenkins controller URL is https://www.example.com/jenkins/ then the `--prefix=/jenkins` argument must be included in the Jenkins controller command line arguments.
上下文路径是 URL 路径的前缀。Jenkins 控制器和反向代理**必须使用相同的上下文路径**。例如，如果 Jenkins 控制器 URL https://www.example.com/jenkins/ 则 `--prefix=/jenkins` 参数必须包含在 Jenkins 控制器命令行参数中。

Set the context path when using the Linux packages by running `systemctl edit jenkins` and adding the following:
在使用 Linux 软件包时，通过运行 `systemctl edit jenkins` 并添加以下内容来设置上下文路径：

```
[Service]
Environment="JENKINS_PREFIX=/jenkins"
```

Set the context path on Windows controllers by including the `--prefix` command line argument in the `jenkins.xml` file in the installation directory.
通过在安装目录的 `jenkins.xml` 文件中包含 `--prefix` 命令行参数来设置 Windows 控制器上的上下文路径。

Ensure that Jenkins is running at the context path where your reverse proxy is serving Jenkins. You will have the least pain if you keep to this principle.
确保 Jenkins 在反向代理为 Jenkins 提供服务的上下文路径上运行。如果你坚持这个原则，你的痛苦会最小。

The `--prefix` command line argument is not needed if the context path is empty. For example, the URL https://jenkins.example.com/ has an empty context path.
如果上下文路径为空，则不需要 `--prefix` 命令行参数。例如，URL https://jenkins.example.com/ 具有空的上下文路径。

## Proxying CLI commands with the HTTP(S) transport 使用 HTTP（S） 传输代理 CLI 命令

Using the plain CLI protocol with the HTTP(S) transport to access Jenkins through an Apache reverse proxy does not work. See [JENKINS-47279 - Full-duplex HTTP(S) transport with plain CLI protocol does not work with Apache reverse proxy](https://issues.jenkins.io/browse/JENKINS-47279) for more details. As a workaround, you can use the [CLI over SSH](https://www.jenkins.io/doc/book/managing/cli/#ssh).
将普通 CLI 协议与 HTTP（S） 传输一起使用以通过 Apache 反向代理访问 Jenkins 是行不通的。有关更多详细信息，请参阅 [JENKINS-47279 - 使用普通 CLI 协议的全双工 HTTP（S） 传输不适用于 Apache 反向代理](https://issues.jenkins.io/browse/JENKINS-47279)。解决方法是，您可以通过 [SSH 使用 CLI](https://www.jenkins.io/doc/book/managing/cli/#ssh)。

If using Apache check that *nocanon* is set on *ProxyPass* and that *AllowEncodedSlashes* is set.
如果使用 Apache，请检查 *ProxyPass* 上是否设置了 *nocanon*，并且 *AllowEncodedSlashes* 是否设置了。

*AllowEncodedSlashes* is not inherited in Apache configs, so this directive must be placed inside the *VirtualHost* definition.
*AllowEncodedSlashes* 不会在 Apache 配置中继承，因此必须将此指令放在 *VirtualHost* 定义中。

------

# Reverse proxy - Nginx 反向代理 - Nginx

Table of Contents 目录

- [Context path 上下文路径](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-nginx/#context-path)
- [Permissions 权限](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-nginx/#permissions)

In situations where you have existing web sites on your server, you may find it useful to run Jenkins (or the servlet container that Jenkins runs in) behind [Nginx](https://nginx.org/), so that you can bind Jenkins to the part of a bigger website that you may have. This section discusses some of the approaches for doing this.
在服务器上已有 Web 站点的情况下，您可能会发现在 [Nginx](https://nginx.org/) 后面运行 Jenkins（或 Jenkins 运行的 servlet 容器）很有用，这样您就可以将 Jenkins 绑定到您可能拥有的更大网站的部分。本节讨论执行此操作的一些方法。

When a request arrives for certain URLs, Nginx becomes a proxy and forwards  that request to Jenkins, then it forwards the response back to the  client.
当收到针对某些 URL 的请求时，Nginx 会成为代理并将该请求转发给 Jenkins，然后将响应转发回客户端。

This 9 minute video tutorial from Darin Pope configures Nginx as a reverse proxy.
Darin Pope 的这个 9 分钟视频教程将 Nginx 配置为反向代理。

Configuring Nginx as a reverse proxy
将 Nginx 配置为反向代理

<iframe width="640" height="360" src="https://www.youtube.com/embed/yixMeJGtLFk?rel=0" frameborder="0" allowfullscreen=""></iframe>

The Nginx configuration fragment below provides an example Nginx reverse proxy configuration. It assumes the Jenkins controller and the Nginx reverse proxy are running on the same computer.
下面的 Nginx 配置 fragment 提供了一个示例 Nginx 反向代理配置。它假设 Jenkins 控制器和 Nginx 反向代理在同一台计算机上运行。

```
upstream jenkins {
  keepalive 32; # keepalive connections
  server 127.0.0.1:8080; # jenkins ip and port
}

# Required for Jenkins websocket agents
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

server {
  listen          80;       # Listen on port 80 for IPv4 requests

  server_name     jenkins.example.com;  # replace 'jenkins.example.com' with your server domain name

  # this is the jenkins web root directory
  # (mentioned in the output of "systemctl cat jenkins")
  root            /var/run/jenkins/war/;

  access_log      /var/log/nginx/jenkins.access.log;
  error_log       /var/log/nginx/jenkins.error.log;

  # pass through headers from Jenkins that Nginx considers invalid
  ignore_invalid_headers off;

  location ~ "^/static/[0-9a-fA-F]{8}\/(.*)$" {
    # rewrite all static files into requests to the root
    # E.g /static/12345678/css/something.css will become /css/something.css
    rewrite "^/static/[0-9a-fA-F]{8}\/(.*)" /$1 last;
  }

  location /userContent {
    # have nginx handle all the static requests to userContent folder
    # note : This is the $JENKINS_HOME dir
    root /var/lib/jenkins/;
    if (!-f $request_filename){
      # this file does not exist, might be a directory or a /**view** url
      rewrite (.*) /$1 last;
      break;
    }
    sendfile on;
  }

  location / {
      sendfile off;
      proxy_pass         http://jenkins;
      proxy_redirect     default;
      proxy_http_version 1.1;

      # Required for Jenkins websocket agents
      proxy_set_header   Connection        $connection_upgrade;
      proxy_set_header   Upgrade           $http_upgrade;

      proxy_set_header   Host              $http_host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;
      proxy_max_temp_file_size 0;

      #this is the maximum upload size
      client_max_body_size       10m;
      client_body_buffer_size    128k;

      proxy_connect_timeout      90;
      proxy_send_timeout         90;
      proxy_read_timeout         90;
      proxy_request_buffering    off; # Required for HTTP CLI commands
  }

}
```

This assumes that you run Jenkins on port 8080. Remember to create the folder /var/log/nginx/jenkins.
这假设您在端口 8080 上运行 Jenkins。请记住创建文件夹 /var/log/nginx/jenkins。

Make sure you do not end the `proxy_pass` value with a slash, as it will cause problems like those described in [this discussion](https://community.jenkins.io/t/reverse-proxy-test-does-not-handle-url-correctly/1294/16).
确保不要以斜杠结束 `proxy_pass` 值，因为它会导致本[讨论](https://community.jenkins.io/t/reverse-proxy-test-does-not-handle-url-correctly/1294/16)中描述的问题。

## Context path 上下文路径

The context path is the prefix of a URL path. The Jenkins controller and the reverse proxy **must use the same context path**. For example, if the Jenkins controller URL is https://www.example.com/jenkins/ then the `--prefix=/jenkins` argument must be included in the Jenkins controller command line arguments.
上下文路径是 URL 路径的前缀。Jenkins 控制器和反向代理**必须使用相同的上下文路径**。例如，如果 Jenkins 控制器 URL https://www.example.com/jenkins/ 则 `--prefix=/jenkins` 参数必须包含在 Jenkins 控制器命令行参数中。

Set the context path when using the Linux packages by running `systemctl edit jenkins` and adding the following:
在使用 Linux 软件包时，通过运行 `systemctl edit jenkins` 并添加以下内容来设置上下文路径：

```
[Service]
Environment="JENKINS_PREFIX=/jenkins"
```

Set the context path on Windows controllers by including the `--prefix` command line argument in the `jenkins.xml` file in the installation directory.
通过在安装目录的 `jenkins.xml` 文件中包含 `--prefix` 命令行参数来设置 Windows 控制器上的上下文路径。

Ensure that Jenkins is running at the context path where your reverse proxy is serving Jenkins. You will have the least pain if you keep to this principle.
确保 Jenkins 在反向代理为 Jenkins 提供服务的上下文路径上运行。如果你坚持这个原则，你的痛苦会最小。

The `--prefix` command line argument is not needed if the context path is empty. For example, the URL https://jenkins.example.com/ has an empty context path.
如果上下文路径为空，则不需要 `--prefix` 命令行参数。例如，URL https://jenkins.example.com/ 具有空的上下文路径。

If you are having problems with some paths (eg folders) with **Blue Ocean**, you may need to add the following snippet to your proxy configuration:
如果您在使用 **Blue Ocean** 时遇到某些路径（例如文件夹）问题，您可能需要将以下代码段添加到您的代理配置中：

```
if ($request_uri ~* "/blue(/.*)") {
    proxy_pass http://YOUR_SERVER_IP:YOUR_JENKINS_PORT/blue$1;
    break;
}
```

## Permissions 权限

To give Nginx permission to read Jenkins web root folder, add the `nginx` user to the Jenkins group:
要授予 Nginx 读取 Jenkins Web 根文件夹的权限，请将 `nginx` 用户添加到 Jenkins 组：

```
usermod -aG jenkins nginx
```

If the last command failed because the `nginx` user is not defined in the system, then you can try adding the `www-data` user to the Jenkins group:
如果最后一个命令因为系统中未定义 `nginx` 用户而失败，那么您可以尝试将 `www-data` 用户添加到 Jenkins 组：

```
usermod -aG jenkins www-data
```

If you are experiencing timeouts when attempting to run long CLI commands through a proxy in Jenkins, you can increase the `proxy_read_timeout` setting as necessary. Older versions of Jenkins may not respect the `proxy_read_timeout` setting.
如果您在尝试通过 Jenkins 中的代理运行长 CLI 命令时遇到超时，您可以根据需要增加 `proxy_read_timeout` 设置。旧版本的 Jenkins 可能不遵循 `proxy_read_timeout` 设置。

If you are experiencing the following error when attempting to run long CLI commands in Jenkins and Jenkins is running behind Nginx, it is probably due to Nginx timing out the CLI connection. You can increase the `proxy_read_timeout` setting as necessary so the command will complete successfully.
如果您在尝试在 Jenkins 中运行长 CLI 命令时遇到以下错误，并且 Jenkins 在 Nginx 后面运行，则可能是由于 Nginx 超时 CLI 连接。您可以根据需要增加 `proxy_read_timeout` 设置，以便命令成功完成。

```
WARNING: null
hudson.cli.DiagnosedStreamCorruptionException
Read back: 0x00 0x00 0x00 0x1e 0x07
           'Started reverse-proxy-test #68'
           0x00 0x00 0x00 0x01 0x07 0x0a
Read ahead:
Diagnosis problem:
    java.io.IOException: Premature EOF
        at sun.net.www.http.ChunkedInputStream.readAheadBlocking(ChunkedInputStream.java:565)
        ...
    at hudson.cli.FlightRecorderInputStream.analyzeCrash(FlightRecorderInputStream.java:82)
    at hudson.cli.PlainCLIProtocol$EitherSide$Reader.run(PlainCLIProtocol.java:153)
Caused by: java.io.IOException: Premature EOF
    at sun.net.www.http.ChunkedInputStream.readAheadBlocking(ChunkedInputStream.java:565)
    ...
    at java.io.DataInputStream.readInt(DataInputStream.java:387)
    at hudson.cli.PlainCLIProtocol$EitherSide$Reader.run(PlainCLIProtocol.java:111)
```

# Reverse proxy - HAProxy 反向代理 - HAProxy

Table of Contents 目录

- [Plain HTTP 普通 HTTP](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-haproxy/#plain-http)
- [With SSL 使用 SSL](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-haproxy/#with-ssl)
- [Context path 上下文路径](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-haproxy/#context-path)

In situations where you want a user friendly URL, different public ports, or to terminate SSL connections before they reach Jenkins, you may find it useful to run Jenkins (or the servlet container that Jenkins runs in) behind HAProxy. This section discusses some of the approaches for doing this.
在需要用户友好的 URL、不同的公共端口或在 SSL 连接到达 Jenkins 之前终止 SSL 连接的情况下，您可能会发现在 HAProxy 后面运行  Jenkins（或 Jenkins 运行的 servlet 容器）很有用。本节讨论执行此操作的一些方法。

This 6 minute video tutorial from Darin Pope configures an HAProxy reverse proxy.
Darin Pope 的这个 6 分钟视频教程配置了 HAProxy 反向代理。

Configuring an HAProxy reverse proxy
配置 HAProxy 反向代理

<iframe width="640" height="360" src="https://www.youtube.com/embed/TuTdvYfM8T8?rel=0" frameborder="0" allowfullscreen=""></iframe>

## Plain HTTP 普通 HTTP

Using HAProxy 2.6.7, here is an example HAProxy.cfg to proxy over plain HTTP:
使用 HAProxy 2.6.7，下面是一个通过纯 HTTP 进行代理的 HAProxy.cfg 示例：

```
# If you already have an haproxy.cfg file, you can probably leave the
# global and defaults section as-is, but you might need to increase the
# timeouts so that long-running CLI commands will work.
global
    maxconn 4096
    log stdout local0 debug

defaults
   log global
   option httplog
   option dontlognull
   option forwardfor
   maxconn 20
   timeout connect 5s
   timeout client 60s
   timeout server 60s

frontend http-in
  log stdout format raw local0 debug #for additional logging
  bind *:80
  mode http
  acl prefixed-with-jenkins  path_beg /jenkins
  # Use http-request redirect prefix to add /jenkins prefix to URL's location
  # to ensure jenkins base url (context path) is working properly.
  http-request redirect code 301 prefix /jenkins unless prefixed-with-jenkins
  use_backend jenkins if prefixed-with-jenkins

backend jenkins
  log stdout format raw local0 debug
  mode http
  server jenkins1 127.0.0.1:8080 check
  http-request replace-path /jenkins(/)?(.*) /\2
  http-request set-header X-Forwarded-Port %[dst_port]
  http-request add-header X-Forwarded-Proto https if { ssl_fc }
  http-request set-header X-Forwarded-Host %[req.hdr(Host)]
```

This assumes Jenkins is running locally on port 8080.
这假设 Jenkins 在端口 8080 上本地运行。

This assumes that you are using the [/jenkins](http://localhost/jenkins) context path for both the site exposed from HAProxy and Jenkins itself. If this is not the case, you will need to adjust the configuration. Refer to the HAProxy documentation on [traffic routing](https://www.haproxy.com/documentation/hapee/latest/traffic-routing/) for more information.
这假定您对从 HAProxy 和 Jenkins 本身公开的站点使用 [/jenkins](http://localhost/jenkins) 上下文路径。如果不是这种情况，您将需要调整配置。有关更多信息，请参阅有关[流量路由](https://www.haproxy.com/documentation/hapee/latest/traffic-routing/)的 HAProxy 文档。

If you are experiencing the following error when attempting to run long CLI commands in Jenkins, and Jenkins is running behind HAProxy, it is probably due to HAProxy timing out the CLI connection. You can increase the `timeout client` and `timeout server` settings as necessary so the command will complete successfully.
如果您在尝试在 Jenkins 中运行长 CLI 命令时遇到以下错误，并且 Jenkins 在 HAProxy 后面运行，则可能是由于 HAProxy 超时 CLI 连接。您可以根据需要增加 `timeout client` 和 `timeout server` 设置，以便命令成功完成。

```
WARNING: null
hudson.cli.DiagnosedStreamCorruptionException
Read back: 0x00 0x00 0x00 0x1e 0x07
           'Started reverse-proxy-test #68'
           0x00 0x00 0x00 0x01 0x07 0x0a
Read ahead:
Diagnosis problem:
    java.io.IOException: Premature EOF
        at sun.net.www.http.ChunkedInputStream.readAheadBlocking(ChunkedInputStream.java:565)
        ...
    at hudson.cli.FlightRecorderInputStream.analyzeCrash(FlightRecorderInputStream.java:82)
    at hudson.cli.PlainCLIProtocol$EitherSide$Reader.run(PlainCLIProtocol.java:153)
Caused by: java.io.IOException: Premature EOF
    at sun.net.www.http.ChunkedInputStream.readAheadBlocking(ChunkedInputStream.java:565)
    ...
    at java.io.DataInputStream.readInt(DataInputStream.java:387)
    at hudson.cli.PlainCLIProtocol$EitherSide$Reader.run(PlainCLIProtocol.java:111)
```

## With SSL 使用 SSL

Using HAProxy 2.6.7, here is an example HAProxy.cfg to connect to the proxy using SSL, terminate the SSL connection, and then talk to Jenkins using plain HTTP:
使用 HAProxy 2.6.7，下面是一个示例 HAProxy.cfg，它使用 SSL 连接到代理，终止 SSL 连接，然后使用纯 HTTP 与 Jenkins 通信：

```
# If you already have an haproxy.cfg file, you can probably leave the
# global and defaults section as-is, but you might need to increase the
# timeouts so that long-running CLI commands will work.

global
    maxconn 4096
    log stdout local0 debug

defaults
   log global
   option httplog
   option dontlognull
   option forwardfor
   maxconn 20
   timeout connect 5s
   timeout client 5m
   timeout server 5m

frontend http-in
  log stdout format raw local0 debug
  bind *:80
  bind *:443 ssl crt /usr/local/etc/haproxy/ssl/server.pem
  mode http
  acl prefixed-with-jenkins  path_beg /jenkins
  http-request redirect code 301 prefix /jenkins unless prefixed-with-jenkins
  redirect scheme https if !{ ssl_fc } # Redirect http requests to https
  use_backend jenkins if prefixed-with-jenkins

backend jenkins
  log stdout format raw  local0 debug
  mode http
  server jenkins1 127.0.0.1:8080 check
  http-request replace-path /jenkins(/)?(.*) /\2
  http-request set-header X-Forwarded-Port %[dst_port]
  http-request add-header X-Forwarded-Proto https if { ssl_fc }
  http-request set-header X-Forwarded-Host %[req.hdr(Host)]
```

## Context path 上下文路径

The context path is the prefix of a URL path. The Jenkins controller and the reverse proxy **must use the same context path**. For example, if the Jenkins controller URL is https://www.example.com/jenkins/ then the `--prefix=/jenkins` argument must be included in the Jenkins controller command line arguments.
上下文路径是 URL 路径的前缀。Jenkins 控制器和反向代理**必须使用相同的上下文路径**。例如，如果 Jenkins 控制器 URL https://www.example.com/jenkins/ 则 `--prefix=/jenkins` 参数必须包含在 Jenkins 控制器命令行参数中。

Set the context path when using the Linux packages by running `systemctl edit jenkins` and adding the following:
在使用 Linux 软件包时，通过运行 `systemctl edit jenkins` 并添加以下内容来设置上下文路径：

```
[Service]
Environment="JENKINS_PREFIX=/jenkins"
```

Set the context path on Windows controllers by including the `--prefix` command line argument in the `jenkins.xml` file in the installation directory.
通过在安装目录的 `jenkins.xml` 文件中包含 `--prefix` 命令行参数来设置 Windows 控制器上的上下文路径。

Ensure that Jenkins is running at the context path where your reverse proxy is serving Jenkins. You will have the least pain if you keep to this principle.
确保 Jenkins 在反向代理为 Jenkins 提供服务的上下文路径上运行。如果你坚持这个原则，你的痛苦会最小。

The `--prefix` command line argument is not needed if the context path is empty. For example, the URL https://jenkins.example.com/ has an empty context path.
如果上下文路径为空，则不需要 `--prefix` 命令行参数。例如，URL https://jenkins.example.com/ 具有空的上下文路径

# Reverse proxy - Pomerium 反向代理 - Pomerium

Table of Contents 目录

- [Why use Pomerium with Jenkins?
  为什么将 Pomerium 与 Jenkins 一起使用？](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium/#why-use-pomerium-with-jenkins)
- Secure Jenkins with Pomerium proxy
  使用 Pomerium 代理保护 Jenkins
  - [Before you begin 准备工作](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium/#before-you-begin)
- [Run Jenkins with Docker Compose
  使用 Docker Compose 运行 Jenkins](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium/#run-jenkins-with-docker-compose)
- [Set up your Jenkins controller
  设置 Jenkins 控制器](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium/#set-up-your-jenkins-controller)
- Configure Pomerium 配置 Pomerium
  - [Create a Pomerium configuration file
    创建 Pomerium 配置文件](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium/#create-a-pomerium-configuration-file)
  - [Run Pomerium services with Docker Compose
    使用 Docker Compose 运行 Pomerium 服务](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium/#run-pomerium-services-with-docker-compose)
- [Install Jenkins plugins 安装 Jenkins 插件](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium/#install-jenkins-plugins)
- Configure JWT authentication
  配置 JWT 身份验证
  - [Test JWT authentication 测试 JWT 身份验证](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium/#test-jwt-authentication)
- [Update your Jenkins authorization settings
  更新 Jenkins 授权设置](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium/#update-your-jenkins-authorization-settings)
- [Next steps: Add more context to your policies
  后续步骤：向策略添加更多上下文](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-pomerium/#next-steps-add-more-context-to-your-policies)

You can secure your Jenkins application with JWT authentication and custom claims behind [Pomerium](https://pomerium.com), an open source reverse proxy.
您可以使用 JWT 身份验证和开源反向代理 [Pomerium](https://pomerium.com) 背后的自定义声明来保护您的 Jenkins 应用程序。

## Why use Pomerium with Jenkins? 为什么将 Pomerium 与 Jenkins 一起使用？

You can set up role-based permissions in Jenkins to control a user’s privileges with Jenkins’ built-in authorization matrix. However, this method requires a username and password to sign in and relies on Jenkins’ user database to store credentials.
您可以在 Jenkins 中设置基于角色的权限，以使用 Jenkins 的内置授权矩阵控制用户的权限。但是，此方法需要用户名和密码才能登录，并依赖 Jenkins 的用户数据库来存储凭据。

JWT authentication is a more secure method of identity verification that  authenticates and authorizes users against an identity provider,  eliminating the need to store or share credentials to access your  Jenkins application.
JWT 身份验证是一种更安全的身份验证方法，它根据身份提供商对用户进行身份验证和授权，无需存储或共享凭据即可访问 Jenkins 应用程序。

However, Jenkins doesn’t support JWT authentication out of the box. With Pomerium, you can implement JWT authentication and apply claims to  your route’s authorization policy to determine a user’s role and  privileges before granting a user access to Jenkins.
但是，Jenkins 不支持开箱即用的 JWT 身份验证。使用 Pomerium，您可以实施 JWT 身份验证并将声明应用于路由的授权策略，以便在授予用户访问 Jenkins 之前确定用户的角色和权限。

Once you’ve configured JWT authentication, you can assign permissions within Jenkins for a specific user, any authenticated user, anonymous users,  or a user group.
配置 JWT 身份验证后，您可以在 Jenkins 中为特定用户、任何经过身份验证的用户、匿名用户或用户组分配权限。

## Secure Jenkins with Pomerium proxy 使用 Pomerium 代理保护 Jenkins

Note: This guide assumes v0.21 of Pomerium! Please refer to Pomerium’s [guide on securing Jenkins](https://www.pomerium.com/docs/guides/jenkins) for the latest version of this guide.
注意：本指南假设 Pomerium 为 v0.21！请参阅Pomerium的 [Jenkins 保护指南](https://www.pomerium.com/docs/guides/jenkins)，以获取本指南的最新版本。

### Before you begin 准备工作

To complete this guide, you need:
要完成本指南，您需要：

1. [Docker](https://docs.docker.com/get-docker/) and [Docker Compose](https://docs.docker.com/compose/install/)
   [Docker](https://docs.docker.com/get-docker/) 和 [Docker Compose](https://docs.docker.com/compose/install/)
2. An [identity provider](https://www.pomerium.com/docs/identity-providers) (IdP)
   [身份提供商](https://www.pomerium.com/docs/identity-providers) （IdP）

If you haven’t, complete the [Pomerium Core quickstart](https://www.pomerium.com/docs/quickstart) to familiarize yourself with running Pomerium in a container  environment. It is free and should take no more than five minutes to get Pomerium open source proxy running.
如果您尚未完成，请完成 [Pomerium Core 快速入门](https://www.pomerium.com/docs/quickstart)，以熟悉如何在容器环境中运行 Pomerium。它是免费的，运行Pomerium开源代理的时间不应超过五分钟。

## Run Jenkins with Docker Compose 使用 Docker Compose 运行 Jenkins

Create a project and add a file called `docker-compose.yaml`.
创建一个项目并添加一个名为 `docker-compose.yaml` 的文件。

In the `docker-compose.yaml` file, add the following code:
在 `docker-compose.yaml` 文件中，添加以下代码：

```
jenkins:
  networks:
    main: {}
  image: jenkins/jenkins:lts-jdk11
  privileged: true
  user: root
  ports:
    - 8080:8080
    - 50000:50000

  volumes:
    # File path to Jenkins_home -- stores configs, build logs, and artifacts
    - ./home/jenkins_compose/jenkins_configuration:/var/jenkins_home
    # "sock" is the Unix socket the Docker daemon listens on by default
    - ./var/run/docker.sock:/var/run/docker.sock
```



Now, run `docker compose up`.
现在，运行 `docker compose up`。

## Set up your Jenkins controller 设置 Jenkins 控制器

If your Jenkins container is set up correctly, the Setup Wizard guides you through several prompts before you can access your dashboard.
如果您的 Jenkins 容器设置正确，则 Setup Wizard 会引导您完成多个提示，然后您才能访问控制面板。

To set up your Jenkins controller:
要设置 Jenkins 控制器：

1. Go to `localhost:8080` and enter the admin user password to continue. You can find the admin user password in your Docker logs or in `/var/jenkins_home/secrets/initialAdminPassword`.
   转到 `localhost：8080` 并输入 admin 用户密码以继续。您可以在 Docker 日志或 中找到管理员用户密码 `/var/jenkins_home/secrets/initialAdminPassword` 。
2. Install the suggested plugins
   安装建议的插件
3. Create an admin user. You can create your first admin user or select **Skip and continue as admin**. If you skip and continue as admin, the default username is **admin** and the password is the admin user password.
   创建 admin 用户。您可以创建您的第一个管理员用户，也可以选择 **Skip and continue as admin（跳过并继续以管理员身份**）。如果您跳过并以 admin 身份继续，则默认用户名为 **admin**，密码为 admin 用户密码。
4. In the **Instance Configuration** window, accept the default hostname
   在 **Instance Configuration （实例配置**） 窗口中，接受默认主机名

After completing the Setup Wizard prompts, you can access the Jenkins dashboard.
完成 Setup Wizard 提示后，您可以访问 Jenkins 控制面板。

Now, run `docker compose stop` so you can configure Pomerium.
现在，运行 `docker compose stop`，以便您可以配置 Pomerium。

## Configure Pomerium 配置 Pomerium

### Create a Pomerium configuration file 创建 Pomerium 配置文件

In your project’s root folder, create a `config.yaml` file.
在项目的根文件夹中，创建一个 `config.yaml` 文件。

In your `config.yaml` file, add the following code:
在 `config.yaml` 文件中，添加以下代码：

```
authenticate_service_url: https://authenticate.localhost.pomerium.io

idp_provider: REPLACE_ME
idp_provider_url: REPLACE_ME
idp_client_id: REPLACE_ME
idp_client_secret: REPLACE_ME

signing_key: REPLACE_ME

routes:
 - from: https://verify.localhost.pomerium.io
   to: http://verify:8000
   pass_identity_headers: true
   policy:
     - allow:
         and:
	email:
	      is: user@example.com
 - from: https://jenkins.localhost.pomerium.io
   to: http://jenkins:8080/
   host_rewrite_header: true
   pass_identity_headers: true
   policy:
     - allow:
         and:
           - domain:
               is: example.com
           - user:
               is: username
```

Next, you need to: 接下来，您需要：

- Update the [identity provider](https://www.pomerium.com/docs/identity-providers) configuration variables with your own
  使用您自己的 [Identity Provider](https://www.pomerium.com/docs/identity-providers) 配置变量更新
- Replace `user@example.com` with the email associated with your IdP
  将 `user@example.com` 替换为与您的 IdP 关联的电子邮件
- Replace `example.com` with your organization’s domain name
  将 `example.com` 替换为您组织的域名
- Replace `username` with the username associated with your IdP
  将 `username` 替换为与您的 IdP 关联的用户名
- Generate a signing key 生成签名密钥

To generate a [signing key](https://www.pomerium.com/docs/reference/signing-key), use the commands below:
要生成[签名密钥](https://www.pomerium.com/docs/reference/signing-key)，请使用以下命令：

```
# Generates a P-256 (ES256) signing key
openssl ecparam  -genkey  -name prime256v1  -noout  -out ec_private.pem
# Prints the base64 encoded value of the signing key
cat ec_private.pem | base64
```

Add the base64-encoded signing key to the `signing_key` variable in your `config.yaml` file.
将 base64 编码的签名密钥添加到 `config.yaml` 文件中的 `signing_key` 变量中。

### Run Pomerium services with Docker Compose 使用 Docker Compose 运行 Pomerium 服务

In your `docker-compose.yaml` file, replace the code in the file with the Pomerium and Jenkins services below:
在 `docker-compose.yaml` 文件中，将文件中的代码替换为以下 Pomerium 和 Jenkins 服务：

```
version: '3'
networks:
 main: {}
services:
 pomerium:
   image: pomerium/pomerium:latest
   volumes:
     - ./config.yaml:/pomerium/config.yaml:ro
   ports:
     - 443:443
   networks:
     main:
       aliases:
       - authenticate.localhost.pomerium.io
 verify:
   networks:
     main: {}
   image: pomerium/verify:latest
   expose:
     - 8000
 jenkins:
   networks:
     main: {}
   image: jenkins/jenkins:lts-jdk11
   privileged: true
   user: root
   ports:
     - 8080:8080
     - 50000:50000
   volumes:
     # File path to Jenkins_home -- stores configs, build logs, and artifacts
     - ./home/jenkins_compose/jenkins_configuration:/var/jenkins_home
     # "sock" is the Unix socket the Docker daemon listens on by default
     - ./var/run/docker.sock:/var/run/docker.sock
```

Run `docker compose up` and navigate to the external Jenkins route at `https://jenkins.localhost.pomerium.io`.
运行 `docker compose up` 并导航到位于 的 `https://jenkins.localhost.pomerium.io` 外部 Jenkins 路由。

Jenkins will prompt you to sign in with your username and password. Sign in to continue to the Jenkins dashboard.
Jenkins 将提示您使用您的用户名和密码登录。登录以继续访问 Jenkins 控制面板。

## Install Jenkins plugins 安装 Jenkins 插件

Next, you need to add plugins to enable JWT authentication and bypass TLS validation.
接下来，您需要添加插件以启用 JWT 身份验证并绕过 TLS 验证。

Install the [**JWT Auth** plugin](https://plugins.jenkins.io/jwt-auth/):
安装 [**JWT Auth** 插件](https://plugins.jenkins.io/jwt-auth/)：

1. Select **Manage Jenkins**
   选择 **Manage Jenkins （管理 Jenkins**）
2. Under **System Configuration**, select **Manage Plugins**
   在 **System Configuration （系统配置）** 下，选择 **Manage Plugins （管理插件）**
3. Select **Available Plugins**
   选择 **Available Plugins**
4. In the search bar, enter **JWT Auth**
   在搜索栏中，输入 **JWT Auth**
5. Select the JWT Auth plugin and **Install without restart**
   选择 JWT Auth 插件并**安装 （Install without restart**）

Install the [**skip-certificate-check** plugin](https://plugins.jenkins.io/skip-certificate-check/):
安装 [**skip-certificate-check** 插件](https://plugins.jenkins.io/skip-certificate-check/)：

1. Select **Available Plugins**
   选择 **Available Plugins**
2. In the search bar, enter **skip-certificate-check**
   在搜索栏中，输入 **skip-certificate-check**
3. Select the skip-certificate-check plugin and **Install without restart**
   选择 skip-certificate-check 插件并**安装**

Once you’ve installed both plugins, **stop your containers**.
安装这两个插件后，**停止容器**。

## Configure JWT authentication 配置 JWT 身份验证

Go to your external Jenkins route.
转到您的外部 Jenkins 路由。

To configure JWT authentication:
要配置 JWT 身份验证：

1. Go to **Manage Jenkins**
   转到**管理 Jenkins**
2. Under **Security**, select **Configure Global Security**
   在 **Security（安全性**）下，选择 **Configure Global Security（配置全局安全性**）
3. Under **Authentication** > **Security Realm**, select **JWT Header Authentication Plugin**
   在 **Authentication** > **Security Realm （安全域）** 下，选择 **JWT Header Authentication Plugin （JWT 标头身份验证插件）**

Under **Global JWT Auth Settings**, you’ll see form fields where you can enter JWT claims. Pomerium forwards a user’s associated [identity information](https://www.pomerium.com/docs/capabilities/getting-users-identity#jwt-verification) in a signed attestation JWT that’s included in upstream requests in an `X-Pomerium-Jwt-Assertion` header.
在 **Global JWT Auth Settings （全局 JWT 身份验证设置**） 下，您将看到可在其中输入 JWT 声明的表单字段。Pomerium 在签名证明 JWT 中转发用户的关联[身份信息](https://www.pomerium.com/docs/capabilities/getting-users-identity#jwt-verification)，该 JWT 包含在 `X-Pomerium-Jwt-Assertion` 标头的上游请求中。

With the [JWT Auth](https://plugins.jenkins.io/jwt-auth) plugin installed, Jenkins can receive and parse the assertion header to authenticate users – you just need to give it the right instructions to find the header and JWT claims.
安装 [JWT Auth](https://plugins.jenkins.io/jwt-auth) 插件后，Jenkins 可以接收和解析断言标头以对用户进行身份验证——您只需为其提供正确的说明即可查找标头和 JWT 声明。

Enter the following information in the **Global JWT Auth Settings** field:
在 **Global JWT Auth Settings （全局 JWT 身份验证设置**） 字段中输入以下信息：

| Field 田                                         | Value 价值                                                   |
| ------------------------------------------------ | ------------------------------------------------------------ |
| **Header name 标头名称**                         | `x-pomerium-jwt-assertion` `x-pomerium-jwt-断言`             |
| **Username claim name 用户名声明名称**           | `name` or `email` `姓名`或`电子邮件`                         |
| **Groups claim name 组声明名称**                 | `groups` `组`                                                |
| **Groups claim list separator 组索赔列表分隔符** | `,` `、`                                                     |
| **Email claim name 电子邮件索赔名称**            | `email` `电子邮件`                                           |
| **Acceptable issuers 可接受的发卡机构**          | `authenticate.corp.example.com`                              |
| **Acceptable audiences 可接受的受众**            | `jenkins.corp.example.com`                                   |
| **JWKS JSON URL JWKS JSON 网址**                 | `https://jenkins.corp.example.com/.well-known/pomerium/jwks.json` |

Note the following details about the fields above:
请注意有关上述字段的以下详细信息：

- **Username claim name** can be either your name or email
  **用户名声明名称**可以是您的姓名或电子邮件
- **Acceptable issuers** must be the URL of the authentication domain that issued the JWT. The `iss` claim tells the target application who the issuing authority is and provides context about the subject.
  **可接受的颁发者**必须是颁发 JWT 的身份验证域的 URL。`iss` 声明告诉目标应用程序谁是颁发机构，并提供有关主题的上下文。
- **Acceptable audiences** must be the URL of the target application. The `aud` claim defines what application the JWT is intended for.
  **可接受的受众**必须是目标应用程序的 URL。`aud` 声明定义 JWT 用于哪个应用程序。
- **JWKS JSON URL** appends `/.well-known/pomerium/jwks.json` to the external route URL. The JWKS endpoint provides Jenkins the user’s public key to verify their JWT signature.
  **JWKS JSON URL** `/.well-known/pomerium/jwks.json` 附加到外部路由 URL。JWKS 终端节点为 Jenkins 提供用户的公钥，以验证其 JWT 签名。

You can go to the external `verify` route defined in your policy to view your JWT claims.
您可以转到策略中定义的外部`验证`路由来查看您的 JWT 声明。

In the **Authorization** dropdown, configure Jenkins permissions so that **Anonymous** has **Administer** privileges.
在 **Authorization** 下拉列表中，配置 Jenkins 权限，以便 **Anonymous** 具有 **Administer** 权限。

1. Select **Matrix-based security**
   选择**基于矩阵的安全性**
2. Under **Overall**, assign **Administer** to **Anonymous** and **Authenticated Users**
   在 **Overall （总体）** 下，将 **Administer （管理**） 分配给 **Anonymous** （匿名） 和 **Authenticated Users （经过身份验证的用户**）

If JWT authentication doesn’t authenticate you successfully, Jenkins signs you in as an anonymous user. With administer privileges, you can  troubleshoot JWT settings as an anonymous user and try again.
如果 JWT 身份验证未成功验证您，Jenkins 会以匿名用户身份登录。使用管理权限，您可以以匿名用户身份对 JWT 设置进行故障排除，然后重试。

Select **save** to apply the security settings.
选择 **保存** 以应用安全设置。

### Test JWT authentication 测试 JWT 身份验证

Restart your container. If the JWT authentication worked, your name appears in the dashboard instead of **admin**. To see more details about the request, add `/whoAmI` to the URL. For example, `https://jenkins.localhost.pomerium.io/whoAmI`.
重新启动容器。如果 JWT 身份验证有效，则您的姓名将显示在控制面板中，而不是 **admin**。要查看有关请求的更多详细信息，请将 `/whoAmI` 添加到 URL。例如， `https://jenkins.localhost.pomerium.io/whoAmI` .

## Update your Jenkins authorization settings 更新 Jenkins 授权设置

Now, you can configure your Jenkins authorization settings:
现在，您可以配置 Jenkins 授权设置：

1. Select **Matrix-based security**
   选择**基于矩阵的安全性**
2. Select **Add user…** and enter the name or email associated with your IdP (the value depends on what claim you entered for **Username claim name**)
   选择 **Add user...（添加用户...**），然后输入与您的 IdP 关联的名称或电子邮件（该值取决于您在 **Username claim name（用户名）声明名称**中输入的声明）

Assign yourself **Administer** privileges and whatever privileges seem appropriate to **Authenticated Users** and **Anonymous** users.
为您自己分配 **Administer** 权限以及任何适合 **Authenticated Users** 和 **Anonymous** 用户的权限。

Select **save** to apply the security changes.
选择 **保存** 以应用安全更改。

## Next steps: Add more context to your policies 后续步骤：向策略添加更多上下文

You can adjust the authorization policy within Jenkins to limit or broaden  what privileges authenticated and anonymous users have, but you can also extend your authorization policies with Pomerium.
您可以在 Jenkins 中调整授权策略，以限制或扩大经过身份验证的用户和匿名用户所拥有的权限，但您也可以使用 Pomerium 扩展您的授权策略。

For example: 例如：

- You can build a policy that only allows users to access Jenkins at certain  times of day or days of the week, or limit access to certain devices
  您可以构建一个策略，仅允许用户在一天中的特定时间或一周中的某些天访问 Jenkins，或限制对某些设备的访问
- You can import custom groups claims from your IdP and only allow access to members of the group
  您可以从 IdP 导入自定义组声明，并且仅允许组的成员访问

# Reverse proxy - Squid 反向代理 - Squid

Table of Contents 目录

- Squid 2.6 鱿鱼 2.6
  - [With ssl 使用 ssl](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-squid/#with-ssl)
- [Context path 上下文路径](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-squid/#context-path)

In situations where you want a user friendly url to access Jenkins (Not port 8080), it may make sense run Jenkins behind Squid, so that you can access Jenkins on port 80 or 443. This section discusses some of the approaches for doing this.
在您希望用户友好的 url 访问 Jenkins（不是端口 8080）的情况下，在 Squid 后面运行 Jenkins 可能是有意义的，这样您就可以在端口 80 或 443 上访问 Jenkins。本节讨论执行此操作的一些方法。

## Squid 2.6 鱿鱼 2.6

Using Squid 2.6: 使用 Squid 2.6：

```
acl all src 0.0.0.0/0.0.0.0
acl localhost src 127.0.0.1/255.255.255.255
acl manager proto cache_object
acl to_localhost dst 127.0.0.0/8
acl valid_dst dstdomain .YOUR_DOMAIN ci

cache_replacement_policy heap LFUDA
memory_replacement_policy heap GDSF

cache_dir ufs /var/spool/squid 512 16 256
cache_mem 512 MB
maximum_object_size 12000 KB

## http --> https redirect
## don't forget to update "Jenkins URL" on https://ci.YOUR_DOMAIN/configure
#acl httpPort myport 80
#http_access deny httpPort
#deny_info https://ci.YOUR_DOMAIN/ httpPort

cache_peer localhost parent 8080 0 originserver name=myAccel
coredump_dir /var/spool/squid
hierarchy_stoplist cgi-bin
http_access allow localhost
http_access allow manager localhost
http_access allow valid_dst
http_access deny all
http_access deny manager

## mkdir /etc/squid/ssl/ && cd /etc/squid/ssl/
## to generate your self-signed certificate
## openssl genrsa -out jenkins.key 1024
## openssl req -new -key jenkins.key -x509 -out jenkins.crt -days 999
http_port 80 vhost
#https_port 443 cert=/etc/squid/ssl/jenkins.crt key=/etc/squid/ssl/jenkins.key vhost

http_reply_access allow all
icp_access allow all

refresh_pattern -i \.jp(e?g|gif|png|ico)   300  20%  600 override-expire

# Combine following THREE LINES into a SINGLE LINE for Squid
logformat combined %>a %ui %un \[%tl\]
          "%rm %ru HTTP/%rv" %Hs %<st
          "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh
strip_query_terms off
access_log /var/log/squid/access.log combined

visible_hostname ci.YOUR_DOMAIN
```



This assumes that you run Jenkins on localhost port 8080. But you can have it on an other server / different port (adjust line starting with cache_peer)
这假设您在 localhost 端口 8080 上运行 Jenkins。 但是你可以把它放在其他服务器/不同的端口上 （调整以 cache_peer 开头的行）

Of course replace  YOUR_DOMAIN with your domain.
当然，将 YOUR_DOMAIN 替换为您的域。

### With ssl 使用 ssl

Remove one level of comment
删除一级注释

```
 sed s/^#// /etc/squid/squid.conf
```

Note: If you use the swarm client plugin, the nodes may report:
注意：如果您使用 swarm 客户端插件，节点可能会报告：

```
Caused by: sun.security.validator.ValidatorException:
    PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException:
        unable to find valid certification path to requested target
        at sun.security.validator.PKIXValidator.doBuild(PKIXValidator.java:285)
        at sun.security.validator.PKIXValidator.engineValidate(PKIXValidator.java:191)
        at sun.security.validator.Validator.validate(Validator.java:218)
        at c.s.n.s.i.s.X509TrustManagerImpl.validate(X509TrustManagerImpl.java:126)
        at c.s.n.s.i.s.X509TrustManagerImpl.checkServerTrusted(X509TrustManagerImpl.java:209)
        at c.s.n.s.i.s.X509TrustManagerImpl.checkServerTrusted(X509TrustManagerImpl.java:249)
        at c.s.n.s.i.s.ClientHandshaker.serverCertificate(ClientHandshaker.java:1014)
        ... 13 more
Caused by: sun.security.provider.certpath.SunCertPathBuilderException:
        unable to find valid certification path to requested target
```

You may be able to avoid that message with the `-noCertificateCheck` argument to `agent.jar`. That will disable server certificate checking from the agent.
您可以通过 `-noCertificateCheck` 参数来避免该消息 `agent.jar`.这将禁用来自代理的服务器证书检查。

## Context path 上下文路径

The context path is the prefix of a URL path. The Jenkins controller and the reverse proxy **must use the same context path**. For example, if the Jenkins controller URL is https://www.example.com/jenkins/ then the `--prefix=/jenkins` argument must be included in the Jenkins controller command line arguments.
上下文路径是 URL 路径的前缀。Jenkins 控制器和反向代理**必须使用相同的上下文路径**。例如，如果 Jenkins 控制器 URL https://www.example.com/jenkins/ 则 `--prefix=/jenkins` 参数必须包含在 Jenkins 控制器命令行参数中。

Set the context path when using the Linux packages by running `systemctl edit jenkins` and adding the following:
在使用 Linux 软件包时，通过运行 `systemctl edit jenkins` 并添加以下内容来设置上下文路径：

```
[Service]
Environment="JENKINS_PREFIX=/jenkins"
```

Set the context path on Windows controllers by including the `--prefix` command line argument in the `jenkins.xml` file in the installation directory.
通过在安装目录的 `jenkins.xml` 文件中包含 `--prefix` 命令行参数来设置 Windows 控制器上的上下文路径。

Ensure that Jenkins is running at the context path where your reverse proxy is serving Jenkins. You will have the least pain if you keep to this principle.
确保 Jenkins 在反向代理为 Jenkins 提供服务的上下文路径上运行。如果你坚持这个原则，你的痛苦会最小。

The `--prefix` command line argument is not needed if the context path is empty. For example, the URL https://jenkins.example.com/ has an empty context path.
如果上下文路径为空，则不需要 `--prefix` 命令行参数。例如，URL https://jenkins.example.com/ 具有空的上下文路径。

# Reverse proxy - IIS 反向代理 - IIS

Table of Contents 目录

- [Requirements 要求](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/#requirements)
- [Example use case 示例用例](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/#example-use-case)
- Configuration Time 配置时间
  - [Enabling Reverse Proxy functionality
    启用反向代理功能](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/#enabling-reverse-proxy-functionality)
  - [Configuring TLS/SSL 配置 TLS/SSL](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/#configuring-tlsssl)
  - [Configuring rules for response rewriting
    配置响应重写规则](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/#configuring-rules-for-response-rewriting)
  - [Experiencing the dreaded "It appears that your reverse proxy set up is broken." error for yourself
    您自己遇到可怕的“看来您的反向代理设置已损坏”错误](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/#experiencing-the-dreaded-it-appears-that-your-reverse-proxy-set-up-is-broken-error-for-yourself)
  - [Fixing the errors 修复错误](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/#fixing-the-errors)
  - [Continue configuring IIS 继续配置 IIS](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/#continue-configuring-iis)
  - [A working web.config 一个正在运行的 web.config](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/#a-working-web-config)

In situations where you have existing web sites on your server, you may find it useful to run Jenkins (or the servlet container that Jenkins runs in) behind IIS, so that you can bind Jenkins to the part of a bigger website that you may have. This section discusses some of the approaches for doing this.
在服务器上已有 Web 站点的情况下，您可能会发现在 IIS 后面运行 Jenkins（或 Jenkins 运行的 Servlet 容器）非常有用，这样您就可以将 Jenkins 绑定到您可能拥有的更大 Web 站点的部分。本节讨论执行此操作的一些方法。

**Make sure that you change the Jenkins httpListenAddress from its default of 0.0.0.0 to 127.0.0.1 or configure the firewall to block request on the port Jenkins is bound to, otherwise any IIS-level restrictions can be easily bypassed by accessing the Jenkins port directly.
确保将 Jenkins httpListenAddress 从默认值 0.0.0.0 更改为 127.0.0.1，或将防火墙配置为阻止对 Jenkins 绑定到的端口的请求，否则可以通过直接访问 Jenkins 端口轻松绕过任何 IIS 级别的限制。**

## Requirements 要求

- IIS 7.0 or greater. IIS 7.0 或更高版本。
  - IIS 8.5 or greater if you want [Certificate Rebind](https://docs.microsoft.com/en-us/iis/get-started/whats-new-in-iis-85/certificate-rebind-in-iis85).
    IIS 8.5 或更高版本（如果需要 [Certificate Rebind](https://docs.microsoft.com/en-us/iis/get-started/whats-new-in-iis-85/certificate-rebind-in-iis85)）。
- [URL Rewrite 2.1](https://www.iis.net/downloads/microsoft/url-rewrite) or greater.
  [URL 重写 2.1](https://www.iis.net/downloads/microsoft/url-rewrite) 或更高版本。
  - As the [announcement](https://blogs.iis.net/iisteam/url-rewrite-v2-1) explains, it introduces a feature flag to turn off the default non-compliant-RFC3986 behavior. Which is what we want.
    正如[公告](https://blogs.iis.net/iisteam/url-rewrite-v2-1)所解释的那样，它引入了一个功能标志来关闭默认的 non-compliant-RFC3986 行为。这就是我们想要的。
- [Application Request Routing](https://www.iis.net/downloads/microsoft/application-request-routing)  3.0 or greater.
  [应用程序请求路由](https://www.iis.net/downloads/microsoft/application-request-routing) 3.0 或更高版本。
- Server access 服务器访问

## Example use case 示例用例

I have a dedicated Jenkins installation on a Windows Server 2012 R2 server with a Common Name of **VRTJENKINS01** in the Active Directory domain **acme.example** and is reachable by the Fully Qualified Domain Name **vrtjenkins01.acme.example**. Additionally Jenkins runs on port **8080** and already listens to **127.0.0.1** instead of 0.0.0.0 and the server has additional DNS names: **jenkins** and **jenkins.acme.example**.
我在 Windows Server 2012 R2 服务器上有一个专用的 Jenkins 安装，其公用名在 Active Directory 域 **acme.example** 中为 **VRTJENKINS01**，并且可通过完全限定域名 **vrtjenkins01.acme.example** 访问。此外，Jenkins 在端口 **8080** 上运行，并且已经侦听 **127.0.0.1** 而不是 0.0.0.0，并且服务器具有其他 DNS 名称：**jenkins** 和 **jenkins.acme.example**。

I want to have an IIS installation which acts as a TLS/SSL terminating reverse proxy. In combination with our in-house Active Directory Certificate Services (ADCS, Microsoft’s Certificate Authority software) this should make certificate management a lot easier since Windows can be configured to automatically renew certificates, and the IIS 8.5+ Certificate Rebind feature can listen to renewal events (which contain the fingerprints of both the old and new certificate) and update the relevant bind(s) to use the fresh certificate. This would ensure that after the initial manual request it would only be necessary to manually change TLS/SSL related settings when the set of Alternate Subject Names on the certificate IIS presents should change.
我想安装一个 IIS 作为 TLS/SSL 终止反向代理。结合我们内部的 Active Directory 证书服务（ADCS，Microsoft  的证书颁发机构软件），这应该会使证书管理变得更加容易，因为 Windows 可以配置为自动续订证书，并且 IIS 8.5+  证书重新绑定功能可以侦听续订事件（包含旧证书和新证书的指纹）并更新相关绑定以使用新证书。这将确保在初始手动请求之后，当 IIS  提供的证书上的备用使用者名称集应更改时，只需手动更改 TLS/SSL 相关设置。

IIS will only have to act as 1) a reverse proxy for Jenkins 2) redirect non-canonical URLs to the canonical URL: *https://jenkins.acme.example/*
IIS 只需充当 1） Jenkins 的反向代理 2） 将非规范 URL 重定向到规范 URL：*https://jenkins.acme.example/*

I have installed the IIS (8.5) role using the *Add Roles and Features Wizard* with the all the default and also the following non-default features:
我使用*“添加角色和功能向导*”安装了 IIS （8.5） 角色，其中包含所有默认功能以及以下非默认功能：

- HTTP Redirection (Under *Common HTTP Features*, to redirect \http(s)://jenkins/, etc. to https://jenkins.acme.example/)
  HTTP 重定向（在*“常见 HTTP 功能*”下，将 \http（s）：//jenkins/ 等重定向到 https://jenkins.acme.example/）
- WebSocket Protocol (Under *Application Development*, because I felt like it)
  WebSocket 协议（在 *Application Development* 下，因为我觉得它）

Then I installed URL Rewrite and Application Request Routing.
然后，我安装了 URL Rewrite 和 Application Request Routing。

## Configuration Time 配置时间

### Enabling Reverse Proxy functionality 启用反向代理功能

1. In the *Internet Information Services (IIS) Manager* click on the VRTJENKINS01 server.
   在 *Internet Information Services （IIS） 管理器*中，单击 VRTJENKINS01 服务器。
2. Go to *Application Request Routing Cache*.
   转到 *Application Request Routing Cache*。
3. In the *Actions* panel click on *Server Proxy Settings…*
   在 *Actions* 面板中，单击 *Server Proxy Settings...*
4. Enable the proxy 启用代理
5. Disable the *Reverse rewrite host in response header*
   禁用 *Reverse rewrite host in response 标头*
   1. Don’t worry, it will work, just follow the rest of the instructions
      别担心，它会起作用的，只需按照其余的说明进行操作即可
6. Set the *Response buffer threshold (KB)* to 0.
   将 *Response buffer threshold （KB） （响应缓冲区阈值 （KB）* ） 设置为 0。
   1. This helps to prevent HTTP 502 errors on Jenkins' Replay pages.
      这有助于防止 Jenkins 的重放页面上出现 HTTP 502 错误。
7. Apply (the *Actions* panel again)
   Apply（再次使用 *Actions* 面板）

### Configuring TLS/SSL 配置 TLS/SSL

Out of scope, there are enough tutorials on the rest of the interwebs for this part. The rest of this tutorial will assume it has been configured with a certificate trusted by your browser of choice.
超出范围，这部分的其余 interwebs 上有足够的教程。本教程的其余部分将假设它已使用您选择的浏览器信任的证书进行配置。

### Configuring rules for response rewriting 配置响应重写规则

1. Go to the *Default Web Site*
   转到*默认网站*
2. Go to *URL Rewrite*
   转到 *URL 重写*
3. In the *Actions* panel click *View Server Variables…*
   在 *Actions* 面板中，单击 *View Server Variables...*
4. Add the following is not already define on the server level:
   添加以下内容尚未在服务器级别定义：
   1. Name: **HTTP_FORWARDED**
      名称：**HTTP_FORWARDED**
5. Click on *Back to Rules*
   点击 *Back to Rules（返回规则）*
6. *Click on Add Rule(s)… 单击 Add Rule（s）...（添加规则...）*
7. Select *Reverse Proxy* and click on OK
   选择 *Reverse Proxy* 并单击 OK
8. Enter *jenkins.acme.example* and click on OK
   输入 *jenkins.acme.example* 并单击 OK
9. Open the rule you just created
   打开您刚刚创建的规则
10. Under *Conditions* add:
    在 *Conditions （条件*） 下添加：
    1. Condition input: **{CACHE_URL}**
       条件输入：**{CACHE_URL}**
    2. Pattern: **^(http|ws)s://**
       模式：**^（http|ws）s://**
11. Under *Server Variables* add:
    在 *Server Variables （服务器变量）* 下添加：
    1. Name: **HTTP_FORWARDED**, Value: **for={REMOTE_ADDR};by={LOCAL_ADDR};host="{HTTP_HOST}";proto="https"**, Replace: yes
       名称：**HTTP_FORWARDED**，值：**for={REMOTE_ADDR};by={LOCAL_ADDR};主机=“{HTTP_HOST}”;proto=“https”**， 替换： yes
       1. Jenkins runs under Jetty, Jetty supports [RFC7239](https://tools.ietf.org/html/rfc7239), so all should be well.
          Jenkins 在 Jetty 下运行，Jetty 支持 [RFC7239](https://tools.ietf.org/html/rfc7239)，所以一切都应该很好。
12. Under Action change: 在 Action change （操作更改） 下：
    1. Rewrite URL to **\{C:1}\://jenkins.acme.example:8080{UNENCODED_URL}**
       将 URL 重写为 **\{C：1}\：//jenkins.acme.example：8080{UNENCODED_URL}**
       1. Note that there is no slash between the port number and the opening curly bracket
          请注意，端口号和左大括号之间没有斜杠
    2. **Remove** the check from the **Append query string** checkbox
       **从** **Append query string （附加查询字符串**） 复选框中删除复选标记
13. Apply the changes. 应用更改。
14. Edit *C:\Windows\System32\drivers\etc\hosts* so that **jenkins.acme.example** points to 127.0.0.1
    编辑 *C：\Windows\System32\drivers\etc\hosts*，使 **jenkins.acme.example** 指向 127.0.0.1
    1. When resolving names Windows will check if the name is its own name before consulting the hosts file. Meaning that adding *vrtjenkins01* or *vrtjenkins01.acme.example* to the hosts file won’t have any effect.
       解析名称时，Windows 将在查阅 hosts 文件之前检查该名称是否为自己的名称。这意味着将 *vrtjenkins01* 或 *vrtjenkins01.acme.example* 添加到 hosts 文件不会产生任何影响。
       1. The hosts file will however be consulted before consulting the DNS infrastructure
          但是，在咨询 DNS 基础设施之前，将查阅 hosts 文件

### Experiencing the dreaded "It appears that your reverse proxy set up is broken." error for yourself 您自己遇到可怕的“看来您的反向代理设置已损坏”错误

1. https://jenkins.acme.example/configure
2. Configure the *Jenkins URL* to be **https://jenkins.acme.example/** and save the change
   将 *Jenkins URL* 配置为 **https://jenkins.acme.example/** 并保存更改
3. Go to *Security* and enable *Enable proxy compatibility* if you have already enabled *Prevent Cross Site Request Forgery exploits*
   转到*安全*并启用 *启用启用代理兼容性* 防止*跨站点请求伪造漏洞*
4. Go to https://jenkins.acme.example/manage
   转至 https://jenkins.acme.example/manage
5. You will still experience the "It appears that your reverse proxy set up is broken." as expected
   您仍会如预期般地遇到“看来您的反向代理设置已损坏”。
   1. If you do not get that at this point, then that is very weird… Continue anyway.
      如果你现在不明白，那就太奇怪了......无论如何都要继续。
6. Right click the *System* link and choose to inspect the element.
   右键单击 *System* 链接，然后选择检查元素。
   1. Make sure you are still on the Manage page as you will want it as your referrer
      确保您仍在 Manage （管理） 页面上，因为您希望它作为您的反向链接
7. Change the value of the *href* attribute to be *administrativeMonitor/hudson.diagnosis.ReverseProxySetupMonitor/test*
   将 *href* 属性的值更改为 *administrativeMonitor/hudson.diagnosis.ReverseProxySetupMonitor/test*
8. Open the link you just changed in a new tab.
   在新选项卡中打开您刚刚更改的链接。
   1. Keep this tab open 保持此选项卡打开
9. Observe the "https://jenkins.acme.example/manage vs http:" error and bask in its glory
   观察 “https://jenkins.acme.example/manage vs http：” 错误并沉浸在它的荣耀中
   1. a white page served with HTTP status code is 200 indicates all is well
      使用 HTTP 状态代码提供的白色页面为 200 表示一切正常
      1. If you do get that at this point, then that is very weird… Continue anyway.
         如果你在这一点上真的明白了，那就太奇怪了......无论如何都要继续。

### Fixing the errors 修复错误

1. In IIS Manager got to *Application Pools* then edit *DefaultAppPool* so that the *.NET CLR version* is **No Managed Code**
   在 IIS 管理器中，转到*应用程序池，*然后编辑 *DefaultAppPool*，以便 *.NET CLR 版本*为**“无托管代码**”
   1. You might find that this is not necessary (at far as you can tell) for your setup, since IIS will only act as a TLS/SSL offloading reverse proxy, we don’t need it.
      您可能会发现这对您的设置不是必需的（据您所知），因为 IIS 仅充当 TLS/SSL 卸载反向代理，我们不需要它。
2. Then go to *Sites* → *Default Web Site* → *Request Filtering* and in the *Actions* panel choose *Edit Feature Settings…* and turn on **Allow double escaping**
   然后转到 *Sites* → *Default Web Site* → *Request Filtering*，在 *Actions* 面板中选择 *Edit Feature Settings...*，并打开 **Allow double estruing**
   1. This is so IIS forwards URLs like https://jenkins.acme.example/%2525 to Jenkins instead of showing an IIS error page
      这样，IIS 就会将 https://jenkins.acme.example/%2525 等 URL 转发到 Jenkins，而不是显示 IIS 错误页面
3. Last, but not least, go to *Sites* → *Default Web Site* → *Configuration Editor* and change the *Section* to *system.webServer/rewrite/rules*
   最后但并非最不重要的一点是，转到 *Sites* → *Default Web Site* *→ Configuration Editor*，并将 *Section* 更改为 *system.webServer/rewrite/rules*
4. Now you should see the URL Rewrite 2.1 property *useOriginalURLEncoding* listed, if not install URL Rewrite 2.1 using the x86 or x64 installer, not the WebPI one and resume from here after a reboot.
   现在，您应该会看到列出了 URL 重写 2.1 属性 *useOriginalURLEncoding*，如果没有，请使用 x86 或 x64 安装程序（而不是 WebPI 安装程序）安装 URL 重写 2.1，并在重新启动后从此处恢复。
5. Change *useOriginalURLEncoding* to **False**
   将 *useOriginalURLEncoding* 更改为 **False**
   1. As the URL Rewrite 2.1 announcement this will change the value of {UNENCODED_URL} to make it *RFC3986* and usable for reverse proxy forwarding purposes
      作为 URL 重写 2.1 公告，这将更改 {UNENCODED_URL} 的值，使其*RFC3986*并可用于反向代理转发目的
   2. original as in pre 2.1 behaviour.
      original 与 2.1 之前的行为相同。
6. Refresh that tab you were supposed to keep open, or recreate it.
   刷新您应该保持打开状态的选项卡，或重新创建它。
   1. Again, take some time to bask in its glory
      再一次，花点时间沐浴在它的荣耀中
7. It should now be white, also the Manage page should no longer complain!
   它现在应该是白色的，管理页面也不应该再抱怨了！

### Continue configuring IIS 继续配置 IIS

Some of the things you might want but I won’t cover:
您可能想要但我不会介绍的一些内容：

- *Hypertext Strict Transport Security* headers
  *超文本 Strict Transport Security* 标头
- Redirecting from non canonical URLs to the canonical URL (ok, sort of covered this in the web.config example)
  从非规范 URL 重定向到规范 URL（好的，在 web.config 示例中介绍了这一点）
- The X-UA-Compatibility header so that Internet Explorer 11 (or 9, or …) won’t claim to be IE 7 for intranet sites
  X-UA-Compatibility 标头，以便 Internet Explorer 11（或 9 或...）不会声称是 Intranet 站点的 IE 7
- Use IIS Crypto to configure cipher suites
  使用 IIS Crypto 配置密码套件
- …

### A working web.config 一个正在运行的 web.config

**web.config**

```
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules useOriginalURLEncoding="false">
        <rule name="CanonicalHostNameRule2" stopProcessing="true">
          <match url="(.*)" />
          <conditions trackAllCaptures="true">
            <add input="{CACHE_URL}" pattern="^(http|ws)://" />
            <add input="{HTTP_HOST}"
                 pattern="^jenkins$|^jenkins\.acme\.example$|
                          ^vrtjenkins01$|^vrtjenkins01\.acme\.example$" />
          </conditions>
          <action type="Redirect"
                  url="{C:1}s://jenkins.acme.example{UNENCODED_URL}"
                  appendQueryString="false"
                  redirectType="Permanent" />
        </rule>
        <rule name="CanonicalHostNameRule1" stopProcessing="true">
          <match url="(.*)" />
          <conditions trackAllCaptures="true">
            <add input="{CACHE_URL}" pattern="^(https|wss)://" />
            <add input="{HTTP_HOST}" pattern="^jenkins$|^vrtjenkins01$|
                                              ^vrtjenkins01\.acme\.example$" />
          </conditions>
          <action type="Redirect"
                  url="{C:1}://jenkins.acme.example{UNENCODED_URL}"
                  appendQueryString="false" redirectType="Permanent" />
        </rule>
        <rule name="ReverseProxyInboundRule1" stopProcessing="true">
          <match url="(.*)" />
          <action type="Rewrite"
                  url="{C:1}://jenkins.acme.example:8080{UNENCODED_URL}"
                  appendQueryString="false" />
          <serverVariables>
            <set name="HTTP_FORWARDED"
                 value="for={REMOTE_ADDR};
                        by={LOCAL_ADDR};
                        host=&quot;{HTTP_HOST}&quot;;
                        proto=&quot;https&quot;" />
          </serverVariables>
          <conditions trackAllCaptures="true">
            <add input="{CACHE_URL}" pattern="^(http|ws)s://" />
            <add input="{HTTP_HOST}" pattern="^jenkins\.acme\.example$" />
          </conditions>
        </rule>
      </rules>
    </rewrite>
    <security>
      <requestFiltering allowDoubleEscaping="true" />
    </security>
  </system.webServer>
</configuration>
```

# Reverse proxy - iptables 反向代理 - iptables

Table of Contents 目录

- [Ubuntu Installations Ubuntu 安装](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iptables/#ubuntu-installations)
- [Prerequisites 先决条件](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iptables/#prerequisites)
- Forwarding 转发
  - [Saving iptables Configuration
    保存 iptables 配置](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iptables/#saving-iptables-configuration)
- [Using firewalld 使用 firewalld](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iptables/#using-firewalld)

The default Jenkins installation runs on ports 8080 and 8443. Typically, HTTP/HTTPS servers run on ports 80 and 443, respectively. But these ports are considered privileged on Unix/Linux systems, and the process using them must be owned by root. Running Jenkins as root is not recommended - it should be run as its own user. One solution is to front Jenkins with a web server such as Apache, and let it proxy requests to Jenkins, but this requires maintaining the Apache installation as well. In situations where you are wanting to run Jenkins on port 80 or 443 (i.e. HTTP/HTTPS), but you do not want to setup a proxy server you can use *iptables* on Linux to forward traffic.
默认 Jenkins 安装在端口 8080 和 8443 上运行。通常，HTTP/HTTPS 服务器分别在端口 80 和 443  上运行。但是这些端口在 Unix/Linux 系统上被视为特权端口，使用它们的进程必须由 root 拥有。不建议以 root 身份运行  Jenkins - 它应该以自己的用户身份运行。一种解决方案是在 Jenkins 前面使用 Web 服务器（如 Apache），并让它代理请求到 Jenkins，但这也需要维护 Apache 安装。如果您想在端口 80 或 443（即 HTTP/HTTPS）上运行  Jenkins，但又不想设置代理服务器，您可以在 Linux 上使用 *iptables* 来转发流量。

## Ubuntu Installations Ubuntu 安装

Follow the [Ubuntu installation instructions](https://www.jenkins.io/doc/book/installing/#debianubuntu) to install and configure the initial Jenkins installation on a supported version of Ubuntu. These instructions are known to not work on Ubuntu versions that are no longer supported by the Ubuntu project.
按照 [Ubuntu 安装说明](https://www.jenkins.io/doc/book/installing/#debianubuntu)在受支持的 Ubuntu 版本上安装和配置初始 Jenkins 安装。已知这些说明不适用于 Ubuntu 项目不再支持的 Ubuntu 版本。

## Prerequisites 先决条件

In order to forward traffic from 80/443 to 8080/8443, first you must ensure that iptables has allowed traffic on all 4 of these ports. Use the following command to list the current iptables configuration:
为了将流量从 80/443 转发到 8080/8443，首先必须确保 iptables 已允许所有 4 个端口上的流量。使用以下命令列出当前的 iptables 配置：

```
 iptables -L -n
```

You should see in the output entries for 80, 443, 8080, and 8443. Here is an example output for comparison.
您应该在输出条目中看到 80、443、8080 和 8443。下面是用于比较的示例输出。

```
ain INPUT (policy ACCEPT)target     prot opt source               destination
target     prot opt source               destination
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:443
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:80
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:8080
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:8443
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0           state NEW tcp dpt:22
REJECT     all  --  0.0.0.0/0            0.0.0.0/0           reject-with icmp-host-prohibited

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination
REJECT     all  --  0.0.0.0/0            0.0.0.0/0           reject-with icmp-host-prohibited

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
target     prot opt source
```

If you dont see entries for these ports, then you need to run commands (as root or with sudo) to add those ports. For example, if you see none of these and need to add them all, you would need to issue the following commands:
如果您没有看到这些端口的条目，则需要运行命令（以 root 身份或使用 sudo）来添加这些端口。例如，如果您没有看到这些命令，并且需要将它们全部添加，则需要发出以下命令：

```
sudo iptables -I INPUT 1 -p tcp --dport 8443 -j ACCEPT
sudo iptables -I INPUT 1 -p tcp --dport 8080 -j ACCEPT
sudo iptables -I INPUT 1 -p tcp --dport 443 -j ACCEPT
sudo iptables -I INPUT 1 -p tcp --dport 80 -j ACCEPT
```

- NOTE 注意

  I used -I INPUT 1. In a lot of iptables documentation/examples, you will see -A INPUT. The difference is that -A appends to the list of rules, while -I INPUT 1 inserts before the first entry. Usually when adding new accept ports to iptables configuration, you want to put them at the beginning of the ruleset, not the end. Run iptables -L -n again and you should now see entries for these 4 ports. 我使用了 -I INPUT 1。在许多 iptables 文档/示例中，你会看到 -A INPUT。区别在于 -A 附加到规则列表，而 -I INPUT 1 在第一个条目之前插入。通常，当向 iptables 配置添加新的 accept 端口时，您希望将它们放在规则集的开头，而不是结尾。再次运行 iptables -L -n，您现在应该可以看到这 4 个端口的条目。

## Forwarding 转发

Once traffic on the required ports are allowed, you can run the command to forward port 80 traffic to 8080, and port 443 traffic to 8443. The commands look like this:
允许所需端口上的流量后，您可以运行命令将端口 80 流量转发到 8080，将端口 443 流量转发到 8443。命令如下所示：

```
sudo iptables -A PREROUTING -t nat -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 8080
sudo iptables -A PREROUTING -t nat -i eth0 -p tcp --dport 443 -j REDIRECT --to-port 8443
```

You can verify the forwarding rules using below command.
您可以使用以下命令验证转发规则。

```
[root@xyz~]# iptables -L -t nat
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination
REDIRECT   tcp  --  anywhere             anywhere             tcp dpt:http redir ports 8080
REDIRECT   tcp  --  anywhere             anywhere             tcp dpt:https redir ports 8443

Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
+
```

Once these rules are set and confirmed with iptables -L -n, and once your Jenkins controller is up and running on port 8080, attempt to access your Jenkins controller on port 80 instead of 8080. It should work and your URL should stay on port 80 - in other words, it should not get redirected to 8080. The fact that forwarding from 80 to 8080 (or 443 to 8443) should remain hidden from the client.
设置并使用 iptables -L -n 确认这些规则后，一旦您的 Jenkins 控制器在端口 8080 上启动并运行，请尝试在端口 80 而不是  8080 上访问您的 Jenkins 控制器。它应该可以工作，并且您的 URL 应该保持在端口 80 上 - 换句话说，它不应该被重定向到  8080。从 80 到 8080（或从 443 到 8443）的转发应该对客户端保持隐藏。

### Saving iptables Configuration 保存 iptables 配置

Using the iptables command to change port configuration and routing rules only changes the current, in-memory configuration. It does not persist between restarts of the iptables service. So, you need to make sure you save the configuration to make the changes permanent.
使用 iptables 命令更改端口配置和路由规则只会更改当前的内存中配置。它不会在 iptables 服务重新启动之间保留。因此，您需要确保保存配置以使更改永久生效。

Saving the configuration is slightly different between Red Hat rpm based and Debian-based systems. On Red Hat-based systems (Red Hat Enterprise Linux, Fedora, Alma Linux,  Rocky Linux, Oracle Linux, CentOS, etc), issue the following command:
在基于 Red Hat rpm 和基于 Debian 的系统之间保存配置略有不同。在基于 Red Hat 的系统（Red Hat Enterprise Linux、Fedora、Alma Linux、Rocky Linux、Oracle Linux、CentOS 等）上，发出以下命令：

```
sudo iptables-save > /etc/sysconfig/iptables
```

On a Debian-based system (Debian, Ubuntu, Mint, etc), issue the following command:
在基于 Debian 的系统（Debian、Ubuntu、Mint 等）上，发出以下命令：

```
sudo sh -c "iptables-save > /etc/iptables.rules"
```

The iptables-restore command will need to be executed manually, or your system configured to automatically run it on boot, against the /etc/iptables.rules file you have created, in order for your iptables configuration to be retained across reboots. On Ubuntu, the fastest way is to install `iptables-persistent` after configuring iptables. It will automatically create the required files from the current configuration and load them on boot.
iptables-restore 命令需要手动执行，或者您的系统配置为在启动时根据您创建的 /etc/iptables.rules 文件自动运行它，以便在重新启动后保留您的  iptables 配置。在 Ubuntu 上，最快的方法是在配置 iptables 后安装 `iptables-persistent`。它将自动从当前配置中创建所需的文件，并在启动时加载它们。

```
sudo apt-get install iptables-persistent
```

See https://help.ubuntu.com/community/IptablesHowTo for other Ubuntu options. There are many other resources describing this; please consult your system’s documentation or search on the internet for information specific to your flavor of Linux.
有关其他 Ubuntu 选项，请参阅 https://help.ubuntu.com/community/IptablesHowTo。还有许多其他资源对此进行了描述;请查阅您的系统文档或在 Internet 上搜索特定于您的 Linux 类型的信息。

If you are unsure at all about what kind of system you have, consult that system’s documentation on how to update iptables configuration.
如果你对你拥有的系统类型完全不确定，请查阅该系统的文档以了解如何更新 iptables 配置。

## Using firewalld 使用 firewalld

Some Linux distributions (Red Hat Enterprise Linux, Rocky Linux, Alma Linux, Oracle Linux, CentOS, etc.) ship with firewalld which serves as a front-end for iptables. Configuration thru firewalld is done via the **firewall-cmd** command. Instead of using any of the iptables commands mentioned above, all you should need to do is something like: 

```
# allow incoming connections on port 80.
# You can also use --add-service=http instead of adding a port number
sudo firewall-cmd --add-port=80/tcp --permanent
sudo firewall-cmd --permanent \
                  --add-forward-port=port=80:proto=tcp:toaddr=127.0.0.1:toport=8080

# allow incoming connections on port 443.
# You can also use --add-service=https instead of adding a port number
sudo firewall-cmd --add-port=443/tcp --permanen
t
sudo firewall-cmd --permanent \
                  --add-forward-port=port=443:proto=tcp:toaddr=127.0.0.1:toport=8443
sudo firewall-cmd --reload
```



With the above commands, jenkins can be configured to run on localhost:8080 and/or localhost:8443 (depending if you need or want to do SSL or not)
使用上述命令，可以将 jenkins 配置为在 localhost：8080 和/或 localhost：8443 上运行（取决于你是否需要或想要使用 SSL）

firewalld will then create the required iptables rules so that incoming connections on port 80 are forwarded to jenkins on 8080 (and 443 is forwarded to 8443).
然后，firewalld 将创建所需的 iptables 规则，以便端口 80 上的传入连接转发到 8080 上的 Jenkins（443 转发到 8443）。

# Reverse proxy - Issues 反向代理 - 问题

Table of Contents 目录

- [Symptoms 症状](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/index.html#jenkins-says-my-reverse-proxy-setup-is-broken)
- [Background 背景](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/index.html#troubleshooting)
- [Context path 上下文路径](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/index.html#context-path)
- [Further Diagnosis 进一步诊断](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/index.html#further-diagnosis)

## Symptoms 症状

An error message is displayed in the "Manage Jenkins" page
“Manage Jenkins” 页面中显示错误消息

```
It appears that your reverse proxy setup is broken
```

|      | This message can also appear if you don’t access Jenkins through a reverse proxy: Make sure the Jenkins URL configured in the System Configuration matches the URL you’re using to access Jenkins.  如果您不通过反向代理访问 Jenkins，也可能显示此消息：确保在系统配置中配置的 Jenkins URL 与您用于访问 Jenkins 的 URL 匹配。 |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

## Background 背景

For a reverse proxy to work correctly, it needs to rewrite both the request and the response. Request rewriting involves receiving an inbound HTTP call and then making a forwarding request to Jenkins (sometimes with some HTTP headers modified, sometimes not). Failing to configure the request rewriting is easy to catch, because you just won’t see any pages at all.
要使反向代理正常工作，它需要重写请求和响应。请求重写涉及接收入站 HTTP 调用，然后向 Jenkins 发出转发请求（有时修改了一些 HTTP 标头，有时不修改）。未能配置请求重写很容易被发现，因为您根本看不到任何页面。

But correct reverse proxying also involves **one of two options**, EITHER
但正确的反向代理还涉及**以下两个选项之一**，要么

- **rewrite the response** with a "Location" header in the response, which is used during redirects. Jenkins sends `Location: http://actual.server:8080/jenkins/foobar` and the reverse proxy must rewrite it to `Location: http://nice.name/jenkins/foobar`. Unfortunately, failing to configure this correctly is harder to catch; OR
  在响应中使用 “Location” 标头**重写响应**，该标头在重定向期间使用。Jenkins 发送 `Location: http://actual.server:8080/jenkins/foobar` ，反向代理必须将其重写为 `Location: http://nice.name/jenkins/foobar` 。遗憾的是，未能正确配置此项将更难捕获;或
- **set the headers** `X-Forwarded-Host` (and perhaps `X-Forwarded-Port`) on the forwarded request. Jenkins will parse those headers and generate all the redirects and other links on the basis of those headers. Depending on your reverse proxy it may be easier to set `X-Forwarded-Host` and `X-Forwarded-Port` to the hostname and port in the original `Host` header respectively or it may be easier to just pass the original `Host` header through as  `X-Forwarded-Host` and delete the `X-Forwarded-Port` # header from the request. You will also need to set the `X-Forwarded-Proto` header if your reverse proxy is changing from `https` to `http` or vice-versa.
  在转发的请求**上设置标头**`X-Forwarded-Host`（可能还有 `X-Forwarded-Port`）。Jenkins 将解析这些标头，并根据这些标头生成所有重定向和其他链接。根据您的反向代理，将 `X-Forwarded-Host` 和 `X-Forwarded-Port` 分别设置为原始 `Host` 标头中的主机名和端口可能更容易，或者将原始 `Host` 标头作为 `X-Forwarded-Host` 传递并从请求中删除 `X-Forwarded-Port` # 标头可能更容易。如果您的反向代理从 `https` 更改为 `http`，您还需要设置 `X-Forwarded-Proto` 标头，反之亦然。

Jenkins has proactive monitoring to make sure this is configured correctly. It uses XmlHttpRequest to request a specific URL in Jenkins (via relative path, so this will always get through provided the request is properly rewritten), which will then redirect the user to another page in Jenkins (this only works correctly if you configured the response rewriting correctly), which then returns 200.
Jenkins 具有主动监控功能，以确保配置正确。它使用 XmlHttpRequest 在 Jenkins 中请求一个特定的  URL（通过相对路径，因此如果请求被正确重写，这将始终通过），然后将用户重定向到 Jenkins  中的另一个页面（这只有在您正确配置了响应重写时才能正常工作），然后返回 200。

This error message indicates that this test is failing - and the most likely cause is that the response rewriting is misconfigured. See the  [configuration examples](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/) for additional tips about configuring a reverse proxy.
此错误消息指示此测试失败 - 最可能的原因是响应重写配置错误。请参阅 [配置示例](https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/) 有关配置反向代理的其他提示。

Be sure to set the `X-Forwarded-Proto` header if your reverse proxy is accessed via HTTPS and then Jenkins itself is accessed via HTTP i.e. proxying HTTPS to HTTP.
如果您的反向代理是通过 HTTPS 访问的，然后通过 HTTP 访问 Jenkins 本身，请务必设置 `X-Forwarded-Proto` 标头，即将 HTTPS 代理为 HTTP。

## Context path 上下文路径

The context path is the prefix of a URL path. The Jenkins controller and the reverse proxy **must use the same context path**. For example, if the Jenkins controller URL is https://www.example.com/jenkins/ then the `--prefix=/jenkins` argument must be included in the Jenkins controller command line arguments.
上下文路径是 URL 路径的前缀。Jenkins 控制器和反向代理**必须使用相同的上下文路径**。例如，如果 Jenkins 控制器 URL https://www.example.com/jenkins/ 则 `--prefix=/jenkins` 参数必须包含在 Jenkins 控制器命令行参数中。

Set the context path when using the Linux packages by running `systemctl edit jenkins` and adding the following:
在使用 Linux 软件包时，通过运行 `systemctl edit jenkins` 并添加以下内容来设置上下文路径：

```
[Service]
Environment="JENKINS_PREFIX=/jenkins"
```

Set the context path on Windows controllers by including the `--prefix` command line argument in the `jenkins.xml` file in the installation directory.
通过在安装目录的 `jenkins.xml` 文件中包含 `--prefix` 命令行参数来设置 Windows 控制器上的上下文路径。

Ensure that Jenkins is running at the context path where your reverse proxy is serving Jenkins. You will have the least pain if you keep to this principle.
确保 Jenkins 在反向代理为 Jenkins 提供服务的上下文路径上运行。如果你坚持这个原则，你的痛苦会最小。

The `--prefix` command line argument is not needed if the context path is empty. For example, the URL https://jenkins.example.com/ has an empty context path.
如果上下文路径为空，则不需要 `--prefix` 命令行参数。例如，URL https://jenkins.example.com/ 具有空的上下文路径。

Changing the context path of Jenkins with a reverse proxy is fraught with danger. There are many URLs that must be rewritten. Even if you rewrite all the URLs in HTML files, you may miss some in JavaScript, CSS, or XML resources.
使用反向代理更改 Jenkins 的上下文路径充满了危险。有许多 URL 必须重写。即使您重写了 HTML 文件中的所有 URL，您也可能会错过 JavaScript、CSS 或 XML 资源中的一些 URL。

While it is technically possible to use rewrite rules to change the context path, you should be aware that it would be a lot of work to find and fix everything in your rewrite rules and the reverse proxy will spend most of its time rewriting responses from Jenkins. Much easier to change Jenkins to run at the context path your reverse proxy is expecting, e.g. if your reverse proxy is forwarding requests at https://manchu.example.org/foobar/ to Jenkins then you could just use `java -jar jenkins.war --prefix=/foobar` to start jenkins using `/foobar` as the context path
虽然从技术上讲可以使用重写规则来更改上下文路径，但您应该意识到，查找和修复重写规则中的所有内容将花费大量工作，并且反向代理将花费大部分时间重写来自 Jenkins 的响应。将 Jenkins 更改为在反向代理期望的上下文路径上运行要容易得多，例如，如果您的反向代理将  https://manchu.example.org/foobar/ 处的请求转发到 Jenkins，那么您可以使用 `java -jar jenkins.war --prefix=/foobar` `/foobar` 作为上下文路径来启动 jenkins

## Further Diagnosis 进一步诊断

For further diagnosis, try using cURL:
要进一步诊断，请尝试使用 cURL：

```
BASE=administrativeMonitor/hudson.diagnosis.ReverseProxySetupMonitor
curl -iL -e http://your.reverse.proxy/jenkins/manage \
            http://your.reverse.proxy/jenkins/${BASE}/test
```

(assuming your Jenkins is located at http://your.reverse.proxy/jenkins/ - and is open to anonymous read access)
（假设您的 Jenkins 位于 http://your.reverse.proxy/jenkins/ - 并且对匿名读取访问开放）

# Managing systemd services  管理 systemd 服务

Table of Contents 目录

- [Viewing service configurations
  查看服务配置](https://www.jenkins.io/doc/book/system-administration/systemd-services/#viewing-service-configurations)
- [Overriding service configurations
  覆盖服务配置](https://www.jenkins.io/doc/book/system-administration/systemd-services/#overriding-service-configurations)
- [Starting services 启动服务](https://www.jenkins.io/doc/book/system-administration/systemd-services/#starting-services)
- [Stopping services 停止服务](https://www.jenkins.io/doc/book/system-administration/systemd-services/#stopping-services)
- [Restarting services 重新启动服务](https://www.jenkins.io/doc/book/system-administration/systemd-services/#restarting-services)
- [Reloading service definitions
  重新加载服务定义](https://www.jenkins.io/doc/book/system-administration/systemd-services/#reloading-service-definitions)
- [Reading service logs 读取服务日志](https://www.jenkins.io/doc/book/system-administration/systemd-services/#reading-service-logs)
- [Pruning service logs 修剪服务日志](https://www.jenkins.io/doc/book/system-administration/systemd-services/#pruning-service-logs)
- [Viewing service status 查看服务状态](https://www.jenkins.io/doc/book/system-administration/systemd-services/#viewing-service-status)
- [Going further 更进一步](https://www.jenkins.io/doc/book/system-administration/systemd-services/#going-further)

Beginning with Jenkins 2.332.1 and Jenkins 2.335, the Linux package installers use `systemd` to manage services. The RPM and deb package installers migrate configuration settings from System V `init` to `systemd` overrides.
从 Jenkins 2.332.1 和 Jenkins 2.335 开始，Linux 软件包安装程序使用 `systemd` 来管理服务。RPM 和 deb 软件包安装程序将配置设置从 System V `init` 迁移到 `systemd` 覆盖。

<iframe width="800" height="420" src="https://www.youtube.com/embed/pwR9TPW2oG4?rel=0" frameborder="0" allowfullscreen=""></iframe>

## Viewing service configurations 查看服务配置

The current service configuration of the Jenkins service as configured by  the package installers and any overrides can be viewed with:
软件包安装程序配置的 Jenkins 服务的当前服务配置和任何覆盖都可以通过以下方式查看：

```
systemctl cat jenkins
# /etc/systemd/system/jenkins.service
#
# This file is managed by systemd(1). Do NOT edit this file manually!
# To override these settings, run:
#
#     systemctl edit jenkins
#
# For more information about drop-in files, see:
#
#     https://www.freedesktop.org/software/systemd/man/systemd.unit.html
#

[Unit]
Description=Jenkins Continuous Integration Server
Requires=network.target
After=network.target

[Service]
Type=notify
NotifyAccess=main
ExecStart=/usr/bin/jenkins
Restart=on-failure
SuccessExitStatus=143

# /etc/systemd/system/jenkins.service.d/override.conf
[Service]
Environment="JAVA_OPTS=-Djava.awt.headless=true"
```

## Overriding service configurations 覆盖服务配置

When installed on a modern Linux distribution running `systemd(1)`, the `systemd(1)` [service unit](https://www.freedesktop.org/software/systemd/man/systemd.service.html) is delivered to:
当安装在运行 `systemd（1）` 的现代 Linux 发行版上时，`systemd（1）`[服务单元](https://www.freedesktop.org/software/systemd/man/systemd.service.html)将交付到：

- Debian Debian的

  `/lib/systemd/system/jenkins.service`

- Red Hat 红帽

  `/usr/lib/systemd/system/jenkins.service`

- openSUSE openSUSE的

  `/usr/lib/systemd/system/jenkins.service`

The main service unit is read-only and not intended to be edited manually. It contains a large notice at the top of the file reminding the user that it is read-only.
主服务单元是只读的，不能手动编辑。它在文件顶部包含一个大通知，提醒用户它是只读的。

Values may be overridden in the drop-in unit (`override.conf` file) for the service. Edit the drop-in unit with:
可以在服务的插入单元（`override.conf` 文件）中覆盖值。使用以下命令编辑插入式单元：

```
# systemctl edit jenkins
```

The `override.conf` file is stored at `/etc/systemd/system/jenkins.service.d/override.conf` and can be used to customize the service. Note that such customizations must be done in a `[Service]` section in order to take effect. Example content of the `override.conf` file might include:
`override.conf` 文件存储在 中 `/etc/systemd/system/jenkins.service.d/override.conf` ，可用于自定义服务。请注意，此类自定义必须在 `[Service]` 部分中完成才能生效。`override.conf` 文件的示例内容可能包括：

```
[Unit]
Description=My Company Jenkins Controller

[Service]
# Add JVM configuration options
Environment="JAVA_OPTS=-Djava.awt.headless=true -XX:+UseStringDeduplication"

# Arbitrary additional arguments to pass to Jenkins.
# Full option list: java -jar jenkins.war --help
Environment="JENKINS_OPTS=--prefix=/jenkins --javaHome=/opt/jdk-17"

# Configuration as code directory
Environment="CASC_JENKINS_CONFIG=/var/lib/jenkins/configuration-as-code/"
```

|      | `systemctl edit jenkins` creates the drop-in unit as `root` with 0644 (`-rw-r—r--`) permissions. The migration logic, on the other hand, creates the drop-in unit as `root` with 0600 (`-rw-------`) permissions. This might be of consequence if you store an HTTPS keystore location and/or password in the drop-in unit and also run jobs directly on the controller, a practice which the Jenkins project [explicitly discourages](https://www.jenkins.io/doc/book/security/controller-isolation/). When in doubt, secure the drop-in unit by setting its permissions to 0600 with `chmod(1)`.  `systemctl edit jenkins` 以具有 0644 （`-rw-r—r--`） 权限的 `root` 身份创建插入式单元。另一方面，迁移逻辑将插入单元创建为具有 0600 （`-rw-------`） 权限的 `root`。如果您在插入式单元中存储 HTTPS 密钥存储位置和/或密码，并且还直接在控制器上运行作业，这可能会产生后果，而 Jenkins 项目[明确反对](https://www.jenkins.io/doc/book/security/controller-isolation/)这种做法。如有疑问，请使用 `chmod（1）` 将 drop-in 单元的权限设置为 0600 来保护该单元。 |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

The drop-in unit unifies configuration across all three distributions: Debian, Red Hat, and openSUSE. Also note that the drop-in unit is not overwritten on upgrades.
插入式单元统一了所有三个发行版的配置：Debian、Red Hat 和 openSUSE。另请注意，插入式单元在升级时不会被覆盖。

|      | Unlike the System V `init(8)` configuration, the `override.conf` file only contains customizations, not the original defaults. Users who are accustomed to editing an existing set of defaults must  refer to the (read-only) service unit side-by-side when editing the  drop-in unit or use a command like `systemctl edit jenkins --full`, which copies the original service unit instead of creating a drop-in unit.  与 System V `init（8）` 配置不同，`override.conf` 文件只包含自定义项，不包含原始的默认值。习惯于编辑现有默认值集的用户在编辑插入式单元时必须并排引用（只读）服务单元，或使用类似 `systemctl edit jenkins --full` 的命令，该命令会复制原始服务单元，而不是创建插入式单元。 |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

Editing the drop-in unit with `systemctl edit jenkins` will automatically reload the `systemd(1)` configuration. The settings will take effect the next time Jenkins is restarted. If you edit the drop-in unit without `systemctl(1)`, you need to run `systemctl daemon-reload` for the changes to take effect.
使用 `systemctl edit jenkins` 编辑插入单元将自动重新加载 `systemd（1）` 配置。这些设置将在下次重新启动 Jenkins 时生效。如果你在没有 `systemctl（1）` 的情况下编辑插入式单元，你需要运行 `systemctl daemon-reload` 才能使更改生效。

A final point to mention about the service unit is its use of specifiers, which may be unfamiliar to some users. The drop-in unit does not perform shell expansion. Specifiers can insert contextual information (like system hostname, unit name, and operating system kernel release) into the drop-in unit. The `systemd(1)` documentation contains [a table of specifiers available in unit files](https://www.freedesktop.org/software/systemd/man/systemd.unit.html#id-1.13.3).
关于 service unit 的最后一点是它对说明符的使用，某些用户可能不熟悉。插入式单元不执行 shell 扩展。说明符可以将上下文信息（如系统主机名、单元名称和操作系统内核版本）插入到插入单元中。`systemd（1）` 文档包含[单元文件中可用的说明符表](https://www.freedesktop.org/software/systemd/man/systemd.unit.html#id-1.13.3)。

## Starting services 启动服务

Once the Jenkins `systemd` service has been defined, it can be started with:
定义 Jenkins `systemd` 服务后，可以通过以下方式启动它：

```
# systemctl start jenkins
```

If Jenkins does not signal startup completion within a configured time, the service will be considered failed and will be shut down again. As each initialization milestone (i.e., "Started initialization", "Listed all plugins", "Prepared all plugins", "Started all plugins", "Augmented all extensions", "System config loaded", "System config adapted", "Loaded all jobs", "Configuration for all jobs updated", and "Completed initialization") is attained, the timeout is extended by the value of the `jenkins.model.Jenkins.extendTimeoutSeconds` system property (by default, 15 seconds). The timeout can be configured with the `TimeoutStartSec` directive in the service unit.
如果 Jenkins  未在配置的时间内发出启动完成信号，则服务将被视为失败并再次关闭。当达到每个初始化里程碑（即“已开始初始化”、“列出所有插件”、“已准备所有插件”、“已启动所有插件”、“已扩充所有扩展”、“已加载系统配置”、“已调整系统配置”、“已加载所有作业”、“已更新所有作业的配置”和“已完成初始化”）时，超时将延长 `jenkins.model.Jenkins.extendTimeoutSeconds` system 属性的值（默认为 15 秒）。可以使用 service unit 中的 `TimeoutStartSec` 指令来配置超时。

## Stopping services 停止服务

The Jenkins `systemd` service can be stopped with:
Jenkins `systemd` 服务可以通过以下方式停止：

```
# systemctl stop jenkins
```

## Restarting services 重新启动服务

The Jenkins `systemd` service can be restarted with:
Jenkins `systemd` 服务可以通过以下方式重新启动：

```
# systemctl restart jenkins
```

## Reloading service definitions 重新加载服务定义

After changes to configuration files, the service definition may need to be reloaded with:
更改配置文件后，可能需要使用以下命令重新加载服务定义：

```
# systemctl daemon-reload
```



## Reading service logs 读取服务日志

Logs for the Jenkins service can be read with the command:
可以使用以下命令读取 Jenkins 服务的日志：

```
journalctl -u jenkins
```

## Pruning service logs 修剪服务日志

Log files retained by `systemd` are commonly configured to automatically rotate. If the log files need to be reduced in size, use the command:
`systemd` 保留的日志文件通常配置为自动轮换。如果需要减小日志文件的大小，请使用以下命令：

```
journalctl --vacuum-size=500M
```

## Viewing service status 查看服务状态

The Jenkins `systemd` service status can be viewed with `systemctl status jenkins`. Some examples are shown below.
可以使用 `systemctl status jenkins` 查看 Jenkins `systemd` 服务状态。下面显示了一些示例。

After upgrading plugins: 升级插件后：

```
systemctl status jenkins
● jenkins.service - Jenkins Continuous Integration Server
     Loaded: loaded (/lib/systemd/system/jenkins.service; enabled; vendor preset: enabled)
    Drop-In: /etc/systemd/system/jenkins.service.d
             └─override.conf
     Active: active (running) […]
   Main PID: […] (java)
     Status: "Restart in 10 seconds"
```

As Jenkins is being brought down:
随着 Jenkins 的宕机：

```
systemctl status jenkins
● jenkins.service - Jenkins Continuous Integration Server
     Loaded: loaded (/lib/systemd/system/jenkins.service; enabled; vendor preset: enabled)
    Drop-In: /etc/systemd/system/jenkins.service.d
             └─override.conf
     Active: deactivating (stop-sigterm) since […]
   Main PID: […] (java)
     Status: "Stopping Jenkins"
```

As Jenkins is starting up:
当 Jenkins 启动时：

```
systemctl status jenkins
● jenkins.service - Jenkins Continuous Integration Server
     Loaded: loaded (/lib/systemd/system/jenkins.service; enabled; vendor preset: enabled)
    Drop-In: /etc/systemd/system/jenkins.service.d
             └─override.conf
     Active: activating (start) since […]
   Main PID: […] (java)
```

After successful startup:
成功启动后：

```
systemctl status jenkins
● jenkins.service - Jenkins Continuous Integration Server
     Loaded: loaded (/lib/systemd/system/jenkins.service; enabled; vendor preset: enabled)
    Drop-In: /etc/systemd/system/jenkins.service.d
             └─override.conf
     Active: active (running) since […]
   Main PID: […] (java)
```

## Going further 更进一步

Some recommended readings on this subject:
关于这个主题的一些推荐读物：

- [DigitalOcean systemd services and units tutorial
  DigitalOcean systemd 服务和单元教程](https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units)
- [Understand and administering systemd](https://docs.fedoraproject.org/en-US/quick-docs/understanding-and-administering-systemd/) by the Fedora project
  通过 Fedora 项目[了解和管理 systemd](https://docs.fedoraproject.org/en-US/quick-docs/understanding-and-administering-systemd/)
- [systemd reference documentation](https://www.freedesktop.org/wiki/Software/systemd/) from freedesktop.org
  来自 freedesktop.org 的 [systemd 参考文档](https://www.freedesktop.org/wiki/Software/systemd/)
- [Debian wiki: systemd Debian wiki：systemd](https://wiki.debian.org/systemd)

# FIPS-140 FIPS-140 格式

Table of Contents 目录

- [Plugins 插件](https://www.jenkins.io/doc/book/system-administration/FIPS-140/#plugins)
- [What FIPS-140 mode does FIPS-140 模式的作用](https://www.jenkins.io/doc/book/system-administration/FIPS-140/#what-fips-140-mode-does)
- [What FIPS-140 mode does not do
  FIPS-140 模式不做什么](https://www.jenkins.io/doc/book/system-administration/FIPS-140/#what-fips-140-mode-does-not-do)
- [How to run a fully FIPS-140 compliant Jenkins
  如何运行完全符合 FIPS-140 标准的 Jenkins](https://www.jenkins.io/doc/book/system-administration/FIPS-140/#how-to-run-a-fully-fips-140-compliant-jenkins)

It may be possible to run Jenkins in a FIPS-140 compliant manner when the [compliance flag](https://www.jenkins.io/doc/book/managing/system-properties/#jenkins-security-fips140-compliance) is enabled, and the servlet container, the JVM, and the host OS are all appropriately configured. How to configure the servlet container, JVM and host are out of scope of the Jenkins community project as this is a complex area with many  pitfalls and gotchas. Some Jenkins features may not work or be disabled.
启用[合规性标志](https://www.jenkins.io/doc/book/managing/system-properties/#jenkins-security-fips140-compliance)后，可以以符合 FIPS-140 的方式运行 Jenkins，并且 servlet 容器、JVM 和主机操作系统都经过适当配置。如何配置 servlet  容器、JVM 和主机不在 Jenkins 社区项目的范围之内，因为这是一个复杂的领域，有许多陷阱和陷阱。某些 Jenkins  功能可能无法正常工作或被禁用。

|      | The Jenkins community does not actively check Jenkins or Plugins for [FIPS-140](https://csrc.nist.gov/pubs/fips/140-2/upd2/final) compliance issues. Jenkins 社区不会主动检查 Jenkins 或插件是否存在 [FIPS-140](https://csrc.nist.gov/pubs/fips/140-2/upd2/final) 合规性问题。 |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

## Plugins 插件

Plugins may or may not honour a request to run in FIPS-140 compliance mode. Before you install or upgrade any plugin, you should check the plugin’s code to ensure it adheres to the FIPS-140 standard.
插件可能会也可能不会接受在 FIPS-140 合规性模式下运行的请求。在安装或升级任何插件之前，您应该检查插件的代码以确保它符合 FIPS-140 标准。

## What FIPS-140 mode does FIPS-140 模式的作用

If you enable [FIPS-140 mode](https://www.jenkins.io/doc/book/managing/system-properties/#jenkins-security-fips140-compliance), it provides a hint to Jenkins and any plugins that have opted in that they should prefer cryptographic algorithms that **may**.[[1](https://www.jenkins.io/doc/book/system-administration/FIPS-140/#_footnotedef_1)] be FIPS-140 approved. This may mean that some features are disabled entirely, or may use a  less secure (but compliant) form of cryptography than normal.
如果启用 [FIPS-140 模式](https://www.jenkins.io/doc/book/managing/system-properties/#jenkins-security-fips140-compliance)，它会向 Jenkins 和任何选择加入的插件提供提示，表明它们应该首选**可能**使用的加密算法。[[1](https://www.jenkins.io/doc/book/system-administration/FIPS-140/#_footnotedef_1)] 已通过 FIPS-140 认证。这可能意味着某些功能被完全禁用，或者可能使用比正常情况更不安全（但合规）的加密形式。

## What FIPS-140 mode does not do FIPS-140 模式不做什么

If any code from the JVM, servlet container, Jenkins, or any plugin  requests a non-compliant algorithm, this will still be the case, and the request may be honoured. For example, this mode cannot configure the JVM, so TLS connections to  external secure web sites might still use non-compliant cryptography. Additionally, Jenkins cannot ensure that plugins will even use  encryption at all, when appropriate. At the end of the day, just because Jenkins and plugins run when  FIPS-140 mode is enabled does not mean that it adheres to the USA  government standard.
如果来自 JVM、servlet 容器、Jenkins 或任何插件的任何代码请求不合规的算法，情况仍然如此，并且可能会接受该请求。例如，此模式无法配置  JVM，因此与外部安全 Web 站点的 TLS 连接可能仍使用不兼容的加密技术。此外，Jenkins  无法确保插件在适当的时候甚至会使用加密。归根结底，仅仅因为 Jenkins 和插件在启用 FIPS-140  模式时运行并不意味着它符合美国政府标准。

## How to run a fully FIPS-140 compliant Jenkins 如何运行完全符合 FIPS-140 标准的 Jenkins

As previously mentioned, the host, JVM, and the servlet container all need to be configured appropriately to ensure that Jenkins is FIPS-140  compliant. Extreme care should be taken when installing or upgrading plugins as  they may or may not be FIPS-140 compliant, and they may introduce code  that is non-compliant or otherwise change the JVM configuration so that  it breaks compliance.
如前所述，主机、JVM 和 servlet 容器都需要进行适当配置，以确保 Jenkins 符合 FIPS-140 标准。安装或升级插件时应格外小心，因为它们可能符合 FIPS-140 标准，也可能不符合 FIPS-140 标准，并且它们可能会引入不合规的代码，或者以其他方式更改 JVM  配置，从而破坏合规性。

The Jenkins community does not support Jenkins FIPS-140 mode, and due to  the complex nature of JVM and servlet configuration that can change  between versions, does not provide documentation for the full  configuration required to run Jenkins in a fully FIPS-140 compliant  manner. If you need to run Jenkins in a way that it is FIPS-140 compliant, it is recommended that you obtain support from a commercial vendor. The Jenkins community may be able to fix issues relating to FIPS-140  compliance; these will be treated as any other bug report or feature  request.
Jenkins 社区不支持 Jenkins FIPS-140 模式，并且由于 JVM 和 servlet  配置的复杂性，可能会在版本之间发生变化，因此不提供以完全符合 FIPS-140 的方式运行 Jenkins  所需的完整配置的文档。如果您需要以符合 FIPS-140 的方式运行 Jenkins，建议您从商业供应商处获得支持。Jenkins  社区或许能够解决与 FIPS-140 合规性相关的问题;这些将被视为任何其他错误报告或功能请求。

------

[1](https://www.jenkins.io/doc/book/system-administration/FIPS-140/#_footnoteref_1). Algorithms are not approved, rather a specific implementation of a  specific algorithm is approved. However, the implementation used at  runtime depends on the JVM, JVM configuration, and the host OS. As this  is outside the scope of the Jenkins project, the algorithms targeted are available from at least one [FIPS-140 compliant provider](https://csrc.nist.gov/projects/cryptographic-module-validation-program/validated-modules/search), namely the [BouncyCastle FIPS library](https://csrc.nist.gov/projects/cryptographic-module-validation-program/certificate/3514). 
[1](https://www.jenkins.io/doc/book/system-administration/FIPS-140/#_footnoteref_1). 算法未获得批准，而是批准了特定算法的特定实现。但是，运行时使用的实现取决于 JVM、JVM 配置和主机操作系统。由于这超出了 Jenkins 项目的范围，因此目标算法可从至少一个[符合 FIPS-140 的提供商](https://csrc.nist.gov/projects/cryptographic-module-validation-program/validated-modules/search)（即 [BouncyCastle FIPS 库](https://csrc.nist.gov/projects/cryptographic-module-validation-program/certificate/3514)）获得。

## 重置 Jenkins 管理员密码

作为系统管理员，可以重置 Jenkins 管理员密码。

### 重置管理员密码

1. Log in to your Jenkins controller.
   登录到 Jenkins 控制器。
2. Stop the Jenkins process. You may use this command: `systemctl stop jenkins`.
   停止 Jenkins 进程。您可以使用此命令：`systemctl stop jenkins`。
3. Edit the Jenkins configuration file (`config.xml`) inside your `jenkins/` or `$JENKINS_HOME` directory.
   编辑 `jenkins/` 或 `$JENKINS_HOME` 目录中的 Jenkins 配置文件 （`config.xml`）。
4. Look for **useSecurity** and change it from **true** to **false** manually.
   查找 **useSecurity** 并手动将其从 **true** 更改为 **false**。
5. Save your file and close it.
   保存文件并关闭它。
6. Restart the Jenkins service to apply your changes. You may use this command: `systemctl start jenkins`. After restarting Jenkins, navigate to your controller and sign in.
   重新启动 Jenkins 服务以应用更改。您可以使用此命令：`systemctl start jenkins`。重新启动 Jenkins 后，导航到您的控制器并登录。
7. On the dashboard, select **Manage Jenkins** in the navigation pane on the left side of the page.
   在控制面板上，选择页面左侧导航窗格中的 **Manage Jenkins**。
8. On the **Manage Jenkins** page, under the **Security** section, select **Configure Global Security**.
   在 **Manage Jenkins （管理 Jenkins**） 页面的 **Security （安全**） 部分下，选择 **Configure Global Security （配置全局安全性**）。
9. Under **Security Realm**, select **Jenkins' own user database** from the dropdown menu. Ensure the option **Allow users to sign up** is unchecked and save your changes. This redirects you to the Manage Jenkins page.
   在 **Security Realm （安全领域）** 下，从下拉菜单中选择 **Jenkins 自己的用户数据库**。确保选项 **允许用户注册** 未选中并保存您的更改。这会将您重定向到 Manage Jenkins （管理 Jenkins） 页面。
10. On the **Manage Jenkins** page, select **Users**.
    在 **Manage Jenkins （管理 Jenkins**） 页面上，选择 **Users （用户**）。
11. You will see a list showing User IDs. Select the User ID that you want to change the password for.
    您将看到一个显示 User ID 的列表。选择要更改其密码的用户 ID。
12. Select Configure using the gear icon or the dropdown menu from the User ID. Locate the **Password** section to change your password.
    使用齿轮图标或用户 ID 中的下拉菜单选择 配置。找到 **密码** 部分以更改您的密码。

After changing the password, you will be able to log into your Jenkins  controller again using the same username and the new password that you  have just set.
更改密码后，您将能够使用刚刚设置的相同用户名和新密码再次登录 Jenkins 控制器。

> Please ensure not to leave the Jenkins controller insecure. So, please re-enable the security by following these steps.  请确保不要让 Jenkins 控制器不安全。因此，请按照以下步骤重新启用安全性。

### 启用安全性

1. Log in as your admin account.
   以您的管理员帐户身份登录。
2. On the dashboard, select **Manage Jenkins** in the navigation pane on the left side of the page.
   在控制面板上，选择页面左侧导航窗格中的 **Manage Jenkins**。
3. On the **Manage Jenkins** page, under the **Security** section, select **Configure Global Security**.
   在 **Manage Jenkins （管理 Jenkins**） 页面的 **Security （安全**） 部分下，选择 **Configure Global Security （配置全局安全性**）。
4. Set the **Authorization** to **Logged-in users can do anything**. Uncheck the option **Allow anonymous read access**. Select **Save**.
   将 **Authorization** 设置为 **Logged-in users can do anything**。取消选中 **Allow anonymous read access** 选项。选择 **Save （保存**）。