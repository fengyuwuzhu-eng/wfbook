# 静态路由基本功能配置

## 1.1 简介

本案例介绍静态路由基本功能的配置方法。

## 1.2 组网需求

如[图1](https://www.h3c.com/cn/d_202303/1816253_30005_0.htm#_Ref81318100)所示，要求配置静态路由，使Switch A和Switch C之间能够互通。

图1 静态路由基本功能配置组网图

![img](https://resource.h3c.com/cn/202303/28/20230328_8774732_x_Img_x_png_0_1816253_30005_0.png)

 

## 1.3 配置步骤

#### 1. 配置Switch A

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchA> system-view

[SwitchA] vlan 100

[SwitchA-vlan100] port gigabitethernet 1/0/1

[SwitchA-vlan100] quit

[SwitchA] interface vlan-interface 100

[SwitchA-Vlan-interface100] ip address 10.1.1.1 24

[SwitchA-Vlan-interface100] quit

\# 配置静态路由。

[SwitchA] ip route-static 20.1.1.0 24 10.1.1.2

\# 保存配置。

[SwitchA] save force

#### 2. 配置Switch B

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchB> system-view

[SwitchB] vlan 100

[SwitchB-vlan100] port gigabitethernet 1/0/1

[SwitchB-vlan100] quit

[SwitchB] vlan 200

[SwitchB-vlan200] port gigabitethernet 1/0/2

[SwitchB-vlan200] quit

[SwitchB] interface vlan-interface 100

[SwitchB-Vlan-interface100] ip address 10.1.1.2 24

[SwitchB-Vlan-interface100] quit

[SwitchB] interface vlan-interface 200

[SwitchB-Vlan-interface200] ip address 20.1.1.1 24

[SwitchB-Vlan-interface200] quit

\# 保存配置。

[SwitchB] save force

#### 3. 配置Switch C

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchC> system-view

[SwitchC] vlan 200

[SwitchC-vlan200] port gigabitethernet 1/0/1

[SwitchC-vlan200] quit

[SwitchC] interface vlan-interface 200

[SwitchC-Vlan-interface200] ip address 20.1.1.2 24

[SwitchC-Vlan-interface200] quit

\# 配置静态路由。

[SwitchC] ip route-static 10.1.1.0 24 20.1.1.1

\# 保存配置。

[SwitchC] save force

## 1.4 验证配置

\# 在Switch A上使用Ping命令测试Switch C的互通性。

[SwitchA] ping 20.1.1.2

Ping 20.1.1.2 (20.1.1.2): 56 data bytes, press CTRL+C to break

56 bytes from 20.1.1.2: icmp_seq=0 ttl=255 time=2.000 ms

56 bytes from 20.1.1.2: icmp_seq=1 ttl=255 time=0.000 ms

56 bytes from 20.1.1.2: icmp_seq=2 ttl=255 time=0.000 ms

56 bytes from 20.1.1.2: icmp_seq=3 ttl=255 time=1.000 ms

56 bytes from 20.1.1.2: icmp_seq=4 ttl=255 time=0.000 ms

 

--- Ping statistics for 20.1.1.2 ---

5 packet(s) transmitted, 5 packet(s) received, 0.0% packet loss

round-trip min/avg/max/std-dev = 0.000/0.600/2.000/0.800 ms

## 1.5 配置文件

·   Switch A： 

\#

vlan 100

\#

interface Vlan-interface100

 ip address 10.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 100

\#

 ip route-static 20.1.1.0 24 10.1.1.2

\#

·   Switch B ：

\#

vlan 100

\#

vlan 200

\#

interface Vlan-interface100

 ip address 10.1.1.2 255.255.255.0

\#

interface Vlan-interface200

 ip address 20.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 100

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 200

\#

·   Switch C： 

\#

vlan 200

\#

interface Vlan-interface200

 ip address 20.1.1.2 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 200

\#

 ip route-static 10.1.1.0 24 20.1.1.1

\#

## 1.6 相关资料

·   产品配套“三层技术-IP路由配置指导”中的“静态路由”。

·   产品配套“三层技术-IP路由命令参考”中的“静态路由”。



 

# 2 IPv6静态路由基本功能配置

## 2.1 简介

本案例介绍无状态自动配置IPv6地址，并配置IPv6静态路由基本功能实现跨网段设备互通的配置方法。

## 2.2 组网需求

如[图2](https://www.h3c.com/cn/d_202303/1816253_30005_0.htm#_Ref259029401)所示，交换机作为企业网络内部的网关设备，要实现无状态自动配置主机Host A和Host B的IPv6地址。不同网段的主机通过IPv6静态路由互相访问。

·   Host A、Host B、Switch A和Switch B之间通过以太网端口相连，将以太网端口分别加入相应的VLAN里，在VLAN接口上配置IPv6地址，验证它们之间的互通性。

·   在Switch A和Switch B上配置IPv6静态路由，实现各网段的互通。

图2 IPv6静态路由基本功能配置组网图

![img](https://resource.h3c.com/cn/202303/28/20230328_8774733_x_Img_x_png_1_1816253_30005_0.png)

‌

## 2.3 配置步骤

#### 1. 配置Switch A

\# 创建VLAN，在VLAN中加入对应的端口。

<SwitchA> system-view

[SwitchA] vlan 4

[SwitchA-vlan4] port gigabitethernet 1/0/2

[SwitchA-vlan4] quit

[SwitchA] vlan 2

[SwitchA-vlan2] port gigabitethernet 1/0/1

[SwitchA-vlan2] quit

\# 手工指定VLAN接口2的全球单播地址。

[SwitchA] interface vlan-interface 2

[SwitchA-Vlan-interface2] ipv6 address 3001::1/64

[SwitchA-Vlan-interface2] quit

\# 手工指定VLAN接口4的全球单播地址，并允许其发布RA消息。（缺省情况下，所有的接口不会发布RA消息）

[SwitchA] interface vlan-interface 4

[SwitchA-Vlan-4] ipv6 address 2001::1/64

[SwitchA-Vlan-4] undo ipv6 nd ra halt

[SwitchA-Vlan-4] quit

\# 配置IPv6静态路由，该路由的目的地址为4001::/64，下一跳地址为3001::2。

[SwitchA] ipv6 route-static 4001:: 64 3001::2

\# 保存配置。

[SwitchA] save force

#### 2. 配置Switch B

\# 创建VLAN，在VLAN中加入对应的端口。

<SwitchB> system-view

[SwitchB] vlan 2

[SwitchB-vlan2] port gigabitethernet 1/0/1

[SwitchB-vlan2] quit

[SwitchB] vlan 3

[SwitchB-vlan3] port gigabitethernet 1/0/2

[SwitchB-vlan3] quit

\# 手工指定VLAN接口2的全球单播地址。

[SwitchB] interface vlan-interface 2

[SwitchB-Vlan-interface2] ipv6 address 3001::2/64

[SwitchB-Vlan-interface2] quit

\# 手工指定VLAN接口3的全球单播地址，并允许其发布RA消息。（缺省情况下，所有的接口不会发布RA消息）

[SwitchB] interface vlan-interface 3

[SwitchB-Vlan-interface3] ipv6 address 4001::1/64

[SwitchB-Vlan-interface3] undo ipv6 nd ra halt

[SwitchB-Vlan-interface3] quit

\# 配置IPv6静态路由，该路由的目的地址为2001::/64，下一跳地址为3001::1。

[SwitchB] ipv6 route-static 2001:: 64 3001::1

#### 3. 配置Host A

在Host A上安装IPv6，并配置自动获取IPv6地址。

#### 4. 配置Host B

在Host B上安装IPv6，并配置自动获取IPv6地址。

## 2.4 验证配置

\# 从Switch A上查看端口GigabitEthernet1/0/2的邻居信息。

[SwitchA] display ipv6 neighbors interface gigabitethernet 1/0/2

Type: S-Static  D-Dynamic  O-Openflow   R-Rule  IS-Invalid static

IPv6 address       MAC address  VLAN/VSI  Interface   State T Aging

2001::15B:E0EA:3524:E791 0015-e9a6-7d14 4      GE1/0/2    REACH D  1248

FE80::215:E9FF:FEA6:7D14 0015-e9a6-7d14 4      GE1/0/2    REACH D  1238

通过上面的信息可以知道Host A上获得的IPv6全球单播地址为2001::15B:E0EA:3524:E791。

\# 从Switch B上查看端口GigabitEthernet1/0/2的邻居信息。

[SwitchB] display ipv6 neighbors interface gigabitethernet 1/0/2

Type: S-Static  D-Dynamic  O-Openflow   R-Rule  IS-Invalid static

IPv6 address       MAC address  VLAN/VSI  Interface   State T Aging

4001::B15F:BC63:DBCE:EB57 6805-ca8b-18f3 3     GE1/0/2    REACH D 46

FE80::510B:D60F:31A7:4AFF 6805-ca8b-18f3 3      GE1/0/2    REACH D  1238

通过上面的信息可以知道Host B上获得的IPv6全球单播地址为4001::B15F:BC63:DBCE:EB57。

\# 在Switch A上使用Ping测试Host B的互通性。

[Switch A] ping ipv6 4001::B15F:BC63:DBCE:EB57

Ping6(56 data bytes) 3001::1 --> 4001::B15F:BC63:DBCE:EB57, press CTRL+C to break

56 bytes from 4001::B15F:BC63:DBCE:EB57, icmp_seq=0 hlim=64 time=1.000 ms

56 bytes from 4001::B15F:BC63:DBCE:EB57, icmp_seq=1 hlim=64 time=0.000 ms

56 bytes from 4001::B15F:BC63:DBCE:EB57, icmp_seq=2 hlim=64 time=0.000 ms

56 bytes from 4001::B15F:BC63:DBCE:EB57, icmp_seq=3 hlim=64 time=1.000 ms

56 bytes from 4001::B15F:BC63:DBCE:EB57, icmp_seq=4 hlim=64 time=0.000 ms

--- Ping6 statistics for 4001::B15F:BC63:DBCE:EB57 ---

5 packet(s) transmitted, 5 packet(s) received, 0.0% packet loss

round-trip min/avg/max/std-dev = 0.000/0.400/1.000/0.490 ms

\# 在Switch B上使用Ping测试Host A的互通性。

[Switch B] ping ipv6 2001::15B:E0EA:3524:E791

Ping6(56 data bytes) 3001::2 --> 2001::15B:E0EA:3524:E791, press CTRL+C to break

56 bytes from 2001::15B:E0EA:3524:E791, icmp_seq=0 hlim=64 time=1.000 ms

56 bytes from 2001::15B:E0EA:3524:E791, icmp_seq=1 hlim=64 time=0.000 ms

56 bytes from 2001::15B:E0EA:3524:E791, icmp_seq=2 hlim=64 time=0.000 ms

56 bytes from 2001::15B:E0EA:3524:E791, icmp_seq=3 hlim=64 time=1.000 ms

56 bytes from 2001::15B:E0EA:3524:E791, icmp_seq=4 hlim=64 time=0.000 ms

--- Ping6 statistics for 2001::15B:E0EA:3524:E791 ---

5 packet(s) transmitted, 5 packet(s) received, 0.0% packet loss

round-trip min/avg/max/std-dev = 0.000/0.400/1.000/0.490 ms

从Host A上也可以ping通Host B，证明它们是互通的。

## 2.5 配置文件

·   Switch A： 

\#

vlan 1

\#

vlan 2

\#

interface Vlan-interface1

 ipv6 address 2001::1/64

 undo ipv6 nd ra halt

\#

interface Vlan-interface2

 ipv6 address 3001::1/64

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 2

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 1

\#

 ipv6 route-static 4001:: 64 3001::2

\#

·   Switch B ：

\#

vlan 2

\#

vlan 3

\#

interface Vlan-interface2

 ipv6 address 3001::2/64

\#

interface Vlan-interface3

 ipv6 address 4001::1/64

 undo ipv6 nd ra halt

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 2

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 3

\#

 ipv6 route-static 2001:: 64 3001::1

\#

## 2.6 相关资料

·   产品配套“三层技术-IP业务配置指导”中的“IPv6基础”。

·   产品配套“三层技术-IP业务命令参考”中的“IPv6基础”。

·   产品配套“三层技术-IP路由配置指导”中的“IPv6静态路由”。

·   产品配套“三层技术-IP路由命令参考”中的“IPv6静态路由”。



 

# 3 配置缺省路由

## 3.1 简介

本案例介绍缺省路由的配置方法。

## 3.2 组网需求

如[图3](https://www.h3c.com/cn/d_202303/1816253_30005_0.htm#_Ref81314529)所示，在Switch A上配置缺省路由，下一跳地址设置为Switch B的接口地址10.1.1.2/24。配置完成后，Switch A可以ping通Switch B的Loopback接口地址3.3.3.3/32。

图3 缺省路由配置组网图

![img](https://resource.h3c.com/cn/202303/28/20230328_8774735_x_Img_x_png_2_1816253_30005_0.png)

## 3.3 配置步骤

#### 1. 配置Switch A

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchA> system-view

[SwitchA] vlan 100

[SwitchA-vlan100] port gigabitethernet 1/0/1

[SwitchA-vlan100] quit

[SwitchA] interface vlan-interface 100

[SwitchA-Vlan-interface100] ip address 10.1.1.1 24

[SwitchA-Vlan-interface100] quit

\# 配置缺省路由。

[SwitchA] ip route-static 0.0.0.0 0 10.1.1.2

\# 保存配置。

[SwitchA] save force

#### 2. 配置Switch B

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchB> system-view

[SwitchB] vlan 100

[SwitchB-vlan100] port gigabitethernet 1/0/1

[SwitchB-vlan100] quit

[SwitchB] interface vlan-interface 100

[SwitchB-Vlan-interface100] ip address 10.1.1.2 24

[SwitchB-Vlan-interface100] quit

\# 配置Loopback接口的IP地址。

[SwitchB] interface LoopBack 0

[SwitchB-LoopBack0] ip address 3.3.3.3 32

\# 保存配置。

[SwitchB] save force

## 3.4 验证配置

\# 当Switch A上未配置缺省路由时，无法访问3.3.3.3。

[SwitchA] ping 3.3.3.3

Ping 3.3.3.3 (3.3.3.3): 56 data bytes, press CTRL+C to break

Request time out

Request time out

Request time out

Request time out

Request time out

--- Ping statistics for 3.3.3.3 ---

5 packet(s) transmitted, 0 packet(s) received, 100.0% packet loss

\# 当Switch A上配置了缺省路由时，可以访问3.3.3.3。

[SwitchA] ping 3.3.3.3

Ping 3.3.3.3 (3.3.3.3): 56 data bytes, press CTRL+C to break

56 bytes from 3.3.3.3: icmp_seq=0 ttl=255 time=2.000 ms

56 bytes from 3.3.3.3: icmp_seq=1 ttl=255 time=0.000 ms

56 bytes from 3.3.3.3: icmp_seq=2 ttl=255 time=0.000 ms

56 bytes from 3.3.3.3: icmp_seq=3 ttl=255 time=1.000 ms

56 bytes from 3.3.3.3: icmp_seq=4 ttl=255 time=0.000 ms

--- Ping statistics for 3.3.3.3 ---

5 packet(s) transmitted, 5 packet(s) received, 0.0% packet loss

round-trip min/avg/max/std-dev = 0.000/0.600/2.000/0.800 ms

## 3.5 配置文件

·   Switch A： 

\#

vlan 100

\#

interface Vlan-interface100

 ip address 10.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 100

\#

 ip route-static 0.0.0.0 0 10.1.1.2

\#

·   Switch B ：

\#

vlan 100

\#

interface Vlan-interface100

 ip address 10.1.1.2 255.255.255.0

\#

interface LoopBack0

 ip address 3.3.3.3 255.255.255.255

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 100

\#

## 3.6 相关资料

·   产品配套“三层技术-IP路由配置指导”中的“静态路由”。

·   产品配套“三层技术-IP路由命令参考”中的“静态路由”。



 

# 4 配置浮动静态路由

## 4.1 简介

本案例介绍浮动静态路由的配置方法。

## 4.2 组网需求

浮动路由又被称为路由备份。如[图4](https://www.h3c.com/cn/d_202303/1816253_30005_0.htm#_Ref81321804)所示，Switch A、Switch B、Switch C和Switch D连接了20.1.1.0/24和30.1.1.0/24两个网段，在交换机上配置静态路由以实现两个网段的互通，并配置路由备份以提高网络的可靠性。

Switch A作为20.1.1.0/24网段内主机的缺省网关，在Switch A上存在两条到达30.1.1.0/24网段的静态路由，下一跳分别为Switch B和Switch C。这两条静态路由形成备份，其中：

·   下一跳为Switch B的静态路由优先级高，作为主路由。该路由可达时，Switch A通过Switch B将报文转发到30.1.1.0/24网段。

·   下一跳为Switch C的静态路作为备份路由。当主路由不可达时，备份路由生效，Switch A通过Switch C将报文转发到30.1.1.0/24网段。

·   在主路由恢复正常后，业务流量将切换到主链路上，备份路由失效。

图4 浮动静态路由配置组网图

![img](https://resource.h3c.com/cn/202303/28/20230328_8774736_x_Img_x_png_3_1816253_30005_0.png)

 

![说明](https://resource.h3c.com/cn/202303/28/20230328_8774737_x_Img_x_png_4_1816253_30005_0.png)

此应用场景下，请确保生成树协议处于未使能状态。

 

 

## 4.3 配置步骤

#### 1. 配置Switch A

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchA> system-view

[SwitchA] vlan 2

[SwitchA-vlan2] port gigabitethernet 1/0/1

[SwitchA-vlan2] quit

[SwitchA] vlan 3

[SwitchA-vlan3] port gigabitethernet 1/0/2

[SwitchA-vlan3] quit

[SwitchA] vlan 6

[SwitchA-vlan6] port gigabitethernet 1/0/3

[SwitchA-vlan6] quit

[SwitchA] interface vlan-interface 2

[SwitchA-Vlan-interface2] ip address 10.1.1.1 24

[SwitchA-Vlan-interface2] quit

[SwitchA] interface vlan-interface 3

[SwitchA-Vlan-interface3] ip address 10.3.1.1 24

[SwitchA-Vlan-interface3] quit

[SwitchA] interface vlan-interface 6

[SwitchA-Vlan-interface6] ip address 20.1.1.1 24

[SwitchA-Vlan-interface6] quit

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.1.1.2，优先级为缺省值60。

[SwitchA] ip route-static 30.1.1.0 24 10.1.1.2

\# 配置到达10.2.1.0/24网段的静态路由：下一跳地址为10.1.1.2，优先级为缺省值60。

[SwitchA] ip route-static 10.2.1.0 24 10.1.1.2

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.3.1.3，优先级为80。

[SwitchA] ip route-static 30.1.1.0 24 10.3.1.3 preference 80

\# 配置到达10.4.1.0/24网段的静态路由：下一跳地址为10.3.1.3，优先级为80。

[SwitchA] ip route-static 10.4.1.0 24 10.3.1.3 preference 80

\# 保存配置。

[SwitchA] save force

#### 2. 配置Switch B

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchB> system-view

[SwitchB] vlan 2

[SwitchB-vlan2] port gigabitethernet 1/0/1

[SwitchB-vlan2] quit

[SwitchB] vlan 5

[SwitchB-vlan5] port gigabitethernet 1/0/2

[SwitchB-vlan5] quit

[SwitchB] interface vlan-interface 2

[SwitchB-Vlan-interface2] ip address 10.1.1.2 24

[SwitchB-Vlan-interface2] quit

[SwitchB] interface vlan-interface 5

[SwitchB-Vlan-interface5] ip address 10.2.1.2 24

[SwitchB-Vlan-interface5] quit

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.2.1.4。

[SwitchB] ip route-static 30.1.1.0 24 10.2.1.4

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.1.1.1。

[SwitchB] ip route-static 20.1.1.0 24 10.1.1.1

\# 保存配置。

[SwitchB] save force

#### 3. 配置Switch C

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchC> system-view

[SwitchC] vlan 3

[SwitchC-vlan3] port gigabitethernet 1/0/1

[SwitchC-vlan3] quit

[SwitchC] vlan 4

[SwitchC-vlan4] port gigabitethernet 1/0/2

[SwitchC-vlan4] quit

[SwitchC] interface vlan-interface 3

[SwitchC-Vlan-interface3] ip address 10.3.1.3 24

[SwitchC-Vlan-interface3] quit

[SwitchC] interface vlan-interface 4

[SwitchC-Vlan-interface4] ip address 10.4.1.3 24

[SwitchC-Vlan-interface4] quit

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.4.1.4。

[SwitchC] ip route-static 30.1.1.0 24 10.4.1.4

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.3.1.1。

[SwitchC] ip route-static 20.1.1.0 24 10.3.1.1

\# 保存配置。

[SwitchC] save force

#### 4. 配置Switch D

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchD> system-view

[SwitchD] vlan 4

[SwitchD-vlan4] port gigabitethernet 1/0/1

[SwitchD-vlan4] quit

[SwitchD] vlan 5

[SwitchD-vlan5] port gigabitethernet 1/0/2

[SwitchD-vlan5] quit

[SwitchD] vlan 7

[SwitchD-vlan7] port gigabitethernet 1/0/3

[SwitchD-vlan7] quit

[SwitchD] interface vlan-interface 4

[SwitchD-Vlan-interface6] ip address 10.4.1.4 24

[SwitchD-Vlan-interface6] quit

[SwitchD] interface vlan-interface 5

[SwitchD-Vlan-interface5] ip address 10.2.1.4 24

[SwitchD-Vlan-interface5] quit

[SwitchD] interface vlan-interface 7

[SwitchD-Vlan-interface7] ip address 30.1.1.1 24

[SwitchD-Vlan-interface7] quit

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.2.1.2，优先级为缺省值60。

[SwitchD] ip route-static 20.1.1.0 24 10.2.1.2

\# 配置到达10.1.1.0/24网段的静态路由：下一跳地址为10.2.1.2，优先级为缺省值60。

[SwitchD] ip route-static 10.1.1.0 24 10.2.1.2

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.4.1.3，优先级为80。

[SwitchD] ip route-static 20.1.1.0 24 10.4.1.3 preference 80

\# 配置到达10.3.1.0/24网段的静态路由：下一跳地址为10.4.1.3，优先级为80。

[SwitchD] ip route-static 10.3.1.0 24 10.4.1.3 preference 80

\# 保存配置。

[SwitchD] save force

## 4.4 验证配置

\# 显示Switch A的路由表。

[SwitchA] display ip routing-table

 

Destinations : 9    Routes : 9

 

Destination/Mask  Proto Pre Cost     NextHop     Interface

10.1.1.0/24     Direct 0  0      10.1.1.1    Vlan2

10.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

10.3.1.0/24     Direct 0  0      10.3.1.1    Vlan3

10.3.1.1/32     Direct 0  0      127.0.0.1    InLoop0

20.1.1.0/24     Direct 0  0      20.1.1.1    Vlan6

20.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

30.1.1.0/24     Static 60  0      10.1.1.2    Vlan2

127.0.0.0/8     Direct 0  0      127.0.0.1    InLoop0

127.0.0.1/32    Direct 0  0      127.0.0.1    InLoop0

以上显示信息表示，Switch A通过Switch B将报文转发到30.1.1.0/24网段。

\# 在Switch B上关闭VLAN接口2对应的以太网接口。

<SwitchB> system-view

[SwitchB] interface gigabitethernet 1/0/1

[SwitchB-GigabitEthernet1/0/1] shutdown

\# 显示Switch A的路由表。

[SwitchA] display ip routing-table

 

Destinations : 9    Routes : 9

 

Destination/Mask  Proto Pre Cost     NextHop     Interface

10.1.1.0/24     Direct 0  0      10.1.1.1    Vlan2

10.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

10.3.1.0/24     Direct 0  0      10.3.1.1    Vlan3

10.3.1.1/32     Direct 0  0      127.0.0.1    InLoop0

20.1.1.0/24     Direct 0  0      20.1.1.1    Vlan6

20.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

30.1.1.0/24     Static 80  0      10.3.1.3    Vlan3

127.0.0.0/8     Direct 0  0      127.0.0.1    InLoop0

127.0.0.1/32    Direct 0  0      127.0.0.1    InLoop0

以上显示信息表示，备份路由生效，Switch A通过Switch C将报文转发到30.1.1.0/24网段。

\# 主路由出现故障后，20.1.1.0/24网段内的主机仍然可以与30.1.1.0/24网段内的主机通信。

[SwitchA] ping -a 20.1.1.1 30.1.1.1

Ping 30.1.1.1: 56 data bytes, press CTRL+C to break

Reply from 30.1.1.1: bytes=56 Sequence=1 ttl=254 time=2 ms

Reply from 30.1.1.1: bytes=56 Sequence=2 ttl=254 time=1 ms

Reply from 30.1.1.1: bytes=56 Sequence=3 ttl=254 time=1 ms

Reply from 30.1.1.1: bytes=56 Sequence=4 ttl=254 time=2 ms

Reply from 30.1.1.1: bytes=56 Sequence=5 ttl=254 time=1 ms

 

--- Ping statistics for 30.1.1.1 ---

5 packet(s) transmitted, 5 packet(s) received, 0.00% packet loss

round-trip min/avg/max/std-dev = 1/1/2/1 ms

\# Switch D上的显示信息与Switch A类似。主路由出现故障后，30.1.1.0/24网段内的主机仍然可以与20.1.1.0/24网段内的主机通信。

[SwitchD] ping -a 30.1.1.1 20.1.1.1

Ping 20.1.1.1: 56 data bytes, press CTRL+C to break

Reply from 20.1.1.1: bytes=56 Sequence=1 ttl=254 time=2 ms

Reply from 20.1.1.1: bytes=56 Sequence=2 ttl=254 time=1 ms

Reply from 20.1.1.1: bytes=56 Sequence=3 ttl=254 time=1 ms

Reply from 20.1.1.1: bytes=56 Sequence=4 ttl=254 time=1 ms

Reply from 20.1.1.1: bytes=56 Sequence=5 ttl=254 time=1 ms

 

--- Ping statistics for 20.1.1.1 ---

5 packet(s) transmitted, 5 packet(s) received, 0.00% packet loss

round-trip min/avg/max/std-dev = 1/1/2/1 ms

## 4.5 配置文件

·   Switch A： 

\#

vlan 2

\#

vlan 3

\#

vlan 6

\#

interface Vlan-interface2

 ip address 10.1.1.1 255.255.255.0

\#

interface Vlan-interface3

 ip address 10.3.1.1 255.255.255.0

\#

interface Vlan-interface6

 ip address 20.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 2

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 3

\#

interface GigabitEthernet1/0/3

 port link-mode bridge

 port access vlan 6

\#

 ip route-static 30.1.1.0 24 10.1.1.2

 ip route-static 10.2.1.0 24 10.1.1.2

 ip route-static 30.1.1.0 24 10.3.1.3 preference 80

 ip route-static 10.4.1.0 24 10.3.1.3 preference 80

\#

·   Switch B ：

\#

vlan 2

\#

vlan 5

\#

interface Vlan-interface2

 ip address 10.1.1.2 255.255.255.0

\#

interface Vlan-interface5

 ip address 10.2.1.2 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 2

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 5

\#

 ip route-static 20.1.1.0 24 10.1.1.1

 ip route-static 30.1.1.0 24 10.2.1.4

\#

·   Switch C

\#

vlan 3

\#

vlan 4

\#

interface Vlan-interface3

 ip address 10.3.1.3 255.255.255.0

\#

interface Vlan-interface4

 ip address 10.4.1.3 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 3

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 4

\#

 ip route-static 20.1.1.0 24 10.3.1.1

 ip route-static 30.1.1.0 24 10.4.1.4

\#

·   Switch D

\#

vlan 4

\#

vlan 5

\#

vlan 7

\#

interface Vlan-interface4

 ip address 10.4.1.4 255.255.255.0

\#

interface Vlan-interface5

 ip address 10.2.1.4 255.255.255.0

\#

interface Vlan-interface7

 ip address 30.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 4

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 5

\#

interface GigabitEthernet1/0/3

 port link-mode bridge

 port access vlan 7

\#

 ip route-static 20.1.1.0 24 10.2.1.2

 ip route-static 10.1.1.0 24 10.2.1.2

 ip route-static 20.1.1.0 24 10.4.1.3 preference 80

 ip route-static 10.3.1.0 24 10.4.1.3 preference 80

\#

## 4.6 相关资料

·   产品配套“三层技术-IP路由配置指导”中的“静态路由”。

·   产品配套“三层技术-IP路由命令参考”中的“静态路由”。

 



# 5 配置静态路由实现路由负载分担

## 5.1 简介

本案例介绍静态路由实现路由负载分担的配置方法。

## 5.2 组网需求

如[图5](https://www.h3c.com/cn/d_202303/1816253_30005_0.htm#_Ref126743820)所示，Switch A、Switch B、Switch C和Switch  D连接了20.1.1.0/24和30.1.1.0/24两个网段，在交换机上配置静态路由以实现两个网段的互通，为了提高链路利用率，要求从20.1.1.0/24到30.1.1.0/24的数据流平均分配到两条链路上，并且当其中一条链路故障后流量自动切换到另一条链路上。

Switch A作为20.1.1.0/24网段内主机的缺省网关，在Switch  A上存在两条到达30.1.1.0/24网段的静态路由，下一跳分别为Switch B和Switch  C。通过这两条静态路由形成路由负载分担。注意：需要配置数据流的去程和回程两个方向的静态路由。

图5 静态路由实现路由负载分担配置组网图

![img](https://resource.h3c.com/cn/202303/28/20230328_8774738_x_Img_x_png_5_1816253_30005_0.png)

 

![说明](https://resource.h3c.com/cn/202303/28/20230328_8774739_x_Img_x_png_6_1816253_30005_0.png)

此应用场景下，请确保生成树协议处于未使能状态。

 

## 5.3 配置步骤

#### 1. 配置Switch A

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchA> system-view

[SwitchA] vlan 2

[SwitchA-vlan2] port gigabitethernet 1/0/1

[SwitchA-vlan2] quit

[SwitchA] vlan 3

[SwitchA-vlan3] port gigabitethernet 1/0/2

[SwitchA-vlan3] quit

[SwitchA] vlan 6

[SwitchA-vlan6] port gigabitethernet 1/0/3

[SwitchA-vlan6] quit

[SwitchA] interface vlan-interface 2

[SwitchA-Vlan-interface2] ip address 10.1.1.1 24

[SwitchA-Vlan-interface2] quit

[SwitchA] interface vlan-interface 3

[SwitchA-Vlan-interface3] ip address 10.3.1.1 24

[SwitchA-Vlan-interface3] quit

[SwitchA] interface vlan-interface 6

[SwitchA-Vlan-interface6] ip address 20.1.1.1 24

[SwitchA-Vlan-interface6] quit

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.1.1.2。

[SwitchA] ip route-static 30.1.1.0 24 10.1.1.2

\# 配置到达10.2.1.0/24网段的静态路由：下一跳地址为10.1.1.2。

[SwitchA] ip route-static 10.2.1.0 24 10.1.1.2

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.3.1.3。

[SwitchA] ip route-static 30.1.1.0 24 10.3.1.3

\# 配置到达10.4.1.0/24网段的静态路由：下一跳地址为10.3.1.3。

[SwitchA] ip route-static 10.4.1.0 24 10.3.1.3

\# 保存配置。

[SwitchA] save force

#### 2. 配置Switch B

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchB> system-view

[SwitchB] vlan 2

[SwitchB-vlan2] port gigabitethernet 1/0/1

[SwitchB-vlan2] quit

[SwitchB] vlan 5

[SwitchB-vlan5] port gigabitethernet 1/0/2

[SwitchB-vlan5] quit

[SwitchB] interface vlan-interface 2

[SwitchB-Vlan-interface2] ip address 10.1.1.2 24

[SwitchB-Vlan-interface2] quit

[SwitchB] interface vlan-interface 5

[SwitchB-Vlan-interface5] ip address 10.2.1.2 24

[SwitchB-Vlan-interface5] quit

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.2.1.4。

[SwitchB] ip route-static 30.1.1.0 24 10.2.1.4

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.1.1.1。

[SwitchB] ip route-static 20.1.1.0 24 10.1.1.1

\# 保存配置。

[SwitchB] save force

#### 3. 配置Switch C

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchC> system-view

[SwitchC] vlan 3

[SwitchC-vlan3] port gigabitethernet 1/0/1

[SwitchC-vlan3] quit

[SwitchC] vlan 4

[SwitchC-vlan4] port gigabitethernet 1/0/2

[SwitchC-vlan4] quit

[SwitchC] interface vlan-interface 3

[SwitchC-Vlan-interface3] ip address 10.3.1.3 24

[SwitchC-Vlan-interface3] quit

[SwitchC] interface vlan-interface 4

[SwitchC-Vlan-interface4] ip address 10.4.1.3 24

[SwitchC-Vlan-interface4] quit

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.4.1.4。

[SwitchC] ip route-static 30.1.1.0 24 10.4.1.4

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.3.1.1。

[SwitchC] ip route-static 20.1.1.0 24 10.3.1.1

\# 保存配置。

[SwitchC] save force

#### 4. 配置Switch D

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchD> system-view

[SwitchD] vlan 4

[SwitchD-vlan4] port gigabitethernet 1/0/1

[SwitchD-vlan4] quit

[SwitchD] vlan 5

[SwitchD-vlan5] port gigabitethernet 1/0/2

[SwitchD-vlan5] quit

[SwitchD] vlan 7

[SwitchD-vlan7] port gigabitethernet 1/0/3

[SwitchD-vlan7] quit

[SwitchD] interface vlan-interface 4

[SwitchD-Vlan-interface4] ip address 10.4.1.4 24

[SwitchD-Vlan-interface4] quit

[SwitchD] interface vlan-interface 5

[SwitchD-Vlan-interface5] ip address 10.2.1.4 24

[SwitchD-Vlan-interface5] quit

[SwitchD] interface vlan-interface 7

[SwitchD-Vlan-interface7] ip address 30.1.1.1 24

[SwitchD-Vlan-interface7] quit

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.2.1.2。

[SwitchD] ip route-static 20.1.1.0 24 10.2.1.2

\# 配置到达10.1.1.0/24网段的静态路由：下一跳地址为10.2.1.2。

[SwitchD] ip route-static 10.1.1.0 24 10.2.1.2

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.4.1.3。

[SwitchD] ip route-static 20.1.1.0 24 10.4.1.3

\# 配置到达10.3.1.0/24网段的静态路由：下一跳地址为10.4.1.3。

[SwitchD] ip route-static 10.3.1.0 24 10.4.1.3

\# 保存配置。

[SwitchD] save force

## 5.4 验证配置

\# 显示Switch A的路由表。

[SwitchA] display ip routing-table

 

Destinations : 9    Routes : 10

 

Destination/Mask  Proto Pre Cost     NextHop     Interface

10.1.1.0/24     Direct 0  0      10.1.1.1    Vlan2

10.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

10.3.1.0/24     Direct 0  0      10.3.1.1    Vlan3

10.3.1.1/32     Direct 0  0      127.0.0.1    InLoop0

20.1.1.0/24     Direct 0  0      20.1.1.1    Vlan6

20.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

30.1.1.0/24     Static 60  0      10.1.1.2    Vlan2

​           Static 60  0      10.3.1.3    Vlan3

127.0.0.0/8     Direct 0  0      127.0.0.1    InLoop0

127.0.0.1/32    Direct 0  0      127.0.0.1    InLoop0

以上显示信息表示，Switch A可以通过Switch B和Switch C将报文转发到30.1.1.0/24网段。

\# 在Switch B上关闭VLAN接口2对应的以太网接口。

<SwitchB> system-view

[SwitchB] interface gigabitethernet 1/0/1

[SwitchB-GigabitEthernet1/0/1] shutdown

\# 显示Switch A的路由表。

[SwitchA] display ip routing-table

 

Destinations : 9    Routes : 9

 

Destination/Mask  Proto Pre Cost     NextHop     Interface

10.1.1.0/24     Direct 0  0      10.1.1.1    Vlan2

10.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

10.3.1.0/24     Direct 0  0      10.3.1.1    Vlan3

10.3.1.1/32     Direct 0  0      127.0.0.1    InLoop0

20.1.1.0/24     Direct 0  0      20.1.1.1    Vlan6

20.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

30.1.1.0/24     Static 60  0      10.3.1.3    Vlan3

127.0.0.0/8     Direct 0  0      127.0.0.1    InLoop0

127.0.0.1/32    Direct 0  0      127.0.0.1    InLoop0

以上显示信息表示，当其中一条链路故障时，Switch A可以通过Switch C将报文转发到30.1.1.0/24网段。

\#其中一条链路出现故障后，20.1.1.0/24网段内的主机仍然可以与30.1.1.0/24网段内的主机通信。

[SwitchA] ping -a 20.1.1.1 30.1.1.1

Ping 30.1.1.1: 56 data bytes, press CTRL+C to break

Reply from 30.1.1.1: bytes=56 Sequence=1 ttl=254 time=2 ms

Reply from 30.1.1.1: bytes=56 Sequence=2 ttl=254 time=1 ms

Reply from 30.1.1.1: bytes=56 Sequence=3 ttl=254 time=1 ms

Reply from 30.1.1.1: bytes=56 Sequence=4 ttl=254 time=2 ms

Reply from 30.1.1.1: bytes=56 Sequence=5 ttl=254 time=1 ms

 

--- Ping statistics for 30.1.1.1 ---

5 packet(s) transmitted, 5 packet(s) received, 0.00% packet loss

round-trip min/avg/max/std-dev = 1/1/2/1 ms

\# Switch D上的显示信息与Switch A类似。其中一条链路出现故障后，30.1.1.0/24网段内的主机仍然可以与20.1.1.0/24网段内的主机通信。

[SwitchD] ping -a 30.1.1.1 20.1.1.1

Ping 20.1.1.1: 56 data bytes, press CTRL+C to break

Reply from 20.1.1.1: bytes=56 Sequence=1 ttl=254 time=2 ms

Reply from 20.1.1.1: bytes=56 Sequence=2 ttl=254 time=1 ms

Reply from 20.1.1.1: bytes=56 Sequence=3 ttl=254 time=1 ms

Reply from 20.1.1.1: bytes=56 Sequence=4 ttl=254 time=1 ms

Reply from 20.1.1.1: bytes=56 Sequence=5 ttl=254 time=1 ms

 

--- Ping statistics for 20.1.1.1 ---

5 packet(s) transmitted, 5 packet(s) received, 0.00% packet loss

round-trip min/avg/max/std-dev = 1/1/2/1 ms

## 5.5 配置文件

·   Switch A： 

\#

vlan 2

\#

vlan 3

\#

vlan 6

\#

interface Vlan-interface2

 ip address 10.1.1.1 255.255.255.0

\#

interface Vlan-interface3

 ip address 10.3.1.1 255.255.255.0

\#

interface Vlan-interface6

 ip address 20.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 2

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 3

\#

interface GigabitEthernet1/0/3

 port link-mode bridge

 port access vlan 6

\#

 ip route-static 30.1.1.0 24 10.1.1.2

 ip route-static 10.2.1.0 24 10.1.1.2

 ip route-static 30.1.1.0 24 10.3.1.3

 ip route-static 10.4.1.0 24 10.3.1.3

\#

·   Switch B ：

\#

vlan 2

\#

vlan 5

\#

interface Vlan-interface2

 ip address 10.1.1.2 255.255.255.0

\#

interface Vlan-interface5

 ip address 10.2.1.2 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 2

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 5

\#

 ip route-static 20.1.1.0 24 10.1.1.1

 ip route-static 30.1.1.0 24 10.2.1.4

\#

·   Switch C

\#

vlan 3

\#

vlan 4

\#

interface Vlan-interface3

 ip address 10.3.1.3 255.255.255.0

\#

interface Vlan-interface4

 ip address 10.4.1.3 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 3

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 4

\#

 ip route-static 20.1.1.0 24 10.3.1.1

 ip route-static 30.1.1.0 24 10.4.1.4

\#

·   Switch D

\#

vlan 4

\#

vlan 5

\#

vlan 7

\#

interface Vlan-interface4

 ip address 10.4.1.4 255.255.255.0

\#

interface Vlan-interface5

 ip address 10.2.1.4 255.255.255.0

\#

interface Vlan-interface7

 ip address 30.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 4

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 5

\#

interface GigabitEthernet1/0/3

 port link-mode bridge

 port access vlan 7

\#

 ip route-static 20.1.1.0 24 10.2.1.2

 ip route-static 10.1.1.0 24 10.2.1.2

 ip route-static 20.1.1.0 24 10.4.1.3

 ip route-static 10.3.1.0 24 10.4.1.3

\#

## 5.6 相关资料

·   产品配套“三层技术-IP路由配置指导”中的“静态路由”。

·   产品配套“三层技术-IP路由命令参考”中的“静态路由”。



# 6 静态路由、Track与NQA联动

## 6.1 简介

本案例介绍静态路由、Track与NQA联动的配置方法。

## 6.2 组网需求

如[图6](https://www.h3c.com/cn/d_202303/1816253_30005_0.htm#_Ref124256276)所示，Switch A、Switch B、Switch C和Switch D连接了20.1.1.0/24和30.1.1.0/24两个网段，在交换机上配置静态路由以实现两个网段的互通，并配置路由备份以提高网络的可靠性。

Switch A作为20.1.1.0/24网段内主机的缺省网关，在Switch A上存在两条到达30.1.1.0/24网段的静态路由，下一跳分别为Switch B和Switch C。这两条静态路由形成备份，其中：

·   下一跳为Switch B的静态路由优先级高，作为主路由。该路由可达时，Switch A通过Switch B将报文转发到30.1.1.0/24网段。

·   下一跳为Switch C的静态路作为备份路由。

·   在Switch A上通过静态路由、Track与NQA联动，实时判断主路由是否可达。当主路由不可达时，备份路由生效，Switch A通过Switch C将报文转发到30.1.1.0/24网段。

同样地，Switch D作为30.1.1.0/24网段内主机的缺省网关，在Switch D上存在两条到达20.1.1.0/24网段的静态路由，下一跳分别为Switch B和Switch C。这两条静态路由形成备份，其中：

·   下一跳为Switch B的静态路由优先级高，作为主路由。该路由可达时，Switch D通过Switch B将报文转发到20.1.1.0/24网段。

·   下一跳为Switch C的静态路作为备份路由。

·   在Switch D上通过静态路由、Track与NQA联动，实时判断主路由是否可达。当主路由不可达时，备份路由生效，Switch D通过Switch C将报文转发到20.1.1.0/24网段。

图6 静态路由、Track与NQA联动配置组网图

![img](https://resource.h3c.com/cn/202303/28/20230328_8774740_x_Img_x_png_7_1816253_30005_0.png)

 

![说明](https://resource.h3c.com/cn/202303/28/20230328_8774741_x_Img_x_png_8_1816253_30005_0.png)

此应用场景下，请确保生成树协议处于未使能状态。

 

 

## 6.3 配置思路

配置思路如下：

(1)   配置各设备IP地址

(2)   配置静态路由

配置主备静态路由，其中下一跳为Switch B的静态路由优先级高，作为主路由，下一跳为Switch C的静态路作为备份路由。

(3)   配置NQA测试

分别在Switch A和Switch D上配置NQA检测Switch A－Switch B－Switch D这条路径的连通性。通过Track关联NQA测试组，实现静态路由、Track与NQA联动。

## 6.4 配置步骤

#### 1. 配置Switch A

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchA> system-view

[SwitchA] vlan 2

[SwitchA-vlan2] port gigabitethernet 1/0/1

[SwitchA-vlan2] quit

[SwitchA] vlan 3

[SwitchA-vlan3] port gigabitethernet 1/0/2

[SwitchA-vlan3] quit

[SwitchA] vlan 6

[SwitchA-vlan6] port gigabitethernet 1/0/3

[SwitchA-vlan6] quit

[SwitchA] interface vlan-interface 2

[SwitchA-Vlan-interface2] ip address 10.1.1.1 24

[SwitchA-Vlan-interface2] quit

[SwitchA] interface vlan-interface 3

[SwitchA-Vlan-interface3] ip address 10.3.1.1 24

[SwitchA-Vlan-interface3] quit

[SwitchA] interface vlan-interface 6

[SwitchA-Vlan-interface6] ip address 20.1.1.1 24

[SwitchA-Vlan-interface6] quit

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.1.1.2，优先级为缺省值60，该路由与Track项1关联。

[SwitchA] ip route-static 30.1.1.0 24 10.1.1.2 track 1

\# 配置到达10.2.1.0/24网段的静态路由：下一跳地址为10.1.1.2，优先级为缺省值60。

[SwitchA] ip route-static 10.2.1.0 24 10.1.1.2

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.3.1.3，优先级为80。

[SwitchA] ip route-static 30.1.1.0 24 10.3.1.3 preference 80

\# 配置到达10.4.1.0/24网段的静态路由：下一跳地址为10.3.1.3，优先级为80。

[SwitchA] ip route-static 10.4.1.0 24 10.3.1.3 preference 80

\# 配置到达10.2.1.4的静态路由：下一跳地址为10.1.1.2。

[SwitchA] ip route-static 10.2.1.4 24 10.1.1.2

\# 创建管理员名为admin、操作标签为test的NQA测试组。

[SwitchA] nqa entry admin test

\# 配置测试类型为ICMP-echo。

[SwitchA-nqa-admin-test] type icmp-echo

\# 配置测试的目的地址为10.2.1.4，下一跳地址为10.1.1.2，以便通过NQA检测Switch A－Switch B－Switch D这条路径的连通性。

[SwitchA-nqa-admin-test-icmp-echo] destination ip 10.2.1.4

[SwitchA-nqa-admin-test-icmp-echo] next-hop ip 10.1.1.2

\# 配置测试频率为100ms。

[SwitchA-nqa-admin-test-icmp-echo] frequency 100

\# 配置联动项1（连续失败5次触发联动）。

[SwitchA-nqa-admin-test-icmp-echo] reaction 1 checked-element probe-fail threshold-type consecutive 5 action-type trigger-only

[SwitchA-nqa-admin-test-icmp-echo] quit

\# 启动探测。

[SwitchA] nqa schedule admin test start-time now lifetime forever

\# 配置Track项1，并进入Track视图，关联NQA测试组（管理员为admin，操作标签为test）的联动项1。

[SwitchA] track 1 nqa entry admin test reaction 1

[SwitchA-track-1] quit

\# 保存配置。

[SwitchA] save force

#### 2. 配置Switch B

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchB> system-view

[SwitchB] vlan 2

[SwitchB-vlan2] port gigabitethernet 1/0/1

[SwitchB-vlan2] quit

[SwitchB] vlan 5

[SwitchB-vlan5] port gigabitethernet 1/0/2

[SwitchB-vlan5] quit

[SwitchB] interface vlan-interface 2

[SwitchB-Vlan-interface2] ip address 10.1.1.2 24

[SwitchB-Vlan-interface2] quit

[SwitchB] interface vlan-interface 5

[SwitchB-Vlan-interface5] ip address 10.2.1.2 24

[SwitchB-Vlan-interface5] quit

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.2.1.4。

[SwitchB] ip route-static 30.1.1.0 24 10.2.1.4

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.1.1.1。

[SwitchB] ip route-static 20.1.1.0 24 10.1.1.1

\# 保存配置。

[SwitchB] save force

#### 3. 配置Switch C

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchC> system-view

[SwitchC] vlan 3

[SwitchC-vlan3] port gigabitethernet 1/0/1

[SwitchC-vlan3] quit

[SwitchC] vlan 4

[SwitchC-vlan4] port gigabitethernet 1/0/2

[SwitchC-vlan4] quit

[SwitchC] interface vlan-interface 3

[SwitchC-Vlan-interface3] ip address 10.3.1.3 24

[SwitchC-Vlan-interface3] quit

[SwitchC] interface vlan-interface 4

[SwitchC-Vlan-interface4] ip address 10.4.1.3 24

[SwitchC-Vlan-interface4] quit

\# 配置到达30.1.1.0/24网段的静态路由：下一跳地址为10.4.1.4。

[SwitchC] ip route-static 30.1.1.0 24 10.4.1.4

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.3.1.1。

[SwitchC] ip route-static 20.1.1.0 24 10.3.1.1

\# 保存配置。

[SwitchC] save force

#### 4. 配置Switch D

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchD> system-view

[SwitchD] vlan 4

[SwitchD-vlan4] port gigabitethernet 1/0/1

[SwitchD-vlan4] quit

[SwitchD] vlan 5

[SwitchD-vlan5] port gigabitethernet 1/0/2

[SwitchD-vlan5] quit

[SwitchD] vlan 7

[SwitchD-vlan7] port gigabitethernet 1/0/3

[SwitchD-vlan7] quit

[SwitchD] interface vlan-interface 4

[SwitchD-Vlan-interface6] ip address 10.4.1.4 24

[SwitchD-Vlan-interface6] quit

[SwitchD] interface vlan-interface 5

[SwitchD-Vlan-interface5] ip address 10.2.1.4 24

[SwitchD-Vlan-interface5] quit

[SwitchD] interface vlan-interface 7

[SwitchD-Vlan-interface7] ip address 30.1.1.1 24

[SwitchD-Vlan-interface7] quit

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.2.1.2，优先级为缺省值60，该路由与Track项1关联。

[SwitchD] ip route-static 20.1.1.0 24 10.2.1.2 track 1

\# 配置到达10.1.1.0/24网段的静态路由：下一跳地址为10.2.1.2，优先级为缺省值60。

[SwitchD] ip route-static 10.1.1.0 24 10.2.1.2

\# 配置到达20.1.1.0/24网段的静态路由：下一跳地址为10.4.1.3，优先级为80。

[SwitchD] ip route-static 20.1.1.0 24 10.4.1.3 preference 80

\# 配置到达10.3.1.0/24网段的静态路由：下一跳地址为10.4.1.3，优先级为80。

[SwitchD] ip route-static 10.3.1.0 24 10.4.1.3 preference 80

\# 配置到达10.1.1.1的静态路由：下一跳地址为10.2.1.2。

[SwitchD] ip route-static 10.1.1.1 24 10.2.1.2

\# 创建管理员名为admin、操作标签为test的NQA测试组。

[SwitchD] nqa entry admin test

\# 配置测试类型为ICMP-echo。

[SwitchD-nqa-admin-test] type icmp-echo

\# 配置测试的目的地址为10.1.1.1，下一跳地址为10.2.1.2，以便通过NQA检测Switch D－Switch B－Switch A这条路径的连通性。

[SwitchD-nqa-admin-test-icmp-echo] destination ip 10.1.1.1

[SwitchD-nqa-admin-test-icmp-echo] next-hop ip 10.2.1.2

\# 配置测试频率为100ms。

[SwitchD-nqa-admin-test-icmp-echo] frequency 100

\# 配置联动项1（连续失败5次触发联动）。

[SwitchD-nqa-admin-test-icmp-echo] reaction 1 checked-element probe-fail threshold-type consecutive 5 action-type trigger-only

[SwitchD-nqa-admin-test-icmp-echo] quit

\# 启动探测。

[SwitchD] nqa schedule admin test start-time now lifetime forever

\# 配置Track项1，并进入Track视图，关联NQA测试组（管理员为admin，操作标签为test）的联动项1。

[SwitchD] track 1 nqa entry admin test reaction 1

[SwitchD-track-1] quit

\# 保存配置。

[SwitchD] save force

## 6.5 验证配置

\# 显示Switch A上Track项的信息。

[SwitchA] display track all

Track ID: 1

 State: Positive

 Duration: 0 days 0 hours 0 minutes 32 seconds

 Tracked object type: NQA

 Notification delay: Positive 0, Negative 0 (in seconds)

 Tracked object:

  NQA entry: admin test

  Reaction: 1

  Remote IP/URL: 10.2.1.4

  Local IP: --

  Interface: --

\# 显示Switch A的路由表。

[SwitchA] display ip routing-table

 

Destinations : 10    Routes : 10

 

Destination/Mask  Proto Pre Cost     NextHop     Interface

10.1.1.0/24     Direct 0  0      10.1.1.1    Vlan2

10.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

10.2.1.0/24     Static 60  0      10.1.1.2    Vlan2

10.3.1.0/24     Direct 0  0      10.3.1.1    Vlan3

10.3.1.1/32     Direct 0  0      127.0.0.1    InLoop0

20.1.1.0/24     Direct 0  0      20.1.1.1    Vlan6

20.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

30.1.1.0/24     Static 60  0      10.1.1.2    Vlan2

127.0.0.0/8     Direct 0  0      127.0.0.1    InLoop0

127.0.0.1/32    Direct 0  0      127.0.0.1    InLoop0

以上显示信息表示，NQA测试的结果为主路由可达（Track项状态为Positive），Switch A通过Switch B将报文转发到30.1.1.0/24网段。

\# 在Switch B上关闭VLAN接口2对应的以太网接口。

<SwitchB> system-view

[SwitchB] interface gigabitethernet 1/0/1

[SwitchB-Gigabitethernet 1/0/1] shutdown

\# 显示Switch A上Track项的信息。

[SwitchA] display track all

Track ID: 1

 State: Negative

 Duration: 0 days 0 hours 0 minutes 32 seconds

 Tracked object type: NQA

 Notification delay: Positive 0, Negative 0 (in seconds)

 Tracked object:

  NQA entry: admin test

  Reaction: 1

  Remote IP/URL: 10.2.1.4

  Local IP: --

  Interface: --

\# 显示Switch A的路由表。

[SwitchA] display ip routing-table

 

Destinations : 10    Routes : 10

 

Destination/Mask  Proto Pre Cost     NextHop     Interface

10.1.1.0/24     Direct 0  0      10.1.1.1    Vlan2

10.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

10.2.1.0/24     Static 60  0      10.1.1.2    Vlan2

10.3.1.0/24     Direct 0  0      10.3.1.1    Vlan3

10.3.1.1/32     Direct 0  0      127.0.0.1    InLoop0

20.1.1.0/24     Direct 0  0      20.1.1.1    Vlan6

20.1.1.1/32     Direct 0  0      127.0.0.1    InLoop0

30.1.1.0/24     Static 80  0      10.3.1.3    Vlan3

127.0.0.0/8     Direct 0  0      127.0.0.1    InLoop0

127.0.0.1/32    Direct 0  0      127.0.0.1    InLoop0

以上显示信息表示，NQA测试的结果为主路由不可达（Track项状态为Negative），则备份路由生效，Switch A通过Switch C将报文转发到30.1.1.0/24网段。

\# 主路由出现故障后，20.1.1.0/24网段内的主机仍然可以与30.1.1.0/24网段内的主机通信。

[SwitchA] ping -a 20.1.1.1 30.1.1.1

Ping 30.1.1.1: 56 data bytes, press CTRL+C to break

Reply from 30.1.1.1: bytes=56 Sequence=1 ttl=254 time=2 ms

Reply from 30.1.1.1: bytes=56 Sequence=2 ttl=254 time=1 ms

Reply from 30.1.1.1: bytes=56 Sequence=3 ttl=254 time=1 ms

Reply from 30.1.1.1: bytes=56 Sequence=4 ttl=254 time=2 ms

Reply from 30.1.1.1: bytes=56 Sequence=5 ttl=254 time=1 ms

 

--- Ping statistics for 30.1.1.1 ---

5 packet(s) transmitted, 5 packet(s) received, 0.00% packet loss

round-trip min/avg/max/std-dev = 1/1/2/1 ms

\# Switch D上的显示信息与Switch A类似。主路由出现故障后，30.1.1.0/24网段内的主机仍然可以与20.1.1.0/24网段内的主机通信。

[SwitchD] ping -a 30.1.1.1 20.1.1.1

Ping 20.1.1.1: 56 data bytes, press CTRL+C to break

Reply from 20.1.1.1: bytes=56 Sequence=1 ttl=254 time=2 ms

Reply from 20.1.1.1: bytes=56 Sequence=2 ttl=254 time=1 ms

Reply from 20.1.1.1: bytes=56 Sequence=3 ttl=254 time=1 ms

Reply from 20.1.1.1: bytes=56 Sequence=4 ttl=254 time=1 ms

Reply from 20.1.1.1: bytes=56 Sequence=5 ttl=254 time=1 ms

 

--- Ping statistics for 20.1.1.1 ---

5 packet(s) transmitted, 5 packet(s) received, 0.00% packet loss

round-trip min/avg/max/std-dev = 1/1/2/1 ms

## 6.6 配置文件

·   Switch A： 

\#

vlan 2

\#

vlan 3

\#

vlan 6

\#

nqa entry admin test

 type icmp-echo

 destination ip 10.2.1.4

 frequency 100

 next-hop ip 10.1.1.2

 reaction 1 checked-element probe-fail threshold-type consecutive 5 action-type trigger-only

\#

 nqa schedule admin test start-time now lifetime forever

\#

interface Vlan-interface2

 ip address 10.1.1.1 255.255.255.0

\#

interface Vlan-interface3

 ip address 10.3.1.1 255.255.255.0

\#

interface Vlan-interface6

 ip address 20.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 2

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 3

\#

interface GigabitEthernet1/0/3

 port link-mode bridge

 port access vlan 6

\#

 ip route-static 10.2.1.0 24 10.1.1.2

 ip route-static 30.1.1.0 24 10.1.1.2 track 1

 ip route-static 10.4.1.0 24 10.3.1.3 preference 80

 ip route-static 30.1.1.0 24 10.3.1.3 preference 80

\#

 track 1 nqa entry admin test reaction 1

\#

·   Switch B ：

\#

vlan 2

\#

vlan 5

\#

interface Vlan-interface2

 ip address 10.1.1.2 255.255.255.0

\#

interface Vlan-interface5

 ip address 10.2.1.2 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 2

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 5

\#

 ip route-static 20.1.1.0 24 10.1.1.1

 ip route-static 30.1.1.0 24 10.2.1.4

\#

·   Switch C

\#

vlan 3

\#

vlan 4

\#

interface Vlan-interface3

 ip address 10.3.1.3 255.255.255.0

\#

interface Vlan-interface4

 ip address 10.4.1.3 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 3

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 4

\#

 ip route-static 20.1.1.0 24 10.3.1.1

 ip route-static 30.1.1.0 24 10.4.1.4

\#

·   Switch D

\#

vlan 4

\#

vlan 5

\#

vlan 7

\#

nqa entry admin test

 type icmp-echo

 destination ip 10.1.1.1

 frequency 100

 next-hop ip 10.2.1.2

 reaction 1 checked-element probe-fail threshold-type consecutive 5 action-type trigger-only

\#

 nqa schedule admin test start-time now lifetime forever

\#

interface Vlan-interface4

 ip address 10.4.1.4 255.255.255.0

\#

interface Vlan-interface5

 ip address 10.2.1.4 255.255.255.0

\#

interface Vlan-interface7

 ip address 30.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 4

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 5

\#

interface GigabitEthernet1/0/3

 port link-mode bridge

 port access vlan 7

\#

 ip route-static 10.1.1.0 24 10.2.1.2

 ip route-static 20.1.1.0 24 10.2.1.2 track 1

 ip route-static 10.3.1.0 24 10.4.1.3 preference 80

 ip route-static 20.1.1.0 24 10.4.1.3 preference 80

\#

 track 1 nqa entry admin test reaction 1

\#

## 6.7 相关资料

·   产品配套“三层技术-IP路由配置指导”中的“静态路由”。

·   产品配套“三层技术-IP路由命令参考”中的“静态路由”。

·   产品配套“可靠性配置指导”中的“Track”。

·   产品配套“可靠性命令参考”中的“Track”。



 

# 7 跨网段登录设备Web页面

## 7.1 简介

本案例介绍使用HTTP方式跨网段登录设备Web页面的配置方法。

## 7.2 组网需求

如[图7](https://www.h3c.com/cn/d_202303/1816253_30005_0.htm#_Ref81228187)所示，Host与交换机设备通过IP网络相连且路由可达，要求Host能通过HTTP方式跨网段登录Switch B的Web页面。

图7 跨网段登录设备Web页面组网图

![img](https://resource.h3c.com/cn/202303/28/20230328_8774742_x_Img_x_png_9_1816253_30005_0.png)

 

## 7.3 配置步骤

#### 1. 配置Switch A

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchA> system-view

[SwitchA] vlan 100

[SwitchA-vlan100] port gigabitethernet 1/0/1

[SwitchA-vlan100] quit

[SwitchA] vlan 200

[SwitchA-vlan200] port gigabitethernet 1/0/2

[SwitchA-vlan200] quit

[SwitchA] interface vlan-interface 100

[SwitchA-Vlan-interface100] ip address 10.1.1.1 24

[SwitchA-Vlan-interface100] quit

[SwitchA] interface vlan-interface 200

[SwitchA-Vlan-interface200] ip address 20.1.1.1 24

[SwitchA-Vlan-interface200] quit

\# 保存配置。

[SwitchA] save force

#### 2. 配置Switch B

\# 创建VLAN，在VLAN中加入对应的端口，并配置各VLAN接口的IP地址。

<SwitchB> system-view

[SwitchB] vlan 200

[SwitchB-vlan200] port gigabitethernet 1/0/1

[SwitchB-vlan200] quit

[SwitchB] interface vlan-interface 200

[SwitchB-Vlan-interface200] ip address 20.1.1.2 24

[SwitchB-Vlan-interface200] quit

\# 配置Web用户名为admin，认证密码为hello12345，服务类型为http，用户角色为network-admin。

[SwitchB] local-user admin

[SwitchB-luser-manage-admin] service-type http

[SwitchB-luser-manage-admin] authorization-attribute user-role network-admin

[SwitchB-luser-manage-admin] password simple hello12345

[SwitchB-luser-manage-admin] quit

\# 配置开启HTTP服务。

[SwitchB] ip http enable

\# 配置静态路由。

[SwitchB] ip route-static 10.1.1.0 24 20.1.1.1

\# 保存配置。

[SwitchB] save force

#### 3. 配置Host

为Host配置IP地址为10.1.1.2，掩码为255.255.255.0，网关地址为10.1.1.1。

## 7.4 验证配置

\# 在Host上使用**ping**命令验证Switch B是否可达（假定主机安装的操作系统为Windows XP）。

C:\Documents and Settings\Administrator>ping 20.1.1.2

 

Pinging 20.1.1.2 with 32 bytes of data:

 

Reply from 20.1.1.2: bytes=32 time=1ms TTL=126

Reply from 20.1.1.2: bytes=32 time=1ms TTL=126

Reply from 20.1.1.2: bytes=32 time=1ms TTL=126

Reply from 20.1.1.2: bytes=32 time=1ms TTL=126

 

Ping statistics for 20.1.1.2:

  Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),

Approximate round trip times in milli-seconds:

  Minimum = 1ms, Maximum = 1ms, Average = 1ms

\# 在Host的浏览器地址栏内输入Switch B的IP地址并回车，浏览器将显示Web登录页面。在本页面输入用户名和密码，点击<登录>按钮后即可登录。成功登录后，用户可以在配置区对设备进行相关配置。

图8 Switch B的Web登录页面

![img](https://resource.h3c.com/cn/202303/28/20230328_8774734_x_Img_x_png_10_1816253_30005_0.png)

 

## 7.5 配置文件

·   Switch A： 

\#

vlan 100

\#

vlan 200

interface Vlan-interface100

 ip address 10.1.1.1 255.255.255.0

\#

interface Vlan-interface200

 ip address 20.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 100

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port access vlan 200

\#

·   Switch B ：

\#

vlan 200

\#

interface Vlan-interface200

 ip address 20.1.1.2 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port access vlan 200

\#

 ip route-static 10.1.1.0 24 20.1.1.1

\#

local-user admin class manage

 password hash $h$6$BdqhpnjJwOBmHmmt$rQ/FQ6WnS9gVhEpdZY3hjvWSYxCtI+9ngtivuAwrvFdCDVE8AepcSxtprJR5XAdrYbXQE76FumgUszLRn03a0g==

 service-type http

 authorization-attribute user-role network-admin

 authorization-attribute user-role network-operator

\#

 ip http enable

\#

# 配置静态路由实现公私网路由互通

## 1.1 简介

本案例介绍配置静态路由实现公私网路由互通的配置方法。

## 1.2 组网需求

如[图1](https://www.h3c.com/cn/d_202303/1816267_30005_0.htm#_Ref359138698)所示，PE1为公网中的设备，服务器Server与PE1直连。PE2连接VR1，VPN1通过PE2接入公网。需求如下：

实现公私网路由互通，VR1能够访问到Server。

图1 配置静态路由实现公私网路由互通组网示意图

![img](https://resource.h3c.com/cn/202303/28/20230328_8774830_x_Img_x_png_0_1816267_30005_0.png)

 

## 1.3 配置思路

要实现VR1能够访问到Server，需要按顺序完成如下配置：

(1)   在PE1和VR1创建VLAN及相应的VLAN接口；

(2)   在PE2上配置VPN实例并将VR1接入PE2；

(3)   在Server、PE1和VR1上配置静态路由保证公网路由互通；

(4)   在PE2上配置静态路由实现公私网路由互通。

## 1.4 配置步骤

#### 1. 配置VR1

\# 在VR1设备上创建VLAN10，并将GigabitEthernet1/0/1端口加入VLAN10。

<VR1> system-view

[VR1] vlan 10

[VR1-vlan10] quit

[VR1] interface GigabitEthernet 1/0/1

[VR1-GigabitEthernet1/0/1] port link-type trunk

[VR1-GigabitEthernet1/0/1] port trunk permit vlan 10

[VR1-GigabitEthernet1/0/1] undo port trunk permit vlan 1

[VR1-GigabitEthernet1/0/1] quit

\# 配置Vlan-interface10接口的IP地址为10.214.10.2/24。

[VR1] interface Vlan-interface 10

[VR1-Vlan-interface10] ip address 10.214.10.2 24

[VR1-Vlan-interface10] quit

#### 2. 配置PE1

\# 在PE1设备上创建VLAN30和VLAN40，并将GigabitEthernet1/0/1端口加入VLAN40，将GigabitEthernet1/0/2端口加入VLAN30。

<PE1> system-view

[PE1] vlan 30

[PE1-vlan30] quit

[PE1] vlan 40

[PE1-vlan40] quit

[PE1] interface GigabitEthernet 1/0/1

[PE1-GigabitEthernet1/0/1] port link-type trunk

[PE1-GigabitEthernet1/0/1] port trunk permit vlan 40

[PE1-GigabitEthernet1/0/1] undo port trunk permit vlan 1

[PE1-GigabitEthernet1/0/1] quit

[PE1] interface GigabitEthernet 1/0/2

[PE1-GigabitEthernet1/0/2] port link-type trunk

[PE1-GigabitEthernet1/0/2] port trunk permit vlan 30

[PE1-GigabitEthernet1/0/2] undo port trunk permit vlan 1

[PE1-GigabitEthernet1/0/2] quit

\# 配置PE1的Vlan-interface30和Vlan-interface40接口分的IP地址分别为172.16.30.2/24和10.1.1.1/24。

[PE1] interface Vlan-interface 30

[PE1-Vlan-interface30] ip address 172.16.30.2 24

[PE1-Vlan-interface30] quit

[PE1] interface Vlan-interface 40

[PE1-Vlan-interface40] ip address 10.1.1.1 24

[PE1-Vlan-interface40] quit

#### 3. 配置PE2

\# 在PE2设备上为VPN1创建VPN实例，名为“vpn1”，并配置该实例的RD值为10:1，接收和发送的VPN Target属性均为111:1。。

<PE2> system-view

[PE2] ip vpn-instance vpn1

[PE2-vpn-instance-vpn1] route-distinguisher 10:1

[PE2-vpn-instance-vpn1] vpn-target 111:1

[PE2-vpn-instance-vpn1] quit

\# 在PE2设备上创建VLAN10和VLAN30，并将GigabitEthernet1/0/10端口加入VLAN10，将GigabitEthernet1/0/3端口加入VLAN30。

[PE2] vlan 10

[PE2-vlan10] quit

[PE2] vlan 30

[PE2-vlan30] quit 

[PE2] interface GigabitEthernet 1/0/10

[PE2-GigabitEthernet1/0/10] port link-type trunk

[PE2-GigabitEthernet1/0/10] port trunk permit vlan 10

[PE2-GigabitEthernet1/0/10] undo port trunk permit vlan 1

[PE2-GigabitEthernet1/0/10] quit

[PE2] interface GigabitEthernet 1/0/3

[PE2-GigabitEthernet1/0/3] port link-type trunk

[PE2-GigabitEthernet1/0/3] port trunk permit vlan 30

[PE2-GigabitEthernet1/0/3] undo port trunk permit vlan 1

[PE2-GigabitEthernet1/0/3] quit

\# 配置Vlan-interface10接口与VPN1实例进行绑定，并配置IP地址为10.214.10.3/24。

[PE2] interface Vlan-interface 10

[PE2-Vlan-interface10] ip binding vpn-instance vpn1

[PE2-Vlan-interface10] ip address 10.214.10.3 24

[PE2-Vlan-interface10] quit

\# 配置Vlan-interface30接口的IP地址为172.16.30.1/24。

[PE2] interface Vlan-interface 30

[PE2-Vlan-interface30] ip address 172.16.30.1 24

[PE2-Vlan-interface30] quit

#### 4. 在Server、PE1和VR1上配置静态路由

\# 在Server上指定静态路由，去往10.214.10.0网段的报文，下一跳地址为10.1.1.1。

<Server> system-view

[Server] ip route-static 10.214.10.0 255.255.255.0 10.1.1.1

\# 在PE1上指定静态路由，去往10.214.10.0网段的报文，下一跳地址为172.16.30.1。

<PE1> system-view

[PE1] ip route-static 10.214.10.0 24 172.16.30.1

\# 在VR1上指定静态路由，去往10.1.1.0网段的报文，下一跳地址为10.214.10.3。

<VR1> system-view

[VR1] ip route-static 10.1.1.0 24 10.214.10.3

#### 5. 在PE2上配置静态路由实现公私网路由互通

\# 在PE2上指定静态路由，去往10.214.10.0网段的报文，下一跳地址为10.214.10.2，并将此路由与VPN1实例绑定。

<PE2> system-view

[PE2] ip route-static 10.214.10.0 24 vpn-instance vpn1 10.214.10.2

\# 在PE2上指定静态路由，去往10.1.1.0网段的报文，下一跳地址为172.16.30.2，并将此路由与VPN1实例绑定。

[PE2] ip route-static vpn-instance vpn1 10.1.1.0 24 172.16.30.2 public

## 1.5 验证配置

\# 显示PE2上为VPN1实例维护的路由信息。

[PE2] display ip routing-table vpn-instance vpn1

 

Destinations : 7    Routes : 7

 

Destination/Mask  Proto Pre Cost     NextHop     Interface

10.214.10.0/24   Direct 0   0      10.214.10.3   Vlan10

10.214.10.3/32   Direct 0   0      127.0.0.1    InLoop0

127.0.0.0/8     Direct 0   0      127.0.0.1    InLoop0

127.0.0.1/32    Direct 0   0      127.0.0.1    InLoop0

172.16.30.0/24   Direct 0   0      172.16.30.1   Vlan30

172.16.30.1/32   Direct 0   0      127.0.0.1    InLoop0

10.1.1.0/24     Static 60   0      172.16.30.2   Vlan30

可以看到，VPN1的路由表中已经存在指向公网的静态路由。

\# 显示PE2上的路由信息。

[PE1] display ip routing-table

 

Destinations : 14    Routes : 14

 

Destination/Mask  Proto  Pre Cost    NextHop     Interface

0.0.0.0/32     Direct 0  0      127.0.0.1    InLoop0

100.100.11.1/32  Direct 0  0      127.0.0.1    InLoop0

127.0.0.0/8    Direct 0  0      127.0.0.1    InLoop0

127.0.0.0/32    Direct 0  0      127.0.0.1    InLoop0

127.0.0.1/32    Direct 0  0      127.0.0.1    InLoop0

127.255.255.255/32 Direct 0  0      127.0.0.1    InLoop0

172.16.30.0/24   Direct 0  0      172.16.30.2   Vlan30

172.16.30.0/32   Direct 0  0      172.16.30.2   Vlan30

172.16.30.2/32   Direct 0  0      127.0.0.1    InLoop0

172.16.30.255/32  Direct 0  0      172.16.30.2   Vlan30

10.214.10.0/24   Static 60  1      10.214.10.2   Vlan10

224.0.0.0/4    Direct 0  0      0.0.0.0     NULL0

224.0.0.0/24    Direct 0  0      0.0.0.0     NULL0

255.255.255.255/32 Direct 0  0      127.0.0.1    InLoop0

可以看到，指向私网网段的静态路由已经引入到公网路由表中。

\# 使用ping命令验证VR1到Server的网络连通性。

<VR1>ping 10.1.1.2

Ping 10.1.1.2 (10.1.1.2): 56 data bytes, press CTRL+C to break

56 bytes from 10.1.1.2: icmp_seq=0 ttl=255 time=3.880 ms

56 bytes from 10.1.1.2: icmp_seq=1 ttl=255 time=0.819 ms

56 bytes from 10.1.1.2: icmp_seq=2 ttl=255 time=0.658 ms

56 bytes from 10.1.1.2: icmp_seq=3 ttl=255 time=1.421 ms

56 bytes from 10.1.1.2: icmp_seq=4 ttl=255 time=0.722 ms

 

--- Ping statistics for 10.1.1.2 ---

5 packet(s) transmitted, 5 packet(s) received, 0.0% packet loss

round-trip min/avg/max/std-dev = 0.658/1.500/3.880/1.221 ms

## 1.6 配置文件

·   VR1：

\#

 vlan 10

\#

interface Vlan-interface10

 ip address 10.214.10.2 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port link-type trunk

 undo port trunk permit vlan 1

 port trunk permit vlan 10

\#

 ip route-static 10.1.1.0 24 10.214.10.3

\#

·   PE1：

\#

vlan 30

\#

vlan 40

\#

interface Vlan-interface30

 ip address 172.16.30.2 255.255.255.0

\#

interface Vlan-interface40

 ip address 10.1.1.1 255.255.255.0

\#

interface GigabitEthernet1/0/1

 port link-mode bridge

 port link-type trunk

 undo port trunk permit vlan 1

 port trunk permit vlan 40

\#

interface GigabitEthernet1/0/2

 port link-mode bridge

 port link-type trunk

 undo port trunk permit vlan 1

 port trunk permit vlan 30

\#

 ip route-static 10.214.10.0 24 172.16.30.1

\#

·   PE2：

\#

ip vpn-instance vpn1

 route-distinguisher 10:1

 vpn-target 111:1 import-extcommunity

 vpn-target 111:1 export-extcommunity

\#

vlan 10

\#

vlan 30

\#

interface Vlan-interface10

 ip binding vpn-instance vpn1

 ip address 10.214.10.3 255.255.255.0

\#

interface Vlan-interface30

 ip binding vpn-instance vpn1

 ip address 172.16.30.1 255.255.255.0

\#

interface GigabitEthernet1/0/3

 port link-mode bridge

 port link-type trunk

 undo port trunk permit vlan 1

 port trunk permit vlan 30

\#

interface GigabitEthernet1/0/10

 port link-mode bridge

 port link-type trunk

 undo port trunk permit vlan 1

 port trunk permit vlan 10

\#

 ip route-static 10.214.10.0 24 vpn-instance v1 10.214.10.2

 ip route-static vpn-instance v1 10.1.1.0 24 172.16.30.2 public

\#