# Authentication With Keystone 使用 Keystone 进行身份验证

​                                  



Glance may optionally be integrated with Keystone.  Setting this up is relatively straightforward, as the Keystone distribution includes the necessary middleware. Once you have installed Keystone and edited your configuration files, newly created images will have their owner attribute set to the tenant of the authenticated users, and the is_public attribute will cause access to those images for which it is false to be restricted to only the owner, users with admin context, or tenants/users with whom the image has been shared.
Glance 可以选择与 Keystone 集成。设置相对简单，因为 Keystone 发行版包含必要的中间件。安装 Keystone  并编辑配置文件后，新创建的映像的所有者属性将设置为经过身份验证的用户的租户，而 is_public  属性将导致对那些图像的访问限制为仅所有者、具有管理员上下文的用户或与之共享映像的租户/用户。

## Configuring the Glance servers to use Keystone 配置 Glance 服务器以使用 Keystone ¶

Keystone is integrated with Glance through the use of middleware. The default configuration file for the Glance API uses a single piece of middleware called `unauthenticated-context`, which generates a request context containing blank authentication information. In order to configure Glance to use Keystone, the `authtoken` and `context` middlewares must be deployed in place of the `unauthenticated-context` middleware. The `authtoken` middleware performs the authentication token validation and retrieves actual user authentication information. It can be found in the Keystone distribution.
Keystone 通过使用中间件与 Glance 集成。Glance API 的默认配置文件使用一个名为 `unauthenticated-context` 的中间件，该中间件会生成包含空白身份验证信息的请求上下文。为了将 Glance 配置为使用 Keystone，必须部署 `authtoken` 和 `context` 中间件来代替 `unauthenticated-context` 中间件。 `authtoken` 中间件执行身份验证令牌验证并检索实际的用户身份验证信息。它可以在 Keystone 发行版中找到。

## Configuring Glance API to use Keystone 配置 Glance API 以使用 Keystone ¶

Configuring Glance API to use Keystone is relatively straight forward.  The first step is to ensure that declarations for the two pieces of middleware exist in the `glance-api-paste.ini`.  Here is an example for `authtoken`:
配置 Glance API 以使用 Keystone 相对简单。第一步是确保 中存在两个中间件的声明 `glance-api-paste.ini` 。下面是一个示例 `authtoken` ：

```
[filter:authtoken]
paste.filter_factory = keystonemiddleware.auth_token:filter_factory
auth_url = http://localhost:5000
project_domain_id = default
project_name = service_admins
user_domain_id = default
username = glance_admin
password = password1234
```

The actual values for these variables will need to be set depending on your situation.  For more information, please refer to the Keystone [documentation](https://docs.openstack.org/keystonemiddleware/latest/middlewarearchitecture.html#configuration) on the `auth_token` middleware.
这些变量的实际值需要根据您的具体情况进行设置。有关更多信息，请参阅 `auth_token` 有关中间件的 Keystone 文档。

In short: 总之：

- The `auth_url` variable points to the Keystone service. This information is used by the middleware to actually query Keystone about the validity of the authentication tokens.
  该 `auth_url` 变量指向 Keystone 服务。中间件使用此信息实际查询 Keystone 有关身份验证令牌有效性的查询。
- The auth credentials (`project_name`, `project_domain_id`, `user_domain_id`, `username`, and `password`) will be used to retrieve a service token. That token will be used to authorize user tokens behind the scenes.
  身份验证凭据（ `project_name` 、 `project_domain_id` 、 `user_domain_id` 、 `username` 和 `password` ）将用于检索服务令牌。该令牌将用于在后台授权用户令牌。

Finally, to actually enable using Keystone authentication, the application pipeline must be modified.  By default, it looks like:
最后，若要实际启用 Keystone 身份验证，必须修改应用程序管道。默认情况下，它如下所示：

```
[pipeline:glance-api]
pipeline = versionnegotiation unauthenticated-context apiv1app
```

Your particular pipeline may vary depending on other options, such as the image cache. This must be changed by replacing `unauthenticated-context` with `authtoken` and `context`:
您的特定管道可能因其他选项（例如图像缓存）而异。这必须通过替换 `unauthenticated-context` 为 `authtoken` 和 `context` 来更改：

```
[pipeline:glance-api]
pipeline = versionnegotiation authtoken context apiv1app
```

# The Glance Image Cache Glance 图像缓存

​                                  



The Glance API server may be configured to have an optional local image cache. A local image cache stores a copy of image files, essentially enabling multiple API servers to serve the same image file, resulting in an increase in scalability due to an increased number of endpoints serving an image file.
Glance API 服务器可以配置为具有可选的本地图像缓存。本地映像缓存存储映像文件的副本，实质上使多个 API 服务器能够提供相同的映像文件，由于提供映像文件的端点数量增加，因此可伸缩性增加。

This local image cache is transparent to the end user – in other words, the end user doesn’t know that the Glance API is streaming an image file from its local cache or from the actual backend storage system.
此本地映像缓存对最终用户是透明的，换句话说，最终用户不知道 Glance API 正在从其本地缓存或实际后端存储系统中流式传输映像文件。

## Managing the Glance Image Cache 管理 Glance 图像缓存 ¶

While image files are automatically placed in the image cache on successful requests to `GET /images/<IMAGE_ID>`, the image cache is not automatically managed. Here, we describe the basics of how to manage the local image cache on Glance API servers and how to automate this cache management.
虽然图像文件会在成功请求时自动放置在图像缓存中 `GET /images/<IMAGE_ID>` ，但不会自动管理图像缓存。在这里，我们将介绍如何在 Glance API 服务器上管理本地图像缓存以及如何自动执行此缓存管理的基础知识。

## Configuration options for the Image Cache 图像缓存的配置选项 ¶

The Glance cache uses two files: one for configuring the server and another for the utilities. The `glance-api.conf` is for the server and the `glance-cache.conf` is for the utilities.
Glance 缓存使用两个文件：一个用于配置服务器，另一个用于实用程序。用于 `glance-api.conf` 服务器，用于 `glance-cache.conf` 实用程序。

The following options are in both configuration files. These need the same values otherwise the cache will potentially run into problems.
以下选项位于两个配置文件中。它们需要相同的值，否则缓存可能会遇到问题。

- `image_cache_dir` This is the base directory where Glance stores the cache data (Required to be set, as does not have a default).
   `image_cache_dir` 这是 Glance 存储缓存数据的基本目录（需要设置，因为没有默认值）。
- `image_cache_sqlite_db` Path to the sqlite file database that will be used for cache management. This is a relative path from the `image_cache_dir` directory (Default:`cache.db`).
   `image_cache_sqlite_db` 将用于缓存管理的 sqlite 文件数据库的路径。这是 `image_cache_dir` 目录中的相对路径（默认值： `cache.db` ）。
- `image_cache_driver` The driver used for cache management. (Default:`sqlite`)
   `image_cache_driver` 用于缓存管理的驱动程序。（默认值： `sqlite` ）
- `image_cache_max_size` The size when the glance-cache-pruner will remove the oldest images, to reduce the bytes until under this value. (Default:`10 GB`)
   `image_cache_max_size` glance-cache-pruner 将删除最旧的图像时的大小，以减少字节数，直到低于此值。（默认值： `10 GB` ）
- `image_cache_stall_time` The amount of time an incomplete image will stay in the cache, after this the incomplete image will be deleted. (Default:`1 day`)
   `image_cache_stall_time` 不完整的图像将在缓存中保留的时间，在此之后，不完整的图像将被删除。（默认值： `1 day` ）

The following values are the ones that are specific to the `glance-cache.conf` and are only required for the prefetcher to run correctly.
以下值是特定于 的 `glance-cache.conf` 值，并且仅预取器正常运行所必需的值。

- `admin_user` The username for an admin account, this is so it can get the image data into the cache.
   `admin_user` 管理员帐户的用户名，这样它就可以将图像数据放入缓存中。
- `admin_password` The password to the admin account.
   `admin_password` 管理员帐户的密码。
- `admin_tenant_name` The tenant of the admin account.
   `admin_tenant_name` 管理员帐户的租户。
- `auth_url` The URL used to authenticate to keystone. This will be taken from the environment variables if it exists.
   `auth_url` 用于对 keystone 进行身份验证的 URL。如果存在，则从环境变量中获取。
- `filesystem_store_datadir` This is used if using the filesystem store, points to where the data is kept.
   `filesystem_store_datadir` 如果使用文件系统存储，则使用此方法，指向数据的保存位置。
- `filesystem_store_datadirs` This is used to point to multiple filesystem stores.
   `filesystem_store_datadirs` 这用于指向多个文件系统存储。

### Controlling the Growth of the Image Cache 控制图像缓存的增长 ¶

The image cache has a configurable maximum size (the `image_cache_max_size` configuration file option). The `image_cache_max_size` is an upper limit beyond which pruner, if running, starts cleaning the images cache. However, when images are successfully returned from a call to `GET /images/<IMAGE_ID>`, the image cache automatically writes the image file to its cache, regardless of whether the resulting write would make the image cache’s size exceed the value of `image_cache_max_size`. In order to keep the image cache at or below this maximum cache size, you need to run the `glance-cache-pruner` executable.
映像缓存具有可配置的最大大小（ `image_cache_max_size` 配置文件选项）。这是一个 `image_cache_max_size` 上限，如果修剪器正在运行，则超过该上限，将开始清理图像缓存。但是，当从调用 `GET /images/<IMAGE_ID>` 成功返回图像时，图像缓存会自动将图像文件写入其缓存，而不管生成的写入是否会使图像缓存的大小超过 `image_cache_max_size` 的值。为了将映像缓存保持在或低于此最大缓存大小，您需要运行 `glance-cache-pruner` 可执行文件。

The recommended practice is to use `cron` to fire `glance-cache-pruner` at a regular interval.
建议的做法是 `cron` 定期开火 `glance-cache-pruner` 。

### Cleaning the Image Cache 清理图像缓存 ¶

Over time, the image cache can accumulate image files that are either in a stalled or invalid state. Stalled image files are the result of an image cache write failing to complete. Invalid image files are the result of an image file not being written properly to disk.
随着时间推移，图像缓存可能会累积处于停止状态或无效状态的图像文件。停止的图像文件是图像缓存写入失败的结果。无效的映像文件是由于映像文件未正确写入磁盘的结果。

To remove these types of files, you run the `glance-cache-cleaner` executable.
若要删除这些类型的文件，请运行 `glance-cache-cleaner` 可执行文件。

The recommended practice is to use `cron` to fire `glance-cache-cleaner` at a semi-regular interval.
推荐的做法是以 `cron` 半定期的间隔开火 `glance-cache-cleaner` 。

### Controlling Image Cache using V2 API 使用 V2 API 控制图像缓存 ¶

In Yoga, Glance API has added new APIs for managing cache related operations. In Zed, Glance has removed support of `cache_images` periodic job which was used to prefetch all queued images concurrently, logging the results of the fetch for each image. Instead the image can be immediately cached once it is queued for caching. You can use below API calls to control the cache related operations.
在 Yoga 中，Glance API 添加了用于管理缓存相关操作的新 API。在 Zed 中，Glance 删除了对 `cache_images` 周期性作业的支持，该作业用于同时预取所有排队的图像，并记录每个图像的提取结果。相反，一旦图像排队等待缓存，就可以立即缓存图像。您可以使用以下 API 调用来控制与缓存相关的操作。

To queue an image for immediate caching, you can use one of the following methods:
若要将图像排队以供立即缓存，可以使用以下方法之一：

- You can call `PUT /cache/<IMAGE_ID>` to queue the image for immediate caching with identifier `<IMAGE_ID>`
  您可以调用 `PUT /cache/<IMAGE_ID>` 将映像排入队列，以便使用标识符 `<IMAGE_ID>` 立即缓存

- Alternately, you can use the `cache-queue` command of glance client to queue the image for immediate caching.
  或者，您可以使用 glance 客户端 `cache-queue` 的命令将图像排队以立即缓存。

  > $ glance cache-queue <IMAGE_ID>
  > $ glance 缓存队列<IMAGE_ID>

  This will queue the image with identifier `<IMAGE_ID>` for immediate caching.
  这会将带有标识符的图像排队 `<IMAGE_ID>` ，以便立即缓存。

To find out which images are in the image cache use one of the following methods:
若要找出图像缓存中的图像，请使用以下方法之一：

- You can call `GET /cache` to see a JSON-serialized list of mappings that show cached images, the number of cache hits on each image, the size of the image, and the times they were last accessed as well as images which are queued for caching.
  您可以调用 `GET /cache` 以查看 JSON 序列化的映射列表，这些映射显示缓存的图像、每个图像上的缓存命中数、图像的大小、上次访问它们的时间以及排队等待缓存的图像。

- Alternately, you can use the `cache-list` command of glance client. Example usage:
  或者，您可以使用 glance 客户端 `cache-list` 的命令。用法示例：

  ```
  $ glance cache-list
  ```

To delete images which are already cached or queued for caching use one of the following methods:
若要删除已缓存或排队等待缓存的图像，请使用以下方法之一：

- You can call `DELETE /cache/<IMAGE_ID>` to remove the image file for image with identifier `<IMAGE_ID>` from the cache or queued state.
  您可以调用 `DELETE /cache/<IMAGE_ID>` 以 `<IMAGE_ID>` 从缓存或排队状态中删除具有标识符的图像的图像文件。

- Alternately, you can use the `cache-delete` command of glance client. Example usage:
  或者，您可以使用 glance 客户端 `cache-delete` 的命令。用法示例：

  ```
  $ glance cache-delete <IMAGE_ID>
  ```

- You can also call `DELETE /cache` with header `x-image-cache-clear-target` to delete either only cached images or only queued images or both. Possible values for header are `cache`, `queue`, `both`.
  您还可以使用标头调用 `DELETE /cache`  `x-image-cache-clear-target` 以仅删除缓存的图像或仅删除排队的图像，或两者兼而有之。标头的可能值为 `cache` 、 `queue` 、 `both` 。

- Alternately, you can use the `cache-clear` command of glance client to delete only cached images or only queued images or both. Example usage:
  或者，您可以使用 Glance 客户端 `cache-clear` 的命令仅删除缓存的图像或仅删除排队的图像，或同时删除两者。用法示例：

  ```
  $ glance cache-clear (default target is ``both``)
  $ glance cache-clear --target cached
  $ glance cache-clear --target queued
  ```

- In Glance, image cache is local to each node, hence cache operations must be performed on each node locally. If OpenStack cloud is deployed with HA (3/5/7 controllers) then while running the cache related operations it is necessary to specify the HOST address using -H option. Example usage:
  在 Glance 中，图像缓存是每个节点的本地缓存，因此必须在本地对每个节点执行缓存操作。如果OpenStack云是用HA（3/5/7个控制器）部署的，那么在运行缓存相关操作时，需要使用-H选项指定HOST地址。用法示例：

  ```
  $ glance --host=<HOST> cache-list
  ```

### Finding Which Images are in the Image Cache with glance-cache-manage 使用 glance-cache-manage 查找图像缓存中的图像 ¶

You can find out which images are in the image cache using one of the following methods:
您可以使用以下方法之一找出图像缓存中的图像：

- If the `cachemanage` middleware is enabled in the application pipeline, you may call `GET /cached-images` to see a JSON-serialized list of mappings that show cached images, the number of cache hits on each image, the size of the image, and the times they were last accessed.
  如果在应用程序管道中启用了 `cachemanage` 中间件，则可以调用 `GET /cached-images` 以查看显示缓存图像的 JSON 序列化映射列表、每个图像上的缓存命中数、图像大小以及上次访问它们的次数。

- Alternately, you can use the `glance-cache-manage` program. This program may be run from a different host than the host containing the image cache. Example usage:
  或者，您可以使用该 `glance-cache-manage` 程序。此程序可以从与包含映像缓存的主机不同的主机运行。用法示例：

  ```
  $ glance-cache-manage --host=<HOST> list-cached
  ```

- In Glance, image cache is local to each node, hence image cache management must be performed on each node locally. If OpenStack cloud is deployed with HA (3/5/7 controllers) then while running the cache management it is necessary to specify the HOST address using -H option. Example usage:
  在 Glance 中，镜像缓存是每个节点的本地缓存，因此必须在本地对每个节点执行镜像缓存管理。如果OpenStack云是用HA（3/5/7个控制器）部署的，那么在运行缓存管理时，必须使用-H选项指定HOST地址。用法示例：

  ```
  $ glance-cache-manage --host=<HOST> list-cached
  ```

- You can issue the following call on *nix systems (on the host that contains the image cache):
  您可以在 *nix 系统（在包含映像缓存的主机上）发出以下调用：

  ```
  $ ls -lhR $IMAGE_CACHE_DIR
  ```

  where `$IMAGE_CACHE_DIR` is the value of the `image_cache_dir` configuration variable.
  其中 `$IMAGE_CACHE_DIR` 是 `image_cache_dir` 配置变量的值。

  Note that the image’s cache hit is not shown using this method.
  请注意，使用此方法不会显示图像的缓存命中。

### Manually Removing Images from the Image Cache with glance-cache-manage 使用 glance-cache-manage 从图像缓存中手动删除图像 ¶

If the `cachemanage` middleware is enabled, you may call `DELETE /cached-images/<IMAGE_ID>` to remove the image file for image with identifier `<IMAGE_ID>` from the cache.
如果启用了 `cachemanage` 中间件，则可以调用 `DELETE /cached-images/<IMAGE_ID>` 从缓存 `<IMAGE_ID>` 中删除具有标识符的图像的图像文件。

Alternately, you can use the `glance-cache-manage` program. Example usage:
或者，您可以使用该 `glance-cache-manage` 程序。用法示例：

```
$ glance-cache-manage --host=<HOST> delete-cached-image <IMAGE_ID>
```

# Policies 政策

​                                  



 

Warning 警告



JSON formatted policy file is deprecated since Glance 22.0.0 (Wallaby). This [oslopolicy-convert-json-to-yaml](https://docs.openstack.org/oslo.policy/latest/cli/oslopolicy-convert-json-to-yaml.html) tool will migrate your existing JSON-formatted policy file to YAML in a backward-compatible way.
JSON 格式的策略文件自 Glance 22.0.0 （Wallaby） 起已弃用。此 oslopolicy-convert-json-to-yaml 工具将以向后兼容的方式将现有的 JSON 格式策略文件迁移到 YAML。

Glance’s public API calls may be restricted to certain sets of users using a policy configuration file. This document explains exactly how policies are configured and what they apply to.
Glance 的公共 API 调用可能仅限于使用策略配置文件的某些用户集。本文档准确解释了策略的配置方式及其适用范围。

A policy is composed of a set of rules that are used by the policy “Brain” in determining if a particular action may be performed by the authorized tenant.
策略由一组规则组成，策略“Brain”使用这些规则来确定授权租户是否可以执行特定操作。

## Constructing a Policy Configuration File 构建策略配置文件 ¶

A policy configuration file is a simply JSON object that contain sets of rules. Each top-level key is the name of a rule. Each rule is a string that describes an action that may be performed in the Glance API.
策略配置文件是包含规则集的简单 JSON 对象。每个顶级键都是规则的名称。每个规则都是一个字符串，用于描述可在 Glance API 中执行的操作。

The actions that may have a rule enforced on them are:
可能对其强制执行规则的操作包括：

- `get_images` - List available image entities
   `get_images` - 列出可用的图像实体
  - `GET /v1/images`
  - `GET /v1/images/detail`
  - `GET /v2/images`
- `get_image` - Retrieve a specific image entity
   `get_image` - 检索特定的图像实体
  - `HEAD /v1/images/<IMAGE_ID>`
  - `GET /v1/images/<IMAGE_ID>`
  - `GET /v2/images/<IMAGE_ID>`
- `download_image` - Download binary image data
   `download_image` - 下载二进制图像数据
  - `GET /v1/images/<IMAGE_ID>`
  - `GET /v2/images/<IMAGE_ID>/file`
- `upload_image` - Upload binary image data
   `upload_image` - 上传二进制图像数据
  - `POST /v1/images`
  - `PUT /v1/images/<IMAGE_ID>`
  - `PUT /v2/images/<IMAGE_ID>/file`
- `copy_from` - Copy binary image data from URL
   `copy_from` - 从 URL 复制二进制图像数据
  - `POST /v1/images`
  - `PUT /v1/images/<IMAGE_ID>`
- `add_image` - Create an image entity
   `add_image` - 创建图像实体
  - `POST /v1/images`
  - `POST /v2/images`
- `modify_image` - Update an image entity
   `modify_image` - 更新图像实体
  - `PUT /v1/images/<IMAGE_ID>`
  - `PUT /v2/images/<IMAGE_ID>`
- `publicize_image` - Create or update public images
   `publicize_image` - 创建或更新公共镜像
  - `POST /v1/images` with attribute `is_public` = `true`
  - `PUT /v1/images/<IMAGE_ID>` with attribute `is_public` = `true`
  - `POST /v2/images` with attribute `visibility` = `public`
  - `PUT /v2/images/<IMAGE_ID>` with attribute `visibility` = `public`
- `communitize_image` - Create or update community images
   `communitize_image` - 创建或更新社区图像
  - `POST /v2/images` with attribute `visibility` = `community`
  - `PUT /v2/images/<IMAGE_ID>` with attribute `visibility` = `community`
- `delete_image` - Delete an image entity and associated binary data
   `delete_image` - 删除图像实体和关联的二进制数据
  - `DELETE /v1/images/<IMAGE_ID>`
  - `DELETE /v2/images/<IMAGE_ID>`
- `add_member` - Add a membership to the member repo of an image
   `add_member` - 将成员身份添加到映像的成员存储库
  - `POST /v2/images/<IMAGE_ID>/members`
- `get_members` - List the members of an image
   `get_members` - 列出图像的成员
  - `GET /v1/images/<IMAGE_ID>/members`
  - `GET /v2/images/<IMAGE_ID>/members`
- `delete_member` - Delete a membership of an image
   `delete_member` - 删除镜像成员资格
  - `DELETE /v1/images/<IMAGE_ID>/members/<MEMBER_ID>`
  - `DELETE /v2/images/<IMAGE_ID>/members/<MEMBER_ID>`
- `modify_member` - Create or update the membership of an image
   `modify_member` - 创建或更新映像的成员资格
  - `PUT /v1/images/<IMAGE_ID>/members/<MEMBER_ID>`
  - `PUT /v1/images/<IMAGE_ID>/members`
  - `POST /v2/images/<IMAGE_ID>/members`
  - `PUT /v2/images/<IMAGE_ID>/members/<MEMBER_ID>`
- `manage_image_cache` - Allowed to use the image cache management API
   `manage_image_cache` - 允许使用图像缓存管理 API

To limit an action to a particular role or roles, you list the roles like so
若要将操作限制为一个或多个特定角色，请列出如下所示的角色

```
{
  "delete_image": ["role:admin", "role:superuser"]
}
```

The above would add a rule that only allowed users that had roles of either “admin” or “superuser” to delete an image.
上面将添加一条规则，该规则仅允许具有“管理员”或“超级用户”角色的用户删除图像。

## Writing Rules 编写规则 ¶

Role checks are going to continue to work exactly as they already do. If the role defined in the check is one that the user holds, then that will pass, e.g., `role:admin`.
角色检查将继续像现在一样工作。如果检查中定义的角色是用户持有的角色，则该角色将通过，例如 `role:admin` .

To write a generic rule, you need to know that there are three values provided by Glance that can be used in a rule on the left side of the colon (`:`). Those values are the current user’s credentials in the form of:
要编写通用规则，您需要知道 Glance 提供了三个值，这些值可用于冒号左侧的规则 （ `:` ）。这些值是当前用户的凭据，格式如下：

- role 角色
- tenant 房客
- owner 所有者

The left side of the colon can also contain any value that Python can understand, e.g.,:
冒号的左侧也可以包含 Python 可以理解的任何值，例如：

- `True`
- `False`
- `"a string"`
- &c.

Using `tenant` and `owner` will only work with images. Consider the following rule:
使用 `tenant` 和 `owner` 仅适用于图像。请考虑以下规则：

```
tenant:%(owner)s
```

This will use the `tenant` value of the currently authenticated user. It will also use `owner` from the image it is acting upon. If those two values are equivalent the check will pass. All attributes on an image (as well as extra image properties) are available for use on the right side of the colon. The most useful are the following:
这将使用当前经过身份验证的用户的 `tenant` 值。它还将使用 `owner` 它所作用的图像。如果这两个值相等，则检查将通过。图像上的所有属性（以及额外的图像属性）都可以在冒号的右侧使用。最有用的是以下几点：

- `owner`
- `protected`
- `is_public`

Therefore, you could construct a set of rules like the following:
因此，您可以构建一组如下所示的规则：

```
{
    "not_protected": "False:%(protected)s",
    "is_owner": "tenant:%(owner)s",
    "is_owner_or_admin": "rule:is_owner or role:admin",
    "not_protected_and_is_owner": "rule:not_protected and rule:is_owner",

    "get_image": "rule:is_owner_or_admin",
    "delete_image": "rule:not_protected_and_is_owner",
    "add_member": "rule:not_protected_and_is_owner"
}
```

## Examples 示例 ¶

Example 1. (The default policy configuration)
例 1.（默认策略配置）

```
{
    "default": ""
}
```

Note that an empty JSON list means that all methods of the Glance API are callable by anyone.
请注意，空的 JSON 列表意味着任何人都可以调用 Glance API 的所有方法。

Example 2. Disallow modification calls to non-admins
例 2.禁止对非管理员进行修改调用

```
{
    "default": "",
    "add_image": "role:admin",
    "modify_image": "role:admin",
    "delete_image": "role:admin"
}
```

# Property Protections 财产保护

​                                  



There are two types of image properties in Glance:
Glance 中有两种类型的图像属性：

- Core Properties, as specified by the image schema.
  核心属性，由映像架构指定。
- Meta Properties, which are arbitrary key/value pairs that can be added to an image.
  元属性，这是可以添加到图像中的任意键/值对。

Access to meta properties through Glance’s public API calls may be restricted to certain sets of users, using a property protections configuration file. Glance also reserves the `os_glance` namespace of meta properties for its own use, and will refuse to let an API user set any property prefixed as such.
使用属性保护配置文件，通过 Glance 的公共 API 调用对元属性的访问可能仅限于某些用户集。Glance 还保留了元属性的 `os_glance` 命名空间供自己使用，并且将拒绝让 API 用户设置任何以此为前缀的属性。

This document explains exactly how property protections are configured and what they apply to.
本文档准确解释了财产保护的配置方式及其适用范围。

## Constructing a Property Protections Configuration File 构建属性保护配置文件 ¶

A property protections configuration file follows the format of the Glance API configuration file, which consists of sections, led by a `[section]` header and followed by `name = value` entries.  Each section header is a regular expression matching a set of properties to be protected.
属性保护配置文件遵循 Glance API 配置文件的格式，该配置文件由部分组成，由 `[section]` 标头引导，后跟 `name = value` 条目。每个节标题都是一个正则表达式，与一组要保护的属性匹配。



 

Note 注意



Section headers must compile to a valid regular expression, otherwise glance api service will not start. Regular expressions will be handled by python’s re module which is PERL like.
节头必须编译为有效的正则表达式，否则 glance api 服务将无法启动。正则表达式将由 python 的 re 模块处理，类似于 PERL。

Each section describes four key-value pairs, where the key is one of `create/read/update/delete`, and the value is a comma separated list of user roles that are permitted to perform that operation in the Glance API. **If any of the keys are not specified, then the glance api service will not start successfully.**
每个部分都描述了四个键值对，其中键是 之一 `create/read/update/delete` ，值是允许在 Glance API 中执行该操作的用户角色的逗号分隔列表。如果未指定任何键，则 glance api 服务将无法成功启动。

In the list of user roles, `@` means all roles and `!` means no role. **If both @ and ! are specified for the same rule then the glance api service will not start**
在用户角色列表中，“ `@` 表示所有角色”， `!` 表示无角色。如果同时 @ 和 ！为同一规则指定，则 Glance API 服务将不会启动



 

Note 注意



Only one policy rule is allowed per property operation. **If multiple are specified, then the glance api service will not start.**
每个属性操作只允许一个策略规则。如果指定了多个，则 glance api 服务将不会启动。

The path to the file should be specified in the `[DEFAULT]` section of `glance-api.conf` as follows.
应在以下 `[DEFAULT]` 部分中指定文件的路径， `glance-api.conf` 如下所示。

```
property_protection_file=/path/to/file
```

If this config value is not specified, property protections are not enforced. **If the path is invalid, glance api service will not start successfully.**
如果未指定此配置值，则不会强制实施属性保护。如果路径无效，glance api 服务将无法成功启动。

The file may use either roles or policies to describe the property protections. The config value should be specified in the `[DEFAULT]` section of `glance-api.conf` as follows.
该文件可以使用角色或策略来描述属性保护。配置值应在以下 `[DEFAULT]` 部分 `glance-api.conf` 中指定。

```
property_protection_rule_format=<roles|policies>
```

The default value for `property_protection_rule_format` is `roles`.
的 `property_protection_rule_format` 默认值为 `roles` 。

Property protections are applied in the order specified in the configuration file.  This means that if for example you specify a section with `[.*]` at the top of the file, all proceeding sections will be ignored.
属性保护按配置文件中指定的顺序应用。这意味着，例如，如果您在文件顶部指定一个部分 `[.*]` ，则所有正在进行的部分都将被忽略。

If a property does not match any of the given rules, all operations will be disabled for all roles.
如果属性与任何给定规则不匹配，则将禁用所有角色的所有操作。

If an operation is misspelled or omitted, that operation will be disabled for all roles.
如果某个操作拼写错误或省略，则将对所有角色禁用该操作。

Disallowing `read` operations will also disallow `update/delete` operations.
禁止 `read` 操作也将禁止 `update/delete` 操作。

A successful HTTP request will return status `200 OK`. If the user is not permitted to perform the requested action, `403 Forbidden` will be returned.
成功的 HTTP 请求将返回 status `200 OK` 。如果不允许用户执行请求的操作， `403 Forbidden` 则将返回。

# Running Glance in HTTPD 在 HTTPD 中运行 Glance

​                                  

In short Glance will not operate properly if tried to be ran without eventlet and introducing another web server into the mix does not make it any better. This exercise failed without ever having proper interest or resources to fix the underlying issues.
简而言之，如果尝试在没有 eventlet 的情况下运行，Glance 将无法正常运行，并且将另一个 Web 服务器引入其中并不会使其变得更好。这项工作失败了，因为没有适当的兴趣或资源来解决根本问题。

None of the models deploying Glance as bare wsgi app under some httpd are currently advised.
目前不建议将 Glance 部署为某些 httpd 下的裸 wsgi 应用程序的模型。

Since the Pike release Glance has packaged a wsgi script entrypoint that enables you to run it with a real web server like Apache HTTPD or nginx. To deploy this there are several patterns, which all fail different ways. This doc mentions three common ways of trying to deploy Glance with Apache HTTPD.
自 Pike 发布以来，Glance 打包了一个 wsgi 脚本入口点，使您能够使用真正的 Web 服务器（如 Apache HTTPD 或  nginx）运行它。要部署它，有几种模式，它们都以不同的方式失败。本文档提到了尝试使用 Apache HTTPD 部署 Glance  的三种常见方法。



 

Warning 警告



As pointed out in the Pike and Queens release notes (see the “Known Issues” section of each), the Glance project team recommends that Glance be run in its normal standalone configuration, particularly in production environments.  The full functionality of Glance is not available when Glance is deployed in the manner described in this document.  In particular, the interoperable image import functionality does not work under such configuration.  See the release notes for details.
正如 Pike 和 Queens 发行说明中所指出的（请参阅每个版本的“已知问题”部分），Glance 项目团队建议 Glance  在其正常的独立配置下运行，尤其是在生产环境中。当以本文档中描述的方式部署 Glance 时，Glance  的全部功能不可用。特别是，可互操作的图像导入功能在此类配置下不起作用。有关详细信息，请参阅发行说明。

## uWSGI Server HTTP Mode uWSGI服务器HTTP模式¶

This has never worked properly nor it has been of any development focus.
这从未正常工作过，也从未成为任何发展重点。

The clearest we can say is just don’t do it.
我们能说的最清楚的就是不要这样做。



### mod_proxy_uwsgi

This has not been doable since Ussuri as we only support Python 3.
自乌苏里以来，这一直不可行，因为我们只支持 Python 3。

In theory the same applies as mod_wsgi but even without chunked encoding the code is still broken under uwsgi.
从理论上讲，这同样适用于mod_wsgi但即使没有分块编码，代码仍然在 uwsgi 下被破坏。

## mod_wsgi

This deployment method is not recommended for using Glance. The mod_wsgi protocol does not support `Transfer-Encoding: chunked` and therefore makes it unsuitable for use with Glance. However, you could theoretically deploy Glance using mod_wsgi but it will fail on any requests that use a chunked transfer encoding.
不建议将此部署方法用于使用 Glance。mod_wsgi协议不支持 `Transfer-Encoding: chunked` ，因此不适合与 Glance 一起使用。但是，理论上您可以使用 mod_wsgi 部署 Glance，但它在任何使用分块传输编码的请求上都会失败。



## Glossary 术语表 ¶

- uwsgi protocol UWSGI 协议 ¶

  The native protocol used by the uWSGI server. (The acronym is written in all lowercase on purpose.) uWSGI服务器使用的原生协议。（首字母缩略词特意全部用小写字母书写。 https://uwsgi-docs.readthedocs.io/en/latest/Protocol.html

- uWSGI project uWSGI项目 ¶

  A project that aims at developing a full stack for building hosting services.  It produces software, the uWSGI server, that is exposed in Python code as a module named `uwsgi`. 一个旨在开发用于构建托管服务的全栈的项目。它生成软件，即uWSGI服务器，在Python代码中作为一个名为 `uwsgi` . https://uwsgi-docs.readthedocs.io/en/latest/index.html https://pypi.org/project/uWSGI/ https://github.com/unbit/uwsgi

- mod_wsgi

  An Apache 2 HTTP server module that supports the Python WSGI specification. 支持 Python WSGI 规范的 Apache 2 HTTP 服务器模块。 https://modwsgi.readthedocs.io/en/develop/

- mod_proxy_uwsgi

  An Apache 2 HTTP Server module that provides a uwsgi gateway for mod_proxy. It communicates to the uWSGI server using the uwsgi protocol. 一个 Apache 2 HTTP Server 模块，它为 mod_proxy 提供 uwsgi 网关。它使用uwsgi协议与uWSGI服务器通信。 http://httpd.apache.org/docs/trunk/mod/mod_proxy_uwsgi.html

- WSGI WSGI 的 ¶

  Web Server Gateway Interface, a Python standard published as [PEP 3333](https://www.python.org/dev/peps/pep-3333). Web 服务器网关接口，作为 PEP 3333 发布的 Python 标准。 https://wsgi.readthedocs.io/en/latest/index.html

# Notifications 通知

​                                  



Notifications can be generated for several events in the image lifecycle. These can be used for auditing, troubleshooting, etc.
可以为映像生命周期中的多个事件生成通知。这些可用于审核、故障排除等。

## Notification Drivers 通知驱动程序 ¶

- log

  This driver uses the standard Python logging infrastructure with the notifications ending up in file specified by the log_file configuration directive.
  此驱动程序使用标准的 Python 日志记录基础结构，通知以log_file配置指令指定的文件结尾。

- messaging 消息

  This strategy sends notifications to a message queue configured using oslo.messaging configuration options.
  此策略将通知发送到使用 oslo.messaging 配置选项配置的消息队列。

- noop

  This strategy produces no notifications. It is the default strategy.
  此策略不会生成通知。这是默认策略。

## Notification Types 通知类型 ¶

- `image.create`

  Emitted when an image record is created in Glance.  Image record creation is independent of image data upload.
  在 Glance 中创建图像记录时发出。图像记录的创建与图像数据上传无关。

- `image.prepare`

  Emitted when Glance begins uploading image data to its store.
  当 Glance 开始将图像数据上传到其存储时发出。

- `image.upload`

  Emitted when Glance has completed the upload of image data to its store.
  当 Glance 完成将图像数据上传到其存储时发出。

- `image.activate`

  Emitted when an image goes to active status.  This occurs when Glance knows where the image data is located.
  当图像进入活动状态时发出。当 Glance 知道图像数据的位置时，就会发生这种情况。

- `image.send`

  Emitted upon completion of an image being sent to a consumer.
  在完成发送给使用者的图像后发出。

- `image.update`

  Emitted when an image record is updated in Glance.
  在 Glance 中更新图像记录时发出。

- `image.delete`

  Emitted when an image deleted from Glance.
  从 Glance 中删除图像时发出。

- `task.run`

  Emitted when a task is picked up by the executor to be run.
  当执行程序选取要运行的任务时发出。

- `task.processing`

  Emitted when a task is sent over to the executor to begin processing.
  当任务被发送到执行程序开始处理时发出。

- `task.success`

  Emitted when a task is successfully completed.
  成功完成任务时发出。

- `task.failure`

  Emitted when a task fails.
  任务失败时发出。

## Content 内容 ¶

Every message contains a handful of attributes.
每条消息都包含一些属性。

- message_id

  UUID identifying the message.
  标识消息的 UUID。

- publisher_id

  The hostname of the glance instance that generated the message.
  生成消息的 glance 实例的主机名。

- event_type

  Event that generated the message.
  生成消息的事件。

- priority 优先权

  One of WARN, INFO or ERROR.
  WARN、INFO 或 ERROR 之一。

- timestamp 时间戳

  UTC timestamp of when event was generated.
  生成事件时的 UTC 时间戳。

- payload 有效载荷

  Data specific to the event type.
  特定于事件类型的数据。

## Payload 有效载荷 ¶

- image.send 图像.发送

  The payload for INFO, WARN, and ERROR events contain the following:
  INFO、WARN 和 ERROR 事件的有效负载包含以下内容：

  - image_id

    ID of the image (UUID) 映像的 ID （UUID）

  - owner_id

    Tenant or User ID that owns this image (string) 拥有此映像的租户或用户 ID（字符串）

  - receiver_tenant_id

    Tenant ID of the account receiving the image (string) 接收映像的帐户的租户 ID（字符串）

  - receiver_user_id

    User ID of the account receiving the image (string) 接收图像的帐户的用户 ID（字符串）

  - destination_ip

    The receiver’s IP address to which the image was sent (string) 将图像发送到的接收方的 IP 地址（字符串）

  - bytes_sent

    The number of bytes actually sent 实际发送的字节数

- image.create

  For INFO events, it is the image metadata. WARN and ERROR events contain a text message in the payload.
  对于 INFO 事件，它是图像元数据。WARN 和 ERROR 事件在有效负载中包含一条文本消息。

- image.prepare

  For INFO events, it is the image metadata. WARN and ERROR events contain a text message in the payload.
  对于 INFO 事件，它是图像元数据。WARN 和 ERROR 事件在有效负载中包含一条文本消息。

- image.upload 图片.upload

  For INFO events, it is the image metadata. WARN and ERROR events contain a text message in the payload.
  对于 INFO 事件，它是图像元数据。WARN 和 ERROR 事件在有效负载中包含一条文本消息。

- image.activate 图像.activate

  For INFO events, it is the image metadata. WARN and ERROR events contain a text message in the payload.
  对于 INFO 事件，它是图像元数据。WARN 和 ERROR 事件在有效负载中包含一条文本消息。

- image.update 图像.update

  For INFO events, it is the image metadata. WARN and ERROR events contain a text message in the payload.
  对于 INFO 事件，它是图像元数据。WARN 和 ERROR 事件在有效负载中包含一条文本消息。

- image.delete 图像.delete

  For INFO events, it is the image id. WARN and ERROR events contain a text message in the payload.
  对于 INFO 事件，它是图像 ID。 WARN 和 ERROR 事件在有效负载中包含一条文本消息。

- task.run 任务.run

  The payload for INFO, WARN, and ERROR events contain the following:
  INFO、WARN 和 ERROR 事件的有效负载包含以下内容：

  - task_id

    ID of the task (UUID) 任务的 ID （UUID）

  - owner 所有者

    Tenant or User ID that created this task (string) 创建此任务的租户或用户 ID（字符串）

  - task_type

    Type of the task. Example, task_type is “import”. (string) 任务的类型。例如，task_type是“import”。（字符串）

  - status, 地位

    status of the task. Status can be “pending”, “processing”, “success” or “failure”. (string) 任务的状态。状态可以是“挂起”、“正在处理”、“成功”或“失败”。（字符串）

  - task_input

    Input provided by the user when attempting to create a task. (dict) 用户在尝试创建任务时提供的输入。（词典）

  - result 结果

    Resulting output from a successful task. (dict) 成功任务的结果输出。（词典）

  - message 消息

    Message shown in the task if it fails. None if task succeeds. (string) 如果任务失败，则在任务中显示的消息。如果任务成功，则无。（字符串）

  - expires_at

    UTC time at which the task would not be visible to the user. (string) 用户看不到任务的 UTC 时间。（字符串）

  - created_at

    UTC time at which the task was created. (string) 创建任务的 UTC 时间。（字符串）

  - updated_at

    UTC time at which the task was latest updated. (string) 最近更新任务的 UTC 时间。（字符串）

  - The exceptions are:- 例外情况是：-

    For INFO events, it is the task dict with result and message as None. WARN and ERROR events contain a text message in the payload. 对于 INFO 事件，它是结果和消息为 None 的任务字典。WARN 和 ERROR 事件在有效负载中包含一条文本消息。

- task.processing 任务处理

  For INFO events, it is the task dict with result and message as None. WARN and ERROR events contain a text message in the payload.
  对于 INFO 事件，它是结果和消息为 None 的任务字典。WARN 和 ERROR 事件在有效负载中包含一条文本消息。

- task.success 任务成功

  For INFO events, it is the task dict with message as None and result is a dict. WARN and ERROR events contain a text message in the payload.
  对于 INFO 事件，它是任务字典，消息为 None，result 是字典。 WARN 和 ERROR 事件在有效负载中包含一条文本消息。

- task.failure 任务失败

  For INFO events, it is the task dict with result as None and message is text. WARN and ERROR events contain a text message in the payload.
  对于 INFO 事件，它是任务字典，结果为 None，message 为文本。WARN 和 ERROR 事件在有效负载中包含一条文本消息。

# Tasks 任务

​                                  



## Conceptual Overview 概念概述 ¶

Image files can be quite large, and processing images (converting an image from one format to another, for example) can be extremely resource intensive. Additionally, a one-size-fits-all approach to processing images is not desirable.  A public cloud will have quite different security concerns than, for example, a small private cloud run by an academic department in which all users know and trust each other.  Thus a public cloud deployer may wish to run various validation checks on an image that a user wants to bring in to the cloud, whereas the departmental cloud deployer may view such processing as a waste of resources.
图像文件可能非常大，处理图像（例如，将图像从一种格式转换为另一种格式）可能非常耗费资源。此外，一刀切的方法来处理图像是不可取的。例如，公共云与由学术部门运营的小型私有云具有完全不同的安全问题，在学术部门中，所有用户都相互了解和信任。因此，公有云部署人员可能希望对用户想要引入云的映像运行各种验证检查，而部门云部署人员可能认为这种处理是浪费资源。

To address this situation, Glance contains *tasks*.  Tasks are intended to offer end users a front end to long running asynchronous operations – the type of operation you kick off and don’t expect to finish until you’ve gone to the coffee shop, had a pleasant chat with your barista, had a coffee, had a pleasant walk home, etc.  The asynchronous nature of tasks is emphasized up front in order to set end user expectations with respect to how long the task may take (hint: longer than other Glance operations).  Having a set of operations performed by tasks allows a deployer flexibility with respect to how many operations will be processed simultaneously, which in turn allows flexibility with respect to what kind of resources need to be set aside for task processing.  Thus, although large cloud deployers are certainly interested in tasks for the alternative custom image processing workflow they enable, smaller deployers find them useful as a means of controlling resource utilization.
为了解决这种情况，Glance 包含任务。任务旨在为最终用户提供长时间运行的异步操作的前端 -  您启动的操作类型，直到您去咖啡店、与咖啡师愉快地聊天、喝咖啡、愉快地步行回家等。预先强调任务的异步性质，以便设置最终用户对任务可能需要多长时间的期望（提示：比其他 Glance  操作更长）。通过任务执行一组操作，部署人员可以灵活地同时处理多少操作，这反过来又可以灵活地决定需要为任务处理留出什么样的资源。因此，尽管大型云部署人员肯定对他们启用的替代自定义图像处理工作流的任务感兴趣，但小型部署人员发现它们作为控制资源利用率的一种手段很有用。

An additional reason tasks have been introduced into Glance is to support Glance’s role in the OpenStack ecosystem.  Glance provides cataloging, storage, and delivery of virtual machine images.  As such, it needs to be responsive to other OpenStack components.  Nova, for instance, requests images from Glance in order to boot instances; it uploads images to Glance as part of its workflow for the Nova image-create action; and it uses Glance to provide the data for the image-related API calls that are defined in the Compute API that Nova instantiates.  It is necessary to the proper functioning of an OpenStack cloud that these synchronous operations not be compromised by excess load caused by non-essential functionality such as image import.
在 Glance 中引入任务的另一个原因是支持 Glance 在 OpenStack 生态系统中的作用。Glance  提供虚拟机映像的编目、存储和交付。因此，它需要对其他OpenStack组件做出响应。例如，Nova 从 Glance  请求映像以启动实例;它将图像上传到 Glance，作为其 Nova 图像创建操作工作流程的一部分;它使用 Glance 为 Nova  实例化的计算 API 中定义的与图像相关的 API 调用提供数据。为了 OpenStack  云的正常运行，这些同步操作必须不会因非必要功能（如映像导入）导致的过量负载而受到影响。

By separating the tasks resource from the images resource in the Images API, it’s easier for deployers to allocate resources and route requests for tasks separately from the resources required to support Glance’s service role.  At the same time this separation avoids confusion for users of an OpenStack cloud. Responses to requests to `/v2/images` should return fairly quickly, while requests to `/v2/tasks` may take a while.
通过在 Images API 中将任务资源与图像资源分开，部署人员可以更轻松地将任务资源与支持 Glance 服务角色所需的资源分开分配资源和路由请求。同时，这种分离避免了OpenStack云用户的混淆。对请求的响应 `/v2/images` 应该很快返回，而请求 `/v2/tasks` 可能需要一段时间。

In short, tasks provide a common API across OpenStack installations for users of an OpenStack cloud to request image-related operations, yet at the same time tasks are customizable for individual cloud providers.
简而言之，任务为OpenStack云的用户提供了一个跨OpenStack安装的通用API，以请求与映像相关的操作，但同时任务可以针对各个云提供商进行自定义。

## Conceptual Details 概念细节 ¶

A Glance task is a request to perform an asynchronous image-related operation. The request results in the creation of a *task resource* that can be polled for information about the status of the operation.
Glance 任务是执行异步图像相关操作的请求。该请求将导致创建一个任务资源，可以轮询该资源以获取有关操作状态的信息。

A specific type of resource distinct from the traditional Glance image resource is appropriate here for several reasons:
与传统 Glance 图像资源不同的特定类型的资源适合于以下几个原因：

- A dedicated task resource can be developed independently of the traditional Glance image resource, both with respect to structure and workflow.
  在结构和工作流程方面，可以独立于传统的 Glance 图像资源开发专用任务资源。
- There may be multiple tasks (for example, image export or image conversion) operating on an image simultaneously.
  可能同时对图像执行多个任务（例如，图像导出或图像转换）。
- A dedicated task resource allows for the delivery to the end user of clear, detailed error messages specific to the particular operation.
  专用任务资源允许向最终用户提供特定于特定操作的清晰、详细的错误消息。
- A dedicated task resource respects the principle of least surprise.  For example, an import task does not create an image in Glance until it’s clear that the bits submitted pass the deployer’s tests for an allowable image.
  专用任务资源遵循最小意外原则。例如，导入任务不会在 Glance 中创建映像，直到明确提交的位通过部署程序对允许映像的测试。

Upon reaching a final state (`success` or `error`) a task resource is assigned an expiration datetime that’s displayed in the `expires_at` field. (The time between final state and expiration is configurable.)  After that datetime, the task resource is subject to being deleted.  The result of the task (for example, an imported image) will still exist.
在达到最终状态 （ `success` 或 `error` ） 时，将为任务资源分配一个字段中 `expires_at` 显示的到期日期时间。（最终状态和到期之间的时间是可配置的。在此日期时间之后，任务资源可能会被删除。任务的结果（例如，导入的图像）仍将存在。

For details about the defined task statuses, please see [Task Statuses](https://docs.openstack.org/glance/2023.2/user/statuses.html#task-statuses).
有关已定义任务状态的详细信息，请参阅任务状态。

Tasks expire eventually because there’s no reason to keep them around, as the user will have the result of the task, which was the point of creating the task in the first place.  The reason tasks aren’t instantly deleted is that there may be information contained in the task resource that’s not easily available elsewhere.  (For example, a successful import task will eventually result in the creation of an image in Glance, and it would be useful to know the UUID of this image.  Similarly, if the import task fails, we want to give the end user time to read the task resource to analyze the error message.)
任务最终会过期，因为没有理由保留它们，因为用户将获得任务的结果，这是创建任务的首要点。任务不会立即删除的原因是，任务资源中可能包含一些在其他地方不容易获得的信息。（例如，成功的导入任务最终将导致在 Glance 中创建图像，了解此图像的 UUID 会很有用。同样，如果导入任务失败，我们希望给最终用户时间来读取任务资源以分析错误消息。

## Task Entities 任务实体 ¶

A task entity is represented by a JSON-encoded data structure defined by the JSON schema available at `/v2/schemas/task`.
任务实体由JSON编码的数据结构表示，该数据结构由JSON 架构定义，可在 中 `/v2/schemas/task` 获取。

A task entity has an identifier (`id`) that is guaranteed to be unique within the endpoint to which it belongs. The id is used as a token in request URIs to interact with that specific task.
任务实体具有一个标识符 （ `id` ），该标识符保证在其所属的终结点中是唯一的。该 id 用作请求 URI 中的令牌，以与该特定任务进行交互。

In addition to the usual properties you’d expect (for example, `created_at`, `self`, `type`, `status`, `updated_at`, etc.), tasks have these properties of interest:
除了您期望的常用属性（例如， `created_at` 、、 `self` 、 `type` 、 `status` 、等 `updated_at` ）之外，任务还具有以下感兴趣的属性：

- `input`: this is defined to be a JSON blob, the exact content of which will depend upon the requirements set by the specific cloud deployer.  The intent is that each deployer will document these requirements for end users.
   `input` ：这被定义为 JSON blob，其确切内容将取决于特定云部署程序设置的要求。其目的是让每个部署人员为最终用户记录这些要求。
- `result`: this is also defined to be a JSON blob, the content of which will be documented by each cloud deployer.  The `result` element will be null until the task has reached a final state, and if the final status is `failure`, the result element remains null.
   `result` ：这也被定义为一个 JSON Blob，其内容将由每个云部署者记录。在任务达到最终状态之前，该 `result` 元素将为 null，如果最终状态为 `failure` ，则结果元素将保持为 null。
- `message`: this string field is expected to be null unless the task has entered `failure` status.  At that point, it contains an informative human-readable message concerning the reason(s) for the task failure.
   `message` ：除非任务已进入 `failure` 状态，否则此字符串字段应为 null。此时，它包含有关任务失败原因的信息性人类可读消息。

# Controlling Glance Servers 控制 Glance 服务器

​                                  



This section describes the ways to start, stop, and reload Glance’s server programs.
本节介绍启动、停止和重新加载 Glance 服务器程序的方法。

## Starting a server 启动服务器 ¶

There are two ways to start a Glance server:
有两种方法可以启动 Glance 服务器：

- Manually calling the server program
  手动调用服务器程序
- Using the `glance-control` server daemon wrapper program
  使用服务器守护程序包装 `glance-control` 程序

We recommend using the second method.
我们建议使用第二种方法。

### Manually starting the server 手动启动服务器 ¶

The first is by directly calling the server program, passing in command-line options and a single argument for a `paste.deploy` configuration file to use when configuring the server application.
第一种方法是直接调用服务器程序，传入命令行选项和配置文件的单个参数，以便在 `paste.deploy` 配置服务器应用程序时使用。



 

Note 注意



Glance ships with an `etc/` directory that contains sample `paste.deploy` configuration files that you can copy to a standard configuration directory and adapt for your own uses. Specifically, bind_host must be set properly.
Glance 附带了一个 `etc/` 目录，其中包含示例 `paste.deploy` 配置文件，您可以将这些文件复制到标准配置目录并根据自己的用途进行调整。具体来说，bind_host必须正确设置。

If you do not specify a configuration file on the command line, Glance will do its best to locate a configuration file in one of the following directories, stopping at the first config file it finds:
如果未在命令行上指定配置文件，Glance 将尽最大努力在以下目录之一中找到配置文件，并在找到的第一个配置文件处停止：

- `$CWD`
- `~/.glance`
- `~/`
- `/etc/glance`
- `/etc`

The filename that is searched for depends on the server application name. So, if you are starting up the API server, `glance-api.conf` is searched for.
搜索的文件名取决于服务器应用程序名称。因此，如果您正在启动 API 服务器， `glance-api.conf` 则会搜索。

If no configuration file is found, you will see an error, like:
如果未找到配置文件，您将看到一个错误，例如：

```
$ glance-api
ERROR: Unable to locate any configuration file. Cannot load application glance-api
```

Here is an example showing how you can manually start the `glance-api` server in a shell.:
下面是一个示例，演示如何在 shell 中手动启动 `glance-api` 服务器：

```
$ sudo glance-api --config-file glance-api.conf --debug &
jsuh@mc-ats1:~$ 2011-04-13 14:50:12    DEBUG [glance-api] ********************************************************************************
2011-04-13 14:50:12    DEBUG [glance-api] Configuration options gathered from config file:
2011-04-13 14:50:12    DEBUG [glance-api] /home/jsuh/glance-api.conf
2011-04-13 14:50:12    DEBUG [glance-api] ================================================
2011-04-13 14:50:12    DEBUG [glance-api] bind_host                      65.114.169.29
2011-04-13 14:50:12    DEBUG [glance-api] bind_port                      9292
2011-04-13 14:50:12    DEBUG [glance-api] debug                          True
2011-04-13 14:50:12    DEBUG [glance-api] default_store                  file
2011-04-13 14:50:12    DEBUG [glance-api] filesystem_store_datadir       /home/jsuh/images/
2011-04-13 14:50:12    DEBUG [glance-api] ********************************************************************************
2011-04-13 14:50:12    DEBUG [routes.middleware] Initialized with method overriding = True, and path info altering = True
2011-04-13 14:50:12    DEBUG [eventlet.wsgi.server] (21354) wsgi starting up on http://65.114.169.29:9292/

$ ps aux | grep glance
root     20009  0.7  0.1  12744  9148 pts/1    S    12:47   0:00 /usr/bin/python /usr/bin/glance-api glance-api.conf --debug
jsuh     20017  0.0  0.0   3368   744 pts/1    S+   12:47   0:00 grep glance
```

Simply supply the configuration file as the parameter to the `--config-file` option (the `etc/glance-api.conf`  sample configuration file was used in the above example) and then any other options you want to use. (`--debug` was used above to show some of the debugging output that the server shows when starting up. Call the server program with `--help` to see all available options you can specify on the command line.)
只需提供配置文件作为 `--config-file` 选项的参数（上面的示例中使用了 `etc/glance-api.conf` 示例配置文件），然后提供要使用的任何其他选项。（ `--debug` 在上面用于显示服务器在启动时显示的一些调试输出。调用服务器程序 `--help` 以查看可在命令行上指定的所有可用选项。

For more information on configuring the server via the `paste.deploy` configuration files, see the section entitled [Configuring Glance servers](https://docs.openstack.org/glance/2023.2/configuration/index.html#configuring)
有关通过 `paste.deploy` 配置文件配置服务器的详细信息，请参阅标题为“配置 Glance 服务器”的部分

Note that the server daemonizes itself by using the standard shell backgrounding indicator, `&`, in the previous example. For most use cases, we recommend using the `glance-control` server daemon wrapper for daemonizing. See below for more details on daemonization with `glance-control`.
请注意，在上一示例中，服务器守护程序通过使用标准 shell 背景指示符 `&` 来化自身。对于大多数用例，我们建议使用 `glance-control` 服务器守护程序包装器进行守护进程化。有关使用 `glance-control` .

### Using the `glance-control` program to start the server 使用 `glance-control` 程序启动服务器 ¶

The second way to start up a Glance server is to use the `glance-control` program. `glance-control` is a wrapper script that allows the user to start, stop, restart, and reload the other Glance server programs in a fashion that is more conducive to automation and scripting.
启动 Glance 服务器的第二种方法是使用该 `glance-control` 程序。 `glance-control` 是一个包装脚本，允许用户以更有利于自动化和脚本化的方式启动、停止、重新启动和重新加载其他 Glance 服务器程序。

Servers started via the `glance-control` program are always daemonized, meaning that the server program process runs in the background.
通过 `glance-control` 程序启动的服务器始终是守护进程，这意味着服务器程序进程在后台运行。

To start a Glance server with `glance-control`, simply call `glance-control` with a server and the word “start”, followed by any command-line options you wish to provide. Start the server with `glance-control` in the following way:
要使用 `glance-control` 启动 Glance 服务器，只需使用服务器和单词“start”进行调用 `glance-control` ，后跟您希望提供的任何命令行选项。按 `glance-control` 以下方式启动服务器：

```
$ sudo glance-control [OPTIONS] <SERVER> start [CONFPATH]
```



 

Note 注意



You must use the `sudo` program to run `glance-control` currently, as the pid files for the server programs are written to /var/run/glance/
您必须使用该 `sudo` 程序才能当前运行 `glance-control` ，因为服务器程序的 pid 文件将写入 /var/run/glance/

Here is an example that shows how to start the `glance-api` server with the `glance-control` wrapper script.
下面是一个示例，演示如何使用 `glance-control` 包装脚本启动 `glance-api` 服务器。

```
$ sudo glance-control api start glance-api.conf
Starting glance-api with /home/jsuh/glance.conf

$ ps aux | grep glance
root     20038  4.0  0.1  12728  9116 ?        Ss   12:51   0:00 /usr/bin/python /usr/bin/glance-api /home/jsuh/glance-api.conf
jsuh     20042  0.0  0.0   3368   744 pts/1    S+   12:51   0:00 grep glance
```

The same configuration files are used by `glance-control` to start the Glance server programs, and you can specify (as the example above shows) a configuration file when starting the server.
使用相同的配置文件 `glance-control` 来启动 Glance 服务器程序，您可以在启动服务器时指定（如上例所示）配置文件。

In order for your launched glance service to be monitored for unexpected death and respawned if necessary, use the following option:
为了监视已启动的 glance 服务是否意外死亡并在必要时重生，请使用以下选项：

```
$ sudo glance-control [service] start --respawn ...
```

Note that this will cause `glance-control` itself to remain running. Also note that deliberately stopped services are not respawned, neither are rapidly bouncing services (where process death occurred within one second of the last launch).
请注意，这将导致 `glance-control` 自身保持运行状态。另请注意，故意停止的服务不会重生，快速反弹的服务也不会重生（进程在上次启动后一秒内死亡）。

By default, output from glance services is discarded when launched with `glance-control`. In order to capture such output via syslog, use the following option:
默认情况下，使用 `glance-control` 启动时，将丢弃 glance 服务的输出。要通过 syslog 捕获此类输出，请使用以下选项：

```
$ sudo glance-control --capture-output ...
```

## Stopping a server 停止服务器 ¶

If you started a Glance server manually and did not use the `&` backgrounding function, simply send a terminate signal to the server process by typing `Ctrl-C`
如果您手动启动了 Glance 服务器并且没有使用 `&` 后台功能，只需键入 `Ctrl-C` 

If you started the Glance server using the `glance-control` program, you can use the `glance-control` program to stop it. Simply do the following:
如果使用该 `glance-control` 程序启动了 Glance 服务器，则可以使用该 `glance-control` 程序将其停止。只需执行以下操作：

```
$ sudo glance-control <SERVER> stop
```

as this example shows:
如本示例所示：

```
$ sudo glance-control api stop
Stopping glance-api  pid: 17602  signal: 15
```

## Restarting a server 重启服务器 ¶

You can restart a server with the `glance-control` program, as demonstrated here:
您可以使用该 `glance-control` 程序重新启动服务器，如下所示：

```
$ sudo glance-control api restart etc/glance-api.conf
Stopping glance-api  pid: 17611  signal: 15
Starting glance-api with /home/jpipes/repos/glance/trunk/etc/glance-api.conf
```

## Reloading a server 重新加载服务器 ¶

You can reload a server with the `glance-control` program, as demonstrated here:
您可以使用该 `glance-control` 程序重新加载服务器，如下所示：

```
$ sudo glance-control api reload
Reloading glance-api (pid 18506) with signal(1)
```

A reload sends a SIGHUP signal to the master process and causes new configuration settings to be picked up without any interruption to the running service (provided neither bind_host or bind_port has changed).
重新加载会向主进程发送 SIGHUP 信号，并导致在不中断正在运行的服务的情况下选取新的配置设置（前提是bind_host或bind_port均未更改）。

# Glance Flow Plugins Glance Flow 插件

​                                  

## Flows 流程 ¶

### api_image_import

Return task flow 返回任务流

- param task_id: 参数 task_id：

  Task ID 任务 ID

- param task_type: 参数 task_type：

  Type of the task 任务类型

- param task_repo: 参数task_repo：

  Task repo 任务存储库

- param image_repo: 参数image_repo：

  Image repository used 使用的映像存储库

- param image_id: 参数image_id：

  ID of the Image to be processed 要处理的图像的 ID

- param uri: 参数 URI：

  uri for the image file 图像文件的 URI

### import 导入 ¶

Return task flow 返回任务流

- param task_id: 参数 task_id：

  Task ID 任务 ID

- param task_type: 参数 task_type：

  Type of the task 任务类型

- param task_repo: 参数task_repo：

  Task repo 任务存储库

- param image_repo: 参数image_repo：

  Image repository used 使用的映像存储库

- param image_factory: 参数image_factory：

  Glance Image Factory Glance 图像工厂

- param uri: 参数 URI：

  uri for the image file 图像文件的 URI

## Import Flows 导入流程 ¶

### convert 转换 ¶

Return task flow for converting images to different formats.
返回将图片转换为不同格式的任务流。

- param task_id: 参数 task_id：

  Task ID. 任务 ID。

- param task_type: 参数 task_type：

  Type of the task. 任务的类型。

- param image_repo: 参数image_repo：

  Image repository used. 使用的映像存储库。

### introspect 内省 ¶

Return task flow for introspecting images to obtain metadata about the image.
返回用于自检图像的任务流，以获取有关图像的元数据。

- param task_id: 参数 task_id：

  Task ID 任务 ID

- param task_type: 参数 task_type：

  Type of the task. 任务的类型。

- param image_repo: 参数image_repo：

  Image repository used. 使用的映像存储库。

### ovf_process

Returns task flow for OVF Process.
返回 OVF 进程的任务流。

- param task_id: 参数 task_id：

  Task ID 任务 ID

- param task_type: 参数 task_type：

  Type of the task. 任务的类型。

- param image_repo: 参数image_repo：

  Image repository used. 使用的映像存储库。

# Interoperable Image Import 可互操作的图像导入

​                                  



Version 2.6 of the Image Service API introduces new API calls that implement an interoperable image import process.  These API calls, and the workflow for using them, are described in the [Interoperable Image Import](https://docs.openstack.org/api-ref/image/v2/index.html#interoperable-image-import) section of the [Image Service API reference](https://docs.openstack.org/api-ref/image/).  That documentation explains the end user’s view of interoperable image import.  In this section, we discuss what configuration options are available to operators.
Image Service API 版本 2.6 引入了新的 API 调用，用于实现可互操作的图像导入过程。这些 API  调用以及使用它们的工作流在影像服务 API  参考的可互操作图像导入部分中进行了介绍。该文档解释了最终用户对可互操作映像导入的看法。在本节中，我们将讨论操作员可以使用哪些配置选项。

The interoperable image import process uses Glance tasks, but does *not* require that the Tasks API be exposed to end users.  Further, it requires the **taskflow** task executor.  The following configuration options must be set:
可互操作的图像导入过程使用 Glance 任务，但不要求向最终用户公开任务 API。此外，它需要任务流任务执行器。必须设置以下配置选项：

- in the `[task]` option group:
  在选项组中 `[task]` ：

  - `task_executor` must either be set to **taskflow** or be used in its default value
     `task_executor` 必须设置为 taskflow 或在其默认值中使用

- in the `[taskflow_executor]` options group:
  在“ `[taskflow_executor]` 选项”组中：

  - The default values are fine.  It’s a good idea to read through the descriptions in the sample **glance-api.conf** file to see what options are available.
    默认值很好。最好通读示例 glance-api.conf 文件中的描述，看看有哪些选项可用。

    

     

    Note 注意

    

    You can find an example [glance-api.conf](https://opendev.org/openstack/glance/src/branch/master/etc/glance-api.conf) file in the **etc/** subdirectory of the Glance source code tree.  Make sure that you are looking in the correct branch for the OpenStack release you are working with.
    您可以在 Glance 源代码树的 etc/ 子目录中找到示例 glance-api.conf 文件。确保您正在查找您正在使用的 OpenStack 版本的正确分支。

- in the default options group:
  在“默认选项”组中：

  - `node_staging_uri` as a `file:///path/to/dir` URI (in the single-store case) or `[os_glance_staging_store]/filesystem_store_datadir` as a path (in the multi-store case) must specify a location writable by the glance user. See [Staging Directory Configuration](https://docs.openstack.org/glance/2023.2/admin/interoperable-image-import.html#staging-directory-configuration) for more details and recommendations.
     `node_staging_uri` `file:///path/to/dir` 作为 URI（在单存储情况下）或 `[os_glance_staging_store]/filesystem_store_datadir` 作为路径（在多存储情况下）必须指定可由 Glance 用户写入的位置。有关更多详细信息和建议，请参阅暂存目录配置。
  - `enabled_import_methods` must specify the import methods you are exposing at your installation.  The default value for this setting is `['glance-direct','web-download']`.  See the next section for a description of these import methods.
     `enabled_import_methods` 必须指定在安装时公开的导入方法。此设置的默认值为 `['glance-direct','web-download']` 。有关这些导入方法的说明，请参阅下一节。

Additionally, your policies must be such that an ordinary end user can manipulate tasks.  In releases prior to Pike, we recommended that the task-related policies be admin-only so that end users could not access the Tasks API.  In Pike, a new policy was introduced that controls access to the Tasks API.  Thus it is now possible to keep the individual task policies unrestricted while not exposing the Tasks API to end users.  Thus, the following is the recommended configuration for the task-related policies:
此外，您的策略必须使普通最终用户可以操作任务。在 Pike 之前的版本中，我们建议与任务相关的策略仅供管理员使用，以便最终用户无法访问任务 API。在 Pike  中，引入了一个新策略来控制对任务 API 的访问。因此，现在可以保持单个任务策略不受限制，同时不向最终用户公开任务  API。因此，以下是与任务相关的策略的建议配置：

```
"get_task": "",
"get_tasks": "",
"add_task": "",
"modify_task": "",
"tasks_api_access": "role:admin",
```

## Image Import Methods 图片导入方式 ¶

Glance provides four import methods that you can make available to your users: `glance-direct`, `web-download`, `glance-download`, and `copy-image`. By default, `glance-download` is not enabled.
Glance 提供了四种可供用户使用的导入方法： `glance-direct` 、、 `web-download` `glance-download` 和 `copy-image` 。默认情况下， `glance-download` 未启用。

- The `glance-direct` import method allows your users to upload image data directly to Glance.
   `glance-direct` 导入方法允许您的用户将图像数据直接上传到 Glance。

- The `web-download` method allows an end user to import an image from a remote URL.  The image data is retrieved from the URL and stored in the Glance backend.  (In other words, this is a *copy-from* operation.)
  该 `web-download` 方法允许最终用户从远程 URL 导入图像。图像数据从 URL 中检索并存储在 Glance 后端。（换言之，这是一个复制自操作。

  

   

  Note 注意

  

  The `web-download` import method replaces the copy-from functionality that was available in the Image API v1 but previously absent from v2. Additionally, the Image API v1 was removed in Glance 17.0.0 (Rocky).
  导入 `web-download` 方法替换了映像 API v1 中可用但以前在 v2 中没有的复制自功能。此外，Image API v1 已在 Glance 17.0.0 （Rocky） 中删除。

- The `glance-download` method allows an end user to import an image from a remote glance. This import method is used to import an image from another openstack region which is federated by the same keystone.
  该 `glance-download` 方法允许最终用户从远程浏览中导入图像。此导入方法用于从另一个由同一梯形图联合的 openstack 区域导入映像。

- The `copy-image` method allows and end user to copy existing image to other Glance backends available in deployment. This import method is only used if multiple glance backends are enabled in your deployment.
  该 `copy-image` 方法允许最终用户将现有映像复制到部署中可用的其他 Glance 后端。仅当在部署中启用了多个浏览后端时，才使用此导入方法。

You control which methods are available to API users by the `enabled_import_methods` configuration option in the default section of the **glance-api.conf** file.
您可以通过 glance-api.conf 文件的默认部分中的 `enabled_import_methods` 配置选项来控制 API 用户可以使用的方法。

### Staging Directory Configuration 暂存目录配置 ¶

All of the import methods require a staging directory to be configured. This is essentially a temporary scratch location where the image can be staged (by the user via `glance-direct`), downloaded (by `web-download`), or pulled from an existing store (as in `copy-image`) before being copied to a given store location. In the single-store case, this location is specified by a local filesystem URI in the `node_staging_uri` configuration option, like this:
所有导入方法都需要配置暂存目录。这本质上是一个临时的暂存位置，在将图像复制到给定的商店位置之前，可以暂存（由用户通过 `glance-direct` ）、下载（由 `web-download` ）或从现有商店（如 ） `copy-image` 中提取图像。在单存储情况下，此位置由 `node_staging_uri` 配置选项中的本地文件系统 URI 指定，如下所示：

```
[DEFAULTS]
node_staging_uri = file:///var/lib/glance/staging
```

In the multistore case, as described in [Reserved Stores](https://docs.openstack.org/glance/2023.2/admin/multistores.html#reserved-stores), the staging store should be configured with the path:
在多存储情况下，如预留存储中所述，应使用以下路径配置暂存存储：

```
[os_glance_staging_store]
filesystem_store_datadir = /var/lib/glance/staging
```

The staging directory for each worker must be configured for all import methods, and can be either local (recommended) or shared. In the case of a shared location, all Glance API workers will be dependent on the shared storage availability, will compete for IO resources, and may introduce additional network traffic. If local storage is chosen, you must configure each worker with the URL by which the other workers can reach it directly. This allows one worker behind a load balancer to stage an image in one request, and another worker to handle the subsequent import request. As an example:
必须为所有导入方法配置每个辅助角色的暂存目录，并且可以是本地（推荐）或共享。在共享位置的情况下，所有 Glance API 工作线程都将依赖于共享存储的可用性，将争夺 IO  资源，并可能引入额外的网络流量。如果选择本地存储，则必须为每个工作线程配置其他工作线程可以直接访问的  URL。这允许负载均衡器后面的一个工作线程在一个请求中暂存映像，而另一个工作线程处理后续的导入请求。举个例子：

```
[DEFAULTS]
worker_self_reference_url = https://glance01.example.com:8000
```

This assumes you have several glance-api workers named `glance01`, `glance02`, etc behind your load balancer.
这假设您的负载均衡器后面有多个名为 `glance01` 、 `glance02` 等的 glance-api 工作线程。

Note that `public_endpoint` will be used as the default if `worker_self_reference_url` is not set. As this will generally be set to the same value across all workers, the result is that all workers will assume the same identity and thus revert to shared-staging behavior. If `public_endpoint` is set differently for one or a group of workers, they will be considered isolated and thus not sharing staging storage.
请注意，如果 `worker_self_reference_url` 未设置， `public_endpoint` 则将用作默认值。由于这通常在所有工作线程中设置为相同的值，因此结果是所有工作线程都将采用相同的标识，从而还原为共享暂存行为。如果 `public_endpoint` 为一个或一组辅助角色设置不同，则这些辅助角色将被视为隔离的，因此不会共享暂存存储。

### Configuring the glance-direct method 配置 glance-direct 方法 ¶

For the `glance-direct` method, make sure that `glance-direct` is included in the list specified by your `enabled_import_methods` setting, and that staging directory config options are set properly.
对于该 `glance-direct` 方法，请确保该 `glance-direct` 方法包含在设置 `enabled_import_methods` 指定的列表中，并且正确设置了暂存目录配置选项。

Note that in order to use `glance-direct`, the `worker_self_reference_url` configuration option must be set as above, or all Glance API workers must have their staging directory mounted to a common location (such as an NFS server).
请注意，为了使用 `glance-direct` ， `worker_self_reference_url` 必须按上述方式设置配置选项，否则所有 Glance API 工作线程都必须将其暂存目录挂载到公共位置（例如 NFS 服务器）。

### Configuring the web-download method 配置 web-download 方法 ¶

To enable the `web-download` import method, make sure that it is included in the list of methods in the `enabled_import_methods` option, and that staging directory config options are set properly.
若要启用 `web-download` 导入方法，请确保它包含在 `enabled_import_methods` 选项的方法列表中，并且正确设置了暂存目录配置选项。

Additionally, you have the following configuration available.
此外，您还具有以下可用的配置。

Depending on the nature of your cloud and the sophistication of your users, you may wish to restrict what URIs they may use for the web-download import method.
根据云的性质和用户的复杂程度，您可能希望限制他们可能用于 Web 下载导入方法的 URI。



 

Note 注意



You should be aware of [OSSN-0078](https://wiki.openstack.org/wiki/OSSN/OSSN-0078), “copy_from in Image Service API v1 allows network port scan”.  The v1 copy_from feature does not have the configurability described here.
您应该知道OSSN-0078“Image Service API v1中的copy_from允许网络端口扫描”。v1 copy_from功能不具有此处所述的可配置性。

You can do this by configuring options in the `[import_filtering_opts]` section of the **glance-image-import.conf** file.
您可以通过在 glance-image-import.conf 文件 `[import_filtering_opts]` 的部分中配置选项来执行此操作。



 

Note 注意



The **glance-image-import.conf** is an optional file.  (See below for a discussion of the default settings if you don’t include this file.)
glance-image-import.conf 是一个可选文件。（请参阅下文，了解默认设置（如果您不包含此文件）。

You can find an example file named [glance-image-import.conf.sample](https://opendev.org/openstack/glance/src/branch/master/etc/glance-image-import.conf.sample) in the **etc/** subdirectory of the Glance source code tree.  Make sure that you are looking in the correct branch for the OpenStack release you are working with.
您可以在 Glance 源代码树的 etc/ 子目录中找到名为 glance-image-import.conf.sample 的示例文件。确保您正在查找您正在使用的 OpenStack 版本的正确分支。

You can whitelist (“allow *only* these”) or blacklist (“do *not* allow these”) at three levels:
您可以在三个级别上列入白名单（“仅允许这些”）或黑名单（“不允许这些”）：

- scheme (`allowed_schemes`, `disallowed_schemes`)
  方案 （ `allowed_schemes` ， `disallowed_schemes` ）
- host (`allowed_hosts`, `disallowed_hosts`)
  主机 （ `allowed_hosts` ， `disallowed_hosts` ）
- port (`allowed_ports`, `disallowed_ports`)
  端口 （ `allowed_ports` ， `disallowed_ports` ）

There are six configuration options, but the way it works is that if you specify both at any level, the whitelist is honored and the blacklist is ignored.  (So why have both? Well, you may want to whitelist a scheme, but blacklist a host, and whitelist a particular port.)
有六个配置选项，但其工作方式是，如果您在任何级别都指定了这两个选项，则允许白名单并忽略黑名单。（那么为什么两者都有呢？好吧，您可能希望将方案列入白名单，但将主机列入黑名单，并将特定端口列入白名单。

Validation of a URI happens as follows:
URI 的验证按如下方式进行：

1. The scheme is checked.
   该方案已选中。
   1. missing scheme: reject 缺少方案：拒绝
   2. If there’s a whitelist, and the scheme is not in it: reject.  Otherwise, skip c and continue on to 2.
      如果有白名单，而方案不在其中：拒绝。否则，跳过 c 并继续执行 2。
   3. If there’s a blacklist, and the scheme is in it: reject.
      如果有一个黑名单，并且方案在其中：拒绝。
2. The hostname is checked.
   已检查主机名。
   1. missing hostname: reject 缺少主机名：拒绝
   2. If there’s a whitelist, and the host is not in it: reject.  Otherwise, skip c and continue on to 3.
      如果存在白名单，而主机不在白名单中：拒绝。否则，跳过 c 并继续执行 3。
   3. If there’s a blacklist, and the host is in it: reject.
      如果存在黑名单，并且主机在其中：拒绝。
3. If there’s a port in the URI, the port is checked.
   如果 URI 中有一个端口，则检查该端口。
   1. If there’s a whitelist, and the port is not in it: reject.  Otherwise, skip b and continue on to 4.
      如果有白名单，但端口不在其中：拒绝。否则，请跳过 b 并继续执行 4。
   2. If there’s a blacklist, and the port is in it: reject.
      如果有黑名单，并且端口在其中：拒绝。
4. The URI is accepted as valid.
   URI 被接受为有效。

Note that if you allow a scheme, either by whitelisting it or by not blacklisting it, any URI that uses the default port for that scheme by not including a port in the URI is allowed.  If it does include a port in the URI, the URI will be validated according to the above rules.
请注意，如果允许某个方案，无论是将其列入白名单还是不将其列入黑名单，则允许使用该方案的默认端口（不在 URI 中包含端口）的任何 URI。如果 URI 中确实包含端口，则将根据上述规则验证 URI。

#### Default settings 默认设置 ¶

The **glance-image-import.conf** is an optional file.  Here are the default settings for these options:
glance-image-import.conf 是一个可选文件。以下是这些选项的默认设置：

- `allowed_schemes` - `['http', 'https']`
- `disallowed_schemes` - empty list `disallowed_schemes` - 空列表
- `allowed_hosts` - empty list `allowed_hosts` - 空列表
- `disallowed_hosts` - empty list `disallowed_hosts` - 空列表
- `allowed_ports` - `[80, 443]`
- `disallowed_ports` - empty list `disallowed_ports` - 空列表

Thus if you use the defaults, end users will only be able to access URIs using the http or https scheme.  The only ports users will be able to specify are 80 and 443.  (Users do not have to specify a port, but if they do, it must be either 80 or 443.)
因此，如果使用默认值，最终用户将只能使用 http 或 https 方案访问 URI。用户唯一可以指定的端口是 80 和 443。（用户不必指定端口，但如果他们指定端口，则必须是 80 或 443。



 

Note 注意



The **glance-image-import.conf** is an optional file.  You can find an example file named [glance-image-import.conf.sample](https://opendev.org/openstack/glance/src/branch/master/etc/glance-image-import.conf.sample) in the **etc/** subdirectory of the Glance source code tree.  Make sure that you are looking in the correct branch for the OpenStack release you are working with.
glance-image-import.conf 是一个可选文件。您可以在 Glance 源代码树的 etc/ 子目录中找到名为 glance-image-import.conf.sample 的示例文件。确保您正在查找您正在使用的 OpenStack 版本的正确分支。

### Configuring the glance-download method 配置 glance-download 方法 ¶

To enable the `glance-download` import method, make sure that it is included in the list of methods in the `enabled_import_methods` option, and that staging directory config options are set properly.
若要启用 `glance-download` 导入方法，请确保它包含在 `enabled_import_methods` 选项的方法列表中，并且正确设置了暂存目录配置选项。

Additionally, you have the following configuration available.
此外，您还具有以下可用的配置。

Depending your needs on image properties you may configure addional properties to be copied from the remote image to the local image.
根据对映像属性的需求，您可以配置要从远程映像复制到本地映像的附加属性。

You can do this by configuring options in the `[glance_download_opts]` section of the **glance-image-import.conf** file.
您可以通过在 glance-image-import.conf 文件 `[glance_download_opts]` 的部分中配置选项来执行此操作。

`extra_properties` options is a list of properties that should be copied from the remote image. The properties listed should be read as properties that “start with” as it allows you to set a namespace instead of explicitly listing each property of the namespace.
 `extra_properties` options 是应从远程映像复制的属性列表。列出的属性应读取为“开头为”的属性，因为它允许您设置命名空间，而不是显式列出命名空间的每个属性。

Default values are : `['hw_', 'trait:', 'os_distro', 'os_secure_boot', 'os_type']`
默认值为： `['hw_', 'trait:', 'os_distro', 'os_secure_boot', 'os_type']` 

If you decide to set this option the default values will be totally ignored unless you explicitly set them.
如果决定设置此选项，则除非显式设置默认值，否则将完全忽略默认值。



 

Note 注意



The `extra_properties` option will ignore namespaces reserved by glance, meaning that all the properties starting with `os_glance` won’t be set on the local image.
该 `extra_properties` 选项将忽略 glance 保留的命名空间，这意味着不会在本地映像上设置所有以 开头的 `os_glance` 属性。



 

Note 注意



The **glance-image-import.conf** is an optional file.  You can find an example file named glance-image-import.conf.sample in the **etc/** subdirectory of the Glance source code tree. Make sure that you are looking in the correct branch for the OpenStack release you are working with.
glance-image-import.conf 是一个可选文件。您可以在 Glance 源代码树的 etc/ 子目录中找到名为 glance-image-import.conf.sample 的示例文件。确保您正在查找您正在使用的 OpenStack 版本的正确分支。

### Configuring the copy-image method 配置 copy-image 方法 ¶

For the `copy-image` method, make sure that `copy-image` is included in the list specified by your `enabled_import_methods` setting as well as you have multiple glance backends configured in your environment. To allow copy-image operation to be performed by users on images they do not own, you can set the copy_image policy to something other than the default, for example:
对于该 `copy-image` 方法，请确保该 `copy-image` 方法包含在设置 `enabled_import_methods` 指定的列表中，并在环境中配置了多个浏览后端。要允许用户对其不拥有的映像执行复制映像操作，您可以将copy_image策略设置为默认值以外的其他值，例如：

```
"copy_image": "'public':%(visibility)s"
```



## Copying existing-image in multiple stores 在多个商店中复制现有映像 ¶

Starting with Ussuri release, it is possible to copy existing image data into multiple stores using interoperable image import workflow.
从乌苏里版本开始，可以使用可互操作的图像导入工作流程将现有图像数据复制到多个存储中。

Basically user will be able to copy only those images which are owned by him. Unless the copying of unowned images are allowed by cloud operator by enforcing policy check, user will get Forbidden (Operation not permitted response) for such copy operations. Even if copying of unowned images is allowed by enforcing policy, ownership of the image remains unchanged.
基本上，用户只能复制他拥有的那些图像。除非云运营商通过强制执行策略检查允许复制无主图像，否则用户将收到此类复制操作的禁止（不允许操作响应）。即使强制执行策略允许复制未拥有的图像，图像的所有权也不会更改。

Operator or end user can either copy the existing image by specifying `all_stores` as True in request body or by passing list of desired stores in request body. If `all_stores` is specified and image data is already present in some of the available stores then those stores will be silently excluded from the list of all configured stores, whereas if `all_stores` is False, `stores` are specified in explicitly in request body and if image data is present in any of the specified store then the request will be rejected. In case of `all_stores` is specified in request body and cloud operator has also configured a read-only `http` store then it will be excluded explicitly.
操作员或最终用户可以通过在请求正文中指定 `all_stores` 为 True 或在请求正文中传递所需存储列表来复制现有映像。如果 `all_stores` 指定了图像数据，并且图像数据已存在于某些可用存储中，则这些存储将从所有已配置存储的列表中静默排除，而如果 `all_stores` 为 False， `stores` 则在请求正文中显式指定，如果图像数据存在于任何指定的存储中，则请求将被拒绝。如果在请求正文中指定了 ， `all_stores` 并且云运营商还配置了只 `http` 读存储，则它将被显式排除。

Image will be copied to staging area from one of the available locations and then import processing will be continued using import workflow as explained in below `Importing in multiple stores` section.
图像将从其中一个可用位置复制到暂存区域，然后使用导入工作流继续导入处理，如下 `Importing in multiple stores` 一节所述。

## Importing in multiple stores 在多个商店中导入 ¶

Starting with Ussuri, it is possible to import data into multiple stores using interoperable image import workflow.
从乌苏里开始，可以使用可互操作的图像导入工作流程将数据导入多个存储。

The status of the image is set to `active` according to the value of `all_stores_must_succeed` parameter.
图像的状态根据参数的 `all_stores_must_succeed` 值设置为 `active` 。

- If set to False: the image will be available as soon as an import to one store has succeeded.
  如果设置为 False：一旦成功导入到一个商店，图像将可用。
- If set to True (default): the status is set to `active` only when all stores have been successfully treated.
  如果设置为 True（默认值）： `active` 仅当所有存储都已成功处理时，状态才设置为。

### Check progress 检查进度 ¶

As each store is treated sequentially, it can take quite some time for the workflow to complete depending on the size of the image and the number of stores to import data to. It is possible to follow task progress by looking at 2 reserved image properties:
由于每个存储都是按顺序处理的，因此工作流可能需要相当长的时间才能完成，具体取决于图像的大小和要导入数据的存储数量。可以通过查看 2 个保留映像属性来跟踪任务进度：

- `os_glance_importing_to_stores`: This property contains a list of stores that has not yet been processed. At the beginning of the import flow, it is filled with the stores provided in the request. Each time a store is fully handled, it is removed from the list.
   `os_glance_importing_to_stores` ：此属性包含尚未处理的存储列表。在导入流的开头，它填充了请求中提供的存储。每次完全处理商店时，都会将其从列表中删除。
- `os_glance_failed_import`: Each time an import in a store fails, it is added to this list. This property is emptied at the beginning of the import flow.
   `os_glance_failed_import` ：每次存储中的导入失败时，都会将其添加到此列表中。此属性在导入流开始时清空。

These 2 properties are also available in the notifications sent during the workflow:
这 2 个属性在工作流期间发送的通知中也可用：



 

Note 注意



Example 例

An operator calls the import image api with the following parameters:
操作员使用以下参数调用导入图像 API：

```
curl -i -X POST -H "X-Auth-Token: $token"
     -H "Content-Type: application/json"
     -d '{"method": {"name":"glance-direct"},
          "stores": ["ceph1", "ceph2"],
          "all_stores_must_succeed": false}'
    $image_url/v2/images/{image_id}/import
```

The upload fails for ‘ceph2’ but succeed on ‘ceph1’. Since the parameter `all_stores_must_succeed` has been set to ‘false’, the task ends successfully and the image is now active.
“ceph2”的上传失败，但“ceph1”的上传成功。由于该参数 `all_stores_must_succeed` 已设置为“false”，因此任务成功结束，映像现在处于活动状态。

Notifications sent by glance looks like (payload is truncated for clarity):
通过 glance 发送的通知如下所示（为清楚起见，有效负载被截断）：

```
{
    "priority": "INFO",
    "event_type": "image.prepare",
    "timestamp": "2019-08-27 16:10:30.066867",
    "payload": {"status": "importing",
                "name": "example",
                "backend": "ceph1",
                "os_glance_importing_to_stores": ["ceph1", "ceph2"],
                "os_glance_failed_import": [],
                ...},
    "message_id": "1c8993ad-e47c-4af7-9f75-fa49596eeb10",
    ...
}

{
    "priority": "INFO",
    "event_type": "image.upload",
    "timestamp": "2019-08-27 16:10:32.058812",
    "payload": {"status": "active",
                "name": "example",
                "backend": "ceph1",
                "os_glance_importing_to_stores": ["ceph2"],
                "os_glance_failed_import": [],
                ...},
    "message_id": "8b8993ad-e47c-4af7-9f75-fa49596eeb11",
    ...
}

{
    "priority": "INFO",
    "event_type": "image.prepare",
    "timestamp": "2019-08-27 16:10:33.066867",
    "payload": {"status": "active",
                "name": "example",
                "backend": "ceph2",
                "os_glance_importing_to_stores": ["ceph2"],
                "os_glance_failed_import": [],
                ...},
    "message_id": "1c8993ad-e47c-4af7-9f75-fa49596eeb18",
    ...
}

{
    "priority": "ERROR",
    "event_type": "image.upload",
    "timestamp": "2019-08-27 16:10:34.058812",
    "payload": "Error Message",
    "message_id": "8b8993ad-e47c-4af7-9f75-fa49596eeb11",
    ...
}
```

## Customizing the image import process 自定义图像导入过程 ¶

When a user issues the image-import call, Glance retrieves the staged image data, processes it, and saves the result in the backing store.  You can customize the nature of this processing by using *plugins*.  Some plugins are provided by the Glance project team, you can use third-party plugins, or you can write your own.
当用户发出图像导入调用时，Glance 会检索暂存图像数据，对其进行处理，并将结果保存在后备存储中。您可以使用插件自定义此处理的性质。有些插件是由 Glance 项目团队提供的，您可以使用第三方插件，也可以自己编写。

### Technical information 技术信息 ¶

The import step of interoperable image import is performed by a [Taskflow](https://docs.openstack.org/taskflow) “flow” object.  This object, provided by Glance, will call any plugins you have specified in the `glance-image-import.conf` file.  The plugins are loaded by [Stevedore](https://docs.openstack.org/stevedore) and must be listed in the entry point registry in the namespace `glance.image_import.plugins`.  (If you are using only plugins provided by the Glance project team, these are already registered for you.)
可互操作图像导入的导入步骤由 Taskflow“流”对象执行。此对象由 Glance 提供，将调用您在 `glance-image-import.conf` 文件中指定的任何插件。插件由 Stevedore 加载，并且必须在命名空间 `glance.image_import.plugins` 的入口点注册表中列出。（如果您仅使用 Glance 项目团队提供的插件，则这些插件已为您注册。

A plugin must be written in Python as a [Taskflow “Task” object](https://docs.openstack.org/taskflow/latest/user/atoms.html#task).  The file containing this object must be present in the `glance/async_/flows/plugins` directory.  The plugin file must contain a `get_flow` function that returns a Taskflow Task object wrapped in a linear flow.  See the `no_op` plugin, located at `glance/async_/flows/plugins/no_op.py` for an example of how to do this.
插件必须用 Python 编写为 Taskflow“Task”对象。 `glance/async_/flows/plugins` 包含此对象的文件必须存在于目录中。插件文件必须包含一个 `get_flow` 函数，该函数返回包装在线性流中的 Taskflow Task 对象。有关如何执行此操作的示例，请参阅 `no_op` 位于 `glance/async_/flows/plugins/no_op.py` 的插件。

### Specifying the plugins to be used 指定要使用的插件 ¶

First, the plugin code must exist in the directory `glance/async_/flows/plugins`.  The name of a plugin is the filename (without extension) of the file containing the plugin code.  For example, a file named `fred_mertz.py` would contain the plugin `fred_mertz`.
首先，插件代码必须存在于目录中 `glance/async_/flows/plugins` 。插件的名称是包含插件代码的文件的文件名（不带扩展名）。例如，一个名为 `fred_mertz.py` 的文件将包含插件 `fred_mertz` 。

Second, the plugin must be listed in the entry point list for the `glance.image_import.plugins` namespace.  (If you are using only plugins provided with Glance, this will have already been done for you, but it never hurts to check.)  The entry point list is in `setup.cfg`.  Find the section with the heading `[entry_points]` and look for the line beginning with `glance.image_import.plugins =`.  It will be followed by a series of lines of the form:
其次，插件必须列在 `glance.image_import.plugins` 命名空间的入口点列表中。（如果您仅使用 Glance 提供的插件，则已经为您完成了此操作，但检查一下也无妨。入口点列表位于 `setup.cfg` 中。找到带有标题 `[entry_points]` 的部分，然后查找以 `glance.image_import.plugins =` 开头的行。后面是一系列形式的行：

```
<plugin-name> = <module-package-name>:get_flow
```

For example: 例如：

```
no_op = glance.async_.flows.plugins.no_op:get_flow
```

Make sure any plugin you want to use is included here.
确保您要使用的任何插件都包含在此处。

Third, the plugin must be listed in the `glance-image-import.conf` file as one of the plugin names in the list providing the value for the `image_import_plugins` option.  Plugins are executed in the order they are specified in this list.
第三，插件必须在 `glance-image-import.conf` 文件中作为提供 `image_import_plugins` 选项值的列表中的插件名称之一列出。插件按此列表中指定的顺序执行。

## The Image Property Injection Plugin 图像属性注入插件 ¶

| release introduced 发布介绍             | Queens (Glance 16.0.0) 皇后区 （Glance 16.0.0） |
| --------------------------------------- | ----------------------------------------------- |
| configuration file 配置文件             | `glance-image-import.conf`                      |
| configuration file section 配置文件部分 | `[inject_metadata_properties]`                  |

This plugin implements the Glance spec [Inject metadata properties automatically to non-admin images](https://specs.openstack.org/openstack/glance-specs/specs/queens/approved/glance/inject-automatic-metadata.html).  One use case for this plugin is a situation where an operator wants to put specific metadata on images imported by end users so that virtual machines booted from these images will be located on specific compute nodes.  Since it’s unlikely that an end user (the image owner) will know the appropriate properties or values, an operator may use this plugin to inject the properties automatically upon image import.
此插件实现了 Glance  规范：自动将元数据属性注入非管理员映像。此插件的一个用例是，操作员希望将特定元数据放在最终用户导入的映像上，以便从这些映像启动的虚拟机将位于特定的计算节点上。由于最终用户（图像所有者）不太可能知道相应的属性或值，因此操作员可以使用此插件在图像导入时自动注入属性。



 

Note 注意



This plugin may only be used as part of the interoperable image import workflow (`POST v2/images/{image_id}/import`).  *It has no effect on the image data upload call* (`PUT v2/images/{image_id}/file`).
此插件只能用作可互操作图像导入工作流 （ `POST v2/images/{image_id}/import` ） 的一部分。它对图像数据上传调用 （ ） 没有影响 `PUT v2/images/{image_id}/file` 。

You can guarantee that your end users must use interoperable image import by restricting the `upload_image` policy appropriately in the Glance `policy.yaml` file.  By default, this policy is unrestricted (that is, any authorized user may make the image upload call).
您可以通过在 Glance `policy.yaml` 文件中适当限制 `upload_image` 策略来保证最终用户必须使用可互操作的图像导入。默认情况下，此策略不受限制（即任何授权用户都可以进行图像上传调用）。

For example, to allow only admin or service users to make the image upload call, the policy could be restricted as follows:
例如，若要仅允许管理员或服务用户进行图像上传调用，可以按如下方式限制策略：

```
"upload_image": "role:admin or (service_user_id:<uuid of nova user>) or
   (service_roles:<service user role>)"
```

where “service_role” is the role which is created for the service user and assigned to trusted services.
其中“service_role”是为服务用户创建并分配给受信任服务的角色。

To use the Image Property Injection Plugin, the following configuration is required.
要使用图像属性注入插件，需要进行以下配置。

1. You will need to configure ‘glance-image-import.conf’ file as shown below:
   您需要配置“glance-image-import.conf”文件，如下所示：

   ```
   [image_import_opts]
   image_import_plugins = [inject_image_metadata]
   
   [inject_metadata_properties]
   ignore_user_roles = admin,...
   inject = "property1":"value1","property2":"value2",...
   ```

   The first section, `image_import_opts`, is used to enable the plugin by specifying the plugin name as one of the elements of the list that is the value of the image_import_plugins parameter.  The plugin name is simply the module name under glance/async_/flows/plugins/
   第一部分 `image_import_opts` 用于通过将插件名称指定为列表元素之一（即 image_import_plugins 参数的值）来启用插件。插件名称只是 glance/async_/flows/plugins/ 下的模块名称

   The second section, `inject_metadata_properties`, is where you set the parameters for the injection plugin.  (Note that the values you specify here only have an effect if the plugin has been enabled in the `image_import_plugins` list as described above.)
   第二部分是 `inject_metadata_properties` 设置注入插件参数的地方。（请注意，您在此处指定的值仅在 `image_import_plugins` 如上所述的列表中启用插件时才有效。

   - `ignore_user_roles` is a comma-separated list of Keystone roles that the plugin will ignore.  In other words, if the user making the image import call has any of these roles, the plugin will not inject any properties into the image.
      `ignore_user_roles` 是插件将忽略的 Keystone 角色的逗号分隔列表。换句话说，如果进行图像导入调用的用户具有这些角色中的任何一个，则插件不会将任何属性注入到图像中。
   - `inject` is a comma-separated list of properties and values that will be injected into the image record for the imported image.  Each property and value should be quoted and separated by a colon (‘:’) as shown in the example above.
      `inject` 是以逗号分隔的属性和值列表，这些属性和值将注入到导入图像的图像记录中。每个属性和值都应用引号括起来，并用冒号 （'：'） 分隔，如上例所示。

2. If your use case is such that you don’t want to allow end-users to create, modify, or delete metadata properties that you are injecting during the interoperable image import process, you will need to protect these properties using the Glance property protection feature (available since the Havana release).
   如果您的用例不希望最终用户创建、修改或删除您在可互操作的图像导入过程中注入的元数据属性，则需要使用 Glance 属性保护功能（自 Havana 版本起可用）保护这些属性。

   For example, suppose there is a property named ‘property1’ that you want injected during import, but you only want an administrator or service user to be able to create this property, and you want only an administrator to be able to modify or delete it.  You could accomplish this by adding the following to the property protection configuration file:
   例如，假设您希望在导入期间注入一个名为“property1”的属性，但您只希望管理员或服务用户能够创建此属性，并且只希望管理员能够修改或删除它。您可以通过将以下内容添加到属性保护配置文件来实现此目的：

   ```
   [property1]
   create = admin,service_role
   read = admin,service_role,member,_member_
   update = admin
   delete = admin
   ```

   See the [Property Protections](https://docs.openstack.org/glance/2023.2/admin/property-protections.html#property-protections) section of this Guide for more information.
   有关详细信息，请参阅本指南的“财产保护”部分。

## The Image Conversion 图像转换 ¶

| release introduced 发布介绍             | Rocky (Glance 17.0.0) 洛基 （Glance 17.0.0） |
| --------------------------------------- | -------------------------------------------- |
| configuration file 配置文件             | `glance-image-import.conf`                   |
| configuration file section 配置文件部分 | `[image_conversion]`                         |

This plugin implements automated image conversion for Interoperable Image Import. One use case for this plugin would be environments where Ceph is used as image back-end and operators want to optimize the back-end capabilities by ensuring that all images will be in raw format while not putting the burden of converting the images to their end users.
此插件为可互操作的图像导入实现自动图像转换。此插件的一个用例是将 Ceph 用作映像后端的环境，操作员希望通过确保所有映像均为原始格式来优化后端功能，同时不将将映像转换为最终用户的负担。



 

Note 注意



This plugin may only be used as part of the interoperable image import workflow (`POST v2/images/{image_id}/import`).  *It has no effect on the image data upload call* (`PUT v2/images/{image_id}/file`).
此插件只能用作可互操作图像导入工作流 （ `POST v2/images/{image_id}/import` ） 的一部分。它对图像数据上传调用 （ ） 没有影响 `PUT v2/images/{image_id}/file` 。

You can guarantee that your end users must use interoperable image import by restricting the `upload_image` policy appropriately in the Glance `policy.yaml` file.  By default, this policy is unrestricted (that is, any authorized user may make the image upload call).
您可以通过在 Glance `policy.yaml` 文件中适当限制 `upload_image` 策略来保证最终用户必须使用可互操作的图像导入。默认情况下，此策略不受限制（即任何授权用户都可以进行图像上传调用）。

For example, to allow only admin or service users to make the image upload call, the policy could be restricted as follows:
例如，若要仅允许管理员或服务用户进行图像上传调用，可以按如下方式限制策略：

```
"upload_image": "role:admin or (service_user_id:<uuid of nova user>) or
   (service_roles:<service user role>)"
```

where “service_role” is the role which is created for the service user and assigned to trusted services.
其中“service_role”是为服务用户创建并分配给受信任服务的角色。

To use the Image Conversion Plugin, the following configuration is required.
要使用图像转换插件，需要以下配置。

You will need to configure ‘glance-image-import.conf’ file as shown below:
您需要配置“glance-image-import.conf”文件，如下所示：

```
[image_import_opts]
image_import_plugins = ['image_conversion']

[image_conversion]
output_format = raw
```



 

Note 注意



The default output format is raw in which case there is no need to have ‘image_conversion’ section and its ‘output_format’ defined in the config file.
默认输出格式为 raw，在这种情况下，无需在配置文件中定义“image_conversion”部分及其“output_format”。

The input format needs to be one of the [qemu-img supported ones](https://github.com/qemu/qemu/blob/master/qemu-img.texi#L599-L725) for this feature to work. In case of qemu-img call failing on the source image the import process will fail if ‘image_conversion’ plugin is enabled.
输入格式必须是 qemu-img 支持的格式之一，此功能才能正常工作。如果源镜像上的qemu-img调用失败，如果启用了“image_conversion”插件，导入过程将失败。



 

Note 注意



`image_import_plugins` config option is a list and multiple plugins can be enabled for the import flow. The plugins are not run in parallel. One can enable multiple plugins by configuring them in the `glance-image-import.conf` for example as following:
 `image_import_plugins` config 选项是一个列表，可以为导入流程启用多个插件。这些插件不是并行运行的。可以通过在例如中 `glance-image-import.conf` 配置多个插件来启用它们，如下所示：

```
[image_import_opts]
image_import_plugins = ['inject_image_metadata', 'image_conversion']

[inject_metadata_properties]
ignore_user_roles = admin,...
inject = "property1":"value1","property2":"value2",...

[image_conversion]
output_format = raw
```

## The Image Decompression 图像解压缩 ¶

| release introduced 发布介绍 | Ussuri (Glance 20.0.0) 乌苏里 （Glance 20.0.0） |
| --------------------------- | ----------------------------------------------- |
| configuration file 配置文件 | `glance-image-import.conf`                      |

This plugin implements automated image decompression for Interoperable Image Import. One use case for this plugin would be environments where user or operator wants to use ‘web-download’ method and the image provider supplies only compressed images.
此插件为可互操作的图像导入实现自动图像解压缩。此插件的一个用例是用户或操作员想要使用“web-download”方法，而图像提供商仅提供压缩图像的环境。



 

Note 注意



This plugin may only be used as part of the interoperable image import workflow (`POST v2/images/{image_id}/import`).  *It has no effect on the image data upload call* (`PUT v2/images/{image_id}/file`).
此插件只能用作可互操作图像导入工作流 （ `POST v2/images/{image_id}/import` ） 的一部分。它对图像数据上传调用 （ ） 没有影响 `PUT v2/images/{image_id}/file` 。

You can guarantee that your end users must use interoperable image import by restricting the `upload_image` policy appropriately in the Glance `policy.yaml` file.  By default, this policy is unrestricted (that is, any authorized user may make the image upload call).
您可以通过在 Glance `policy.yaml` 文件中适当限制 `upload_image` 策略来保证最终用户必须使用可互操作的图像导入。默认情况下，此策略不受限制（即任何授权用户都可以进行图像上传调用）。

For example, to allow only admin or service users to make the image upload call, the policy could be restricted as follows:
例如，若要仅允许管理员或服务用户进行图像上传调用，可以按如下方式限制策略：

```
"upload_image": "role:admin or (service_user_id:<uuid of nova user>) or
(service_roles:<service user role>)"
```

where “service_role” is the role which is created for the service user and assigned to trusted services.
其中“service_role”是为服务用户创建并分配给受信任服务的角色。



 

Note 注意



The plugin will not decompressed images which container_format is set to ‘compressed’ to maintain the original intent of the image creator.
该插件不会解压缩container_format设置为“压缩”的图像，以保持图像创建者的原始意图。

To use the Image Decompression Plugin, the following configuration is required.
要使用镜像解压插件，需要进行以下配置。

You will need to add “image_decompression” to ‘glance-image-import.conf’ file as shown below:
您需要将“image_decompression”添加到“glance-image-import.conf”文件中，如下所示：

```
[image_import_opts]
image_import_plugins = ['image_decompression']
```



 

Note 注意



The supported archive types for Image Decompression are zip, lha/lzh and gzip. Currently the plugin does not support multi-layered archives (like tar.gz). Lha/lzh is only supported in case python3 lhafile dependency library is installed, absence of this dependency will fail the import job where lha file is provided. (In this case we know it won’t be bootable as the image is compressed and we do not have means to decompress it.)
镜像解压支持的归档类型为 zip、lha/lzh 和 gzip。目前，该插件不支持多层存档（如 tar.gz）。Lha/lzh 仅在安装了 python3  lhafile 依赖库的情况下受支持，如果没有此依赖项，提供 lha  文件的导入作业将失败。（在这种情况下，我们知道它无法启动，因为映像已压缩，并且我们没有办法解压缩它。



 

Note 注意



`image_import_plugins` config option is a list and multiple plugins can be enabled for the import flow. The plugins are not run in parallel. One can enable multiple plugins by configuring them in the `glance-image-import.conf` for example as following:
 `image_import_plugins` config 选项是一个列表，可以为导入流程启用多个插件。这些插件不是并行运行的。可以通过在例如中 `glance-image-import.conf` 配置多个插件来启用它们，如下所示：

```
[image_import_opts]
image_import_plugins = ['image_decompression', 'image_conversion']

[image_conversion]
output_format = raw
```

If Image Conversion is used together, decompression must happen first, this is ensured by ordering the plugins.
如果一起使用图像转换，则必须首先进行解压缩，这可以通过订购插件来确保。                      

# Multi Store Support 多商店支持

​                                  





 

Note 注意



The Multi Store feature was introduced as EXPERIMENTAL in Rocky and is now fully supported in the Train release.
多商店功能在 Rocky 中作为 EXPERIMENTAL 引入，现在在 Train 版本中完全支持。

## Scope of this document 本文档的范围 ¶

This page describes how to enable multiple stores in glance.
本页介绍如何一目了然地启用多个商店。

## Prerequisites 先决条件 ¶

- Glance version 17.0.0 or Later
  Glance 版本 17.0.0 或更高版本
- Glance Store Library 0.25.0 or Later
  Glance Store Library 0.25.0 或更高版本
- Glance not using the Glance Registry
  Glance 未使用 Glance 注册表
- Available backends 可用的后端

## Procedure 操作步骤 ¶

In this section, we discuss what configuration options are available to operators to enable multiple stores support.
在本节中，我们将讨论运营商可以使用哪些配置选项来启用多个存储支持。

- in the `[DEFAULT]` options group:
  在“ `[DEFAULT]` 选项”组中：

  - `enabled_backends` must be set as a key:value pair where key represents the identifier for the store and value will be the type of the store. Valid values are one of `file`, `http`, `rbd`, `swift`, `cinder` or `vmware`. In order to have multiple stores operator can specify multiple key:value separated by comma.
     `enabled_backends` 必须设置为键值对，其中 key 表示存储的标识符，value 将是存储的类型。有效值为 `file` 、 `http` 、 `rbd` 、 `swift` `cinder` 或 `vmware` 之一。为了拥有多个存储，运算符可以指定多个 key：value，以逗号分隔。

    

     

    Warning 警告

    

    The store identifier prefix `os_glance_` is reserved.  If you define a store identifier with this prefix, the glance service will refuse to start.
    保留存储标识符前缀 `os_glance_` 。如果使用此前缀定义存储标识符，则 glance 服务将拒绝启动。

    The http store type is always treated by Glance as a read-only store.  This is indicated in the response to the `/v2/stores/info` call, where an http type store will have the attribute `read-only: True` in addition to the usual `id` and `description` fields.
    Glance 始终将 http 存储类型视为只读存储。这在 `/v2/stores/info` 对调用的响应中指示，其中 http 类型存储除了通常 `id` 的 and `description` 字段外，还将具有该属性 `read-only: True` 。

    ```
    [DEFAULT]
    enabled_backends = fast:rbd, cheap:rbd, shared:file, reliable:file
    ```

- in the `[glance_store]` options group:
  在“ `[glance_store]` 选项”组中：

  - `default_backend` must be set to one of the identifier which are defined using `enabled_backends` option. If `default_backend` is not set or if it is not representing one of the valid store drivers then it will prevent glance api service from starting.
     `default_backend` 必须设置为使用 `enabled_backends` option 定义的标识符之一。如果 `default_backend` 未设置，或者它不代表一个有效的存储驱动程序，则它将阻止 glance api 服务启动。

    ```
    [glance_store]
    default_backend = fast
    ```

- For each of the store identifier defined in `enabled_backends` section operator needs to add a new config group which will define config options related to that particular store.
  对于在部分中 `enabled_backends` 定义的每个存储标识符，操作员需要添加一个新的配置组，该组将定义与该特定存储相关的配置选项。

  ```
  [shared]
  filesystem_store_datadir = /opt/stack/data/glance/shared_images/
  store_description = "Shared filesystem store"
  
  [reliable]
  filesystem_store_datadir = /opt/stack/data/glance/reliable
  store_description = "Reliable filesystem backend"
  
  [fast]
  store_description = "Fast rbd backend"
  rbd_store_chunk_size = 8
  rbd_store_pool = images
  rbd_store_user = admin
  rbd_store_ceph_conf = /etc/ceph/ceph.conf
  rados_connect_timeout = 0
  
  [cheap]
  store_description = "Cheap rbd backend"
  rbd_store_chunk_size = 8
  rbd_store_pool = images
  rbd_store_user = admin
  rbd_store_ceph_conf = /etc/ceph/ceph1.conf
  rados_connect_timeout = 0
  ```

  

   

  Note 注意

  

  `store_description` is a new config option added to each store where operator can add meaningful description about that store. This description is displayed in the GET /v2/info/stores response.
   `store_description` 是添加到每个商店的新配置选项，操作员可以在其中添加有关该商店的有意义的描述。此说明显示在 GET /v2/info/stores 响应中。

### Store Configuration Issues 商店配置问题 ¶

Please keep the following points in mind.
请记住以下几点。

- Due to the special read only nature and characteristics of the http store type, configuring multiple instances of the http type store **is not supported**.  (This constraint is not currently enforced in the code.)
  由于 http 存储类型的特殊只读性质和特性，不支持配置 http 类型存储的多个实例。（此约束当前未在代码中强制执行。
- Each instance of the filesystem store **must** have a different value for the `filesystem_store_datadir`.  (This constraint is not currently enforced in the code.)
  文件系统存储的每个实例都必须具有不同的 `filesystem_store_datadir` 值。（此约束当前未在代码中强制执行。



## Reserved Stores 预留存储 ¶

With the Train release, Glance is beginning a transition from its former reliance upon local directories for temporary data storage to the ability to use backend stores accessed via the glance_store library.
随着 Train 的发布，Glance 开始从以前依赖本地目录进行临时数据存储过渡到使用通过 glance_store 库访问的后端存储的能力。

In the Train release, the use of backend stores for this purpose is optional **unless you are using the multi store support feature**.  Since you are reading this document, this situation most likely applies to you.
在 Train 版本中，除非使用多存储支持功能，否则将后端存储用于此目的是可选的。由于您正在阅读本文档，因此这种情况很可能适用于您。



 

Note 注意



Currently, only the filesystem store type is supported as a Glance reserved store.
目前，仅支持将文件系统存储类型作为 Glance 保留存储。

The reserved stores are not intended to be exposed to end users.  Thus they will not appear in the response to the store discovery call, GET /v2/info/stores, or as values in the `OpenStack-image-store-ids` response header of the image-create call.
保留存储不应向最终用户公开。因此，它们不会出现在对存储发现调用 GET /v2/info/stores 的响应中，也不会作为值出现在 image-create 调用的 `OpenStack-image-store-ids` 响应标头中。

You do not get to select the name of a reserved store; these are defined by Glance and begin with the prefix `os_glance_`.  In the Train release, you do not get to select the store type: all reserved stores must be of type filesystem.
您无法选择保留存储的名称;这些由Glance定义，以前缀 `os_glance_` 开头。在 Train 版本中，您无法选择存储类型：所有保留存储都必须为 filesystem 类型。

Currently, there are two reserved stores:
目前，有两个预留商店：

- `os_glance_tasks_store`

  This store is used for the tasks engine.  It replaces the use of the DEPRECATED configuration option `[task]/work_dir`. 此存储用于任务引擎。它取代了 DEPRECATED 配置选项 `[task]/work_dir` 。

- `os_glance_staging_store`

  This store is used for the staging area for the interoperable image import process.  It replaces  the use of the DEPRECATED configuration option `[DEFAULT]/node_staging_uri`. 此存储用于可互操作图像导入过程的暂存区域。它取代了 DEPRECATED 配置选项 `[DEFAULT]/node_staging_uri` 。



 

Note 注意



If end user wants to retrieve all the available stores using `CONF.enabled_backends` then they need to remove reserved stores from that list explicitly.
如果最终用户想要检索所有可用的存储， `CONF.enabled_backends` 则他们需要从该列表中显式删除保留存储。

### Configuration 配置 ¶

As mentioned above, you do not get to select the name or the type of a reserved store (though we anticipate that you will be able configure the store type in a future release).
如上所述，您无法选择保留存储的名称或类型（尽管我们预计您将能够在将来的版本中配置存储类型）。

The reserved stores *must* be of type filesystem.  Hence, you must provide configuration for them in your `glance-api.conf` file.  You do this by introducing a section in `glance-api.conf` for each reserved store as follows:
保留存储的类型必须为 filesystem。因此，您必须在 `glance-api.conf` 文件中为它们提供配置。为此，您可以 `glance-api.conf` 为每个保留的存储引入一个部分，如下所示：

```
[os_glance_tasks_store]
filesystem_store_datadir = /var/lib/glance/tasks_work_dir

[os_glance_staging_store]
filesystem_store_datadir = /var/lib/glance/staging
```

Since these are both filesystem stores (remember, you do not get a choice) the only option you must configure for each is the `filesystem_store_datadir`.  Please keep the following points in mind:
由于它们都是文件系统存储（请记住，您没有选择权），因此必须为每个文件系统配置的唯一选项是 `filesystem_store_datadir` .请记住以下几点：

- The path for `filesystem_store_datadir` used for the reserved stores must be **different** from the path you are using for any filesystem store you have listed in `enabled_backends`. Using the same data directory for multiple filesystem stores is **unsupported** and may lead to data loss.
   `filesystem_store_datadir` 用于保留存储的路径必须不同于用于 中列出的任何文件系统存储的路径 `enabled_backends` 。不支持对多个文件系统存储使用相同的数据目录，这可能会导致数据丢失。
- The identifiers for reserved stores, that is, `os_glance_tasks_store` and `os_glance_staging_store`, must **not** be included in the `enabled_backends` list.
   `enabled_backends` 保留存储的标识符（即 `os_glance_tasks_store` 和 `os_glance_staging_store` ）不得包含在列表中。
- The reserved stores will **not** appear in the store discovery response or as values in the `OpenStack-image-store-ids` response header of the image-create call.
  保留存储不会显示在存储发现响应中，也不会作为值显示在 image-create 调用的 `OpenStack-image-store-ids` 响应标头中。
- The reserved stores will **not** be accepted as the value of the `X-Image-Meta-Store` header on the image-data-upload call or the image-import call.
  保留存储不会被接受为 image-data-upload 调用或 image-import 调用的 `X-Image-Meta-Store` 标头值。

# Database Management 数据库管理

​                                  



## Updating and Migrating the Database 更新和迁移数据库 ¶

The default metadata driver for Glance uses [SQLAlchemy](http://www.sqlalchemy.org/), which implies there exists a backend database which must be managed. The `glance-manage` binary provides a set of commands for making this easier.
Glance 的默认元数据驱动程序使用 SQLAlchemy，这意味着存在一个必须管理的后端数据库。 `glance-manage` 二进制文件提供了一组命令来简化此操作。

The commands should be executed as a subcommand of ‘db’:
这些命令应作为 'db' 的子命令执行：

```
glance-manage db <cmd> <args>
```



 

Note 注意



In the Ocata release (14.0.0), the database migration engine was changed from *SQLAlchemy Migrate* to *Alembic*.  This necessitated some changes in the `glance-manage` tool.  While the user interface has been kept as similar as possible, the `glance-manage` tool included with the Ocata and more recent releases is incompatible with the “legacy” tool.  If you are consulting these documents for information about the `glance-manage` tool in the Newton or earlier releases, please see the [Legacy Database Management](https://docs.openstack.org/glance/2023.2/admin/db-sqlalchemy-migrate.html#legacy-database-management) page.
在 Ocata 版本 （14.0.0） 中，数据库迁移引擎已从 SQLAlchemy Migrate 更改为 Alembic。这需要对 `glance-manage` 工具进行一些更改。虽然用户界面尽可能保持相似，但 Ocata 和更新版本中包含的 `glance-manage` 工具与“旧版”工具不兼容。如果您正在查阅这些文档，了解有关 Newton 或更早版本中的 `glance-manage` 工具的信息，请参阅旧版数据库管理页面。

### Migration Scripts 迁移脚本 ¶

The migration scripts are stored in the directory: `glance/db/sqlalchemy/alembic_migrations/versions`
迁移脚本存储在以下目录中： `glance/db/sqlalchemy/alembic_migrations/versions` 

As mentioned above, these scripts utilize the Alembic migration engine, which was first introduced in the Ocata release.  All database migrations up through the Liberty release are consolidated into one Alembic migration script named `liberty_initial`.  Mitaka migrations are retained, but have been rewritten for Alembic and named using the new naming convention.
如上所述，这些脚本利用了 Alembic 迁移引擎，该引擎在 Ocata 版本中首次引入。到 Liberty 发行版之前的所有数据库迁移都合并到一个名为 `liberty_initial` 的 Alembic 迁移脚本中。Mitaka 迁移被保留，但已针对 Alembic 进行了重写，并使用新的命名约定进行命名。

A fresh Glance installation will apply the following migrations:
全新 Glance 安装将应用以下迁移：

- `liberty-initial`
- `mitaka01`
- `mitaka02`
- `ocata01`



 

Note 注意



The “old-style” migration scripts have been retained in their [current directory](https://opendev.org/openstack/glance/src/branch/stable/ocata/glance/db/sqlalchemy/migrate_repo/versions) in the Ocata release so that interested operators can correlate them with the new migrations.  This directory will be removed in future releases.
在 Ocata 版本中，“旧式”迁移脚本已保留在当前目录中，以便感兴趣的操作员可以将它们与新迁移相关联。此目录将在将来的版本中删除。

In particular, the “old-style” script for the Ocata migration, [045_add_visibility.py](https://opendev.org/openstack/glance/src/branch/stable/ocata/glance/db/sqlalchemy/migrate_repo/versions/045_add_visibility.py) is retained for operators who are conversant in SQLAlchemy Migrate and are interested in comparing it with a “new-style” Alembic migration script.  The Alembic script, which is the one actually used to do the upgrade to Ocata, is [ocata01_add_visibility_remove_is_public.py](https://opendev.org/openstack/glance/src/branch/stable/ocata/glance/db/sqlalchemy/alembic_migrations/versions/ocata01_add_visibility_remove_is_public.py).
特别是，Ocata 迁移的“旧式”脚本045_add_visibility.py为熟悉 SQLAlchemy Migrate 并有兴趣将其与“新式”Alembic 迁移脚本进行比较的操作员保留。Alembic 脚本是实际用于升级到 Ocata  的脚本，ocata01_add_visibility_remove_is_public.py。

### Sync the Database 同步数据库 ¶

```
glance-manage db sync [VERSION]
```

Place an existing database under migration control and upgrade it to the specified VERSION or to the latest migration level if VERSION is not specified.
将现有数据库置于迁移控制之下，并将其升级到指定的 VERSION 或最新的迁移级别（如果未指定 VERSION）。



 

Note 注意



Prior to Ocata release the database version was a numeric value.  For example: for the Newton release, the latest migration level was `44`. Starting with Ocata, database version is a revision name corresponding to the latest migration included in the release. For the Ocata release, there is only one database migration and it is identified by revision `ocata01`. So, the database version for Ocata release is `ocata01`.
在 Ocata 发布之前，数据库版本是一个数值。例如：对于 Newton 版本，最新的迁移级别是 `44` 。从 Ocata 开始，数据库版本是与发行版中包含的最新迁移相对应的修订名称。对于 Ocata 版本，只有一个数据库迁移，它由修订版标识 `ocata01` 。因此，Ocata 版本的数据库版本是 `ocata01` .

This naming convention will change slightly with the introduction of zero-downtime upgrades, which is EXPERIMENTAL in Ocata, but is projected to be the official upgrade method beginning with the Pike release.  See [Zero-Downtime Database Upgrades](https://docs.openstack.org/glance/2023.2/admin/zero-downtime-db-upgrade.html#zero-downtime) for more information.
随着零停机升级的引入，这种命名约定将略有变化，这在 Ocata 中是实验性的，但预计从 Pike 版本开始成为官方升级方法。有关详细信息，请参阅零停机数据库升级。

### Determining the Database Version 确定数据库版本 ¶

```
glance-manage db version
```

This will print the current migration level of a Glance database.
这将打印 Glance 数据库的当前迁移级别。

### Upgrading an Existing Database 升级现有数据库 ¶

```
glance-manage db upgrade [VERSION]
```

This will take an existing database and upgrade it to the specified VERSION.
这将获取现有数据库并将其升级到指定的 VERSION。



### Downgrading an Existing Database 降级现有数据库 ¶

Downgrading an existing database is **NOT SUPPORTED**.
不支持降级现有数据库。

Upgrades involve complex operations and can fail. Before attempting any upgrade, you should make a full database backup of your production data. As of the OpenStack Kilo release (April 2013), database downgrades are not supported, and the only method available to get back to a prior database version is to restore from backup.
升级涉及复杂的操作，并且可能会失败。在尝试任何升级之前，应对生产数据进行完整数据库备份。从 OpenStack Kilo 版本（2013 年 4 月）开始，不支持数据库降级，恢复到以前的数据库版本的唯一方法是从备份中恢复。

## Database Maintenance 数据库维护 ¶

Like most OpenStack systems, Glance performs *soft* deletions when it deletes records from its database.  Depending on usage patterns in your cloud, you may occasionally want to actually remove such soft deleted table rows.  This operation is called *purging* the database, and you can use the `glance-manage` tool to do this.
与大多数 OpenStack 系统一样，Glance 在从数据库中删除记录时会执行软删除。根据云中的使用模式，您可能偶尔希望实际删除此类软删除的表行。此操作称为清除数据库，您可以使用该 `glance-manage` 工具执行此操作。

### High-Level Database Architecture 高级数据库架构 ¶

Roughly, what we’ve got in the glance database is an **images** table that stores the image **id** and some other core image properties.  All the other information about the image (for example: where the image data is stored in the backend, what projects an image has been shared with, image tags, custom image properties) is stored in other tables in which the **image id** is a foreign key.
粗略地说，我们在 glance 数据库中得到的是一个图像表，它存储了图像 ID 和其他一些核心图像属性。有关图像的所有其他信息（例如：图像数据在后端的存储位置、与哪些项目共享图像、图像标记、自定义图像属性）都存储在其他表中，其中图像 ID 是外键。

Because the **images** table keeps track of what image identifiers have been issued, it must be treated differently from the other tables with respect to purging the database.
由于映像表跟踪已颁发的映像标识符，因此在清除数据库方面，必须将其与其他表区别对待。



 

Note 注意



Before the Rocky release (17.0.0), the **images** table was *not* treated differently, which made Glance vulnerable to [OSSN-0075](https://wiki.openstack.org/wiki/OSSN/OSSN-0075), “Deleted Glance image IDs may be reassigned”.  Please read through that OpenStack Security Note to understand the nature of the problem.
在 Rocky 版本 （17.0.0） 之前，图像表没有区别对待，这使得 Glance 容易受到 OSSN-0075 的攻击，“删除的 Glance 图像 ID 可能会被重新分配”。请通读该 OpenStack 安全说明，以了解问题的本质。

Additionally, the Glance spec [Mitigate OSSN-0075](https://specs.openstack.org/openstack/glance-specs/specs/rocky/approved/glance/mitigate-ossn-0075.html) contains a discussion of the issue and explains the changes made to the `glance-manage` tool for the Rocky release.  The [Gerrit review of the spec](https://review.opendev.org/#/c/468179/) contains an extensive discussion of several alternative approaches and will give you an idea of why the Glance team provided a “mitigation” instead of a fix.
此外，Glance 规范 Mitigate OSSN-0075 包含对该问题的讨论，并解释了对 Rocky 版本 `glance-manage` 的工具所做的更改。Gerrit 对规范的审查包含对几种替代方法的广泛讨论，并将让您了解为什么 Glance 团队提供了“缓解”而不是修复。

### Purging the Database 清除数据库 ¶

You can use the `glance-manage` tool to purge the soft-deleted rows from all tables *except* the images table:
您可以使用该 `glance-manage` 工具从除图像表之外的所有表中清除软删除的行：

```
glance-manage db purge
```

This command takes two optional parameters:
此命令采用两个可选参数：

- --age_in_days NUM

  Only purge rows that have been deleted for longer than *NUM* days.  The default is 30 days. 仅清除删除时间超过 NUM 天数的行。默认值为 30 天。

- --max_rows NUM

  Purge a maximum of *NUM* rows from each table. The default is 100. All deleted rows are purged if equals -1 从每个表中清除最多 NUM 行。默认值为 100。如果等于 -1，则清除所有已删除的行

### Purging the Images Table 清除图像表 ¶

Remember that image identifiers are used by other OpenStack services that require access to images.  These services expect that when an image is requested by ID, they will receive the same data every time.  When the **images** table is purged of its soft-deleted rows, Glance loses its memory that those image IDs were ever mapped to some particular payload. Thus, care must be taken in purging the **images** table.  We recommend that it be done much less frequently than the “regular” purge operation.
请记住，映像标识符由需要访问映像的其他 OpenStack 服务使用。这些服务期望当 ID 请求图像时，它们每次都会收到相同的数据。当图像表中的软删除行被清除时，Glance  会失去这些图像 ID 映射到某个特定有效负载的记忆。因此，在清除图像表时必须小心。我们建议其执行频率远低于“常规”清除操作。

Use the following command to purge the images table:
使用以下命令清除图像表：

```
glance-manage db purge_images_table
```

Be sure you have read and understood the implications of [OSSN-0075](https://wiki.openstack.org/wiki/OSSN/OSSN-0075) before you use this command, which purges the soft-deleted rows from the images table.
在使用此命令之前，请确保您已阅读并理解 OSSN-0075 的含义，该命令会从图像表中清除软删除的行。

It takes two optional parameters:
它需要两个可选参数：

- --age_in_days NUM

  Only purge rows that have been deleted for longer than *NUM* days.  The default is 180 days. 仅清除删除时间超过 NUM 天数的行。默认值为 180 天。

- --max_rows NUM

  Purge a maximum of *NUM* rows from the **images** table. The default is 100. All deleted rows are purged if equals -1 从图像表中清除最多 NUM 行。默认值为 100。如果等于 -1，则清除所有已删除的行

It is possible for this command to fail with an IntegrityError saying something like “Cannot delete or update a parent row: a foreign key constraint fails”.  This can happen when you try to purge records from the **images** table when related records have not yet been purged from other tables.  The `purge_images_table` command should only be issued after all related information has been purged using the “regular” `purge` command.
此命令可能会失败，并显示 IntegrityError，提示类似“无法删除或更新父行：外键约束失败”。当您尝试从图像表中清除记录时，如果相关记录尚未从其他表中清除，则可能会发生这种情况。只有在使用“常规” `purge` 命令清除所有相关信息后，才应发出该 `purge_images_table` 命令。

# Legacy Database Management 传统数据库管理

​                                  





 

Note 注意



This page applies only to Glance releases prior to Ocata.  From Ocata onward, please see [Database Management](https://docs.openstack.org/glance/2023.2/admin/db.html#database-management).
此页面仅适用于 Ocata 之前的 Glance 版本。从 Ocata 开始，请参阅数据库管理。

The default metadata driver for Glance uses sqlalchemy, which implies there exists a backend database which must be managed. The `glance-manage` binary provides a set of commands for making this easier.
Glance 的默认元数据驱动程序使用 sqlalchemy，这意味着存在一个必须管理的后端数据库。 `glance-manage` 二进制文件提供了一组命令来简化此操作。

The commands should be executed as a subcommand of ‘db’:
这些命令应作为 'db' 的子命令执行：

```
glance-manage db <cmd> <args>
```

## Sync the Database 同步数据库 ¶

```
glance-manage db sync <version> <current_version>
```

Place a database under migration control and upgrade, creating it first if necessary.
将数据库置于迁移控制和升级之下，如有必要，请先创建它。

## Determining the Database Version 确定数据库版本 ¶

```
glance-manage db version
```

This will print the current migration level of a Glance database.
这将打印 Glance 数据库的当前迁移级别。

## Upgrading an Existing Database 升级现有数据库 ¶

```
glance-manage db upgrade <VERSION>
```

This will take an existing database and upgrade it to the specified VERSION.
这将获取现有数据库并将其升级到指定的 VERSION。

## Downgrading an Existing Database 降级现有数据库 ¶

Upgrades involve complex operations and can fail. Before attempting any upgrade, you should make a full database backup of your production data. As of Kilo, database downgrades are not supported, and the only method available to get back to a prior database version is to restore from backup[1].
升级涉及复杂的操作，并且可能会失败。在尝试任何升级之前，应对生产数据进行完整数据库备份。从 Kilo 开始，数据库降级不受支持，恢复到以前的数据库版本的唯一方法是从备份中恢复[1]。

[1]: https://wiki.openstack.org/wiki/OpsGuide/Operational_Upgrades#perform-a-backup

[1]：https://wiki.openstack.org/wiki/OpsGuide/Operational_Upgrades#perform-a-backup

# Zero-Downtime Database Upgrades 零停机数据库升级

​                                  





 

Warning 警告



This feature is EXPERIMENTAL in the Ocata, Pike and Queens releases. We encourage operators to try it out, but its use in production environments is currently NOT SUPPORTED.
此功能在 Ocata、Pike 和 Queens 版本中是实验性的。我们鼓励操作员尝试一下，但目前不支持在生产环境中使用它。

A *zero-downtime database upgrade* enables true rolling upgrades of the Glance nodes in your cloud’s control plane.  At the appropriate point in the upgrade, you can have a mixed deployment of release *n* (for example, Ocata) and release *n-1* (for example, Newton) Glance nodes, take the *n-1* release nodes out of rotation, allow them to drain, and then take them out of service permanently, leaving all Glance nodes in your cloud at release *n*.
零停机数据库升级可实现云控制平面中 Glance 节点的真正滚动升级。在升级的适当位置，您可以混合部署版本 n（例如 Ocata）和版本 n-1（例如 Newton）Glance 节点，将 n-1 版本节点从轮换中取出，允许它们耗尽，然后将它们永久停止服务，将所有 Glance 节点留在云中，使其在版本 n 时保留。

That’s a rough sketch of how a rolling upgrade would work.  For full details, see [Rolling Upgrades](https://docs.openstack.org/glance/2023.2/admin/rollingupgrades.html#rolling-upgrades).
这是滚动升级如何工作的粗略草图。有关完整详细信息，请参阅滚动升级。



 

Note 注意



When we speak of a “database upgrade”, we are simply talking about changing the database schema and its data from the version used in OpenStack release *n* (say, Pike) to the version used in OpenStack release *n+1* (say, Queens).  We are **not** talking about upgrading the database management software.
当我们谈到“数据库升级”时，我们只是在谈论将数据库模式及其数据从 OpenStack 版本 n 中使用的版本（比如 Pike）更改为 OpenStack 版本 n+1 中使用的版本（比如 Queens）。我们不是在谈论升级数据库管理软件。



 

Note 注意



Downgrading a database is not supported.  See [Downgrading an Existing Database](https://docs.openstack.org/glance/2023.2/admin/db.html#downgrades) for more information.
不支持降级数据库。有关详细信息，请参阅降级现有数据库。

## The Expand-Migrate-Contract Cycle 扩展-迁移-合同循环 ¶

It’s possible to characterize three phases of a database upgrade:
可以描述数据库升级的三个阶段：

1. **Expand**: in this phase, new columns, tables, indexes, are added to the database.
   扩展：在此阶段，将新列、表、索引添加到数据库中。
2. **Migrate**: in this phase, data is migrated to the new columns or tables.
   迁移：在此阶段，数据将迁移到新列或表。
3. **Contract**: in this phase, the “old” tables or columns (which are no longer in use) are removed from the database.
   协定：在此阶段，将从数据库中删除“旧”表或列（不再使用）。

The “legacy” Glance database migrations performed these phases as part of a single monolithic upgrade script.  Currently, the Glance project creates a separate script for each the three parts of the cycle.  We call such an upgrade an **E-M-C** database migration.
“传统”Glance 数据库迁移作为单个整体式升级脚本的一部分执行这些阶段。目前，Glance 项目为循环的三个部分创建一个单独的脚本。我们将这种升级称为 E-M-C 数据库迁移。

## Zero-Downtime Database Upgrade 零宕机数据库升级 ¶

The E-M-C strategy can be performed offline when Glance is not using the database.  With some adjustments, however, the E-M-C strategy can be applied online when the database is in use, making true rolling upgrades possible.
当 Glance 不使用数据库时，可以脱机执行 E-M-C 策略。但是，通过一些调整，E-M-C策略可以在数据库使用时在线应用，从而实现真正的滚动升级。



 

Note 注意



Don’t forget that zero-downtime database upgrades are currently considered experimental and their use in production environments is NOT SUPPORTED.
不要忘记，零停机时间数据库升级目前被认为是实验性的，不支持在生产环境中使用它们。

A zero-downtime database upgrade takes place as part of a [rolling upgrade strategy](https://docs.openstack.org/glance/2023.2/admin/rollingupgrades.html#rolling-upgrades) for upgrading your entire Glance installation.  In such a situation, you want to upgrade to release *n* of Glance (say, Queens) while your release *n-1* API nodes are still running Pike.  To make this possible, in the **Expand** phase, database triggers can be added to the database to keep the data in “old” and “new” columns synchronized.  Likewise, after all data has been migrated and all Glance nodes have been updated to release *n* code, these triggers are deleted in the **Contract** phase.
零停机数据库升级是升级整个 Glance 安装的滚动升级策略的一部分。在这种情况下，您希望升级到 Glance 的 n 版（例如，Queens），而您的 n-1 版  API 节点仍在运行  Pike。为此，在“展开”阶段，可以将数据库触发器添加到数据库中，以保持“旧”和“新”列中的数据同步。同样，在迁移所有数据并更新所有  Glance 节点以发布 n 代码后，这些触发器将在 Contract 阶段删除。



 

Note 注意



Unlike the E-M-C scripts, database triggers are particular to each database technology.  That’s why the Glance project currently provides experimental support only for MySQL.
与 E-M-C 脚本不同，数据库触发器特定于每种数据库技术。这就是为什么 Glance 项目目前只提供对 MySQL 的实验性支持。

## New Database Version Identifiers 新的数据库版本标识符 ¶

In order to perform zero-downtime upgrades, the version identifier of a database becomes more complicated since it must reflect knowledge of what point in the E-M-C cycle the upgrade has reached.  To make this evident, the identifier explicitly contains ‘expand’ or ‘contract’ as part of its name.
为了执行零停机升级，数据库的版本标识符变得更加复杂，因为它必须反映升级已达到 E-M-C 周期中哪个点的知识。为了清楚地表明这一点，标识符明确包含“expand”或“contract”作为其名称的一部分。

Thus the Ocata cycle migration has two identifiers associated with it: `ocata_expand01` and `ocata_contract01`.
因此，Ocata 循环迁移有两个与之关联的标识符： `ocata_expand01` 和 `ocata_contract01` 。

During the upgrade process, the database is initially marked with `ocata_expand01`.  Eventually, after completing the full upgrade process, the database will be marked with `ocata_contract01`. So, instead of one database version, an operator will see a composite database version that will have both expand and contract versions.  A database will be considered at Ocata version only when both expand and contract revisions are at the latest revisions.  For a successful Ocata zero-downtime upgrade, for example, the database will be marked with both `ocata_expand01`, `ocata_contract01`.
在升级过程中，数据库最初标记为 `ocata_expand01` 。最终，在完成完整升级过程后，数据库将标记为 `ocata_contract01` 。因此，操作员将看到一个复合数据库版本，而不是一个数据库版本，该版本将同时具有扩展版本和收缩版本。只有当扩展和合同修订都是最新修订时，才会考虑在 Ocata 版本中使用数据库。例如，对于成功的 Ocata 零停机时间升级，数据库将同时标记为 `ocata_expand01` ， `ocata_contract01` 。

In the case in which there are multiple changes in a cycle, the database version record would go through the following progression:
如果一个周期中有多个更改，则数据库版本记录将经历以下进程：

| stage 阶段 | database identifier 数据库标识符   | comment 评论                               |
| ---------- | ---------------------------------- | ------------------------------------------ |
| E          | `bexar_expand01`                   | upgrade begins 升级开始                    |
| E          | `bexar_expand02`                   |                                            |
| E          | `bexar_expand03`                   |                                            |
| M          | `bexar_expand03`                   | bexar_migrate01 occurs 发生bexar_migrate01 |
| M          | `bexar_expand03`                   | bexar_migrate02 occurs 发生bexar_migrate02 |
| M          | `bexar_expand03`                   | bexar_migrate03 occurs 发生bexar_migrate03 |
| C          | `bexar_expand03, bexar_contract01` |                                            |
| C          | `bexar_expand03, bexar_contract02` |                                            |
| C          | `bexar_expand03, bexar_contract03` | upgrade completed 升级完成                 |

## Database Upgrade 数据库升级 ¶

For offline database upgrades, the `glance-manage` tool still has the `glance-manage db sync` command.  This command will execute the expand, migrate, and contract scripts for you, just as if they were contained in a single script.
对于脱机数据库升级，该 `glance-manage` 工具仍具有该 `glance-manage db sync` 命令。此命令将为您执行扩展、迁移和收缩脚本，就像它们包含在单个脚本中一样。

In order to enable zero-downtime database upgrades, the `glance-manage` tool has been augmented to include the following operations so that you can explicitly manage the upgrade.
为了实现零停机数据库升级，该 `glance-manage` 工具已得到增强，包括以下操作，以便您可以显式管理升级。



 

Warning 警告



For MySQL, using the `glance-manage db expand` or `glance-manage db contract` command requires that you either grant your glance user `SUPER` privileges, or run `set global log_bin_trust_function_creators=1;` in mysql beforehand.
对于 MySQL，使用 `glance-manage db expand` or `glance-manage db contract` 命令需要您授予 glance 用户 `SUPER` 权限，或者事先在 mysql 中运行 `set global log_bin_trust_function_creators=1;` 。

### Expanding the Database 扩展数据库 ¶

```
glance-manage db expand
```

This will run the expansion phase of a rolling upgrade process.  Database expansion should be run as the first step in the rolling upgrade process before any new services are started.
这将运行滚动升级过程的扩展阶段。在启动任何新服务之前，数据库扩展应作为滚动升级过程的第一步运行。

### Migrating the Data 迁移数据 ¶

```
glance-manage db migrate
```

This will run the data migrate phase of a rolling upgrade process.  Database migration should be run after database expansion but before any new services are started.
这将运行滚动升级过程的数据迁移阶段。数据库迁移应在数据库扩展之后运行，但在启动任何新服务之前运行。

### Contracting the Database 承包数据库 ¶

```
glance-manage db contract
```

This will run the contraction phase of a rolling upgrade process. Database contraction should be run as the last step of the rolling upgrade process after all old services are upgraded to new ones.
这将运行滚动升级过程的收缩阶段。在所有旧服务升级到新服务后，数据库收缩应作为滚动升级过程的最后一步运行。

# Rolling Upgrades 滚动升级

​                                  





 

Note 注意



The Rolling Upgrades feature is EXPERIMENTAL and its use in production systems is currently **not supported**.
滚动升级功能是实验性的，目前不支持在生产系统中使用。

This statement remains true for the Queens release of Glance.  What is the holdup, you ask?  Before asserting that the feature is fully supported, the Glance team needs to have automated tests that perform rolling upgrades in the OpenStack Continuous Integration gates.  The Glance project team has not had sufficient testing and development resources in recent cycles to prioritize this work.
这句话在皇后区发布的 Glance 中仍然适用。你问什么是滞留？在断言该功能完全受支持之前，Glance 团队需要进行自动化测试，以便在 OpenStack  持续集成入口中执行滚动升级。在最近的周期中，Glance 项目团队没有足够的测试和开发资源来优先考虑这项工作。

The Glance project team is committed to the stability of Glance.  As part of OpenStack, we are committed to [The Four Opens](https://governance.openstack.org/tc/reference/opens.html).  If the ability to perform rolling upgrades in production systems is important to you, feel free to participate in the Glance community to help coordinate and drive such an effort.  (We gently remind you that “participation” includes providing testing and development resources.)
Glance 项目团队致力于 Glance  的稳定性。作为OpenStack的一部分，我们致力于“四个开放”。如果在生产系统中执行滚动升级的能力对您很重要，请随时加入 Glance  社区，以帮助协调和推动此类工作。（我们委婉地提醒您，“参与”包括提供测试和开发资源。

## Scope of this document 本文档的范围 ¶

This page describes one way to perform a rolling upgrade from Newton to Ocata for a particular configuration of Glance services.  There may be other ways to perform a rolling upgrade from Newton to Ocata for other configurations of Glance services, but those are beyond the scope of this document.  For the experimental rollout of rolling upgrades, we describe only the following simple case.
本页介绍了针对 Glance 服务的特定配置执行从 Newton 到 Ocata 的滚动升级的一种方法。对于 Glance  服务的其他配置，可能还有其他方法可以执行从 Newton 到 Ocata  的滚动升级，但这些方法超出了本文档的范围。对于滚动升级的实验性推出，我们仅介绍以下简单情况。

## Prerequisites 先决条件 ¶

- MySQL/MariaDB 5.5 or later
  MySQL/MariaDB 5.5 或更高版本
- Glance running Images API v2 only
  仅运行 Images API v2 的 Glance
- Glance not using the Glance Registry
  Glance 未使用 Glance 注册表
- Multiple Glance nodes 多个 Glance 节点
- A load balancer or some other type of redirection device is being used in front of the Glance nodes in such a way that a node can be dropped out of rotation, that is, that Glance node continues running the Glance service but is no longer having requests routed to it
  负载平衡器或某种其他类型的重定向设备正在 Glance 节点前面使用，这样就可以将节点从轮换中丢弃，也就是说，Glance 节点继续运行 Glance 服务，但不再将请求路由到它

## Procedure 操作步骤 ¶

Following is the process to upgrade Glance with zero downtime:
以下是在零停机时间的情况下升级 Glance 的过程：

1. Backup the Glance database.
   备份 Glance 数据库。
2. Choose an arbitrary Glance node or provision a new node to install the new release. If an existing Glance node is chosen, gracefully stop the Glance services.  In what follows, this node will be referred to as the NEW NODE.
   选择任意 Glance 节点或预置新节点以安装新版本。如果选择了现有的 Glance 节点，请正常停止 Glance 服务。在下文中，此节点将被称为 NEW NODE。



 

Note 注意



**Gracefully stopping services
正常停止服务**

Before stopping the Glance processes on a node, one may choose to wait until all the existing connections drain out. This could be achieved by taking the node out of rotation, that is, by ensuring that requests are no longer routed to that node. This way all the requests that are currently being processed will get a chance to finish processing.  However, some Glance requests like uploading and downloading images may last a long time. This increases the wait time to drain out all connections and consequently the time to upgrade Glance completely.  On the other hand, stopping the Glance services before the connections drain out will present the user with errors. While arguably this is not downtime given that Images API requests are continually being serviced by other nodes, this is nonetheless an unpleasant user experience for the user whose in-flight request has terminated in an error.  Hence, an operator must be judicious when stopping the services.
在停止节点上的 Glance  进程之前，可以选择等到所有现有连接耗尽。这可以通过使节点退出轮换来实现，即确保请求不再路由到该节点。这样，当前正在处理的所有请求都有机会完成处理。但是，某些 Glance 请求（如上传和下载图像）可能会持续很长时间。这增加了耗尽所有连接的等待时间，从而增加了完全升级 Glance  的时间。另一方面，在连接耗尽之前停止 Glance 服务会给用户带来错误。虽然可以说这不是停机时间，因为图像 API  请求不断由其他节点提供服务，但对于正在进行的请求因错误终止的用户来说，这仍然是一种不愉快的用户体验。因此，运营商在停止服务时必须谨慎行事。

1. Upgrade the NEW NODE with new release and update the configuration accordingly.  **DO NOT** start the Glance services on the NEW NODE at this time.
   使用新版本升级 NEW NODE，并相应地更新配置。此时不要在 NEW NODE 上启动 Glance 服务。

2. Using the NEW NODE, expand the database using the command:
   使用 NEW NODE，使用以下命令展开数据库：

   ```
   glance-manage db expand
   
   .. warning::
   
    For MySQL, using the ``glance-manage db_expand`` command requires that
    you either grant your glance user ``SUPER`` privileges, or run
    ``set global log_bin_trust_function_creators=1;`` in mysql beforehand.
   ```

3. Then, also on the NEW NODE, perform the data migrations using the command:
   然后，同样在 NEW NODE 上，使用以下命令执行数据迁移：

   ```
   glance-manage db migrate
   ```

   *The data migrations must be completed before you proceed to the next step.
   必须先完成数据迁移，然后才能继续下一步。*

4. Start the Glance processes on the NEW NODE.  It is now ready to receive traffic from the load balancer.
   在 NEW NODE 上启动 Glance 进程。现在，它已准备好接收来自负载均衡器的流量。

5. Taking one node at a time from the remaining nodes, for each node:
   从其余节点中一次选取一个节点，对于每个节点：

   1. [Stop the Glance processes gracefully](https://docs.openstack.org/glance/2023.2/admin/rollingupgrades.html#stop-the-glance-processes-gracefully) as described in Step 2, above. *Do not proceed until the “old” Glance services on the node have been completely shut down.*
      按照上面的步骤 2 中所述，正常停止 Glance 进程。在节点上的“旧”Glance 服务完全关闭之前，不要继续。
   2. Upgrade the node to the new release (and corresponding configuration).
      将节点升级到新版本（以及相应的配置）。
   3. Start the updated Glance processes on the upgraded node.
      在升级后的节点上启动更新的 Glance 进程。

6. After **ALL** of the nodes have been upgraded to run the new Glance services, and there are **NO** nodes running any old Glance services, contract the database by running the command from any one of the upgraded nodes:
   在升级所有节点以运行新的 Glance 服务，并且没有节点运行任何旧的 Glance 服务后，通过从任何一个升级的节点运行命令来收缩数据库：

   ```
   glance-manage db contract
   ```

# Images and instances 映像和实例

​                                  

Virtual machine images contain a virtual disk that holds a bootable operating system on it. Disk images provide templates for virtual machine file systems. The Image service controls image storage and management.
虚拟机映像包含一个虚拟磁盘，该虚拟磁盘上保存着可启动的操作系统。磁盘映像为虚拟机文件系统提供模板。影像服务控制影像的存储和管理。

Instances are the individual virtual machines that run on physical compute nodes inside the cloud. Users can launch any number of instances from the same image. Each launched instance runs from a copy of the base image. Any changes made to the instance do not affect the base image. Snapshots capture the state of an instances running disk. Users can create a snapshot, and build a new image based on these snapshots. The Compute service controls instance, image, and snapshot storage and management.
实例是在云中的物理计算节点上运行的单个虚拟机。用户可以从同一映像启动任意数量的实例。每个启动的实例都从基础映像的副本运行。对实例所做的任何更改都不会影响基础映像。快照捕获运行磁盘的实例的状态。用户可以创建快照，并基于这些快照构建新映像。计算服务控制实例、映像和快照的存储和管理。

When you launch an instance, you must choose a `flavor`, which represents a set of virtual resources. Flavors define virtual CPU number, RAM amount available, and ephemeral disks size. Users must select from the set of available flavors defined on their cloud. OpenStack provides a number of predefined flavors that you can edit or add to.
启动实例时，必须选择一个 `flavor` ，它表示一组虚拟资源。规格定义虚拟 CPU 数量、可用 RAM 量和临时磁盘大小。用户必须从其云上定义的可用风格集中进行选择。OpenStack 提供了许多预定义的风格，您可以编辑或添加这些风格。



 

Note 注意



- For more information about creating and troubleshooting images, see the [OpenStack Virtual Machine Image Guide](https://docs.openstack.org/image-guide/).
  有关创建映像和故障排除的更多信息，请参阅《OpenStack 虚拟机映像指南》。
- For more information about image configuration options, see the [Image services](https://docs.openstack.org/glance/2023.2/configuration/index.html) section of the OpenStack Configuration Reference.
  有关映像配置选项的更多信息，请参阅《OpenStack 配置参考》的“映像服务”部分。

You can add and remove additional resources from running instances, such as persistent volume storage, or public IP addresses. The example used in this chapter is of a typical virtual system within an OpenStack cloud. It uses the `cinder-volume` service, which provides persistent block storage, instead of the ephemeral storage provided by the selected instance flavor.
您可以在正在运行的实例中添加和删除其他资源，例如永久性卷存储或公有 IP 地址。本章中使用的示例是 OpenStack 云中的典型虚拟系统。它使用提供持久性块存储 `cinder-volume` 的服务，而不是所选实例风格提供的临时存储。

This diagram shows the system state prior to launching an instance. The image store has a number of predefined images, supported by the Image service. Inside the cloud, a compute node contains the available vCPU, memory, and local disk resources. Additionally, the `cinder-volume` service stores predefined volumes.
此图显示了启动实例之前的系统状态。映像存储具有许多预定义的映像，这些映像受映像服务支持。在云中，计算节点包含可用的 vCPU、内存和本地磁盘资源。此外，该 `cinder-volume` 服务还存储预定义的卷。

**The base image state with no running instances
没有正在运行的实例的基本映像状态**

![../_images/instance-life-1.png](https://docs.openstack.org/glance/2023.2/_images/instance-life-1.png)

## Instance Launch 实例启动 ¶

To launch an instance, select an image, flavor, and any optional attributes. The selected flavor provides a root volume, labeled `vda` in this diagram, and additional ephemeral storage, labeled `vdb`. In this example, the `cinder-volume` store is mapped to the third virtual disk on this instance, `vdc`.
要启动实例，请选择映像、特定实例和任何可选属性。所选变种提供根卷（在此图中标记为 `vda` ）和附加的临时存储（标记为 `vdb` ）。在此示例中， `cinder-volume` 存储映射到此实例上的第三个虚拟磁盘 `vdc` 。

**Instance creation from an image
从映像创建实例**

![../_images/instance-life-2.png](https://docs.openstack.org/glance/2023.2/_images/instance-life-2.png)

The Image service copies the base image from the image store to the local disk. The local disk is the first disk that the instance accesses, which is the root volume labeled `vda`. Smaller instances start faster. Less data needs to be copied across the network.
镜像服务将基础镜像从镜像存储复制到本地磁盘。本地磁盘是实例访问的第一个磁盘，即标记为 `vda` 的根卷。较小的实例启动速度更快。需要通过网络复制的数据更少。

The new empty ephemeral disk is also created, labeled `vdb`. This disk is deleted when you delete the instance.
还会创建新的空临时磁盘，标记为 `vdb` 。当您删除实例时，此磁盘将被删除。

The compute node connects to the attached `cinder-volume` using iSCSI. The `cinder-volume` is mapped to the third disk, labeled `vdc` in this diagram. After the compute node provisions the vCPU and memory resources, the instance boots up from root volume `vda`. The instance runs and changes data on the disks (highlighted in red on the diagram). If the volume store is located on a separate network, the `my_block_storage_ip` option specified in the storage node configuration file directs image traffic to the compute node.
计算节点使用 iSCSI 连接到连接 `cinder-volume` 节点。映射 `cinder-volume` 到第三个磁盘， `vdc` 在此图中标记。计算节点预置 vCPU 和内存资源后，实例将从根卷 `vda` 启动。实例运行并更改磁盘上的数据（在图中以红色突出显示）。如果卷存储位于单独的网络上，则存储节点配置文件中指定的 `my_block_storage_ip` 选项会将映像流量定向到计算节点。



 

Note 注意



Some details in this example scenario might be different in your environment. For example, you might use a different type of back-end storage, or different network protocols. One common variant is that the ephemeral storage used for volumes `vda` and `vdb` could be backed by network storage rather than a local disk.
此示例方案中的某些详细信息在您的环境中可能会有所不同。例如，可以使用不同类型的后端存储或不同的网络协议。一种常见的变体是用于卷 `vda` 的临时存储， `vdb` 可以由网络存储而不是本地磁盘提供支持。

When you delete an instance, the state is reclaimed with the exception of the persistent volume. The ephemeral storage, whether encrypted or not, is purged. Memory and vCPU resources are released. The image remains unchanged throughout this process.
当您删除实例时，将回收状态，但持久卷除外。临时存储（无论是否加密）都会被清除。释放内存和 vCPU 资源。图像在整个过程中保持不变。

**The end state of an image and volume after the instance exits
实例退出后映像和卷的结束状态**

![../_images/instance-life-3.png](https://docs.openstack.org/glance/2023.2/_images/instance-life-3.png)

## Image properties and property protection 图片属性和属性保护 ¶

An image property is a key and value pair that the administrator or the image owner attaches to an OpenStack Image service image, as follows:
镜像属性是管理员或镜像所有者附加到 OpenStack 镜像服务镜像的键值对，如下所示：

- The administrator defines core properties, such as the image name.
  管理员定义核心属性，例如映像名称。
- The administrator and the image owner can define additional properties, such as licensing and billing information.
  管理员和映像所有者可以定义其他属性，例如许可和计费信息。

The administrator can configure any property as protected, which limits which policies or user roles can perform CRUD operations on that property. Protected properties are generally additional properties to which only administrators have access. Further, Glance itself reserves properties namespaced with the `os_glance` prefix for its own use.
管理员可以将任何属性配置为受保护，从而限制哪些策略或用户角色可以对该属性执行 CRUD 操作。受保护的属性通常是只有管理员才能访问的其他属性。此外，Glance 本身保留带有 `os_glance` 前缀的命名空间的属性供自己使用。

For unprotected image properties, the administrator can manage core properties and the image owner can manage additional properties.
对于未受保护的映像属性，管理员可以管理核心属性，映像所有者可以管理其他属性。

**To configure property protection
配置属性保护**

To configure property protection, edit the `policy.yaml` file. This file can also be used to set policies for Image service actions.
若要配置属性保护，请编辑 `policy.yaml` 文件。此文件还可用于设置影像服务操作的策略。

1. Define roles or policies in the `policy.yaml` file:
   在 `policy.yaml` 文件中定义角色或策略：

   ```
   {
       "context_is_admin":  "role:admin",
       "default": "",
   
       "add_image": "",
       "delete_image": "",
       "get_image": "",
       "get_images": "",
       "modify_image": "",
       "publicize_image": "role:admin",
       "copy_from": "",
   
       "download_image": "",
       "upload_image": "",
   
       "delete_image_location": "",
       "get_image_location": "",
       "set_image_location": "",
   
       "add_member": "",
       "delete_member": "",
       "get_member": "",
       "get_members": "",
       "modify_member": "",
   
       "manage_image_cache": "role:admin",
   
       "get_task": "",
       "get_tasks": "",
       "add_task": "",
       "modify_task": "",
   
       "deactivate": "",
       "reactivate": "",
   
       "get_metadef_namespace": "",
       "get_metadef_namespaces":"",
       "modify_metadef_namespace":"",
       "add_metadef_namespace":"",
       "delete_metadef_namespace":"",
   
       "get_metadef_object":"",
       "get_metadef_objects":"",
       "modify_metadef_object":"",
       "add_metadef_object":"",
       "delete_metadef_object":"",
   
       "list_metadef_resource_types":"",
       "get_metadef_resource_type":"",
       "add_metadef_resource_type_association":"",
       "remove_metadef_resource_type_association":"",
   
       "get_metadef_property":"",
       "get_metadef_properties":"",
       "modify_metadef_property":"",
       "add_metadef_property":"",
       "remove_metadef_property":"",
   
       "get_metadef_tag":"",
       "get_metadef_tags":"",
       "modify_metadef_tag":"",
       "add_metadef_tag":"",
       "add_metadef_tags":"",
       "delete_metadef_tag":"",
       "delete_metadef_tags":""
    }
   ```

   For each parameter, use `"rule:restricted"` to restrict access to all users or `"role:admin"` to limit access to administrator roles. For example:
   对于每个参数，用于 `"rule:restricted"` 限制对所有用户的访问或 `"role:admin"` 限制对管理员角色的访问。例如：

   ```
   {
       "download_image":
       "upload_image":
   }
   ```

2. Define which roles or policies can manage which properties in a property protections configuration file. For example:
   定义哪些角色或策略可以管理属性保护配置文件中的哪些属性。例如：

   ```
   [x_none_read]
   create = context_is_admin
   read = !
   update = !
   delete = !
   
   [x_none_update]
   create = context_is_admin
   read = context_is_admin
   update = !
   delete = context_is_admin
   
   [x_none_delete]
   create = context_is_admin
   read = context_is_admin
   update = context_is_admin
   delete = !
   ```

   - A value of `@` allows the corresponding operation for a property.
     值 `@` 允许对属性进行相应的操作。
   - A value of `!` disallows the corresponding operation for a property.
     值 `!` 不允许对属性执行相应的操作。

3. In the `glance-api.conf` file, define the location of a property protections configuration file.
   在 `glance-api.conf` 文件中，定义属性保护配置文件的位置。

   ```
   property_protection_file = {file_name}
   ```

   This file contains the rules for property protections and the roles and policies associated with it.
   此文件包含属性保护规则以及与之关联的角色和策略。

   By default, property protections are not enforced.
   默认情况下，不强制实施属性保护。

   If you specify a file name value and the file is not found, the `glance-api` service does not start.
   如果指定文件名值，但未找到该文件，则 `glance-api` 服务不会启动。

   To view a sample configuration file, see [glance-api.conf](https://docs.openstack.org/glance/2023.2/configuration/glance_api.html).
   要查看示例配置文件，请参阅 glance-api.conf。

4. Optionally, in the `glance-api.conf` file, specify whether roles or policies are used in the property protections configuration file
   （可选）在 `glance-api.conf` 文件中，指定是否在属性保护配置文件中使用角色或策略

   ```
   property_protection_rule_format = roles
   ```

   The default is `roles`.
   默认值为 `roles` 。

   To view a sample configuration file, see [glance-api.conf](https://docs.openstack.org/glance/2023.2/configuration/glance_api.html).
   要查看示例配置文件，请参阅 glance-api.conf。

## Image download: how it works 图片下载：工作原理 ¶

Prior to starting a virtual machine, transfer the virtual machine image to the compute node from the Image service. How this works can change depending on the settings chosen for the compute node and the Image service.
在启动虚拟机之前，请将虚拟机映像从映像服务传输到计算节点。其工作方式可能会根据为计算节点和映像服务选择的设置而改变。

Typically, the Compute service will use the image identifier passed to it by the scheduler service and request the image from the Image API. Though images are not stored in glance—rather in a back end, which could be Object Storage, a filesystem or any other supported method—the connection is made from the compute node to the Image service and the image is transferred over this connection. The Image service streams the image from the back end to the compute node.
通常，计算服务将使用计划程序服务传递给它的映像标识符，并从映像 API  请求映像。虽然图像不是存储在一目了然的中，而是存储在后端，可以是对象存储、文件系统或任何其他支持的方法，但从计算节点到映像服务的连接是建立的，并且映像通过此连接传输。镜像服务将镜像从后端流式传输到计算节点。

It is possible to set up the Object Storage node on a separate network, and still allow image traffic to flow between the compute and object storage nodes. Configure the `my_block_storage_ip` option in the storage node configuration file to allow block storage traffic to reach the compute node.
可以在单独的网络上设置对象存储节点，并且仍然允许图像流量在计算节点和对象存储节点之间流动。在存储节点配置文件中配置该 `my_block_storage_ip` 选项，以允许块存储流量到达计算节点。

Certain back ends support a more direct method, where on request the Image service will return a URL that links directly to the back-end store. You can download the image using this approach. Currently, the only store to support the direct download approach is the filesystem store. Configured the approach using the `filesystems` option in the `image_file_url` section of the `nova.conf` file on compute nodes.
某些后端支持更直接的方法，其中图像服务将根据请求返回直接链接到后端存储的 URL。您可以使用此方法下载映像。目前，唯一支持直接下载方法的存储是文件系统存储。使用 `nova.conf` 计算节点上文件 `image_file_url` 部分中的 `filesystems` 选项配置了该方法。

Compute nodes also implement caching of images, meaning that if an image has been used before it won’t necessarily be downloaded every time. Information on the configuration options for caching on compute nodes can be found in the [Configuration Reference](https://docs.openstack.org/glance/2023.2/configuration/).
计算节点还实现了图像缓存，这意味着如果之前使用过图像，则不一定每次都下载它。有关计算节点上缓存的配置选项的信息，请参阅配置参考。

## Instance building blocks 实例构建块 ¶

In OpenStack, the base operating system is usually copied from an image stored in the OpenStack Image service. This results in an ephemeral instance that starts from a known template state and loses all accumulated states on shutdown.
在 OpenStack 中，基本操作系统通常是从存储在 OpenStack 镜像服务中的镜像中复制的。这会导致一个临时实例从已知模板状态开始，并在关闭时丢失所有累积状态。

You can also put an operating system on a persistent volume in Compute or the Block Storage volume system. This gives a more traditional, persistent system that accumulates states that are preserved across restarts. To get a list of available images on your system, run:
您还可以将操作系统放在计算或块存储卷系统中的持久卷上。这提供了一个更传统、更持久的系统，该系统会累积在重新启动时保留的状态。要获取系统上可用映像的列表，请运行：

```
glance image-list
+--------------------------------------+-----------------------------+
| ID                                   | Name                        |
+--------------------------------------+-----------------------------+
| aee1d242-730f-431f-88c1-87630c0f07ba | Ubuntu 14.04 cloudimg amd64 |
+--------------------------------------+-----------------------------+
| 0b27baa1-0ca6-49a7-b3f4-48388e440245 | Ubuntu 14.10 cloudimg amd64 |
+--------------------------------------+-----------------------------+
| df8d56fc-9cea-4dfd-a8d3-28764de3cb08 | jenkins                     |
+--------------------------------------+-----------------------------+
```

The displayed image attributes are:
显示的图像属性为：

- `ID`

  Automatically generated or user provided UUID of the image. 自动生成或用户提供的映像 UUID。

- `Name`

  Free form, human-readable name for the image. 自由形式，图像的人类可读名称。

Virtual hardware templates are called `flavors`, and are defined by administrators. Prior to the Newton release, a default installation also includes five predefined flavors.
虚拟硬件模板称为 `flavors` ，由管理员定义。在 Newton 版本之前，默认安装还包括五种预定义的风格。

For a list of flavors that are available on your system, run:
有关系统上可用的风格列表，请运行：

```
openstack flavor list
+-----+-----------+-------+------+-----------+-------+-----------+
| ID  | Name      |   RAM | Disk | Ephemeral | VCPUs | Is_Public |
+-----+-----------+-------+------+-----------+-------+-----------+
| 1   | m1.tiny   |   512 |    1 |         0 |     1 | True      |
| 2   | m1.small  |  2048 |   20 |         0 |     1 | True      |
| 3   | m1.medium |  4096 |   40 |         0 |     2 | True      |
| 4   | m1.large  |  8192 |   80 |         0 |     4 | True      |
| 5   | m1.xlarge | 16384 |  160 |         0 |     8 | True      |
+-----+-----------+-------+------+-----------+-------+-----------+
```

By default, administrative users can configure the flavors. You can change this behavior by redefining the access controls for `compute_extension:flavormanage` in `/etc/nova/policy.yaml` on the `compute-api` server.
默认情况下，管理用户可以配置特定实例。您可以通过在 `compute-api` 服务器上重新定义 `compute_extension:flavormanage` in `/etc/nova/policy.yaml` 的访问控制来更改此行为。

## Instance management tools 实例管理工具 ¶

OpenStack provides command-line, web interface, and API-based instance management tools. Third-party management tools are also available, using either the native API or the provided EC2-compatible API.
OpenStack 提供命令行、Web 界面和基于 API 的实例管理工具。第三方管理工具也可用，使用本机 API 或提供的 EC2 兼容 API。

The OpenStack python-openstackclient package provides a basic command-line utility, which uses the **openstack** command. This is available as a native package for most Linux distributions, or you can install the latest version using the pip python package installer:
OpenStack python-openstackclient 软件包提供了一个基本的命令行实用程序，它使用 openstack 命令。这可作为大多数 Linux 发行版的本机包提供，或者您可以使用 pip python 包安装程序安装最新版本：

```
pip install python-openstackclient
```

For more information about python-openstackclient and other command-line tools, see the [OpenStack End User Guide](https://docs.openstack.org/glance/2023.2/cli/index.html).
有关 python-openstackclient 和其他命令行工具的更多信息，请参阅 OpenStack 最终用户指南。

Latest image management tools can be installed using the pip package manager:
可以使用 pip 包管理器安装最新的映像管理工具：

```
pip install python-glanceclient
```

This package provides you the **glance** for managing all your images.
该软件包为您提供了管理所有图像的一目了然。

## Control where instances run 控制实例的运行位置 ¶

The [Scheduling section](https://docs.openstack.org/nova/latest/user/filter-scheduler.html) of OpenStack Configuration Reference provides detailed information on controlling where your instances run, including ensuring a set of instances run on different compute nodes for service resiliency or on the same node for high performance inter-instance communications.
OpenStack 配置参考的 Scheduling 部分提供了有关控制实例运行位置的详细信息，包括确保一组实例在不同的计算节点上运行以实现服务弹性，或在同一节点上运行以实现高性能实例间通信。

Administrative users can specify which compute node their instances run on. To do this, specify the `--availability-zone AVAILABILITY_ZONE:COMPUTE_HOST` parameter.
管理用户可以指定其实例在哪个计算节点上运行。为此，请指定 `--availability-zone AVAILABILITY_ZONE:COMPUTE_HOST` 参数。

## Launch instances with UEFI 使用 UEFI 启动实例 ¶

Unified Extensible Firmware Interface (UEFI) is a standard firmware designed to replace legacy BIOS. There is a slow but steady trend for operating systems to move to the UEFI format and, in some cases, make it their only format.
统一可扩展固件接口 （UEFI） 是一种标准固件，旨在取代传统 BIOS。操作系统向 UEFI 格式移动有一个缓慢但稳定的趋势，在某些情况下，使其成为它们唯一的格式。

**To configure UEFI environment
配置 UEFI 环境**

To successfully launch an instance from an UEFI image in QEMU/KVM environment, the administrator has to install the following packages on compute node:
要在 QEMU/KVM 环境中从 UEFI 映像成功启动实例，管理员必须在计算节点上安装以下软件包：

- OVMF, a port of Intel’s tianocore firmware to QEMU virtual machine.
  OVMF，英特尔的 tianocore 固件到 QEMU 虚拟机的端口。
- libvirt, which has been supporting UEFI boot since version 1.2.9.
  libvirt，自 1.2.9 版本以来一直支持 UEFI 引导。

Because default UEFI loader path is `/usr/share/OVMF/OVMF_CODE.fd`, the administrator must create one link to this location after UEFI package is installed.
由于默认 UEFI 加载程序路径是 `/usr/share/OVMF/OVMF_CODE.fd` ，因此管理员必须在安装 UEFI 包后创建一个指向此位置的链接。

**To upload UEFI images 上传 UEFI 映像**

To launch instances from a UEFI image, the administrator first has to upload one UEFI image. To do so, `hw_firmware_type` property must be set to `uefi` when the image is created. For example:
要从 UEFI 映像启动实例，管理员首先必须上传一个 UEFI 映像。为此， `hw_firmware_type` 必须将 property 设置为创建映像 `uefi` 时。例如：

```
glance image-create-via-import --container-format bare \
  --disk-format qcow2 --property hw_firmware_type=uefi \
  --file /tmp/cloud-uefi.qcow --name uefi
```

After that, you can launch instances from this UEFI image.
之后，您可以从此 UEFI 映像启动实例。

# Manage images 管理映像

​                                  

The cloud operator assigns roles to users. Roles determine who can upload and manage images. The operator might restrict image upload and management to only cloud administrators or operators.
云操作员为用户分配角色。角色决定了谁可以上传和管理图像。运营商可能会将图像上传和管理限制为仅云管理员或操作员。

You can upload images through the **glance image-create** or **glance image-create-via-import** command or the Image service API. You can use the `glance` client for the image management. It provides mechanisms to do all operations supported by the Images API v2.
您可以通过 glance image-create 或 glance image-create-via-import 命令或镜像服务 API 上传图片。您可以使用客户端 `glance` 进行映像管理。它提供了执行映像 API v2 支持的所有操作的机制。

After you upload an image, you cannot change the content, but you can update the metadata.
上传图像后，您无法更改内容，但可以更新元数据。

For details about image creation, see the [Virtual Machine Image Guide](https://docs.openstack.org/image-guide/).
有关镜像创建的详细信息，请参阅《虚拟机镜像指南》。

## List or get details for images (glance) 列出或获取图像的详细信息（一目了然） ¶

To get a list of images and to get further details about a single image, use **glance image-list** and **glance image-show** commands.
要获取图像列表并获取有关单个图像的更多详细信息，请使用 glance image-list 和 glance image-show 命令。

```
glance image-list
+--------------------------------------+---------------------------------+
| ID                                   | Name                            |
+--------------------------------------+---------------------------------+
| dfc1dfb0-d7bf-4fff-8994-319dd6f703d7 | cirros-0.3.5-x86_64-uec         |
| a3867e29-c7a1-44b0-9e7f-10db587cad20 | cirros-0.3.5-x86_64-uec-kernel  |
| 4b916fba-6775-4092-92df-f41df7246a6b | cirros-0.3.5-x86_64-uec-ramdisk |
| d07831df-edc3-4817-9881-89141f9134c3 | myCirrosImage                   |
+--------------------------------------+---------------------------------+
glance image-show d07831df-edc3-4817-9881-89141f9134c3
+------------------+------------------------------------------------------+
| Field            | Value                                                |
+------------------+------------------------------------------------------+
| checksum         | 443b7623e27ecf03dc9e01ee93f67afe                     |
| container_format | ami                                                  |
| created_at       | 2016-08-11T15:07:26Z                                 |
| disk_format      | ami                                                  |
| file             | /v2/images/d07831df-edc3-4817-9881-89141f9134c3/file |
| id               | d07831df-edc3-4817-9881-89141f9134c3                 |
| min_disk         | 0                                                    |
| min_ram          | 0                                                    |
| name             | myCirrosImage                                        |
| os_hash_algo     | sha512                                               |
| os_hash_value    | 6513f21e44aa3da349f248188a44bc304a3653a04122d8fb4535 |
|                  | 423c8e1d14cd6a153f735bb0982e2161b5b5186106570c17a9e5 |
|                  | 8b64dd39390617cd5a350f78                             |
| os_hidden        | False                                                |
| owner            | d88310717a8e4ebcae84ed075f82c51e                     |
| protected        | False                                                |
| schema           | /v2/schemas/image                                    |
| size             | 13287936                                             |
| status           | active                                               |
| tags             |                                                      |
| updated_at       | 2016-08-11T15:20:02Z                                 |
| virtual_size     | None                                                 |
| visibility       | private                                              |
+------------------+------------------------------------------------------+
```

When viewing a list of images, you can also use `grep` to filter the list, as follows:
查看图像列表时，还可以用于 `grep` 筛选列表，如下所示：

```
glance image-list | grep 'cirros'
| dfc1dfb0-d7bf-4fff-8994-319dd6f703d7 | cirros-0.3.5-x86_64-uec         |
| a3867e29-c7a1-44b0-9e7f-10db587cad20 | cirros-0.3.5-x86_64-uec-kernel  |
| 4b916fba-6775-4092-92df-f41df7246a6b | cirros-0.3.5-x86_64-uec-ramdisk |
```

## Create or update an image (glance) 创建或更新图像（概览） ¶

To create an image, use **glance image-create**:
要创建映像，请使用 glance image-create：

```
glance image-create --name imageName
```

To update an image, you must specify its ID and use **glance image-update**:
要更新映像，必须指定其 ID 并使用 glance image-update：

```
glance image-update --property x="y" <IMAGE_ID>
```

The following list explains the commonly used properties that you can set or modify when using the `image-create` and `image-update` commands. For more information, refer to the [OpenStack Useful Image Properties](https://docs.openstack.org/glance/latest/admin/useful-image-properties.html).
以下列表说明了在使用 `image-create` and `image-update` 命令时可以设置或修改的常用属性。有关更多信息，请参阅 OpenStack 有用的映像属性。

- `--architecture <ARCHITECTURE>`

  Operating system architecture as specified in https://docs.openstack.org/glance/latest/admin/useful-image-properties.html https://docs.openstack.org/glance/latest/admin/useful-image-properties.html 中指定的操作系统体系结构

- `--protected [True|False]`

  If true, image will not be deletable. 如果为 true，则图像将不可删除。

- `--name <NAME>`

  Descriptive name for the image 图像的描述性名称

- `--instance-uuid <INSTANCE_UUID>`

  Metadata which can be used to record which instance this image is associated with. (Informational only, does not create an instance snapshot.) 元数据，可用于记录此映像与哪个实例相关联。（仅供参考，不会创建实例快照。

- `--min-disk <MIN_DISK>`

  Amount of disk space (in GB) required to boot image. 启动映像所需的磁盘空间量（以 GB 为单位）。

- `--visibility <VISIBILITY>`

  Scope of image accessibility.  Valid values: `public`, `private`, `community`, `shared` 图像可访问性的范围。取值范围： `public` 、、 `private` `community` 、 `shared` 

- `--kernel-id <KERNEL_ID>`

  ID of image stored in Glance that should be used as the kernel when booting an AMI-style image. 存储在 Glance 中的映像的 ID，在引导 AMI 样式映像时应用作内核。

- `--os-version <OS_VERSION>`

  Operating system version as specified by the distributor 分销商指定的操作系统版本

- `--disk-format <DISK_FORMAT>`

  Format of the disk.  May not be modified once an image has gone to `active` status.  Valid values: `ami`, `ari`, `aki`, `vhd`, `vhdx`, `vmdk`, `raw`, `qcow2`, `vdi`, `iso`, `ploop` 磁盘的格式。一旦图像进入 `active` 状态，就不能修改。取值范围： `ami` 、 `ari` 、 、 `vhd` 、 `vhdx` `vmdk` `raw` `qcow2` `vdi` `iso` `ploop` `aki` 

- `--os-distro <OS_DISTRO>`

  Common name of operating system distribution as specified in https://docs.openstack.org/glance/latest/admin/useful-image-properties.html https://docs.openstack.org/glance/latest/admin/useful-image-properties.html 中指定的操作系统分发的公用名

- `--owner <OWNER>`

  Owner of the image.  Usually, may be set by an admin only. 图像的所有者。通常，只能由管理员设置。

- `--ramdisk-id <RAMDISK_ID>`

  ID of image stored in Glance that should be used as the ramdisk when booting an AMI-style image. 存储在 Glance 中的映像的 ID，在引导 AMI 样式映像时应用作虚拟磁盘。

- `--min-ram <MIN_RAM>`

  Amount of ram (in MB) required to boot image. 启动映像所需的 ram 量（以 MB 为单位）。

- `--container-format <CONTAINER_FORMAT>`

  Format of the container.  May not be modified once an image has gone to `active` status.  Valid values: `ami`, `ari`, `aki`, `bare`, `ovf`, `ova`, `docker`, `compressed` 容器的格式。一旦图像进入 `active` 状态，就不能修改。取值范围： `ami` 、 `ari` 、 、 `aki` `bare` 、 `ovf` 、 `ova` 、 `docker` `compressed` 

- `--hidden [True|False]`

  If true, image will not appear in default image list response. 如果为 true，则图像不会出现在默认图像列表响应中。

- `--property <key=value>`

  Arbitrary property to associate with image. May be used multiple times. 要与图像关联的任意属性。可多次使用。

- `--remove-property key`

  Name of arbitrary property to remove from the image. 要从图像中删除的任意属性的名称。

The following example shows the command that you would use to upload a CentOS 6.3 image in qcow2 format and configure it for public access:
以下示例显示了用于上传 qcow2 格式的 CentOS 6.3 映像并将其配置为公共访问的命令：

```
glance image-create --disk-format qcow2 --container-format bare \
  --visibility public --file ./centos63.qcow2 --name centos63-image
```

The following example shows how to update an existing image with a properties that describe the disk bus, the CD-ROM bus, and the VIF model:
下面的示例演示如何使用描述磁盘总线、CD-ROM 总线和 VIF 模型的属性来更新现有映像：



 

Note 注意



When you use OpenStack with VMware vCenter Server, you need to specify the `vmware_disktype` and `vmware_adaptertype` properties with **glance image-create**. Also, we recommend that you set the `hypervisor_type="vmware"` property. For more information, see [Images with VMware vSphere](https://docs.openstack.org/ocata/config-reference/compute/hypervisor-vmware.html#images-with-vmware-vsphere) in the OpenStack Configuration Reference.
将 OpenStack 与 VMware vCenter Server 结合使用时，需要使用 glance image-create 指定 `vmware_disktype` and `vmware_adaptertype` 属性。此外，我们建议您设置属性 `hypervisor_type="vmware"` 。有关更多信息，请参见《OpenStack 配置参考》中的具有 VMware vSphere 的映像。

```
glance image-update \
    --property hw_disk_bus=scsi \
    --property hw_cdrom_bus=ide \
    --property hw_vif_model=e1000 \
    <Image-ID>
```

Currently the libvirt virtualization tool determines the disk, CD-ROM, and VIF device models based on the configured hypervisor type (`libvirt_type` in `/etc/nova/nova.conf` file). For the sake of optimal performance, libvirt defaults to using virtio for both disk and VIF (NIC) models. The disadvantage of this approach is that it is not possible to run operating systems that lack virtio drivers, for example, BSD, Solaris, and older versions of Linux and Windows.
目前，libvirt 虚拟化工具根据配置的虚拟机管理程序类型（ `libvirt_type` 在 `/etc/nova/nova.conf` 文件中）确定磁盘、CD-ROM 和 VIF 设备型号。为了获得最佳性能，libvirt 默认对磁盘和 VIF （NIC） 模型都使用  virtio。这种方法的缺点是无法运行缺少 virtio 驱动程序的操作系统，例如 BSD、Solaris 以及旧版本的 Linux 和  Windows。

If you specify a disk or CD-ROM bus model that is not supported, see the [Disk_and_CD-ROM_bus_model_values_table](https://docs.openstack.org/glance/2023.2/admin/manage-images.html#disk-and-cd-rom-bus-model-values-table). If you specify a VIF model that is not supported, the instance fails to launch. See the [VIF_model_values_table](https://docs.openstack.org/glance/2023.2/admin/manage-images.html#vif-model-values-table).
如果指定不支持的磁盘或 CD-ROM 总线型号，请参阅 Disk_and_CD-ROM_bus_model_values_table。如果指定不支持的 VIF 模型，则实例无法启动。请参阅VIF_model_values_table。

The valid model values depend on the `libvirt_type` setting, as shown in the following tables.
有效的模型值取决于设置， `libvirt_type` 如下表所示。

**Disk and CD-ROM bus model values
磁盘和 CD-ROM 总线模型值**

| libvirt_type setting libvirt_type设置 | Supported model values 支持的模型值               |
| ------------------------------------- | ------------------------------------------------- |
| qemu or kvm QEMU 或 KVM               | fdc ide scsi SCSI的 sata 小时 virtio 维尔蒂奥 usb |
| xen                                   | ide xen                                           |

**VIF model values VIF 模型值**

| libvirt_type setting libvirt_type设置 | Supported model values 支持的模型值                          |
| ------------------------------------- | ------------------------------------------------------------ |
| qemu or kvm QEMU 或 KVM               | e1000 E1000系列 ne2k_pci pcnet PCNet的 rtl8139 RTL8139系列 virtio 维尔蒂奥 |
| xen                                   | e1000 E1000系列 netfront 网前 ne2k_pci pcnet PCNet的 rtl8139 RTL8139系列 |
| vmware VMware的                       | VirtualE1000 虚拟E1000 VirtualPCNet32 VirtualVmxnet 虚拟Vmxnet |



 

Note 注意



By default, hardware properties are retrieved from the image properties. However, if this information is not available, the `libosinfo` database provides an alternative source for these values.
默认情况下，硬件属性是从映像属性中检索的。但是，如果此信息不可用， `libosinfo` 则数据库将提供这些值的备用源。

If the guest operating system is not in the database, or if the use of `libosinfo` is disabled, the default system values are used.
如果客户机操作系统不在数据库中，或者禁用了 ， `libosinfo` 则使用缺省系统值。

Users can set the operating system ID or a `short-id` in image properties. For example:
用户可以设置操作系统 ID 或 `short-id` 映像属性。例如：

```
glance image-update --property short-id=fedora23 \
  <Image-ID>
```

### Create an image from ISO image 从 ISO 镜像创建镜像 ¶

You can upload ISO images to the Image service (glance). You can subsequently boot an ISO image using Compute.
您可以将 ISO 映像上传到映像服务（glance）。随后，您可以使用计算启动 ISO 映像。

In the Image service, run the following command:
在映像服务中，运行以下命令：

```
glance image-create --name ISO_IMAGE --file IMAGE.iso \
  --disk-format iso --container-format bare
```

Optionally, to confirm the upload in Image service, run:
（可选）要确认在映像服务中上传，请运行：

```
glance image-list
```

## Troubleshoot image creation 镜像创建疑难解答 ¶

If you encounter problems in creating an image in the Image service or Compute, the following information may help you troubleshoot the creation process.
如果您在影像服务或计算中创建镜像时遇到问题，以下信息可以帮助您排查创建过程的问题。

- Ensure that the version of qemu you are using is version 0.14 or later. Earlier versions of qemu result in an `unknown option -s` error message in the `/var/log/nova/nova-compute.log` file.
  确保您使用的 qemu 版本为 0.14 或更高版本。早期版本的 qemu 会导致 `/var/log/nova/nova-compute.log` 文件中出现 `unknown option -s` 错误消息。
- Examine the `/var/log/nova/nova-api.log` and `/var/log/nova/nova-compute.log` log files for error messages.
  检查 `/var/log/nova/nova-api.log` 和 `/var/log/nova/nova-compute.log` 日志文件中的错误消息。

# Useful image properties 有用的图像属性

​                                  

You can set image properties that can be consumed by other services to affect the behavior of those other services.  For example:
您可以设置可供其他服务使用的映像属性，以影响这些其他服务的行为。例如：

- Image properties can be used to override specific behaviors defined for Nova flavors
  图像属性可用于覆盖为 Nova 风格定义的特定行为
- Image properties can be used to affect the behavior of the Nova scheduler
  映像属性可用于影响 Nova 调度程序的行为
- Image properties can be used to affect the behavior of particular Nova hypervisors
  映像属性可用于影响特定 Nova 虚拟机管理程序的行为
- Image properties can be used to provide additional information to Ironic (even when Nova is not used)
  图像属性可用于向 Ironic 提供附加信息（即使未使用 Nova 也是如此）

## Using image properties 使用图像属性 ¶

Some important points to keep in mind:
要记住的一些要点：

- In order to allow custom image properties, Glance must be configured with the `glance-api.conf` setting `allow_additional_image_properties` set to True.  (This is the default setting.)
  为了允许自定义图像属性，必须将 Glance 配置为 `glance-api.conf`  `allow_additional_image_properties` 设置为 True。（这是默认设置。

- The `glance-api.conf` setting `image_property_quota` should be sufficiently high to allow any additional desired properties.  (The default is 128.)
  该 `glance-api.conf` 设置 `image_property_quota` 应足够高，以允许任何其他所需的属性。（默认值为 128。

- You can use Glance *property protections* to control access to specific image properties, should that be desirable.  See the [Property Protections](https://docs.openstack.org/glance/2023.2/admin/property-protections.html#property-protections) section of this Guide for more information.
  如果需要，您可以使用 Glance 属性保护来控制对特定图像属性的访问。有关详细信息，请参阅本指南的“财产保护”部分。

- Glance reserves properties namespaced with the `os_glance` prefix for its own use and will refuse attempts by API users to set or change them.
  Glance 保留带有 `os_glance` 前缀的命名空间属性供自己使用，并将拒绝 API 用户设置或更改它们的尝试。

- You can use a plugin to the interoperable image import process to set specific properties on non-admin images imported into Glance.  See [Copying existing-image in multiple stores](https://docs.openstack.org/glance/2023.2/admin/interoperable-image-import.html#iir-plugins) for more information.  See the original spec, [Inject metadata properties automatically to non-admin images](https://specs.openstack.org/openstack/glance-specs/specs/queens/implemented/glance/inject-automatic-metadata.html) for a discussion of the use case addressed by this plugin.
  您可以使用可互操作图像导入过程的插件来设置导入到 Glance 中的非管理员图像的特定属性。有关详细信息，请参阅在多个存储中复制现有映像。请参阅原始规范 Inject metadata  properties automatically to non-admin images，了解此插件解决的用例。

- The Nova **ImagePropertiesFilter**, enabled by default in the Compute Service, consumes image properties to determine proper scheduling of builds to compute hosts.  See the [Compute schedulers](https://docs.openstack.org/nova/latest/admin/configuration/schedulers.html) section of the Nova Configuration Guide for more information.
  默认情况下，Nova ImagePropertiesFilter 在计算服务中启用，它使用映像属性来确定对计算主机的生成的正确计划。有关详细信息，请参阅《Nova 配置指南》的“计算调度程序”部分。

- Nova has a setting, `non_inheritable_image_properties`, that allows you to specify which image properties from the image a virtual machine was booted from will *not* be propagated to a snapshot image of that virtual machine.  See the [Configuration Options](https://docs.openstack.org/nova/latest/configuration/config.html) section of the Nova Configuration Guide for more information.
  Nova 有一个设置 ， `non_inheritable_image_properties` 可用于指定从中引导虚拟机的映像中的哪些映像属性不会传播到该虚拟机的快照映像。有关详细信息，请参阅《Nova 配置指南》的“配置选项”部分。

- Some properties recognized by Nova may have no effect unless a corresponding property is enabled in the server flavor.  For example, the `hw_rng_model` image property has no effect unless the Nova flavor has been configured to have `hw_rng:allowed` set to True in the flavor’s extra_specs.
  除非在服务器变种中启用了相应的属性，否则 Nova 识别的某些属性可能不起作用。例如， `hw_rng_model` image 属性不起作用，除非 Nova 变种已配置为在变种的extra_specs中 `hw_rng:allowed` 设置为 True。

- In a mixed hypervisor environment, the Compute Service uses the `hypervisor_type` image property to match images to the correct hypervisor type.
  在混合虚拟机监控程序环境中，计算服务使用 `hypervisor_type` image 属性将映像与正确的虚拟机监控程序类型相匹配。

  Depending upon what hypervisors are in use in your Nova installation, there may be other image properties that these hypervisors can consume to affect their behavior.  Read through the configuration information for your hypervisors in the [Hypervisors](https://docs.openstack.org/nova/latest/admin/configuration/hypervisors.html) section of the Nova Configuration Guide for more information.
  根据 Nova 安装中使用的虚拟机管理程序，这些虚拟机管理程序可能会使用其他映像属性来影响其行为。有关详细信息，请通读《Nova 配置指南》的“虚拟机管理程序”部分中虚拟机管理程序的配置信息。

  In particular, the VMware hypervisor driver requires that particular image properties be set for optimal functioning.  See the [VMware vSphere](https://docs.openstack.org/nova/latest/admin/configuration/hypervisor-vmware.html) section of the Nova Configuration Guide for more information.
  具体而言，VMware 虚拟机管理程序驱动程序要求设置特定的映像属性以实现最佳功能。有关详细信息，请参见《Nova 配置指南》的“VMware vSphere”部分。



## Image property keys and values 图像属性键和值 ¶

Here is a list of useful image properties and the values they expect.
下面列出了有用的图像属性及其期望的值。

- `architecture`

  Type: 类型： str  The CPU architecture that must be supported by the hypervisor. For example, `x86_64`, `arm`, or `ppc64`. Run **uname -m** to get the architecture of a machine. We strongly recommend using the architecture data vocabulary defined by the [libosinfo project](http://libosinfo.org/) for this purpose. 虚拟机管理程序必须支持的 CPU 体系结构。例如， `x86_64` 、 `arm` 或 `ppc64` 。运行 uname -m 获取计算机的架构。为此，我们强烈建议使用 libosinfo 项目定义的架构数据词汇表。 One of: 以下之一： `aarch64` - [ARM 64-bit](https://en.wikipedia.org/wiki/AArch64) `aarch64` - ARM 64 位 `alpha` - [DEC 64-bit RISC](https://en.wikipedia.org/wiki/DEC_Alpha)  `alpha` - DEC 64 位 RISC `armv7l` - [ARM Cortex-A7 MPCore](https://en.wikipedia.org/wiki/ARM_architecture) `cris` - [Ethernet, Token Ring, AXis—Code Reduced Instruction Set](https://en.wikipedia.org/wiki/ETRAX_CRIS)  `cris` - 以太网、令牌环、AXis—降码指令集 `i686` - [Intel sixth-generation x86 (P6 micro architecture)](https://en.wikipedia.org/wiki/X86)  `i686` - 英特尔第六代 x86（P6 微架构） `ia64` - [Itanium](https://en.wikipedia.org/wiki/Itanium) `ia64` - 安腾 `lm32` - [Lattice Micro32](https://en.wikipedia.org/wiki/Milkymist)  `lm32` - 莱迪思Micro32 `m68k` - [Motorola 68000](https://en.wikipedia.org/wiki/Motorola_68000_family)  `m68k` - 摩托罗拉68000 `microblaze` - [Xilinx 32-bit FPGA (Big Endian)](https://en.wikipedia.org/wiki/MicroBlaze)  `microblaze` - Xilinx 32 位 FPGA（Big Endian） `microblazeel` - [Xilinx 32-bit FPGA (Little Endian)](https://en.wikipedia.org/wiki/MicroBlaze)  `microblazeel` - Xilinx 32 位 FPGA （Little Endian） `mips` - [MIPS 32-bit RISC (Big Endian)](https://en.wikipedia.org/wiki/MIPS_architecture)  `mips` - MIPS 32 位 RISC（大端序） `mipsel` - [MIPS 32-bit RISC (Little Endian)](https://en.wikipedia.org/wiki/MIPS_architecture)  `mipsel` - MIPS 32 位 RISC （Little Endian） `mips64` - [MIPS 64-bit RISC (Big Endian)](https://en.wikipedia.org/wiki/MIPS_architecture)  `mips64` - MIPS 64 位 RISC （Big Endian） `mips64el` - [MIPS 64-bit RISC (Little Endian)](https://en.wikipedia.org/wiki/MIPS_architecture)  `mips64el` - MIPS 64 位 RISC （Little Endian） `openrisc` - [OpenCores RISC](https://en.wikipedia.org/wiki/OpenRISC#QEMU_support)  `openrisc` - OpenCores RISC （英语） `parisc` - [HP Precision Architecture RISC](https://en.wikipedia.org/wiki/PA-RISC)  `parisc` - HP Precision 架构 RISC `parisc64` - [HP Precision Architecture 64-bit RISC](https://en.wikipedia.org/wiki/PA-RISC)  `parisc64` - HP Precision 架构 64 位 RISC `ppc` - [PowerPC 32-bit](https://en.wikipedia.org/wiki/PowerPC)  `ppc` - PowerPC 32 位 `ppc64` - [PowerPC 64-bit](https://en.wikipedia.org/wiki/PowerPC)  `ppc64` - PowerPC 64 位 `ppcemb` - [PowerPC (Embedded 32-bit)](https://en.wikipedia.org/wiki/PowerPC)  `ppcemb` - PowerPC（嵌入式 32 位） `s390` - [IBM Enterprise Systems Architecture/390](https://en.wikipedia.org/wiki/S390)  `s390` - IBM 企业系统架构/390 `s390x` - [S/390 64-bit](https://en.wikipedia.org/wiki/S390x) `s390x` - S/390 64 位 `sh4` - [SuperH SH-4 (Little Endian)](https://en.wikipedia.org/wiki/SuperH)  `sh4` - SuperH SH-4 （小端） `sh4eb` - [SuperH SH-4 (Big Endian)](https://en.wikipedia.org/wiki/SuperH)  `sh4eb` - SuperH SH-4 （大端序） `sparc` - [Scalable Processor Architecture, 32-bit](https://en.wikipedia.org/wiki/Sparc)  `sparc` - 可扩展处理器架构，32 位 `sparc64` - [Scalable Processor Architecture, 64-bit](https://en.wikipedia.org/wiki/Sparc)  `sparc64` - 可扩展处理器架构，64 位 `unicore32` - [Microprocessor Research and Development Center RISC Unicore32](https://en.wikipedia.org/wiki/Unicore)  `unicore32` - 微处理器研发中心 RISC Unicore32 `x86_64` - [64-bit extension of IA-32](https://en.wikipedia.org/wiki/X86)  `x86_64` - IA-32 的 64 位扩展 `xtensa` - [Tensilica Xtensa configurable microprocessor core](https://en.wikipedia.org/wiki/Xtensa#Processor_Cores)  `xtensa` - Tensilica Xtensa 可配置微处理器内核 `xtensaeb` - [Tensilica Xtensa configurable microprocessor core](https://en.wikipedia.org/wiki/Xtensa#Processor_Cores) (Big Endian)  `xtensaeb` - Tensilica Xtensa 可配置微处理器内核 （Big Endian）

- `hypervisor_type`

  Type: 类型： str  The hypervisor type. Note that `qemu` is used for both QEMU and KVM hypervisor types. 虚拟机监控程序类型。请注意，它 `qemu` 用于 QEMU 和 KVM 虚拟机管理程序类型。 One of: 以下之一： `hyperv` `ironic` `lxc` `qemu` `uml` `vmware` `xen`.

- `instance_uuid`

  Type: 类型： str  For snapshot images, this is the UUID of the server used to create this image. The value must be a valid server UUID. 对于快照映像，这是用于创建此映像的服务器的 UUID。该值必须是有效的服务器 UUID。

- `img_config_drive`

  Type: 类型： str  Specifies whether the image needs a config drive. 指定映像是否需要配置驱动器。 One of: 以下之一： `mandatory` `optional` (default if property is not used)  `optional` （如果未使用属性，则默认）

- `img_type`

  Type: 类型： str  Specifies the partitioning type of the image. The default value is `partition` if the `kernel_id`/`ramdisk_id` properties are present, otherwise `whole-disk`. 指定映像的分区类型。默认值为 `partition` `kernel_id` / `ramdisk_id` 属性是否存在，否则 `whole-disk` . One of: 以下之一： `whole-disk` - an image with a partition table embedded.  `whole-disk` - 嵌入了分区表的图像。 `partition` - an image with only the root partition without a partition table.  `partition` - 只有根分区而没有分区表的映像。  Note 注意 This property is currently only recognized by Ironic. 此属性目前仅由 Ironic 认可。

- `kernel_id`

  Type: 类型： str  The ID of an image stored in the Image service that should be used as the kernel when booting an AMI-style image. The value must be a valid image ID 存储在映像服务中的映像的 ID，在引导 AMI 样式映像时应用作内核。该值必须是有效的映像 ID

- `os_admin_user`

  Type: 类型： str  The name of the user with admin privileges. The value must be a valid username (defaults to `root` for Linux guests and `Administrator` for Windows guests). 具有管理员权限的用户的名称。该值必须是有效的用户名（对于 Linux 客户机和 `Administrator` Windows 客户机，默认为 `root` 用户名）。

- `os_distro`

  Type: 类型： str  The common name of the operating system distribution in lowercase (uses the same data vocabulary as the [libosinfo project](http://libosinfo.org/)). Specify only a recognized value for this field. Deprecated values are listed to assist you in searching for the recognized value. 操作系统发行版的通用名称，小写（使用与 libosinfo 项目相同的数据词汇表）。仅为此字段指定可识别的值。列出了已弃用的值，以帮助您搜索已识别的值。 One of: 以下之一： `arch` - Arch Linux. Do not use `archlinux` or `org.archlinux`.  `arch` - Arch Linux的。请勿使用 `archlinux` 或 `org.archlinux` . `centos` - Community Enterprise Operating System. Do not use `org.centos` or `CentOS`.  `centos` - 社区企业操作系统。请勿使用 `org.centos` 或 `CentOS` . `debian` - Debian. Do not use `Debian` or ``org.debian`.  `debian` - Debian的。不要使用 `Debian` or ``org.debian` . `fedora` - Fedora. Do not use `Fedora`, `org.fedora`, or `org.fedoraproject`.  `fedora` - 软呢帽。请勿使用 `Fedora` 、 `org.fedora` 或 `org.fedoraproject` 。 `freebsd` - FreeBSD. Do not use `org.freebsd`, `freeBSD`, or `FreeBSD`.  `freebsd` - FreeBSD。请勿使用 `org.freebsd` 、 `freeBSD` 或 `FreeBSD` 。 `gentoo` - Gentoo Linux. Do not use `Gentoo` or `org.gentoo`.  `gentoo` - Gentoo Linux的。请勿使用 `Gentoo` 或 `org.gentoo` . `mandrake` - Mandrakelinux (MandrakeSoft) distribution. Do not use `mandrakelinux` or `MandrakeLinux`.  `mandrake` - Mandrakelinux （MandrakeSoft） 发行版。请勿使用 `mandrakelinux` 或 `MandrakeLinux` . `mandriva` - Mandriva Linux. Do not use `mandrivalinux`.  `mandriva` - 曼德里瓦 Linux。不要使用 `mandrivalinux` . `mes` - Mandriva Enterprise Server. Do not use `mandrivaent` or `mandrivaES`.  `mes` - Mandriva 企业服务器。请勿使用 `mandrivaent` 或 `mandrivaES` . `msdos` - Microsoft Disc Operating System. Do not use `ms-dos`.  `msdos` - Microsoft 光盘操作系统。不要使用 `ms-dos` . `netbsd` - NetBSD. Do not use `NetBSD` or `org.netbsd`.  `netbsd` - NetBSD。请勿使用 `NetBSD` 或 `org.netbsd` . `netware` - Novell NetWare. Do not use `novell` or `NetWare`.  `netware` - Novell NetWare。请勿使用 `novell` 或 `NetWare` . `openbsd` - OpenBSD. Do not use `OpenBSD` or `org.openbsd`.  `openbsd` - OpenBSD。请勿使用 `OpenBSD` 或 `org.openbsd` . `opensolaris` - OpenSolaris. Do not use `OpenSolaris` or `org.opensolaris`.  `opensolaris` - OpenSolaris。请勿使用 `OpenSolaris` 或 `org.opensolaris` . `opensuse` - openSUSE. Do not use `suse`, `SuSE`, or `` org.opensuse``.  `opensuse` - openSUSE。请勿使用 `suse` 、 `SuSE` 或 '' org.opensuse''。 `rocky` - Rocky Linux. Do not use `Rocky` or `rockylinux`.  `rocky` - 洛基Linux。请勿使用 `Rocky` 或 `rockylinux` . `rhel` - Red Hat Enterprise Linux. Do not use `redhat`, `RedHat`, or `com.redhat`.  `rhel` - 红帽企业 Linux。请勿使用 `redhat` 、 `RedHat` 或 `com.redhat` 。 `sled` - SUSE Linux Enterprise Desktop. Do not use `com.suse`.  `sled` - SUSE Linux Enterprise Desktop。不要使用 `com.suse` . `ubuntu` - Ubuntu. Do not use `Ubuntu`, `com.ubuntu`, `org.ubuntu`, or `canonical`.  `ubuntu` - 乌班图。请勿使用 `Ubuntu` 、 `com.ubuntu` 、 `org.ubuntu` 或 `canonical` 。 `windows` - Microsoft Windows. Do not use `com.microsoft.server` or `windoze`.  `windows` - Microsoft Windows。请勿使用 `com.microsoft.server` 或 `windoze` .

- `os_version`

  Type: 类型： str  The operating system version as specified by the distributor. 分发服务器指定的操作系统版本。 The value must be a valid version number (for example, `11.10`). 该值必须是有效的版本号（例如， `11.10` ）。

- `os_secure_boot`

  Type: 类型： str  Secure Boot is a security standard. When the instance starts, Secure Boot first examines software such as firmware and OS by their signature and only allows them to run if the signatures are valid. 安全启动是一种安全标准。当实例启动时，安全启动首先通过签名检查固件和操作系统等软件，并且仅在签名有效时才允许它们运行。 For Hyper-V: Images must be prepared as Generation 2 VMs. Instance must also contain `hw_machine_type=hyperv-gen2` image property. Linux guests will also require bootloader’s digital signature provided as `os_secure_boot_signature` and `hypervisor_version_requires'>=10.0'` image properties. 对于 Hyper-V：映像必须准备为第 2 代 VM。 实例还必须包含 `hw_machine_type=hyperv-gen2` 映像属性。Linux 客户机还需要引导加载程序的数字签名 `os_secure_boot_signature` 作为和 `hypervisor_version_requires'>=10.0'` 映像属性提供。 One of: 以下之一： `required` - Enable the Secure Boot feature.  `required` - 启用安全启动功能。 `disabled` or `optional` - (default if property not used) Disable the Secure Boot feature.  `disabled` 或 `optional` -（如果未使用属性，则为默认值）禁用安全启动功能。

- `os_shutdown_timeout`

  Type: 类型： int  By default, guests will be given 60 seconds to perform a graceful shutdown. After that, the VM is powered off. This property allows overriding the amount of time (unit: seconds) to allow a guest OS to cleanly shut down before power off. A value of 0 (zero) means the guest will be powered off immediately with no opportunity for guest OS clean-up. 默认情况下，来宾将有 60 秒的时间来执行正常关机。之后，虚拟机将关闭电源。此属性允许覆盖允许客户机操作系统在关机前完全关闭的时间量（单位：秒）。值为 0（零）表示客户机将立即关闭电源，没有机会清理客户机操作系统。

- `ramdisk_id`

  The ID of image stored in the Image service that should be used as the ramdisk when booting an AMI-style image. 存储在镜像服务中的镜像 ID，在引导 AMI 样式镜像时应用作 ramdisk。 The value must be a valid image ID. 该值必须是有效的映像 ID。

- `rootfs_uuid`

  For whole-disk images (see `img_type` above), the UUID of the root partition. 对于全磁盘映像（见 `img_type` 上文），为根分区的 UUID。 This property is used by Ironic when configuring software RAID. Ironic 在配置软件 RAID 时使用此属性。

- `trait:<trait_name>`

  Type: 类型： str  Added in the Rocky release. Functionality is similar to traits specified in [flavor extra specs](https://docs.openstack.org/nova/latest/user/flavors.html#extra-specs). 在 Rocky 版本中添加。功能类似于 flavor extra spec 中指定的特征。 Traits allow specifying a server to build on a compute node with the set of traits specified in the image. The traits are associated with the resource provider that represents the compute node in the Placement API. 特征允许指定服务器以使用映像中指定的一组特征在计算节点上构建。这些特征与表示放置 API 中的计算节点的资源提供程序相关联。 The syntax of specifying traits is **trait:<trait_name>=value**, for example: 指定特征的语法是 trait：<trait_name>=value，例如： `trait:HW_CPU_X86_AVX2=required` `trait:STORAGE_DISK_SSD=required` The nova scheduler will pass required traits specified on the image to the Placement API to include only resource providers that can satisfy the required traits. Traits for the resource providers can be managed using the [osc-placement plugin.](https://docs.openstack.org/osc-placement/latest/index.html) nova 调度程序会将映像上指定的必需特征传递给放置 API，以仅包含可以满足所需特征的资源提供程序。可以使用 osc-placement 插件管理资源提供程序的特征。 Image traits are used by the nova scheduler even in cases of volume backed instances, if the volume source is an image with traits. 如果卷源是具有特征的图像，则即使在卷支持的实例的情况下，nova 调度程序也会使用映像特征。 The only valid value is `required`. Any other value is invalid. 唯一有效的值是 `required` 。任何其他值都无效。 One of: 以下之一： `required` - <trait_name> is required on the resource provider that represents the compute node on which the image is launched.  `required` -  在表示启动映像的计算节点的资源提供程序上是必需的。

- `vm_mode`

  Type: 类型： str  The virtual machine mode. This represents the host/guest ABI (application binary interface) used for the virtual machine. 虚拟机模式。这表示用于虚拟机的主机/来宾 ABI（应用程序二进制接口）。 One of: 以下之一： `hvm` - Fully virtualized. This is the mode used by QEMU and KVM.  `hvm` - 完全虚拟化。这是 QEMU 和 KVM 使用的模式。 `xen` - Xen 3.0 paravirtualized.  `xen` - Xen 3.0 半虚拟化。 `uml` - User Mode Linux paravirtualized.  `uml` - 用户模式：Linux 半虚拟化。 `exe` - Executables in containers. This is the mode used by LXC.  `exe` - 容器中的可执行文件。这是LXC使用的模式。

- `hw_cpu_sockets`

  Type: 类型： int  The preferred number of sockets to expose to the guest. 要向来宾公开的首选套接字数。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_cpu_cores`

  Type: 类型： int  The preferred number of cores to expose to the guest. 要向来宾公开的首选内核数。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_cpu_threads`

  Type: 类型： int  The preferred number of threads to expose to the guest. 要向来宾公开的首选线程数。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_cpu_policy`

  Type: 类型： str  Used to pin the virtual CPUs (vCPUs) of instances to the host’s physical CPU cores (pCPUs). Host aggregates should be used to separate these pinned instances from unpinned instances as the latter will not respect the resourcing requirements of the former. 用于将实例的虚拟 CPU （vCPU） 固定到主机的物理 CPU 内核 （pCPU）。应使用主机聚合将这些固定实例与未固定实例分开，因为后者不会遵循前者的资源要求。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。 One of: 以下之一： `shared` - (default if property not specified) The guest vCPUs will be allowed to freely float across host pCPUs, albeit potentially constrained by NUMA policy.  `shared` - （如果未指定属性，则为默认值）将允许来宾 vCPU 在主机 pCPU 之间自由浮动，尽管可能受到 NUMA 策略的约束。 `dedicated` - The guest vCPUs will be strictly pinned to a set of host pCPUs. In the absence of an explicit vCPU topology request, the drivers typically expose all vCPUs as sockets with one core and one thread. When strict CPU pinning is in effect the guest CPU topology will be setup to match the topology of the CPUs to which it is pinned. This option implies an overcommit ratio of 1.0. For example, if a two vCPU guest is pinned to a single host core with two threads, then the guest will get a topology of one socket, one core, two threads.  `dedicated` - 客户机 vCPU 将严格固定到一组主机 pCPU。在没有显式 vCPU 拓扑请求的情况下，驱动程序通常会将所有 vCPU  公开为具有一个内核和一个线程的套接字。当严格的 CPU 固定生效时，将设置客户机 CPU 拓扑以匹配其固定到的 CPU  的拓扑。此选项意味着超额承诺比率为 1.0。例如，如果将两个 vCPU  客户机固定到具有两个线程的单个主机核心，则客户机将获得一个套接字、一个核心、两个线程的拓扑。

- `hw_cpu_thread_policy`

  Type: 类型： str  Further refine `hw_cpu_policy=dedicated` by stating how hardware CPU threads in a simultaneous multithreading-based (SMT) architecture be used. SMT-based architectures include Intel processors with Hyper-Threading technology. In these architectures, processor cores share a number of components with one or more other cores. Cores in such architectures are commonly referred to as hardware threads, while the cores that a given core share components with are known as thread siblings. 通过说明如何使用基于同步多线程 （SMT） 的体系结构中的硬件 CPU 线程来进一步细化 `hw_cpu_policy=dedicated` 。基于 SMT 的架构包括采用超线程技术的英特尔处理器。在这些体系结构中，处理器内核与一个或多个其他内核共享许多组件。此类体系结构中的内核通常称为硬件线程，而给定内核与之共享组件的内核称为线程同级。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。 One of: 以下之一： `prefer` - (default if property not specified) The host may or may not have an SMT architecture. Where an SMT architecture is present, thread siblings are preferred.  `prefer` - （如果未指定属性，则默认）主机可能具有也可能没有 SMT 体系结构。如果存在 SMT 架构，则首选线程同级架构。 `isolate` - The host must not have an SMT architecture or must emulate a non-SMT architecture. If the host does not have an SMT architecture, each vCPU is placed on a different core as expected. If the host does have an SMT architecture - that is, one or more cores have thread siblings - then each vCPU is placed on a different physical core. No vCPUs from other guests are placed on the same core. All but one thread sibling on each utilized core is therefore guaranteed to be unusable.  `isolate` - 主机不得具有 SMT 架构或必须模拟非 SMT 架构。如果主机没有 SMT 体系结构，则每个 vCPU  将按预期放置在不同的内核上。如果主机确实具有 SMT 体系结构（即，一个或多个内核具有线程同级），则每个 vCPU  都放置在不同的物理内核上。来自其他客户机的 vCPU 不会放置在同一个内核上。因此，每个已利用内核上除一个线程同级线程外的所有线程都保证不可用。 `require` - The host must have an SMT architecture. Each vCPU is allocated on thread siblings. If the host does not have an SMT architecture, then it is not used. If the host has an SMT architecture, but not enough cores with free thread siblings are available, then scheduling fails.  `require` - 主机必须具有 SMT 架构。每个 vCPU 都分配在线程同级上。如果主机没有 SMT 体系结构，则不使用它。如果主机具有 SMT 体系结构，但没有足够的具有可用线程同级内核，则调度将失败。

- `hw_cdrom_bus`

  Type: 类型： str  Specifies the type of disk controller to attach CD-ROM devices to. As for `hw_disk_bus`. 指定要将 CD-ROM 设备连接到的磁盘控制器的类型。至于 `hw_disk_bus` . Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_disk_bus`

  Type: 类型： str  Specifies the type of disk controller to attach disk devices to. 指定要将磁盘设备连接到的磁盘控制器的类型。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。 Options depend on the value of [nova’s virt_type config option](https://docs.openstack.org/nova/latest/configuration/config.html#libvirt.virt_type): 选项取决于 nova 的 virt_type 配置选项的值： For `qemu` and `kvm`: one of `scsi`, `virtio`, `uml`, `xen`, `ide`, `usb`, or `lxc`. 对于 `qemu` 和 `kvm` ： `scsi` 、 `virtio` 、 `uml` `xen` 、 `ide` 、 或 `usb` `lxc` 之一。 For `xen`: one of `xen` or `ide`. 对于 `xen` ： 或 `xen` `ide` 之一 。 For `uml`: must be `uml`. 对于 `uml` ： 必须是 `uml` 。 For `lxc`: must be `lxc`. 对于 `lxc` ： 必须是 `lxc` 。 For `parallels`: one of `ide` or `scsi`. 对于 `parallels` ： 或 `ide` `scsi` 之一 。

- `hw_firmware_type`

  Specifies the type of firmware with which to boot the guest. 指定用于引导客户机的固件类型。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。 One of: 以下之一： `bios` `uefi`

- `hw_mem_encryption`

  Type: 类型： bool 布尔值  Enables encryption of guest memory at the hardware level, if there are compute hosts available which support this. See [nova’s documentation on configuration of the KVM hypervisor](https://docs.openstack.org/nova/latest/admin/configuration/hypervisor-kvm.html#amd-sev-secure-encrypted-virtualization) for more details. 在硬件级别启用来宾内存加密（如果有可用的计算主机支持此加密）。有关更多详细信息，请参阅 nova 关于 KVM 虚拟机管理程序配置的文档。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_pointer_model`

  Type: 类型： str  Input devices that allow interaction with a graphical framebuffer, for example to provide a graphic tablet for absolute cursor movement. Currently only supported by the KVM/QEMU hypervisor configuration and VNC or SPICE consoles must be enabled. 允许与图形帧缓冲区交互的输入设备，例如，为绝对光标移动提供图形输入板。目前仅受 KVM/QEMU 虚拟机管理程序配置支持，并且必须启用 VNC 或 SPICE 控制台。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。 One of: 以下之一： `usbtablet`

- `hw_rng_model`

  Type: 类型： str  Adds a random-number generator device to the image’s instances. This image property by itself does not guarantee that a hardware RNG will be used; it expresses a preference that may or may not be satisfied depending upon Nova configuration. 将随机数生成器设备添加到映像的实例中。此映像属性本身并不能保证将使用硬件 RNG;它表达了一种偏好，根据 Nova 配置，可能会或可能不会满足。 The cloud administrator can enable and control device behavior by configuring the instance’s flavor. By default: 云管理员可以通过配置实例的风格来启用和控制设备行为。默认情况下： The generator device is disabled. 发电机设备被禁用。 `/dev/urandom` is used as the default entropy source. To specify a physical hardwre RNG device, use the following option in the `nova.conf` file:  `/dev/urandom` 用作默认熵源。要指定物理硬核 RNG 设备，请在 `nova.conf` 文件中使用以下选项： `rng_dev_path=/dev/hwrng `  The use of a hardware random number generator must be configured in a flavor’s extra_specs by setting `hw_rng:allowed` to True in the flavor definition. 硬件随机数生成器的使用必须在特定实例的extra_specs中配置，方法是在特定实例定义中设置为 `hw_rng:allowed` True。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。 One of: 以下之一： `virtio` Other supported device. 其他支持的设备。

- `hw_time_hpet`

  Type: 类型： bool 布尔值  Adds support for the High Precision Event Timer (HPET) for x86 guests in the libvirt driver when `hypervisor_type=qemu` and `architecture=i686` or `architecture=x86_64`. The timer can be enabled by setting `hw_time_hpet=true`. By default HPET remains disabled. 在 libvirt 驱动程序 when `hypervisor_type=qemu` 和 `architecture=i686` or `architecture=x86_64` 中为 x86 客户机添加对高精度事件计时器 （HPET） 的支持。可以通过设置 `hw_time_hpet=true` 来启用定时器。默认情况下，HPET 保持禁用状态。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_machine_type`

  Type: 类型： str  For libvirt: Enables booting an ARM system using the specified machine type. If an ARM image is used and its machine type is not explicitly specified, then Compute uses the `virt` machine type as the default for ARMv7 and AArch64. 对于 libvirt：允许使用指定的机器类型引导 ARM 系统。如果使用 ARM 映像且未显式指定其计算机类型，则计算将使用该 `virt` 计算机类型作为 ARMv7 和 AArch64 的默认值。 For Hyper-V: Specifies whether the Hyper-V instance will be a generation 1 or generation 2 VM. By default, if the property is not provided, the instances will be generation 1 VMs. If the image is specific for generation 2 VMs but the property is not provided accordingly, the instance will fail to boot. 对于 Hyper-V：指定 Hyper-V 实例是第 1 代还是第 2 代 VM。默认情况下，如果未提供该属性，则实例将是第 1 代 VM。如果映像特定于第 2 代 VM，但未相应地提供该属性，则实例将无法启动。 For libvirt: Valid types can be viewed by using the **virsh capabilities** command (machine types are displayed in the `machine` tag). 对于 libvirt：可以使用 virsh capabilities 命令查看有效类型（机器类型显示在标签中 `machine` ）。 For hyper-V: Acceptable values are either `hyperv-gen1` or `hyperv-gen2`. 对于 hyper-V：可接受的值为 `hyperv-gen1` 或 `hyperv-gen2` 。 Only supported by the libvirt and Hyper-V drivers. 仅受 libvirt 和 Hyper-V 驱动程序支持。

- `os_type`

  Type: 类型： str  The operating system installed on the image. The `libvirt` API driver contains logic that takes different actions depending on the value of the `os_type` parameter of the image. For example, for `os_type=windows` images, it creates a FAT32-based swap partition instead of a Linux swap partition, and it limits the injected host name to less than 16 characters. 映像上安装的操作系统。 `libvirt` API 驱动程序包含根据图像参数的 `os_type` 值执行不同操作的逻辑。例如，对于 `os_type=windows` 映像，它会创建一个基于 FAT32 的交换分区，而不是 Linux 交换分区，并将注入的主机名限制为少于 16 个字符。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。 One of: 以下之一： `linux` `windows`

- `hw_scsi_model`

  Type: 类型： str  Enables the use of VirtIO SCSI (`virtio-scsi`) to provide block device access for compute instances; by default, instances use VirtIO Block (`virtio-blk`). VirtIO SCSI is a para-virtualized SCSI controller device that provides improved scalability and performance, and supports advanced SCSI hardware. 允许使用 VirtIO SCSI （ `virtio-scsi` ） 为计算实例提供块设备访问;默认情况下，实例使用 VirtIO 块 （ `virtio-blk` ）。VirtIO SCSI 是一种半虚拟化的 SCSI 控制器设备，可提供改进的可扩展性和性能，并支持高级 SCSI 硬件。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。 One of: 以下之一： `virtio-scsi`

- `hw_serial_port_count`

  Type: 类型： int  Specifies the count of serial ports that should be provided. If `hw:serial_port_count` is not set in the flavor’s extra_specs, then any count is permitted. If `hw:serial_port_count` is set, then this provides the default serial port count. It is permitted to override the default serial port count, but only with a lower value. 指定应提供的串行端口数。如果 `hw:serial_port_count` 未在口味的extra_specs中设置，则允许进行任何计数。如果 `hw:serial_port_count` 已设置，则提供默认串行端口计数。允许覆盖默认串行端口计数，但只能使用较低的值。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_video_model`

  Type: 类型： str  The graphic device model presented to the guest. `none` disables the graphics device in the guest and should generally be used when using GPU passthrough. 呈现给来宾的图形设备模型。 `none` 禁用客户机中的图形设备，通常应在使用 GPU 直通时使用。 One of: 以下之一： `vga` `cirrus` `vmvga` `xen` `qxl` `virtio` `gop` `none` `bochs` Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_video_ram`

  Type: 类型： int  Maximum RAM in MB for the video image. Used only if a `hw_video:ram_max_mb` value has been set in the flavor’s extra_specs and that value is higher than the value set in `hw_video_ram`. 视频图像的最大 RAM（以 MB 为单位）。仅当在变种的extra_specs中设置了某个 `hw_video:ram_max_mb` 值，并且该值高于 中 `hw_video_ram` 设置的值时才使用。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_watchdog_action`

  Type: 类型： str  Enables a virtual hardware watchdog device that carries out the specified action if the server hangs. The watchdog uses the `i6300esb` device (emulating a PCI Intel 6300ESB). If `hw_watchdog_action` is not specified, the watchdog is disabled. 启用虚拟硬件监视器设备，该设备在服务器挂起时执行指定的操作。看门狗使用设备 `i6300esb` （模拟 PCI Intel 6300ESB）。如果 `hw_watchdog_action` 未指定，则禁用监视器。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。 One of: 以下之一： `disabled` - (default) The device is not attached. Allows the user to disable the watchdog for the image, even if it has been enabled using the image’s flavor.  `disabled` - （默认）未连接设备。允许用户禁用映像的监视器，即使已使用映像的风格启用监视器也是如此。 `reset` - Forcefully reset the guest.  `reset` - 强制重置访客。 `poweroff` - Forcefully power off the guest.  `poweroff` - 强行关闭客人的电源。 `pause` - Pause the guest.  `pause` - 暂停客人。 `none` - Only enable the watchdog; do nothing if the server hangs.  `none` - 仅启用看门狗;如果服务器挂起，则不执行任何操作。

- `os_command_line`

  Type: 类型： str  The kernel command line to be used by the `libvirt` driver, instead of the default. For Linux Containers (LXC), the value is used as arguments for initialization. This key is valid only for Amazon kernel, `ramdisk`, or machine images (`aki`, `ari`, or `ami`).  `libvirt` 驱动程序要使用的内核命令行，而不是默认命令行。对于 Linux 容器 （LXC），该值用作初始化的参数。此密钥仅对 Amazon 内核 `ramdisk` 或计算机映像（ `aki` 、 `ari` 或 `ami` ）有效。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_vif_model`

  Type: 类型： str  Specifies the model of virtual network interface device to use. 指定要使用的虚拟网络接口设备的型号。 Only supported by the libvirt driver and VMware API drivers. 仅受 libvirt 驱动程序和 VMware API 驱动程序支持。 The valid options depend on the configured hypervisor. 有效选项取决于配置的虚拟机管理程序。 `KVM` and `QEMU`: `e1000`, `e1000e`, `ne2k_pci`, `pcnet`, `rtl8139`, `virtio` and `vmxnet3`.  `KVM` 和 `QEMU` ： `e1000` ， ， `e1000e` `ne2k_pci` ， `pcnet` ， `rtl8139` `virtio` 和 `vmxnet3` . VMware: `e1000`, `e1000e`, `VirtualE1000`, `VirtualE1000e`, `VirtualPCNet32`, `VirtualVmxnet` and `VirtualVmxnet3`. VMware： `e1000` 、、 `e1000e` 、 `VirtualE1000` `VirtualE1000e` 、 `VirtualPCNet32` `VirtualVmxnet` 和 `VirtualVmxnet3` 。 Xen: `e1000`, `netfront`, `ne2k_pci`, `pcnet`, and `rtl8139`. Xen： `e1000` 、、 `netfront` `ne2k_pci` 、和 `pcnet` `rtl8139` 。

- `hw_vif_multiqueue_enabled`

  Type: 类型： bool 布尔值  If `true`, this enables the `virtio-net multiqueue` feature. In this case, the driver sets the number of queues equal to the number of guest vCPUs. This makes the network performance scale across a number of vCPUs. 如果 `true` ，则启用该 `virtio-net multiqueue` 功能。在这种情况下，驱动程序将队列数设置为等于来宾 vCPU 数。这使得网络性能可以跨多个 vCPU 进行扩展。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_boot_menu`

  Type: 类型： bool 布尔值  If `true`, enables the BIOS bootmenu. In cases where both the image metadata and Extra Spec are set, the Extra Spec setting is used. This allows for flexibility in setting/overriding the default behavior as needed. 如果 `true` ，则启用 BIOS 引导菜单。如果同时设置了图像元数据和“额外规范”，则使用“额外规范”设置。这允许根据需要灵活地设置/覆盖默认行为。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `hw_pmu`

  Type: 类型： bool 布尔值  Controls emulation of a virtual performance monitoring unit (vPMU) in the guest.  To reduce latency in realtime workloads disable the vPMU by setting `hw_pmu=false`. 控制客户机中虚拟性能监控单元 （vPMU） 的仿真。要减少实时工作负载中的延迟，请通过设置 `hw_pmu=false` 来禁用 vPMU。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `img_hide_hypervisor_id`

  Type: 类型： bool 布尔值  Some hypervisors add a signature to their guests.  While the presence of the signature can enable some paravirtualization features on the guest, it can also have the effect of preventing some drivers from loading.  Hiding the signature by setting this property to `true` may allow such drivers to load and work. 一些虚拟机管理程序会为其来宾添加签名。虽然签名的存在可以在客户机上启用某些半虚拟化功能，但它也可能具有阻止某些驱动程序加载的效果。通过将此属性设置为隐藏签名 `true` 可能会允许此类驱动程序加载和工作。 Only supported by the libvirt driver. 仅受 libvirt 驱动程序支持。

- `vmware_adaptertype`

  Type: 类型： str  The virtual SCSI or IDE controller used by the hypervisor. 虚拟机管理程序使用的虚拟 SCSI 或 IDE 控制器。 Only supported by the VMWare API driver. 仅受 VMWare API 驱动程序支持。 One of: 以下之一： `lsiLogic` `lsiLogicsas` `busLogic` `ide` `paraVirtual`

- `vmware_ostype`

  A VMware GuestID which describes the operating system installed in the image. This value is passed to the hypervisor when creating a virtual machine. If not specified, the key defaults to `otherGuest`. See [thinkvirt.com](http://www.thinkvirt.com/?q=node/181) for supported values. 一个 VMware GuestID，用于描述映像中安装的操作系统。此值在创建虚拟机时传递给虚拟机监控程序。如果未指定，则密钥默认为 `otherGuest` 。有关支持的值，请参阅 thinkvirt.com。 Only supported by the VMWare API driver. 仅受 VMWare API 驱动程序支持。

- `vmware_image_version`

  Type: 类型： int  Currently unused. 目前未使用。

- `instance_type_rxtx_factor`

  Type: 类型： float 浮  Deprecated and currently unused. 已弃用，目前未使用。

- `auto_disk_config`

  Type: 类型： bool 布尔值  Deprecated and currently unused. 已弃用，目前未使用。

# Requirements 要求

​                                  

## External Requirements Affecting Glance 影响 Glance 的外部要求 ¶

Like other OpenStack projects, Glance uses some external libraries for a subset of its features. Some examples include the `qemu-img` utility used by the tasks feature, `sendfile` to utilize the “zero-copy” way of copying data faster, `pydev` to debug using popular IDEs, `python-xattr` for Image Cache using “xattr” driver.
与其他 OpenStack 项目一样，Glance 使用一些外部库来实现其功能的子集。一些示例包括任务功能使用的 `qemu-img` 实用程序， `sendfile` 以利用“零拷贝”方式更快地复制数据， `pydev` 使用流行的IDE进行调试， `python-xattr` 使用“xattr”驱动程序进行图像缓存。

On the other hand, if `dnspython` is installed in the environment, Glance provides a workaround to make it work with IPV6.
另一方面，如果 `dnspython` 安装在环境中，Glance 会提供一种解决方法，使其与 IPV6 配合使用。

Additionally, some libraries like `xattr` are not compatible when using Glance on Windows (see [the documentation on config options affecting the Image Cache](https://docs.openstack.org/glance/2023.2/configuration/index.html#configuring)).
此外，在 Windows 上使用 Glance 时，某些库（如 `xattr` ）不兼容（请参阅有关影响图像缓存的配置选项的文档）。

## Guideline to include your requirement in the requirements.txt file 将您的要求包含在 requirements.txt 文件中的指南 ¶

As described above, we don’t include all the possible requirements needed by Glance features in the source tree requirements file. So, when an operator decides to use an **advanced feature** in Glance, we ask them to check the documentation/guidelines for those features to set up the feature in a workable way. In order to reduce the operator pain, the development team likes to work with different operators to figure out when a popular feature should have its dependencies included in the requirements file. However, there’s a tradeoff in including more of requirements in source tree as it becomes more painful for packagers. So, it is a bit of a haggle among different stakeholders and a judicious decision is taken by the project PTL or release liaison to determine the outcome.
如上所述，我们没有在源代码树需求文件中包含 Glance 功能所需的所有可能要求。因此，当操作员决定在 Glance  中使用高级功能时，我们会要求他们查看这些功能的文档/指南，以便以可行的方式设置该功能。为了减少操作员的痛苦，开发团队喜欢与不同的操作员合作，以确定何时应该将流行的功能包含在需求文件中。但是，在源代码树中包含更多需求需要权衡，因为这对打包者来说变得更加痛苦。因此，不同利益相关者之间有点讨价还价，项目 PTL 或发布联络员会做出明智的决定来确定结果。

To simplify the identification of an **advanced feature** in Glance we can think of it as something not being used and deployed by most of the upstream/known community members.
为了简化 Glance 中高级功能的识别，我们可以将其视为大多数上游/已知社区成员未使用和部署的功能。

To name a few features that have been identified as advanced:
仅举几个已被确定为高级的功能：

- glance tasks Glance 任务
- image signing 图像签名
- image prefetcher 图像预取器
- glance db purge utility Glance 数据库清除实用程序
- image locations 图像位置

## Steps to include your requirement in the requirements.txt file 将您的要求包含在 requirements.txt 文件中的步骤 ¶

1. First step is to propose a change against the `openstack/requirements` project to include the requirement(s) as a part of `global-requirements` and `upper-constraints` files.
2. 第一步是针对 `openstack/requirements` 项目提出更改建议，将需求作为 `upper-constraints` 文件的一部分 `global-requirements` 。
3. If your requirement is not a part of the project, you will have to propose a change adding that requirement to the requirements.txt file in Glance. Please include a `Depends-On: <ChangeID>` flag in the commit message, where the `ChangeID` is the gerrit ID of corresponding change against `openstack/requirements` project.
4. 如果您的需求不是项目的一部分，则必须提出更改建议，将该需求添加到 Glance 中的requirements.txt文件中。请在提交消息中包含一个 `Depends-On: <ChangeID>` 标志，其中 `ChangeID` 是针对 `openstack/requirements` 项目的相应更改的 gerrit ID。
5. A sync bot then syncs the global requirements into project requirements on a regular basis, so any updates to the requirements are synchronized on a timely basis.
6. 然后，同步机器人会定期将全局需求同步到项目需求中，以便及时同步对需求的任何更新。

# Per-Tenant Quotas 每租户配额

​                                  



 

New in version 23.0.0: (Xena)
新版本 23.0.0： （Xena）





 

This functionality was first introduced in the 23.0.0 (Xena) release. Prior to this, only global resource limits were supported.
此功能是在 23.0.0 （Xena） 版本中首次引入的。在此之前，仅支持全局资源限制。





Glance supports resource consumption quotas on tenants through the use of Keystone’s unified limits functionality. Resource limits are *registered* in Keystone with suitable default values, and may be overridden on a per-tenant basis. When a resource consumption attempt is made in Glance, the current consumption is computed and compared against the limit set in Keystone; the request is denied if the user is over the specified limit.
Glance 通过使用 Keystone 的统一限制功能来支持租户的资源消耗配额。资源限制在 Keystone  中注册，具有适当的默认值，并且可以按租户覆盖。在 Glance 中尝试使用资源时，将计算当前消耗量并将其与 Keystone  中设置的限制进行比较;如果用户超过指定的限制，则请求将被拒绝。

Due to the design of Glance, most of the storage-focused quotas in Glance are **soft limits**. Since Glance allows clients to stream image data of unknown total size during an upload or import operation, it is not possible to determine if quota has been exceeded until *after* the operation has completed. Thus, a user is permitted to go over their quota for a single operation, and then denied additional stored on subsequent operations. There are object-focused quotas that can help operators limit the damage caused by multiple large competing data streams. Those details are covered below.
由于 Glance 的设计，Glance 中大多数以存储为中心的配额都是软限制。由于 Glance  允许客户端在上传或导入操作期间流式传输总大小未知的图像数据，因此在操作完成之前无法确定是否超出了配额。因此，允许用户超过其单个操作的配额，然后拒绝在后续操作中存储额外的配额。有一些以对象为中心的配额可以帮助运营商限制多个大型竞争数据流造成的损害。下面将介绍这些详细信息。



 

Note 注意



Glance also has legacy global resource limits that may be ignored if per-tenant quotas are enabled. Currently the `user_storage_quota` limit will be ignored if per-tenant quotas are used.
Glance 还具有旧版全局资源限制，如果启用了每个租户的配额，则可以忽略这些限制。目前，如果使用每个租户的配额，则将忽略该 `user_storage_quota` 限制。

See the Keystone docs for more information on [unified limits](https://docs.openstack.org/keystone/latest/admin/unified-limits.html).
有关统一限制的更多信息，请参阅 Keystone 文档。

## Quota Resource Types 配额资源类型 ¶

Glance supports quota limits on multiple areas of resource consumption. Limits are enforced at the time in which resource consumption is attempted, so setting an existing user’s quota for any item below the current usage will only prevent them from consuming *more* data until they free up space.
Glance 支持对多个资源消耗区域进行配额限制。限制是在尝试资源消耗时强制实施的，因此，为低于当前使用量的任何项目设置现有用户的配额只会阻止他们消耗更多数据，直到他们释放空间。

### Total Image Size 总图像尺寸 ¶

The `image_size_total` limit defines the maximum amount of storage (in MiB) that the tenant may consume across all of their active images. Images with multiple locations contribute to this count according to the number of places the image is stored. Thus, if you have a single 1GiB image stored in four locations, the usage will be considered to be 4GiB.
该 `image_size_total` 限制定义租户在其所有活动映像中可能使用的最大存储量（以 MiB 为单位）。具有多个位置的图像根据存储图像的位置数计入此计数。因此，如果将单个 1GiB 映像存储在四个位置，则使用量将被视为 4GiB。

### Total Staging Size 总暂存大小 ¶

The [Interoperable Image Import](https://docs.openstack.org/glance/2023.2/admin/interoperable-image-import.html#iir) function uses a two-step upload process, whereby a user first uploads an image into the *staging* store, and then subsequently *imports* the image to the final destination(s). The staging store is generally local storage on the API workers themselves, and thus is likely at somewhat of a premium, compared to the bulk shared storage allocated for general images. The `image_stage_total` limit defines the total amount of staging space that may be used. This should be set to a value sufficient to allow a user to import one or more images at the same time, according to your desired level of parallelism. It may be appropriate to provide the user with a very generous `image_size_total` quota, but a relatively restrictive `image_stage_total` allocation, effectively limiting them to one image being imported at any given point.
可互操作图像导入功能使用两步上传过程，即用户首先将图像上传到暂存存储，然后将图像导入最终目标。暂存存储通常是 API 工作线程本身的本地存储，因此与为常规映像分配的批量共享存储相比，可能会有一定的溢价。该 `image_stage_total` 限制定义了可以使用的暂存空间总量。此值应设置为足以允许用户根据所需的并行度级别同时导入一个或多个图像的值。为用户提供一个非常慷慨的 `image_size_total` 配额，但相对限制性的 `image_stage_total` 分配可能是合适的，有效地将他们限制为在任何给定点导入一个图像。

Keep in mind that images being imported using the `web-download` method will need to fit within this allocation as well, as those are first downloaded to the staging store before being imported to the final destination(s). Images being copied from one store to another using the `copy-image` method are similarly affected. Note that the conventional image upload method does not stage the image, and thus is not impacted by this limit.
请记住，使用该 `web-download` 方法导入的图像也需要适合此分配，因为这些图像在导入到最终目标之前首先下载到暂存存储。使用该 `copy-image` 方法从一个商店复制到另一个商店的图像也会受到类似的影响。请注意，传统的图像上传方法不会暂存图像，因此不受此限制的影响。

### Total Number of Images 图片总数 ¶

The `image_count_total` limit controls the maximum number of image objects that the user may have, regardless of the individual or collective sizes or impact to storage. This limit may be useful if you wish to prevent users from taking thousands of small server snapshots without ever deleting them.
该 `image_count_total` 限制控制用户可能拥有的最大图像对象数，无论单个或集合大小或对存储的影响如何。如果您希望阻止用户在不删除它们的情况下拍摄数千个小型服务器快照，则此限制可能很有用。

### Total Number of In-Progress Uploads 正在进行的上传总数 ¶

Because Glance can not enforce storage-focused quotas until after a stream is finished, it may be useful to limit the number of parallel upload operations that can be in-progress at any single point. The `image_count_uploading` limit provides this control, and affects conventional image upload, pre-import stage (including `web-download` and `glance-direct`), as well as any `copy-image` operations that may be pending. It may be desirable to limit untrusted users to a single in-progress image upload, which will limit the amount of damage a malicious user may be able to inflict on your image storage if they initiate multiple simultaneous unbounded upload streams.
由于 Glance 在流完成之前无法强制实施以存储为中心的配额，因此限制在任何单个点上可以进行的并行上载操作的数量可能很有用。该 `image_count_uploading` 限制提供了此控制，并影响常规图像上传、导入前阶段（包括 `web-download` 和 `glance-direct` ）以及可能挂起的任何 `copy-image` 操作。最好将不受信任的用户限制为单个正在进行的图像上传，这将限制恶意用户在同时启动多个无限制上传流时可能对图像存储造成的损害。

## Quota Strategies 配额策略 ¶

Below are a couple of use-case example strategies for different types of deployments. In all cases, it makes sense for `image_size_total` and `image_stage_total` to be set to at least the size of the largest image you expect a user to use. The global limit on a single image (see configuration item `image_size_cap`) may be relevant as well. Users with an `image_count_total` of zero will be unable to create any images, and with an `image_count_uploading` of zero will be able to upload data to any images.
以下是针对不同类型部署的几个用例示例策略。在所有情况下，它都有意义 `image_size_total` ，并且 `image_stage_total` 至少设置为您期望用户使用的最大图像的大小。单个映像的全局限制（请参阅配置项 `image_size_cap` ）也可能是相关的。 `image_count_total` 零的用户将无法创建任何图像，而 `image_count_uploading` 零的用户将能够将数据上传到任何图像。

1. **Public cloud, users are billed per-byte**: In this case, it probably makes sense to set fairly high default quota limits for each of the above resource classes, allowing users to consume as much as they are willing to pay for. It still may be desirable to set `image_stage_total` to something modest to prevent overrunning limited staging space, if you have import enabled.
   公有云，用户按字节计费：在这种情况下，为上述每个资源类设置相当高的默认配额限制可能是有意义的，允许用户使用他们愿意支付的金额。如果启用了导入，则仍可能需要设置为 `image_stage_total` 适度值以防止超出有限的暂存空间。
2. **Private cloud, trusted users are billed by quota**: In this case, each user pays for the amount of resource they are *allowed* to consume, instead of what they *are* consuming. Generally this involves billing total space, so `image_size_total` is set to their allotment, potentially with some upper bound on total images via `image_count_total`. If they are somewhat trusted or low-impact customers, limiting the staging usage and upload count is probably not necessary, and can be left unbounded or set to some high upper bound.
   私有云、受信任的用户按配额计费：在这种情况下，每个用户都为他们被允许使用的资源量付费，而不是他们消耗的资源量。通常，这涉及对总空间进行计费，因此 `image_size_total` 设置为它们的分配，可能通过 `image_count_total` 对总图像有一些上限。如果他们是受信任或影响较小的客户，则可能没有必要限制暂存使用量和上传计数，并且可以保持无限制或设置为某个高上限。
3. **Private cloud, semi-trusted third party users**: This case may be similar to either of the above in terms of paying for allotment or strict usage. However, the lack of full trust may suggest limiting the total number of image uploads to something like 10% of their compute quota (to allow for snapshots) and limiting staging usage to enough for one or two image imports at a time.
   私有云、半受信任的第三方用户：在支付分配或严格使用方面，这种情况可能与上述任何一种类似。但是，缺乏完全信任可能建议将图像上传的总数限制在其计算配额的 10% 左右（以允许快照），并将暂存使用限制为一次导入一个或两个图像的足够数量。

## Configuring Glance for Per-Tenant Quotas 为每租户配额配置 Glance ¶

1. Register quota limits (optional):
   注册配额限制（可选）：

   If you decide to use per-tenant quotas in Glance, you must register the limits in Keystone first:
   如果您决定在 Glance 中使用每租户配额，则必须先在 Keystone 中注册限制：

```
openstack --os-cloud devstack-system-admin registered limit create \
  --service glance --default-limit 1000 --region RegionOne image_size_total

+---------------+----------------------------------+
| Field         | Value                            |
+---------------+----------------------------------+
| default_limit | 1000                             |
| description   | None                             |
| id            | 9cedfc5de80345a9b13ed00c2b5460f2 |
| region_id     | RegionOne                        |
| resource_name | image_size_total                 |
| service_id    | e38c84a2487f49fd9864193bdc8a3174 |
+---------------+----------------------------------+
openstack --os-cloud devstack-system-admin registered limit create \
  --service glance --default-limit 1000 --region RegionOne image_stage_total

+---------------+----------------------------------+
| Field         | Value                            |
+---------------+----------------------------------+
| default_limit | 1000                             |
| description   | None                             |
| id            | 5a68712b6ba6496d823d0c66e5e860b9 |
| region_id     | RegionOne                        |
| resource_name | image_stage_total                |
| service_id    | e38c84a2487f49fd9864193bdc8a3174 |
+---------------+----------------------------------+
openstack --os-cloud devstack-system-admin registered limit create \
  --service glance --default-limit 100 --region RegionOne image_count_total

+---------------+----------------------------------+
| Field         | Value                            |
+---------------+----------------------------------+
| default_limit | 100                              |
| description   | None                             |
| id            | beb91b043296499f8e6268f29d8b2749 |
| region_id     | RegionOne                        |
| resource_name | image_count_total                |
| service_id    | e38c84a2487f49fd9864193bdc8a3174 |
+---------------+----------------------------------+
```

1. ```
   openstack --os-cloud devstack-system-admin registered limit create \
     --service glance --default-limit 100 --region RegionOne \
     image_count_uploading
   
   +---------------+----------------------------------+
   | Field         | Value                            |
   +---------------+----------------------------------+
   | default_limit | 100                              |
   | description   | None                             |
   | id            | fc29649c047a45bf9bc03ec4a7bcb8af |
   | region_id     | RegionOne                        |
   | resource_name | image_count_uploading            |
   | service_id    | e38c84a2487f49fd9864193bdc8a3174 |
   +---------------+----------------------------------+
   ```

   Be sure to also set `use_keystone_limits=True` in your `glance-api.conf` file.
   请务必在您的 `glance-api.conf` 文件中进行设置 `use_keystone_limits=True` 。

2. Tell Glance to use Keystone quotas
   告诉 Glance 使用 Keystone 配额

- In the `[oslo_limit]` section, configure access to keystone:
  在本节 `[oslo_limit]` 中，配置对 keystone 的访问：

  ```
  [oslo_limit]
  auth_url = http://controller:5000
  auth_type = password
  user_domain_id = default
  username = glance
  system_scope = all
  password = GLANCE_PASS
  endpoint_id = 340be3625e9b4239a6415d034e98aace
  region_name = RegionOne
  ```

  Replace `GLANCE_PASS` with the password you chose for the `glance` user in the Identity service.
  替换 `GLANCE_PASS` 为您在 Identity 服务中为用户选择的 `glance` 密码。

  Make sure that the glance account has reader access to system-scope resources (like limits):
  确保 glance 帐户具有对系统范围资源（如限制）的读取者访问权限：

```
openstack role add --user glance --user-domain Default --system all reader
```

See [the oslo_limit docs](https://docs.openstack.org/oslo.limit/latest/user/usage.html#configuration) for more information about configuring the unified limits client.
有关配置统一限制客户端的更多信息，请参阅oslo_limit文档。

In the `[DEFAULT]` section, optionally enable per-tenant quotas:
在该部分中，可以选择启用每个租户的配额：In the `[DEFAULT]` section， optionally enable per-tenant quotas：

```
[DEFAULT]
use_keystone_limits = True
```

Note that you must have created the registered limits as described above if this is enabled.

# Secure Hash Algorithm Support (Multihash) 安全哈希算法支持（多哈希）

​                                  

The Secure Hash Algorithm feature supplements the current ‘checksum’ image property with a self-describing secure hash.
安全哈希算法功能使用自描述的安全哈希来补充当前的“校验和”图像属性。

The self-description consists of two new image properties:
自描述由两个新的图像属性组成：

- `os_hash_algo`

  Contains the name of the secure hash algorithm used to generate the value on the image 包含用于在映像上生成值的安全哈希算法的名称

- `os_hash_value`

  The hexdigest computed by applying the secure hash algorithm named in the `os_hash_algo` property to the image data 通过将 `os_hash_algo` 属性中命名的安全哈希算法应用于图像数据来计算的十六进制摘要

## Hash Algorithm Configuration 哈希算法配置 ¶

`os_hash_algo` will be populated by the value of the configuration option `hashing_algorithm` in the `glance.conf` file. The `os_hash_value` value will be populated by the hexdigest computed when the algorithm is applied to the uploaded or imported image data.
 `os_hash_algo` 将由 `glance.conf` 文件中配置选项 `hashing_algorithm` 的值填充。该 `os_hash_value` 值将由将算法应用于上传或导入的图像数据时计算的十六进制摘要填充。

These are read-only image properties and are not user-modifiable.
这些是只读图像属性，用户不可修改。

The default secure hash algorithm is SHA-512. It should be suitable for most applications.
默认安全哈希算法为 SHA-512。它应该适用于大多数应用。

The multihash is computed only for new images. There is no provision for computing the multihash for existing images.
仅针对新映像计算多哈希。没有规定计算现有图像的多哈希值。