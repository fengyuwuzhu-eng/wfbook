# TLS

​        version 版本              



This guide describes how to configure Kolla Ansible to deploy OpenStack with TLS enabled. Enabling TLS on the provided internal and/or external VIP address allows OpenStack clients to authenticate and encrypt network communication with OpenStack services.
本指南介绍如何配置 Kolla Ansible 以在启用 TLS 的情况下部署 OpenStack。在提供的内部和/或外部 VIP 地址上启用 TLS 允许 OpenStack 客户端验证和加密与 OpenStack 服务的网络通信。

When an OpenStack service exposes an API endpoint, Kolla Ansible will configure HAProxy for that service to listen on the internal and/or external VIP address. The HAProxy container load-balances requests on the VIPs to the nodes running the service container.
当 OpenStack 服务公开 API 端点时，Kolla Ansible 将为该服务配置 HAProxy 以侦听内部和/或外部 VIP 地址。HAProxy 容器将 VIP 上的请求负载均衡到运行服务容器的节点。

There are two different layers of TLS configuration for OpenStack APIs:
OpenStack API 有两个不同的 TLS 配置层：

1. Enabling TLS on the internal and/or external VIP, so communication between an OpenStack client and the HAProxy listening on the VIP is secure.
   在内部和/或外部 VIP 上启用 TLS，以便 OpenStack 客户端与在 VIP 上侦听的 HAProxy 之间的通信是安全的。
2. Enabling TLS on the backend network, so communication between HAProxy and the backend API services is secure.
   在后端网络上启用 TLS，以便 HAProxy 和后端 API 服务之间的通信是安全的。



 

Note 注意



TLS authentication is based on certificates that have been signed by trusted Certificate Authorities. Examples of commercial CAs are Comodo, Symantec, GoDaddy, and GlobalSign. Letsencrypt.org is a CA that will provide trusted certificates at no charge. If using a trusted CA is not possible for your project, you can use a private CA, e.g. Hashicorp Vault, to create a certificate for your domain, or see [Generating TLS certificates with Let’s Encrypt](https://docs.openstack.org/kolla-ansible/latest/admin/tls.html#admin-tls-generating-a-private-ca) to use a Kolla Ansible generated private CA.
TLS 身份验证基于已由受信任的证书颁发机构签名的证书。商业 CA 的示例包括 Comodo、Symantec、GoDaddy 和  GlobalSign。Letsencrypt.org 是一个 CA，将免费提供受信任的证书。如果您的项目无法使用受信任的 CA，您可以使用私有  CA（例如 Hashicorp Vault）为您的域创建证书，或者参阅使用 Let's Encrypt 生成 TLS 证书以使用 Kolla  Ansible 生成的私有 CA。

For details on ACME-enabled CAs, such as letsencrypt.org, please see [ACME http-01 challenge support](https://docs.openstack.org/kolla-ansible/latest/admin/acme.html).
有关启用 ACME 的 CA（如 letsencrypt.org）的详细信息，请参阅 ACME http-01 质询支持。

## Quick Start 快速入门 ¶



 

Note 注意



The certificates generated by Kolla Ansible use a simple Certificate Authority setup and are not suitable for a production deployment. Only certificates signed by a trusted Certificate Authority should be used in a production deployment.
Kolla Ansible 生成的证书使用简单的证书颁发机构设置，不适合生产部署。在生产部署中，只能使用由受信任的证书颁发机构签名的证书。

To deploy OpenStack with TLS enabled for the external, internal and backend APIs, configure the following in `globals.yml`:
要为外部、内部和后端 API 部署启用了 TLS 的 OpenStack，请在以下位置配置 `globals.yml` 以下内容：

```
kolla_enable_tls_internal: "yes"
kolla_enable_tls_external: "yes"
kolla_enable_tls_backend: "yes"
kolla_copy_ca_into_containers: "yes"
```

If deploying on Debian or Ubuntu:
如果部署在 Debian 或 Ubuntu 上：

```
openstack_cacert: "/etc/ssl/certs/ca-certificates.crt"
```

If on CentOS or Rocky:
如在 CentOS 或 Rocky 上：

```
openstack_cacert: "/etc/pki/tls/certs/ca-bundle.crt"
```

The Kolla Ansible `certificates` command generates a private test Certificate Authority, and then uses the CA to sign the generated certificates for the enabled VIP(s) to test TLS in your OpenStack deployment. Assuming you are using the `multinode` inventory:
Kolla Ansible `certificates` 命令生成一个专用测试证书颁发机构，然后使用 CA 对已启用的 VIP 生成的证书进行签名，以测试 OpenStack 部署中的 TLS。假设您正在使用 `multinode` 库存：

```
kolla-ansible -i ~/multinode certificates
```

## TLS Configuration for internal/external VIP 内部/外部 VIP 的 TLS 配置 ¶

The configuration variables that control TLS for the internal and/or external VIP are:
控制内部和/或外部 VIP 的 TLS 的配置变量包括：

- `kolla_enable_tls_external`
- `kolla_enable_tls_internal`
- `kolla_internal_fqdn_cert`
- `kolla_external_fqdn_cert`



 

Note 注意



If TLS is enabled only on the internal or external network, then `kolla_internal_vip_address` and `kolla_external_vip_address` must be different.
如果仅在内部或外部网络上启用 TLS，则 `kolla_internal_vip_address` 和 `kolla_external_vip_address` 必须不同。

If there is only a single network configured in your topology (as opposed to separate internal and external networks), TLS can only be enabled using the internal network configuration variables.
如果拓扑中仅配置了一个网络（而不是单独的内部和外部网络），则只能使用内部网络配置变量启用 TLS。

The default state for TLS networking is disabled. To enable external TLS encryption:
TLS 网络的默认状态为禁用。要启用外部 TLS 加密，请执行以下操作：

```
kolla_enable_tls_external: "yes"
```

To enable internal TLS encryption:
要启用内部 TLS 加密，请执行以下操作：

```
kolla_enable_tls_internal: "yes"
```

Two certificate files are required to use TLS securely with authentication, which will be provided by your Certificate Authority:
需要两个证书文件才能安全地将 TLS 与身份验证一起使用，这将由您的证书颁发机构提供：

- server certificate with private key
  带有私钥的服务器证书
- CA certificate with any intermediate certificates
  具有任何中间证书的 CA 证书

The combined server certificate and private key needs to be provided to Kolla Ansible, with the path configured via `kolla_external_fqdn_cert` or `kolla_internal_fqdn_cert`.  These paths default to `{{ kolla_certificates_dir }}/haproxy.pem` and `{{ kolla_certificates_dir }}/haproxy-internal.pem` respectively, where `kolla_certificates_dir` is `/etc/kolla/certificates` by default.
需要向 Kolla Ansible 提供组合的服务器证书和私钥，并通过 `kolla_external_fqdn_cert` 或 `kolla_internal_fqdn_cert` 配置路径。这些路径默认为 `{{ kolla_certificates_dir }}/haproxy.pem` 和 `{{ kolla_certificates_dir }}/haproxy-internal.pem` 分别，其中 `kolla_certificates_dir` 默认为 `/etc/kolla/certificates` 。

If the server certificate provided is not already trusted by clients, then the CA certificate file will need to be distributed to the clients. This is discussed in more detail in [Configuring the OpenStack Client for TLS](https://docs.openstack.org/kolla-ansible/latest/admin/tls.html#admin-tls-openrc) and [Adding CA Certificates to the Service Containers](https://docs.openstack.org/kolla-ansible/latest/admin/tls.html#admin-tls-ca-in-containers).
如果提供的服务器证书尚未受客户端信任，则需要将 CA 证书文件分发给客户端。在为 TLS 配置 OpenStack 客户端和向服务容器添加 CA 证书中对此进行了更详细的讨论。



## Configuring the OpenStack Client for TLS 配置 OpenStack 客户端的 TLS ¶

The location for the CA certificate for the `admin-openrc.sh` file is configured with the `kolla_admin_openrc_cacert` variable, which is not set by default. This must be a valid path on all hosts where `admin-openrc.sh` is used.
 `admin-openrc.sh` 文件的 CA 证书的位置是使用 `kolla_admin_openrc_cacert` 变量配置的，默认情况下未设置该变量。这必须是使用的所有 `admin-openrc.sh` 主机上的有效路径。

When TLS is enabled on a VIP, and `kolla_admin_openrc_cacert` is set to `/etc/pki/tls/certs/ca-bundle.crt`, an OpenStack client will have settings similar to this configured by `admin-openrc.sh`:
当在 VIP 上启用 TLS 并 `kolla_admin_openrc_cacert` 设置为 `/etc/pki/tls/certs/ca-bundle.crt` 时，OpenStack 客户端将具有与此类似的设置，配置如下 `admin-openrc.sh` ：

```
export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_NAME=admin
export OS_TENANT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=demoPassword
export OS_AUTH_URL=https://mykolla.example.net:5000
export OS_INTERFACE=internal
export OS_ENDPOINT_TYPE=internalURL
export OS_MISTRAL_ENDPOINT_TYPE=internalURL
export OS_IDENTITY_API_VERSION=3
export OS_REGION_NAME=RegionOne
export OS_AUTH_PLUGIN=password
# os_cacert is optional for trusted certificates
export OS_CACERT=/etc/pki/tls/certs/ca-bundle.crt
```



## Adding CA Certificates to the Service Containers 向服务容器添加 CA 证书 ¶

To copy CA certificate files to the service containers:
要将 CA 证书文件复制到服务容器，请执行以下操作：

```
kolla_copy_ca_into_containers: "yes"
```

When `kolla_copy_ca_into_containers` is configured to “yes”, the CA certificate files in `/etc/kolla/certificates/ca` will be copied into service containers to enable trust for those CA certificates. This is required for any certificates that are either self-signed or signed by a private CA, and are not already present in the service image trust store. Kolla will install these certificates in the container system wide trust store when the container starts.
当配置为“是”时 `kolla_copy_ca_into_containers` ，其中 `/etc/kolla/certificates/ca` 的 CA 证书文件将复制到服务容器中，以启用对这些 CA 证书的信任。对于自签名或由专用 CA 签名且服务映像信任存储中尚不存在的任何证书，这是必需的。当容器启动时，Kolla 将把这些证书安装在容器系统范围的信任存储中。

All certificate file names will have the `kolla-customca-` prefix prepended to them when they are copied into the containers. For example, if a certificate file is named `internal.crt`, it will be named `kolla-customca-internal.crt` in the containers.
将所有证书文件名复制到容器中时，都会在其前面加上 `kolla-customca-` 前缀。例如，如果证书文件被命名为 `internal.crt` ，它将在容器中命名 `kolla-customca-internal.crt` 。

For Debian and Ubuntu containers, the certificate files will be copied to the `/usr/local/share/ca-certificates/` directory.
对于 Debian 和 Ubuntu 容器，证书文件将被复制到 `/usr/local/share/ca-certificates/` 目录中。

For CentOS and Rocky containers, the certificate files will be copied to the `/etc/pki/ca-trust/source/anchors/` directory.
对于 CentOS 和 Rocky 容器，证书文件会复制到目录中 `/etc/pki/ca-trust/source/anchors/` 。

In both cases, valid certificates will be added to the system trust store - `/etc/ssl/certs/ca-certificates.crt` on Debian and Ubuntu, and `/etc/pki/tls/certs/ca-bundle.crt` on CentOS and Rocky.
在这两种情况下，有效的证书都会被添加到系统信任库中 - `/etc/ssl/certs/ca-certificates.crt` 在 Debian 和 Ubuntu 上，以及 `/etc/pki/tls/certs/ca-bundle.crt` 在 CentOS 和 Rocky 上。

## Configuring a CA bundle 配置 CA 捆绑包 ¶

OpenStack services do not always trust CA certificates from the system trust store by default. To resolve this, the `openstack_cacert` variable should be configured with the path to the CA Certificate in the container.
默认情况下，OpenStack 服务并不总是信任来自系统信任存储的 CA 证书。若要解决此问题，应使用容器中 CA 证书的路径配置变量 `openstack_cacert` 。

To use the system trust store on Debian or Ubuntu:
要在 Debian 或 Ubuntu 上使用系统信任库：

```
openstack_cacert: /etc/ssl/certs/ca-certificates.crt
```

For CentOS or Rocky:
对于 CentOS 或 Rocky：

```
openstack_cacert: /etc/pki/tls/certs/ca-bundle.crt
```

## Back-end TLS Configuration 后端 TLS 配置 ¶

Enabling TLS on the backend services secures communication between the HAProxy listing on the internal/external VIP and the OpenStack services. It also enables secure end-to-end communication between OpenStack services that support TLS termination. The OpenStack services that support backend TLS termination in Victoria are: Nova, Ironic, Neutron, Keystone, Glance, Heat, Placement, Horizon, Barbican, and Cinder.
在后端服务上启用 TLS 可以保护内部/外部 VIP 上的 HAProxy 列表与 OpenStack 服务之间的通信。它还支持支持 TLS 终止的  OpenStack 服务之间的安全端到端通信。在 Victoria 中支持后端 TLS 终止的 OpenStack  服务包括：Nova、Ironic、Neutron、Keystone、Glance、Heat、Placement、Horizon、Barbican 和 Cinder。

The configuration variables that control back-end TLS for service endpoints are:
控制服务终结点的后端 TLS 的配置变量包括：

- `kolla_enable_tls_backend`
- `kolla_tls_backend_cert`
- `kolla_tls_backend_key`
- `haproxy_backend_cacert`
- `haproxy_backend_cacert_dir`

The default state for back-end TLS is disabled. To enable TLS for the back-end communication:
后端 TLS 的默认状态为禁用。要为后端通信启用 TLS，请执行以下操作：

```
kolla_enable_tls_backend: "yes"
```

It is also possible to enable back-end TLS on a per-service basis. For example, to enable back-end TLS for Keystone, set `keystone_enable_tls_backend` to `yes`.
还可以基于每个服务启用后端 TLS。例如，要为 Keystone 启用后端 TLS，请设置为 `keystone_enable_tls_backend` `yes` 。

The default values for `haproxy_backend_cacert` and `haproxy_backend_cacert_dir` should suffice if the certificate is in the system trust store. Otherwise, they should be configured to a location of the CA certificate installed in the service containers.
如果证书位于系统信任存储区中，则 `haproxy_backend_cacert` 和 `haproxy_backend_cacert_dir` 的默认值应该就足够了。否则，应将它们配置为服务容器中安装的 CA 证书的位置。

Each backend service requires a certificate and private key. In many cases it is necessary to use a separate certificate and key for each host, or even per-service. The following precedence is used for the certificate:
每个后端服务都需要一个证书和私钥。在许多情况下，有必要为每个主机使用单独的证书和密钥，甚至为每个服务使用单独的证书和密钥。以下优先级用于证书：

- `{{ kolla_certificates_dir }}/{{ inventory_hostname }}/{{ project_name }}-cert.pem`
- `{{ kolla_certificates_dir }}/{{ inventory_hostname }}-cert.pem`
- `{{ kolla_certificates_dir }}/{{ project_name }}-cert.pem`
- `{{ kolla_tls_backend_cert }}`

And for the private key:
对于私钥：

- `{{ kolla_certificates_dir }}/{{ inventory_hostname }}/{{ project_name }}-key.pem`
- `{{ kolla_certificates_dir }}/{{ inventory_hostname }}-key.pem`
- `{{ kolla_certificates_dir }}/{{ project_name }}-key.pem`
- `{{ kolla_tls_backend_key }}`

The default for `kolla_certificates_dir` is `/etc/kolla/certificates`.
的 `kolla_certificates_dir` 默认值为 `/etc/kolla/certificates` 。

`kolla_tls_backend_cert` and `kolla_tls_backend_key`, default to `{{ kolla_certificates_dir }}/backend-cert.pem` and `{{ kolla_certificates_dir }}/backend-key.pem` respectively.
 `kolla_tls_backend_cert` 和 `kolla_tls_backend_key` ，分别默认为 `{{ kolla_certificates_dir }}/backend-cert.pem` 和 `{{ kolla_certificates_dir }}/backend-key.pem` 。

`project_name` is the name of the OpenStack service, e.g. `keystone` or `cinder`.
 `project_name` 是 OpenStack 服务的名称，例如 `keystone` `cinder` 或 。



 

Note 注意



The back-end TLS cert/key can be the same certificate that is used for the VIP, as long as those certificates are configured to allow requests from both the VIP and internal networks.
后端 TLS 证书/密钥可以是用于 VIP 的相同证书，只要这些证书配置为允许来自 VIP 和内部网络的请求即可。

By default, the TLS certificate will be verified as trustable by the OpenStack services. Although not recommended for production, it is possible to disable verification of the backend certificate:
默认情况下，OpenStack 服务将验证 TLS 证书是否可信。虽然不建议用于生产环境，但可以禁用后端证书的验证：

```
kolla_verify_tls_backend: "no"
```



## Generating TLS certificates with Let’s Encrypt 使用 Let's Encrypt 生成 TLS 证书 ¶

Let’s Encrypt is a free, automated, and open certificate authority.
Let's Encrypt 是一个免费、自动化和开放的证书颁发机构。

To enable OpenStack to deploy the Let’s Encrypt container to fetch certificates from the Let’s Encrypt certificate authority, the following must be configured in `globals.yml`:
要使 OpenStack 能够部署 Let's Encrypt 容器以从 Let's Encrypt 证书颁发机构获取证书，必须在 `globals.yml` ：

```
enable_letsencrypt: "yes"
letsencrypt_email: "<The email used for registration and recovery contact>"
```

The Let’s Encrypt container will attempt to renew your certificates every 12 hours. If the certificates are renewed, they will automatically be deployed to the HAProxy containers using SSH.
Let's Encrypt 容器将尝试每 12 小时续订一次证书。如果证书续订，它们将使用 SSH 自动部署到 HAProxy 容器。



 

Note 注意



If `letsencrypt_email` is not valid email, letsencrypt role will not work correctly.
如果 `letsencrypt_email` 电子邮件无效，letsencrypt 角色将无法正常工作。



 

Note 注意



If `enable_letsencrypt` is set to true, haproxy’s socket will run with admin access level. This is needed so Let’s Encrypt can interact with HAProxy.
如果 `enable_letsencrypt` 设置为 true，haproxy 的套接字将以管理员访问级别运行。这是必需的，以便 Let's Encrypt 可以与 HAProxy 交互。

## Generating a Private Certificate Authority 生成私有证书颁发机构 ¶



 

Note 注意



The certificates generated by Kolla Ansible use a simple Certificate Authority setup and are not suitable for a production deployment. Only certificates signed by a trusted Certificate Authority should be used in a production deployment.
Kolla Ansible 生成的证书使用简单的证书颁发机构设置，不适合生产部署。在生产部署中，只能使用由受信任的证书颁发机构签名的证书。

It’s not always practical to get a certificate signed by a trusted CA. In a development or internal test OpenStack deployment, it can be useful to generate certificates locally to enable TLS.
获取由受信任的 CA 签名的证书并不总是可行的。在开发或内部测试 OpenStack 部署中，在本地生成证书以启用 TLS 可能很有用。

For convenience, the `kolla-ansible` command will generate the necessary certificate files based on the information in the `globals.yml` configuration file and the inventory file:
为方便起见，该 `kolla-ansible` 命令将根据 `globals.yml` 配置文件和清单文件中的信息生成必要的证书文件：

```
kolla-ansible -i multinode certificates
```

The `certificates` role performs the following actions:
该 `certificates` 角色执行以下操作：

1. Generates a test root Certificate Authority
   生成测试根证书颁发机构
2. Generates the internal/external certificates which are signed by the root CA.
   生成由根 CA 签名的内部/外部证书。
3. If back-end TLS is enabled, generate the back-end certificate signed by the root CA.
   如果启用了后端 TLS，请生成由根 CA 签名的后端证书。

The combined certificate and key file `haproxy.pem` (which is the default value for `kolla_external_fqdn_cert`) will be generated and stored in the `/etc/kolla/certificates/` directory, and a copy of the CA certificate (`root.crt`) will be stored in the `/etc/kolla/certificates/ca/` directory.
将生成组合的证书和密钥文件 `haproxy.pem` （ `kolla_external_fqdn_cert` 这是 的默认值）并将其存储在 `/etc/kolla/certificates/` 目录中，CA 证书 （ `root.crt` ） 的副本将存储在 `/etc/kolla/certificates/ca/` 目录中。

## Generating your certificates without kolla-ansible 在没有 kolla-ansible 的情况下生成证书 ¶

If you want to manage your TLS certificates outside kolla-ansible directly on your hosts, you can do it by setting `kolla_externally_managed_cert` to `true`. This will make kolla-ansible ignore any copy of certificate from the operator to kolla-ansible managed hosts and will keep other configuration options for TLS as is.
如果要直接在主机上管理 kolla-ansible 之外的 TLS 证书，可以通过设置为 `kolla_externally_managed_cert` `true` 来实现。这将使 kolla-ansible 忽略从操作员到 kolla-ansible 托管主机的任何证书副本，并按原样保留 TLS 的其他配置选项。

If using this option, make sure that all certificates are present on the appropriate hosts in the appropriate location.
如果使用此选项，请确保所有证书都存在于相应主机上的相应位置。