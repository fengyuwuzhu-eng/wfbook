# Linux 关机和重启

[TOC]

## 概述

Linux 的文件系统缓冲一般在内存中变化，只是偶尔才把它们写回磁盘。这种方案使得磁盘 IO 速度更快，但是当系统被粗暴地中止时，这种方案也更容易使文件系统丢失数据。传统的 UNIX 和 Linux 机器要非常小心地处理关机方式才行。现代的系统已经变得不那么敏感了（尤其是当用户使用一个像 ext3fs 这样强健的文件系统时），但有可能的话，妥善关机总是一个好主意。

不恰当的关机可能产生隐蔽的小问题，从而导致重大灾难事故。在面向消费级用户的操作系统上，重新引导操作系统是适合处理几乎任何故障的第一课。而在Linux 系统上，最好首先考虑清楚，然后再重新引导机器。Linux 的故障更微妙、更复杂一些，因此，盲目地重新引导系统只会在很小比例的场合下起作用。还有，Linux 系统引导所花费的时间很长，这对于多用户来说是不太方便的。

当添加一种新硬件或现有硬件出现问题甚至不能够复位时，通常需要重新引导系统。如果所修改的配置文件只有在引导过程中才使用的话，那么，要让改动起作用，也必须重新引导系统。如果系统出现故障，使得用户不能够登录进入系统去正确地诊断故障，这时显然除了重新引导系统以外别无选择。只要修改启动脚本，就应该重新引导系统，以确保系统能够成功地运行起来。如果时隔几个星期之后才发现问题，那么就不太可能回想起最近所做修改的细节。

引导系统本质上只能用一种方法来完成，与此不同的是，关闭或重新引导系统有许多种方法。这些方法如下：

* 关闭电源。
* 使用 shutdown 命令。
* 使用 halt 和 reboot 命令。
* 使用 telinit 来改变 init 的运行级别。
* 使用 poweroff 命令告诉系统关闭电源。

正确的关机流程为：sync > shutdown > reboot > halt

sync 将数据由内存同步到硬盘中。

## 关闭系统

### 关闭电源

即使是在桌面系统上，关闭电源也不是关闭系统的一个好方法。这样做有可能丢失数据和破坏文件系统。

许多机器有一个“软电源开关”，当用户按下电源按钮时，机器实际上运行一串命令来执行关闭系统的正确操作。如果不清楚自己的机器是否提供这个特性，那么不要按下电源按钮来证明这一点！最好是自己去执行这一串关闭系统的操作。

不过，这并不是说绝对不可以关闭电源。在发生紧急情况时，如果没有足够的时间来妥善关机的话，那么关闭电源也是可以的。老式机房经常有一个“意外事件处理按钮”可以立即关闭所有设备的电源。

### shutdown

shutdown 是停止或重新引导系统，或者返回到单用户模式的最安全、考虑最周到的、最彻底的方式。

可以让 shutdown 在开始关闭系统以前等待一定的时间。在这个等待的过程中，shutdown 以越来越短的时间间隔发送一些消息给已经登录的用户，警告用户关闭系统的时间即将到来。默认情况下，这些警告消息只是说系统即将关闭并给出离关闭系统还剩的时间，管理员也可以提供自己的简短消息。消息应该说明为什么要关闭系统、并应该估计多长时间以后用户可以再次登录进入系统（比如，上午11:00 恢复）。在大多数系统上，立即执行 shutdown 时，用户是不能够录进入系统的，但如果管理员设定自己的消息，那么用户能够看到消息，从而明白是怎么回事。shutdown 让管理员指定当该任务完成后，机器是应该停机 (-h) ，还是重新引导 (-r) 。还可以指定在重新引导以后是强制使用 fsck 命令检査磁盘 (-F) ，还是不检査 (-f) 。在默认情况下，只要文件系统是正确卸载的，Linux 系统会自动跳过 fsck 检查。

可以指定一个时间字符串（通常是 now 或者用 hh:mm 指定小时/分钟）作为第一个参数。额外地，也可以设置一个广播信息在系统关闭前发送给所有已登录的用户。

重要：如果使用了时间参数，系统关机前 5 分钟，会创建 `/run/nologin` 文件，以确保没有人可以再登录。

```bash
shutdown
shutdown now
shutdown 13:20  
shutdown -p now                                          # 关闭机器
shutdown --poweroff hh:mm                                # hh:mm 是 24 小时时钟格式的时间。
shutdown -h now                                          # 停止机器，而不关闭机器的电源
shutdown –h +10                                          # 十分钟后关机
shutdown --halt +m                                       # 延迟 m 分钟，停止机器，而不关闭机器的电源。now 等同于 +0 。
shutdown -c                                              # 取消即将进行的关机
shutdown –h 10 ‘This server will shutdown after 10 mins’ # 计算机将在10分钟后关机，并且会显示在登陆用户的当前屏幕中。
shutdown –h 20:25                                        # 系统会在今天20:25关机
```

### halt

halt 命令执行关闭系统所需要的基本任务。它可以被 shutdown -h 调用，也可以单独使用。halt 记录关机的情况，终止那些非必需的进程，执行 sync 系统调用（被 sync 命令调用并与 sync 命令等效），等待文件系统写操作完成，然后停止内核。

halt -n 不执行 sync 调用。在 fsck 修好了根分区之后会用到这条命令。如果 fsck 没有使用 -n 选项，那么内核可能会用内存中缓存的超级块的老版本覆盖 fsck 的修改。

通知硬件来停止所有的 CPU 功能，但是仍然保持通电。可以用它使系统处于低层维护状态。注意在有些情况会它会完全关闭系统。

等同于 `shutdown –h now` 和 `poweroff`

```bash
halt               # 停止机器
halt -p            # 关闭机器
```

### poweroff

会发送一个 ACPI 信号来通知系统关机。

poweroff 命令等价于 halt，不同之处是在 Linux 关闭后，poweroff 可以向电源管理系统（在有这项功能的系统上）发送一则请求来关闭系统的主电源。这项功能易于实现远程关机（例如，在一次供电故障期间）。

```bash
poweroff           # 关闭机器
poweroff --halt    # 停止机器
```

### systemctl

要关闭系统，可以直接使用 `systemctl` 工具，或者通过 `shutdown` 命令来调用这个工具。

使用 `shutdown` 命令的好处是：

- 支持时间参数

  这对于计划的维护特别有用。此外，用户还有更多时间来对计划的系统关闭的警告做出反应。

- 取消关闭的选项

要关闭系统并关闭机器的电源

```bash
systemctl poweroff
```

要关闭和停止系统而不关闭机器的电源

```bash
systemctl halt
```

> 注意：
>
> 默认情况下，运行其中任何一个命令都会导致 systemd 向当前登录到该系统的所有用户发送一条信息性消息。要防止 systemd 发送此消息，请运行所选的带有 `--no-wall` 命令行选项的命令。

### telinit

使用 telinit 可以指引 init 进入特定的运行级。例如：

```bash
telinit 0
```


在使用 telinit 的时候，不会得到像 shutdown 那样友好的警告消息或者善意的等候时间，所以在大多数情况下，可能都要避免用到它。对于测试对 inittab 文件的修改来说，telinit 是最有用处的。

## 重启系统

### shutdown

```bash
shutdown -r 09:35                                        # 在 09:35am 重启机器
shutdown -r now											 # 立即重启系统
```

### halt

```bash
halt --reboot      # 重启机器
```

### poweroff

```bash
poweroff --reboot  # 重启机器
```

### reboot

通知系统重启。reboot 几乎跟 halt 完全一样，只不过它是让机器重新启动，而 halt 是让机器停止。reboot 由 shutdown -r 来调用。与 halt 类似，它也支持 -n 参数。

等同于 `shutdown –r now` 。

```bash
reboot             # 重启机器
reboot --halt      # 停止机器
reboot -p          # 关闭机器
```

### systemctl

```bash
systemctl reboot
```

> 注意：
>
> 默认情况下，这个命令会让 systemd 向当前登录到该系统的所有用户发送一条信息性消息。要防止 systemd 发送此消息，请运行带有 `--no-wall` 命令行选项的这个命令。

### telinit

使用 telinit 可以指引 init 进入特定的运行级。例如：

```bash
telinit 6
```

## 挂起系统

```bash
systemctl suspend
```

该命令在 RAM 中保存系统状态，除了 RAM 模块外，关闭机器中的大多数设备。当重新打开机器时，系统会从内存中恢复其状态，而无需再次引导。

由于系统状态保存在 RAM 中，而不是保存在硬盘上，因此，从挂起模式恢复系统比从休眠模式恢复要快得多。但是，请注意，暂停的系统状态也容易受到断电的影响。

## 休眠系统

```bash
systemctl hibernate
```

该命令在硬盘驱动器中保存系统状态，并断开机器电源。当重新打开机器时，系统会从保存的数据中恢复其状态，而无需再次引导。 

由于系统状态保存在硬盘上，而不是保存在 RAM 中，因此机器不必保持对 RAM 模块的供电。但是，因此，从休眠模式恢复系统要比将其恢复为挂起模式恢复要慢得多。

另外，要休眠并挂起系统，请运行以下命令：

```bash
systemctl hybrid-sleep		
```

## systemctl 的电源管理命令

| `systemctl` 命令         | 描述             |
| ------------------------ | ---------------- |
| `systemctl halt`         | 关闭系统。       |
| `systemctl poweroff`     | 关闭系统。       |
| `systemctl reboot`       | 重启该系统。     |
| `systemctl suspend`      | 挂起系统。       |
| `systemctl hibernate`    | 休眠系统。       |
| `systemctl hybrid-sleep` | 休眠并挂起系统。 |

