虛擬機器雖然邏輯上是一部完全獨立的主機，但是畢竟用到的就是實體的主機資源。因此，當虛擬機器要使用實體資源時， 就得要透過一組軟體來控制～這組軟體就稱為虛擬機器監督器 (hypervisor) 了！基本上常見的是這兩個：

- Xen：目前由 Citrix 公司繼續維護與發展，有自由軟體的分支可使用；
- KVM：直接納入 Linux 核心的監督器，安裝好 Linux 立刻就能用這個監督器了

事實上無論是 Xen 還是 KVM，這兩個軟體僅是作為硬體資源監督，且大部分在傳達 CPU 指令功能，在一般『電腦其他硬體』的模擬方面， 還得要透過其他軟體的支援才行！其中一個名為 qemu 的軟體，就是用來模擬各種週邊硬體的！包括主機板晶片組、網路卡、USB、顯示卡等等， 就是透過 qemu 這套軟體來達成的！這兩個軟體的相關性簡單的用下圖來做個說明：



​	![KVM + Qemu](https://linux.vbird.org/linux_server/rocky9/0110mytalk/Kernel-based_Virtual_Machine.png)


上圖最上方的 KVM guest 就是一個虛擬機器，你可以在 Linux 系統上面建立多個 KVM guest (只要你的硬體資源如 CPU 與記憶體足夠的話！)， 且透過 qemu 去模擬各個週邊，就能夠在一部實體機器上建立多個虛擬機器來同時操作囉！不過，如果每個 KVM guest 都得要自己手動設定與處理， 這些參數很難搞定～因此後來就有統一控制這些 guest 的管理平台出現了！目前 RockyLinux 上面就使用 libvirtd 這個 daemon 來管理！ 不過，libvirt 其實使用度是相當廣泛的，他僅是一個中介界面，可以管理相當多的虛擬機器監督器呢！

​	![libvirt](https://linux.vbird.org/linux_server/rocky9/0110mytalk/Libvirt_support.png)
 圖 0.1.6、Libvirt 中介軟體示意圖 (https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine) 



- IPv4 與 IPv6

目前我們所在的世界，沒有網路應該是很難想像的一件事～而如果想要理解伺服器的網路運作，沒有網路基礎的話，會很麻煩！ 如同上一小節提到的，IoT 應該是未來的趨勢，那麼所有的節點應該都需要有網路連接，有網路連接基本上就應該要有 IP 位址， 但是 IPv4 的 IP 位址在前幾年就已經發派完畢，目前已經沒有新的 IP 位址可用了。那我們還需要這麼多的物件來連線，怎辦？ 這就需要 IPv6 的支援！嗄！這啥鬼？不懂就慘了！對不對！詳細 IPv6 留待後面我們慢慢來講！

```
[vbird@localhost ~]$ ip addr show
3: enp0s7: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 52:54:00:00:02:80 brd ff:ff:ff:ff:ff:ff
    inet 192.168.100.180/24 brd 192.168.100.255 scope global noprefixroute enp0s7
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe00:280/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
# 上面 inet 是 IPv4，而 inet6 則是 IPv6 的 IP 位址～看不懂對不對～
# 沒關係！後面章節我們慢慢再來談！
```

- 區域網路功能與網路速度單位

另外，你也會經常聽到區域網路對吧？那區域網路是什麼？他可以讓你的主機之間進行什麼動作？你的防火牆可以針對整個區域網路做些什麼設定？ 區域網路的 IP 位址表示法又是什麼等等～如果你不清楚，那麼伺服器的防火牆設定，會讓你非常非常頭疼！

目前的網際網路速度越來越快，據說已經有 100Gbps 的設備已經在開發中，伺服器等級的設備大多已經內建 10Gbps 的網路晶片組， 甚至一般家用的系統，也都內建了 2.5Gbps, 5Gbps 的網路速度了！真是飛快！ 你知道這個數據代表的是什麼意思嘛？這些超級快的網路能夠用在哪裡？每一部電腦都可以使用到這麼快的速度嘛？ 如果整個區域網路裡有這麼一個高速的設備存在，所有的主機都能夠享用的到嘛？如果不懂網路基礎，那你的 $$ 肯定會花錯地方！

```
[vbird@localhost ~]$ ethtool enp3s0f0
Settings for enp3s0f0:
        Supported ports: [ TP ]
        Supported link modes:   100baseT/Full
                                1000baseT/Full
                                10000baseT/Full
                                2500baseT/Full
                                5000baseT/Full
        Supported pause frame use: Symmetric
.....
        Speed: 10000Mb/s
.....
# 重點在於：單位！Mb/s 是什麼單位？ Mbytes/s 又是什麼單位？這很重要！
```

- 網路佈線

網路佈線一直是網路管理者心中最大的擔心！因為一個佈線不良，可能會影響到好幾年的工作效益！有摸過一點點網路的朋友都知道 RJ-45 的『水晶頭』， 網路也有一堆人在教你如何壓制水晶頭～問題是，如果你需要的環境是 10Gbps 以上的網路速度的環境， 自己壓水晶頭有沒有關係？又該使用什麼等級的網路線？為什麼外觀看起來一模一樣的網路線，只是列為『等級不同』就差好多好多錢？ 這就是我們需要注意的部份！

- 網路磁碟機與主動備援線路

有很多所謂的網路磁碟機架構，就是讓 server 透過網路去取得一個網路『硬碟』來使用～我們都知道，主機的硬碟如果死掉， 你這部系統當然就會卡卡並且可能立刻就不能用了！那麼網路來的『硬碟』當然就是吃網路囉！那...如果網路線鬆脫， 或者是網路流量增加導致網路暫時停頓，那這個網路硬碟『可能就會被判斷為損毀』的情況～此時，你可能會需要使用到兩條以上的線路來備援！ 咦！兩條網路線？那怎麼共用一個 IP 位址來連線呢？這就是我們需要理解的！

- 為什麼使用 https 以及為什麼網路會變慢？

現在很多 ISP 公司都直接告訴你，所有的服務請加密！為什麼要加密啊？不加密行不行？當然行！不過，後果請自負～ 那，為什麼不加密的資料可能會被竊取？這就涉及到基本乙太網路的傳輸協定了！如果不清楚這個協定，你當然也就不知道怎麼防備！

你也會經常發現你的客戶或朋友說：『咦！怎麼網路又變慢了！』好！想一想，怎麼找出來變慢的原因？是你的網路環境？ 伺服器的 loading 過高？你的電腦裡面有問題？該網路服務本身就慢，其實是網際網路的線路被挖斷了嘛？還是地震導致海底電纜又斷了？ 等等，都需要你理解網路基礎後，才有辦法進一步釐清問題～這也是統管理員應該要學會的基礎技能喔！

- 虛擬化網路

最後，未來大多是虛擬機器的世界，這種世界裡面的網路設定與細分，就得要透過一些虛擬的網路界面來搞定。 因為你看不到實際的線路，所以如果不懂得網路拓樸的大致圖示，可能會導致挺嚴重的後果！此外，最單純的網路卡模擬， 也是得要透過所謂的實體網卡的橋接 (bridge) 才能模擬的出來！所以，這些基礎功不能不知道的喔！

​	![qemu bridge](https://linux.vbird.org/linux_server/rocky9/0110mytalk/qemu_br.jpg)


上面只是提出一些你為什麼需要學習網路基礎的原因而已，還沒有講重要的概念與原理喔！所以你都看不懂也沒關係！我們會在後面慢慢談。 不過，永遠在你心理先有個概念，網路基礎好重要啊！這樣就好了！



另外，這是一本自學的文件，所以拿來作為教科書講解，可能會有些許的不便。最大的不便大概就是作業的份量太少了... 大部分的實做都已經在個章節實做流程當中跑完，所以當然不會有太多的課後習題～如果老師們想拿來作為教科書， 或許應該可以參考鳥哥另一個專門用來作為上課訓練的教材較佳：

- http://dic.vbird.tw/linux_server/

本文件的流程與訓練跟一般教科書與其他書籍差異很大，因為主要的目的是讓網路新手可以有個入門的方向，同時不只入門， 而是希望能夠讓入門者『真的理解各個流程在幹麻』，以及『架設這個 server 的原理、目的與手段』通通有個理解， 因此整個維持鳥哥的一貫作風，就是...非常囉唆...如果你只想要速成的話，使用 google 查查關鍵字就能找到一堆方便的教學， 甚至直接給你完整答案的教學文章～但那畢竟只是讓你解決燃眉之急。總之，建立良好的學習態度是在 Linux 基礎篇裡面就持續的談到， 鳥哥在這裡更可以建議你，甚至可以直接到官網找資料來閱讀就好，都比讀一些速成的書要好的多！^_^

- 努力自己找出問題點

因為種種原因，每個系統可能產生的問題都會不一樣～包括連 SELinux 產生問題時，setroubleshoot 的方案都一堆了！ 只要能找到問題並且解決就好了！沒有一定的解決方案～只要能解決問題，大部分都是好方案！只是，當下次出現相同的問題時， 請務必使用相同的方式去解決～並且能夠順利解決該問題，那麼這應該就是一個可以做成 SOP 的好方案～盡速記錄在自己的工作日誌內！ 這都是未來自己的資產！

鳥哥上課的時候，最怕學生寫一行指令，就轉頭問，這樣指令寫對不對？然後執行了，產生的訊息完全不看，就又接著敲第二個指令， 還沒有按下 enter ，又舉手轉頭過來問，這個指令對不對...我很想請教一下學生，你們未來出社會，去工作的時候，會拿著電腦問你的老闆說， 老闆，這樣打字對不對嗎？

請自己測試，自己查閱出現的結果，自己了解一下為什麼指令要這樣下達！指令的目的是讓你完成工作， 那麼你想要完成的目標是什麼？先自己搞清楚，那麼出問題的機會就不大！如果凡事都要問專家，那麼你怎麼成為專家？ 因為專家的經驗永遠是專家的！你無法學習到～只有自己碰到問題，詢問可能解決的方向，然後自己朝著方向找出答案， 這過程當中的訓練以及得到的經驗，才永遠是你的！

Linux 系統當中，很多的問題與訊息都會紀錄在 /var/log/ 裡面，即使目前已經大量使用 systemd 的 journald 服務， 不過，大部分的 Linux distributions 還是預設會啟用 rsyslog 服務 (你也可以自己手動強迫啟用)。另外，某些複雜的服務也有自己的 log 檔案， 同時，這些服務也能夠自己指定 log 的複雜度。當開始處理這些服務時，為了理解服務的流程，或許可以將 log 的訊息標準訂低一點， 也就是一堆基本資訊也會紀錄起來的意思，讓你可以完整掌握服務的訊息。等到穩定了，再將訊息等級調高一點，讓訊息更為精簡有效～ 這些動作不要小看，系統管理員經常是透過分析這些 log 來理解系統運作的狀況，並且進一步提前處理可能或即將產生的錯誤哩！

​	鳥哥的系統很多都有 RAID 組成，因為實在很擔心硬碟出錯，所以鳥哥都會讓系統每日自己偵測 RAID 的硬碟健康狀態， 然後做成 email 傳送到我的信箱。根據這個信箱的 log 信件，通常可以提早發現是否有出問題的硬碟，提早更換， 可以避免資料的損毀啊！ 



### 0.2.2、章節編排的流程設定-網路基礎與虛擬機器

如前所述，沒有基礎功，想要架設網站，鳥哥的個人建議是...還是花錢請專家幫你搞定比較合理！那，有 Linux 基礎功了呢？接下來要怎麼辦？ 這裡談談鳥哥的理想。

- 不只是伺服器管理員，而是機房管理員

鳥哥希望大家能夠站在『管理機房』這樣的角度來思考你的伺服器學習。談到『機房』，你可能就會想到裡面有全年無休的冷氣、冷的要命的環境、 好吵好吵的風扇、多的要命的電腦主機、永遠持續閃爍的網路交換器燈號等等。事實上，沒錯！機房就是這樣。先不考慮散熱或者是綠色能源使用， 先講講，如果要你控制一棟大樓的網路環境，你該如何設計網路？你的防火牆應該放置在哪個環節上？你的大樓有幾個比較機密的單位， 他們家的網路需要額外切開，你該如何管理進入該網域的權限？

在現在這個磁碟容量大到變態的環境下，任何人使用資訊相關系統都已經不在乎檔案容量了。可以想像得到的是，你的磁碟永遠都會不夠用！ 所以可以彈性增加的網路磁碟就顯的重要。但是，你也知道網路磁碟機的『網路狀態』不可以斷線！斷線代表『主機的硬碟損毀』了！ 這當然會讓系統整個爆炸！因此，你該如何管理這些重要的網路磁碟裝置的『網路容錯率』？這都需要學習！

所以，整個機房的管理員不是只要設定好你的單部伺服器就好，還得要隨時注意整個區域網路的其他設備的相依性， 隨時做好區網主機的可抽換彈性變動。這些設定與想法，沒有扎實的網路基礎來輔助，會很麻煩！所以，一定要從網路基礎開始學習， 完全不可以略過。

- 雲程序的虛擬機自我建置

既然要學習管理機房，所以你得要購買足夠的設備！包括可能數十台主機硬體、好幾台主幹交換器、好多的 CAT6A 線路， 以及動輒數百台計算的個人電腦，這樣才算是個基礎的機房環境，對吧！咦！光是學習的初設費我們就得要傾家蕩產了！哪有時間學習啦！ 趕快去賺錢！不要往下看了 (大誤...)。

這一章一開始不是一直談到雲端虛擬機器嘛？我們一台實體主機 (鳥哥預計使用 Intel 10 代 i5 等級的 CPU 搭配 32G 以上的記憶體環境來處理) 可以生出大約  10 台以上的 server 數量，然後，還可以設計多個不同的虛擬橋接設備來劃分出不同的子網路。也可以透過 VLAN 來讓網路邏輯上完全獨立！ 另外，如果你的一部實體主機無法產生這麼多的虛擬設備，那麼使用兩部以上的實體主機來模擬總可以吧？是可以啦！ 但是我們的虛擬機可能都是綁在內部，透過這樣來模擬實體機器的對外 (WAN) 與對內 (LAN) 的實際環境～那兩部實體主機的虛擬機器不就無法溝通了？

沒關係～我們可以透過第二張網卡的橋接，也可以透過第一張網卡設計 VLAN 來讓實體網卡拆開成為兩個區段， 一個區段給 WAN 使用，一個區段給內部 LAN 使用。總之，就有很多種的設計方式！

由於虛擬機器的玩法相當多樣，也能夠讓我們在花費比較少 (一部實體機器) 的情況下來理解整個網路的實際連線情況， 更可以透過這樣的環境來模擬機房『網路內外分離』的情境，所以，當然就得要來學一學啊！

不過讀者們還是得要注意，我們的模擬環境許多的建置是要讓你『理解為什麼要這麼做』，而不是實際上會在虛擬機上面這樣搞！ 所以，在設計種種的連線與伺服器/用戶端的交互連線時，大家還是要在腦袋理面實際想出整個連線的架構才好！

- 第一部份的章節安排

如上所述，網路基礎與虛擬機器的預先建置是本書最重要的一環！所以，鳥哥會先以一個實際的網路環境搭配硬體安裝好一部 Linux 小雲系統， 然後建立第一個虛擬機器，並且做好適當的防護之後，再來繼續聊聊網路基礎，並且透過一部測試用的虛擬機器進行各項網路基礎的練習。 等到網路基礎介紹完畢之後，再實際講講系統如何做防備，以及如何連結上 Internet，接下來就準備進行各項區域網路內常見伺服器的架設。 第一部份預計會講到這些喔：

- 小型雲系統與主機安全強化流程
- 第一個虛擬機器的安裝與調整
- SELinux 初探
- 網路基礎、Linux網路設定與網路偵錯
- ....





企業總是會有很多的只提供給企業內部使用的服務，包括檔案伺服器、時間伺服器、代理伺服器、網路磁碟系統、帳號控制伺服器等等。 尤其是有異質平台作業系統的情況下，若能整合帳號控制，對於整個企業內部的帳號控管，真的幫助很大！為此， Windows 有開發出 AD 系統， Linux 有老牌的 NIS 服務。但若需要跨平台，可能還是得要使用 LDAP 會比較好！

想一想，同時有 10 個人頻繁的讀寫資料到 Server 去，你的 Server 如果只有一張網路卡，那麼效能瓶頸可能就卡在那張網路卡上面。 如果有 10G 網路當然是最好！不過 10G 網路還很貴～那能不能安裝多片網卡到 Server 上，再將這些網卡綁定在同一個 IP 上？ 這樣不就可以增加頻寬了？沒錯～有這功能～這就是 bonding 與 teamd ！所以，這個區域網路內的環境介紹，我們也會加上這個特別的功能！

- 內部伺服器是要服務誰？

總之，機房管理員請注意，你在企業內部的所有服務都是用來『服務自己的同事』，同時『請將自己的同事想成是白痴』， 因此，許多的設定需求請盡量簡單～不要用政治人物的講話方式來說明，請用小學老師的講話方式來解釋，盡量讓同事可以快速、便捷且沒有傷害的操作資訊系統！

但是反過來說，對於跟著自己做事的資訊領域的同事來說，那就不能用上面的態度來處理～畢竟你的資訊方面同事是『可能會直接存取你的重要系統』的一群人！ 因此，你必須要嚴格的把關才行！例如許多比較機密的資料要嘛就不要放行，要嘛就一定要嚴格的教育訓練。

基本上，這個部份會談論到的服務有：

​	

- 區域網路的 DHCP, DNS 與 NTP (虛擬機器重整)
- 遠端連線伺服器 ssh, VNC, XRDP
- bonding、teamd與 VLAN
- LDAP 伺服器
- Kerboros 與 NFS 服務
- Samba 與跨平台帳號控制
- iSCSI 伺服器



### 0.2.4、章節編排的流程設定-網際網路伺服器

伺服器的建置裡面，你一定會思考到要使用 Web server 吧？不過，其實建立 Web server 的第一個重點在於選擇一個好的主機名稱耶！ 而選擇一個好的主機名稱最重要的就是建置 DNS 伺服器耶！因此，在網際網路伺服器的章節裡面，我們會從 DNS 伺服器講起， 然後再帶入 Web & FTP 以及郵件伺服器。

另外，在 Web server 的角度裡面，我們經常需要建置 Data base 的相關工作，所以在這些章節裡面也簡單的介紹一些建立 SQL 資料庫的帳號密碼， 同時增加資料庫的重建與簡易的 SQL 查詢方式。

由於網頁前端與後端工程師都需要長時間的培養，因此這裡不可能直接講解所有的 SQL 技術以及 PHP 或 python 的語法， 只是提供一個基礎的操作而已啦！如果對網頁設計有興趣，也可以參考鳥哥在學校授課所寫的教材：

- https://dic.vbird.tw/webdesign/

- 那，網際網路伺服器又是在服務誰？

話說內部伺服器主要在服務自己的同事，而且由於可能是服務『生產者』(實際 coding 或者是管理圖形影像編輯等，會讓系統 loading 加重的工作)， 所以你得要時時將系統調整到最快速！因為網路走內網，要讓系統加速的方式太多了！要仔細的考量考量。

那網際網路服務的對象呢？當然就是貴公司的客戶囉！或者是一般大眾消費者。雖然說網路頻寬越來越大，但如果同時間有太多的連線要求， 你的頻寬還是會被用光光。所以，隨時做好不斷線，然後將資料壓縮，或將資料削減 (例如網路圖檔解析度當然不用太大，因為在瀏覽器上面看， 1024 解析度跟 3096 像素的解析度是不會差太多的！但是檔案容量差很多...)，都是一些優化的好方案。而且，由於是走網際網路， 所以效能瓶頸大多是卡在公司對外的那條線路上，要增加頻寬只有再付錢給 ISP 這樣的方法而已～所以，在有限的資源下， 如何創造最大的效益，可能就是身為機房系統管理員的你的最重要任務囉！

- 監測： fail2ban, knockd 等





本課程實際連上雲端系統，主要是透過 gocloud 以及 spice remove viewer 的軟體，學生可以自行從網路下載最新版軟體：

- Windows 版本：https://virt-manager.org/download/(選擇 Win_x64.MSI 即可)
- Windows 版本：https://releases.pagure.org/virt-viewer/virt-viewer-x64-3.1.msi(這是 3.1 版本)
- MAC (OSx)版本：https://people.freedesktop.org/~teuf/spice-gtk-osx/dmg/(選擇 0.5.7 版本即可)

由於有兩個不同的系統在操作，加上你的使用機器共三個作業系統在操作，可能會有些無法掌握的情況，這也是平時系統管理員所會遭遇的狀態！ 所以，慢慢學習！總是會有進步的。另外，本門課程的內容大部份是有延續的，因此，請盡量不要缺課～若有缺課的情況，也請跟同學詢問上課的進度， 跟好進度才好喔！

- Server/Client 的環境與平時操作

為了模擬正常的系統操作環境，因此本課程在 Server 處僅提供純文字界面，並沒有圖形界面的提供，因此預設的畫面就是黑壓壓一片。 並且 Server 為最小安裝！因此讀者需要花時間去重建自己熟悉的環境 (這也是應該要會的基本技術)。不過如果拿這個畫面來上課， 可能大家都會想死～因為畫面實在是不好讀取 (連廣播或投影都很麻煩)。因此，課程中會使用 client 端的機器啟動圖形界面， 再透過圖形界面來連線到 Server 上！

- 評分基準

就如首頁談到的，評分就是平時成績 30%、期中考 30%、期末考 40%，每週進度的最後都會有習題，請回家連上雲端虛擬機來練習即可。 而每週練習偵測腳本會放置於本網站的平台上，請下載後處理上傳！

期中考與期末考一樣的動作，可以帶書、帶筆記，但不能帶任何電子產品與影印的文件資料。

### 1.2： Linux Server 的基礎防護

你的 Linux 作業系統要怎麼安裝？這與你的 Linux 系統使用情況有關。如果是作為 Internet Server 使用，一般建議使用最小安裝來處理較佳。 如果是作為虛擬化伺服器，那一開始就安裝成虛擬化主機即可 (在挑選軟體時可以考慮的安裝方式)。如果是測試機，那安裝具有 GUI 界面的伺服器。

如果想要進一步理解怎麼安裝最小化的 Linux 作業系統，請參考下列連結：

- [最小安裝 Linux OS](http://linux.vbird.org/linux_basic_train/unit15.php)

如果你是剛剛接觸 Linux 的新手，那建議先不要上這門課，你應該要先去看看 Linux 基礎學習，等到學的差不多，再回來繼續閱讀底下的文件喔！

- [基礎學習篇-上課用](http://linux.vbird.org/linux_basic_train/)
- [基礎學習篇-自學用](http://linux.vbird.org/linux_basic/)

- I. root 慣用環境的建置

大家都會說『工欲善其事，必先利其器』，不過到底要怎麼做啊？呵呵！每個人習慣的作業環境都不一樣，但是某些軟體總是會需要的！ 因此，你得要先將你的 Linux 作業系統搞成你習慣的環境，這樣未來要管理比較方便嘛！

​		例題 1.2.A：取得虛擬機器的環境 	

1. 依據老師寫的資料，請在上課的網站上面註冊兩個帳號，一個是『你的學號_server』，一個是『你的學號』， 	注意註冊時，一定要使用正確的姓名，否則老師不會將你的帳號開通的
2. 主要的伺服器大多使用『你的學號_server』來建置(環境會與一般系統不同)，用戶端系統則主要用『你的學號』來建置
3. 請使用『你的學號-server』帳號登入，登入後啟動『 LinuxServer-伺服器 』的雲端虛擬機器，開始準備使用系統。
4. 雲系統的帳號 student, 密碼 mystdgo，且具有 sudo 的功能了！

取得上述的資料後，現在請登入該系統，然後操作一下該系統。請注意，該系統為最小安裝，所以幾乎什麼都沒有～ 未來你得要自行慢慢加上所需要的軟體才行！

​		例題 1.2.B：處理預設的網路環境與相關的操作軟體安裝 	

1. 因為預設沒有網路，現在請先以 DHCP 的方式來啟動你這部虛擬機器的網路，同時由於沒有 ifconfig， 		所以請使用 nmcli 或者是 ip 來觀察網路即可。
2. 你有很多軟體還沒有安裝，最重要的就是 vim 以及指令參數補全的功能！所以，請安裝 vim-enhanced 及 bash-completion 軟體。
3. 使用 yum whatprovides "*sbin/ifconfig" 之類的方式找出你所欠缺的軟體名稱為何？然後直接安裝上去！
4. (hint)安裝完 bash-completion 之後，你可能需要登出再登入，這樣才會讓 bash 的參數補全功能生效喔！
5. 我們應該需要網路校時才對，請安裝 chrony 軟體，並且編輯 chrony.conf 設定檔，加入 ntp.ksu.edu.tw 時間伺服器， 	並重新啟動後，使用 chronyc tracking 或 chronyc sources 檢查連線是否成功？最後設定每次開機都會啟用時間同步。

上個學期我們常用的軟體功能大概就是這些，先完成這些軟體的基礎安裝後，我們比較好處理後續的各項任務啊！ 另外，上面的動作都可以用在未來系統操作過程中，若有些指令不存在系統中時，就是透過上述的方法來安裝使用的。

- II. 封包進入 Server 的基本流程

如果通過了上述的考驗，那麼我們可以進一步來理解，你該如何防衛你的 Linux 作業系統呢？先來看一下封包進入主機的基本流程圖：

![img](https://dic.vbird.tw/images/link_to_myhost.gif)

1. 先要通過 TCP/IP 的相關規範才能夠連線到本機的網路門口
2. 要先通過防火牆的規則管制，才可以進入到本機使用本機的服務
3. 能否取得服務與這個服務是否啟用與相關設定有關 (發生問題可以查登錄檔)
4. 能否實際存取資料，首先要看有沒有啟動 SELinux 這個細部權限設定項目？
5. 全部都放行後，最後能不能存取資料，還是跟資料檔案的權限 (rwx) 有關！

所以上面就是你在架設 Server 時，需要注意到的各項事情了！

- III. 防火牆有沒有用？軟體升級有沒有用？設定 chmod 777 會不會出事？

很多網路介紹的文件都不是很清楚，你應該要搭配上一張圖來理解底下的問題：

1. 防火牆是沒屁用的，對正常提供的服務來說：
    	從前一個項目的圖示來看，如果你是 WWW 伺服器，那一定就是要放行 port 80，因此，若 port 80 出問題， 	那你的防火牆當然一點用處也沒有。
2. 防火牆是很有用的，對需要保護的服務來說：
    	如果你的服務中，例如 ssh 的服務，僅放行給部份的來源 IP 位址，則此時防火牆保護危險的服務，就很有用處了！
3. 軟體更新是一定要的，對連上 Internet 的伺服器來說：
    	一般來說，軟體如果沒有問題，或沒有加入新功能，是不會隨意升級的。因此，如果官網有公告最新的軟體升級資訊， 	當然最好就是一定要升級到最新！至少能夠預防一大堆可能的系統漏洞
4. 軟體更新是非必要的，對提供給內部特定用途的軟體來說：
    	崑山資傳系主要透過自建的 DRBL 搭配 Clonezilla 以及 partclone 再加上 PHP 的功能來進行電腦教室的佈建。 	過去曾經因為 clonezilla 不同版本所支援的參數不同，導致 PHP 程式無法順利呼叫 clonezilla 的困擾。鳥哥自己的 cluster 跑模式用 Linux Server， 	也因為內部的環境已經建置妥當，而且該系統基本上是不連網的，所以，此時你的系統應該『不要隨便升級』！ 	或者是說：『不要隨便升級特定的內部服務軟體』！
5. 權限設定的理解是基礎中的基礎：
    	如果你的網路服務僅提供讀取的功能，那麼即使你的檔案權限放行 777 可能都還不會出事。但是如果你的這個服務設定錯誤呢？ 	如果你的這個服務因為漏洞所以被攻破呢？那麼你的檔案如果是 777 ，很好！那就是完全的被拿走了...
6. 正規伺服器 (沒有自己撰寫怪異的程式腳本)，請一定要啟動 SELinux ：
    	SELinux 可以管理網路程序 (本機程序通常不管理)，讓這個網路程序僅能在某些目錄內工作，而且只能進行某些行為， 	因此，即使你的這個網路軟體被攻破，而且權限還是 root 時，它還是無法完整的操控你的系統！

- IV. 伺服器本機的防護：升級到官方最新的軟體版本

升級整個系統就能夠讓系統保有一定程度的安全性：

1. 找到最近的官網 mirror 網站，崑山校內最簡單的就是 http://ftp.ksu.edu.tw 這個網站了！(hint: 要注意 repodata/ 對不對啊？ 	而且請注意輸入的文字大小寫要正確喔！)

2. 修改 /etc/yum.repos.d/ 這個目錄，可以的話，只加上 base 及 updates 這兩個就好，其他的沒用到暫時不用也無所謂。(hint:  	暫時沒用到的，就用 enabled=0 處理，同時，須不需要進行 yum clean all 呢？)

3. 使用 yum -y update 自動進行全系統升級 (hint: 那個 -y 的用途為何)

4. 若有升級到核心或重要的函式庫，最好重新開機，才能使用到最新的核心與函式庫功能。 	另外，CentOS 8 提供了名為 yum-utils 軟體，內建了 needs-restarting 指令，這個指令可以判斷系統是否要重新啟動某些服務， 	或者是需要進行重新開機的行為，相當值得討論看看。

   ```
   # needs-restarting -r
   ```

​		例題 1.2.C：你有時候必須要修改核心參數，有時候也需要管理非正規軟體，該如何處理較佳呢？ 	

1. 建立一隻每天 2 點會執行的腳本，該腳本會每天持續更新系統。且若有實際更新，才會傳 log 給管理員，否則就不會傳 log 給管理員！ 		(因為要 mail 給 root，所以需要 mail 這個指令。但是這個指令不存在喔！要怎麼處理安裝才好？)
2. 假設你需要加入某些核心功能，例如在 /proc/cmdline 加入 intel_iommu=on 要如何處理與觀察？
3. 如何讓你的 Linux 支援 EPEL 呢？
4. 請使用 yum 的方式，列出目前啟動當中的 repository 喔！若有發現 epel ，請讓他預設沒有啟用較佳！ ( yum ??? --disable epel...)
5. 請使用 yum 並『暫時使用 epel (意思是，不要修改設定檔，直接使用指令列模式處理)』來查詢有沒有 ntfs-3g 這個軟體？
6. 若需要透過 epel 提供的 ntfs-3g 來安裝，該如何操作呢？且請問本例題中第一項提到的 2 點鐘更新，會不會讓 ntfs-3g 同步更新呢？

- V. 伺服器本機的防護：減少網路服務

如果對方想要連接到你的 port 80，但是你的 port 80 根本就沒有啟用埠口在監聽，那麼對方無論如何是無法連接到你的服務的！ 所以減少網路服務是很重要的！ (底下會用到的軟體，如果不存在的話，請自行使用 yum whatprovides "*bin/???" 找到軟體後自行安裝！)

1. 可使用 netstat -utlnp 來查詢自己本機所啟動的服務
2. 可使用 nmap IP 來查詢某個 IP 有啟動的 TCP 埠口有哪些 (不可隨意攻打別人)
3. 可使用 nmap -sTU IP 來查詢某個 IP 啟動的 TCP/UDP 埠口
4. 可使用 nmap -sP network/netmask 來查詢整個網域有啟動的 IP 位址共有哪些

​		例題 1.2.D： 將你的 Linux server 當中的網路服務關閉到只剩下系統至少需要的 port 22 及 port 25 即可 	(不過，如果使用 dhcp 用戶端模式，則可能會再多出幾個必要的 port 喔！) 	

1. 先用 netstat 檢查一下本機有啟動的網路埠口共有哪些？
2. 先自己分析一下，哪些是需要的埠口？哪些是不需要的埠口？
3. 透過 systemctl 關閉不要的埠口，且下次開機，這些埠口也不會啟用！
4. 使用 nmap 搭配 icmp (-sP) 的功能，來找到你的外部網域的區網有哪些 IP 是開機著的！

再次說明，那個 nmap 是一個駭客軟體，主要的目的在做 port 掃描。你可以自行使用 nmap 去攻擊自己，掃描自己 server 的漏洞， 但是不要去攻擊別人啊！

### 1.3： 課後練習

1. 透過 tcpdump -i ens3 -nn 嘗試監聽本機的網卡，並且看看有沒有任何封包流進你的網卡
2. 觀察完畢請用 [ctrl] + c 結束 tcpdump 軟體。

## SELinux 初探與網路基礎

###### 上次更新日期 2020/09/29

網路從 OSI 七層協定到 TCP/IP 的架構，然後在其架構上以 WWW 火熱起來，目前的物連網基本上也是得要透過 TCP/IP 才行！ 所以，不懂網路基礎，怎麼理解網路伺服器呢？這節課我們就來談談網路基礎吧！

學習目標

- 學會操作基本的 SELinux 指令
- 理解 OSI 七層協定的 layer 2, 3, 4 個別的意義與其相關的協定
- 理解 CSMA/CD 乙太網路的基礎協定
- 了解路由概念與如何計算 IP 位址
- 實際操作 Linux 的網路設定方式

- 2.1： SELinux 初探
- 2.2： OSI 七層協定與 TCP/IP
- 2.3： 乙太網路的 CSMA/CD 協定
- 2.4： IP 封包與 IP 位址
- 2.5： Linux 網路設定
- 2.6： 課後練習

### 2.1： SELinux 初探

SELinux 全名為 Secure Enhanced Linux，安全強化的 Linux 模組！重點是在細部的權限設定，而不是防火牆的功能。

- 一般 rwx 權限管理的是『用戶的身份權限』，這個用戶操作某個 process 後，看的是用戶的權限而不是 process 服務的權限。
- SELinux 在上述的條件前，再加一個針對『網路 process 的權限控制』項目，也就是 SELinux 是針對『某個權限』來控制， 	與操作者行為不太一樣！

也就是說，在實際進入到 Linux 傳統的權限管理 (rwx) 之前，會有一個管理 process 的預判功能！當 process 的操作超出 SELinux 所能管理的權限， 那就直接進行 drop 的動作，而不會理會權限的偵測 (看本節課的第一張圖)。SELinux 的管理主體是網路服務那個『程序』，而不是『啟動該程序的身份』喔！ 至於整個程序與相關的SELinux模式可由下圖來理解：

![img](https://dic.vbird.tw/images/selinux_1.gif)

- 第一關：SELinux 的三種模式與每種模式的功能

除了 Enforce (強制模式) 會可能有抵擋之外，其他兩種模式會放行。但是 Disable 是直接放行，不考慮後續的程序，而 Permissive 則是後續的程序一併運作， 但若有錯誤產生時，會將錯誤的情況記錄下來 (log) ，但還是放行該操作的意思。

- Disable：完整關閉不使用 SELinux，核心不會啟用 SELinux
- Enforcing：完整啟動 SELinux 的功能，會分析、管制網路程序能夠存取的目錄與檔案
- Permissive：寬容模式，事實上有啟動 SELinux 的功能，但是僅進行分析與紀錄，並不會實際抵擋網路程序的運作。

​		例題 2.1.A：你的 SELinux 似乎不是在 Enforcing 的階段，如何檢查並且修改，同時未來每次都生效呢？可以這樣處理： 	

1. 使用 getenforce 觀察目前你的系統使用哪種 SELinux 的模式？
2. 使用 setenforce [0|1] 搭配 getenforce 來觀察 SELinux 的模式變化！
3. 觀察 /etc/selinux/config 這個檔案的內容，看如何設定預設的 SELinux 模式。
4. 觀察 /boot/grub2/grub.cfg 裡面的設定，若有 selinux=0 亦代表預設關閉 SELinux 的模式，而成為 disable 喔！
5. 未來系統一定要預設就是 Enforcing 狀態

讀者須注意，最好不要使用 Disable 模式來與其他兩種模式交互切換，因為切換成 disable 後，系統內的每個檔案的 inode 內容會被修改，可能造成無法預知的問題！

- 第二關：每種網路程序要能提供某些服務時，需要透過一些規則與政策

如前圖示所述，當你使用了 Enforcing 或者是 Permissive 之後，你的被管制的 process 想要處理某些操作的動作時，就會被迫接受某些規範。 舉例來說，網頁程序 httpd 這個資料，就是不能讀取 /var/www/html 以外其他目錄 (當然有例外，這裡只是舉個例子)，因為預設的『政策規則』就是不允許！ 除非你將該規則改變才行！這就是第二關卡，規則與政策。(semanage 可能預設不安裝，請找到相關的軟體後安裝！)

- 可以使用『 sestatus 』觀察目前的 SELinux 狀態
- 可以使用『 getsebool -a 』查詢現階段 SELinux 所支援的各項規則與放行否
- 可以使用『 semanage boolean --list 』查詢每個 SELinux 規則的簡易說明
- 可以使用『 setsebool -P rule=[0|1] 』修改設定檔並直接啟用某個規則

​		例題 2.1.B：直接嘗試修改 SELinux 的規則 	

1. 透過 semanage boolean --list 找出所有跟 FTP 有關的規則有哪些？
2. 讓 FTP 可以完整的存取 (full access) 系統資訊
3. 再次將設定檔改回原本的規則模樣

- 第三關：每個程序要讀取檔案，程序的安全本文與檔案的安全本文要能夠搭配

就有點像 student 帳號只能讀屬於 student 的檔案一樣，SELinux 會根據每種 process 的安全本文，搭配到檔案的安全本文， 兩者相符合才能夠讀取這樣。也就是說， process 會有一個安全本文，檔案本身也會有個安全本文的意思。至於相關的查詢對照方式： (注意，安全本文是在第三個欄位上面喔！)

1. 可以透過『 ps -Z 』觀察到每一種程序使用的安全本文為何
2. 可以透過『 ls -Z 』觀察每一個檔案的安全本文為何
3. 可以透過『 semanage fcontext --list 』觀察每個檔案的預設安全本文為何
4. 可以透過『 chcon -t type 檔名 』修改檔案的安全本文
5. 可以透過『 restorecon -Rv 目錄 』修改目錄下的檔案恢復原本的安全本文
6. 可以透過觀察『 /var/log/messages 』的內容了解如何修改 SELinux 的錯誤

​		例題 2.1.C：為了要讓 /var/log/messages 裡面有 SELinux 的錯誤訊息，我們必須要安裝 setroubleshoot 的服務才行！ 	在最小安裝中，這個服務預設並沒有被安裝喔！所以，我們現在得要安裝這東西才行。 	

1. 先搜尋系統有沒有任何安裝以 setrouble 為名的軟體？
2. 用 yum 搜尋 yum server 有沒有提供 setrouble 為名的軟體？
3. 請安裝上述的軟體
4. 安裝完畢之後，可能需要重新啟動一次 Linux 才會比較完整的生效。

接下來讓我們測試一下 setroubleshoot 的功能。

​		例題 2.1.D：管理 FTP 伺服器的一般帳號登入權限 	

1. 讓你的系統安裝 vsftpd 這個 FTP 伺服器軟體，並且啟動這個伺服器軟體
2. 查詢一下 vsftpd 這個 process 的安全本文名稱為何？
3. 查詢一下 vsftpd 所屬的檔案名稱，並查詢可能的匿名登入目錄所在的 SELinux 安全本文為何？
4. 請使用 curl 軟體，然後使用 curl ftp://localhost 看看是否能夠查詢到 pub 等目錄？
5. 在 /root 底下建立一個檔案，內容填寫你的學號與姓名，然後將檔案移動到 /var/ftp/pub 底下， 		再以匿名登入瀏覽，能否看到這個檔案？能否讀取這個檔案？為什麼？
6. 如何改善上面的情況？

- 全系統的 SELinux 更新方式

如果你不知道做了什麼事情，導致 SELinux 的安全本文錯亂時，只好透過全系統更新的方法來處理了。此外，若在沒有 SELinux 的環境下更動到檔案的  inode 內容，則原本紀錄在 inode 內的 SELinux 將會被清空。 例如在基礎訓練篇裡面的關於 root 救援進入 rescue 的模式中，就是一個最基本的案例。此時你可以這樣做：

- 在離開救援模式前，使用 touch /.autorelable ，則下次重新開機後，系統會重新根據預設定義重建 SELinux  	對每個檔案的安全本文！重新定義完畢會再次的重新開機就正常了
- 離開救援模式之前，將 /etc/selinux/config 修改成為 permissive 的模式，正常進入系統後， 	使用 root 下達 restorecon -Rv / 來處理全系統的 SELinux 復原，之後修改 /etc/selinux/config 成為 Enforcing 再重開機。 	或直接 setenforce 1 而不用重新開機也行。

### 2.2： OSI 七層協定與 TCP/IP

網路最早的參考模型是 OSI 七層協定，後來才開發出 TCP/IP 的四層協定。不過目前世界上還是多以 OSI 七層協定來定義網際網路的分層概念。

- 認識 OSI 七層協定與 TCP/IP 的四層協定相關性：

1. 無論哪種協定都是在規範網路主程式的撰寫行為
2. 分層負責的好處是可以讓程式碼比較方便抽換 (堆疊的優點)
3. 程式碼主要是由作業系統所提供，因此有提供 TCP/IP 的作業系統稱為網路作業系統
4. OSI 七層協定從底層到上層分別是：實體層、資料鏈結層、網路層、傳輸層、會談層、表現層與應用層
    		![OSI, TCP/IP](https://dic.vbird.tw/images/osi_packet.gif)
5. 因為 OSI 七層協定規範的太嚴謹，後來美國軍方與柏克萊大學合作，開發了一個當時給學術單位使用的網路程式， 		後來被稱為 TCP/IP 協定，這也是大家都知道的『 Internet, 網際網路 』的學名！
6. TCP/IP 四層分別為『資料連結層、網路層、傳輸層與應用層』
    	![OSI, TCP/IP](https://dic.vbird.tw/images/osi_tcpip.gif)

一般來說，偏向硬體的層級，我們稱為訊框 (frame)，大多就是在第一、二層，而以軟體打包的資料，我們稱為封包 (packet)，一般就是第三層以上的各層封包！ 接下來就來談談每種封包上面的表頭資料吧。

- 基礎網路通常指的是 OSI 七層協定的 layer2, layer3, layer4 這三層！

1. Layer2 主要的訊框 (frame) 名稱為何？同時，在這個訊框表頭 (header) 有那兩個重要的位址？
2. Layer2 的這個重要的位址，每個位址的資料各佔用多少個位元組 (bytes)？
3. Layer3 的主要封包 (packet) 名稱為何？在這個封包表頭有那兩個重要的位址？
4. Layer3 的這個重要的位址，每個位址各佔用多少個位元 (bits)
5. Layer4 的主要封包名稱有那兩個？那一個具有『三向交握』的功能？那一個是非連接導向的封包？
6. Layer4 的封包表頭有個重要的數值號碼，那個號碼的名稱為何？一般這個號碼具有 0~65535 個！

​		例題 2.2.A：繪圖說明何謂三向交握？並且說明哪個流程需要回應 (ACK) 及發送新旗標 (SYN) ？ 

TCP 封包與 UDP 封包是有差異的，一般穩定連線都是採用 TCP，而非連接則使用 UDP。但是 UDP 速度較快， google chrome 漸進的採用 UDP 封包來傳送 youtube， 在某些阻擋 UDP 封包的防火牆範圍內， chrome 的速度好像會慢一點，原因就是這個問題。請將 chrome 的這個 QUIC 功能關閉看看 (chrome://flags/)。

​		例題 2.2.B：實際監測各層 layer 的表頭資料 	

1. 如何在 windows 上面使用指令查出 MAC 位址號碼？
2. 如何在 Linux 上面使用指令查出 MAC 位址號碼？
3. 如何在 Linux 上面查出 IP 位址？(這題很重要！因為指令太多了！)
4. 那一個封包是『可靠的連線』封包格式？
5. 底下這些在『應用層』裡面的協定，其使用的 port number 一般為何？ DNS, HTTP, SSH, SMTP, FTP, HTTPS, POP3, SMB

網路是雙向的，封包會由 Client--> Server 也會由 Server --> Client，因此兩邊均需要告知對方自己的 IP 與所使用的埠口！這就是所謂的網路 socket：

- IP1:port1 <--> IP2:Port2 稱為網路的 socket！

- 區域網路的連線

你應該經常聽到廣域網路 (WAN) 與區域網路 (LAN) 這兩個名詞～其中 LAN 更是經常聽到！區域網路簡單的說，就是『住在同一條巷子的人們』， 同一條巷子內的所有住戶就是區域網路！

1. 在目前的乙太網路架構上，只要所有的機器透過一部 hub/switch 連接在一塊，如果能夠使用同一區段的 IP 位址，就能夠稱為區域網路
2. 同一段區域網路的情況下，網路資料的傳遞主要是透過『網卡對網卡』來直接傳遞
3. 由於網卡對網卡傳遞，因此每部主機就得要知道互相傳遞資料的網卡位址 (這就是 MAC address 的重要性！)
4. 現階段區域網路的制定主要還是依據 IP address 的項目，因此機器對機器之間的傳遞，還是透過所謂的 IP 位址來達成的。
5. 電腦的傳遞透過網路卡的廣播 (卡號)，網際網路資料的傳遞主要透過 IP 位址的傳遞！這兩者間會有相關性！ 		由 IP 去找出 MAC 的流程就是 ARP (address resolution protocol) 的功能！

​		例題 2.2.C：使用 arp 來找出 MAC 與 IP 的對應  	

1. 先使用網路環境測試你的網路卡是否驅動了；
2. 使用 ping 這個指令來 ping 老師寫在白板上面的 IP
3. 使用 arp -n 這個指令，查詢該 IP 所在的區域網路 MAC address 為那一個
4. 你能不能 ping google 之後，找到 google 伺服器的 MAC 呢？為何？

七層協定與 TCP/IP 就是個網路模型參考，基本上就是一個網路層級的程式撰寫指引。因此，只要你符合該指引的參考去撰寫可以相容的軟體， 就可以讓你的 OS 加入 Internet 了！

### 2.3： 乙太網路的 CSMA/CD 協定

目前網際網路使用最廣的類型就是乙太網路～所以讓我們來了解一下什麼是乙太網路。

1. 全名為： Carrier Sense and Multiple Access with Collision Detection，至於運作模式的情況是： 	
   1. CS(監聽)：
       		要發送訊息的機器會先監聽一次共用媒體 (Carrier Sense)
   2. MA(多點傳送)：
       		若無人使用，就會發送訊息 (發送量通常就是 MAC 訊框的大小)！這個訊息在共用媒體上面會以廣播的方式傳遞， 		所有在區域網路的機器均會接收到這個訊息，但若 destination MAC address 不是自己，就會將該訊息丟棄， 		若是自己則收下來解析。
   3. CD(碰撞偵測)：
       		同時若有兩個機器同時送出訊息，此時將導致封包碰撞，兩個封包均會損毀。兩部機器在各自的隨機時間內， 		再次的進行監聽與傳送的功能，此及碰撞偵測。
2. 媒體共享不共享很重要： 	
   - Hub 就是共用媒體，以 gigabit 的網路速度來說，連接在 Hub 上的所有的機器會共用 1Gbit 的總傳輸量
   - swtich 內建一個記憶體紀錄了 switch port 與 MAC address 的對應，因此當封包傳送時， 		switch 會透過這個記憶體將這些資訊傳送到正確的 destination MAC address，因此就不會使用廣播的功能， 		此時即可避免碰撞的發生。此外， switch 的埠口均有各自獨立的 1Gbit 頻寬

​		例題 2.3.A：嘗試思考底下的問題： 	

1. 使用星形連線圖示說明 hub 與 switch 在 CSMA/CD 的狀況下，他是如何進行資料傳遞的？
2. 回家後，嘗試注意自己家裡的 switch/hub，當有任何封包傳輸行為時，是兩兩對傳？還是全部燈會都會閃動？藉以了解 switch/hub 的相關功能。
3. 如何在 CSMA/CD 的相關環境中，透過『不登入他人電腦，即可取得該電腦的所有網路封包』？ 	該有哪幾個重要的項目需要思考 (僅透過 CSMA/CD 的相關原則，並沒有使用任何的攻擊軟體的環境下！)
4. 有沒有可能在連接到無密碼的 AP wifi 時，會讓你的資料被竊取？為什麼？

- 乙太網路 CAT 網路線等級

1. CAT 5：標準速度 100Mbit/s，無法到達 1Gbit/s 的速度。
2. CAT 5e：過渡時期標準，可達到 1Gbit/s 的速度。
3. CAT 6：標準的 1Gbit/s 的速度
4. CAT 6e：過渡時期標準，可達到 10Gbits/s 的速度
5. CAT 6a：標準的 10Gbit/s 的速度
6. 早期有所謂的跳線與平行線，自從推出 1Gbit/s 以上速度的網卡與媒體設備後，目前是否為跳線都可以透過網卡或網路媒體的『 	auto MDI/MDIX 』等相關技術來判斷，因此無須判斷平行線或跳線了，都可以通！只要水晶頭都是符合 568A 或 568B 的配置即可！

​		例題 2.3.B：找一找，你手邊的網路線，看看是什麼等級的網路線呢？ 



### 2.4： IP 封包與 IP 位址

目前的 IP 封包有兩種版本，分別是 IPv4 及 IPv6，兩者最大的差異就是在於 IP address 的位元數的差別了！

- IPv4 的 IP 等級範圍

1. IP 協定版本分兩種，分別為 IPv4 與 IPv6，這兩個版本在表頭的 IP address 部份差異很大，IPv4 佔用 32bit 作為位址， 		IPv6 佔用 128bit 作為位址，兩者差了 2^96 倍數。
2. 目前台灣地區主流還是 IPv4，不過未來等到 IPv6 的基礎網路佈建完成後，應該會以 IPv6 為基準了！因為物連網  	(Internet Of Things, IOT) 的關係。
3. IPv4 的 IP 位址格式為 32 個 0 或 32 個 1，亦即是：
    		二進位最小：00000000000000000000000000000000
    		二進位最大：11111111111111111111111111111111
    		不過人類對於數字尤其是 2 進位相當不在行，所以就將 2 進位分 4 組，並轉成 10 進位，所以：
    		二轉十進位最小：00000000.00000000.00000000.00000000 --> 0.0.0.0
    		二轉十進位最大：11111111.11111111.11111111.11111111 --> 255.255.255.255
4. 為了方便整組 IP 範圍的給予，因此 IP 是有『等級』之分的！主要有底下三種等級： 	
   - Class A： 2 進位開頭為 0 的那個位址，轉成 10 進位後，第一組號碼範圍在 0~127 之內的，都是 A 等級
   - Class B： 2 進位開頭為 10 的那個位址，轉成 10 進位後，第一組號碼在 128~191 之間的，都是 B 等級
   - Class C： 2 進位開頭為 110 的那個位址，轉成 10 進位後，第一組號碼在 192~223 之間的，都是 C 等級
5. 等級 A 的 IP 位址所定義的區域網路中，若以 127 為例，則該 Class A 的區域網路所涵蓋的 IP 位址範圍在 127.0.0.0 ~ 127.255.255.255 之間， 		亦即 127 為網域識別 (Network ID) 而後面三組位址則為主機識別 (host ID)。簡單的說，就像一般門牌號碼，分為同巷子內都相同的巷子號碼， 		以及每戶均不同的家戶號碼。
6. 同一個區域網路中，每一個 IP 位址均可以透過簡單的廣播功能來進行網路資料的傳輸，而不需要透過路由器或閘道器
7. 正常預設 IPv4 的定義下，各 Class 的區域網路範圍是：
   - Class A： 1.0.0.0/8, 1.0.0.0/255.0.0.0, 1.0.0.0~1.255.255.255
   - Class B： 172.0.0.0/16, 172.0.0.0/255.255.0.0, 172.0.0.0~172.0.255.255
   - Class C： 192.0.0.0/24, 192.0.0.0/255.255.255.0, 192.0.0.0~192.0.0.255
8. 以 172.16.0.0 這一個 IP 來說明一段區域網路的話，那麼區域網路的參數就會有： 	
   - netmask (子網域遮罩)：255.255.0.0 或 /16：功能是在定義出區域網路的『巷子』號碼所在處，也是 32 位元，只是作為網域 ID 的位置全部為 1 ， 		而作為主機 ID 的位置則全部為 0 ，因此 Class B 的預設 netmask 就會是 11111111.11111111.00000000.00000000
   - network IP(網域 IP 位址，亦即是第一個 IP 位址的意思)：172.16.0.0：網域 ID 是不可變的，而主機 ID 可以全部是 0 (最小)，此時就是網域 IP 位址！ 		這個位址搭配 netmask 則是一整個網域的代表數字
   - broadcast IP (廣播 IP 位址，亦即是最後一個 IP 位址的意思)：172.16.255.255：網域 ID 是不可變的，而主機 ID 可以全部是 1 (最大)，此時就是廣播 IP。 		network IP 與 broadcast IP 是有特殊用途的，因此不能作為一般裝置設定 IP 之用
   - 可用 IP 位址範圍：172.16.0.1 ~ 172.16.255.254 ：就是去掉 network IP 與 broadcast IP 之後的其他 IP 位址。

​		例題 2.4.A：嘗試回答下列問題： 	

1. 有個 IP 為 119.231.23.52，請問這個 IP 是 Class A, B, C 的那一個？
2. 承上，那麼該 IP 所在的網段理論上，其 Netmask IP, Network IP, Broadcast IP, 可用 IP 範圍，個別是多少？
3. 承上，有沒有可能存在類似 119.231.23.0 這樣的『可用 IP』呢？

- IP 的種類：主要分為兩種

1. public IP (公共 IP 或公開 IP 位址)：
    	這種 IP 必須要從 ISP 申請而來，以學校來說，就是要跟計算機中心申請；以住家來說，就是需要向類似中華電信申請 (要花錢)。 	這種 IP 可以直接上網，也可以架設網站，全世界都可以直接跟這個 IP 連線與溝通。
2. private IP (私有 IP 或保留 IP 位址)：
    	當初設計 IPv4 時，預設保留給內部網路設定用的 IP 區段。這種 IP 位址不能直接上網， 	需要透過 IP 分享器 (透過 NAT 技術) 後才能夠上網。當區域網路還不需要連上 Internet 時，可以使用這種 IP 位址來設定裝置， 	未來有 Internet 的需求，只需要加上 IP 分享器即可。這種 IP 位址所架設的網站，也需要透過 IP 分享器的轉遞 (port mapping) 後， 	才有可能讓 Internet 瀏覽到。
3. 根據 Class 的分類，private IP 位址也分三個 class 提供給用戶或企業來設定規劃自己的區域網路： 	
   - Class A：10.0.0.0/8，一組 Class A
   - Class B：172.16.0.0/16, 172.17.0.0/16..., 172.31.0.0/16，共 16 組 Class B
   - Class C：192.168.0.0/24, 192.168.1.0/24..., 192.168.255.0/24，共 256 組 Class C

​		例題 2.4.B：下列哪幾個是屬於 private IP，這種 IP 需要透過 IP 分享或偽裝才能夠連上 Internet 	

1. 172.15.1.1/16
2. 192.28.1.1/24
3. 10.100.1.1/8
4. 172.20.1.1/16
5. 192.168.5.1/24
6. 61.5.5.1/8

- 無等級 IP 位址 (Classless Interdomain Routing)

1. 除了上述的預設的等級外，區域網路管理員也能夠指定非正規的區域網路。非正規的區域網路就被稱為無等級 IP 位址 (CIDR)
2. 若以『 台南市 . 永康區 . 崑大路 . 195 號 』為例，我們可以說： 	
   - 崑大路的管理者，他的網域 IP 位址可以到『台南市 . 永康區 . 崑大路』，因此不論幾號都是屬於他的管轄範圍
   - 永康區的區長，他的網域 IP 位址可以到『台南市 . 永康區』，因此不論永康區的什麼路，都是他的管轄範圍
   - 台南市的市長，他的網域 IP 位址可以到『台南市』，因此不論什麼區的什麼路，都是他的管轄範圍
3. 定義出崑大路長、永康區長、台南市長的參數，就是『netmask (子網路遮罩)』。
4. 計算 192.168.5.30/24 的相關參數有： 	
   - netmask: 255.255.255.0
   - Network IP: 192.168.5.0
   - Broadcast IP: 192.168.5.255
   - 可用 IP: 192.168.5.1 ~ 192.168.5.254 (共 254 個)
5. 計算 192.168.5.100/26 的相關參數有： 	
   - Netmask：首先，由 /26 推算出： 11111111.11111111.11111111.11000000，因此得到 255.255.255.192 這個參數
   - Network IP：由 192.168.5.100 中，前面 192.168.5 已經固定 (前面 24 個位址)，而 100 推算 2 進位成為 01100100， 		因為 2 個 bit 被設定為網域 ID 是不可動的，因此這個位址的範圍『 01 000000 』到『 01 111111 』之間， 		所以得到第一個位址為 01000000 (二進位) --> 64 (十進位)，所以 Network IP 就成為 192.168.5.64
   - Broadcast IP：承上，最後一個 IP 位址為 01111111 (二進位) --> 127 (十進位)，所以 Broadcast IP 就成為： 192.168.5.127
   - 可用的 IP 位址範圍在： 192.168.5.65 ~ 192.168.5.126

​		例題 2.4.C：再請嘗試計算出 192.168.10.200/27 的 Netmask IP, Network IP, Broadcast IP, 可用 IP 範圍分別是什麼？ 

- 離開區域網路的重要關鍵： Gateway, Router...

1. 在區域網路內可以透過網路卡直接廣播，當然， IP 位址也需要是在同一個區域網路內
2. 如果要前往的目標 IP 位址並不在區域網路內呢？則此時需要將 IP 封包送給一個專門轉送資料的地方，那就是區網內的通訊閘 (Gateway) 	或稱為路由器 (Router)。
3. 想像泡麵廣告，在區域網路內可以透過廣播呼叫小妹妹回家吃泡麵。但小妹妹如果不在巷子內呢？此時就得要將泡麵送到小 7 ， 	透過宅即便的功能轉送出巷子外！
4. 但是你還是得要走到小 7 才行，所以這個小 7 必須要跟你在同一個區域網路內！
5. 一般建議 Gateway 設定為最後一個可用 IP，例如 192.168.5.0/24 當中，建議 gateway 應設定為 192.168.5.254 較好。

- 不要使用 IP 填寫在網址列了，透過 DNS 解析

1. 現在已經沒有人在瀏覽器的網址列 (URL) 填寫 IP 了，都是透過主機名稱來處理的。
2. 因為 Internet 就是 TCP/IP，因此上網一定要用 IP 才行 (不論是 IPv4 還是 IPv6)。
3. 所以就需要透過 DNS 系統，讓瀏覽器直接去 DNS 系統詢問某主機名稱的 IP 後，瀏覽器再自行連上該伺服器！

- 基本上，連上 Internet 所需要的幾個網路參數：

1. IP/Netmask：這兩個參數設定後，系統會自動的算出 Network IP 及 broadcast IP；
2. Gateway：當然重要！能不能離開區域網路的重要項目！
3. DNS server IP：使用主機名稱連上 Internet 的重要設定項目！

- IP 的取得方式有很多方法，台灣地區常見的方法為：

1. 自動取得：學名為 dhcp 這個協定，通常使用 auto 取代此方法。網路參數統一放置於 DHCP server 上面，用戶端電腦開機時會去詢問 DHCP 伺服器， 	藉以得到正確的網路參數的方式，常見於宿舍網路環境與辦公環境下。
2. 手動設定：手動處理 (manual) 的方式，自己向 ISP 取得相關的網路參數，直接手動設定好網路參數之意。 	常見於伺服器本身的環境設定中。
3. 撥接：台灣地區包括 ADSL 以及中華電信光世代，對外都是走電話線，或者是 CAT5 (通常最多到 CAT 5e) 的網路線，只是都附掛在電話上， 	需要透過數據機撥接的情況，這種情況的 IP 網路參數也是由 ISP 機房主動分配的，使用者無法手動設定。
4. 第四台纜線 (Cable)：透過電視纜線，第四台提供的線路來連網，同樣需要透過數據機，而 IP 的取得與 DHCP 雷同。

### 2.5： Linux 網路設定

請稍微注意，因為我們的系統使用的是虛擬機器，而為了讓大家理解 Server/Client 的架構，因此，這部 Server 主機擁有三張網卡， 三張網卡分別對應不同的網域，目前這三張卡分別是： ens3, ens7, ens8 界面。而我們目前可以對外的界面為 ens3 這一張喔！ 要注意！要注意！

預設使用一張網卡來設定一個 IP，方式很簡單，有指令方法也有直接設定的方法。就讓我們來實際設定網路參數吧！

- 暫時的設定 (不改變設定檔，重新開機還是恢復原本參數的指令設定行為，通常用在測試環境中)

1. 取得目前有多少網路卡以及網路卡的名稱：

   ```
   ifconfig -a
   ip link show
   ```

   ​		請注意， lo 是內部網域 (local)，vir 或 br 開頭的應該是虛擬化設備 (假的！不理他！)，其他的才是目前實體網卡

2. 改變 IP/netmask：

   ```
   ifconfig [NIC name] IP netmask NETMASK
   ifconfig ens3 192.168.5.* netmask 255.255.255.0
   ```

   ​		上述的 * 請用自己的學號尾數去帶，不可以有重複的 IP 設定！

3. 改變 gateway 的方法

   ```
   route add default gw GWIP
   route add default gw 192.168.5.254
   ```

4. 改變 DNS server IP 的方法

   ```
   vim /etc/resolv.conf
   nameserver 168.95.1.1
   ```

5. 查詢設定是否正確的流程：

   ```
   ifconfig ens3  
   	(查看 IP 與 netmask 是否正常，若不正常，則回 ifconfig [NIC name]... 重新設定)
   route -n 
   	(查看 0.0.0.0 開頭的那行，是否有正確的 gateway，若不對，回 route add default 修改)
   ping 192.168.5.254 
   	(看是否有回應封包，若沒有，應該是 IP 分享器的問題，詢問 ISP 管理員)
   ping 168.95.1.1 
   	(連線到中華電信提供的公開 DNS server，若有問題也只能問 ISP)
   dig www.google.com 
   	(查看有沒有找到正確的 google IP？若沒有，請回去查看 nameserver 的設定)
   ```

   ​		上面幾個步驟請依序處理，因為是有相依性的喔！

- 永久的設定 (直接用指令修改設定檔了！) - 針對外部區網

事實上，所有的設定檔都在 /etc/sysconfig/network-scripts/ifcfg-XXX 當中！你也可以自己瞧一瞧該檔案的內容。 不過， CentOS 8 之後，似乎一定要使用 NetworkManager 這個服務了！因此需要使用 nmcli 這個指令。 如果硬要使用舊版的 network 指令，那就得要額外安裝舊版的 network 腳本軟體才可以！

1. 查看目前的網路連線界面有哪些

   ```
   nmcli connection show
   ```

   ​		通常會得到連線名稱『NAME』以及網卡裝置名稱『DEVICE』，這兩個名稱通常也相同！

2. 查看目前網卡所在網路的設定值：

   ```
   # nmcli connection show ens3
   
   connection.id:                          ens3
   connection.uuid:                        ff0b88ed-7cc6-4803-be7d-e77c74fea95b
   connection.interface-name:              ens3
   connection.type:                        802-3-ethernet
   connection.autoconnect:                 yes
   connection.autoconnect-priority:        0
   connection.timestamp:                   1475170677
   connection.read-only:                   no
   connection.permissions:
   connection.zone:                        --
   connection.master:                      --
   connection.slave-type:                  --
   connection.autoconnect-slaves:          -1 (default)
   connection.secondaries:
   connection.gateway-ping-timeout:        0
   connection.metered:                     不明
   802-3-ethernet.port:                    --
   802-3-ethernet.speed:                   0
   802-3-ethernet.duplex:                  --
   802-3-ethernet.auto-negotiate:          yes
   802-3-ethernet.mac-address:             --
   802-3-ethernet.cloned-mac-address:      --
   802-3-ethernet.mac-address-blacklist:
   802-3-ethernet.mtu:                     auto
   802-3-ethernet.s390-subchannels:
   802-3-ethernet.s390-nettype:            --
   802-3-ethernet.s390-options:
   802-3-ethernet.wake-on-lan:             1 (default)
   802-3-ethernet.wake-on-lan-password:    --
   ipv4.method:                            manual
   ipv4.dns:                               120.114.100.1,120.114.150.1
   ipv4.dns-search:
   ipv4.addresses:                         192.168.254.100/24, 10.255.100.254/24
   ipv4.gateway:                           192.168.254.254
   ipv4.routes:
   ipv4.route-metric:                      -1
   ipv4.ignore-auto-routes:                no
   ipv4.ignore-auto-dns:                   no
   ipv4.dhcp-client-id:                    --
   ipv4.dhcp-send-hostname:                yes
   ipv4.dhcp-hostname:                     --
   ipv4.never-default:                     no
   ipv4.may-fail:                          yes
   ipv6.method:                            auto
   ipv6.dns:
   ipv6.dns-search:
   ipv6.addresses:
   ipv6.gateway:                           --
   ipv6.routes:
   ipv6.route-metric:                      -1
   ipv6.ignore-auto-routes:                no
   ipv6.ignore-auto-dns:                   no
   ipv6.never-default:                     no
   ipv6.may-fail:                          yes
   ipv6.ip6-privacy:                       -1（不明）
   ipv6.dhcp-send-hostname:                yes
   ipv6.dhcp-hostname:                     --
   GENERAL.NAME:                           ens3
   GENERAL.UUID:                           ff0b88ed-7cc6-4803-be7d-e77c74fea95b
   GENERAL.DEVICES:                        ens3
   GENERAL.STATE:                          已啟用
   GENERAL.DEFAULT:                        是
   GENERAL.DEFAULT6:                       否
   GENERAL.VPN:                            否
   GENERAL.ZONE:                           --
   GENERAL.DBUS-PATH:                      /org/freedesktop/NetworkManager/ActiveConnection/0
   GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/Settings/0
   GENERAL.SPEC-OBJECT:                    /
   GENERAL.MASTER-PATH:                    --
   IP4.ADDRESS[1]:                         192.168.254.100/24
   IP4.ADDRESS[2]:                         10.255.100.254/24
   IP4.GATEWAY:                            192.168.254.254
   IP4.DNS[1]:                             120.114.100.1
   IP4.DNS[2]:                             120.114.150.1
   IP6.ADDRESS[1]:                         fe80::5054:ff:fe5f:2182/64
   IP6.GATEWAY:
   ```

   ​		你需要知道的是上面幾個粗體字的項目！小寫字元的是屬於設定檔的部份，大寫字元的是屬於目前正在運作中的實際網路參數狀況～這兩者需要搭配才行。 	設定方面的參數主要有： 	

   - connection.autoconnect [yes|no]：是否需要啟動這個網路界面
   - ipv4.method [auto|manual]：取得的方式為自動或手動
   - ipv4.addresses [IP/Netmask]：直接設定 IP 位址與子網路遮罩
   - ipv4.gateway [GWIP]：設定 Gateway 的 IP 位址
   - ipv4.dns [DNSIP]：設定 DNS server 的 IP 位址

3. 請依據底下的設定來設定好你的網路參數：

   ```
   nmcli connection modify ens3 ....
   ```

   - IP/Netmask: 192.168.254.*/24
   - GW IP: 192.168.254.254
   - DNS 1: 120.114.100.1
   - DNS 2: 120.114.150.1

   ​		務必記得當完成上述的設定後 (modify)，一定要使用底下的方式來啟動設定值：

   ```
   nmcli connection up ens3
   ```

4. 事實上，如果你有額外安裝 network 單純的啟動腳本軟體，這些設定值就都紀錄在底下這個檔案中！

   /etc/sysconfig/network-scripts/ifcfg-ens3

   ```
   TYPE=Ethernet
   BOOTPROTO=none
   DEFROUTE=yes
   IPV4_FAILURE_FATAL=no
   IPV6INIT=yes
   IPV6_AUTOCONF=yes
   IPV6_DEFROUTE=yes
   IPV6_FAILURE_FATAL=no
   NAME=ens3
   UUID=ff0b88ed-7cc6-4803-be7d-e77c74fea95b
   DEVICE=ens3
   ONBOOT=yes
   DNS1=120.114.100.1
   DNS2=120.114.150.1
   IPADDR=192.168.254.100
   PREFIX=24
   IPADDR1=10.255.100.254
   PREFIX1=24
   GATEWAY=192.168.254.254
   IPV6_PEERDNS=yes
   IPV6_PEERROUTES=yes
   ```

   ​		你當然也能手動編輯這個檔案的內容，不過如果手動編輯過後，得要重新裝置 nmcli 才行！

   ```
   nmcli connection reload
   ```

- 永久的設定 - 針對你的內部網域 (LAN)

這門課程的重點是希望讀者們能夠管理整個機房的區域網路，因此讀者得要了解到如何設定內部區網才行。雲端機器在 server 的部份提供了 ens7, ens8 這兩個連接到內部網路的網卡，請先使用 ens7 來設計你的區域網路！每個人的區域網路需要獨立才行，不可以重複，否則就會互相干擾。 上面的外部網路是在 192.168.254.0/24 這一段，而內部網路則預計為 10.255.XX.0/24 這一段！

- 你的 ens7 網路參數請設定 10.255.XX.254/24，而未來用戶端的網路則先設定為 10.255.XX.1/24 ！

因此，你有外部網路 (WAN) 的設定，也有內部網路 (LAN) 的存在喔！未來要處理任何工作前，先理解你要處理的室內網還是外網！

- 主機名稱的設定方式

1. 一般我們建議每部要連網的主機都要有自己的主機名稱。若沒有網路或者是尚未規範好主機名稱的系統，通常我們會分配一個名為 localhost 的本機主機名稱。 	這是因為系統有個 localhost 對應到 127.0.0.1 這個固定 IP 的設定的原因。

2. 你可以觀察 /etc/hosts 這個檔案的內容，一般來說，這個檔案內容的格式為：

   ```
   thereis.your.ip.address  your.host.name         your.host.alias
   127.0.0.1                localhost.localdomain  localhost
   ```

   ​		所以你可以將你的主機名稱與對應的 IP 寫入到這個檔案中，無須重新啟動任何資料，他會自動設定好對應。

3. 至於主機名稱的實際設定，可以使用 hostnamectl 來處理即可！請自行使用 man hostnamectl 查詢相關的應用。

​		例題 2.5.A：依據底下的資料來設定好這個系統 (ens3) 	

1. 由於我們的雲系統是虛擬機器 clone 出來的，因此請將目前系統中的所有網路連線通通刪除，然後重建 ens3, ens7, ens8 的連線， 		且分別對應到 ens3, ens7, ens8 的網卡上！

2. ens3 外部網路參數為： 192.168.254.*/24 ，其中 * 為老師規定的 IP  尾數。另外 gateway 為 192.168.254.254，而 DNS 為 120.114.100.1 以及 168.95.1.1

3. ens7 內部網路參數為： 10.255.*.254/24，不需要 gateway 

4. ens8 預設不要啟動喔！

5. 主機名稱指定為： pc*.dic.ksu

6. 最終你的主機名稱與 IP 的對應為：

   ```
   pc*.dic.ksu		192.168.254.*		別名為 pc*
   pc254.dic.ksu		192.168.254.254		別名為 pc254
   server.lan*.dic.ksu	10.255.*.254		別名為 server
   client.lan*.dic.ksu	10.255.*.1		別名為 client
   ```

- 系統網路 debug 流程 (每個流程都有相依性喔！一步一步處理才行)

1. 先查看 IP 與 netmask 的設定是否正確：

   ```
   ifconfig ens3
   ip addr show
   nmcli connection show ens3 (看最後面大寫字元的部份是否正確)
   ```

2. ​		若不正確，請再使用 nmcli connection modify ens3 ... 的方式重新設定 ipv4.addresses 那個項目，然後 nmcli connection up ens3 重新啟用！ 		

3. 再查閱 router/gateway 的設定是否正確？：

   ```
   route -n 			(看 0.0.0.0 開頭的那一行)
   ip route show 			(看 default 開頭的那一行
   nmcli connection show ens3 	(看大寫字元的部份)
   ```

   ​		若不正確，也是要使用nmcli connection modify ens3 ... 的方式重新設定 ipv4.gateway 那一個項目！

4. 檢查你的機器與 gateway 之間的連線是否正常？

   ```
   ping GW_IP (停止用 [ctrl]+c )
   ```

   ​		若沒有正確的回應，可能就是 gateway 設定錯誤，或者是 gateway 本身有問題，或者是網路線有問題等等， 	反正理論上就是你的系統與 gateway 之間的過程有問題就是了。這時若不是自己檢查硬體問題，應該就是回報 ISP 了！

5. 檢查你的 DNS server IP 設定

   ```
   dig www.google.com
   ```

   ​		這個步驟的結果理論上應該會出現

   ```
   ; <<>> DiG 9.9.4-RedHat-9.9.4-29.el7 <<>> www.google.com
   ;; global options: +cmd
   ;; Got answer:
   ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 46866
   ;; flags: qr rd ra; QUERY: 1, ANSWER: 12, AUTHORITY: 4, ADDITIONAL: 5
   
   ;; OPT PSEUDOSECTION:
   ; EDNS: version: 0, flags:; udp: 4096
   ;; QUESTION SECTION:
   ;www.google.com.                        IN      A
   
   ;; ANSWER SECTION:
   www.google.com.         188     IN      A       202.169.175.96
   www.google.com.         188     IN      A       202.169.175.102
   www.google.com.         188     IN      A       202.169.175.103
   www.google.com.         188     IN      A       202.169.175.109
   www.google.com.         188     IN      A       202.169.175.110
   www.google.com.         188     IN      A       202.169.175.116
   www.google.com.         188     IN      A       202.169.175.117
   www.google.com.         188     IN      A       202.169.175.123
   www.google.com.         188     IN      A       202.169.175.82
   www.google.com.         188     IN      A       202.169.175.88
   www.google.com.         188     IN      A       202.169.175.89
   www.google.com.         188     IN      A       202.169.175.95
   
   ;; AUTHORITY SECTION:
   google.com.             164038  IN      NS      ns3.google.com.
   google.com.             164038  IN      NS      ns2.google.com.
   google.com.             164038  IN      NS      ns1.google.com.
   google.com.             164038  IN      NS      ns4.google.com.
   
   ;; ADDITIONAL SECTION:
   ns1.google.com.         12624   IN      A       216.239.32.10
   ns2.google.com.         19127   IN      A       216.239.34.10
   ns3.google.com.         19127   IN      A       216.239.36.10
   ns4.google.com.         19127   IN      A       216.239.38.10
   
   ;; Query time: 2 msec
   ;; SERVER: 120.114.100.1#53(120.114.100.1)
   ;; WHEN: 五  9月 30 22:33:19 CST 2016
   ;; MSG SIZE  rcvd: 371
   ```

   ​		這部份要看的大概是問題 (QUESTION) 的部份，是否主機名稱填寫正確，以及回應 (ANSWER) 是否真的有找到 IP ， 	最後再看伺服器 (SERVER) 是否是你設定的那一個項目？若不是，得要回去 nmcli 重新克服！

6. 最後，若不放心，再使用『 ping 168.95.1.1 』確認與中華電信 DNS 伺服器的連線是否 OK！

​		例題 2.5.B：用另一個用戶端帳號，啟動客戶端電腦，並建立如下的網路參數： 	

1. 由於我們的雲系統是虛擬機器 clone 出來的，因此請將目前系統中的所有網路連線通通刪除，然後重建 ens3 界面

2. ens3 網路參數為： 10.255.*.1/24 ，其中 * 為老師規定的 IP 尾數。另外 gateway 為 10.255.*.254，而 DNS 為 120.114.100.1 以及 168.95.1.1

3. 主機名稱預設為： client.lan*.dic.ksu

4. 最終你的主機名稱與 IP 的對應為：

   ```
   pc*.dic.ksu		192.168.254.*		別名為 pc*
   pc254.dic.ksu		192.168.254.254		別名為 pc254
   server.lan*.dic.ksu	10.255.*.254		別名為 server
   client.lan*.dic.ksu	10.255.*.1		別名為 client
   ```

5. 由於 Server 尚未設定好 IP 分享器的 NAT 功能，因此只需要能夠 ping 10.255.*.254 成功即可！

6. 嘗試使用 ssh student@10.255.*.254，看看能不能登入系統！

7. 記得要 exit 離開 server 喔！

### 2.6： 課後練習

1. (60%)實作題：啟動 Server 作業硬碟 - unit2 

   1. 系統安全整理： 

      請先使用預設 dhcp 的自動取得 IP 模式，讓你的 ens3 網卡啟動，以取得 ISP 所提供的環境。 	

      1. 使用崑山的 FTP 網站作為你的 YUM server 來源，並且清除一次 yum 清單快取
      2. 安裝相關的軟體，至少須安裝 vim-enhanced, bash-completion, net-tools, links, bind-utils, kernel-tools, kernel-modules 		(某些軟體可能需要使用 PowerTools 軟體倉儲安裝喔！但是該軟體倉儲預設需要是不啟用
      3. 全系統自動升級，且每天凌晨 3 點也會自動升級一次。(請寫入 /etc/crontab 為主)

   2. SELinux 的相關問題整理： 	

      1. 將 SELinux 修改成為 Enforcing 模式，且未來每次開機都自動為 Enforcing 才行 (若不為 Enforcing 狀態，則這題算全錯)
      2. 讓 /home/demouser/ 底下的所有檔案恢復成為正常的 SELinux 安全本文
      3. 當重新啟動 sshd 的時候 (systemctl restart sshd) ，該服務會報錯誤！請透過查詢登錄檔的方式，解決這個 SELinux 產生的問題 		(注意，你可能需要安裝 setroubleshoot* 才能夠順利取得問題的解決方案，並且查看到有 port 2222 的產生才行！

   3. 網路參數的設定，請依據底下的方式來設定好： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。因此，請先刪除所有的連線界面後，再重建三個網卡界面 (ens3, ens7,.ens8) 之後， 		才開始底下的設定任務。

      2. ens3 外部網路參數為： 172.18.255.*/24 ，其中 * 為老師規定的 IP  尾數。另外 gateway 為 172.18.255.254，而 DNS 為 172.16.200.254 以及 168.95.1.1

      3. ens7 內部網路參數為： 172.19.*.254/24，不需要 gateway 

      4. ens8 開機後設定為『不啟動』模式

      5. 主機名稱指定為： pc*.example.dic

      6. 最終你的主機名稱與 IP 的對應為：

         ```
         pc*.example.dic		172.18.255.*		別名為 pc*
         pc254.example.dic	172.18.255.254		別名為 pc254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

2. (10%)實作題：啟動 client 作業硬碟 - unit2 

   1. 因為系統是 clone 來的，因此請先刪除 ens3 連線後，重新建立新的 ens3 連線名稱
   2. 網路參數的設定，請依據底下的方式來設定好： 	
      - ens3 網路參數為： 172.19.*.1/24 ，其中 * 為老師規定的 IP  尾數。另外 gateway 為 172.19.*.254，而 DNS 為 172.16.200.254 以及 168.95.1.1
      - 主機名稱指定為： client.lan*.example.dic

3. (30%)簡易問答題： 	從具有 GUI 及中文的用戶端 Linux ，使用『 ssh root@172.19.*.254 』登入你的 Server ，之後建立 /root/ans.txt 的檔案，並將底下各題目的答案寫入你 server 當中！ 

   1. 網路功能是硬體、作業系統、系統呼叫、應用程式中，哪些層級所提供的功能？
   2. OSI 七層協定，從最底層的硬體層寫起，將七層的中文名稱依序寫下來
   3. 一般來說，所謂的網路基礎，指的是哪幾層？同時，上課提到，每一層的表頭資料中，最重要的參數各為何 (經常用在防火牆的管理上)
   4. TCP/IP 將 OSI 的七層簡化成為哪幾層？
   5. 常見的網路資料中，MAC/IP/TCP/UDP ，哪些被稱為 frame ？哪些被稱為 packet ？
   6. 什麼是 MTU？一般來說，正常的 MTU 大概是多少？而通常比較好的 switch 又可以接受多大的 MTU 呢？
   7. 思考，為何需要修改 MTU (效能、頻寬、內網的 LAN、外網的 WAN？)
   8. 何謂網路的 Socket pair ？
   9. 找出 568A 及 568B 的 RJ-45 接頭的顏色排序各為何？
   10. 計算出 192.168.5.200/26 的 Network IP, broadcast IP, Netmask IP 以及可用 IP 範圍

4. 上傳成績 

   1. 請將 Server/Client 的硬碟通通啟動，並且確認兩者間的連線沒有問題；
   2. 在 Server 硬碟上面登入，然後執行 vbird_server_check_unit ，並依據提示資料填寫你的學號與 IP 尾數
   3. 該程式會偵測你的系統，並且通知你哪個部份可能有問題，你需要持續觀察或者重新處理的部份會交代妥當。
   4. 若一切沒問題，螢幕就會出現如下的字樣，然後你就能夠使用 links 去檢查你的檔案是否有順利的上傳了！
   5. Please use links http://172.18.255.250/upload/unit02 to check your filename

------

- 2020/09/22：趕緊直接上到 CentOS8 的環境介紹，不過，大部分的資料都沒有更動
- 2020/09/29：將 eth0 改為 en3，將 eth1 改為 ens7，將 eth2 改為 ens8 ！
- 2020/09/30：調整題目的順序，並將作業硬碟處理完畢！



## LACP 與 bonding/team 及 IPv6 簡易設定

3.1： 區域網路拓樸與 LACP 的需求

電腦數量不多的時候，透過一部 switch 來連結各個 LAN 裡面的電腦，然後再透過一部 gateway 連結外部網路，大概也就沒啥問題了。 但是，若以學校的電腦教室來說，一間教室 30~60 台電腦，若每個電腦在區網路都向同一部 Server 要資料的時候，你覺得每一部 PC 可以下載的頻寬會是多少？ 而 Server 可以提供的最大頻寬又是多少？這兩者有沒有關係呢？當然是有的啊！

- 一般企業/學校在電腦數量龐大的情況下，通常的網路接法

以資傳系為例，我們有兩間電腦教室超過 50 台電腦，那一般的不是很昂貴的 switch 最多也不過是 48 port 而已，此時至少就得要串接兩個 switch 才行！ 假設如下圖示的接法：

![LAN switch](https://dic.vbird.tw/images/switch_raw_01.jpg)

仔細看上圖的結果喔：

- 直接連主幹 switch：
   	當有三部 PC 直接連上 B 這個 switch 時，這三部 PC 可以獲得完整的伺服器提供的三張網卡總頻寬。
- 非主幹的 switch ：
   	但如果是 A 與 C 區連接的 PC 呢？由於 A 到 B 兩個 switch 僅使用到一個埠口，因此這兩個 switch  	之間最大的頻寬當然也只有 1Gbits/s 的量，所以，如果 A 區有三部 PC 要使用伺服器的資源時，你猜猜網路流量的頻頸在哪裡？ 	想也知道是兩個 switch 間的總流量啊！那怎麼辦？能不能在兩部 switch 之間接上兩條以上的網路線啊？

- 常見的小型企業網路拓樸：

一般企業可能會有架設伺服器的小機房，然後又有員工所用的生產機器，因此習慣上的接法會這樣區分：

![LAN switch](https://dic.vbird.tw/images/switch_lan_1.jpg)

上述的連接方式是比較簡單且單純的：

- 如果你的區網內，每個員工常常有需要連線到 FTP 去下載大型檔案時，那麼這個連線的架構的頻頸將會發生在 FTP server 到 switch 這一段。
- 如果區網-1 的內部網路中，有個特殊的服務被啟動，而區網-2 的員工都得要去存取他時，那麼頻頸就會發生在 switch 到 switch 連接的那個 port 上面囉。

- 單一主機的多個網段服務

例如資傳系的 DRBL 快速復原系統的環境：

![LAN switch](https://dic.vbird.tw/images/switch_lan_2.jpg)

缺點是，你得要區分不同的 switch 與 port 以及相關的 DHCP 或 IP 的設定才行！而不是將所有的網路全部串接在一起而已！連接上面要很小心！

- 透過 switch 的 LACP 增加頻寬

如果你的 switch 可以支援 LACP 的功能，那才可以使用底下的連接方式：

![LAN switch](https://dic.vbird.tw/images/switch_lan_3.jpg)

如上圖所示，主控的 (最上方那部) switch 僅直接連接伺服器與 switch 而已，並不接受一般 PC 的連接。至於其他三部 switch 則是每部連接 20 個 PC 終端設備。 因為使用 24 port switch，所以這三部 switch 總共會花費 20+3 個埠口，就剩下一個備用的囉。其他共用設備 (印表機、伺服器等) 就都接在主控 switch 上頭， 如此一來，一般的網際網路連線，就只會經過主控 switch 與該 PC 連接的 switch，其實是有擴大頻寬的功能的。

​		例題 3.1.A： 嘗試回答下列問題： 	

- 觀察一下本教室的網路連接方式，進一步繪製出網路連接的拓樸圖示。
- 就你的觀察，全 10G switch 對於 PC 與 PC 之間，還有 PC 與 server 之間有沒有很大幅度的效益？為什麼？ 		請就頻寬、傳輸速度、PC/server可以負荷的最大讀寫效能做解釋。

事實上，骨幹才需要全 10G switch，其他的辦公室內，大概 2port 10G + N port 1G 的 switch 規劃，可能會是比較好又便宜的解決方案。

要注意的是，兩個 switch 不可以在沒有設定 LACP 或其他相關協定時，使用兩條以上 (含) 的網路線連接～ 如果你用了兩條以上的網路線串連兩部 switch， 這時就會產生 switch 內部的廣播風暴，好一點的 switch 會自動的關閉被你連接的那幾個埠口  (那幾個埠口不能使用了)，差一點或者是沒有設定防堵機制的， switch 可能會熱當或者是造成連接到該 switch 的所有設備無法連線的問題喔！要注意！要注意！很嚴重！很嚴重！

- 那，什麼是 LACP

LACP 的全名是 Link Aggregation Control Protocol，中文翻譯為『鏈路聚合控制協定』，這個通訊協定可以在 switch 對 switch 之間，或  switch 對 PC 之間有連線的需求時，可連接多條實體網路線，以達到網路連線容錯以及增加兩者間頻寬的目的。

這個 LACP 協定最初發展的目的就有兩個，一個是由於有多條連線，因此連線就具有容錯功能，可以在某條連線失敗時， 兩者間的連線依舊可以透過其他存在的連線來達成。另一個就是在增加整體的網路流量傳輸率(throughput)。

那麼 LACP 實際上在 switch 的連線是如何進行資料傳送的呢？其實所有的資料都會被分散在實體的 switch 間的連線中，另外，我們知道  switch，尤其是第二層的 switch 主要是針對網卡卡號 (MAC) 來進行資料的傳送，為了不要讓 switch 一直在埠口間切換同一個 MAC，因此， 同一部主機所發出的連續訊框 (frame)， 基本上都會透過同一個實體網路線來傳送，而不是交替在不同的網路線間傳送。

舉例來說，如果有兩條對接的線，在兩邊的 switch 各有兩部主機，並且分別對另一台 switch 的主機連線。理論上，兩兩 PC 連線會透過不同的兩條實體線路連接， 所以總頻寬就可以增加一倍了！當然，這是最佳的情況啦！

### 3.2： Linux bonding 的頻寬處理

前一個小節的許多圖示當中，你會發現有時候 Linux Server 會有多張網卡的埠口～這啥鬼？這些埠口是分別有各別的 IP 網路參數設定？ 還是共用 IP 參數呢？個別的網路參數還好說 (前一章我們已經設定過內/外網卡了)，那如果是共用 IP 網路參數呢？也就是說， 兩張以上的網卡共用一個 IP 呢？可行嗎？可以的！這就是類似 bonding 的功能！

- 什麼是 bonding

早期由於乙太網路卡的速度還不夠快，那如果妳的伺服器需要比較大的頻寬使用時，就得要購買更昂貴的設備才行。 那為什麼不能將幾張網卡合併成為一張來擴大頻寬呢？此外，對於重要的服務來說，網路是不能中斷的！所以，能不能使用兩條以上的線路連接到我的伺服器呢？ 因此，(1)合併網路卡的頻寬與 (2)讓網路具有容錯能力 (fault tolerance) 就成了 Linux bonding 最主要的考量了！ 目前 Linux bonding 功能已經加入核心，所以妳只要啟動它即可！不需要額外安裝其他軟體呦！

- Bonding 的模式與功能：

bonding 根據當初設計理念的不同，有許多常用的模式可以參考：

- 模式 0，循環負載平衡合併頻寬 (Round-robin, balance-rr)：
   	Linux bonding 會將要發送的封包循序的從任何可用的網卡上面循環發送，因為是循環發送的，所以每張網卡就能夠被充分利用～ 	不過，就鳥哥的經驗來看，這種模式的負載平衡方面似乎沒有想像中的好！所以鳥哥不建議使用。

- 模式 1，自動備援模式 (Active-backup)：
   	假設有三個網路卡做成這種 bonding 模式的話，那麼永遠都只有一個網路卡會運作，我們稱之為主要網卡 (primary)！除非這個主要網卡連線失敗了， 	另一張網卡 (slave) 才會扶正而成為下一個主要網卡，並持續提供服務。這種模式並不會合併頻寬，只會用在連線的容錯而已。

- 模式 4，LACP 鏈路聚合模式 (IEEE 802.3ad Dynamic link aggregation)：
   	這種模式算是業界的標準支援吧！妳的 bonding 網卡啟動在這種模式下，然後讓串接到這些網卡的 switch 埠口設定好 LACP 群組， 	這樣就能夠達成與 LACP 相同的頻寬倍增功能！這種模式得要有支援網管且提供 LACP 設定的 switch 才行！這種模式可以同時提供合併頻寬與網路容錯！

- 模式 5，自動調整傳輸負載平衡 (Adaptive transmit load balancing, balance-tlb)：
   	在傳送方面，這種模式會將封包分散在各個可用的 bonding 網卡上送出，因此傳送才能夠達到合併頻寬。不過在接收封包時， 	由於考慮到 switch 的 MAC 記憶能力，因此僅有一個網卡的 MAC 會被紀錄於 switch 上頭，簡單的說，就是僅有一張網卡會用於接收！ 	除非該接收網卡掛點， 否則其他網卡不會被用在接收上。這種模式也算挺適合用在『主要在發送資料給用戶端的 Server 』上， 	如果 server 也要負責大量資料的接收，恐怕就不是這麼適合了。

- 模式 6，自動調整全負載平衡 (Adaptive load balancing, balance-alb)：
   	這個模式包括了模式 5，除了傳送可以合併頻寬之外，連接收也可以合併頻寬了。當伺服器要傳資料出去給用戶端時，bonding 模組會主動的攔截封包， 	並透過 ARP 協商機制 (ARP 就是透過 IP 去找出 MAC 的通訊協定)，將不同的網卡要送出到同一個用戶端的封包，都改寫成單一一個固定的發送端 MAC 位址， 	如此一來，發送有合併頻寬的功能了，但接收卻還是只有一個 MAC 而已對吧？那怎麼說接收有合併頻寬的負載平衡機制呢？

   		原因是這樣的：當有資料封包要送出到多個不同的用戶端時，此模式的 bonding 模組就會透過 ARP 協商機制，找出 bonding 管理的比較閒置的網卡  	MAC 分配給下個用戶端，如此一來，不同的用戶端回傳給伺服器的資料，就可以透過不同的網卡來接收，就能達到接收也合併頻寬的功能了。

   		這個模式不需要特別的 switch 支援，而且設定簡單，可以在接收、傳送都達成合併頻寬的能力，且也具有基本的網路容錯功能， 是目前鳥哥最愛使用的 bonding 模式啦！

- Linux bonding 處理

你得要先知道為什麼要做 bonding 呢？可能的原因有兩個：

- 為了讓網路連線有備援，因此斷了一條網路的時候，另一條網卡會主動接管
- 為了增加頻寬

如果是為了第一點，那使用 bonding 模式 1 (Active-backup) 的功能最好！如果是為了第二點，那你得要注意，就是你 server 提供的資料速度要比兩張網卡更快， 所以你的硬碟不能太慢 (當然，如果傳輸的資料是在記憶體，那就無關硬碟)，而且，同一個用戶端與 server 之間的連線，最多只能有一條網路線的頻寬使用， 因此你的 client 端如果也用兩張網卡想要綁定到 server，其實是無法增加頻寬的喔！這點要先說明。

所以，如果是為了增加頻寬，那你就應該要有這樣的想法：

- 你的 Server 總體讀/寫速度要高於所有網卡的頻寬總和才好
- 你的網卡所連接的 switch 總背板頻寬 (bandwidth) 要能夠負荷 bonding 的最高流量
- 用戶端的數量要比網卡數還要多才合理

1. 事先工作：先了解網卡的狀態 	

   你要 bonding 的網卡應該要連接到同一個 switch 上面，而且未來會創造一個新的 bonding 網卡，所以你的實體網卡上面的設定應該要先去除。 	因此，先讓我們把 ens7, ens8 這兩個連線去掉

   ```
   [root@localhost ~]# nmcli connection delete ens7
   [root@localhost ~]# nmcli connection delete ens8
   ```

2. 建立 bonding 網卡： 	

   再來建立 bonding 網卡就使用 nmcli 來建立即可～我們假設這張網卡的連線名稱為 bond0 (con-name bond0)，且實際網卡名稱也是 bond0 (ifname bond0)， 	使用的類型為 bond (type bond)，然後使用的參數為模式 6 或稱為 balance-alb ，大約 100 ms 檢查一次網路，所以整體的設定會是這樣：

   ```
   [root@localhost ~]# nmcli connection add con-name bond0 ifname bond0 \
   > type bond bond.options "miimon=100,mode=6"
   
   [root@localhost ~]# nmcli connection show
   NAME   UUID                                  TYPE            DEVICE
   bond0  fb901bbd-bb61-4080-9c50-97db5649570b  bond            bond0
   ens3   0af5a13a-792e-4b62-a671-2371e183b31b  802-3-ethernet  ens3
   ```

   這樣就建立了 bond0 這張網路卡。問題是，還沒有任何一個附掛的實體網卡給 bond0 使用～這時就得要這樣做：

3. 建立支援 bonding 的實體網卡，透過 bond-slave 類型： 	

   附掛在 bonding 底下的實體網卡使用的類型為 bond-save，而主要的參數就是設定主人 (master) 為 bond0 即可！

   ```
   [root@localhost ~]# nmcli connection add con-name ens7 ifname ens7 type bond-slave \
   > master bond0
   [root@localhost ~]# nmcli connection add con-name ens8 ifname ens8 type bond-slave \
   > master bond0
   
   [root@localhost ~]# nmcli connection show
   NAME   UUID                                  TYPE            DEVICE
   bond0  fb901bbd-bb61-4080-9c50-97db5649570b  bond            bond0
   ens3   0af5a13a-792e-4b62-a671-2371e183b31b  802-3-ethernet  ens3
   ens7   48fc4ea4-6e19-4f4f-b2d8-00cef479ee29  802-3-ethernet  ens7
   ens8   25ef25a4-349d-458f-9071-c439843f8473  802-3-ethernet  ens8
   
   [root@localhost ~]# ip addr show
   3: ens7: <BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master bond0 state UP qlen 1000
       link/ether 52:54:00:f4:bd:20 brd ff:ff:ff:ff:ff:ff
   4: ens8: <BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master bond0 state UP qlen 1000
       link/ether 52:54:00:34:ab:27 brd ff:ff:ff:ff:ff:ff
   9: bond0: <BROADCAST,MULTICAST,MASTER,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000
       link/ether 52:54:00:f4:bd:20 brd ff:ff:ff:ff:ff:ff
       inet6 fe80::3db0:ba24:9d55:6dd6/64 scope link
          valid_lft forever preferred_lft forever
   
   [root@localhost ~]# nmcli connection up bond0
   [root@localhost ~]# nmcli connection up ens7
   [root@localhost ~]# nmcli connection up ens8
   ```

4. 最後觀察目前的使用情況： 	

   直接查看記憶體內的參數即可了解目前的 bonding 狀態！

   ```
   [root@localhost ~]# cat /proc/net/bonding/bond0
   Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)
   
   Bonding Mode: adaptive load balancing
   Primary Slave: None
   Currently Active Slave: ens7
   MII Status: up
   MII Polling Interval (ms): 100
   Up Delay (ms): 0
   Down Delay (ms): 0
   
   Slave Interface: ens7
   MII Status: up
   Speed: Unknown
   Duplex: Unknown
   Link Failure Count: 0
   Permanent HW addr: 52:54:00:f4:bd:20
   Slave queue ID: 0
   
   Slave Interface: ens8
   MII Status: up
   Speed: Unknown
   Duplex: Unknown
   Link Failure Count: 0
   Permanent HW addr: 52:54:00:34:ab:27
   Slave queue ID: 0
   ```

5. 最後，修改成正確的 IP 參數即可！

   ```
   [root@localhost ~]# nmcli connection modify bond0 ipv4.method manual \
   > ipv4.addresses 10.255.200.254/24
   [root@localhost ~]# nmcli connection up bond0
   [root@localhost ~]# ifconfig bond0
   bond0: flags=5187<UP,BROADCAST,RUNNING,MASTER,MULTICAST>  mtu 1500
           inet 10.255.200.254  netmask 255.255.255.0  broadcast 10.255.200.255
           inet6 fe80::3db0:ba24:9d55:6dd6  prefixlen 64  scopeid 0x20<link>
           ether 52:54:00:f4:bd:20  txqueuelen 1000  (Ethernet)
           RX packets 20  bytes 2820 (2.7 KiB)
           RX errors 0  dropped 0  overruns 0  frame 0
           TX packets 457  bytes 29100 (28.4 KiB)
           TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
   ```

​		例題 3.2.A：使用用戶端電腦確認 Server 的設定是生效的： 	

1. 啟動你的用戶端電腦，修改網路成為 10.255.*.1/24 ，先不要有 gateway 沒關係，檢查看看能不能 ping 到你的 server 10.255.*.254 那個 IP 呢？
2. 在 Server 與 Client 端，分別使用 arp -n 查詢 IP 的 mac 對應，說明目前生效的 bond0 使用那一個網卡？
3. 在 client 端一直 ping server_IP 不要停，在 server 端關閉 ens7 ，看看 active 的網卡會變什麼？且 client 網路會不會中斷？

透過上面的練習，你會知道 bonding 的好處喔！

### 3.3： Linux team 的頻寬處理

Linux bonding 幾乎完全是 Linux 核心預設的支援，但許多 distribution 比較傾向於使用更多使用者空間的 team 這個服務！其實 team 跟 bonding 幾乎一模一樣！ 最大的差別就是一個在核心，一個有更多的使用者控制功能。但是要使用 team 就得要有 teamd 這個服務才行！不過不用擔心， CentOS 預設都有安裝了！為了確認，我們還是來查一查好了：

```
[root@localhost ~]# which teamd
/usr/bin/teamd

[root@localhost ~]# find /usr/lib/systemd/ -type f | grep team
/usr/lib/systemd/system/teamd@.service
```

因為 team 要做的跟 bonding 其實是一樣的！因此，如果要實做 team 的話，請將 bonding 取消吧！所以，事前工作就是刪除 bonding 囉！

```
[root@localhost ~]# nmcli connection delete ens7
[root@localhost ~]# nmcli connection delete ens8
[root@localhost ~]# nmcli connection delete bond0
```

再來就是準備要建立一個 team0 的網卡，也是很簡單！不過要注意的是， team 的模式主要有底下幾種：

- activebackup (就是 bonding 的 mode 1)
- roundrobin (就是 bonding 的 mode 0)
- loadbalance (就是 bonding 的 mode 6)
- lacp (就是 bonding 的 mode 4)

不同於 bonding 的設定只要指定模式就好， team 的設定內容比較複雜，很多關鍵字要記憶！如果要建立一個自動備援的 team ，就得這麼做：

```
'{"runner":{"name":"activebackup"}}'
```

現在讓我們來實做一個 team0 的連線，網卡名稱為 team0，而設定為 activebackup (不是 loadbalance 喔！)

```
[root@localhost ~]# nmcli connection add con-name team0 ifname team0 type team \
> config '{"runner":{"name":"activebackup"}}'

[root@localhost ~]# nmcli connection show team0
connection.id:                          team0
connection.interface-name:              team0
connection.type:                        team
team.config:                            {"runner":{"name":"activebackup"}}

[root@localhost ~]# nmcli connection add con-name ens7 ifname ens7 \
> type team-slave master team0
[root@localhost ~]# nmcli connection add con-name ens8 ifname ens8 \
> type team-slave master team0
```

修改網路參數吧，因為 team0 要有網路參數後，才有辦法順利啟動。如果使用 dhcp 的話，team0 很可能會無法啟用， 因為我們的內網並沒有 DHCP 的伺服器存在之故。

```
[root@localhost ~]# nmcli connection modify team0 ipv4.method manual \
> ipv4.addresses 10.255.200.254/24
[root@localhost ~]# nmcli connection up team0
[root@localhost ~]# nmcli connection up ens7
[root@localhost ~]# nmcli connection up ens8
[root@localhost ~]# ifconfig team0
team0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.255.200.254  netmask 255.255.255.0  broadcast 10.255.200.255
        inet6 fe80::a917:23db:27cd:3aa1  prefixlen 64  scopeid 0x20<link>
        inet6 fe80::5362:bce8:3ba:fed7  prefixlen 64  scopeid 0x20<link>
        inet6 fe80::d75c:9763:f9f5:b3ed  prefixlen 64  scopeid 0x20<link>
        ether 52:54:00:f4:bd:20  txqueuelen 1000  (Ethernet)
        RX packets 22  bytes 2732 (2.6 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 22  bytes 3040 (2.9 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

接下來查看一下 team 是否正確的運作中！這時就得要使用 teamd 提供的管理功能了！

```
[root@localhost ~]# teamdctl team0 state
setup:
  runner: activebackup
ports:
  ens7
    link watches:
      link summary: up
      instance[link_watch_0]:
        name: ethtool
        link: up
        down count: 0
  ens8
    link watches:
      link summary: up
      instance[link_watch_0]:
        name: ethtool
        link: up
        down count: 0
runner:
  active port: ens7
```

​		例題 3.3.A：使用用戶端電腦確認 Server 的設定是生效的： 	

1. 啟動你的用戶端電腦，修改網路成為 10.255.*.1/24 ，先不要有 gateway 沒關係，檢查看看能不能 ping 到你的 server 10.255.*.254 那個 IP 呢？
2. 在 Server 與 Client 端，分別使用 arp -n 查詢 IP 的 mac 對應，說明目前生效的 team0 使用那一個網卡？
3. 在 client 端一直 ping server_IP 不要停，在 server 端關閉 ens7 ，看看 active 的網卡會變什麼？且 client 網路會不會中斷？

鳥哥是覺得兩個功能效果都差不多，就看你個人的喜好而定了。目前 CentOS 預設建議使用 team 就是了！參考看看。 另外，經過測試的結果，team0 在 loadbalance 底下要支援 IPv6 的設定比較麻煩，所以如果你的 team0  未來會加上 IPv6 的 IP 位址時，就要改成 activebackup 比較好設定！

### 3.4： IPv6 基礎與設定

IPv4 的網路位址已經發放完畢了，目前新興國家或新的 ISP 若想要取得 IPv4 的話，就只能向其他已經申請的人購買～不過應該還是不夠用的！ 因為現在連手機等行動裝置，還有 IOT 的偵測器與收集器都需要用到網際網路，這也都需要 IP 的！所以，沒有新的 IP 來源，那就慘了！ 因此，IPv6 就這樣產生囉！

IPv6 跟 IPv4 一樣都在網路層 (layer 3)，使用的 IP 封包也差不多，只是表頭資料與相關功能比較不同。相關功能這裡就不說明， 要強調的是 IPv6 使用了 128bits 來作為 IP 位址使用～也就是說 IPv4 用 32 個 0 與 1 排列來展示位址，而 IPv6 用了 128 個 0 與 1 排列來展示位址... 底下沒辦法直接寫下來，實在太長了！

為了簡化位址長度， IPv4 是轉 2 進位為 10 進位，而 IPv6 則是轉 2 進位成為 16 進位 (2 的 4 次方)，因此 128/4 = 32 個 16 進位的數字！ 所謂的 16 進位指的是 0, 1 ... 9, a, b, c, d, e, f ，其中 f 代表的就是 16 的意思，那每 4 個 16 進位的數字分別做一個區隔， 因此舊有 32/4 = 8 組 16 進位的數值，最小與最大就分別是：

- 0000:0000:0000:0000:0000:0000:0000:0000
- FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF

- IPv6 的 IP 位址簡化表示法：

如上所示，雖然已經經過了一些簡化，而不是使用 128 個 0 與 1 的表示，同時將 IPv4 的 10 進位改為 16 進位，理論上確實少很多數值了， 不過，總數 32 個 16 進位的數值，還是稍嫌長了些～因此，IPv6 的 IP 位址允許做一些簡化的寫法！亦即：

- 在同一個冒號之間的數值，若為連續的 0 ，則只填一個 0 即可
- 在同一個冒號區間的數值，左邊高位元若為連續的0，則可以簡化略過不寫
- 連續(含)一個以上的 :0000: 時，可以使用 :: 來取代，但只能保留一組 :: 的存在。

如下所示，第一行為標準的 IPv6 的 IP 位址寫法，第二行則符合上述第 2 點，連續的 0 可以簡化，第三行則符合上述的第 3 點，超過一個以上的 :0000: 時， 可以使用 :: 來取代，但是只能保留一組，所以第三行右側的 :0:0 就不能繼續簡化了 (通常保留左側高位的數值)

- FE80:1234:5678:0000:0000:0010:0000:0000
- FE80:1234:5678:0:0:10:0:0
- FE80:1234:5678::10:0:0

- IPv6 的子網路遮罩 (Netmask)

就跟 IPv4 的 IP address 一樣具有區網的 netmask IP，IPv4 同樣也有自己的區網所需要指定的 Netmask IP，只是...這個 IPv6 的 netmask 就沒道理還要用 IP 吧？ 呵呵！當然是直接使用 bit 來展示了！一般來說，IPv6 的 Netmask 通常使用了 64bit 作為區域網路的劃分，不過就如 IPv4 的無等級 IP (CIDR) 一樣， 你當然也能夠指定自己的 Netmask IP 囉。由於 IPv6 是以 16bit 為一個 IP 位址區段分隔，因此 netmask 也通常就是 16 的倍數，底下以 2001:0db8 這個網段來說明：

- Netmask 為 32 bit 時： 	
  - Network IP: 2001:0db8:0000:0000:0000:0000:0000:0000 		
    - 可以簡化為： 2001:db8::
  - Broadcast IP: 2001:0db8:ffff:ffff:ffff:ffff:ffff:ffff
  - 網域表示方式：2001:db8::/32
- Netmask 為 64 bit 時： 	
  - Network IP: 2001:0db8:1234:5678:0000:0000:0000:0000 		
    - 可以簡化為： 2001:db8:1234:5678::
  - Broadcast IP: 2001:0db8:1234:5678:ffff:ffff:ffff:ffff
  - 網域表示方式：2001:db8:1234:5678::/64

- 只用於區網且只與網卡卡號有關的 Link Local Address 的 IPv6 位址

為了簡化區域網路內部的 IPv6 之 IP 位址設定，因此 IPv6 規劃的時候，有提出一個明於區域網路連結位址 (Link Local Address) 的 IPv6 位址設定方式！ 其實很簡單，就是提供一個 fe80::/10 的區段給 LAN 使用，且最後的 64 位元 (最後 4 組位址數值) 使用網卡卡號來計算～，同時能使用的區網為 64bit 的設計， 因此最終會有 fe80::/64 這一段的區網來使用喔！

​		例題 3.4.1：嘗試查看你的系統的 IPv6 內部位址。

```
[root@localhost ~]# ip addr show ens3
2: ens3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:99:57:99 brd ff:ff:ff:ff:ff:ff
    inet 192.168.254.200/24 brd 192.168.254.255 scope global ens3
       valid_lft forever preferred_lft forever
    inet6 fe80::714f:d0c7:d7a0:773b/64 scope link
       valid_lft forever preferred_lft forever

[root@localhost ~]# ip addr show team0
22: team0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000
    link/ether 52:54:00:f4:bd:20 brd ff:ff:ff:ff:ff:ff
    inet 10.255.200.254/24 brd 10.255.200.255 scope global team0
       valid_lft forever preferred_lft forever
    inet6 fe80::d75c:9763:f9f5:b3ed/64 scope link tentative dadfailed
       valid_lft forever preferred_lft forever
    inet6 fe80::a917:23db:27cd:3aa1/64 scope link tentative dadfailed
       valid_lft forever preferred_lft forever
    inet6 fe80::5362:bce8:3ba:fed7/64 scope link tentative dadfailed
       valid_lft forever preferred_lft forever
```

​		雖然 team0 的 IPv6 位址怪怪的，先不理他，我們來嘗試 ping 一下自己的 IPv6 ens3 的位址看看：

```
[root@localhost ~]# ping6 fe80::714f:d0c7:d7a0:773b
PING fe80::714f:d0c7:d7a0:773b(fe80::714f:d0c7:d7a0:773b) 56 data bytes
64 bytes from fe80::714f:d0c7:d7a0:773b%ens3: icmp_seq=1 ttl=64 time=0.099 ms
64 bytes from fe80::714f:d0c7:d7a0:773b%ens3: icmp_seq=2 ttl=64 time=0.034 ms
64 bytes from fe80::714f:d0c7:d7a0:773b%ens3: icmp_seq=3 ttl=64 time=0.075 ms
^C
--- fe80::714f:d0c7:d7a0:773b ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2000ms
rtt min/avg/max/mdev = 0.034/0.069/0.099/0.027 ms
```

​		要使用 IPv6 的位址時，使用的不是 ping 而是 ping6 喔！你也會發現這是內部網卡自己的功能，所以 IP 的顯示最終都會有網卡名稱存在！ 	這種網路不能夠跨路由，只能在區網裡面簡單的進行快速 IPv6 的封包傳送！ 

所以，你會看到所有自動產生的 IPv6 的 IP 位址都是 fe80 開頭的！這是由作業系統根據網卡卡號自動計算產生的喔！ 再說一次，不能夠直接對外連網，只能在區域網路內部互相連結而已喔！

- IPv6 的 private IP (Unique Local Address) 與 public IP (Global Unicast Address)

與 IPv4 的 private IP 類似，IPv6 也提供一段的 IP 來給區網使用，使用的區段為 FC00::/7，亦即開頭為 FC00:: ~ FDFF:: 之間的 IP 段落。 目前較常使用 FD00::/8 這一網段。

至於 public IP 則使用 2000::/3 (2000:00 ~ 3FFF::) 這一大段，與 IPv4 的 public IP 一樣，你的 IPv6 位址得要從你的 ISP 處取得， 才能夠順利的以 IPv6 的 IP 位址連上 Internet 的。那麼有沒有那一段 Public IP 可作為測試的區段呢？ 有的，那就是 2001:0db8::/32 這一大段 IP 位址可以提供給測試範本 (example) 使用，亦即是，你可以使用這一段 IP 位址來測試你的 IPv6 網路囉！ 那怎麼設定呢？一樣啊！使用 nmcli 來設定 ipv6.addresses 即可！

讓我們來實際測試一下，在外部網路 (ens3 這張網卡) 請使用 2001:0db8:1000::XX/64，其中 XX 為你的學號尾數轉成 16 進位的結果。

```
[root@localhost ~]# nmcli connection show ens3 | grep ipv6
ipv6.method:                            auto
ipv6.dns:
ipv6.dns-search:
ipv6.dns-options:                       （預設）
ipv6.dns-priority:                      0
ipv6.addresses:                         
ipv6.gateway:                           --
ipv6.routes:
....(預設什麼都沒有)....

[root@localhost ~]# nmcli connection modify ens3 ipv6.method manual \
> ipv6.addresses 2001:0db8:1000::c8/64 (200號的 10 進位轉成 16 進位的結果為 c8)

[root@localhost ~]# nmcli connection up ens3

[root@localhost ~]# nmcli connection show ens3 | grep ipv6
ipv6.method:                            manual
ipv6.dns:
ipv6.dns-search:
ipv6.dns-options:                       （預設）
ipv6.dns-priority:                      0
ipv6.addresses:                         2001:db8:1000::c8/64
ipv6.gateway:                           --
ipv6.routes:

[root@localhost ~]# nmcli connection show ens3
....前面的先省略不看....
IP4.ADDRESS[1]:                         192.168.254.200/24
IP4.GATEWAY:                            192.168.254.254
IP4.DNS[1]:                             120.114.100.1
IP4.DNS[2]:                             168.95.1.1
IP6.ADDRESS[1]:                         2001:db8:1000::c8/64
IP6.ADDRESS[2]:                         fe80::714f:d0c7:d7a0:773b/64
IP6.GATEWAY:

[root@localhost ~]# 2001:db8:1000::c8
64 bytes from 2001:db8:1000::c8: icmp_seq=1 ttl=64 time=0.057 ms
64 bytes from 2001:db8:1000::c8: icmp_seq=2 ttl=64 time=0.042 ms
64 bytes from 2001:db8:1000::c8: icmp_seq=3 ttl=64 time=0.024 ms
^C
--- 2001:db8:1000::c8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 1999ms
rtt min/avg/max/mdev = 0.024/0.041/0.057/0.013 ms
```

最後用 ping6 來檢查看看對不對喔！

​		例題 3.4.2：設定你的 IPv6 內部區域網路。不過由於 team0 的 loadbalance 模式預設的設定對 IPv6 的 IP 位址支援度似乎怪怪的， 	所以，如果你以前使用的 team0 是 loadbalance 的話，得要先修改 team0 的模式成為 activebackup 之後，底下的設定才能成功喔！  	『 nmcli connection modify team0 config '{"runner":{"name":"activebackup"}}' 』 	

- 在 server 內部網路 (team0 這張網卡) 請使用 2001:0db8:2000:XX::ff/64
- 在 client 端的 ens3 上面，請用 2001:0db8:2000:XX::1/64 來設定網路。

最終使用 ping6 serverIP, ping6 clientIP 來查詢兩者是否能夠互通就 OK 了！最後，一般來說，我們要寫 IPv4 的 socket 使用 10.255.200.254:80 這樣的模式， 那麼 IPv6 怎麼寫呢？就得要寫成 [2001:0db8:2000:XX::ff]:80 囉！亦即 IPv6 的 IP 位址加上中括號來區隔 port 號！這樣理解否？

### 3.5： 課後練習

1. (50%)實作題：啟動 Server 作業硬碟 - unit3 

   1. 網路參數的設定，請依據底下的方式來設定好你的網路環境： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 為外部的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.18.255.*/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.18.255.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 使用 teamd 的機制建立內部區域網路的備援功能： 		

         - team 的界面使用 team0 卡號，且連線名稱請命名為 team0
         - team 使用 activebackup 備援功能，不要使用 loadbalance
         - team 的實體網卡 (team slave) 請使用 ens7 及 ens8 ，且其連線名稱名稱亦請命名為 ens7, ens8
         - team0 網路參數為： 172.19.*.254/24，不需要 gateway 

      4. 主機名稱指定為： server*.example.dic

      5. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 基本的伺服器作業系統設定行為： 	

      1. 使用崑山的 FTP 網站作為你的 YUM server 來源，來源倉儲至少需要涵蓋 BaseOS, AppStream, extras, PowerTools 等， 		並且清除一次 yum 清單快取。(請注意，由於最終系統會全系統升級一次，升級後，這些設定檔可能會被更新。 		因此，你在全部升級完畢之後，還需要回來修改這個設定檔喔！)
      2. 安裝相關的軟體，至少須安裝 vim-enhanced, bash-completion, net-tools, mailx, wget, links, bind-utils,  		kernel-tools, kernel-modules (某些軟體可能需要使用 PowerTools 軟體倉儲安裝喔！但是該軟體倉儲預設需要是不啟用 
      3. 全系統自動升級，且每天凌晨 3 點也會自動升級一次。(請寫入 /etc/crontab 為主)
      4. 將 SELinux 修改成為 Enforcing 模式，且未來每次開機都自動為 Enforcing 才行

   3. IPv6 的設定： 	

      1. 在你的 team0 網卡上面設定 IPv6 的位址為： 2001:db8:3000:XX::ff/64，其中 XX 為你的 IP 尾數，直接輸入 10 進位數字，不用轉為 16 進位

      2. 你的 IPv6 主機名稱與 IP 的對應最終會成為：

         ```
         server6.lan*.example.dic	2001:db8:3000:*::ff	別名為 server6
         client6.lan*.example.dic	2001:db8:3000:*::1	別名為 client6
         ```

         ​			亦即當你 ping6 server6 或 ping6 client6 時，就會主動連接到正確的 IPv6 位址去！

2. (20%)實作題：啟動 client 作業硬碟 

   1. 網路參數的設定，請依據底下的方式來設定好： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.19.*.1/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.19.*.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 主機名稱指定為： client.lan*.example.dic

      4. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. IPv6 的設定： 	

      1. 在你的 ens3 網卡上面設定 IPv6 的位址為： 2001:db8:3000:XX::1/64，其中 XX 為你的 IP 尾數

      2. 你的 IPv6 主機名稱與 IP 的對應最終會成為：

         ```
         server6.lan*.example.dic	2001:db8:3000:*::ff	別名為 server6
         client6.lan*.example.dic	2001:db8:3000:*::1	別名為 client6
         ```

         ​			亦即當你 ping6 server6 或 ping6 client6 時，就會主動連接到正確的 IPv6 位址去！

3. (30%)簡易問答題： 	從具有 GUI 及中文的用戶端 Linux ，使用『 ssh root@172.19.*.254 』登入你的 Server ，之後建立 /root/ans.txt 的檔案，並將底下各題目的答案寫入你 server 當中！ 

   1. 當同一條網路線的兩個 RJ-45 水晶頭同時插入一個 switch 時，會發生什麼問題？
   2. 在有簡單網管功能的 switch 中，哪一個設定的啟動，可以在發生上述問題的時候，可以提供保護 (會將該 port drop 掉， 	請上網 google 找關鍵字 "switch broadcast storm protection" 所提供的資訊)
   3. 承上，在一般固定 IP 的手動設定環境中，上述功能啟動是比較好的。但如果在電腦教室的自動取得 IP 環境 (dhcp) 下， 	該功能可能會造成什麼後果？
   4. 為了增加兩部 switch 之間的溝通頻寬，可不可以直接在兩個 switch 上面，選用兩個 port 互接兩條網路線即可？如果可以就寫可以，如果不可以， 	那該如何處理？
   5. 計算出 192.168.10.100/27 的 Network IP, broadcast IP, Netmask IP 以及可用 IP 範圍
   6. 本課程中提到的，如果要讓 server 增加頻寬，可以使用那兩種機制來處理？
   7. 說明 bonding 的模式 1 及模式 6 最主要的差別在哪裡？
   8. 要了解 bonding 有沒有成功執行，以及 bonding 的網卡用的是哪幾個實際網卡，可以觀察那一個檔案？假設你現有的 bonding 網卡為 bond1 時。
   9. 如果你有兩個 client ，分別為 PC1 及 PC2，這兩個 client 都有設定 bonding，且都使用 mode6 ，同時均有兩張網卡。 	你有一個 server 為 serverA，ServerA 有四張網卡，同時也設定了 bonding，同時也使用了 mode6，且這共 8 張網卡均安插在同一個交換器上面。 	請問， PC1 對 ServerA，以及 PC2 對 ServerA 的上傳下載頻寬，最大各為多少？
   10. team 的那兩個模式分別對應 bonding 的 mode1 與 mode6 呢？
   11. 請 man teamd.conf ，寫下 teamd 所支援的所有模式有那幾個？
   12. IPv6 與 IPv4 在 IP 位址上，個別提供多少位元來記載位址？
   13. IPv6 的 IP 位址預設以冒號 (:) 隔開，其位址共有幾個間隔？每個間隔佔用多少位元？
   14. 那一個 IPv6 的網段預設是提供給內部區網使用的，且該網段是不能跨路由的。
   15. IPv6 提供那一個網段來作為 private IP？
   16. IPv6 提供那一個網段來作為範例用途 (example) ？
   17. 有一個 IP 網段為： 2001:0db8:0300:0000:0000:0001:0000:0000，請問這個 IP 可以怎麼做簡化？

4. 上傳成績 

   1. 請將 Server/Client 的硬碟通通啟動，並且確認兩者間的連線沒有問題；
   2. 在 Server 硬碟上面登入，然後用 root 的身份執行 vbird_server_check_unit ，並依據提示資料填寫你的學號與 IP 尾數
   3. 該程式會偵測你的系統，並且通知你哪個部份可能有問題，你需要持續觀察或者重新處理的部份會交代妥當。
   4. 若一切沒問題，螢幕就會出現如下的字樣，然後你就能夠使用 links 去檢查你的檔案是否有順利的上傳了！
   5. Please use links http://172.18.255.250/upload/unit03 to check your filename

------

- 2017/09/20：第一次以 CentOS 7 完成的版本
- 2020/09/29：修改為 CentOS 8 的版本，且主要以 ens3, ens7, ens8 取代 eth0, eth1, eth2 了！
- 2020/10/07：將作業的資料修訂一下，收集成績的腳本原來一直是錯的...已經訂正了！

## 認識與建置防火牆

###### 上次更新日期 2020/10/14

上週的課程雖然完成了內部區域網路的建置，但其實內部 LAN 的那部客戶端電腦事實上是無法上網的！為啥？ 因為你的 Server 還沒有成為 gateway/router 啦！另外，你的某些需要被保護的服務也需要好好的設定一下， 所以，這節課我們就來玩玩成為 router 的 NAT 功能與保護服務的防火牆功能囉！

學習目標

- 了解 Linux iptables 防火牆機制
- 熟悉 iptables 的觀察與設定語法
- 實際設定 Linux 伺服器本機防火牆
- 實際設定 Linux NAT 防火牆，含 SNAT 與 DNAT
- 了解 firewalld 的領域相關性

- 4.1： 什麼是防火牆
- 4.2： CentOS 8 的防火牆機制
- 4.3： iptables 的表格 (table) 與鏈 (chain)
- 4.4： NAT 網路位址轉換表格
- 4.5： 簡易的 firewalld 服務介紹
- 4.6： 課後練習

### 4.1： 什麼是防火牆

什麼是防火牆呢？基本上，防火牆的主要功能就是：

- 切割被信任(如子網域)與不被信任(如 Internet)的網段 (用 IP 判斷，為 Layer 3 的方法)；
- 劃分出可提供 Internet 的服務與必須受保護的服務 (用 IP 與 port 處理，為 Layer 3/4 的方法)；
- 分析出可接受與不可接受的封包狀態 (許多狀態封包，有點屬於防火牆的外掛功能)；

而依據達成上述功能的方法不同，基本上有分為軟體防火牆以及封包過濾式防火牆：

- 封包過濾式火牆：在 CentOS 上面使用 Netfilter 核心防火牆機制來控制 layer2, layer3, layer4 以及某些外掛的封包過濾行為， 	主要是分析訊框或封包的表頭資料來判斷是否放行該封包的一種方式；
- 軟體式防火牆：例如某些防毒、防木馬軟體內建的軟體過濾機制，或者是類似代理伺服器 (Proxy) 的功能，也都能算是某種特殊的軟體防火牆。

無論何種防火牆，大多是設定一堆流程與規則，讓封包要進入到本機前，需要通過這些規則的順序，以達到放行或者是拒絕的程序。

- 封包過濾型防火牆

開始了解 netfilter 之前，這裡先告知一下，其實早期 (事實上，目前還是存在的！) 有用比較簡單的方式，那就是使用 tcp_wrapper 的方式來抵擋服務的進出！ 只要修改 /etc/hosts.deny 與 /etc/hosts.allow 即可！這種方式主要透過一個名為 tcpd 的軟體來控管～但由於現在的 netfilter 的功能太強大， 因此目前很少人使用 tcp wrapper 了！

​	

不過，萬一你接手一台舊 server (意思就是，原先不是你建置的，可能是實驗室或是公司的老機器)，然後怎麼處理 netfilter 的機制都無法順利達成某些任務， 甚至於關閉 netfilter 都還有防火牆的管制時，記得去 /etc/hosts.allow 及 /etc/hosts.deny 瞧一瞧是否有異狀 (基本上，目前這兩個檔案的內容應該都是空的才對！)

基本上，封包過濾的防火牆就是根據封包的分析資料 "比對" 你預先定義的規則內容，若封包資料與規則內容相同則進行動作，否則就繼續下一條規則的比對！』 重點在那個『比對與分析順序』上。以底下的過濾流程圖示來解釋：

![iptables](https://dic.vbird.tw/images/iptables_01.png)

1. 你要先制定一些規則，例如底下的規則順序 (有順序之分喔！) 	
   1. 放行本機的網路界面 (lo, 就是 localhost 那片網卡)
   2. 放行 ICMP 這個封包檢測的功能 (例如 ping 就是其中一種 icmp 封包)
   3. 放行本機自己的回應封包 (就是本機自己向外要求的封包回應訊息，例如去 centos 官網後，官網回傳的訊息)
   4. 放行區域網路連線到自己本機的 ssh 服務要求。
   5. 放行來源為區域網路的所有要求
   6. 拒絕全部的連線
   7. 放行整個 Internet 連線到自己本機的 www 服務要求。
2. 當有任何網路來源對你這部系統發起連線時，就需要通過上面四個流程，而只要有任何一個流程通過，後面的流程就不會被檢測  	(重要的項目排在前面較佳)。
3. 萬一發起連線的封包並沒有符合任何一條規則時，那系統就會使用預設政策 ( Policy ) 來決定該連線封包是否放行。
4. 通常建議網路主機的預設政策為丟棄，亦即『關閉所有連線，開放特定服務』的設定機制較佳。

​		例題 4.1.A：請看 A 的幾個的流程，並且解析每條連線的通過與不通過的流程： 	

1. 對自己『 ping localhost 』會通不會通？用到那條規則？
2. 『 ssh localhost 』會通不會通？用到那條規則？
3. 區網內用戶端對我『 ping localhost 』時？那 internet 的用戶呢？
4. 區網內用戶端對我發起網路連線 (用瀏覽器連線我的 WWW 時)？那 internet 的用戶呢？
5. 區網內用戶端『 ssh 我的IP 』時？那 internet 的用戶呢？
6. 我主動連線到 www.google.com 去搜尋資料時？
7. 區網內用戶端對我發起 FTP 連線 (用瀏覽器連線我的 FTP 服務時)？那 internet 的用戶呢？

要懂的如何解析～這樣才會理解防火牆的建置與修改喔！

### 4.2： CentOS 8 的防火牆機制

linux kernel 就是使用 iptables 這個 netfilter 的防火牆機制，由於是核心提供的防火牆，所以效能特別好。 CentOS 8 提供了兩個管理機制，一個直接使用 iptables 來管理，一個則透過 firewalld 這個服務來管理。但是 firewalld 需要透過專屬的 firewall-cmd 這個指令來管理，在正常一般的管理行為中， firewall-cmd 較為簡易，但若有特別的規則時，則需要使用到 firewall-cmd 的 rich rule 來管理！ 其實學習 rich rule 才是王道！

不過，事實上，最終 firewalld 還是透過核心的 iptables 來達成防火牆控制。因此，在『學習防火牆機制』行為上，個人還是建議先摸一下 iptables 較佳。

​		例題 4.2.A：關於 firewalld 與 iptables 服務的啟動與關閉 	

1. 以 systemctl 觀察目前使用的是 firewalld 還是 iptables 這兩個服務的那一個啟動了？
2. 若沒有 iptables 這個服務，代表你的系統沒有安裝，請使用 yum 自己安裝好 iptables-services 這個軟體
3. 請關閉 firewalld 且重新開機不會啟動，請啟動 iptables 且重新開機會啟動。
4. 如何確定 iptables 是啟動的了？

- 會影響到防火牆的許多服務

因為虛擬化的環境中，虛擬系統需要透過本機對外連線，因此虛擬化軟體會主動的去修改實體機器的 iptables 防火牆。 不過，我們的上課環境已經就是虛擬機器，因此無須使用啟用虛擬化軟體，所以需要關閉這些軟體，避免防火牆規則一直被干擾影響。 另外，由於 Server 使用的是最小安裝，且 client 端的虛擬化軟體已經事先被鳥哥拿掉了，所以底下單純瞧瞧就好！

​		例題 4.2.B：先檢查有沒有 libvirtd 以及 virsh 的指令，若有這幾個指令存在，底下的練習才會生效！否則就無須進行底下的練習 	

1. 使用 virsh net-list 查看是否有一個名為 default 的網路資訊？
2. 使用 virsh net-destroy default 刪除掉這個特別的網路卡
3. 使用 virsh net-undefine default 讓這個虛擬網路裝置不會再被啟動。
4. 透過 systemctl 的方式關閉 libvirtd 這個特別的虛擬系統服務。
5. 請重新開機，這樣就能夠避免虛擬化造成的防火牆被修改的問題了。

先處理好服務，等一下才有辦法繼續玩下去！

### 4.3： iptables 的表格 (table) 與鏈 (chain)

iptables 預設提供好多種特殊的 IP 管理表格 (所以稱為 ip tables 嘛！)，基本上有三個比較常見的表格存在：

- filter 表格：針對伺服器本機的管理行為
- nat 表格：針對透過伺服器作為 router 之用的網路管理行為 (如 IP 分享器等)
- mangle 表格：與特殊的封包路由旗標有關

![iptables](https://dic.vbird.tw/images/iptables_02.png)

- iptables 針對本機的工作鏈 (chain)

針對本機的防火牆表格是 filter (過濾) 這個表格，filter 共有三個預設的鏈，分別是 INPUT, OUTPUT, FORWARD，功能如下：

- INPUT 任何進入本機使用本機服務的封包 (包括從伺服器端回傳的回應資訊)，都會經過這個鏈
- OUTPUT 從本機主動發出的封包，包括回應給用戶端的訊息，都會經過這個鏈
- FORWARD 沒有進入本機，但是透過本機轉遞 (例如本機為路由器的角色時) 的封包，就會經過這個鏈

一般來說，在單純的伺服器環境下 (沒有開放讓其他用戶使用本機的 ssh 等本地端服務)，只要管制 INPUT 鏈即可，OUTPUT 及 FORWARD 都可以直接放行。

- iptable 指令語法 - 觀察

使用 iptables-save 觀察防火牆的規則與順序：

```
[root@localhost ~]# iptables-save [-t table]
[root@localhost ~]# iptables-save -t filter; iptables-save -t nat
# Generated by iptables-save v1.8.4 on Mon Oct 12 21:49:46 2020
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [120:14633]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Mon Oct 12 21:49:46 2020
# Generated by iptables-save v1.8.4 on Mon Oct 12 21:49:46 2020
*nat
:PREROUTING ACCEPT [12:2787]
:INPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [2:136]
:OUTPUT ACCEPT [2:136]
COMMIT
# Completed on Mon Oct 12 21:49:46 2020
```

上表當中，出現 # 的都不用看，那僅是告知 iptables-save 的執行與輸出時間而已，至於 * 與 : 與 -A 開頭的就得要注意了：

- 使用的表格：出現 *filter 代表使用的是 filter 這個表格
- 使用的鏈：出現 :INPUT 代表 INPUT 的 chain ，而 ACCEPT 代表預設政策為接受，後續的 :OUTPUT, :FORWARD 都是類似的意思
- 使用的規則： 	
  - -A INPUT 為 INPUT 的依順序的各個規則！因為 -A INPUT 共有 5 個，因此就是說，共有 5 個針對 INPUT chain 的規則之意。
  - -A FOWARD 僅有一條規則
  - -A OUTPUT 沒有出現，代表沒有 OUTPUT 定義規則，亦即 OUTPUT 完全使用預設政策的意思。

- iptable 指令語法 - 清除鏈/規則，與定義預設政策

你要建立新的規則之前，最好將以前的規則全部刪除後，依序建立一條一條的規則順序，畢竟規則之間是有順序差別的！這點很重要！ 清除鏈與規則需要一條一條來執行，無法一口氣執行完畢。此外，建議不要在遠端機器完整的清除鏈與規則，否則容易因為自己的不小心， 導致本機拒絕了自己的連線功能喔！

```
[root@localhost ~]# iptables -[F|X|Z] (清除規則|自訂鏈|統計資訊)
[root@localhost ~]# iptables -P [INPUT|OUTPUT|FORWARD] [ACCEPT|DROP]  (注意，是大寫的 P 喔！)
```

​		例題 4.2.A：依序進行如下的題目 (主要針對 filter 表格) 	

1. 先針對三條鏈，全部給予 ACCEPT 的預設政策，設定完畢之後，請立刻觀察是否正確？
2. 清除所有的規則、自訂鏈與統計資訊，完成後也請觀察是否正確？

- iptable 指令語法 - 定義規則，針對 layer3 與 layer4 的方式

基本的語法有點像底下這樣：

```
[root@localhost ~]# iptables [-A INPUT] [-i lo|eth0|ens3] [-s IP/Netmask] [-d IP/Netmask] \
[-p tcp|udp [--sport ports] [--dport ports]] [-j ACCEPT|REJECT|DROP]
```

基本上，來源 (指的是客戶端) 通常使用 -s, --sport 來處理，目標 (指的是伺服器自己) 通常指的是 -d, --dport 就是了。

​		例題 4.3.A：依序設定好你的防火牆規則： 	

1. 讓 lo 變成一個可信任的裝置 (任何連線連接到這個網卡，就直接放行的意思)
2. 讓 icmp 封包變成可接受的封包類型
3. 讓來自 Gateway IP 的來源變成是可信任的來源
4. 讓來自內網的所有 IP 網段都成為可信任的來源
5. 讓來自 172.16.0.0/16 的區段成為可信任的 ssh 連線來源 (意思是，其他來源沒有被放行)
6. 讓你的伺服器變成 http 與 https 服務提供者 (可以分兩條規則撰寫)
7. 全部的封包通通拒絕
8. 上面的規則設定完畢後，讓你的 INPUT 規則變成 DROP，同時設定完畢之後請觀察設定是否生效了。

​		完成上述的功能之後，請思考在伺服器本機上： 	

1. ping localhost 通不通？是那條連線的問題？
2. ssh localhost 通不通？是那條連線的問題？
3. culr http://www.google.com 通不通？是那條連線的問題？
4. ping GatewayIP 通不通？是那條連線的問題？
5. ping 168.95.1.1 通不通？是那條連線的問題？
6. ping client 通不通？是那條連線的問題？
7. ssh client 通不通？是那條連線的問題？

​		完成上述的功能之後，請思考在內部 client 的用戶端機器上： 	

1. ping server 通不通？是那條連線的問題？
2. ssh server 通不通？是那條連線的問題？
3. curl http://server 通不通？是那條連線的問題？
4. curl ftp://server 通不通？是那條連線的問題？

​		完成上述的功能之後，請思考在外部與同學可以互通的網路網段上： 	

1. 『 ping 同學IP 』通不通？是那條連線的問題？
2. 『 ssh 同學IP 』通不通？是那條連線的問題？
3. 『 curl http://同學IP 』通不通？是那條連線的問題？
4. 『 curl ftp://同學IP 』通不通？是那條連線的問題？

最後，請將上述的所有指令編輯成為一個 shell script 來加以執行探討！檔名就稱為 /root/firewall.sh 好了。

- iptable 指令語法 - 針對網卡 layer2 與狀態封包的外掛模組

上個練習當中發生的最大問題，就是防火牆本身連出去的封包要回來，還得再一次進入 input 鏈去檢查！很有點麻煩！ 如果避免，就得要透過回傳的封包含有 ACK 回應旗標來處理了！使用的是狀態 (state) 模組！僅須這樣進行：

```
[root@localhost ~]# iptables [-A INPUT] [-m state] [--state RELATED,ESTABLISHED] \
[-j ACCEPT|DROP|REJECT]
```

- ESTABLISHED：已經連線成功的連線狀態；
- RELATED：這個最常用！表示這個封包是與我們主機發送出去的封包有關

如果需要使用到 layer2 的管制網路卡，則可以使用底下的方式來處理：

```
[root@localhost ~]# iptables [-A INPUT] [[-m mac] [--mac-source aa:bb:cc:dd:ee:ff]] \
[-j ACCEPT|REJECT|DROP]
```

​		例題 4.3.B：修改 /root/firewall.sh 檔案，增/刪防火牆資料如下： 	

1. 讓狀態回應規則成為在 lo 信任裝置後的規則 (超級重要的規則喔！)
2. 嘗試找到 192.168.254.200 這部機器的 MAC，並將這部機器加入成為信任來源，這個規則請寫在拒絕全部封包的前一條規則。
3. 最終讓這樣的規則儲存下來，並且重新啟動 iptables 服務，看看有沒有正常顯示出這些規則？

這就是防火牆建置的基礎功，好好練練功吧！

### 4.4： NAT 網路位址轉換表格

NAT 的全名是 Network Address Translation，字面上的意思是『網路位址的轉換』。由字面上的意思我們來想一想，  TCP/IP 的網路封包不是有 IP 位址嗎？那 IP 位址不是有來源與目的嗎？我們的 iptables 指令就能夠修改 IP 封包的表頭資料， 連目標或來源的 IP 位址都可以修改呢！甚至連 TCP 封包表頭的 port number 也能修改！真是有趣！

但是整個 NAT 要能工作，需要核心的 ip forward 有啟動才行！

​		例題 4.4.A：啟動你的 ip forward 核心功能 	

1. 先觀察 /proc/sys/net/ipv4/ip_forward 這個檔案的內容
2. 修改 /etc/sysctl.conf ，加入一行『 net.ipv4.ip_forward = 1 』
3. 使用 sysctl -p 來載入這個設定
4. 重複觀察第一步，看看有沒有順利生效？(1 是有生效， 0 是未生效)

先來看一張圖，了解一下 nat 表格在 filter 表格的相關性：

![iptables](https://dic.vbird.tw/images/iptables_04.gif)

當中的鏈意義為：

- PREROUTING：在進行路由判斷之前所要進行的規則(DNAT/REDIRECT)
- POSTROUTING：在進行路由判斷之後所要進行的規則(SNAT/MASQUERADE)
- OUTPUT：與發送出去的封包有關

那 NAT 表格要幹麻用呢？最簡單的想法，一個是 IP 分享器的功能，一個是當我把 server 架設在 LAN 裡面時， 從外面來的連線就得要透過 port mapping 才行！這時就得要 NAT 的協助了！

- SNAT：修改來源 (source)

當你想要成為 IP 分享器時，那麼所有從內部 LAN 要出去到 Internet 的封包，都要將『出去的那個 IP 改為 server 的對外 IP』， 這改的就是『來源』位址，因此稱為 SNAT！圖示如下：

![iptables](https://dic.vbird.tw/images/nat_01.png)

當封包經過 SNAT 的偽裝之後，該偽裝的資料會紀錄到記憶體當中，當從 Internet 回來後，該回應封包會透過剛剛的紀錄， 從 PREROUTING 處，就直接自動改回原本的 IP，然後再往後送這樣。如下所示：

![iptables](https://dic.vbird.tw/images/nat_02.png)

至於 SNAT 的基本語法為：

```
[root@localhost ~]# iptables -t nat -A POSTROUTING -s $innet -o $EXTIF -j MASQUERADE

[root@localhost ~]# iptables -t nat -A POSTROUTING -o ens3 -j SNAT --to-source 192.168.1.100
```

- DNAT：修改目標 (destination)

當你的 server 是架設在內網，就需要 DNAT 的協助了！

![iptables](https://dic.vbird.tw/images/nat_03.png)

假設的情況說明如下：

1. 外部主機想要連接到目的端的 WWW 服務，則必須要連接到我們的 NAT 伺服器上頭；
2. 我們的 NAT 伺服器已經設定好要分析出 port 80 的封包，所以當 NAT 伺服器接到這個封包後， 		會將目標 IP 由 public IP 改成 192.168.1.210 ，且將該封包相關資訊記錄下來，等待內部伺服器的回應；
3. 上述的封包在經過路由後，來到 private 介面處，然後透過內部的 LAN 傳送到 192.168.1.210 上頭！
4. 192.186.1.210 會回應資料給 61.xx.xx.xx ，這個回應當然會傳送到 192.168.1.2 上頭去；
5. 經過路由判斷後，來到 NAT Postrouting 的鏈，然後透過剛剛第二步驟的記錄，將來源 IP 由 192.168.1.210 改為 public IP 後，就可以傳送出去了！

至於 DNAT 的基本語法為：

```
[root@localhost ~]# iptables -t nat -A PREROUTING -i ens3 -p tcp --dport 80 \
-j DNAT --to-destination 192.168.100.10:80 

[root@localhost ~]# iptables -t nat -A PREROUTING -p tcp  --dport 80 -j REDIRECT --to-ports 8080
```

上面第一條是轉到後面的其他主機上，第二條則是透過 redirect 的方式轉到本機上面的某個埠口而已～比較簡單！

​		例題 4.4.B：建立你 server 成為 IP 分享器的 nat server 任務 	

1. 加入清除 PREROUTING, POSTROUTING 的規則功能
2. 加入你的內網進行偽裝 (MASQUERADE) 讓封包傳輸的功能
3. 執行 firewall.sh 之後，查詢是否正常？ 	

​		執行完畢之後，開始處理用戶端功能 	

1. 開啟用戶端硬碟，然後依據傳統的網路 debug 流程，確認網路終於通了！
2. 修改 yum 伺服器，使用 ksu 的 yum 伺服器作為來源
3. 全系統更新，同時在每日 3 點全系統更新

基本上，將 SNAT 設定妥當後，我們的內網就可以順利連接到 Internet 上囉！ 	

​		例題 4.4.C：讓你的區網用戶端電腦也能架設網站，修改 /root/firewall.sh，讓它可以具有如下功能： 	

1. 只要想連接到本機的 port 888 的，全部重導向到 port 80 上
2. 只要是來自外部來源 (ens3) 且想要連線到 port 8080 的，就導向到 client 那台的 port 80 上！



### 4.5： 簡易的 firewalld 服務介紹

在 RHCSA 的課程上面我們就講過 firewalld 這個防火牆的服務，這個 firewalld 在使用上比起 iptables 要簡單許多， 而且也不需要懂得許多特殊的概念，更有甚者， firewalld 已經預設建立的幾個領域 (zone) 的概念，來讓使用者挑選， 要讓那張網卡的資料加入哪個領域，該領域就有特定的預設規則，這樣就很容易設計防火牆。只是對於 NAT 的概念來說， 鳥哥自己認為，傳統的 iptables 概念還是比較清晰，用來講解封包的轉換會比較好。firewalld 太容易了！許多概念反而不容易講清楚啊！呵呵！

我們上面談到的 iptables 有幾個特色，包括：

- 有內部的信任區域網路 (LAN)，亦即在 team0 上面的連線，都算 LAN 的連線，該連線應該是可信任的，因此我們才會有該網域的設計
- 有外部網域與內部網域的設計，因此我們會有需要用到核心的 IP forward 功能，以及使用到 SNAT 或 DNAT 的功能規則
- 可能有不信任的網域，因此，可將該網域整個拒絕 (block) 掉。

要完成上面的功能，我們都是透過修改 /root/firewall.sh 來處理，如果是 firewalld 的話，他可以設計規定某些網卡帶入哪個領域， 就可以直接達成上述的功能！很簡單！預設 firewalld 會有底下的幾個領域，提供預設的規則給管理員選擇：

```
[root@localhost ~]# firewall-cmd --get-zones
block dmz drop external home internal public trusted work
```

firewalld 提供上述的領域，上述的領域大致的說明是這樣的：

- drop (丟棄領域)：最低信任的領域，加入此領域的網路卡，其預設的連線封包進入政策為 DROP，只有對外 (OUTPUT 鏈) 為放行。
- block (攔阻領域)：與 drop 領域類似，但是將預設政策改為 REJECT，所以會回應用戶拒絕連線。
- public (公開領域)：是 firewalld 預設的領域，為不信任領域政策，在 Internet 上面比較常使用這種領域， 		你無法信任所有的連線，但是，可能因為伺服器的需要，因此需要放行某些服務之意。
- external (外部領域)：如果有使用到 NAT 的機制，而且該網卡在 NAT 機制為對外 (亦即我們上面的介紹中，屬於 ens3 那個界面的意思) 時， 		就可以使用 external 領域的意思。任何經過 external 的網卡往外的封包，基本上都預設會被偽裝 (masquerade)
- internal (內部領域)：跟 external 搭配，在 NAT 的機制中，屬於內部網路的那一邊 (亦即我們使用的 team0 那個網卡與網域界面)， 		大部分的連線是可信任的。
- dmz (非軍事區)：主要放置需要被隔離的重要系統，這些系統基本上是不能被一般用戶直接存取的，只有特殊的人員能夠存取這些領域的電腦。 		因為系統放在這裡主要是需要被隔離的區域，因此就稱為非軍事區 (所以管制最嚴格)
- work (工作領域)：用來上班工作用的電腦，等於是辦公室裡面的桌機那樣的概念，所以旁邊都是同事，因此大部分的連線是可信任的， 		而且可能還需要額外放行某些服務就是了。
- home (家用領域)：等於放在家裡的桌機，那大部分家裡的連線都放行，因此也是屬於可信任度比較高的領域。
- trusted (可信任領域)：任何連線到此領域的連線都放行！

如果你需要知道某個領域預設的規則，例如你想要知道 trusted, block 與 work 這三個領域的規則時，可以這樣查閱：

```
[root@localhost ~]# firewall-cmd --info-zone=trusted
trusted
  target: ACCEPT
  icmp-block-inversion: no
  interfaces:
  sources:
  services:
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:

[root@localhost ~]# firewall-cmd --info-zone=block
block
  target: %%REJECT%%
  icmp-block-inversion: no
.....

[root@localhost ~]# firewall-cmd --info-zone=work
work
  target: default
  icmp-block-inversion: no
.....
```

很明顯可以看到目標策略的差異！那目前我們使用的是那一個領域？而該領域的規則目前為何呢？可以這樣做：

```
[root@localhost ~]# firewall-cmd --get-default-zone
public

[root@localhost ~]# firewall-cmd --get-active-zones
public
  interfaces: ens3

[root@localhost ~]# firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: ens3
  sources:
  services: cockpit dhcpv6-client ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

因為我們的用戶端該是屬於工作場所的領域，所以推薦可以使用 work 這個領域，現在，請將動作中的領域改為 work，且觀察其規則項目：

```
[root@localhost ~]# firewall-cmd --set-default-zone=work

[root@localhost ~]# firewall-cmd --get-active-zones
work
  interfaces: ens3

[root@localhost ~]# firewall-cmd --list-all
work (active)
  target: default
  icmp-block-inversion: no
  interfaces: ens3
  sources:
  services: cockpit dhcpv6-client ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

基本上，跟 public 領域規則不會差太多，只是方便我們管理而已。現在，我們需要加入信任領域，就是內部網路那張卡的領域！ 同時加入 http 的服務連線需求，因此你需要透過『 man firewalld.richlanguage 』去找到 Example 6 那個項目，就知道如何設計了。 至於一般設定 firewalld 時，建議直接使用 --permanent 將設定加入設定檔之後，再以 --reload 載入較佳。例如，要加入 NTP 網路校時協定時， 可以這樣做：

```
[root@localhost ~]# firewall-cmd --permanent --add-service=ntp

[root@localhost ~]# firewall-cmd --reload

[root@localhost ~]# firewall-cmd --list-services
cockpit dhcpv6-client ntp ssh
```

​		例題 4.5.A：讓你的 client 端使用 firewalld 防火牆機制 	

1. 切換活動領域到 work 這個領域當中，並將該領域的規則進行部份修改： 		
   - 增加 http 服務的連線需求
   - 以 rich rule 的功能，放行內部網路 (10..../24) 成為信任網域的連線 (看 man page 來設計)
   - 上述資料加入時，最好直接加入設定檔，然後再以 firewall-cmd --reload 來重新載入較佳。
2. 安裝 httpd 服務，同時到 /var/www/html 建立 index.html 檔案，內容為『 I amd client.lan*.dic.ksu 』
3. 使用類似 curl http://localhost 看看 WWW 服務是否正常？

​		接下來詢問你的朋友群，或告知你的朋友群，讓他們在他們的用戶端電腦上面執行類似 curl http://192.168.254.*:8080/ ，能不能看到你用戶端的顯示？ 



### 4.6： 課後練習

1. (50%)實作題：啟動 Server 作業硬碟 - unit04	

   1. 網路參數的設定，請依據底下的方式來設定好你的網路環境： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 為外部的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.18.255.*/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.18.255.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 使用 teamd 的機制建立內部區域網路的備援功能： 		

         - team 的界面使用 team0 卡號，且連線名稱請命名為 team0
         - team 使用 activebackup 備援功能，不要使用 loadbalance
         - team 的實體網卡 (team slave) 請使用 ens7 及 ens8 ，且其連線名稱名稱亦請命名為 ens7, ens8
         - team0 網路參數為： 172.19.*.254/24，不需要 gateway 

      4. 主機名稱指定為： server*.example.dic

      5. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 基本的伺服器作業系統設定行為： 	

      1. 使用崑山的 FTP 網站作為你的 YUM server 來源，來源倉儲至少需要涵蓋 BaseOS, AppStream, extras, PowerTools 等， 		並且清除一次 yum 清單快取。(請注意，由於最終系統會全系統升級一次，升級後，這些設定檔可能會被更新。 		因此，你在全部升級完畢之後，還需要回來修改這個設定檔喔！)
      2. 安裝相關的軟體，至少須安裝 vim-enhanced, bash-completion, net-tools, mailx, wget, links, bind-utils,  		kernel-tools, kernel-modules (某些軟體可能需要使用 PowerTools 軟體倉儲安裝喔！但是該軟體倉儲預設需要是不啟用 
      3. 全系統自動升級，且每天凌晨 3 點也會自動升級一次。(請寫入 /etc/crontab 為主)
      4. 將 SELinux 修改成為 Enforcing 模式，且未來每次開機都自動為 Enforcing 才行

   3. 實際設定好本機防火牆 

      1. 請關閉 firewalld 服務，並且自行安裝、啟動 iptables 服務
      2. 將預設的規則轉存到 /root/firewall.sh 這個檔案內
      3. 首先將全部的規則刪除 (應該有三條指令)
      4. 設定好預設政策，讓 INPUT 成為 DROP 而 OUTPUT 與 FORWARD 成為 ACCEPT
      5. 針對 INPUT 前三條規則為 (1)回應封包 (2)放行 lo 界面 (3)放行 icmp 封包
      6. 放行你自己的內部區域網路那個網域的連線要求 (針對 LAN 的信任設定)
      7. 讓 ssh 只對外部的區網放行，不會對 Internet 放行 (對 ssh 連線做限制較佳)
      8. 讓 http 針對整個 Internet 放行 (一般公開的服務設計)
      9. 最後讓確定的規則轉存到 /etc/sysconfig/iptables 這個設定檔
      10. 重新啟動 iptables 服務，然後觀察規則是否正確

   4. 實際設定好 Server 的路由功能 

      1. 讓核心支援 IP 轉遞的功能，並且每次重新開機都可以自動生效
      2. 修改 /root/firewall.sh ，在該檔案加入清除 nat 表格的規則與自訂鏈的設定
      3. 增加規則：讓來自內部網路的封包，在路由判斷後，並預計由 ens3 對外網卡出去的封包，全部偽裝成為 ens3 的 IP 位址 	 (一般在數據機上面的就是 public IP)
      4. 在 /etc/sysconfig/iptables-config 當中增加 nf_nat_ftp 及 nf_conntrack_ftp 模組功能
      5. 上述功能在開機後依舊能夠順利啟動

   5. 針對 NAT 的設定行為： 	

      1. 將由 ens3 進入的封包，若要連線到本機 port 2323 時，重新導向到本機的 port 22 上。所以，當用戶端執行 ssh -p 2323 root@your_server_ip 		時，確實可以使用 ssh 服務。
      2. 讓由 ens3 進入的封包，想要連線到本機 port 888 時，重新導向到 172.19.*.1 的 port 80 上面去。

2. (20%)實作題：啟動 client 作業硬碟 

   1. 網路參數的設定，請依據底下的方式來設定好： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.19.*.1/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.19.*.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 主機名稱指定為： client.lan*.example.dic

      4. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 實際設定好本機防火牆 

      1. 預設請使用 firewalld 防火牆服務，不要使用 iptables 服務！
      2. 請將預設的領域 (zone) 改為 work 領域
      3. 預計放行的服務主要有 ssh 與 http 兩個服務，其他還可能有預設會啟用的 dhcp 用戶端服務。
      4. 查詢 rich rule (man firewalld.richlanguage)，確認來自本機同一個 LAN 網段的封包，通通給予放行。
      5. 上述放行的防火牆服務，在下次重新開機後，依舊會存在才行

   3. 啟動內部服務 	

      1. 安裝名為 httpd 的軟體，同時設定啟動、開機啟動 httpd 這個服處等任務
      2. 撰寫 /var/www/html/index.html 的檔案，內容只須兩行，你的姓名與學號即可。

3. (30%)簡易問答題： 	從具有 GUI 及中文的用戶端 Linux ，使用『 ssh root@172.19.*.254 』登入你的 Server ，之後建立 /root/ans.txt 的檔案，並將底下各題目的答案寫入你 server 當中！ 

   1. 一般所謂的防火牆，依據達成方式的不同，主要分為那兩種基本的防火牆？
   2. CentOS 8 預設提供那兩種『防火牆服務』呢？
   3. 承上，那達成該種防火牆服務的指令又個別為何呢？
   4. CentOS 8 防火牆使用 Netfilter ，該機制提供的預設表格中，上課用到的是那兩個？個別針對哪種主機 (本機或後端主機) 來進行封包的過濾與重導向？
   5. 針對 Linux 本機的封包進出來說， Netfilter 主要提供的是那一個表格 (table) 的那兩個鏈 (chain) 來管理的？
   6. 那一個指令可以觀察 Netfilter 的預設政策、各鏈的流向與防火牆的規則順序？
   7. 承上，那一個檔案主要就是在紀錄這些設定的？
   8. 針對 ssh 來說，底下的錯誤要怎麼改善？寫下改善後的語法：
       	iptables -A INPUT -s 192.168.0.0/16 --dport 22 -j ACCEPT
   9. 在 iptables 的動作中， REJECT 與 DROP 有什麼差別？
   10. 啟動核心的 IP 轉遞功能時，(1)需要修改哪個設定檔？ (2)實際上變更的是那一個核心檔案的值？
   11. 所謂的 IP 分享器的 IP 偽裝功能，只要是修改那一個 Netfilter 的表格與鏈？
   12. 所謂的 port mapping 的功能，主要是修改那一個 Netfilter 的表格與鏈？
   13. 承上面兩題，哪個被稱為 SNAT 或 DNAT 呢？

4. 上傳成績 

   1. 請將 Server/Client 的硬碟通通啟動，並且確認兩者間的連線沒有問題；
   2. 在 Server 硬碟上面登入，然後用 root 的身份執行 vbird_server_check_unit ，並依據提示資料填寫你的學號與 IP 尾數
   3. 該程式會偵測你的系統，並且通知你哪個部份可能有問題，你需要持續觀察或者重新處理的部份會交代妥當。
   4. 若一切沒問題，螢幕就會出現如下的字樣，然後你就能夠使用 links 去檢查你的檔案是否有順利的上傳了！
   5. Please use links http://172.18.255.250/upload/unit04 to check your filename

------

- 2020/10/14：修改成為 CentOS8 的版本，並且加入了比較多的 firewalld 機制介紹。

## 區域網路的 DHCP server 建置

###### 上次更新日期 2020/10/21

上節課程雖然已經完成了防火牆的功能，同時也將 NAT 的 IP 分享器環境設定妥當。不過，等等！如果只有一兩部 client， 我們手動去設定好 IP 還沒啥，如果像電腦教室內有這麼多電腦，難道要一台一台去設定？這時得要架設 DHCP 才行。 還是不對！我們上課的環境裡面只有一個獨立的內部區網，所有的同學都在同一個區網內，那 DHCP 會互相干擾耶！ 這怎辦？這時可能得要玩一玩 VLAN 的設定才行！那，如果區網內的 client 要溝通時，該怎辦呢？ 這時，恐怕就得要透過路由功能來處理比較妥當喔！

學習目標

- 了解 VLAN 主要運用在 switch 上，但是 Linux 網卡可以模擬
- 學會以 VLAN 設計自己的 server/client 網路對接
- 學會 DHCP server 的實做，並設計、管理自己的區域網路規劃
- 了解並實際設定額外的路由規劃

- 5.1： 什麼是 VLAN 與達成方式
- 5.2： 區網的網路參數自動取得 DHCP 服務設定
- 5.3： 內部私有網域的路由設定(再講到 routing 的互傳概念！)
- 5.4： 課後練習

### 5.1： 什麼是 VLAN 與達成方式

在所謂的星形連線方式中，只要是串接在同一個 switch 上面的所有電腦，在實體上面就是串接在一起，沒辦法隔離的！ 也就是所謂的實體區域網路連接的狀態。不過，許多時刻，我們可能需要對不同電腦進行隔離，否則許多封包的傳遞可能會有問題。 但是我們只有一個 switch 可以達到實體分離的狀態嘛？可以的～那就是透過所謂的虛擬區域網路 (virtual local area network, VLAN)。

VLAN 最簡單的想法，就是在一部 switch 裡面，將許多不同的埠口規劃成同一區，非在同一區的其他埠口，就無法讓封包流進這一區。 舉例來說，一部 12 port 的 switch ，將 1~6 劃分成為一個 vlan id 2，另外的 7~12 保留原本的 vlan id 1 設定，那在邏輯的思考上面， 這個 swith 已經被隔離成為兩個區塊，你可以將 1~6 埠口想成是 swtich 1 而 7~12 埠口則為 switch 0，這兩個邏輯的 swtich  裡面的封包是無法互相傳遞的！

這個 vlan 的功能對於只有一個共同實體連線，但是卻想要切割出不同區域網路，且不同 LAN 彼此間不互相干擾的情況時， 就顯的非常的有幫助！舉例來說，我們的上課環境中，大家在虛擬電腦教室系統裡面僅有一個獨立的區網， 所有同學都在此區網裡面使用網路，此時如果我們需要架設類似 DHCP 的服務時，彼此之間就容易產生競爭與干擾。 若能使用 VLAN 技術，每個使用者都有自己的一個虛擬網路，則彼此之間就可以不互相干擾， 此時要架設相關服務就顯的簡單了！畢竟不會被干擾啊！

- VLAN 的 ID 識別碼

其實，基本上，預設的所有網路封包都是在一個 ID 為 1 號的 VLAN 環境下，所以大家都是能夠透過廣播 (broadcast) 來互通訊息的同一 VLAN 內。 因此，如果想要讓你的 VLAN 與原本的網路隔離開來，就給你的網路一個 VLAN 不為 1 的 ID 即可！這樣就能夠讓你的網路隔離開來了。 因此，等一下的實際設定中，同學們需要定義出自己的 VLAN ID 號碼，且不能重複，否則就會互相干擾啊！

- CentOS 8 的 VLAN 設定

其實我們的 Linux 可以直接透過網路卡來做 VLAN 的封包表頭喔！你需要做的是：

1. 選擇一個實體網卡界面，並且選擇一個 VLAN 的 ID 號碼 (不可以是 1 號)
2. 透過 nmcli 的指令，實做一個名為 vlanXXX 的網卡，且這個 VLAN 網卡使用上面談到的那個實體網卡界面
3. 給予這個 vlanXXX 的連線名稱實際的 IP 位址與網路參數即可。
4. (optional) 有可能因為 VLAN 包太多層，導致 MTU (最大傳輸單位) 無法拆解的問題。所以，建議可以降低 MTU，從標準的 1500 降低到 1400 左右即可。

就這麼簡單！

​		例題 5.1.A：讓你的 team0 變成一個 vlan 的實體網卡，然後建立一個名為 vlanXX 的 VLAN 網卡，且 ID 就是 XX，其中 XX 為你的 IP 尾數。 	

1. 預處理：因為 team0 即將變成 vlan 的實體網卡，因此， team0 的網路參數應該要全部取消才對。 		所以，你需要 (1)先關閉 team0 ； (2)讓 team0 的網路參數設定取消，因此 ipv4.method 設定為 disable 以及 ipv6.method 設定為 link-local ， 		在設定的同時，你可能需要取消其他網路參數，例如加上 ipv4.addresses '' 來將其他有用的參數取消才行
2. 先想好，你的網卡類型為 vlan (type vlane) ，你的連線名稱為 vlanXX (con-name)，你的網卡名稱為 vlanXX (ifname vlanXX)，你的裝置為  		team0 (dev team0)，你的 vlan id 為 XX ( id XX)
3. 將上述的資料以： nmcli connection add ... 加入，最終會產生一個名為 vlanXX 的連線界面與網卡
4. 讓 vlanXX 的 IP 來接管原本 team0 的設定！包括 IPv6 及 IPv4
5. 讓 MTU 設定為 1400 左右 (802-3-ethernet.mtu 1400)
6. 最後記得啟動 vlanXX 喔！此時使用 ip addr show 或 ifconfig，就會看到 vlanXX 的網卡。

完成了上述的設定後，你的 server IP 並沒有改變，依舊具有 192.168.254.*/24 以及 10.255.*.254/24 這兩個網路參數， 不過，在 client 端卻無法 ping 到 10.255.*.254 這個 IP 了！這是因為 server 與 client 的 vlan 已經在不同的網段之故。 所以，接下來你得要開始修改 client 的網路卡設定才行！

​		例題 5.1.B：讓你的 client 加入 vlanXX 的虛擬區域網路 ID 號碼內。 	

1. 預處理：跟剛剛 team0 的取消類似，你可以透過 nmcli connection modify ens3 ipv4.method disable ipv4.dns "" ipv4.gateway "" 		ipv4.addresses "" 來取消所有的網路設定項目。(注意， ipv6 也要同步處理)
2. 先想好，你的網卡類型為 vlan (type vlane) ，你的網路連線名稱為 vlanXX (con-name vlanXX)，網卡名稱為 vlanXX ( ifname vlanXX)， 		你的裝置為 ens3 (dev ens3)，你的 vlan id 為 XX ( id XX)
3. 將上述的資料以： nmcli connection add ... 加入，最終會產生一個名為 vlanXX 的連線界面與網卡
4. 讓 vlanXX 的 IP 來接管原本 ens3 的設定！包括 IPv6 及 IPv4
5. 讓 MTU 設定為 1400 左右 (802-3-ethernet.mtu 1400)
6. 最後記得啟動 vlanXX 以及 ens3，這樣就可以使用 ip addr show 以及 ifconfig 來看到 vlanXX 這張網卡了！ 

你的 client 也完成如上的設定之後，此時你的 server 與 client 之間的對答只有你們自己可以取得，除非別人也使用跟你的 vlan 相同的 id， 否則，看到你的封包，應該都是直接丟棄的喔！

### 5.2： 區網的網路參數自動取得 DHCP 服務設定

如果區域網路裡面有超過 5 台以上的電腦，你要怎麼設定好每一台電腦的網路？每一台電腦都手動去設定嘛？ 有沒有這麼麻煩？若讓每部電腦都自動取得 IP 的話，那不是很好嘛？就像現在一般無線網路基地台的功能， 每台手機只要連上無線 wifi AP 就可以自動取得網路參數，這才是正解吧？那這是什麼服務呢？即時就是動態主機設定服務 (Dynamic Host Configuration Protocol, DHCP)。 說穿了，就是自動發派 IP 與相關網路參數給各用戶端電腦的服務。

DHCP 服務的 Server 與 client 端的連線如下所示：

![DHCP](https://dic.vbird.tw/images/dhcp_protocol.gif)

基本上，用戶端的網路取得流程為：

1. 用戶端：利用廣播封包發送搜索 DHCP 伺服器的封包
2. 伺服器端：提供用戶端網路相關的租約以供選擇 (主要透過用戶端 MAC 位址來判斷喔！)
3. 用戶端：決定選擇的 DHCP 伺服器提供的網路參數租約並回報伺服器：
4. 伺服器端：記錄該次租約行為並回報用戶端已確認的回應封包資訊：

要注意的是，如果區域網路裡面有多部 DHCP 伺服器的話，那麼用戶端會用先回應的那一部 DHCP 伺服器所提供的網路參數為主， 所以，最好區域網路內不要有兩部以上的 DHCP 服務，否則容易產生干擾的狀態喔！

- 固定 IP 與動態給予 IP 的模式：

DHCP 伺服器會依據設定來給予某些主機固定的 IP 喔！透過的方式就是依據用戶端的 MAC 位址來處理的。當用戶端電腦使用自動取得 IP 來探索區域網路內的 DHCP 服務時， 一般來說，你的 DHCP 會做這些動作：

1. 到伺服器的登錄檔中尋找該用戶之前是否曾經用過某個 IP ，若有且該 IP 目前無人使用，則提供此 IP 給用戶端；
2. 若設定檔針對該 MAC 提供額外的固定 IP (static IP) 時，則提供該固定 IP 給用戶端；
3. 若不符合上述兩個條件，則隨機取用目前沒有被使用的 IP 參數給用戶端，並記錄下來。

也就是說，如果你想要讓某部主機永遠取得固定的 IP 時，可以透過取得該主機的網卡卡號，再修改 DHCP 伺服器的設定檔， 讓該網卡 (MAC address) 提供固定的 IP 即可喔！

- DHCP 服務的安裝、設定、啟動與觀察

DHCP 主要的服務軟體名稱為 dhcp-server 這個軟體，相關的檔案主要為：

- /etc/dhcp/dhcpd.conf 主設定檔
- /usr/share/doc/dhcp-server/dhcpd.conf.example 範例檔
- /var/lib/dhcpd/dhcpd.leases 用戶端租約檔
- systemctl [start|enable|stop|status] dhcpd

現在針對我們的伺服器內網 (10.255.*.0/24 那一個網段) 來設定 dhcp 伺服器的行為時，我們預計動態分配從 10.255.*.101~10.255.*.199 為動態取得 IP 的區段， 而 10.255.*.200 之後的區段保留給未來其他需要的內部服務使用，至於 10.255.*.1~10.255.*.100 則保留給固定的某些主機對應使用。 那麼簡單的設定檔就可以寫成如下的模樣： (鳥哥以 * 為 200 來設計如下的樣式！請將下列的 200 改成你的 IP 尾數即可。)

```
[root@localhost ~]# yum install dhcp-server
[root@localhost ~]# vim /etc/dhcp/dhcpd.conf
ddns-update-style       none;
default-lease-time      600;       # 預設的租約時間
max-lease-time          7200;      # 最大的租約時間
option routers          10.255.200.254;
option domain-name      "lan200.dic.ksu";
option domain-name-servers 120.114.100.1, 168.95.1.1;

subnet 10.255.200.0 netmask 255.255.255.0 {
        range 10.255.200.101 10.255.200.199;

}

[root@localhost ~]# systemctl start dhcpd
[root@localhost ~]# systemctl enable dhcpd
[root@localhost ~]# systemctl status dhcpd
● dhcpd.service - DHCPv4 Server Daemon
   Loaded: loaded (/usr/lib/systemd/system/dhcpd.service; enabled; vendor preset: disabled)
   Active: active (running) since 六 2017-09-23 23:55:32 CST; 8s ago
     Docs: man:dhcpd(8)
           man:dhcpd.conf(5)
 Main PID: 8531 (dhcpd)
   Status: "Dispatching packets..."
   CGroup: /system.slice/dhcpd.service
           └─8531 /usr/sbin/dhcpd -f -cf /etc/dhcp/dhcpd.conf -user dhcpd -group dhcpd --no-pid

[root@localhost ~]# vim /var/log/messages
Sep 23 23:55:31 pc200 systemd: Starting DHCPv4 Server Daemon...
Sep 23 23:55:32 pc200 dhcpd: Internet Systems Consortium DHCP Server 4.2.5
Sep 23 23:55:32 pc200 dhcpd: Copyright 2004-2013 Internet Systems Consortium.
Sep 23 23:55:32 pc200 dhcpd: All rights reserved.
Sep 23 23:55:32 pc200 dhcpd: For info, please visit https://www.isc.org/software/dhcp/
Sep 23 23:55:32 pc200 dhcpd: Wrote 0 leases to leases file.
Sep 23 23:55:32 pc200 dhcpd: Listening on LPF/vlan200/6e:01:19:f2:60:34/10.255.200.0/24
Sep 23 23:55:32 pc200 dhcpd: Sending on   LPF/vlan200/6e:01:19:f2:60:34/10.255.200.0/24
```

因為紀錄的資訊的關係，因此你從 systemctl status dhcpd 裡頭看不到實際的 dhcp 生效的狀態，所以請到 /var/log/messages 裡頭去看看， 要確認出現如上的特殊字體部份，這才確認 server 是順利的在正確的網卡上面生效的！ 我們這裡的正確網卡指的是 vlan200 那一張喔！要注意！

- 防火牆的設定

如果要針對用戶端來放行 dhcp 的要求，那麼就得要提供 udp port 67 的放行功能！因此，請修改 /root/firewall.sh 的內容， 加上 dhcp 的協力功能！

```
[root@localhost ~]# vim /root/firewall.sh
iptables -A INPUT -p udp --dport 67 -i vlan200 -j ACCEPT

[root@localhost ~]# sh /root/firewall.sh
```

- 用戶端的自動取得 IP

轉到 client 端的設定上，只要指定 ipv4.method 為 auto 之後，重新啟動網卡即可！

```
[root@localhost ~]# nmcli connection show
NAME     UUID                                  TYPE            DEVICE
ense     ba8b05ee-2e76-4a44-a341-cd50874aa49b  802-3-ethernet  ens3
vlan200  849f2c14-b52f-4817-8cea-db69502160cc  vlan            ens3.200

[root@localhost ~]# nmcli connection modify vlan200 ipv4.method auto
[root@localhost ~]# nmcli connection up vlan200
```

這時 ifconfig 就會看到 ens3.200 這張網卡上面的 IP 已經改為 10.255.200.101 囉！接下來，來到 server 端，查看一下租約檔案， 這個檔案的內容就會有點像這樣：

```
[root@localhost ~]# cat /var/lib/dhcpd/dhcpd.leases
# The format of this file is documented in the dhcpd.leases(5) manual page.
# This lease file was written by isc-dhcp-4.2.5

server-duid "\000\001\000\001!Y@tn\001\031\362`4";

lease 10.255.200.101 {
  starts 6 2017/09/23 16:17:27;
  ends 6 2017/09/23 16:27:27;
  cltt 6 2017/09/23 16:17:27;
  binding state active;
  next binding state free;
  rewind binding state free;
  hardware ethernet 52:54:00:41:49:77;
}
```

這就是 MAC address 搭配 IP 的設定紀錄資料。

- 設定取得固定 IP 的方案

我們的 client IP 尾數會變成 101 啊！這不是我們要的！所以，請查詢到 client 的 MAC address 之後，將它設定成為固定的 IP 位址才好！

```
[root@localhost ~]# vim /etc/dhcp/dhcpd.conf
ddns-update-style       none;
default-lease-time      600;       # 預設的租約時間
max-lease-time          7200;      # 最大的租約時間
option routers          10.255.200.254;
option domain-name      "lan200.dic.ksu";
option domain-name-servers 120.114.100.1, 168.95.1.1;

subnet 10.255.200.0 netmask 255.255.255.0 {
        range 10.255.200.101 10.255.200.199;

        host client {
                hardware ethernet 52:54:00:41:49:77;
                fixed-address 10.255.200.1;
        }
}

[root@localhost ~]# systemctl restart dhcpd
```

接下來，只要回到 client 端，重新執行『 nmcli connection up vlan200 』，這樣就可以更新到正確的 IP 囉！ 也同樣記得回到 server 去看一下 /var/lib/dhcp/dhcpd.leases 的檔案紀錄喔！

​		例題 5.2.A：完成底下的設定與觀察 	

1. 假設有一張網卡 mac address 為 52:54:00:11:11:11 ，這張網卡預計要給予 10.255.*.51 的 IP 位址， 		該如何設定與重新啟動 dhcpd 服務？
2. 重新啟動 dhcpd 後，觀察 /var/log/messages 裡面與 dhcp 有關的訊息，為何會有一堆『 No subnet declaration for ens3 . 』的訊息？ 		那代表什麼意思？
3. 前往 client，透過 nmcli connection show vlan200 之類的指令，查看一下最後面出現的訊息，有關 DHCP option 的訊息， 		嘗試解析這些訊息的意義為何？

由於我們在前一小節 (5.1) 已經設定好了 vlan 了，因此這個 dhcp 的服務會讓大家的網路都是在分離的狀態下運作的， 因此並不會互相干擾的喔！這樣運作就方便多了！連在這個測試環境中，我們也不需要關閉 DHCP 服務囉！從這裡我們也能知道， 如果某些比較重要的場合，我們透過 vlan 來設定，也能夠避免很多被偷聽或被攻擊的問題呢！衍生出來的資安保護，倒是挺不錯的概念。 只是， vlan 真的只能在區網內啊！

### 5.3： 內部私有網域的路由設定(再講到 routing 的互傳概念！)

現在來想一想，目前我們訓練機的環境中，就是一個稍微龐大一點點的企業私有網路環境，每位同學都是一個單位部門的 IT 管理人員， 所以我們會有一個外部的區網 (192.168.254.0/24)，以及好多個子網路 (10.255.*.0/24)，那麼來想一想， 能不能讓 10.255.100.1 可以直接連線到 10.255.200.1 呢？這兩個都是子網路喔！

直覺上，這兩個子網路要連線，好像可以吧？不就是已經所有的線路都接在一起嘛？不過，實際上『預設』卻是不可行的！ 這是因為路由的問題！先來看看下面這張圖的連結狀況：

![DHCP](https://dic.vbird.tw/images/centos6_router_dynamic.jpg)

在只有目前的 NAT 設定情況下，每一部路由器都只記得自己下一層與自己上一層的路由，隔壁層與下下層的路由就沒有注意到了！ 因此，當封包由 PCZ2 的 10.255.200.1 傳出來，目的地想要跑去 PCZ1 的 10.255.100.1 時，封包的傳遞方向是這樣的：

1. 先傳送到 Router Z2，亦即 10.255.200.254 這個 IP
2. 經過 Z2 的路由判斷，最終交給 192.168.254.254
3. 經過 192.168.254.254 的路由判斷，因為沒有設定 10.255.100.254 的目的第位置，因此交給這部主機的 Gateway， 		然後就傳出去給 GW 了！
4. 其他的 GW 當然就更不知道封包該怎麼傳，然後又是 private 封包，所以該封包就直接被 drop 掉了！

瞧，這封包連 router Z1 那部 192.168.254.100 都還不知道在哪裡呢！真是傷腦筋！其實，最好解決的方案，是直接在 192.168.254.254 那部 router 上面動手腳，讓它記得每一個子網路的路由是那一層 Router 所管理即可。不過該 router 你可能沒辦法動 (例如計中的環境， 我們是無法動手的！)，此時只好讓自己的 router 知道彼此的目的在哪裡即可。也就是說：

- 讓 Router Z2 知道 10.255.100.0/24 要交由 192.168.254.100 管理
- 讓 Router Z1 知道 10.255.200.0/24 要交由 192.168.254.200 管理

這樣就搞定了！因為如此一來，當封包由 10.255.200.1 傳出來而要交給 10.255.100.1 的時候，就會透過 Router Z2 再到 Router Z1 然後給 PC Z1， 回應的封包也能夠經由 Router Z1 回傳給 Router Z2 再回給 PC Z2 了！真的要很注意，不能單純的設定 Router Z1 或 Router Z2 而已， 這兩者之間得要互相搭配才行！那該如何設定呢？很簡單！透過 nmcli 裡面的 ipv4.routes 處理即可。設定很簡單，這樣做看看：

```
[root@localhost ~]# nmcli connection modify ens3 +ipv4.routes '10.255.100.0/24 192.168.254.100'
[root@localhost ~]# nmcli connection show ens3 | grep ipv4.routes
ipv4.routes:                            { ip = 10.255.100.0/24, nh = 192.168.254.100 }

[root@localhost ~]# nmcli connnection up ens3
[root@localhost ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.254.254 0.0.0.0         UG    103    0        0 ens3
10.255.100.0    192.168.254.100 255.255.255.0   UG    103    0        0 ens3
10.255.200.0    0.0.0.0         255.255.255.0   U     400    0        0 vlan200
192.168.254.0   0.0.0.0         255.255.255.0   U     103    0        0 ens3
```

同理，你也得在另一台 Router Z1 上面反向設定回來！兩邊都做好之後，PC Z1 與 PC Z2 就可以隨意互相傳遞資料了！所以， 一切的一切，都是路由的設定啦！

此外，由於我們在之前已經設定過 IP 偽裝的功能，因此從 ens3 出去的封包都會被偽裝成 ens3 的 IP。這對於純粹用於內部的 Server 恐怕會出問題。 因此，你應該要將內部的網段加入 firewall.sh 裡面，且放在偽裝的那行條件之前，使用 ACCEPT 即可放行。

```
iptables -t nat -A POSTROUTING -d 10.0.0.0/8 -o ens3 -j ACCEPT
```

若內部網路通過這行規則，就不會去使用到後續的 IP 偽裝的規則了！

### 5.4： 課後練習

1. (68%)實作題：啟動 Server 作業硬碟 - unit05	

   1. 網路參數的設定，請依據底下的方式來設定好你的網路環境： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 為外部的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.18.255.*/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.18.255.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 使用 teamd 的機制建立內部區域網路的備援功能： 		

         - team 的界面使用 team0 卡號，且連線名稱請命名為 team0
         - team 使用 activebackup 備援功能，不要使用 loadbalance
         - team 的實體網卡 (team slave) 請使用 ens7 及 ens8 ，且其連線名稱名稱亦請命名為 ens7, ens8
         - team0 網路參數為： 172.19.*.254/24，不需要 gateway 

      4. 主機名稱指定為： server*.example.dic

      5. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 基本的伺服器作業系統設定行為： 	

      1. 使用崑山的 FTP 網站作為你的 YUM server 來源，來源倉儲至少需要涵蓋 BaseOS, AppStream, extras, PowerTools 等， 		並且清除一次 yum 清單快取。(請注意，由於最終系統會全系統升級一次，升級後，這些設定檔可能會被更新。 		因此，你在全部升級完畢之後，還需要回來修改這個設定檔喔！)
      2. 安裝相關的軟體，至少須安裝 vim-enhanced, bash-completion, net-tools, mailx, wget, links, bind-utils,  		kernel-tools, kernel-modules (某些軟體可能需要使用 PowerTools 軟體倉儲安裝喔！但是該軟體倉儲預設需要是不啟用 
      3. 全系統自動升級，且每天凌晨 3 點也會自動升級一次。(請寫入 /etc/crontab 為主)
      4. 將 SELinux 修改成為 Enforcing 模式，且未來每次開機都自動為 Enforcing 才行

   3. 實際設定好本機防火牆 

      1. 請關閉 firewalld 服務，並且自行安裝、啟動 iptables 服務
      2. 將預設的規則轉存到 /root/firewall.sh 這個檔案內
      3. 首先將全部的規則刪除 (應該有三條指令)
      4. 設定好預設政策，讓 INPUT 成為 DROP 而 OUTPUT 與 FORWARD 成為 ACCEPT
      5. 針對 INPUT 前三條規則為 (1)回應封包 (2)放行 lo 界面 (3)放行 icmp 封包
      6. 放行你自己的內部區域網路那個網域的連線要求 (針對 LAN 的信任設定)
      7. 讓 ssh 只對外部的區網放行，不會對 Internet 放行 (對 ssh 連線做限制較佳)
      8. 讓 http 針對整個 Internet 放行 (一般公開的服務設計)
      9. 最後讓確定的規則轉存到 /etc/sysconfig/iptables 這個設定檔
      10. 重新啟動 iptables 服務，然後觀察規則是否正確

   4. 實際設定好 Server 的路由功能 

      1. 讓核心支援 IP 轉遞的功能，並且每次重新開機都可以自動生效
      2. 修改 /root/firewall.sh ，在該檔案加入清除 nat 表格的規則與自訂鏈的設定
      3. 增加規則：讓來自內部網路的封包，在路由判斷後，並預計由 ens3 對外網卡出去的封包，全部偽裝成為 ens3 的 IP 位址 	 (一般在數據機上面的就是 public IP)
      4. 在 /etc/sysconfig/iptables-config 當中增加 nf_nat_ftp 及 nf_conntrack_ftp 模組功能
      5. 上述功能在開機後依舊能夠順利啟動

   5. 內部私有 VLAN 的設定 	

      1. 先取消 team0 的網路設定 (取消 IP 等參數的設定值)
      2. 指定一個名為 vlanXX 的 VLAN 環境，其中 XX 為 VLAN ID，該 ID 為你的 IP 尾數，且該 VLAN 使用 team0 作為實體網卡， 		且使用 vlan 的網卡名稱同樣取名為 vlanXX。
      3. 使用 MTU 設定為 1400 
      4. vlanXX 的網路參數使用原本設定於 team0 上面的網路參數。

   6. DHCP 伺服器的設定 	

      1. 以 vlanXX 的網路環境為準，定義出一個內部的 DHCP 管理的區域網路，該網路的特色為： 		
         - 預留 172.19.*.1 ~ 172.19.*.100 作為保留給未來固定 IP 位址所使用
         - 其中 172.19.*.101 ~ 172.19.*.200 作為動態分配給其他用戶端
         - 你的 client 透過網卡，給予固定的 172.19.*.1 的 IP 位址參數
         - 其他參數請參考數周以來的網路環境 (包括主機名稱、gateway、DNS等等)
         - 請記得務必放行 dhcp 的使用權 (防火牆的規範)

   7. 內部私有路由 	

      1. 讓你的 server 會多一個路由，當發現到 172.19.250.0/24 的封包目標時，將它導向到 172.18.255.250 這部伺服器。
      2. 你可能需要修改防火牆，讓從 ens3 出去的封包，在 172.19.0.0/16 這一區段時，並不要進行偽裝喔！
      3. 當你在你的 Server 上面執行 ping 172.19.250.1 的時候，應該是會發現有回應封包才對。
      4. 這個設定在下次開機也是會生效的。

2. (20%)實作題：啟動 client 作業硬碟 

   1. 網路參數的設定，請依據底下的方式來設定好： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.19.*.1/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.19.*.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 主機名稱指定為： client.lan*.example.dic

      4. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 實際設定好本機防火牆 

      1. 預設請使用 firewalld 防火牆服務，不要使用 iptables 服務！
      2. 請將預設的領域 (zone) 改為 work 領域
      3. 預計放行的服務主要有 ssh 與 http 兩個服務，其他還可能有預設會啟用的 dhcp 用戶端服務。
      4. 查詢 rich rule (man firewalld.richlanguage)，確認來自本機同一個 LAN 網段的封包，通通給予放行。
      5. 上述放行的防火牆服務，在下次重新開機後，依舊會存在才行

   3. 內部私有 VLAN 的設定 	

      1. 先取消 ens3 的網路設定 (取消 IP 等參數的設定值)
      2. 指定一個名為 vlanXX 的 VLAN 環境，其中 XX 為 VLAN ID，該 ID 為你的 IP 尾數，且該 VLAN 使用 ens3 作為實體網卡， 		且使用 vlan 的網卡名稱同樣取名為 vlanXX。
      3. 使用 MTU 設定為 1400 
      4. vlanXX 的網路參數請使用 dhcp 自動取得的方式來處理！且自動取得的 IP 必須要跟原本手動設定的網路參數相同才行。

3. (12%)簡易問答題：(每題 2 分) 	從具有 GUI 及中文的用戶端 Linux ，使用『 ssh root@172.19.*.254 』登入你的 Server ，之後建立 /root/ans.txt 的檔案，並將底下各題目的答案寫入你 server 當中！ 

   1. 簡單的說明 VLAN 在 switch 上面設定的目的是什麼 (尤其對大數量 port number 的 switch 來說)？
   2. 簡單的說明 VLAN 用在內部網路 (LAN) 的功能是什麼？
   3. 其實預設的環境就是一個 VLAN，這個 VLAN 的 ID 是幾號？
   4. DHCP 伺服器啟用的 port number 是幾號？用的封包格式是？DHCP 用戶端啟用的 port number 是幾號？用的封包格式又是？
   5. 在 CentOS8 的系統下，DHCP 伺服器的設定檔完整路徑為？DHCP 租約檔的完整路徑為？
   6. DHCP 可以提供兩種 IP 取得的方法，其設定值分別是什麼？

4. 上傳成績 

   1. 請將 Server/Client 的硬碟通通啟動，並且確認兩者間的連線沒有問題；
   2. 在 Server 硬碟上面登入，然後用 root 的身份執行 vbird_server_check_unit ，並依據提示資料填寫你的學號與 IP 尾數
   3. 該程式會偵測你的系統，並且通知你哪個部份可能有問題，你需要持續觀察或者重新處理的部份會交代妥當。
   4. 若一切沒問題，螢幕就會出現如下的字樣，然後你就能夠使用 links 去檢查你的檔案是否有順利的上傳了！
   5. Please use links http://172.18.255.250/upload/unit05 to check your filename

## 遠端連線伺服器 sshd, VNC 與 XRDP

###### 上次更新日期 2020/11/05

較有規模的公司，伺服器都是放在機房的。至於像校園系所的伺服器，或老師個人的伺服器，可能就只是放在某個角落沒有接上螢幕的主機而已。 因此，要登入這些設備，就得要透過網路連接到系統裡面去。連接到伺服器的方法有純文字模式與圖形界面模式， 純文字模式幾乎一定是用 sshd 這個服務，至於圖形界面則可能是 VNC 或 XRDP 囉！

學習目標

- 了解金鑰系統，比較能熟悉免密碼登入的 ssh 功能
- 熟悉 sshd 協定，包括使用 rsync 也是透過 sshd 協定的任務
- 進行 sshd 的安全強化
- 了解使用 VNC/XRDP 等圖形界面協定

- 6.1： 遠端連線伺服器與連線加密的金鑰系統
- 6.2： ssh 的指令功能： ssh, scp, sftp
- 6.3： ssh 協定的安全設定
- 6.4： ssh 的常見應用
- 6.5： 使用圖形界面連線： VNC
- 6.6： 使用圖形界面連線： XRDP
- 6.7： 課後練習

### 6.1： 遠端連線伺服器與連線加密的金鑰系統

- 什麼是遠端連線伺服器

所謂的連線到伺服器的功能，主要就是：透過遠端連線的功能登入到伺服器，經常使用於工作站，或者是多人共用伺服器的環境， 包括科學運算過程當中需要用到的數值模式模擬環境。而常見的模式則有：

- 透過純文字模式，目前主流為 ssh
- 透過圖形界面，包括 VNC, RDP 以及 Linux 模擬的 XRDP 功能！

因為我們透過連線伺服器的功能，然後就可以在遠端對伺服器下達各種命令。因此，如果我們所傳達的任何命令或指令或動作， 以一般的明碼進行傳送時，很可能就會在傳輸的路上被竊取而遭受進一步的攻擊。所以，早期明碼傳輸的 telnet 與 rsh 才會被淘汰。 而近期使用 ssh 則是因為資料在 server / client 之間傳送時，是經過加密的行為，因此網路上竊取的資料就不會被輕易的解析出來， 對於資料而言，當然是相對較為安全。

- 連線加密的金鑰系統

那麼所謂的加密是怎麼回事呢？基本上就是發送端會先透過一個機制來加密，而接收端就透過相對的機制來進行解密。 這兩個機制必須要有相關性啊，這就是所謂的成對金鑰系統。

- 公鑰 (public key)：提供給遠端主機進行資料加密的行為，也就是說，大家都能取得你的公鑰來將資料加密的意思
- 私鑰 (private key)：遠端主機使用你的公鑰加密的資料，在本地端就能夠使用私鑰來進行解密。由於私鑰是這麼的重要， 	因此私鑰是不能夠外流的！只能保護在自己的主機上。

![ssh 金鑰系統](https://dic.vbird.tw/images/keypair-2.gif)

因此，Server 需要有一對公/私鑰， client 也要有自己的一對公/私鑰，並且將自己的公鑰傳給對方，保留自己的私鑰來進行解密。 而提供公鑰給對方，就是要對方以我自己的公鑰來加密的意思。整體的 Server / Client 金鑰傳輸系統有點像這樣：

![ssh 金鑰系統](https://dic.vbird.tw/images/ssh-keypair2.gif)



​		例題 6.1.A：了解金鑰的發放與保存： 	

1. 當用戶端要傳送資料給伺服器端，資料是如何進行加密與解密？(用誰的公鑰?用誰的私鑰?)
2. 當伺服器端要傳送資料給用戶端，資料是如何進行加密與解密？(用誰的公鑰?用誰的私鑰?)
3. 所以，那一個鑰匙是不能夠外流的？



​		例題 6.1.B：了解 ssh 的連線行為與產生的各項金鑰資訊 (請同時啟動 server 與 client 兩個系統) 	

1. 個人金鑰系統的檔案紀錄功能： 		
   1. 先在 client 系統上面的 student 用戶，看看有沒有 ~/.ssh/ 這個目錄的存在？若有，則請觀察該目錄的權限為何？
   2. 使用『 ssh localhost 』，並且輸入 yes 之後，再輸入 student 密碼，看看能否登入系統了？
   3. 登入之後，使用『 netstat -atnp 』查閱一下有沒有 port 22 的連線存在？
   4. 現在請離開這次的 ssh 連線
   5. 查閱一下 student 家目錄下的 ~/.ssh/known_hosts 檔案內容，是否有 localhost 的金鑰存在？
2. 系統整體金鑰檔案的放置位置與 sshd 啟動呼叫金鑰的流程理解： 		
   1. 現在使用 root 的身份在 client 系統上，並且進入 /etc/ssh 這個目錄，然後理解一下公鑰與私鑰的可能檔名為何？
   2. 將金鑰系統移動到 /tmp 去，然後重新啟動 sshd 這個服務，有沒有產生新的金鑰？
   3. 使用另一個終端機，以 student 的身份，再次執行『 ssh localhost 』，會出現什麼問題？
   4. 回到 root 的視窗，刪除新的金鑰，將舊的金鑰移動回來，重新啟動 sshd 服務
   5. 再以 student 身份重新執行『 ssh localhost 』有沒有恢復正常的登入流程？為什麼會這樣？
   6. 若要刪除記載的金鑰，該如何處理？ (請使用 vim 來處理)



### 6.2： ssh 的指令功能： ssh, scp, sftp

常見的 ssh 協定的使用軟體有 ssh, scp, sftp 等，各個功能不太一樣。

- ssh：等於是遠端登入，然後取得伺服器終端機 (bash shell) 的一個方式
- scp：透過 ssh 協定進行檔案直接網路複製的功能
- sftp：透過 ssh 協定，進行類似 FTP 檔案傳輸的功能。

- ssh 連線功能

這個指令基本的操作方式如下說明：

```
[student@localhost ~]$ ssh [-f] [-o parms] [-p port] [account@]IP [command]

# 直接用目前的身份登入某部伺服器的方式：
[student@localhost ~]$ ssh 127.0.0.1

# 改用其他帳號登入某部伺服器的方式：
[student@localhost ~]$ ssh root@127.0.0.1   # 重點在 @ 之前的帳號！

# 直接在其他伺服器上面執行某個指令後結束
[student@localhost ~]$ ssh student@127.0.0.1 find / &> ~/find1.log

# 與上述指令相同，但是交派指令後立即結束連線，讓伺服器自己執行後面的指令 (有沒有連線差很多)
[student@localhost ~]$ ssh -f student@127.0.0.1 find / &> ~/find1.log

# 不要詢問而是直接加入金鑰到紀錄檔中的方式
[student@localhost ~]$ ssh -o StrictHostKeyChecking=no root@localhost
```

- sshd 的加密機制

sshd 支援相當多的加密機制，由於加密功能漸漸廣泛，因此許多的 CPU 加密指令集就被開發出來，其中比較重要的就是 AES 加密機制。 sshd 也支援此種加密機制，除了可以加快傳輸之外，也可以避免被攻擊的情境。若需要了解 sshd 支援的加密機制，可以使用底下的方式查詢：

```
[root@localhost ~]# sshd -T | grep -i cipher
```

但事實上，傳輸是需要兩方面具有相同的功能，所以，如果是兩部不同 distribution 的系統，那兩部主機會自動協調可用的參數來傳輸。

​		例題 6.2.A：請回答下列問題： 	

1. 嘗試回答，當出現底下的畫面時，應該要輸入哪個帳號的密碼才對？ 		
   - [student@localhost ~]$ ssh 127.0.0.1
   - [root@localhost ~]# ssh 127.0.0.1
   - [student@localhost ~]$ ssh root@127.0.0.1
   - [root@localhost ~]# ssh student@127.0.0.1
2. 預設的 ssh 加密為 AES 加密機制，由於涉及加密的速度，因此目前很多的 CPU 會加入 AES 這個指令集。請查出你系統 CPU 是否有支援 AES 呢？ 		(hint: 找 /proc/cpuinfo 就對了)
3. 如果你需要更高階的加密計算，可以使用 256bit 的 aes 加密機制 (如上，使用 sshd -T 去查詢支援度)，而不是使用預設的機制。 		如果要強迫使用 aes256-gcm@openssh.com 這個機制，該如何處理？ (hint: ssh 需要 -c 的選項，而 scp 需要 -o 的選項功能喔！ 		此外，建議 ssh 加上 -v 的參數來查詢連線階段的訊息輸出) 		

- scp 網路異地直接複製功能

你可以直接以 ssh 協定來進行檔案的傳輸！是檔案傳輸喔！不是透過其他通訊協定。scp 是可以直接以 ssh 通道來傳送檔案的一種方式， 使用上面就與 cp 相當類似，只是你得要加上遠端主機的帳號、IP與檔名而已。處理方式如下：

```
[student@localhost ~]$ scp [-pr] [-l 速率] file  [帳號@]主機:目錄名  # 上傳的行為
[student@localhost ~]$ scp [-pr] [-l 速率] [帳號@]主機:file  目錄名  # 下載的行為

-p ：保留原本檔案的權限資料；
-r ：複製來源為目錄時，可以複製整個目錄 (含子目錄)
-l ：可以限制傳輸的速度，單位為 Kbits/s ，例如 [-l 800] 代表傳輸速限 100Kbytes/s
-P port：如果 ssh 開在非正規埠口，可以使用這個大寫 P 來指定埠口號碼
```

到底是上傳還是下載？可以透過觀察上述指令的冒號 (:) 來分析即可！那個冒號的所在處，就是遠端機器的位置，你就可以知道上傳還是下載了。

​		例題 6.2.B：實際執行下列動作： 	

1. 在 Server 上，以 root 身份將 /etc/host* 連同目錄喔！完整的複製到 client 的 /dev/shm/checking/ 目錄下，遠端身份請使用 student 喔！
2. 在 Server 上面以 dd 建立一個大約 500M 的檔案，放置到 /dev/shm 底下喔。然後以 chacha20-poly1305@openssh.com 的運算機制，將檔案複製到  		client 的 /dev/shm 底下去。
3. 承上，你不想要太花系統頻寬，因此預計使用 1Mbytes/s 的速度來傳輸，又該如何處理？

- sftp 類似 ftp 用戶端軟體，但透過 ssh 協定

如果你習慣使用 FTP 的用戶端軟體，那就直接以 ssh 提供的 sftp 來處置即可。基本上，你可以在用戶端選擇以 GUI 的軟體來執行檔案的傳輸， 不但連線加密，還與 FTP 的功能完全一致。基本上，有 scp 你應該會比較少使用 sftp 的！所以這裡僅是告知你有這個功能，相關的指令就不介紹了。

- 以 ssh 取得遠端 X 軟體的操作權

某些時刻，你可能需要從遠端取得圖形化界面，但是遠端伺服器其實並沒有圖形界面的存在，只是有圖形界面的軟體而已。那該如何是好？ 其實，你可以在 client 端以 X server 來操作伺服器的 X client 喔！不過，因為 X 的執行需要在伺服器端有 X 軟體以及驗證功能，所以， 你的伺服器需要先安裝某些特殊軟體才行！

​		例題 6.2.C：在伺服器端安裝 X 軟體以及驗證工具 (X client 軟體) 	

1. 在伺服器端的軟體： 		
   - 先安裝比較多軟體的 xorg-x11-apps 這個軟體包；
   - 因為需要提供操作者的驗證，因此還需要安裝 xauth 這個軟體包
2. 在用戶端 GUI 的環境下，執行：『 ssh -X account@IP xeyes 』等，來執行伺服器端的 X client 軟體。 		未來若有其他需求，直接修改 xeyes 成為你要執行的軟體即可！

進行上述練習時，在 Client 端執行軟體時，最好都用原生的圖形界面操作者，不要切換身份來執行較佳。

### 6.3： ssh 協定的安全設定

sshd 的設定主要是在 /etc/ssh/sshd_config 這個檔案裡面做設定，其中預設的設定值已經是挺完整的了，不過還是有需要進行一些更嚴格的設定較佳。 此外，防火牆的規劃也請額外處理一下才好。

- 連線埠口的更改

某些時刻，可能由於計算機中心管制的問題，以及 port 重複利用的問題，或者是其他各企業規範政策所致，你可能無法使用正規的 port 22 來處理你的 ssh。 此時你可以調整 ssh 的埠口號碼，建立在非正規的埠口上。唯一的好處是，可能可以略過一些常見的 ssh 攻擊掃描問題。

​		例題 6.3.A：我們想要修改 ssh port，讓它同時存在 port 22 以及 port 5533 ，該如何處理？ 	

1. 事前準備：由於出自於 SELinux 的問題，因此你最好已經安裝了 setroubleshoot-* 等軟體！
2. 修改 /etc/ssh/sshd_config 內容，建立兩個 Port 項目，亦即 Port 22 以及 Port 5533，設定完請重新啟動 sshd 服務。
3. 使用 systemctl status sshd 時，會發現錯誤！無法啟用 port 5533 ，請查詢 /var/log/messages 的內容，並據以修改。
4. 上述改完之後，請再次啟動 sshd，並使用 netstat 觀察監聽的埠口是否正確擁有 5533 了。
5. 在用戶端使用這個埠口來進行 (1)登入與 (2)複製 /etc/pam.d 到用戶端的 /dev/shm 底下去！(你可能需要用 root 身份)

- 防火牆處理

啟動了埠口後，我們還是希望不要讓這個 port number 對全世界放行。因此，你可能需要調整一下你的防火牆規則才好。

​		例題 6.3.B：這個 sshd 5533 的埠口只針對某些 IP 來放行的喔！ 	

- 預設將 port 5533 對全世界封閉 (reject)
- 針對 172.16.0.0/16 放行，同時針對 10.0.0.0/8 放行
- 針對 172.16.99.99 這個 IP 拒絕其連線

防火牆制定規則中，大致上的條件幾乎是『小範圍的先進行，再管理大範圍的』情況，所以上述的情況也需要做一些修訂才行喔！

- 取消 root 登入權限

一般來說，要攻擊你的系統，從『軟體漏洞』攻擊最快！因為無須猜測你的帳號密碼。但如果沒有漏洞的軟體存在時，那麼攻擊者恐怕就會轉而處理猜測你的密碼。 而整個 Linux 系統一定會存在的帳號，那當然就是 root 這個帳號了！因此，如果你讓 root 可以使用 ssh 登入系統的話，那麼攻擊者就很可能一直猜測你的 root 密碼。 所以，通常我們建議你關閉 root 的登入權，改由一般帳號登入系統，然後再轉換身份來處理較佳。

​		例題 6.3.C：取消 root 遠端登入的權限 	

1. 修改 /etc/ssh/sshd_config，讓 root 無法繼續使用 sshd 服務，同時需要重新啟動 sshd 喔！
2. 嘗試使用 ssh root@localhost 看看，查閱一下 systemctl status sshd, /var/log/secure 等檔案，看看出現的問題為何？
3. 測試完畢後，請再次讓 root 可以使用 sshd 喔！

- 建立不可使用 ssh 登入的用戶

以鳥哥為例，我必須要建立給學生上課用來傳輸網頁的伺服器，且第一次讓學生操作時，需要強迫他們重新設定自己的密碼，因此學生帳號必須要能夠使用 ssh 才行。 但是在處理完畢這件事情之後，鳥哥希望學生不要使用 ssh 來登入這個系統，因為擔心某些資料會被亂用。因此，我就得要讓他們再也無法使用 ssh， 不過，卻是可以使用任何功能的條件。

在此設計的角度上，讓 shell 變成 /sbin/nologin 也是一個作法，只是這樣一來，連本地端 (tty1~tty6) 也無法登入，這與當初只想要關閉 ssh 的使用不太一樣。 此時，我們可以使用 sshd_config 提供的功能來設計！

​		例題 6.3.D：建立無法使用 ssh 的帳號 	

1. 先使用 man sshd_config 的方式，搜尋 denygroups 的設定值，觀察如何設定與它的功能為何？
2. 建立一個 denyssh 的群組，而且將這個群組設定到無法使用 sshd 的參數中 (你應該要重新啟動 sshd)
3. 建立一個 usera 的帳號，這個帳號還加入 denyssh 的次要群組，同時密碼為 1234hehe!
4. 嘗試用 tty3 登入這個帳號
5. 嘗試用 ssh usera@localhost 登入系統

未來你只要讓任何不想讓他使用 ssh 的帳號，將該帳號加入 denyssh 的群組，他就無法使用 ssh 的功能囉！

- 不修改 ssh port 增加 ssh port 連線埠口的功能

事實上，你依舊使用 port 22 來管理 ssh 即可，只是，讓你的某個方向的連線增加一個 port mapping 的功能即可。 舉例來說，你如果需要使用 5555 這個 port 來連線到 ssh 的話，那麼可以使用底下的方式來處理即可：

```
iptables -t nat -A PREROUTING -p tcp --dport 5555 -j REDIRECT --to 22
```

這樣，雖然對方還是連線到你的 port 5555，但是因為上面這段的關係，該連線被重新導向 port 22 去了！這樣還不用修改 ssh 呢！ 比較有趣！比較有趣！

### 6.4： ssh 的常見應用

ssh 除了可以讓你登入與傳送檔案之外，其實他還經常被拿來作為自動異地備份的相關功能之中。不過，如果想要讓系統自動於背景中進行異地備援， 就得要建立無須密碼登入的帳號～這就需要用到預先設定好的金鑰系統才行。

底下例題的目的是：在 Server 上面使用 root 的身份，將重要資料複製到 client 端去！因為涉及權限，因此建議兩者均用 root。 但是因為 server 的 root 可能已經被拒絕使用 ssh 囉，所以才用 server 主動的提供到 client 去的方向。

​		例題 6.4.A：從連線發起端建立金鑰後，再將公鑰上傳到接收端的方式： 	

1. 在連線發起端使用 root ，以『 ssh-keygen 』來建立兩把金鑰，注意看 ~/.ssh 的內容！
2. 在連線發起端使用 root 以『 ssh-copy-id -i filename account@IP 』來處理金鑰的上傳
3. 在連線發起端使用 root 以『 ssh account@IP date 』來測試是否需要密碼？
4. 在連線接收端，使用相對應的帳號來觀察 ~/.ssh 內部檔案的變化。

- 使用 rsync 處理異地備援

如果你的檔案是一直更新的，那麼使用 scp 即可。如果你的檔案不是一直更新，而是持續累加不同的檔案時，使用 scp 有點困擾！ 因為沒有更新的檔案透過 scp 還是會重新複製一次。因此，這時可以比對兩邊資料後，只上傳較新的檔案的方式，就是你應該要學會的技術了。 那就是 rsync 這個指令囉。

```
[student@localhost ~]$ rsync [-avrlptgoD] [-e ssh] [user@host:/dir] [/local/path]

-v ：觀察模式，可以列出更多的資訊，包括鏡像時的檔案檔名等；
-q ：與 -v  相反，安靜模式，略過正常資訊，僅顯示錯誤訊息；
-r ：遞迴複製！可以針對『目錄』來處理！很重要！
-u ：僅更新 (update)，若目標檔案較新，則保留新檔案不會覆蓋；
-l ：複製連結檔的屬性，而非連結的目標原始檔案內容；
-p ：複製時，連同屬性 (permission) 也保存不變！
-g ：保存原始檔案的擁有群組；
-o ：保存原始檔案的擁有人；
-D ：保存原始檔案的裝置屬性 (device)
-t ：保存原始檔案的時間參數；
-I ：忽略更新時間 (mtime) 的屬性，檔案比對上會比較快速；
-z ：在資料傳輸時，加上壓縮的參數！
-e ：使用的通道協定，例如使用 ssh 通道，則 -e ssh
-a ：相當於 -rlptgoD ，所以這個 -a 是最常用的參數了！
```

因為就是使用 ssh 的協定，因此上傳或下載，就是查看冒號 (:) 所在處囉！另外，使用 rsync 時，需要特別注意：

- Server 與 Client 兩端都需要安裝 rsync 才能夠順利的運作喔！！
- 如果兩端帳號身份相同，可以配合 -av 來處理所有權限同步
- 如果兩端帳號身份不相同，建議使用 -rlt 參數來複製較佳。

​		例題 6.4.B：開始處理 ssh 協定的工作： 	

1. 在 Client 用 root 帳號身份，將 /root, /etc 目錄備份到 Server 的 student 家目錄下的 backups 目錄中
2. 重複上一個動作，結果會如何？
3. 如果需要使用到 port 5533 時，又該如何下達指令？
4. 定期於每日 2 點執行一次備份功能。

- 使用個人 ~/.ssh/config 設定檔

如果懶的記憶許多的主機名稱 / IP位址，可以透過設定檔來紀錄相關設定。舉例來說：

- 假定主機名稱 myadm 連線到 192.168.254.4，透過帳號 myadm 連線
- 假定主機名稱 web 連線到 192.168.254.23，透過帳號 web 連線
- 假定主機名稱 dbuser 連線到 192.168.254.16，透過帳號 dbuser 連線

上述設定均可使用底下的語法來處理：

```
Host myadm
Hostname 192.168.254.4
User myadm
Port 22
```

### 6.5： 使用圖形界面連線： VNC

VNC server 會在伺服器端啟動一個監聽用戶要求的埠口，一般埠口號碼在 5901 ~ 5910 之間。當用戶端啟動 X server 連線到 5901 之後，  VNC server 再將一堆預先設定好的 X client 透過這個連線傳遞到用戶端上，最終就能夠在用戶端顯示伺服器的圖形介面了。

不過需要注意的是，預設的 VNC server 都是獨立提供給『單一』一個用戶端來連線的，因此當你要使用 VNC 時，再連線到伺服器去啟動  VNC server 即可。所以，一般來說， VNC server 都是使用手動啟動的，然後使用完畢後， 再將 VNC server 關閉即可。

​		例題 6.5.A：安裝需要的軟體 	

- 雖然說在 Server 端安裝 tigervnc-server 即可，不過為了取得良好的顯示效果，我們還需要至少安裝一些桌面顯示功能才好！
- 除了 tigervnc-server 之外，根據分析 /etc/X11/xinit/xinitrc 以及 /etc/X11/xinit/Xclients， 		我們決定持續安裝底下的軟體較佳： 		
  - gnome-session
  - gnome-classic-session
  - gnome-terminal
- 在 client 端安裝 tigervnc 即可。

至於啟動/關閉 VNC server 的方式為：

```
[student@localhost ~]$ vncserver [:號碼] [-geometry 解析度] [options] # 啟動 VNC Server
[student@localhost ~]$ vncserver [-kill :號碼]                        # 關閉 VNC server
```

​		例題 6.5.B：開始測試 VNC server 的使用 	

- 在 Server 端的操作： 		
  - 以 student 的身份，啟動 VNC 埠口在 5905 上面
  - 第一次操作時需要輸入密碼，密碼需要至少 6 個字元以上
  - 啟動完成後，請使用 netstat 檢查是否順利啟動了。
  - 前往 student 家目錄下，觀察 ~/.vnc 目錄，了解密碼檔案是那一個？
  - 若需要修改密碼，可以參考 vncpasswd 指令的處理方式即可。
  - 不建議 port 對全世界放行，不過如果需要針對外部某個 IP 來源放行，則請修改防火牆。例如放行 172.16.0.0/16 的連線！
- 在 client 端的操作： 		
  - 必須要是在 GUI 的環境下才能夠操作連線功能
  - 最簡單的方式，使用 vncviewer IP:port 即可連線，當然還是需要輸入密碼的。

- 嘗試開機執行 VNC 功能

VNC 一般建議用到才啟動，用完就關閉，不要持續啟動。不過在某些情境下 (例如鳥哥透過 VNC 操作 Server 的模式運算)， 你或許需要開機就啟動喔！這時就得要使用特別的方式來啟用了！

​		例題 6.5.C：開機就啟用 VNC 這個服務 	

- 若尚未關閉 port 5905 ，請立刻關閉他！
- 使用 rpm -ql tigervnc-server ，找出 systemd 的設定檔所在處
- 參考上述檔案的內容的說明，一步一步設定好 VNC 的處理！
- 將該服務設定為啟動，且開機就啟動 (systemd [start|enable])。

- 嘗試使用 ssh 通道加密 VNC 的連線

一般正常情況下，VNC 預設是不加密的。如果 Server/client 你都可以使用 ssh 連線溝通的話，那麼我們可以透過 ssh 的隧道功能 (tunnel) 來進行連線， 達成在這條通道內的任何資料傳遞！你可以參考例題 6.5.C 找到的那個檔案的介紹，直接在用戶端這樣處理即可：

​		例題 6.5.D：透過 ssh 通道，直接連接未加密的 VNC ，以 ssh 通道達成加密的 VNC 視窗。請注意，底下的動作全部都在 client 進行即可！ 	

- 先開啟一個視窗，輸入『 ssh -c -v -L 5905:localhost:5905 account@VNC_Server_IP 』，輸入 account 密碼，此時就會有一條通道連接到 VNC server 上， 		而 5905:localhost:5905 ，左側的 5905 指的是用戶端 (localhost) 開啟的監聽埠口，而右側的 5905 則是 VNC server 所啟動的埠口，這兩個埠口可以不一致， 		不過如果不影響本機的服務，建議兩者相同即可。
- 再開一個視窗，輸入『 vncviewer localhost:5905 』即可取得圖形界面。

透過上述取得的 VNC 畫面，其實是透過 ssh 的通道，因此你會發現兩個視窗的訊息非常的多！這是因為 VNC 連線的所有資訊都會在這條隧道內顯示的意思！ 你就無須自行尋找 VNC 的加密囉！因為 ssh 真是萬能！

### 6.6： 使用圖形界面連線： XRDP

我們知道 Windows 的遠端桌面 (Remote Desktop Procotol, RDP) 其實是具有連線加密功能的，所以，能不能在 Linux 上面裝一個 RDP Server 呢？是可以的，那就是 XRDP  伺服器

很可惜的是，我們的 CentOS 8.x 預設並沒有提供 XRDP 的伺服器，如果你有興趣的話，可以自行編譯 xrdp 軟體， 但鳥哥有找到 Fedora  基金會提供的 RHEL 額外軟體計畫，請依據第一堂課的例題 1.2.C 的方式建立好 EPEL 這個 repo 的 yum 來源伺服器，然後以底下的方式來安裝好你的 xrdp 喔！

```
[root@localhost ~]# yum --enablerepo=epel install xrdp
```

安裝完畢之後，你就可以立刻啟動 xrdp 了！因為幾乎所有的設定值都已經處理妥當～不須額外的其他設定。 只是有可能得要處理一下防火牆就是了。

​		例題 6.6.A：啟動與觀察 XRDP 伺服器 	

1. 啟動 XRDP，同時讓這個服務永遠都會開機啟動
2. 使用 netstat 觀察一下 RPD 使用的埠口預設是幾號？
3. 如果要針對 internet 放行你的 RPD 埠口，該如何處理？

處理完畢之後，你得要注意，未來若有用戶端連線過來，雖然連線是透過 xrdp，但事實上後端跑的依舊是 VNC 喔！這點得要加強說明。 若有其他需要處理的額外設定，也請參考 /etc/xrdp/ 這個目錄下的設定檔吧！

那麼用戶端如何連接？如果是 windows，那就使用遠端桌面連接即可。那如果是 Linux 呢？CentOS 8 提供了 freerdp 這個軟體可以提供給你操作使用。 你可以直接使用 yum install freerdp 即可！安裝完畢之後，可以透過底下的指令功能來連結喔：

```
[student@localhost ~]$ xfreerdp serverIP:port
```

然後最好挑選 Xorg 的原生選項，填入你的 Server 上面的帳號與密碼，就可以登入囉！這這麼簡單！

### 6.7： 課後練習

1. (60%)實作題：啟動 Server 作業硬碟 - unit06	

   1. 網路參數的設定，請依據底下的方式來設定好你的網路環境： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 為外部的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.18.255.*/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.18.255.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 使用 teamd 的機制建立內部區域網路的備援功能： 		

         - team 的界面使用 team0 卡號，且連線名稱請命名為 team0
         - team 使用 activebackup 備援功能，不要使用 loadbalance
         - team 的實體網卡 (team slave) 請使用 ens7 及 ens8 ，且其連線名稱名稱亦請命名為 ens7, ens8
         - team0 網路參數為： 172.19.*.254/24，不需要 gateway 

      4. 主機名稱指定為： server*.example.dic

      5. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 基本的伺服器作業系統設定行為： 	

      1. 使用崑山的 FTP 網站作為你的 YUM server 來源，來源倉儲至少需要涵蓋 BaseOS, AppStream, extras, PowerTools 等， 		並且清除一次 yum 清單快取。(請注意，由於最終系統會全系統升級一次，升級後，這些設定檔可能會被更新。 		因此，你在全部升級完畢之後，還需要回來修改這個設定檔喔！)
      2. 安裝相關的軟體，至少須安裝 vim-enhanced, bash-completion, net-tools, mailx, wget, links, bind-utils,  		kernel-tools, kernel-modules (某些軟體可能需要使用 PowerTools 軟體倉儲安裝喔！但是該軟體倉儲預設需要是不啟用 
      3. 全系統自動升級，且每天凌晨 3 點也會自動升級一次。(請寫入 /etc/crontab 為主)
      4. 將 SELinux 修改成為 Enforcing 模式，且未來每次開機都自動為 Enforcing 才行

   3. 實際設定好本機防火牆 

      1. 請關閉 firewalld 服務，並且自行安裝、啟動 iptables 服務
      2. 將預設的規則轉存到 /root/firewall.sh 這個檔案內
      3. 首先將全部的規則刪除 (應該有三條指令)
      4. 設定好預設政策，讓 INPUT 成為 DROP 而 OUTPUT 與 FORWARD 成為 ACCEPT
      5. 針對 INPUT 前三條規則為 (1)回應封包 (2)放行 lo 界面 (3)放行 icmp 封包
      6. 放行你自己的內部區域網路那個網域的連線要求 (針對 LAN 的信任設定)
      7. 讓 ssh 只對外部的區網放行，不會對 Internet 放行 (對 ssh 連線做限制較佳)
      8. 讓 http 針對整個 Internet 放行 (一般公開的服務設計)
      9. 最後讓確定的規則轉存到 /etc/sysconfig/iptables 這個設定檔
      10. 重新啟動 iptables 服務，然後觀察規則是否正確

   4. 實際設定好 Server 的路由功能 

      1. 讓核心支援 IP 轉遞的功能，並且每次重新開機都可以自動生效
      2. 修改 /root/firewall.sh ，在該檔案加入清除 nat 表格的規則與自訂鏈的設定
      3. 增加規則：讓來自內部網路的封包，在路由判斷後，並預計由 ens3 對外網卡出去的封包，全部偽裝成為 ens3 的 IP 位址 	 (一般在數據機上面的就是 public IP)
      4. 在 /etc/sysconfig/iptables-config 當中增加 nf_nat_ftp 及 nf_conntrack_ftp 模組功能
      5. 上述功能在開機後依舊能夠順利啟動

   5. 針對 sshd 服務的相關設定項目： 	

      1. 由於某些緣故，這個系統的 sshd 必須要同時開啟 port 22 以及 port 3131，且開機完畢就啟動這兩個埠口
      2. 承上，針對 port 3131 的防火牆設定中： 		
         - 除了兩段區網需要放行之外 (ens3 與 team0 的所在網域)
         - 還需要針對 10.0.0.0/8 放行
         - 但是 10.10.10.0/24 這個區段必須要拒絕使用 port 3131
      3. 建立三個帳號，帳號名稱分別為 localuser1, localuser2, localuser3，三個帳號均加入 nosshgrp 次要群組支援， 		這三個帳號的密碼均為 123hehe。此外，這三個帳號可以使用本機 tty1~tty6 登入系統取得 bash 界面，但是不能使用 ssh 遠端登入！
      4. sshd 這個服務拒絕直接以 root 的身份登入系統。
      5. 只給外部網域使用 port 4455 這個埠口轉遞到 port 22 的連線功能，請使用 iptables 防火牆功能來完成這個項目 		(請參考 6.3 小節最後面的新增部份)。

   6. 針對異地備份的功能設置 	

      1. 在 server 上面寫一隻名為 /root/bin/backup.sh 的腳本，這個腳本會進行： 		
         - 以 rsync 透過 ssh 通訊協定，將 Server 上的 /etc, /home, /root, /var/spool/mail 等目錄備份到 client 端的 /backups/ 裡面去
         - 必須要在 Server 上面以 root 的身份進行這個備份的動作，而且備份到 client 時，也是以 root 的身份登入到 client 上面。
         - 進行 ssh 協定時，需要使用 chacha20-poly1305@openssh.com 的加密機制，加快傳輸速度。
      2. 上述腳本在運作中，不需要輸入密碼。
      3. 該腳本每日凌晨 3 點進行一次。

   7. 針對圖形界面 VNC 服務的啟動 	

      1. Server 為了圖形界面 VNC，請額外安裝 gnome-session, gnome-classic-session, gnome-terminal 等軟體
      2. 使用 student 的身份建立好 VNC 的服務，且服務密碼為 mystudent，埠口開在 5907 上面。
      3. 在 5901 ~ 5910 這一連續的埠口可以針對 172.30.0.0/16 這一段網域放行。
      4. 每次系統開機都會主動啟動 port 5907 這一段 VNC 服務。

2. (20%)實作題：啟動 client 作業硬碟 

   1. 網路參數的設定，請依據底下的方式來設定好： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.19.*.1/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.19.*.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 主機名稱指定為： client.lan*.example.dic

      4. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 實際設定好本機防火牆 

      1. 預設請使用 firewalld 防火牆服務，不要使用 iptables 服務！
      2. 請將預設的領域 (zone) 改為 work 領域
      3. 預計放行的服務主要有 ssh 與 http 兩個服務，其他還可能有預設會啟用的 dhcp 用戶端服務。
      4. 查詢 rich rule (man firewalld.richlanguage)，確認來自本機同一個 LAN 網段的封包，通通給予放行。
      5. 上述放行的防火牆服務，在下次重新開機後，依舊會存在才行

   3. 使用特別的設定方式來處理無法使用 root 登入卻需要 root 權限的行為 	

      1. 在 Server 上面建立一個名為 admin 的帳號，該帳號的密碼請設定為 345haha。這個帳號使用 sudo 時，不需要輸入密碼即可放行。

      2. 在 Client 上面建立一隻名為 /home/student/bin/getroot.sh 的腳本，腳本的基本內容如下(請修改 ip 為正確的 server IP)：

         ```
         #!/bin/bash
         
         ip="Your server IP"
         ssh -o StrictHostKeyChecking=no admin@${ip} "LANG=en_US; sudo sh -c \"
         	ls -l /root;
         	whoami
         	\"
         "
         ```

      3. 這隻腳本可以讓 student 執行，且 student 執行時，無須輸入任何密碼就可以取得 Server 的相關 root 權限資料。

3. (20%)簡易問答題 (前面 7 題 2 分，最後一題 6 分。) 	從具有 GUI 及中文的用戶端 Linux ，使用『 ssh root@172.19.*.254 』登入你的 Server ，之後建立 /root/ans.txt 的檔案，並將底下各題目的答案寫入你 server 當中！ 

   1. 成對的金鑰系統有公鑰與私鑰，請問，(1)那一把鑰匙在加密？(2)那一把鑰匙在解密？(3)那一把鑰匙是不能流出去的？
   2. 以本機的 localuser 帳號為例，當有任何 ssh 公鑰被紀錄時，預設紀錄的檔名為何？
   3. 預設的 ssh 的 version 2 (1)使用那一個加密機制？(2)如何觀察目前硬體有沒有支援該機制？
   4. 若想要使用 ssh -X 來登入遠端主機取得圖形界面軟體的使用權時，遠端伺服器應該要安裝哪個驗證軟體才行？
   5. 以本機的 localuser 帳號為例，這個帳號設定好 VNC 的使用後，預設 VNC 連線密碼記載檔名為何？
   6. 承上，那麼啟動 VNC 的程序運作檔名為何？
   7. RDP 預設的埠口號碼是幾號？
   8. 考慮如何以 ssh 加密某個服務的連線： 	
      - 我的 Server IP 為 myserverip，在 Server 上面有個服務啟動到 port 7777，這個 Server 的服務本身並沒有加密。
      - 我的 Server 上面有個我能夠掌握的帳號，帳號為 myserveruser
      - 我在 client 端想要啟動一個 port 4433 ，當我使用類似 vncviewer localhost:4433 時，該連線可以連接到 myserverip 的 port 7777。
      - 寫下來，(1)你要在 client 端還是 server 端執行 ssh 指令？ (2)指令如何下達？

4. 上傳成績 

   1. 請將 Server/Client 的硬碟通通啟動，並且確認兩者間的連線沒有問題；
   2. 在 Server 硬碟上面登入，然後用 root 的身份執行 vbird_server_check_unit ，並依據提示資料填寫你的學號與 IP 尾數
   3. 該程式會偵測你的系統，並且通知你哪個部份可能有問題，你需要持續觀察或者重新處理的部份會交代妥當。
   4. 若一切沒問題，螢幕就會出現如下的字樣，然後你就能夠使用 links 去檢查你的檔案是否有順利的上傳了！
   5. Please use links http://172.18.255.250/upload/unit06 to check your filename

------

- 2020/11/05：修改一些文字的錯誤，同時增加 6.3 小節的部份新增功能，另外，也將作業習題搞定！請大家實做看看！

## 身份識別伺服器與內部檔案系統伺服器

###### 上次更新日期 2021/12/01

如果你有一群員工大家彼此共用數台電腦，你應該會期望每個員工都可以使用自己的帳號與密碼登入系統，然後在每台電腦上面都能夠取得前一次登入時的工作環境。 這時你就需要一台統一管理帳密的伺服器，以及一台提供登入後取得家目錄的檔案伺服器，當然，這兩台也可以是同一部伺服器系統就是了。 然後讓所有的員工電腦以這兩個服務來管理帳號與檔案系統，那就可以達成你的願望了！這也是目前本單位電腦教室裡面的實做結果喔！

學習目標

- 了解 LDAP 的節點與屬性之間的非關聯性資料庫
- 學會如何設定 ldap 與操作 ldapmodify, ldapadd 等重要指令
- 了解如何讓 linux 系統與 ldap 身份驗證連動，包括設定 sssd.conf 設定檔
- 讓 ldap 搭配 NFS 提供 workstation 各種需要的供能。

- 7.1： 身份識別與檔案系統間的關係
- 7.2： LDAP 簡介
- 7.3： LDAP 的實際設定流程
- 7.4： LDAP 資料庫簡易管理 (新增/刪除/修改用戶參數)
- 7.5： 分享檔案系統的 NFS 伺服器
- 7.6： 課後練習

### 7.1： 身份識別與檔案系統間的關係

以電腦教室為例，如果讓每個學生預設都以同一個帳號登入，那麼學生在座位上面的調整就會比較沒有彈性，如果課程是有延續性質的， 那學生就得要坐到前一次上課的座位，否則就無法取得上次操作的環境與檔案。因此，許多電腦教室或辦公室，可能都會提供一個檔案伺服器來給學生或員工掛載使用， 例如底下的圖示，就是以 NFS 服務來提供檔案系統的範例：

![NFS 示意圖](https://dic.vbird.tw/images/nfs_server_client.png)

不過檔案系統也是需要驗證的，否則所有人都可以讀取任何人的檔案資料，那就天下大亂了！因此就需要有身份驗證系統才行。 所以，我們也才能夠透過身份驗證系統登入每一部主機，這樣在出問題時，也比較好查詢到到底是那一位學生或員工惡意使用所造成的問題， 比較好釐清責任歸屬囉。

總結說明身份識別與檔案系統間的關係就是：在一組或一間伺服器機房內，所有的伺服器均需要使用同一組帳號與密碼來登入， 並取得相同家目錄時，就需要這樣的設備需求。此種狀況常見的環境有：

- 在大型數值模式模擬中，經常需要跨不同的運算節點 (computing node) 來操作，以讓一個模擬的工作，可以透過多台高性能的系統共同運作， 	以期待快速達成模式運算的結果。因為每台 node 都需要讀取相同的檔案系統 (連檔名都要相同)，且操作的程序 (process) 也需要相同的帳號 (連同 UID/GID 最好都相同)， 	因此，在這些運算節點中，每部系統的帳號以及檔案系統，就都得要同步才行。
- 在崑山資傳系操作電腦教室的電腦時，所有的電腦均可以使用你的學號登入，並且可以取得你的個人桌面與額外的三個檔案系統 	(是檔案系統，不是檔案而已喔！)。因此在資傳系上課時，你可以在五間電腦教室的任何一間，使用相同的帳密登入，並可取得前一次上課的桌面與工作家目錄。 	所以如果對當前的座位不滿意，可以立刻換座位，也不會影響到你的正常操作。

再次強調該功能就得要有兩個元件：

- 使用身份識別功能：就是 ID 認證的服務。常見的服務有： NIS, LDAP, AD(windows), Kerboros...
- 使用者家目錄的取得：就是個人檔案資料。常見的服務有： NFS, SMB(網芳), AD(windows)...

以純粹 linux 的伺服器環境來說，最容易設定的其實是 NIS 與 NFS 兩者的搭配，不過 NIS 對於 windows 的支援較差，所以如果考量到未來的系統規劃， 建議是可以使用跨平台的 LDAP 來取代 NIS 作為身份識別系統較佳。至於檔案系統方面，雖然 SAMBA 才是預設可以提供跨平台的檔案系統， 不過在運作的效能方面，還是以 NFS 較為強大，因此作為 Server 的環境來說，當然首選還是使用 NFS 的。故底下將以 LDAP 搭配 NFS 來進行整體系統架構的設定。

### 7.2： LDAP 簡介

LDAP 全名： Lightweight Directory Access Protocol，主要的功能在於『目錄服務 (directory service)』的提供！什麼是『目錄服務』呢？ 從 wiki 上的說明來看，目錄服務指的是：

> 目錄服務是一個儲存、組織和提供資訊存取服務的軟體系統，在軟體工程中，一個目錄是指一組名字和值的對映。它允許根據一個給出的名字來尋找對應的值，與詞典相似。 像詞典中每一個詞也許會有多個詞義，在一個目錄中，一個名字也許會與多個不同的資訊相關聯。 類似地，就像一個詞會有多個不同的發音和多個不同的詞義，目錄中的一個名字可能會有多個不同類型的值。
>
> 目錄也許只提供範圍非常小的節點類型和數值類型，也可能對任意的或可延伸的一組類型提供支援。在一個電話目錄中，節點就是姓名而數值項就是電話號碼。 在DNS中，節點是域名而數值項是IP位址（還有別名，郵件伺服器名等等）。 在一個網路作業系統的目錄中，節點是那些由作業系統所管理的資源，包括用戶、電腦、印表機和其它共享資源。 

簡單的說，就是你可以提供一個查詢的資料對應的內容，舉例來說，你可以提供一個『帳號名稱』，而在這個帳號名稱底下給予對應了密碼、UID、GID、真實姓名等資訊， 若用戶端使用帳號名稱來查詢目錄服務，則可以得到該帳號的密碼、UID等等資訊就是了。而且目錄服務還不只提供這些資料，你想要額外增加什麼節點都可以！ 所以用途相當廣泛。

- LDAP 的組成

基本上，你就將 LDAP 想成是一個目錄，而每個目錄都有個目錄名稱，然後根據不同需求，可以給予更多的目錄節點。 至於目錄的內容，則根據目錄的定義來給予鄉對應的內容就是了。至於目錄的節點還是需要根據不同的層級給予不同的設定才行。 單純以節點的角度來看，以一個公司名稱為『 example.com 』的位置來說，該公司的相關部門位置節點有點像這樣：

![LDAP](https://dic.vbird.tw/images/ldap.jpg)
 圖示來源：http://dbaontap.com/2016/07/20/oem-13c-ldap-authentication/

如上所示，公司底下有兩個部門 (organization unit)，一個是伺服器部門 (Servers) 一個是人資部門 (People) ，其中人資部門底下管理著員工證號 (Person, udid)， 大概就是這樣一層一層的分配下來～而每一個節點底下可以搭配不同的資料給予特別的任務就是了。而如果是不同部門的相似架構呢？則可以用底下圖示來說明：

![LDAP](https://dic.vbird.tw/images/LDAPStructuresAdvanced.png)
 圖示來源：http://dbaontap.com/2016/07/20/oem-13c-ldap-authentication/

在公司 (company.com) 內部的兩大部門 (location1, location2) 個別提供了各自的帳號密碼管理機制之類的，可以再細分下去之意。 因此，只要找尋不同的 location 即可取得各自部門的人資訊息。

在比較學理的組成說明如下：

1. 可以提供非關聯性的資料庫環境，而每一筆資料則透過判別名稱 (distinguished name, DN) 來提示定義。 	例如上圖的 Organization unit 可以分別是兩者無關的部門 (People 與 Servers 明顯就是不同且無關的部門定義)
2. 每一個組織均需要定義最頂層的判別名稱，就被稱為 baseDN，這也是整個 LDAP 系統最先要設定的項目。 	例如上圖的『 dc=exmpale,dc=com 』以及底下的『 dc=company,dc=com 』都是所謂的 baseDN ！你可以猜測在組織 (Organization) 那一層的名稱， 	就是 baseDN 的意思了。
3. 每一筆查詢資料稱為 DN (Distinguished Name)，而 DN 就是呼叫出目錄節點的位置所在。 	例如上面提到的 baseDN 就是一例。他的展現方式就是『 dc=exmaple,dc=com 』，從小範圍寫起直到最頂層 (dc=com) 為止。 	事實上，DN 的展示方式其實有點像 DNS，不過需要使用 dc, ou, cn 等來進行名稱的指定。dc (domain component) 一般用在公司或最頂層 DN 的設定， 	ou (organization unit) 一般用在大部門的設定上， cn (common name) 一般用在非上述兩個用途的其他應用上。
4. 每個 baseDN 底下還有附屬組織單位，那就是 organization unit 的概念。例如人事部門可以使用類似： 	『 dn: ou=People,dc=example,dc=com 』之類的方式來命名。而該 DN 底下就會有多種屬性定義！這些屬性定義就牽涉到每一個 LDAP 的用途為何。
5. 因為 LDAP 僅是一個『目錄服務』的提供者，但這些目錄底下資料的定義使用的功能為何，就是透過預先定義的綱要檔 (Schema) 來定義。 	舉例來說， Linux 與 Windows 的帳號所需要的項目並不相同，因此使用 LDAP 作為 Linux 的帳號認證來源時，就得要使用 LDAP 提供的 Linux 帳號所需綱要檔 (schema)

- LDAP 的架設流程簡介

如果確定要架設 LDAP 作為你的身份驗證來源，那麼你得要事先規劃好這部 LDAP 所提供的 baseDN、相關的管理者密碼、相關的帳號 UID 起始號碼、 相關的使用者家目錄 (最好不要跟系統預設的 /home 相同位置，否則容易造成本機帳號與網路帳號衝突的狀況)等等。至於一般的架設流程大概是這樣的：

1. 安裝好 LDAP 伺服器軟體，並且提供登入 LDAP 功能的 RootDN 密碼
2. 載入 LDAP 所需要的環境設定參數檔
3. 啟動 LDAP 服務，並觀察 LDAP 服務的埠口，以啟用防火牆放行的功能
4. 預先指定好自己公司即將使用的 baseDN 環境 (最好與 DNS 系統相同即可)，同時規劃好即將要使用的用戶端作業系統有哪些
5. 開始載入基本的 baseDN 功能
6. 開始載入用戶端作業系統所需要的綱要檔 (schema)
7. 嘗試取得用戶端所需要的帳號參數範例檔，變轉為 LDAP 所需要的格式 (LDAP Data Interchange Format, LDIF) ，然後載入到 LDAP 伺服器內
8. 若需要加密環境，請前往 /etc/pki/tls/certs 目錄下進行所需要的 key 建制

​		例題 7.2.A 大致定義出你的 LDAP 頂層與基礎名稱判別： 	

1. 依據你的主機名稱的網域名稱，定義你的 baseDN 為何？
2. 依據上述 baseDN 的指定，定義出管理 RootDN 的管理員密碼為 cn=Manager,(baseDN) (Manager 為管理部份的意思)



### 7.3： LDAP 的實際設定流程

為了避免 Server/client 之間名稱解析產生的連線延遲，因此 IP 對應主機名稱最好還是寫入 /etc/hosts 較佳。所以，先檢查一下你的 Server/client  的設定是否已經正確設定在 /etc/hosts 了呢？基本上，相關的設定在前幾周都已經完成，我們還是來持續檢查一下：

```
[root@localhost ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.254.xxx pcxxx.dic.ksu   pcxxx
192.168.254.254 pc254.dic.ksu   pc254
10.255.xxx.254  server.lanxxx.dic.ksu   server   <==這個項目
10.255.xxx.1    client.lanxxx.dic.ksu   client   <==這個項目
```

上面的設定是相當重要的！這是因為如果我們想要使用加密過後的 LDAP 加密傳輸連線，那麼就得要建立金鑰系統，而金鑰系統裡面會建立一隻憑證， 該憑證就只能使用對應的主機名稱而已！因此，如果我們未來使用的主機名稱無法在這個檔案內找到正確的 IP，那就會無法連線成功的！ 這裡請特別特別留意！否則會出大事情！

​		例題 7.3.A：請注意自己的主機名稱對應資訊 	

- 再次使用 hostnamectl 查看自己的主機名稱
- 再次分析 Server/Client 系統上，針對目前這部主機名稱都可以找到正確的 IP

- Step 1、安裝 LDAP 相關軟體、啟動 slapd 服務以及了解 LDIF 格式與匯入 LDIF 檔案

要能夠執行 LDAP server 至少也需要 openldap-servers, openldap-clients, openldap 等軟體才行～不過，後續我們會用到 Linux 帳號轉成 LDAP 帳號的機制， 那就得要額外安裝 unix 帳號轉 ldap 帳號的轉換腳本 migrationtools 這個軟體才行！

安裝完畢之後，我們就可以啟動一個名為 slapd (standard alone ldap daemon) 的服務，啟動這個服務之後，系統會多出一個 port 389 的埠口喔！ 你應該使用 netstat 去觀察一下該埠口是否順利啟動為宜。同時也要能夠處理防火牆才好。

由於 CentOS 8.2 以後，已經拿掉了以往支援的 openldap-servers 軟體，因此已經無法由官網直接安裝。還好，網際網路上面還有其他公司有提供支援！ 例如底下的公司就是支援 openldap for RHEL 的單位之一。 	

- symas 公司的 openldap：https://symas.com/linuxopenldap/
- repos 安裝方法：https://repo.symas.com/sofl/rhel8/

​		例題 7.3.B：依據上述說明分別完成底下任務： 	

1. 按照上面的第二個連結，安裝好 symas 公司提供的 openldap repository 方式。
2. 按照上面的第二個連結，安裝好 symas-openldap-clients, symas-openldap-servers 這兩個主要的軟體
3. 啟動、開機啟動 slapd 服務，同時觀察一下該服務！
4. 觀察埠口，是否有 port 389 的產生？
5. 觀察防火牆，僅針對內部網路 (10.xxx) 來說，是否還需要額外放行防火牆規則？

因為 LDAP 控制了帳號與密碼等相關資料，因此，要管理這個系統，當然需要管理員的身份。所以，軟體安裝完成之後， 可以透過 openldap 提供的『 slappasswd 』來取得加密後的密碼文字資料，並將加密過後的密碼寫入到設定檔中！那麼設定檔在哪裡呢？ 大部分的設定檔放置在 /etc/openldap/slapd.d/cn=config/ 目錄下，你可以自行查閱相關資訊。 跟整個系統運作比較有關係的僅有『 olcDatabase={2}mdb.ldif 』 『 olcDatabase={1}monitor.ldif 』而已！其他的檔案都暫時不要理他！

```
[root@localhost ~]# ll /etc/openldap/slapd.d/cn=config
drwxr-x---. 2 ldap ldap  29 11月 19 09:18 'cn=schema'
-rw-------. 1 ldap ldap 378 11月 19 09:18 'cn=schema.ldif'
-rw-------. 1 ldap ldap 513 11月 19 09:18 'olcDatabase={0}config.ldif'
-rw-------. 1 ldap ldap 412 11月 19 09:18 'olcDatabase={-1}frontend.ldif'
-rw-------. 1 ldap ldap 562 11月 19 09:18 'olcDatabase={1}monitor.ldif' <==次重要，設定 baseDN
-rw-------. 1 ldap ldap 609 11月 19 09:18 'olcDatabase={2}mdb.ldif'     <==最重要！設定 RooDN,密碼
```

我們可以先觀察一下 olcDatabase={2}mdb.ldif 這個檔案，這個檔案的內容有點像這樣：

```
[root@localhost ~]# cat /etc/openldap/slapd.d/cn\=config/olcDatabase\=\{2\}mdb.ldif
# AUTO-GENERATED FILE - DO NOT EDIT!! Use ldapmodify.  <==警告你不要亂動！
# CRC32 a26ee33b
dn: olcDatabase={2}mdb                                 <==由 dn: 開始規範！
objectClass: olcDatabaseConfig
objectClass: olcMdbConfig
olcDatabase: {2}mdb
olcDbDirectory: /var/lib/ldap
olcSuffix: dc=my-domain,dc=com                         <==這個需要修改
olcRootDN: cn=Manager,dc=my-domain,dc=com              <==這個需要修改
olcDbIndex: objectClass eq,pres
olcDbIndex: ou,cn,mail,surname,givenname eq,pres,sub
structuralObjectClass: olcMdbConfig
entryUUID: e34a08f8-be50-103a-8689-57eb5ce90f91
creatorsName: cn=config
createTimestamp: 20201119011834Z
entryCSN: 20201119011834.415912Z#000000#000#000000
modifiersName: cn=config
modifyTimestamp: 20201119011834Z
```

上面的檔案格式我們稱為 LDAP 的資料交換格式檔 (LDAP Data Interchange Format, LDIF)，基本規則是：



- 撰寫時，以冒號 (:) 隔開節點名稱與相對應的值；
- 冒號左側不能有空白，右側需要保留一個空白後，才填寫資料。
- 每一個節點，都是由 dn: 開頭，且需要完整的寫入該節點 (連同 baseDN 的資料)
- 在 dn 之後寫入你想要影響的項目，然後底下加入所需要的動作或者是資料
- 若資料延伸到第二行，則需要在行首保留一個空白字元
- 最終需要保留一個空白行

如上所述，其實我們的 baseDN (就是那個 olcSuffix) 以及 RootDN 都需要改變！因此接下來要進行的是：

- 先設計出一個 LDIF 格式的檔案；
- 再以 ldapmodify 來匯入該筆紀錄。

如上所述，我們要修改兩個項目，可以使用 basedn.ldif 這樣的檔名來處理即可！另外，請記得我們要改的檔案檔名： /etc/openldap/slapd.d/cn=config/olcDatabase={2}mdb.ldif 其中 cn=config 是上層目錄 (所以寫在後面)，olcDatabase=(2)mdb.ldif 則寫在前面！因此可以這樣來設計：

```
# 進入 ldap 目錄，統一放置 LDAP 相關的資料，保持家目錄的乾淨！
[root@localhost ~]# mkdir ldap
[root@localhost ~]# cd ldap

# 取得 root 管理員的加密密碼文字
[root@localhost ldap]# slappasswd
New password:             <==輸入你的密碼
Re-enter new password:    <==輸入你的密碼
{SSHA}mJnkkDx4NacnPwPkdEQ/a+Fh6WPQEGEM   <==這一段文字複製下來

[root@localhost ldap]# vim basedn.ldif
dn: olcDatabase={2}mdb,cn=config           <==就是這個 dn 的設計！
changetype: modify                         <==動作是修改！
replace: olcSuffix                         <==取代這個項目
olcSuffix: ${basedn}                       <==實際的值！

dn: olcDatabase={2}mdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: ${rootdn}

dn: olcDatabase={2}mdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: ${rootdn_password}

# 開始匯入資料。這個動作可以反覆做不要緊，因為是『取代』的功能！
[root@localhost ldap]# ldapmodify -Y EXTERNAL  -H ldapi:/// -f basedn.ldif
```

當然！上述的 ${basedn} 與 ${rootdn} 是需要實際帶入你的設定值的。最後，因為 RootDN 的管理員最好是需要密碼的，我們可以使用 slappasswd 來設定好加密的密碼， 然後修改上面畫面中的 ${rootdn_password} 項目即可！

​		例題 7.3.C：設定好你的 LDAP 基礎設定如下： 	

1. 建立 LDAP 的系統管理員操作密碼為 2727175，同時將密碼、RootDN, BaseDN 寫入於 basedn.ldif 檔案內

2. 使用『 ldapmodify -Y EXTERNAL  -H ldapi:/// -f basedn.ldif 』匯入 basedn.ldif 的內容，如果一切順利，應該會看到類似底下的輸出：

   ```
   SASL/EXTERNAL authentication started
   SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
   SASL SSF: 0
   modifying entry "olcDatabase={2}mdb,cn=config"
   modifying entry "olcDatabase={2}mdb,cn=config"
   modifying entry "olcDatabase={2}mdb,cn=config"
   ```

3. 修改完成之後，再查詢一下 /etc/openldap/slapd.d/cn=config 內容是否順利修訂成功了。

設定好該項目後，接下來得要修改另一個檔案，那就是 cn=config/olcDatabase={1}monitor.ldif 囉！這個檔案的內容有點像這樣：

```
[root@localhost ldap]# cat /etc/openldap/slapd.d/cn\=config/olcDatabase\=\{1\}monitor.ldif
# AUTO-GENERATED FILE - DO NOT EDIT!! Use ldapmodify.
# CRC32 969d0269
dn: olcDatabase={1}monitor
objectClass: olcDatabaseConfig
olcDatabase: {1}monitor
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=extern
 al,cn=auth" read by dn.base="cn=Manager,dc=my-domain,dc=com" read by * none
structuralObjectClass: olcDatabaseConfig
entryUUID: e34a0218-be50-103a-8688-57eb5ce90f91
creatorsName: cn=config
createTimestamp: 20201119011834Z
entryCSN: 20201119011834.415737Z#000000#000#000000
modifiersName: cn=config
modifyTimestamp: 20201119011834Z
```

如同前面提到的 [LDIF 撰寫格式](https://dic.vbird.tw/linux_server/unit07.php#ldifformat)，上面特殊字體的部份其實是一個名為 olcAccess 的屬性項目，這個屬性項目資料比較長， 因此分兩行來撰寫，第二行就加上一個空白來指定。我們需要整行都複製下來，然後將上面底線的部份修改成為我們自己的 RootDN 即可。 我們可以繼續修改 basedn.ldif 新增一個項目 (雖然如此一來，前面三個資訊會被重複覆蓋就是了！)，該項目內容有點像這樣：

```
dn: olcDatabase={1}monitor,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=extern
 al,cn=auth" read by dn.base="${RootDN}" read by * none
```

然後重複匯入即可！

​		例題 7.3.D：持續設定好你的 LDAP 基礎設定如下： 	

1. 修改 basedn.ldif 檔案，將上述的『 dn: olcDatabase={1}monitor,cn=config 』加入
2. 使用『 ldapmodify -Y EXTERNAL  -H ldapi:/// -f basedn.ldif 』匯入 basedn.ldif 的內容
3. 修改完成之後，再查詢一下 /etc/openldap/slapd.d/cn=config 內容是否順利修訂成功了。

這樣就讓我們的 LDAP 目前擁有正確的 baseDN, RootDN, 管理員密碼等重要的參數設定。上面這些資料都只是在設定 LDAP server 的相關資料， 還沒有進入到 LDAP 的資料庫系統，亦即還沒有實際管理 LDAP 內部的節點資訊喔！

- Step 2、修改資料庫，並載入 cosine, nis 等綱要檔

前一步驟完成了 LDAP server 的設定，現在開始在 LDAP server 裡面建立好資料庫，然後載入我們需要用到的綱要檔 (schema) 囉！ Open LDAP 預設的 /var/lib/ldap/ 目錄管理位置並沒有任何設定檔，所以管理員可以複製 OpenLDAP 提供的預設檔案來使用。

```
[root@localhost ~]# cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
[root@localhost ~]# chown ldap:ldap /var/lib/ldap/DB_CONFIG
```

如前所述，LDAP 僅是一個提供目錄功能的服務，如果需要特定的帳號管理機制，可以透過系統預設提供的綱要檔 (schema) 來處理！ 針對 Linux 帳號常用的綱要檔主要有：

- cosine.ldif
- nis.ldif
- inetorgperson.ldif

這些檔案都放置在 /etc/openldap/schema/ 中，然後需要注意的是，剛剛我們是『修改 LDAP server』內容，所以使用的是 ldapmodify， 但現在是載入不存在 LDAP 內部的綱要檔 (schema)，因此要改用 ldapadd 來進行『新增』的處理才行！處理的方法跟 ldapmodify 很類似：

```
[root@localhost ~]# ldapadd -Y EXTERNAL -H ldapi:/// -f ${filename}
[root@localhost ~]# ldapadd -Y EXTERNAL -H ldapi:/// -f .../nis.ldif
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
adding new entry "cn=cosine,cn=schema,cn=config"  <==一定要看到這行，且沒有錯誤才對！
```

​		例題 7.3.E：完成底下的功能： 	

1. 複製範本資料庫到 /var/lib/ldap 當中，且變更權限
2. 匯入上述的三個綱要檔案，請務必小心，這三個綱要檔載入也有順序之分，要先載入 cosine 才行！

如果一切設定都順利搞定，那麼使用底下的指令查詢時，就會出現成功的樣式！

```
[root@localhost ~]# slaptest -u
config file testing succeeded
```

- Step 3、建置 Linux 帳號系統所需要的節點

完成上述的 LDAP 基礎資訊之後，接下來要處理的就是建置 Linux 帳號所需要的基礎節點了，這部份就需要動到 LDAP 的資料庫。由於 Linux 帳號主要分為  1)帳號與 2)群組，所以我們需要在 LDAP 目錄設定內規範好這兩項資料！ 基本上，我們需要在 base.ldif  這個檔案內宣告好我們所需要的帳號與密碼是在哪個節點上，一般來說，主要的節點會有：

- dn: dc=dic,dc=ksu(最頂層設定) 	
  - dn: cn=Manager,dc=dic,dc=ksu(管理員節點)
  - dn: ou=People,dc=dic,dc=ksu(帳號與密碼)
  - dn: ou=Group,dc=dic,dc=ksu(群組項目)

繪製成為相關圖示，可以是底下這樣。要注意，Manager 這個 RootDN 的目的是在提供管理 LDAP 的管理員身份，所以他會是個特定的節點 (cn 的屬性)， 而 People, Group 則是眾多帳號、群組的節點，因此是單位特性 (ou)，設計上是不一樣的。

```
            dc=dic,dc=ksu  -----------  cn=Manager,dc=dic,dc=ksu
                 |
       -------------------------
       |                       |
   ou=People,dc=dic,dc=ksu   ou=Group,dc=dic,dc=ksu
```

了解了上述的節點功能之後，再來就是要寫成 LDIF 格式，好讓 LDAP server 能夠匯入這些資料到 /var/lib/ldap 的資料庫內。 你可以寫一個名為 base.ldif 的檔案來處理：

```
[root@localhost ldap]# vim base.ldif
dn: dc=dic,dc=ksu
objectClass: top
objectClass: dcObject
objectclass: organization
o: dic ksu
dc: dic

dn: cn=Manager,dc=dic,dc=ksu
objectClass: organizationalRole
cn: Manager
description: Directory Manager

dn: ou=People,dc=dic,dc=ksu
objectClass: organizationalUnit
ou: People

dn: ou=Group,dc=dic,dc=ksu
objectClass: organizationalUnit
ou: Group
```

依據你不同的設定項目，只要修改『 dc=dic,dc=ksu 』這一串數值即可！當然，也能用取代的方式處理掉～總之，最終你要將這個 base.ldif 匯入到你的 LDAP 資料庫才行。 接下來，使用 ldapadd 指令，並且透過管理員密碼的節點來管理，然後匯入的是 ldap 資料庫內！所以，不再是使用 -Y EXTERNAL 的參數喔！ 如下所示，主要在匯入資料庫：

```
[root@localhost ~]# ldapadd -x -W -D "${RootDN}" -f LDIf_filename
[root@localhost ~]# ldapadd -x -W -D "cn=Manager,dc=dic,dc=ksu" -f /root/ldap/base.ldif
```

​		例題 7.3.F：完成底下的功能： 	

1. 依據上面的說明，建置好你的 base.ldif 檔案內容

2. 使用 ldapadd 的功能來匯入這個檔案的內容，若一切順利，應該會看到如下的狀態：

   ```
   [root@localhost ~]# ldapadd -x -W -D "cn=Manager,dc=dic,dc=ksu" -f base.ldif
   Enter LDAP Password:   <==這裡輸入你的 RootDN 密碼！
   adding new entry "dc=dic,dc=ksu"
   adding new entry "cn=Manager,dc=dic,dc=ksu"
   adding new entry "ou=People,dc=dic,dc=ksu"
   adding new entry "ou=Group,dc=dic,dc=ksu"
   ```

- Step 4、設計好 Linux 帳號，並使用該預設帳號轉成範例資訊，以腳本大量建置 LDAP 帳號

如果要手動一個一個輸入 LDAP 帳號，確實有點麻煩！我們能不能將 Linux 帳號轉出來呢？當然可以！這就是重點項目啊！ 不過，要將目前 Linux 帳號的資訊轉成 LDIF 的格式，需要有其他轉換軟體工具的支援才行。目前 CentOS 8.2 已經取消了 migrationtools 的提供， 好消息是，該軟體使用的是 python 的模組，因此不是編譯過後的可執行檔，故可由 CentOS 7 的系統中去獲取軟體即可，底下為相關的網站：

- pkgs.org 網站：https://centos.pkgs.org/
- 站上的 migrationtools：https://centos.pkgs.org/7/centos-x86_64/migrationtools-47-15.el7.noarch.rpm.html

請依據上面第二個連結當中的『 Download 』項目內，取得 Binary Package 的網址列，直接透過 wget 來下載即可：

```
[root@localhost ~]# wget  \
> http://mirror.centos.org/centos/7/os/x86_64/Packages/migrationtools-47-15.el7.noarch.rpm

[root@localhost ~]# yum install ./migrationtools-47-15.el7.noarch.rpm
```

為了擔心本地帳號與網路帳號相互重疊，因此我們可能會有幾個打算：

- 假設使用者名稱為 ldapuser1 ~ ldapuser10
- 預設使用者密碼為 mypassword123 這個密碼
- 假設使用者的 UID 從 6001 開始編號
- 假設使用者的 GID 也是從 6001 開始編號，且有對應的私有群組
- 假設使用者的預設家目錄在 /home/rhome/ 底下

所以我們要先手動處理前一個帳號來交互比對看看：

```
[root@localhost ~]# mkdir /home/rhome
[root@localhost ~]# useradd -d /home/rhome/ldapuser1 -u 6001 ldapuser1
[root@localhost ~]# echo "mypassword123" | passwd --stdin ldapuser1
[root@localhost ~]# id ldapuser1
uid=6001(ldapuser1) gid=6001(ldapuser1) groups=6001(ldapuser1)
[root@localhost ~]# ll /home/rhome
drwx------. 2 ldapuser1 ldapuser1 62 11月 19 10:14 ldapuser1
```

要開始進行 Linux 帳號轉成 LDAP 帳號的腳本之前，得要先修改一下系統預設的 baseDN 設定才行！所以你可能要修改一下底下的幾個位置：

```
[root@localhost ~]# vim /usr/share/migrationtools/migrate_common.ph
$DEFAULT_MAIL_DOMAIN = "dic.ksu";          # 71 行左右
$DEFAULT_BASE = "dc=dic,dc=ksu";           # 74 行左右
$EXTENDED_SCHEMA = 1;                      # 90 行左右
```

處理完畢之後，接下來我們得要將轉換的帳號清理一下～因為我們只想要轉換 ldap 的使用者與群組，因此先將重要資訊抽出來到 /root/ldap 目錄下， 簡易的動作如下：

```
[root@localhost ldap]# grep ldapuser /etc/passwd > user.txt
[root@localhost ldap]# grep ldapuser /etc/group > group.txt
```

最後使用 migrationtools 指令，將帳號與群組轉成 LDIF 格式如下：

```
[root@localhost ldap]# /usr/share/migrationtools/migrate_passwd.pl user.txt > user.ldif
[root@localhost ldap]# /usr/share/migrationtools/migrate_group.pl group.txt > group.ldif
[root@localhost ldap]# cat user.ldif
dn: uid=ldapuser1,ou=People,dc=dic,dc=ksu
uid: ldapuser1
cn: ldapuser1
sn: ldapuser1
mail: ldapuser1@dic.ksu
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}$6$VgCD309ydL0MCTXB$uoq08FV.nuWif4KFa1lBREOi...eT.Uj70b6WJRIHU5.
shadowLastChange: 18585
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 6001
gidNumber: 6001
homeDirectory: /home/rhome/ldapuser1

[root@localhost ldap]# cat group.ldif
dn: cn=ldapuser1,ou=Group,dc=dic,dc=ksu
objectClass: posixGroup
objectClass: top
cn: ldapuser1
userPassword: {crypt}x
gidNumber: 6001
```

雖然接下來只要匯入這兩個檔案就可以建置好 LDAP 的資料，但是我們需要的帳號共有 10 個之多，因此上述的方式實在不太適合。因此， 先不要急著匯入～請改用底下的練習題來處理相關的任務！

​		例題 7.3.G：透過腳本大量建置 LDAP 帳號 	

1. 先將剛剛建立的兩個測試帳號完整的刪除 (userdel -r ...)
2. 寫一隻名為 /root/ldap/adduser.sh 的腳本，在這裡面以迴圈的方式來建置所有帳號所需要的資訊！因為密碼是相同的， 		所以密碼可以複製。不過其他的項目請用變數來處理妥當。 		
   - 規範出最小 UID 與 GID 的號碼，變數定義為 minuid，依據上述設定，此數值應為 6000
   - 規範用戶家目錄為 home 變數，位於 /home/rhome 目錄下 (需要判定目錄存在否)
   - 規範用戶 LDIF 檔名為 /root/ldap/ldapuser.ldif, 群組檔名 /root/ldap/ldapgroup.ldif
   - 建立今日密碼日期，使用 $(( $(date +%s)/60/60/24 + 1 )) 決定
   - 建立迴圈，使用 for i in $( seq 1 100) 建置，內容為： 			
     - 使用者與群組名稱 username 為 ldapuser${i}
     - uid 與 guid 為 userid 數值為 minuid + i 
     - 帶入上述轉換得來的兩個區段內容，將該內容變化，以變數處理之
     - 最終分別帶入兩個檔案中！
     - 複製由 /etc/skel 來的家目錄，請使用 chmod 修改權限為 700，再以 chown uid:uid 的方式以數值的方式來修改正規權限。
3. 可以參考[這裡的連結](https://dic.vbird.tw/linux_server/download/add_ldapuser.html)來參考，但請不要照抄！
4. 記得執行完這個指令會產生 ldapuser.ldif, ldapgroup.ldif 檔案
5. 最後再以『ldapadd -x -W -D "cn=Manager,dc=dic,dc=ksu" -f /root/ldap/ldap{user|group}.ldif』的方式來分別載入帳號、群組資訊。

- Step 5、使用 ldapsearch 檢驗 LDAP 的查詢功能

如果一切順利，在上面的動作完成之後，基本上，我們的 LDAP 就已經完全設定好了。那麼如果我想要根據上述的設定查詢一下是否有問題， 該如何進行呢？簡單的處理方案，可以透過 ldapsearch 來處理。基本的 ldapsearch 語法有點像這樣：

```
# ldapsearch [-x] [-b baseDN] [-W -D "RootDN"] [-H ldap://hostname] [-ZZ] [查詢值] [-d1]
```

上述的選項與參數簡介如下：

- -x ：使用簡易認證，幾乎所有的 ldapsearch 都要使用到這個選項才能順利運作！
- -b baseDN ：如果有不同的幾個 ldapserver 的存在，那需要使用確切的 baseDN 時，才加這個項目。例如我們的環境為 dc=dic,dc=ksu， 	則這個項目會是『 -b "dc=dic,dc=ksu" 』的操作情況。
- -W -D "RootDN" ：如果有需要增加 (ldapadd) 或者是操作資料庫等行為時，才需要使用這個項目，且需要輸入密碼才行。 	以我們為例，那就是『 -W -D "cn=Manager,dc=dic,dc=ksu" 』的操作行為
- -H ldap://hostname ：指定到某個位置去搜尋 LDAP 資料，例如『 -H ldap://127.0.0.1 』這樣的操作。
- -ZZ ：目前用不到，後續步驟才會使用。這個是強迫 ldapsearch 使用加密的 TLS 來處理的意思。
- -d1 ：是偵錯模式，如果你搜尋出問題，加上這個項目，可以得到很多有用的資訊來解釋問題！
- 查詢值 ：例如想要找 ldapuser1 時，可以使用 cn=ldapuser1 之類的方式來處理！

```
# 以明碼方式查詢所有資料庫的內容
[root@localhost ~]# ldapsearch -x -H ldap://127.0.0.1 -b "dc=dic,dc=ksu"
# extended LDIF
#
# LDAPv3
# base <dc=dic,dc=ksu> with scope subtree
# filter: (objectclass=*)       <==這裡顯示所有的資料都要展示出來的意思！
# requesting: ALL
#

# dic.ksu
dn: dc=dic,dc=ksu
objectClass: top
objectClass: dcObject
objectClass: organization
o: dic ksu
dc: dic
....

# 只找出與 uid 為 ldapuser1 的資訊：
[root@localhost ~]# ldapsearch -x -H ldap://127.0.0.1 -b "dc=dic,dc=ksu" uid=ldapuser1
# extended LDIF
#
# LDAPv3
# base <dc=dic,dc=ksu> with scope subtree
# filter: uid=ldapuser1  <==顯示僅有 ldapuser1 的訊息！
# requesting: ALL
#

# ldapuser1, People, dic.ksu
dn: uid=ldapuser1,ou=People,dc=dic,dc=ksu
uid: ldapuser1
cn: ldapuser1
sn: ldapuser1
mail: ldapuser1@dic.ksu
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword:: e2NyeXB0fSQ2JFZnQ0QzMDl5ZEwwTUNUWEIkdW9xMDhGVi5udVdpZjRLRmExbEJ
 SRU9peGZKZVZ0Z1RsWW5Scy5LSjhyNFVONkZTYTRuazN5Mjd4R2RMNFZGZjRwN2JtZVQuVWo3MGI2
 V0pSSUhVNS4=
shadowLastChange: 18585
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 6001
gidNumber: 6001
homeDirectory: /home/rhome/ldapuser1

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1

# 嘗試使用 TLS 的方式查詢
[root@localhost ~]# ldapsearch -x -H ldap://127.0.0.1 -b "dc=dic,dc=ksu" uid=ldapuser1 -ZZ
ldap_start_tls: Protocol error (2)
        additional info: unsupported extended operation
```

你可以發現到，如果使用明碼查詢資料，一切都順暢！但是如果使用 TLS 加密機制查詢，那就出問題了！ 顯示的結果是不支援的延伸參數！這是因為這一版的 LDAP 預設將 TLS 加密支援的設定值取消了！所以，我們需要額外的參數設定才行！ 否則就會發生這個問題。

事實上，如果不需要加密的 LDAP 連線，那麼到目前這個步驟為止，整個 LDAP 就搞定了。但是我們知道 LDAP 的查詢甚至可以傳輸密碼！ 所以當然最好在網路上傳輸得加密比較妥當的！而同時 LDAP server 是可以接受明碼與 TLS 加密傳輸的！因此，底下我們來處理，讓 LDAP 一定要使用加密傳輸才行！

- Step 6、建立 LDAP Server / Client 連線時所需要的公私鑰檔案：

在第六章過後你應該知道什麼是公鑰與私鑰。因為你的 LDAP 會在 Server/client 之間傳送帳號參數與密碼參數，所以，兩者之間當然有加密的效果會比較妥當。 建立的方法可以使用 CentOS 預設提供的金鑰建置方式來處理，也能夠自己使用 openssl 這個指令來處理。因為 openldap 預設的 keys 都放在 /etc/openldap/certs 目錄內， 所以建議你前往該目錄去建置所需要的金鑰檔即可。至於建置的方法如下：

```
[root@localhost ~]# cd /etc/openldap/certs
[root@localhost certs]# openssl req -new -x509 -nodes -out {公鑰檔名}.crt \
> -keyout {私鑰檔名}.key -days 3650
Generating a RSA private key
............................................................................+++++
...........................................+++++
writing new private key to '{私鑰檔名}.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:TW
State or Province Name (full name) []:Tainan
Locality Name (eg, city) [Default City]:Tainan
Organization Name (eg, company) [Default Company Ltd]:ksu
Organizational Unit Name (eg, section) []:dic
Common Name (eg, your name or your server's hostname) []:pc200.dic.ksu
Email Address []:root@pc200.dic.ksu
# hostname 很重要！一定要跟你的主機名稱一致才行！！！

[root@localhost certs]# chown ldap:ldap {公鑰檔名}.crt {私鑰檔名}.key
```

這會建置出一對以 RSA 加密且可以用 10 年不會過期的金鑰系統出來！然後記得這個檔名就是了！



​		例題 7.3.H：使用上述的方式，建立一對金鑰，檔名就指定為 dicksu.{crt|key} 來處理！因此最終你會有一對金鑰。 	

- 憑證： /etc/openldap/certs/dicksu.crt
- 私鑰： /etc/openldap/certs/dicksu.key

​		同時記得，確實要修改這兩個檔案的擁有者之外，也需要重整 SELinux 的類型『 restorecon -Rv /etc/openldap/certs 』喔！ 

接下來繼續將上述兩個檔案加入 /etc/openldap/slapd.d/cn=config.ldif 檔案當中！同時請注意，我們預計讓 LDAP 只支援加密傳輸，而經過上面的 openssl 指令輸出， 我們知道了加密使用 RSA 的方式來處置的！因此就使用底下的 LDIF 格式檔案來修改設定囉！

```
[root@localhost ldap]# vim certs.ldif
# 特別注意，這幾筆紀錄的順序不能改變！一改變就會無法匯入喔！
dn: cn=config
add: olcTLSCACertificatePath
olcTLSCACertificatePath: /etc/openldap/certs

dn: cn=config
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/openldap/certs/dicksu.key

dn: cn=config
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/openldap/certs/dicksu.crt

[root@localhost ldap]# ldapmodify -Y EXTERNAL -H ldapi:/// -f certs.ldif
```

接下來，因為 LDAP 可以支援有加密與未加密的連線，如果我們沒有指定，那麼不論有沒有加密，其連線都會出現在 389 這個埠口。 不過因為我們想要讓用戶不能使用明碼傳輸，因此建議可以讓加密與未加密的連線分開。處理的方式也挺簡單的，確認 /usr/lib/systemd/system/slapd.service 檔案的內容即可：

```
[root@localhost ~]# cat /usr/lib/systemd/system/slapd.service
[Unit]
Description=OpenLDAP Server Daemon
After=syslog.target network-online.target
Documentation=man:slapd
Documentation=man:slapd-config
Documentation=man:slapd-hdb
Documentation=man:slapd-mdb
Documentation=file:///usr/share/doc/openldap-servers/guide.html

[Service]
Type=forking
ExecStartPre=/usr/libexec/openldap/check-config.sh
ExecStart=/usr/sbin/slapd -u ldap -h "ldap:/// ldaps:/// ldapi:///"

[Install]
WantedBy=multi-user.target
Alias=openldap.service

[root@localhost ~]# systemctl restart slapd
[root@localhost ~]# netstat -tlunp | grep slapd
tcp        0      0 0.0.0.0:636             0.0.0.0:*               LISTEN      753/slapd
tcp        0      0 0.0.0.0:389             0.0.0.0:*               LISTEN      753/slapd
tcp6       0      0 :::636                  :::*                    LISTEN      753/slapd
tcp6       0      0 :::389                  :::*                    LISTEN      753/slapd
```

這樣就出現了 636 這個需要連線加密的埠口囉。

​		例題 7.3.I：建立 certs.ldif ，以加入金鑰系統資訊 	

1. 將金鑰憑證系統匯入 LDAP 設定當中： 		
   - 建立 certs.ldif 檔案，將上述的資訊複製進來，然後改寫完整的檔名；
   - 將該檔案匯入系統中 (ldapmodify -Y EXTERNAL -H ldapi:/// -f ...)
   - 查看 /etc/openldap/slapd.d/cn=config.ldif 是否修改成功。
   - 使用 slaptest -u 測試設定檔是否成功。
2. 讓加密與不加密的 LDAP 連線分開，最終重新啟動 slapd 時，會有兩個不同的埠口在監聽。

​		但是，這個時候還不能使用 ldapsearch 來查詢 TLS 的結果喔！還需要進行一些細節的設定才行！ 

- Step 7、讓用戶端可以使用 TLS 連線通道進行查詢

預設 ldapsearch 是透過明碼來傳輸的，如果需要透過 TLS 加密的話，那就得要修改設定檔，讓 ldapsearch 的查詢可以支援憑證的檢查才行。 這個屬於用戶端功能的設定位於 /etc/openldap/ldap.conf 當中，在該檔案內加入這行：

```
[root@localhost ~]# vim /etc/openldap/ldap.conf
TLS_REQCERT allow
```

修改完成後儲存離開，接下來開始查詢一下 port 636 的功能！依舊查詢 ldapuser1 的資訊來看看：

```
[root@localhost ~]# ldapsearch -x -H ldaps://pc200.dic.ksu -b "dc=dic,dc=ksu" uid=ldapuser1
# 1. ...輸出訊息要是正確的 ldapuser1 資訊才行！這邊我省略輸出！....
# 2. 要注意，上面已經變成 ldaps 喔！有個 s 在結尾！

[root@localhost ~]# journalctl | grep slap | tail -n 20
 slapd[27551]: conn=1003 fd=15 ACCEPT from IP=192.168.254.200:42838 (IP=0.0.0.0:636)
 slapd[27551]: conn=1003 fd=15 TLS established tls_ssf=256 ssf=256
 slapd[27551]: conn=1003 op=0 BIND dn="" method=128
 slapd[27551]: conn=1003 op=0 RESULT tag=97 err=0 text=
 slapd[27551]: conn=1003 op=1 SRCH base="dc=dic,dc=ksu" scope=2 deref=0 filter="(uid=ldapuser1)"
 slapd[27551]: <= mdb_equality_candidates: (uid) not indexed
 slapd[27551]: conn=1003 op=1 SEARCH RESULT tag=101 err=0 nentries=1 text=
 slapd[27551]: conn=1003 op=2 UNBIND
 slapd[27551]: conn=1003 fd=15 closed
```

記得查詢的時候使用 ldaps:// 喔！與 ldap:// 比較是多了個 s 的不同！加上 ldaps:// 之後，就不必使用 -ZZ 來強迫啟用 TLS 了！ 因為預設就是會使用 TLS 之意。

- Step 8、伺服器本機也使用 LDAP 作為帳號驗證

一般來說，我們登入 Linux 伺服器的時候，驗證帳號密碼通常是由 /etc/nsswitch.conf 這個檔案的設計來決定登入的方法， 這個登入的方法主要記載了 password 與 shadow 的方式，亦即使用 /etc/passwd 以及 /etc/shadow 作為帳號密碼驗證的來源。

不過，這個方法似乎沒有辦法提供 LDAP 的驗證，因此，CentOS 8 以後建議使用 sssd 這個服務來處理驗證的事宜。 而我們得要安裝適當的軟體才有辦法讓 sssd 服務支援 LDAP 喔！基本需要安裝的軟體有：

```
[root@localhost ~]# yum install sssd sssd-ldap sssd-tools
```

安裝完畢之後，我們就得要重新設定好 sssd 的設定檔，這個設定檔預設是不存在的，所以，我們要自己去建立起這個設定檔。 底下的資料你可以先照抄，之後再做簡單的微調即可：

```
[root@localhost ~]# vim /etc/sssd/sssd.conf
# 針對 sssd 的服務設定，記得 domains 設定要與底下的 [domain/LDAP] 相符合
[sssd]
services = nss, pam
domains = LDAP

[nss]

[pam]

[domain/LDAP]
ldap_id_use_start_tls = true
id_provider = ldap
auth_provider = ldap
# 這裡最重要！需要設定 ldaps 之外，主機名稱必需要寫當初在建立金鑰時的主機名稱！！
ldap_uri = ldaps://pc200.dic.ksu
ldap_search_base = dc=dic,dc=ksu
ldap_tls_reqcert = demand
cache_credentials = true
# 填寫放置金鑰的目錄即可！不需要額外寫憑證檔名！
ldap_tls_cacertdir = /etc/openldap/certs

[root@localhost ~]# sssctl config-check
File ownership and permissions check failed. Expected root:root and 0600.

[root@localhost ~]# ll /etc/sssd/sssd.conf
-rw-r--r--. 1 root root 575 11月 19 14:15 /etc/sssd/sssd.conf

[root@localhost ~]# chmod 600 /etc/sssd/sssd.conf
[root@localhost ~]# sssctl config-check
Issues identified by validators: 0

Messages generated during configuration merging: 0

Used configuration snippet files: 0

[root@localhost ~]# systemctl restart sssd
```

最後檢驗一下，如果出問題的情境都是 0 (如上所示)，那麼就表示應該沒啥大問題了。不過，即使如此， sssd 還是得要透過 ldap 用戶端軟體去查詢！ 因此，我們還是得要回頭去處理 ldap.conf 這個設定檔才行！

```
[root@localhost ~]# vim /etc/openldap/ldap.conf
TLS_REQCERT allow
BASE dc=dic,dc=ksu
URI  ldaps://127.0.0.1
TLS_CACERT /etc/openldap/certs/dicksu.crt

[root@localhost ~]# ldapsearch -x 'uid=ldapuser1'
```

因為我們在 ldap.conf 裡面規範了查詢的主機位置與 baseDN 了，因此查詢時，只要輸入想要查詢的項目即可，其他的參數，系統都會自動幫你帶入！ 接下來，看看 slapd 內容寫了些什麼？看看是否查詢到正確的協定了？

```
[root@localhost ~]# systemctl status slapd
● slapd.service - OpenLDAP Server Daemon
   Loaded: loaded (/usr/lib/systemd/system/slapd.service; enabled; vendor preset: disabled)
   Active: active (running) since Thu 2020-11-19 11:26:32 CST; 3h 3min ago
     Docs: man:slapd
           man:slapd-config
           man:slapd-hdb
           man:slapd-mdb
           file:///usr/share/doc/openldap-servers/guide.html
 Main PID: 27551 (slapd)
    Tasks: 4 (limit: 12505)
   Memory: 16.7M
   CGroup: /system.slice/slapd.service
           └─27551 /usr/sbin/slapd -u ldap -h ldap:/// ldaps:/// ldapi:///

 conn=1027 fd=18 closed
 conn=1028 fd=18 ACCEPT from IP=127.0.0.1:40372 (IP=0.0.0.0:636)
 conn=1028 fd=18 TLS established tls_ssf=256 ssf=256
 conn=1028 op=0 BIND dn="" method=128
 conn=1028 op=0 RESULT tag=97 err=0 text=
 conn=1028 op=1 SRCH base="dc=dic,dc=ksu" scope=2 deref=0 filter="(uid=ldapuser1)"
 <= mdb_equality_candidates: (uid) not indexed
 conn=1028 op=1 SEARCH RESULT tag=101 err=0 nentries=1 text=
 conn=1028 op=2 UNBIND
 conn=1028 fd=18 closed
```

可以確定 ldap.conf 設定內容應該是沒錯了！這時，就準備來讓系統未來的驗證都使用 sssd 這個服務！請使用 authselect 的項目來設定：

```
[root@localhost ~]# authselect select sssd --force
介“sssd“被選中了。
以下nsswitch映射將被配置文件覆蓋：
- passwd
- group
- netgroup
- automount
- services

Make sure that SSSD service is configured and enabled.
 See SSSD documentation for more information.

[root@localhost ~]# authselect current
設定檔 ID：sssd
啟用的功能： 無

[root@localhost ~]# authselect check
目前的組態有效。

[root@localhost ~]# id ldapuser1; id ldapuser2; ..
```

最後如果可以查詢到 ldapuser1 ~ ldapuser10 的帳號存在，而且也能夠順利的使用 su - ldapuser2 ，並在 tty3 以後的終端機， 用這個帳號來順利的登入，那就代表 LDAP 的設定是成功了。

- Step 9、讓用戶端使用 LDAP Server 作為帳號驗證來源之一

用戶端如果也需要用到 server 的 LDAP 服務時，雖然不用安裝 symas-openldap-servers，但是 sssd-ldap 與 symas-openldap-clients 還是得安裝喔！ 否則還是無法取得與 LDPA 的 server 連動的。另外，也需要 openldap 的憑證檔，那個東西也很重要！用來處理連線加密的功能。底下一步一步分別動作。

​		例題 7.3.J：請參考上一個步驟的流程，一步一步處理好你 Client 端的系統。 	

- 再次確認在你的 /etc/hosts 裡面，是否有搭配 LDAP server 的主機名稱了！
- 先安裝 symas-openldap-clients，同樣先下載 repo.conf 檔案，然後才能進行安裝。
- 再安裝所需要的數個軟體，包括 sssd, sssd-ldap, sssd-tools 等
- 用戶端要複製來自 Server 的憑證 (公鑰檔案)，同樣放置在 /etc/openldap/certs 目錄下即可。
- 設定 /etc/sssd/sssd.conf，內容與上一步驟相同即可
- 重新啟動 sssd 服務
- 使用 authselect 選定使用 sssd 為預定的帳號身份驗證協定
- 修改 /etc/openldap/ldap.conf 的內容，與 server 的設定相同，但是 URI 的網址要修改一下。 		改完使用 ldapsearch -x 測試看看即可。
- 最後『 id ldapuser1 』確認用戶存在即可！

透過這長長一大串的資料，你的 LDAP server 現在應該可以順暢的運作了！不論加密還是不加密，LDAP 的查詢應該都沒問題了才對喔！

### 7.4： LDAP 資料庫簡易管理 (新增/刪除/修改用戶參數)

LDAP 管理帳號密碼確實比較麻煩！因為都得要先建立 LDIF 資料後，才有辦法進行匯入的行為，相當麻煩！不過，這也沒辦法！ 就讓我們來了解一下基本的帳號管理方式吧！

- 新增用戶

如果在建置好了 LDAP 系統後，若需要增加其他用戶或群組，那就直接修改 ldapuser.ldif 以及 ldapgroup.ldif 後，再以 ldapadd 加入即可！ 如下的範例可以來持續進行：

```
# 先來建立 ldapuser11 這個帳號與群組的 LDIF 資料，假設檔名為 newuser.ldif
[root@localhost ldap]# vim newuser.ldif
dn: uid=ldapuser11,ou=People,dc=dic,dc=ksu
uid: ldapuser11
cn: ldapuser11
sn: ldapuser11
mail: ldapuser11@dic.ksu
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}$6$VgCD309ydL0MCTXB$uoq08FV.nuWif4KFa1lBREOixfJeVtgT...meT.Uj70b6WJRIHU5.
shadowLastChange: 18585
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 6011
gidNumber: 6011
homeDirectory: /home/rhome/ldapuser11

dn: cn=ldapuser11,ou=Group,dc=dic,dc=ksu
objectClass: posixGroup
objectClass: top
cn: ldapuser11
userPassword: {crypt}x
gidNumber: 6011

# 接著將這個資料匯入 LDAP 資料庫當中！
[root@localhost ldap]# ldapadd -x -W -D 'cn=Manager,dc=dic,dc=ksu' -H ldaps://127.0.0.1 \
> -f newuser.ldif
Enter LDAP Password:
adding new entry "uid=ldapuser11,ou=People,dc=dic,dc=ksu"
adding new entry "cn=ldapuser11,ou=Group,dc=dic,dc=ksu"

[root@localhost ldap]# id ldapuser11
uid=6011(ldapuser11) gid=6011(ldapuser11) groups=6011(ldapuser11)

# 當然還是得要建置用戶的家目錄與相關權限才行！
[root@localhost ldap]# cp -a /etc/skel /home/rhome/ldapuser11
[root@localhost ldap]# chown ldapuser11:ldapuser11 -R /home/rhome/ldapuser11
[root@localhost ldap]# chmod 700 /home/rhome/ldapuser11
```

- 刪除用戶

如果是想要刪除用戶，那直接透過 ldapdelete 來處置即可！

```
# 假設刪除掉 ldapuser8 這個帳號，這個帳號的 dn 為 uid=ldapuser8,ou=People,dc=dic,dc=ksu
[root@localhost ldap]# ldapdelete -x -W -D 'cn=Manager,dc=dic,dc=ksu' -H ldaps://127.0.0.1 \
> uid=ldapuser8,ou=People,dc=dic,dc=ksu
Enter LDAP Password:

[root@localhost ldap]# id ldapuser8
id: ldapuser8: no such user
```

當然啦！那個 /home/rhome/ldapuser8 的使用者家目錄，就得要手動移除才行！

- 修改用戶參數

那如果是想要修改參數呢？舉例來說，想要將 ldapuser1 的密碼由原先的密碼變更為新的密碼，假設密碼為 qqq123ddd 的話，那可以怎麼做呢？簡單的作法如下：

```
# 先取得加密過後的密碼樣式：
[root@localhost ldap]# slappasswd
New password:
Re-enter new password:
{SSHA}RbrP717EPR3XGOtGRMaVvhPiICd5Pi0E

# 開始建立一個名為 changepw.ldif 的檔案，內容如下：
[root@localhost ldap]# vim changepw.ldif
dn: uid=ldapuser1,ou=People,dc=dic,dc=ksu
changetype: modify
replace: userPassword
userPassword: {SSHA}RbrP717EPR3XGOtGRMaVvhPiICd5Pi0E

# 匯入上面這個 LDIF 檔案來更新！
[root@localhost ldap]# ldapmodify -W -D 'cn=Manager,dc=dic,dc=ksu' -H ldaps://127.0.0.1 \
> -f changepw.ldif
Enter LDAP Password:
modifying entry "uid=ldapuser1,ou=People,dc=dic,dc=ksu"
```

在 Server 上面想要確認這個密碼是否生效？可以到 tty2 去使用 ldapuser1 登入就知道了！

### 7.5： 分享檔案系統的 NFS 伺服器

- 什麼是 NFS 與 RPC server

NFS 為 Network Filesystem 的縮寫，主要的目的在於分享伺服器的檔案系統給用戶端使用。但 NFS 主要是架構於 RPC server  底下的一個服務， 因此啟動 NFS 之前，需要啟動 RPC server。事實上檔案系統的運作是相當複雜的，因此過去有所謂的遠端程序呼叫在負責很多 Server/Client  的溝通與資訊傳遞，所以附掛在 RPC 之上的服務，我們就稱為 RPC service 了。

RPC (Remote Procedure Call) 最主要的功能就是在指定每個 NFS 功能所對應的 port number ，並且回報給用戶端，讓用戶端可以連結到正確的埠口上去。 那 RPC 又是如何知道每個 NFS 的埠口呢？這是因為當伺服器在啟動 NFS 時會隨機取用數個埠口，並主動的向 RPC 註冊，因此 RPC 可以知道每個埠口對應的 NFS  功能，然後 RPC 又是固定使用 port 111 來監聽用戶端的需求並回報用戶端正確的埠口， 所以當然可以讓 NFS 的啟動更為輕鬆愉快了！簡單的說：

- NFS 會用到的服務很多，包括 rpc.mountd, rpc.nfsd, rpc.rquotad...，這些服務啟動時，預設為隨機啟動任意埠口。
- 但是 NFS 用戶端是直接連線到上述服務的埠口，因此就需要有一隻總管程式來管理這些服務的埠口
- 這個總管的角色就是 RPC 了！
- CentOS 使用的 RPC server 為 rpcbind 這個服務

![img](https://dic.vbird.tw/images/nfs_rpc.png)

- 用戶端會向伺服器端的 RPC (port 111) 發出 NFS 檔案存取功能的詢問要求；
- 伺服器端找到對應的已註冊的 NFS daemon 埠口後，會回報給用戶端；
- 用戶端瞭解正確的埠口後，就可以直接與 NFS daemon 來連線。

NFS 僅提供檔案系統的分享，本身並不理會帳號的驗證喔！基本上使用 NFS 會有底下的狀況：

![img](https://dic.vbird.tw/images/nfs_auth.png)

由於 server/client 都是用『自己的帳號去看待檔案系統』，但是『檔案系統記載的是 UID/GID 資訊』，因此若 server/client 帳號不同步， 那可能會產生很大的問題。這也是本章前幾個小節要先介紹 LDAP 的主因！

- 簡易的 NFS 設定

NFS 的設定相當簡單！設定檔位於 /etc/exports，該檔案的格式大致為：

```
/dir/path  IP(permission)  network/netmask(permission)
```

/dir/path 指的是你要分享出去的目錄

IP, Network/netmask 的寫法可以是：

- 單獨的IP： 192.168.1.1
- 一整個網段： 192.168.1.0/24
- 可以找到 IP 的主機名稱： station100.dic.ksu

至於常見的權限則有底下幾種：

- rw/ro：可讀寫或唯讀
- sync/async：同步或非同步檔案系統。建議一定要 async ！效能差很多！
- no_root_squash/root_squash：是否壓縮 root 權限，預設為 root_squash
- all_squash, anonuid, anongid：若身份全部壓縮，亦即讓登入者全部變某個匿名者之意。
- insecure：使用非加密的傳輸方式，速度會比較快。

假設我想要分享出 /mnt 給 192.168.254.0/24 唯讀使用，基本寫法就會是： (務必記得， /mnt 得要先存在才行！)

```
/mnt  192.168.254.0/24(ro,async)
```

​		例題 7.5.A：在 server 上，完成如下的設定： 	

- 讓 10.255.XXX.0/24 的整個網段都可以使用 /home/rhome 目錄，且為可讀寫，且為非加密的環境
- 讓 10.255.XXX.0/24 的整個網段都可以使用 /srv/project 目錄，且為可讀寫，且為非加密的環境
- 讓 10.255.XXX.0/24 的整個網段都可以使用 /srv/public 目錄，且為唯讀，且為非加密的環境
- 讓 10.255.XXX.1 的這個 IP 可以使用 /srv/root 目錄，且為可讀寫，且 root 可保有權限，且為非加密的環境
- 上述的目錄均放行一份給 127.0.0.0/8 的整個網段使用
- 建立好 /srv/project /srv/public /srv/root 三個目錄備用

- NFS 服務的啟動與觀察

NFS 目前有兩種服務，一種要加密傳輸一種則是非加密傳輸。本章主要討論區網內使用的非加密傳輸機制～因此啟動的服務名稱就會是 nfs-server， 如果是加密傳輸，則是啟動 nfs-secure-server 才對。

​		例題 7.5.B：進行如下的處理流程： 	

- NFS 提供者為 nfs-utils，請先安裝這軟體才行！
- 啟動 nfs-server 服務，且該服務下次開機也會啟動
- 另外，亦請使用 systemctl 觀察一下 nfs-server 的狀態，如果忘記建置目錄，該狀態會告知！
- 使用 netstat 觀察 nfs 啟動的埠口在幾號？
- 使用 rpcinfo -p 查閱一下各啟動的埠口是否已經跟 rpcbind 註冊了。
- 使用 showmount -e localhost 可以查詢該 Server 分享的目錄與分享的用戶範圍。
- 前往查看 /var/lib/nfs/etab 會得到更詳細的分享的權限參數！

- NFS 用戶端的觀察與使用

用戶端設定很簡單，就只要去查閱伺服器端有沒有提供相對應的服務，然後掛載這樣而已。一般來說，常見的流程會是這樣：

- 在用戶端嘗試使用 showmount -e ServerIP 來看伺服器有沒有提供相關的掛載服務
- 使用 mount -t nfs IP:/share/mount /local/path 來將伺服器的目錄手動掛載到系統上，卸載同樣使用 umount
- 若開機就需要掛載，直接寫入 /etc/fstab 當中，但要注意檔案系統參數 (第四欄位) 要加上『 _netdev 』較佳！

​		例題 7.5.C ：在用戶端電腦完成如下的設定： 	

- 先用 su - ldapuser1 測試用戶能不能取得家目錄？然後 exit 回到 root 身份。
- 嘗試使用 showmount 查詢 server 分享的目錄有哪些？
- 手動嘗試將 Server:/home/rhome 掛載到本機的 /home/rhome 上，測試完畢請卸載
- 將設定值寫入 /etc/fstab 當中，並使用 mount -a 測試
- 使用 nfsstate -m 查閱掛載的詳細參數
- 使用 su - ldapuser1 看看，是否可以取得正確的家目錄與權限。
- 請使用 root 的身份進入 /home/rhome，測試能否建置/修改檔案在該目錄下？

在正規的設定行為中，我們有 LDAP 的 ID 認證，搭配 NFS 的掛載，這樣就已經完成了大部分的需求了！不過未來請注意，關機時， 一定要先關用戶端再關 server，否則擔心 NFS 檔案系統的卸載會影響到你的關機情況。因此，還是建議使用 autofs 來進行登入時的掛載較佳。

- NFS 用戶端的檔案系統自動掛載

其實上學期的網路檔案系統內就有講過了！直接查閱 /etc/auto.master 就能夠想起來如何處理囉！不過，由於 CentOS 8 改用了 sssd 管理各項資料， 因此，我們還是得要額外安裝名為 libsss_autofs 的軟體，提供 sssd 的 API 之後，才能夠順利使用 autofs 喔！

​		例題 7.5.D：處理用戶端的自動掛載行為 	

- 先卸載 /home/rhome，同時取消 /etc/fstab 內的開機掛載項目
- 刪除 /home/rhome 目錄
- 先安裝 autofs, libsss_autofs 軟體，才會有自動掛載的功能！
- 編輯 /etc/auto.master ，加入『 /home/rhome  /etc/auto.rhome 』一行
- 編輯 /etc/auto.rhome，加入『*   -rw,soft   server:/home/rhome/& 』
- 啟動 autofs 服務，並且下次開機這個服務也會啟動
- 再次使用 su - ldapuser1 看看能不能讓系統自動掛載相對的家目錄？
- 使用 nfsstate -m 查詢更多掛載參數。
- (Option)：如果出現失敗，可能要在 /etc/sssd/sssd.conf 裡面的 service 增加 autofs 的項目喔！

- NFS 用戶端的 root 權限保留

我們知道 server 的 /srv/root 是可以使用 root 身份操作系統的。現在請實際實施看看結果為何！

​		例題 7.5.E：使用 root 身份登入 NFS 檔案系統 	

- 建立 /srv/root
- 以手動方式將 server:/srv/root 掛載到本地端的 /srv/root
- 以 root 身份進入 /srv/root，是否可以順利的進行操作？



### 7.6： 課後練習

1. (60%)實作題：啟動 Server 作業硬碟 - unit07	

   1. 網路參數的設定，請依據底下的方式來設定好你的網路環境： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 為外部的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.18.255.*/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.18.255.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 使用 teamd 的機制建立內部區域網路的備援功能： 		

         - team 的界面使用 team0 卡號，且連線名稱請命名為 team0
         - team 使用 activebackup 備援功能，不要使用 loadbalance
         - team 的實體網卡 (team slave) 請使用 ens7 及 ens8 ，且其連線名稱名稱亦請命名為 ens7, ens8
         - team0 網路參數為： 172.19.*.254/24，不需要 gateway 

      4. 主機名稱指定為： server*.example.dic

      5. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 基本的伺服器作業系統設定行為： 	

      1. 使用崑山的 FTP 網站作為你的 YUM server 來源，來源倉儲至少需要涵蓋 BaseOS, AppStream, extras, PowerTools 等， 		並且清除一次 yum 清單快取。(請注意，由於最終系統會全系統升級一次，升級後，這些設定檔可能會被更新。 		因此，你在全部升級完畢之後，還需要回來修改這個設定檔喔！)
      2. 安裝相關的軟體，至少須安裝 vim-enhanced, bash-completion, net-tools, mailx, wget, links, bind-utils,  		kernel-tools, kernel-modules (某些軟體可能需要使用 PowerTools 軟體倉儲安裝喔！但是該軟體倉儲預設需要是不啟用 
      3. 全系統自動升級，且每天凌晨 3 點也會自動升級一次。(請寫入 /etc/crontab 為主)
      4. 將 SELinux 修改成為 Enforcing 模式，且未來每次開機都自動為 Enforcing 才行

   3. 實際設定好本機防火牆 

      1. 請關閉 firewalld 服務，並且自行安裝、啟動 iptables 服務
      2. 將預設的規則轉存到 /root/firewall.sh 這個檔案內
      3. 首先將全部的規則刪除 (應該有三條指令)
      4. 設定好預設政策，讓 INPUT 成為 DROP 而 OUTPUT 與 FORWARD 成為 ACCEPT
      5. 針對 INPUT 前三條規則為 (1)回應封包 (2)放行 lo 界面 (3)放行 icmp 封包
      6. 放行你自己的內部區域網路那個網域的連線要求 (針對 LAN 的信任設定)
      7. 讓 ssh 只對外部的區網放行，不會對 Internet 放行 (對 ssh 連線做限制較佳)
      8. 讓 http 針對整個 Internet 放行 (一般公開的服務設計)
      9. 最後讓確定的規則轉存到 /etc/sysconfig/iptables 這個設定檔
      10. 重新啟動 iptables 服務，然後觀察規則是否正確

   4. 實際設定好 Server 的路由功能 

      1. 讓核心支援 IP 轉遞的功能，並且每次重新開機都可以自動生效
      2. 修改 /root/firewall.sh ，在該檔案加入清除 nat 表格的規則與自訂鏈的設定
      3. 增加規則：讓來自內部網路的封包，在路由判斷後，並預計由 ens3 對外網卡出去的封包，全部偽裝成為 ens3 的 IP 位址 	 (一般在數據機上面的就是 public IP)
      4. 在 /etc/sysconfig/iptables-config 當中增加 nf_nat_ftp 及 nf_conntrack_ftp 模組功能
      5. 上述功能在開機後依舊能夠順利啟動

   5. 建置專屬你區域網路的 LDAP 服務 	

      1. 安裝相關的軟體功能： 		
         - CentOS 8.2 以後，已經拿掉 openldap-servers 等軟體，請查詢到 symas 相關網站， 			由該網站的介紹，直接安裝好軟體倉儲 (repository) 之後，直接安裝該網站提供的 ldap server 與 ldap client 等軟體。
         - 請前往 centos.pkgs.org 網站，查詢 centos 7 的 mirgrationtools 軟體，下載後自行安裝該軟體。
         - 安裝 sssd, sssd-tools, sssd-ldap 等身份認證所需要的軟體
         - 安裝完畢 openldap-server 等軟體之後，請啟動名為 slapd 的服務，並且開機自動啟動。
      2. 修改 LDAP server 的設定檔節點，包括 cn=config 等重要系統節點，完成底下所需要的設定值： 		
         - baseDN 設定為： dc=example,dc=dic
         - RootDN 設定為： cn=Manager,dc=example,dc=dic
         - RootDN 的密碼設定為： 2727175
      3. 因為預計要作為 Linux 的帳號驗證功能，因此請載入與 Linux 帳號相關的三個主要綱要檔 (schema)
      4. 開始設定 LDAP 非關聯性資料庫的資料庫內容： 		規劃的基礎 LDAP 資料庫節點設計中，至少應具有底下的節點存在，請將這些節點匯入到資料庫內： 		
         - dn: dc=example,dc=dic
         - dn: cn=Manager,dc=example,dc=dic
         - dn: ou=People,dc=example,dc=dic
         - dn: ou=Group,dc=example,dc=dic
      5. 建立 10 個 LDAP 所管理的相關帳號，帳號相關資訊如下，請將該資訊匯入 LDAP 資料庫中： 		
         - 假設使用者名稱為 webuser1 ~ webuser10
         - 預設使用者密碼為 webpasswd 這個密碼
         - 假設使用者的 UID 從 8001 開始編號
         - 假設使用者的 GID 也是從 8001 開始編號，且有對應的私有群組
         - 假設使用者的預設家目錄在 /rhome/ 底下
      6. 承上，這 10 個用戶的家目錄亦請自行設定好相關的位置與權限
      7. 由於 sssd 服務僅支援 TLS 等加密機制，因此， LDAP server 必須要完成 TLS 等加密動作， 		否則會讓後續的身份驗證出問題。請使用 TLS 搭配 port 636 來操作，請完成底下工作： 		
         - 成對金鑰系統檔名請設定為 exampledic.crt 與 exampledic.key，建置時，主機名稱的全名必須指定為：  			server*.example.dic 這一個才行！且要求金鑰檔案務必放置於 /etc/openldap/certs 目錄內
         - 匯入金鑰系統時，應該要增加三個金鑰的屬性 (attribute) 到 LDAP 設定檔當中， 			請使用 LDIF 的格式新增這三個屬性 (主要在 cn=config.ldif 檔案中)
         - 啟動 slapd 時，務必讓用戶端可以使用 ldap:/// 以及 ldaps:/// 兩種網址
         - 讓 server 自己可以使用 ldapsearch 查詢 ldaps:/// 的資料
      8. 讓 server 自己使用 LDAP 服務的帳號： 		
         - 選擇 sssd 的身份驗證機制
         - 請依據本章的介紹，自行設定好 /etc/sssd/sssd.conf 內容，並啟用 sssd 服務。
         - 最終使用 id webuser1 ~ id webuser10 會顯示正確的 UID 與 GID 即可。

   6. 建置 NFS 檔案伺服器 	

      1. 讓你的 /rhome 針對你的區域網路分享，權限請設定為可讀寫、不加密。

2. (30%)實作題：啟動 client 作業硬碟 

   1. 網路參數的設定，請依據底下的方式來設定好： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.19.*.1/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.19.*.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 主機名稱指定為： client.lan*.example.dic

      4. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 實際設定好本機防火牆 

      1. 預設請使用 firewalld 防火牆服務，不要使用 iptables 服務！
      2. 請將預設的領域 (zone) 改為 work 領域
      3. 預計放行的服務主要有 ssh 與 http 兩個服務，其他還可能有預設會啟用的 dhcp 用戶端服務。
      4. 查詢 rich rule (man firewalld.richlanguage)，確認來自本機同一個 LAN 網段的封包，通通給予放行。
      5. 上述放行的防火牆服務，在下次重新開機後，依舊會存在才行

   3. 讓你的用戶端主機也能夠支援 LDAP 的帳號驗證，並且使用的是 ldaps:/// 的網址功能 	

      - 需要能夠使用 ldapsearch 等指令，注意需要的軟體有哪些。
      - 需要能夠透過 sssd 查詢來自 server 的 LDAP 資訊

   4. 請使用 autofs 的機制，讓網路用戶登入時，能夠透過 NFS 取得自己的家目錄

3. (10%)簡易問答題： 	從具有 GUI 及中文的用戶端 Linux ，使用『 ssh root@172.19.*.254 』登入你的 Server ，之後建立 /root/ans.txt 的檔案，並將底下各題目的答案寫入你 server 當中！ 

   1. 請說明 LDAP 的 BaseDN, RootDN, RootPW, schema 的意義各為何？
   2. 在 Linux 帳號的 schema 當中，匯入 nis.ldif 之後，應該要有那兩個 ou (organization unit) 的存在。
   3. 在 CentOS 8 上面，架設 LDAP server 與 LDAP client 功能，各需要哪個軟體？
   4. slapd 啟動後，若將 TLS 的連線通道分開，則 ldap:///, ldaps:/// 各預設啟動在哪個埠口？
   5. NFS server 預設啟動在哪個埠口上？可以使用那一個指令觀察 (不是 netstat 喔！)？

4. 上傳成績 

   1. 請將 Server/Client 的硬碟通通啟動，並且確認兩者間的連線沒有問題；
   2. 在 Server 硬碟上面登入，然後用 root 的身份執行 vbird_server_check_unit ，並依據提示資料填寫你的學號與 IP 尾數
   3. 該程式會偵測你的系統，並且通知你哪個部份可能有問題，你需要持續觀察或者重新處理的部份會交代妥當。
   4. 若一切沒問題，螢幕就會出現如下的字樣，然後你就能夠使用 links 去檢查你的檔案是否有順利的上傳了！
   5. Please use links http://172.18.255.250/upload/unit07 to check your filename

### 內容修改紀錄

1. 2021/12/01：在 7.3 的 step8 當中，有個同學說，一直無法順利連線上！狀態是： 

   - ldapsearch 無論加密、未加密，都可以搜尋到 ldapuser1
   - sssd 設定資訊已經完全按照網站上面資料設定妥當
   - 一直無法使用 id ldapuser1 找到這個用戶。

   ​	根據情境，大致上就是判斷 LDAP 沒有問題，有問題的應該是 sssd 吧！使用了 sssctl 查看一下狀態：

   ```
   # sssctl domain-list
   implicit_files
   LDAP
   
   # sssctl domain-status LDAP
   Online status: Offline
   
   Active servers:
   LDAP: not connected
   
   Discovered LDAP servers:
   - pc62.dic.ksu
   ```

   ​	查了好久！竟然發現，原來是最源頭的 /etc/hosts 裡面，沒有將 pc62.dic.ksu 加入而已！會發現可能的問題， 當然就是上面出現 LDAP: not connected 的狀況！最終加上 /etc/hosts 紀錄，重啟動 sssd 之後，就可以順利使用 ldapuser1 囉！

2. 2019/11/13：LDAP 的 TLS 建置中， Key 的匯入順序有差別喔！所以重新修改匯入的順序，[參考這裡](https://dic.vbird.tw/linux_server/unit07.php#20191113)

3. 2020/11/19：LDAP 已經不被 CentOS 8.2 以後支援，請使用 symas.com 公司出版的軟體：https://repo.symas.com/sofl/rhel8/

4. 2020/11/19：大致修改完畢整份資料，已經可以在 CentOS 8 上面順利運作！就剩下硬碟了～

## 網路芳鄰伺服器 (SMB Server)

###### 上次更新日期 2020/12/02

上節課程講到如果需要 Unix 對 Unix 進行檔案系統傳輸，此時可以透過 LDAP 搭配 NFS 來進行。那如果需要的是 Windows 對 Windows 呢？ 當然使用微軟的網芳 (CIFS) 這個玩意兒。那如果需要的是 Windows client 對 Linux Server 呢？那可能就得要 SMB 服務了！ 其實 SMB 就是 Linux 版本的網路芳鄰就是了！可以讓 windows 直接掛載喔！

學習目標

- 了解 NetBIOS, NetBIOS over TCP/IP, Samab, SMB, CIFS 等專有名詞的意思
- 大致的 smb.conf 設定檔內容理解
- smb 服務的啟動與觀察
- smbclient 指令的應用
- 實際掛載 cifs 檔案系統時，使用的 multiuser, sec=ntlmssp, credentials= 等參數的應用
- SELinux 問題解決

- 8.1： 檔案伺服器之網路芳鄰 (windows 網路磁碟機)
- 8.2： Samba 檔案伺服器基礎設定
- 8.3： 共享資源之設定
- 8.4： 其他議題：同一掛載點不同權限與防火牆
- 8.5： 課後練習

### 8.1： 檔案伺服器之網路芳鄰 (windows 網路磁碟機)

大家應該經常聽到『檔案伺服器』，這個玩意兒可以提供用戶端取得檔案來源。那麼有哪些檔案伺服器呢？前一堂課我們聽過了 NFS 了！那接下來還有哪些呢？ 其實經常使用到的檔案伺服器有這些喔：

- 常見的檔案伺服器分類：

1. 非同步的檔案伺服器 (在 Server/client 各保留一份) 	
   - FTP
   - HTTP
2. 同步的檔案伺服器 (只保留在 Server 端，但用戶端看起來就跟本機的檔案系統沒兩樣) 	
   - NFS (Linux <--> Linux)
   - CIFS (Common Internet Filesystem)(Windows <--> Windows)
   - SMB (Server Message Block)：事實上就是 CIFS 囉！透過逆向工程解析出來的一個通訊協定

一般來說，由企業主動提供給其他消費者的，大多使用 FTP 或 HTTP 之類的類型來提供。如果是一般企業內部員工共用的環境，那當然就得要使用同步的檔案伺服器， 這樣檔案才不會有新舊版本造成的困擾。同時檔案集中在 Server 上面，對於企業內部的資安維護來說，也會比較有保障。 同時，我們只要管理好這部 file server 的話，基本上，你的文件資料就有一定程度的保障囉！

- 什麼是網芳與 NetBIOS ？

早期的企業辦公室內部就有檔案分享的問題存在，那時還沒有很方便的隨身硬碟 (USB) 或快閃硬碟，資料的複製常常需要經過軟碟來傳輸， 軟碟傳輸的速度慢，而且軟碟的資料保證很糟糕 (軟碟真的很容易損壞)。因此，許多的 IT 公司都發展了企業辦公室檔案共享的機制。 其中一個使用很廣泛的，就是 Windows 採用的 NetBIOS 這個辦公室內不能跨網域的檔案分享通訊協定。

基本上，NetBIOS 的檔案分享機制是這樣的：

- 區域網路 (LAN) 裡面透過 NetBIOS 的名稱解析功能，任何一部加入 NetBIOS 網域的主機，可以取得每一部網路主機的 NetBIOS 名稱  	(就是 windows 上設定的名稱)，當然，自己的名稱也會被他人取得。
- 每一個具有 NetBIOS 主機名稱的網路主機，就可以直接透過 NetBIOS 進行檔案的傳輸
- 但是 NetBIOS 不能跨路由器 (不可在不同的網段間溝通)
- 早期的 windows (windows 98 以前) 不需要設定 IP 位址也能夠進行網芳溝通，就是透過這個機制！

也就是說，你的 windows 電腦只要啟動了 NetBIOS 協定，並且設定好一個不會與其他人重複的主機名稱，那麼區網內的其他電腦， 就可以透過你的 NetBIOS 分享的目錄，直接掛載使用你的 windows 磁碟機內的資料了。所以， windows 電腦的主機名稱是真的有意義的！

後來微軟將自己開發修改過的 NetBIOS 協定稱為網路檔案分享系統 (Common Internet Filesystem, CIFS)。

- NetBIOS over TCP/IP

因為 NetBIOS 不能跨路由，因此只能在區網內運作。但是後來 Internet 流行了起來，漸漸的每一部主機都會有 IP 位址。 所以後來就有在 Internet 上面開發出支援 NetBIOS 功能的協定，讓 NetBIOS 可以在網際網路上面應用！那就是所謂的『 NetBIOS over TCP/IP 』這個玩意兒。

說穿了， NetBIOS over TCP/IP 就是透過 IP 位址來傳送 NetBIOS 分享的功能，因為使用的是 TCP/IP 的傳送機制，因此就可以跨過路由傳輸！ 讓網路芳鄰 (Windows 網路磁碟機) 的功能更有可看性。

windows 的 CIFS 使用了兩個埠口在進行資料的傳輸，一個是沿用 NetBIOS 的功能，埠口開在 139 ，另一個則是使用 port 445 在傳輸。 目前慣用的傳輸方式為 port 445。

- SMB 以及 Samba 的開發

故事的起源是這樣的，有個博士班學生名為 Andrew Tridgell，這位先生為了自己的學業，因此手邊有幾部不同硬體與作業系統的機器。 但是 Andrew 在資料傳輸時遇到了些困難，因為他沒有辦法在所有機器間共享檔系統。因為比較麻煩的是他手邊的微軟的作業系統， 所以為了解決這個問題，他使用逆向工程去分析出 CIFS 協定的傳輸方式，並自己開發出一個相容於 CIFS 的程式碼， 這個程式碼符合 SMB (Server Message Block) 協定的要求，也可以相容於 CIFS 這個傳輸協定，因此他就可以在不同的機器與作業系統之間進行檔案分享了。

因為 SMB 是有意義的一個通訊協定，所以 Andrew 不能直接使用 SMB 去註冊～但是為了讓自己開發的程式具有 SMB 的特徵， 於是他翻字典找到了 SaMBa 這個舞蹈單字，並對 Samba 進行了註冊。

於是，Samba 是註冊商標、是軟體名稱，但是通訊協定為 SMB，而 CIFS 就是相容於 SMB 的一個通訊協定之一。所以主架構是 SMB， CIFS 與 SAMBA 都相容於 SMB 之意。

- Windows 的網芳 (共享) 功能設定：

一般來說，在 windows 的系統內，可以透過底下的方式來直接分享網芳。不過預設的情況下，只有在同一個網域內的不同電腦才可以通行防火牆， 所以不同的網域基本上也不能加入 windows 的網芳共享檔案的 (除非你知道如何處理 windows 的防火牆)。至於基本設定程序是這樣的：

- 打開檔案總管，移動到你想要分享的目錄上
- 按下右鍵，選擇『共用對象』，選擇『特定人員』
- 選擇『Everyone』指定唯讀
- 最終按下『共用』後，螢幕就會出現你的資料夾共用名稱

如果你共享的目錄名稱為 movies 的話，那麼網路上預設共享的名稱也會是 movies。如果你需要讓這兩個名字不一樣， 那就得要修改資料夾名稱與共用共享名稱 (dir_name 與 share_name)。

- 資料夾共用名稱通常為『 \\netbios_name\share_name 』
- 一般來說，預設 dir_name 會相等於 share_name
- 若需要設定不同的 share_name ，就得要修改囉！也就是說，目錄名稱與共用名稱可以不同！

因為 CIFS 已經支援 Internet 囉，所以取得 server 的可用目錄共享名稱 (share_name) 的方式：

- 檔案總管輸入『 \\IP 』即可
- 檔案總管輸入『 \\對方IP 』即可

​		例題 8.1.A：透過上述的方式，完成底下的設定： 	

- 建立一個名為 D:\myshare 目錄
- 在這個目錄上面設定所有人都唯讀的權限，且分享的名稱為 forshare 
- 承上，也請查閱一下，能否『針對特定用戶』給予權限？
- 在自己的檔案總管上面輸入『 \\127.0.0.1 』查看是否正確的看到一個新的目錄？
- 告知旁邊的同學，請他連線到自己的 IP，是否能夠看到自己分享的目錄？
- 當你登入同學的網芳之後，請寫下該目錄的『網址』為何？
- 嘗試查詢 windows 防火牆： 		
  - 先開啟『網路和共用中心』，查看目前的網路使用的是『工作場所』『家用網路』
  - 同一畫面左側點選『變更進階共用設定』，單純查看不同共用的差別
  - 打開 windows 防火牆，點選左側『進階設定』，再點選左側『輸入規則』，之後查看『輸入規則』的框框， 			往下找到『檔案及印表機共用』的項目，然後拖拉下方的 bar 另其顯示右邊『連機連接埠』的位置，請查看到 TCP port 139 與 445 的項目， 			並請查閱到『遠端位址』的可用範圍是『任何』還是『本機子網路』？
  - 針對 TCP port 445 ，並且針對『私人』的規則，連點兩下，選擇『領域』頁框，查看『遠端 IP 位址』的設定， 			嘗試加入一個 172.31.255.0/24 的網域看看。
  - 同樣的方式，將私人連線的『輸出規則』 port 445 一樣加上 172.31.255.0/24 的輸出。



### 8.2： Samba 檔案伺服器基礎設定

- Samba 提供的服務：

如前所述，Samba 是一個 SMB 協定，且目的是相容於 CIFS 這一個 SMB 協定，而 CIFS 預設會去找 NetBIOS 名稱以及提供檔案分享兩種機制。 所以， Samba 提供的服務就有：

1. smb： 	
   - 就是 Samba 的主要服務，管理分享的目錄、傳輸檔案與身份驗證等等重要功能 (只要這個即可)
   - 因為涉及檔案傳輸，需要 TCP 封包，主要埠口為 port 139, 445
2. nmb： 	
   - 相容於 NetBIOS，會去搜尋區網內的各個 NetBIOS name 來進行網路主機名稱的列表等。
   - 透過 UDP 封包的 port 137, 138 來進行 NetBIOS name 的網路主機名稱搜尋～
   - 如果只是要作為檔案傳輸分享，無須進行網路自動搜尋時，不用啟動這個服務。

- Samba 所需軟體設定檔位置：

完成 Samba 設定所需要的軟體有底下這些：

- samba：主要的 smb, nmb 等服務以及文件檔與開機設定檔等
- samba-client：提供 Samba 用戶端掛載相關的功能，包括查詢 server 分享的資料等指令
- samba-common：提供 server/client 都會使用到的資料，包括設定檔與語法檢驗指令等

至於主要設定檔的檔名是『 /etc/samba/smb.conf 』這一個，而這個設定檔的基本語法是這樣的：

```
[root@localhost ~]# vim /etc/samba/smb.conf
[global]
   參數項目 = 設定內容
   ....

[分享資源名稱]
   參數項目 = 設定內容
   ....
```

​		例題 8.2.A：完成底下題目： 	

- 安裝並檢查 samba 相關的軟體與軟體所含的檔名資料
- 檢查 /etc/samba/smb.conf 以及 /etc/samba/smb.conf.sample 的差異
- 在 smb.conf 底下，預設的中括號 [] 有哪幾個？

- 基礎伺服器設定 [global]

針對 [global] 的設定項目中，需要修改的就是原本範例檔中的資料，大致有這些設定：

- workgroup = 工作群組名稱
- netbios name = 現在預設為主機名稱喔！ (可不設定，預設使用 hostname 的輸出)
- server string = 主機的簡易說明 (可不設定)
- unix charset = 在 Linux 伺服器上面所使用的編碼
- dos charset = 就是 Windows 用戶端的編碼
- security = user 透過 samba 伺服器本身的帳號密碼資料庫

雖然說  dos charset, unix charset 可以指定中文編碼的格式，不過由於目前新版的 Samba 對於編碼的解析已經大有進步， 同時，目前我們的 server/client 大多同時使用 utf8 了，因此上述關於語系的設定可以忽略不理，或者是全部通通設定為 utf8 即可。

​		例題 8.2.B：請設定你的 samba server 有如下的參數： 	

- 工作群組為 dic，主機名稱為 stationXX，主機說明為你的學號
- 所有編碼格式均不須設定
- 使用 testparm 測試設定檔語法是否有問題。若有問題請依據問題解決。

若使用 testparm 之後，發現到系統會顯示『rlimit_max: increasing rlimit_max (1024) to minimum Windows limit (16384)』的問題時， 那可能是 Samba 系統擔心使用者能夠開啟的檔案太小之故。若真的發生這個情況，那你可以使用如下的指令去檢查一般用戶能夠同時開啟的檔案數量：

```
[root@localhost ~]# ulimit -a
[root@localhost ~]# ulimit -n
```

該項目其實就是 『open files』 那個限制值。Samba 希望我們能夠調整成 16384，那如何調整？其實調整 /etc/secirity/limits.conf 內容即可！ 設定的方式如下 (若沒有發生錯誤，就略過這個動作即可)：

```
[root@localhost ~]# vim /etc/security/limits.conf
*  soft  nofile  16384
*  hard  nofile  16384
```

由於 limits.conf 得要重新登入才會生效，因此請你登出 root 之後再登入，重複使用 testparm 就可以發現該錯誤不見了。 此外，如果你有興趣了解所有的 samba 設定值，則改用 testparm -v 來查閱即可。

- 針對一般用戶 [homes] 的設定

照一般正常的思考邏輯，每個人的家目錄均不同啊～因此 dmtsai 會有 dmtsai 的家目錄，而 niki 也有自己的家目錄。 若以 8.1.A 的想法，那麼每個人的家目錄網址應該不同！例如 dmtsai 應該是 \\your_server_name\dmtsai\ 而 niki  則是 \\your_server_name\niki\ 才對！所以，我們的家目錄若針對每個人給予設定，那管理員就崩潰了！

因此除了 [global] 這個全域設定項目的特別特性之外，那個 [homes] 也是特別的設定項目！因為 homes 可以讓任何人取代！ 因此，如果是 dmtsai 登入，那麼中括號其實會變成 [dmtsai]，則分享的網址會主動變成『 \\your_server_name\dmtsai 』 這樣一來，設定就簡單多了！

如果你剛剛已經使用過 testparm，則針對 [homes] 會看到這個項目：

```
[homes]
        comment = Home Directories
        browseable = No
        inherit acls = Yes
        read only = No
        valid users = %S %D%w%S
```

很簡單的看出：

- comment ：該目錄用途的簡易說明
- browseable ：是否允許被瀏覽查詢到該目錄的存在 (只能看到目錄，不是允許登入的意思)
- inherit acls ：是否放行已經設定權限的 ACL 資訊
- read only ：是否為唯讀
- valid users ：能使用此項目的用戶。

那個 valid users 比較特別～怎麼會是 %S 呢？如果你使用 man smb.conf 去查詢就知道！那就代表 [這裡的名字] 的意思～如前所述， [homes] 是特別的名稱，他可以被登入者的帳號所取代，而 %S 則是代表 [] 裡面的名稱之意！所以，當有 dmtsai 這個家目錄存在， 就代表 dmtsai 是允許登入的用戶之意！更多的 %XXX 請參考 man smb.conf 的內容！

​		例題 8.2.C：完成底下的練習： 	

- 確定設定無誤之後，啟動 smb 服務，且該服務下次開機也會自動啟動

- 查詢系統新增的埠口有哪些？

- 使用 smbclient -L //IP 然後直接按下 [enter] 以匿名登入，看看是否啟動了 Samba ？若順利取得 samba 的資訊，應該會看到如下資訊：

  ```
  Enter DIC\root's password:
  Anonymous login successful
  
          Sharename       Type      Comment
          ---------       ----      -------
          print$          Disk      Printer Drivers
          IPC$            IPC       IPC Service (Samba 4.11.2)
  SMB1 disabled -- no workgroup available
  ```

新版的 Samba 以及 windows 10 以後的系統，預設都會將 SMB version1 關閉，僅使用 version2 與 version3 而已。若需要查詢詳細的版本資訊， 可以用底下的方式檢查即可：

```
# testparm -v | grep protocol
Load smb config files from /etc/samba/smb.conf
Loaded services file OK.
Weak crypto is allowed
Server role: ROLE_STANDALONE

Press enter to see a dump of your service definitions

        client ipc max protocol = default
        client ipc min protocol = default
        client max protocol = default
        client min protocol = SMB2_02
        server max protocol = SMB3
        server min protocol = SMB2_02
```

- 放行系統上的用戶使用權

在 8.1.A 的例題中，我們可以針對某個特定的用戶來放行，而『該用戶一定得要存在於系統中』！否則 Windows 無法進行身份的權限給予 (UID/GID...)。 同理， Samba 也是一樣的！你需要注意：

- 由於牽涉到系統的檔案與權限，因此 Samba 的用戶必須是系統的實體用戶
- 但是 Linux 實體用戶與 Samba 的用戶『密碼資料庫並不相同』，因此 Samba 必須要額外製作使用密碼

要設定可以使用 Samba 的用戶也很簡單，我們以已經存在 Linux 的這個 student 帳號來說，要將它加入 samba 的使用權限，直接使用 pdbedit 處理即可。

```
# pdbedit -a -u username                    (建立 Samba 用戶)
# pdbedit -L                                (列出 Samba 用戶)
# pdbedit -x -u username                    (刪除 Samba 用戶)
```

​		例題 8.2.D：建立 alex 讓它可以使用 samba 	

- 以正常方法建立 alex 這個用戶，此用戶無須給予 Linux 密碼

- 讓 alex 可以使用 Samba，且登入 Samba 的密碼為 heyalex

- 使用 pdbedit -L 確認 alex 在 Samba 的使用列表當中

- 使用 smbclient -L //IP -U alex 之後輸入 alex 的密碼，看看能否得到類似如下的畫面：

  ```
  Enter DIC\alex's password:
  
          Sharename       Type      Comment
          ---------       ----      -------
          print$          Disk      Printer Drivers
          IPC$            IPC       IPC Service (Samba 4.11.2)
          alex            Disk      Home Directories
  SMB1 disabled -- no workgroup available
  ```

- 用戶家目錄的掛載與卸載 (含 SELinux 問題處理)

要在 Linux 底下使用 Samba 檔案系統也頗簡單！只要使用 cifs 檔案系統掛載即可！當然，掛載時還得要輸入帳號與密碼才行喔！

​		例題 8.2.E：請在 client 系統端完成底下練習 	

1. 系統可能並沒有安裝 samba-client，所以不見得具有 smbclient 軟體。請安裝該軟體即可。
2. 確認剛剛使用 alex 查詢到的網路磁碟機網址為何？
3. 掛載 SMB 檔案系統，需要有 CIFS 的支援，請找尋 cifs 軟體，並安裝相關的軟體！
4. 使用『 mount -t cifs -o username=alex,passowrd=xxxx 裝置網址 /mnt 』嘗試將 alex 的家目錄掛載到 /mnt 當中
5. 使用 df 確認是否已經掛載
6. 使用 ll /mnt 是否可以查詢到資料？若出現權限不符，嘗試使用 setenforce 0 ，再確認一次，若確實可以查詢到檔案， 		重新 setenforc 1，然後自行處理 SELinux 的相關問題。或者查閱 /etc/samba/smb.conf.example 查閱解決方案。 		(這一小題非常重要！注意流程！)
7. touch /mnt/from_samba ，查看一下權限，然後離開。最終回到 server 端，查看 /home/alex 底下的檔案， 		檢查一下權限為何？為什麼？另外，預設權限會不會太離譜(一般檔案是幾分？)
8. 將上述問題克服之後，請卸載 /mnt 的掛載



### 8.3： 共享資源之設定

除了家目錄之外，samba 還經常用來作為『分享共同的資源』之用！舉例來說，有三個用戶，這三個用戶想共用 /srv/project 時， 那除了本身 /srv/project 需要設定好權限之外，我們讓這三個用戶可以透過 samba 分別從不同的主機連線進來，然後開始大家共用此目錄！ 唯一要注意的大概就是檔案不能同時被多個人開啟這樣而已。

Samba 要分享資源時，大部分會這樣做：

```
[myshare]                                      資源名稱
        comment = Just share my directory      一些簡易說明
        path = /srv/share                      實際放行的目錄
        public = no                            要不要開放訪客進入 (當然不要)
        browseable = yes                       要不要能夠被瀏覽到名稱 (不是查看內容)
        writable = yes                         能否寫入 (smb 控制的)
        create mode = 0664                     建立檔案的預設權限
        directory mode = 0775                  建立目錄的預設權限
        write list = teacher, @teacher         哪個帳號或群組的用戶可以寫入
        valid users = user1, @group1           不是寫入權限，而是能用此資源的人(是否唯讀要看設定)
```

上面設定值當中的 write list 與 valid users 選擇其中一個來設定即可。個人建議使用 valid users 即可喔。 當然，最終能不能寫入還是與 Linux 檔案系統的權限有關的！

​		例題 8.3.A：嘗試建立一個專題組員共用的系統 	

1. 預計建立的三個帳號分別是 std1, std2, std3，預計共同加入的專題組名為 graduation ，而預計共享的目錄在 /srv/myproject。 		請先設計好帳號、群組與目錄之權限等資訊。並請注意，針對 /srv/myproject 目錄，非群組外的其他人不具備任何權限。
2. 在 SELinux 的情境下，Samba 分享的目錄需要具備特別的類型，請依據 /etc/samba/smb.conf.example 的說明， 		解決 SELinux 的類型問題。
3. 透過 samba 分享該目錄，且目錄的預計網址會是：『 //your_server_name/graduation/ 』，在 graduation 群組內的用戶具有完整權限， 		且加入 graduation 即可使用本目錄資源。
4. 讓 std1, std2, std3 均可使用 Samba，且其 Samba 密碼為 heystd1, heystd2, heystd3 。
5. 請前往用戶端，嘗試使用 std3 掛載本目錄，並且將本資源掛載於 /media/data 下，並且測試寫入與讀出等動作。

如果覺得密碼這樣輸入很麻煩，也能透過 standard input 的方式來處理。查詢 pdbedit 的結果，得到 -t 這個參數， 只是，仍然需要輸入兩行！所以，你可以這樣做：

```
# pdbedit -x -u std3
# echo -e "heystd3\nheystd3" | pdbedit -t -a -u std3
```

雖然上述設定之後，未來若有其他用戶要加入該專題，只要 (1)建立新的用戶， (2)將該用戶加入 graduation 群組中， (3)讓該用戶可以使用 Samba， 那麼該用戶就能夠使用 //your_server_name/graduation/ 的資源了。不過，如果有個名為 teacher1 的用戶想要進入該目錄資源『查閱』而已， 僅是查閱而不能寫入喔 (就是僅有 rx 而已)，那該如何處理呢？

​		例題 8.3.B：讓 teacher1 這位老師僅能進入該目錄查閱，不可直接寫入 (意思是，依舊可以下載的意思，只是變成唯讀) 	

1. 建立名為 teaacher1 的帳號，但該帳號不可加入 graduation 群組
2. 讓 teacher1 可以使用 Samba，且密碼為 heyteacher。
3. 在 smb.conf 當中，讓 teacher1 可以使用 graduation 資源！
4. 利用 teacher1 的身份掛載 //your_server_name/graduation 到 /media/teacher ，請確認能否進入該目錄查閱資料？ 		若不行，該如何處理 (注意，需要用到 ACL 喔！)

所以，想要有什麼好的設定，大多還是跟 Linux 傳統的設定有關！基礎學習還是相當重要的喔！

- 在公開檔案 (/etc/fstab) 保障密碼不外流的方式

如果你需要一開機就將上述的資源掛載起來的話，那麼就得要寫入 /etc/fstab 當中！並且將帳號與密碼也都要寫入在第四欄位， 例如這樣的寫法：

```
[root@localhost ~]# vim /etc/fstab
//127.0.0.1/graduation  /media/data  cifs  defaults,username=std3,password=heystd3,_netdev 0 0

[root@localhost ~]# umount /media/data
[root@localhost ~]# mount -a
```

不過如此一來 std3 的帳號與密碼都被看光光了！實在很蠢～你可以使用另一種機制～透過 cifs-utils 這個軟體提供的功能， 在上述的特殊字體部份，使用『 credentials=/root/mountme 』之類的方式來提供另一個檔案儲存帳號與密碼， 然後再以底下的格式來寫入 /root/mountme ，就能夠處理妥當了！

```
username=std3
password=heystd3
```

​		例題 8.3.C：在 client 端完成底下的練習： 	

1. 安裝 cifs-utils，並觀察該軟體提供什麼檔案
2. man mount.cifs 之後，搜尋 credential 這個關鍵字，查出檔案的格式
3. 利用 std3 掛載 //IP/graduation 到 /media/data 去，且將帳密寫在 /root/mountstd3.txt 這個檔案中， 		不要讓帳密出現在 /etc/fstab 當中。



### 8.4： 其他議題：同一掛載點不同權限與防火牆

- 觀察來自 client 的連線狀態 (Server 端功能)

有時候在 Samba server 還是得要知道用戶端的使用情況比較好！最簡單的查詢方式，就是透過 smbstatus 去查看一下即可！ 我們就能夠了解到有哪些用戶端連線進來系統了！

```
[root@localhost ~]# smbstatus

Samba version 4.11.2
PID     Username     Group        Machine                                   Protocol Ver
----------------------------------------------------------------------------------------
1807    std3         std3         10.255.200.1 (ipv4:10.255.200.1:50420)    SMB3_11     

Service      pid     Machine       Connected at                     Encryption   Signing
-----------------------------------------------------------------------------------------
graduation   1807    10.255.200.1  一 11月 30 21時36分35秒 2020 CST -            -
IPC$         1807    10.255.200.1  一 11月 30 21時36分35秒 2020 CST -            -

No locked files
```

- 同一掛載點但是不同帳密登入的方式 (用戶端功能)

想一想，如果你已經用了 root 的身份，然後以 std3 的帳密資訊掛載了 //IP/graduation 到 /media/data 當中， 然後同時 std1 已經登入這部系統，他也想要掛載 graduation 到該目錄下！你要 std1 與 std3 分別使用自己的權限到 /media/data 目錄去工作， 而不需要重複掛載，此時該如何是好？

最簡單的想法，就是在用戶端掛載時，特別加上兩個參數，分別是底下這兩個：

- multiuser ：可以對應使用者給予個別的權限，同時還需要搭配 cifscreds 來處理權限問題才行。
- sec=ntlmssp ：安全模式，提供 multiuser 的參數可以變更權限的密碼測試方式。

因此，請修改 /etc/fstab 成為類似如下的模樣：

```
[root@localhost ~]# vim /etc/fstab
//server/graduation  /media/data  cifs defaults,credentials=/root/mountstd3.txt,_netdev,
	multiuser,sec=ntlmssp 0 0

[root@localhost ~]# umount /media/data/
[root@localhost ~]# mount -a
```

此時 root 登入系統後，進入到 /media/data 時，就會取得 std3 的權限！因為 /root/mountstd3.txt 裡面就是用 std3 的帳號資訊來設定的。 那如果此時 student 登入系統之後，想要使用 std1 的身份時，他該如何是好？他可以這麼做：

```
[student@localhost ~]$ cd /media/data
[student1@localhost data]$ ll
ls: reading directory .: 拒絕不符權限的操作

[student@localhost data]$ cd
[student@localhost ~]$ cifscreds add -u std1 server
Password:  # 這裡輸入 std1 的 samba 密碼喔！

[student@localhost ~]$ ll /media/data
[student@localhost ~]$ touch /media/data/std1

# 回到 root 的身份，來到 server 查看一下狀態！
[root@localhost ~]# smbstatus

Samba version 4.11.2
PID     Username     Group        Machine                                   Protocol Ver
----------------------------------------------------------------------------------------
1817    std1         std1         10.255.200.1 (ipv4:10.255.200.1:50422)    SMB3_11     
1817    std3         std3         10.255.200.1 (ipv4:10.255.200.1:50422)    SMB3_11     

Service      pid     Machine       Connected at                     Encryption   Signing
----------------------------------------------------------------------------------------
IPC$         1817    10.255.200.1  一 11月 30 21時47分47秒 2020 CST -            -
graduation   1817    10.255.200.1  一 11月 30 21時40分01秒 2020 CST -            -
IPC$         1817    10.255.200.1  一 11月 30 21時40分01秒 2020 CST -            -
graduation   1817    10.255.200.1  一 11月 30 21時47分47秒 2020 CST -            -

No locked files
```

你就可以發現確實能夠以自己的帳號來登入該目錄工作了！而且在 server 端也看到同一個 PID 會有不同的帳號來使用，此時不同的帳號身份就能夠用不同的權限來操作該目錄！ 達成多人共用的情況囉！

​		例題 8.4.A：在 client 端完成上述的功能！並且嘗試以不同身份在 /media/data 目錄內操作檔案系統： 	

1. 讓 /media/data 這個掛載點加入 multiuser 以及 sec=ntlmssp 的參數，並讓此參數生效。同時使用『 mount | grep data 』確認該參數已經正確設定。
2. 用 root 的身份去操作 /media/data 這個目錄 (cd /media/data; ll; touch root; ll; rm root; ll)
3. 若曾經使用過 cifscreds 時，請使用『 cifscreds clearall 』清除所有的暫時使用權
4. 用 student 的身份去操作 /media/data 這個目錄 (cd /media/data; ll; touch root; ll; rm root; ll)
5. 用 student 身份，去取得 teacher1 的身份，然後操作 /media/data 這個目錄 (cd /media/data; ll; touch root; ll; rm root; ll)

- 防火牆議題

- 最簡單的方式為透過 iptables 控制 port 139 與 port 445 是否放行即可。
- 另外， smb.conf 裡面也提供了『 hosts allow 』這個設定項目來給予處理。亦即你可以針對內網開放 iptables， 	但可以透過 hosts allow 來指定某個 IP 或某段 IP 的設定喔！

​		例題 8.4.B：在 client 系統中完成下列練習 (未變更 iptables 的情況下) 	

1. (client)詢問你身邊的同學，他的 Server IP 是多少？然後，使用 smbclient -L //IP -u std1 之類的方式，測試是否能夠找到使用的環境？
2. (SERVER)讓外部這個 192.168.254.xxx 的區網也能穿透防火牆來進行連線！
3. (client)再次嘗試 smbclient -L ... 那段指令，若成功，請將 std1 的家目錄掛載到 /media/std1 目錄下
4. (client)掛載成功後，進去 /media/std1 裡面操作一下檔案系統
5. (client)卸載檔案系統。
6. (SERVER)更改設定檔，讓你的 Samba 只能讓你的內部區網還有 127.0.0.0/8 這兩個網段可以使用(外部區網停權)
7. (client)再次嘗試 smbclient -L ... 那段指令，應該要不成功才對喔！



### 8.5： 課後練習

1. (60%)實作題：啟動 Server 作業硬碟 - unit08	

   1. 網路參數的設定，請依據底下的方式來設定好你的網路環境： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 為外部的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.18.255.*/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.18.255.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 使用 teamd 的機制建立內部區域網路的備援功能： 		

         - team 的界面使用 team0 卡號，且連線名稱請命名為 team0
         - team 使用 activebackup 備援功能，不要使用 loadbalance
         - team 的實體網卡 (team slave) 請使用 ens7 及 ens8 ，且其連線名稱名稱亦請命名為 ens7, ens8
         - team0 網路參數為： 172.19.*.254/24，不需要 gateway 

      4. 主機名稱指定為： server*.example.dic

      5. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 基本的伺服器作業系統設定行為： 	

      1. 使用崑山的 FTP 網站作為你的 YUM server 來源，來源倉儲至少需要涵蓋 BaseOS, AppStream, extras, PowerTools 等， 		並且清除一次 yum 清單快取。(請注意，由於最終系統會全系統升級一次，升級後，這些設定檔可能會被更新。 		因此，你在全部升級完畢之後，還需要回來修改這個設定檔喔！)
      2. 安裝相關的軟體，至少須安裝 vim-enhanced, bash-completion, net-tools, mailx, wget, links, bind-utils,  		kernel-tools, kernel-modules (某些軟體可能需要使用 PowerTools 軟體倉儲安裝喔！但是該軟體倉儲預設需要是不啟用 
      3. 全系統自動升級，且每天凌晨 3 點也會自動升級一次。(請寫入 /etc/crontab 為主)
      4. 將 SELinux 修改成為 Enforcing 模式，且未來每次開機都自動為 Enforcing 才行

   3. 實際設定好本機防火牆 

      1. 請關閉 firewalld 服務，並且自行安裝、啟動 iptables 服務
      2. 將預設的規則轉存到 /root/firewall.sh 這個檔案內
      3. 首先將全部的規則刪除 (應該有三條指令)
      4. 設定好預設政策，讓 INPUT 成為 DROP 而 OUTPUT 與 FORWARD 成為 ACCEPT
      5. 針對 INPUT 前三條規則為 (1)回應封包 (2)放行 lo 界面 (3)放行 icmp 封包
      6. 放行你自己的內部區域網路那個網域的連線要求 (針對 LAN 的信任設定)
      7. 讓 ssh 只對外部的區網放行，不會對 Internet 放行 (對 ssh 連線做限制較佳)
      8. 讓 http 針對整個 Internet 放行 (一般公開的服務設計)
      9. 最後讓確定的規則轉存到 /etc/sysconfig/iptables 這個設定檔
      10. 重新啟動 iptables 服務，然後觀察規則是否正確

   4. 實際設定好 Server 的路由功能 

      1. 讓核心支援 IP 轉遞的功能，並且每次重新開機都可以自動生效
      2. 修改 /root/firewall.sh ，在該檔案加入清除 nat 表格的規則與自訂鏈的設定
      3. 增加規則：讓來自內部網路的封包，在路由判斷後，並預計由 ens3 對外網卡出去的封包，全部偽裝成為 ens3 的 IP 位址 	 (一般在數據機上面的就是 public IP)
      4. 在 /etc/sysconfig/iptables-config 當中增加 nf_nat_ftp 及 nf_conntrack_ftp 模組功能
      5. 上述功能在開機後依舊能夠順利啟動

   5. 基本的網芳分享設定 	

      1. 只開放本伺服器的 (1) lo 亦即是 localhost 內部迴圈網路、 (2)連接到 LAN 的內部網域、(3)所有同學伺服器可以互連的那個外部區域網路， 		只有這三個 LAN 可以這部伺服器的 Samba 服務； (hint： 除了 iptables 防火牆，還要記得 Samba 自己的防火牆設定也需要！)
      2. 這部 Samba 的工作群組為 LINUX，而主機名稱使用 stationXX
      3. 讓 alex, dora, vitor 能夠使用網芳取得自己的家目錄，且能夠從遠端掛載使用！ 		這三個帳號的 Linux 密碼是 iamlinux，Samba 密碼都是 mylinux

   6. 專題共享之 Samba 設定 	

      1. alex, dora, vitor 為三個專題組員，他們預計加入群組名稱為 vhost 群組的次要群組支援
      2. 這三個人想要共享 /srv/myvhost 目錄，這三個帳號可以具有完整權限，但非專題組員則沒有任何權限
      3. 這三個人想要使用 Samba 分享資源，分享的目錄就這個 /srv/myvhost，但分享的資源名稱想設定為 vhostdir， 		且這個目錄是可以被瀏覽的，但需要有帳密才能登入！
      4. 另建立一個名為 admin1 的帳號，這個帳號可以唯讀使用 /srv/myvhost，且可以完整使用 /srv/myvhost/toadmin 目錄。
      5. admin1 也可以使用 vhostdir 這個 Samba 資源，且登入密碼為 myadmin。

2. (30%)實作題：啟動 client 作業硬碟 

   1. 網路參數的設定，請依據底下的方式來設定好： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.19.*.1/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.19.*.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 主機名稱指定為： client.lan*.example.dic

      4. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 實際設定好本機防火牆 

      1. 預設請使用 firewalld 防火牆服務，不要使用 iptables 服務！
      2. 請將預設的領域 (zone) 改為 work 領域
      3. 預計放行的服務主要有 ssh 與 http 兩個服務，其他還可能有預設會啟用的 dhcp 用戶端服務。
      4. 查詢 rich rule (man firewalld.richlanguage)，確認來自本機同一個 LAN 網段的封包，通通給予放行。
      5. 上述放行的防火牆服務，在下次重新開機後，依舊會存在才行

   3. Samba 的掛載與使用：
       	本題目標是：讓來自你 server 的 vhostdir 掛載到本機的 /srv/myvhost 目錄下

   4. 1. 在掛載的權限上，預設使用 alex 的帳密掛載上述資源，但帳密請寫入 /root/alex.txt 當中，同時，開機就可以掛載此目錄。
      2. 系統上面有個名為 dora 的帳號 (若帳號不存在，請自己建置) 		另外，當 dora 要使用此目錄時，可以透過 cifscreds 更改自己的認證來登入此系統。

3. (10%)簡易問答題： 	從具有 GUI 及中文的用戶端 Linux ，使用『 ssh root@172.19.*.254 』登入你的 Server ，之後建立 /root/ans.txt 的檔案，並將底下各題目的答案寫入你 server 當中！ 

   1. 早期辦公室達成檔案分享為使用 NetBIOS，這個機制無法跨過路由。(1)後來在這個基礎上面開發出哪個協定，所以它可以跨路由！且(2)使用的 port 又是幾號？
   2. 在 Linux 上面達成 SMB (server message block) 這個協定的軟體為 Samba，Samba 最早的目的是加入微軟開發的哪個協定中以進行檔案分享的？
   3. 承上，所以 (1)Samba 啟動的服務有那兩個？而(2)各服務啟用的 port 又各別是哪種格式 (tcp/udp) 且埠口號碼分別是？
   4. 有個主機名稱為 serverhost，這個主機分享的目錄為 /srv/mydata/ ，而 samba 設定的資源項目為 [checkdata]，請問，在 windows 上面看到的分享網址會是怎麼寫？
   5. 若要掛載來自 server 的裝置，且要加上多人共用該掛載的目錄時，該加上那兩個特別的掛載選項？

4. 上傳成績 

   1. 請將 Server/Client 的硬碟通通啟動，並且確認兩者間的連線沒有問題；
   2. 在 Server 硬碟上面登入，然後用 root 的身份執行 vbird_server_check_unit ，並依據提示資料填寫你的學號與 IP 尾數
   3. 該程式會偵測你的系統，並且通知你哪個部份可能有問題，你需要持續觀察或者重新處理的部份會交代妥當。
   4. 若一切沒問題，螢幕就會出現如下的字樣，然後你就能夠使用 links 去檢查你的檔案是否有順利的上傳了！
   5. Please use links http://172.18.255.250/upload/unit08 to check your filename

## 領域名稱伺服器 (DNS)

###### 上次更新日期 2020/12/16

雖然要連上 Internet 得要使用 TCP/IP，但不論是 IPv4 還是 IPv6 的 IP 位址都是數字與英文的混合資料，對於人腦來說，真的是很難記憶。 因此早期的工程師就透過 /etc/hosts 來進行對應。但是 email 到 web 的火紅程度，讓 server 的數量整個大增，因此 /etc/hosts 無法負荷了！ 所以後來就有分散式設定主機名稱與 IP 對應的 DNS 系統產生！DNS 真是好重要的服務！沒有了它，網際網路基本上就已經是癱瘓的狀態！ 現在讓我們來架設屬於你的 DNS 系統吧！

學習目標

- 理解 DNS 的正解/反解/zone 的意思
- 了解 named.conf 的設定與正解 zone、反解 zone 的設定
- 了解 master/slave DNS server 的設定

- 9.1： Domain Name Service (DNS) 系統
- 9.2： DNS 的階層架構與查詢方向
- 9.3： DNS 伺服器正解與反解的記錄項目 (Resource Record, RR)
- 9.4： 設定不含自身資料庫的 cache only DNS 伺服器
- 9.5： DNS 正解設定
- 9.6： DNS 反解設定
- 9.7： Master/Slave 的設定
- 9.8： 課後練習

### 9.1： Domain Name Service (DNS) 系統

DNS 原始最主要的目的是『透過主機名稱來找到該伺服器的 IP 』，如此一來，人們就可以不用記憶 IP 而只須記憶主機名稱即可。 而主機名稱相對來說就像人名，會比較好記。想想看，你是記憶朋友的名字比較厲害，還是記憶朋友的身份證比較厲害？戶政事務所要找的是身份證號碼， 但是我們要找的是人名，兩者間的對應，對於伺服器來說，就是 DNS 系統了。所以說， DNS 系統就是網際網路的戶政事務所囉。 相關的 DNS 目標為：

- 每部伺服器應該會有一個網路主機名稱
- 且該主機名稱應該要『註冊在這一個 DNS 系統的架構底下』！
- 所以，透過詢問 DNS 系統，就會知道該伺服器的主機名稱對應到的 IP 了！
- 找到 IP 是最重要的目的！

- DNS 的主機命名方式

主機名稱也不是隨便就能命名的！就像您的大名一樣，也不是可以隨便更改的！至少，你的姓氏基本上就是不能變更對吧！一般來說，人名與地址相關的命名方式為：

- 先分區域，包括台北的、高雄的、台南的
- 再分姓氏，姓蔡的、姓邱的、姓林的等等
- 最後才是名字
- 一般 DNS 的寫法與美式姓名比較像，重要的姓氏在後面，名字在前面，所以就會變成： 	
  - 鳥哥.蔡.台南 (住台南的蔡鳥哥)
  - 鳥哥.邱.台北 (住台北的邱鳥哥)
  - 都叫鳥哥，但是因為姓氏與住址不同，而可以找到正確的人名～我們姑且稱之為『完整的人名系統』

網路主機名稱跟上述的系統架構就很像了！你必須要去註冊一個領域名 (姓氏)，你的主機名 (名字) 才能夠讓人家找到正確的地方：

- 所有主機名稱都是從一個『頂層』所延伸出來的，這個頂層也稱為 root，設計上是一個小數點 (.)
- 你可以跟頂層註冊一個姓氏，例如 .tw 這個頂層姓氏
- 然後透過 .tw 自己分配下層領域，例如 .gov.tw, .edu.tw..
- 每個下層姓氏再自己成立所需要的主機名稱，例如 www.gov.tw, www.edu.tw 這兩個政府與教育部的 WWW 伺服器主機名！
- 從主機名稱到最頂層 (www.gov.tw.) 這個完整的主機名稱，就被稱為 FQDN  	(Fully Qualified Domain Name)

這一個大架構其實可以視為分散式『資料庫』系統！因為所有的名字都在個別的 DNS 伺服器當中設定，再透過加入 DNS 系統，讓大家都能查詢的到！ 基本的 DNS 大架構是這樣的：

- 最頂層 (類似根目錄) 基本上有 13 部系統在管理下層的資料連結
- 每一個節點只負責自己所管理註冊的網域，其他網域則會去頂層 (類似根目錄) 尋找關聯點再去往下找。

所以最重要的就是『註冊』囉！就像你生出小孩，得要去戶政事務所報戶口一樣啦！只是有所謂的『授權』功能，讓你也能開小型戶政事務所而已。

- DNS 資料庫的記錄：正解、反解與領域 (zone)

我們經常聽到領域名稱 (domain name) 對吧！那就是 DNS 的基本項目，領域名稱就有點像是你的祖籍姓氏這樣，那主機名稱就有點像是你的名字而已。 不過在查詢的時候，你總是得要查詢到你的『祖籍姓氏』之後，才能查到你吧！就有點像族譜這樣。不過，因為查詢的方式有時會從主機名稱查到 IP， 有時需要從 IP 反查到主機名稱，因此就有一些定義需要了解一下：

- 從主機名稱查詢到 IP 的流程稱為：正解
- 從 IP 反解析到主機名稱的流程稱為：反解
- 在 DNS 伺服器的資料庫設定中，不管是正解還是反解，每個領域的記錄就是一個區域 (zone)

- DNS 伺服器資料庫的類型、權重與同步方式

根據上述的說明，我們知道 DNS 最頂層是由 13 部主機所構成，然後再依據一層一層的註冊來授權下游 DNS 來分別設定屬於自己的族譜 (正反解資料庫)。 另外，由於 DNS 是很重要的服務，因此同一個領域可能會有許多部系統協同服務，以避免單一主機掛掉而導致整個 DNS 記錄資料的損毀。 而為了簡化設定的流程，因此就有所謂的主從 DNS 伺服器。

先來說說 DNS 伺服器的資料庫類型吧：

- hint: 記錄最頂層 (.) 的領域記錄方式，每部 DNS server 都應該要有這個記錄才對
- master: 讓管理員主動或透過管理程式碼主動修改主機名稱與 IP 對應的資料庫內容，該伺服器就是 DNS master。 	並且可以提供 DNS 資料庫給 slave 查詢。
- slave: 與 master 同樣可以管理同一個 domain 的資料庫，但其資料庫的來源為直接從 master 的記錄中同步而取得的

也就是說，全部的 DNS server 應該都要知道最頂天的 . 這個 zone 的類型是獨一無二的 hint 類型，其他的設定則主要是 master 設定。 而為了簡化設定，所以假設你有三部內容需要完全一模一樣的 DNS 伺服器，那麼針對某一個特定的 zone，就可以指定一台為 master， 其他兩台為 slave，你只要手動更新了 master 的資料庫，那麼其他兩部 slave 的 DNS server 就會自動的更新了！問題來了， 那麼 Internet 在查詢你的這個特定的主機名稱時，會先向 master 查詢嘛？其實是這樣的：

- 無論 master 還是 slave ，其所記錄的資料應該是一模一樣
- 在 DNS 系統當中，領域名稱的查詢是『先搶先贏』的狀態，因此每一部 DNS 伺服器的角色在 Internet 上面都是一樣的。

好的，那麼 Master/Slave 資料的同步是如何進行的呢？基本上的流程是這樣的：

- DNS 伺服器，slave 透過分析來自 master 的資料庫序號 (serial number) 判斷是否需要更新，若比  	slave 自己記錄的序號還要大，則更新自己的資料庫，否則就不更新。
- Master 若主動修改過資料庫，通常 DNS 系統會發出訊息告知 slave 來更新資料
- Slave 也會定期去向 master 要求資料庫，並透過上述的序號比對方式來決定是否要更新。

​		例題 9.1.A： 完成底下的練習： 	

1. DNS 最主要的目的是什麼？
2. DNS 最頂層的名稱亦稱為 root，他的代表符號為何？
3. 何謂 domain name, hostname 與 FQDN (可以隨便舉例說明較佳)？
4. 嘗試說明什麼是正解？反解與 zone 
5. DNS 的資料庫記錄中，依據其資料的設定與取得方式，主要分為幾種類型 (type)？



### 9.2： DNS 的階層架構與查詢方向

DNS 的架構是一層一層疊起來的，你可以加入所謂的授權來取得建立 DNS 資料庫的權限。不過，基本上 DNS 的階層架構是有點像底下說明的：

1. 如前所述，DNS 是有階層架構的，而最頂層的稱為 root ，以小數點 (.) 為符號表示。

2. 相關的階層可以使用如下的圖示來解釋：
    	![img](https://dic.vbird.tw/linux_server/images/dns_dot.gif)

3. 除了頂層的 root 之外，第一層 (top level domain, tld) 主要可以分為兩大類： 	

   - 一般最上層領域名稱 (Generic TLDs, gTLD)：例如 .com, .org, .gov 等等
   - 國碼最上層領域名稱 (Country code TLDs, ccTLD)：例如 .tw, .uk, .jp, .cn 等

4. 常見的 gTLD 有底下幾大類：

   | 名稱 | 代表意義         |
   | ---- | ---------------- |
   | com  | 公司、行號、企業 |
   | org  | 組織、機構       |
   | edu  | 教育單位         |
   | gov  | 政府單位         |
   | net  | 網路、通訊       |
   | mil  | 軍事單位         |

- DNS Server 的查詢流程 (由主機名稱找到 IP 的完整程序)

為什麼你隨意指定一台 DNS 伺服器，然後將你要找的主機名稱丟給她，她就能夠幫你找到正確的 IP 呢？這是由於每個查詢大致都是從點 (.) 開始查起， 那就有點像目錄樹的根目錄的功能。然後一個一個經由『授權』的 DNS server 去往下找，就能找到每部 DNS server 自己指定的 zone 了！

1. 一般來說，上層管理者，只會將『查詢權』交辦給下層管理者，這可以稱為『授權』
2. 下層管理者只會記錄自己的主機名稱，只要自己設定完成，全世界立刻生效！有點像分散式系統
3. 由於『授權』與類似『分散式資料庫』系統，因此任何一部 DNS 伺服器，只要能找到 root (.) 的所在， 	就可以找到所有合法的 DNS 主機名稱與 IP 的對應。
4. 透過上述的說明，我們可以簡單的知道 DNS 查詢的流程如下：
    	![img](https://dic.vbird.tw/linux_server/images/dns_search.gif)
5. 可以透過 dig +trace domainname 來查詢『授權』與『記錄』的結果

​		例題 9.2.A：完成底下的練習： 	

1. 最頂層 (tld) 的 DNS 設定，主要分為那兩種項目？
2. 最原本的 6 個 tld 主要是哪幾個？
3. 請使用 dig 追蹤 www.ksu.edu.tw 的授權與設定分別在哪裡？ (追蹤的英文為 trace)
4. 請使用 whois (若沒裝，請自行安裝) 找出 ksu.edu.tw 的相關註冊資料
5. 查詢一下， whois 的資料庫，使用的是那一個埠口？( google 查完，再到 /etc/services 查看)



### 9.3： DNS 伺服器正解與反解的記錄項目 (Resource Record, RR)

既然 DNS server 最重要的項目就是在記錄正解與反解，那麼正反解的資料主要又是記錄於 DNS 資料庫環境下，那麼到底這些資料記錄了哪些東西呢？ 你可以使用 dig 來查詢所有的記錄資料格式，預設就是透過 A 這種記錄！無論如何，基本的記錄格式如下：

```
[domain]   [ttl]          IN [[RR type]  [RR data]]
[待查資料] [暫存時間(秒)] IN [[資源類型] [資源內容]]
```

例如查詢 www.ksu.edu.tw 這部主機的 IP 可以這樣做：

```
[student@localhost ~]$ dig www.ksu.edu.tw

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.62.rc1.el6_9.4 <<>> www.ksu.edu.tw
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 1133
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 3, ADDITIONAL: 4

;; QUESTION SECTION:
;www.ksu.edu.tw.                        IN      A

;; ANSWER SECTION:
www.ksu.edu.tw.         3600    IN      A       120.114.100.101   <==其中一筆資料

;; AUTHORITY SECTION:
ksu.edu.tw.             3600    IN      NS      dns2.ksu.edu.tw.  <==底下的也是喔！
ksu.edu.tw.             3600    IN      NS      dns1.ksu.edu.tw.
ksu.edu.tw.             3600    IN      NS      dns3.twaren.net.

;; ADDITIONAL SECTION:
dns1.ksu.edu.tw.        3600    IN      A       120.114.50.1
dns2.ksu.edu.tw.        3600    IN      A       120.114.150.1
dns3.twaren.net.        590     IN      A       211.79.61.47
dns3.twaren.net.        590     IN      AAAA    2001:e10:5c00:1::47

;; Query time: 0 msec
;; SERVER: 120.114.150.1#53(120.114.150.1)
;; WHEN: Mon Dec  4 15:04:16 2017
;; MSG SIZE  rcvd: 191
```

當 RR type 為 A (Address) 的時候，他的 RR data 就是 IP 位址囉！接下來讓我們來看看常見的 RR 有哪些！

- 正解與反解都需要的記錄項目

正解與反解都需要的項目，大部分都是 Server 需要做的任務！包括記錄 DNS 主管理伺服器的 IP 以及相關 master/slave 更新的序號資料等等。 底下就稍微講解一下各個主要的 RR type：

1. 『NS IP』： name server 的意思，亦即是管理該 domain 的伺服器 IP 位址

2. 『

   SOA servername. admin_email. ( serial refresh retry expire ttl)

    』主要是進行 master/slave  	更新程序的相關資料，用在單一 DNS 設定上面沒啥重要，但是如果有 Master/Slave 搭配，就很重要了！ 	

   - servername：主要管理這個 domain 的 master 伺服器主機名稱
   - admin_email：管理員的 email
   - 序號 (serial)：slave 判斷 master 的資料是新的與否，就是透過這個 serial 號碼。為了避免設定值出錯， 		通常使用的格式為『 YYYYMMDDnn 』
   - 重新更新 (refresh)：多久讓 slave 主動來更新資料庫一次
   - 錯誤嘗試 (retry)： 當前一次更新沒有成功，則在比較短的時間內 (retry) 會嘗試去更新
   - 嘗試錯誤時間 (expire)：如果一直嘗試都沒有成功，則不再嘗試
   - 暫存時間 (ttl, time to live)：若不再嘗試，則多久後此筆記錄應予以刪除
   - 上述的時間範圍應該是這樣的： 		
     - Refresh >= Retry * 2
     - Refresh + Retry < Expire
     - Expire >= Rrtry * 10
     - Expire >= 7Days
   - PS. 不過，一般 DNS 設定時都有範例檔，直接引用範例檔的時間參數就不會出錯了！

​		例題 9.3.A：完成底下的練習： 	

1. 以 dig -t ns ksu.edu.tw 查詢崑山科大的 DNS 伺服器設定為何
2. 以 dig -t soa ksu.edu.tw 查詢崑山科大的 DNS 伺服器設定為何
3. 若將上述兩題改為 www.ksu.edu.tw 這樣的主機名稱，會發生什麼情況？
4. 想一想，為何上述資料使用 ksu.edu.tw 而不是 www.ksu.edu.tw 呢？

由於 NS 與 SOA 都是在設定 domain 的相關事宜，因此你要帶入搜尋的資料，當然就得是要 domain (人類的姓氏，而不是名字) 的意思！

- 正解常見的記錄項目

正解就是從主機名稱找到 IP 的方向，這種正解 zone 常見的設定記錄有：

1. 『A  IP』：記錄該主機名稱或領域的 IP 位址
2. 『AAAA IPv6』：記錄該主機名稱或領域的 IPv6 的位址
3. 『MX 權重數字 hostname』：與 email 有關的設定，可以設定多部 mail gateway，權重數字越小最重要， 	而 hostname 必須要有 IP 才行 (就是要有 A 的對應喔！)！
4. 『CNAME hostname』：有點類似『暱稱』『別名』的意思～

​		例題 9.3.B：完成底下的練習： 	

1. 以 dig  www.ksu.edu.tw 查詢崑山科大的 DNS 伺服器設定為何
2. 以 dig -t mx mail.ksu.edu.tw 查詢崑山科大的 DNS 伺服器設定為何
3. 以 dig tw.yahoo.com 查詢該伺服器的 IP 為何？

- 反解常見的記錄項目

反解則是從 IP 去找到主機名稱。因為網路上的殭屍主機非常的多～一大堆喪屍...正規的服務為了避免被有問題的喪屍主機攻擊，因此會去反解他們的主機名稱！ 如果無法對應，就表示該 IP 可能來自比較疏於管理的 ISP，就很可能被抵擋掉了！常見的反解大概只有這一個：

1. 『PTR hostname』：其實反解大多也只有這個項目！就是某個 IP 對應的主機名稱而已。
2. PS. PTR 就是 pointer 的縮寫！

​		例題 9.3.C：完成底下的練習： 	

- 以 dig 查詢到 www.ksu.edu.tw 的 IP 之後
- 再以 dig -x IP 查詢其反解資料為何？
- 反解的主機名稱主要的設定為何？其 domain name 為何呢？
- 同時觀察反解的 NS 設定為何？這相當的重要！

上面的最後一個練習相當的重要！那是因為反解的 zone 與正解的 zone 不一樣！由於西式姓名的寫法中，右邊出現的名字會比較重要，因此 DNS 的設定也是相同的， 一串主機名稱中，越右邊的名字越重要！代表的範圍越廣～不過，這與我們知道的 IPv4 的設定不同～ IP 位址的設定是如同數字，越右邊的越小～ 兩者的對應不一樣。因此反解為了要加入正解的查詢流程，所以得要將一些數值『反過來寫』，那就是反解 zone 的成因！要很注意！很注意！

### 9.4： 設定不含自身資料庫的 cache only DNS 伺服器

從 DNS 的查詢流程中，我們會知道查詢過的主機名稱會暫存一份到自己的快取中！如果自己沒有設定資料庫，單純拿來穿透防火牆的防線， 這時，這部 DNS 伺服器，就稱為 cache only 的伺服器囉：

1. cache only 僅進行 DNS 代理查詢與將結果快取一份到自身記憶體當中的功能而已。
2. cache only DNS server 也是需要知道 root (.) 的所在，因此依舊需要一個 zone 來紀錄才行！
3. 最頂層 DNS 伺服器的紀錄是公開的資訊，一般 DNS 套件都會主動提供！

- forwarding DNs server

另外，有時候為了簡化 cache only DNS 的設定，連 . 都不用給，直接讓 cache only DNS server 向上一層要求即可！這就是 forwarding DNS srver：

1. 透過更上層 DNS 來代理查詢，而不是自己跑去 root 查詢！
2. 詳細流程有點像這樣：
    	![img](https://dic.vbird.tw/linux_server/images/dns_forwarding.gif)
3. 主要是因為透過上層伺服器代理，因此，甚至完全不需要 zone 來設定 root 的所在！

- CentOS 的 DNS 安裝、設定、啟用與觀察

最早的 DNS 是由柏克萊大學所提出的概念，為了這個概念他們開發了一套軟體，稱為 Berkeley Internet Name Domain，簡稱為 BIND。 所以最終軟體名稱就被稱為 bind 囉！。不過這個 bind 軟體所產生的服務不是叫做 bind 喔！是被稱為 named 呢！

1. DNS 伺服器軟體名稱為 bind (Berkeley Internet Name Domain, BIND)
2. bind 軟體提供一個名為 named 的服務，這個服務的設定檔為 /etc/named.conf
3. 因為 named 經常被攻擊，因此建議安裝 bind-chroot 將 bind 鎖在 /var/named/chroot 目錄內！

​		例題 9.4.A：  	

1. 請安裝 bind, bind-chroot 等相關軟體，
2. 並查詢 bind 所擁有的檔案檔名為何？

接下來請查詢 /etc/named.conf 這個主設定檔，分析一下該檔案內部的預設設定是否如下：

1. 僅開放在 127.0.0.1 這個界面
2. 僅允許本機 (127.0.0.1) 的資料查詢要求
3. 針對整個 Internet 放行 DNS 代理查詢 (recursion) 的功能
4. 載入了 . 的 zone
5. 載入了文件上要求載入的 zone

由於預設只能讓自己找自己，這樣的 DNS 對於區網來說是沒用的～所以當然要設定一下，主要需要修改的項目，請處理如下：

1. 建立一個內部的網域名稱為 mylan，內容包括自己的所有網域；
2. 監聽在所有的界面上
3. 允許回應所有人對本 DNS 伺服器的資料查詢要求
4. 只允許 mylan 網域的 DNS 代理查詢 (recursion-allow {...})
5. 保留載入 root 的 zone
6. 取消其他 zone 的載入

實際設定情況有點像底下這樣：

```
[root@localhost ~]# vim /etc/named.conf
acl mylan { 192.168.254.0/24; 10.255.0.0/16; 127.0.0.0/8; };
options {
        listen-on port 53 { any; };
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        allow-query     { any; };
        allow-recursion { mylan; };
        dnssec-enable yes;
        dnssec-validation yes;
        bindkeys-file "/etc/named.iscdlv.key";
        managed-keys-directory "/var/named/dynamic";
        pid-file "/run/named/named.pid";
        session-keyfile "/run/named/session.key";
};

logging {
        channel default_debug {
                file "data/named.run";
                severity dynamic;
        };
};

zone "." IN {
        type hint;
        file "named.ca";
};
```

設定完畢之後就是啟動與觀察～啟動與觀察的詳細流程請參考底下的流程：

1. 不要啟動 named 而是要啟動 named-chroot 才行！
2. 啟動的埠口應該是在 port 53 才對！
3. 將本機網路設定當中的 DNS server 第一部改成本機 (127.0.0.1) 之後，重新啟動網路 (nmcli, /etc/resolv.conf...)

​		例題 9.4.B：完成底下的練習 	

1. 啟動 named-chroot 服務 (若成功，記得也需要開機啟動！)
2. 觀察 named-chroot 的登錄檔資訊，同步觀察 /var/log/messages 裡面的資料！
3. 使用 mount 觀察一下系統掛載的項目為何
4. 觀察 port 53 是否啟動了？
5. 觀察是否放行全世界 port 53 的查詢功能 (firewall 若沒設定，請設定！)
6. 用自己的 DNS 查詢 www.ksu.edu.tw 的 IP 設定為何？( hint: dig... @...)
7. 承上，再次查詢 www.ksu.edu.tw ，觀察其 ttl 的變化為何？
8. 讓 client 端主機也同步設定第一部 DNS 為 server 的內部 IP ！(若 client 端使用的是 DHCP 服務，請在你 Server 的 DHCP 設定中， 		將 DNS server IP 指向你自己的 IP 位址)

上面的練習相當重要！每次啟動 named-chroot 都需要重新觀察 messages 這個檔案才行！

### 9.5： DNS 正解設定

一般來說，我們如果有大量主機名稱的設定需求，就得要架設 DNS 伺服器。而架設 DNS 伺服器的第一步，就是選擇一個合法授權且沒有人用過的領域名稱 (domain)。 你不知道某個領域名稱有沒有被人註冊？那就前往 ISP 提供的網站去查詢，或自己查詢均可。在台灣，你可以選擇 hinet 的網站來查詢， 如下連結所示：

- https://domain.hinet.net/

在最上方 whois 查詢項目中，選好台灣的頂層領域名，然後輸入你想要的主機名稱，按下 go 之後，螢幕就會告訴你該領域名稱有沒有被使用了。 找到沒有被使用掉的主機名稱，就能夠開始註冊了！

- 建置一個練習用的虛擬 zone 環境

因為我們是用來架設 DNS 練功用的，因此選擇的名稱可以不用符合 DNS 的現有環境。然後搭配我們原先的主機名稱設定，因此設定的 zone 為  lanXX.dic.ksu，幾個基本設定如下：

- ZONE 名稱為 lanXX.dic.ksu
- NS 為 server.lanXX.dic.ksu，且管理員 student@mail.lanXX.dic.ksu
- server.lanXX.dic.ksu: 10.255.XX.254
- client.lanXX.dic.ksu: 10.255.XX.1
- www.lanXX.dic.ksu: CNAME to server.lanXX.dic.ksu
- ftp.lanXX.dic.ksu: CNAME to server.lanXX.dic.ksu
- mail.lanXX.dic.ksu: 10.255.XX.254
- mail.lanXX.dic.ksu: MX ?? mail.lanXX.dic.ksu

- 主設定檔的 zone 參數設定

在 /etc/named.conf 裡面新增一小段設定值：

```
zone "lanXX.dic.ksu" IN {
        type master;
        file "named.lanXX.dic.ksu";
};
```

此段設定值最重要的地方就在指定類型為 master 的資料庫格式，且檔名為 named.lanXX.dic.ksu。這個檔名預設會放在 /var/named 裡面喔！

- 與主設定檔呼應的資料庫檔名設定

在 /var/named/ 新增一個檔案，檔名為 named.lanXX.dic.ksu，檔案內容有點像這樣：

```
$TTL    1D
@       IN SOA  server.lanXX.dic.ksu. student.mail.lanXX.dic.ksu. (
                2016112601 1D 1H 1W 3H )
@       IN NS   server.lanXX.dic.ksu.
server.lanXX.dic.ksu.      IN A            10.255.XX.254

client.lanXX.dic.ksu.      IN A            10.255.XX.1
www.lanXX.dic.ksu.         IN CNAME        server.lanXX.dic.ksu.
ftp.lanXX.dic.ksu.         IN CNAME        server.lanXX.dic.ksu.
mail.lanXX.dic.ksu.        IN A            10.255.XX.254
mail.lanXX.dic.ksu.        IN MX 5         mail.lanXX.dic.ksu.
```

仔細看，當你主機名稱設定具有 FQDN 的全名時，一定要在最後面加上小數點，這代表就是全名，否則就會被視為是一般主機名稱，需要再加上 zone name  才會變成 FQDN 的喔！這個小數點經常會被忘記，故請特別小心在意！

重新啟動 named-chroot 之後，務必要查看 named-chroot 的 status 以及 /var/log/messages 的內容！ 務必要看到所啟動的 zone 與該 zone 的 serial 是正確的才行！ 接下來就是測試了！請使用 dig 測試自己的設定是否正確！每一個紀錄項目都需要查詢！

​		例題 9.5.A：完成底下的練習 	

1. 完成所有正解 A 的 dig 結果
2. 完成正解 NS 的 dig 結果
3. 完成正解 SOA 的 dig 結果
4. 完成正解 MX 的 dig 結果



### 9.6： DNS 反解設定

反解的 zone 名稱與正解不太一樣～請搭配你的 IPv4 區網來建立好你的 zone 資料。一般來說，你可能會有如下的先期設定規劃：

- ZONE 名稱為 XX.255.10.in-addr.arpa
- NS 為 server.lanXX.dic.ksu，且管理員 student@mail.lanXX.dic.ksu
- server.lanXX.dic.ksu: 10.255.XX.254
- client.lanXX.dic.ksu: 10.255.XX.1

- 主設定檔的 zone 參數設定

在 /etc/named.conf 裡面新增一小段設定值：

```
zone "XX.255.10.in-addr.arpa" {
        type master;
        file "named.10.255.XX";
};
```

- 與主設定檔呼應的資料庫檔名設定

在 /var/named/ 新增一個檔案，檔名為 named.10.255.XX，檔案內容有點像這樣：

```
$TTL    1D
@       IN SOA  server.lan100.dic.ksu. student.mail.lan100.dic.ksu. (
                2016112801 1D 1H 1W 3H )
@       IN NS   server.lan100.dic.ksu.
254     IN PTR  server.lan100.dic.ksu.
```

重新啟動 named-chroot 之後，務必要查看 named-chroot 的 status 以及 /var/log/messages 的內容！ 務必要看到所啟動的 zone 與該 zone 的 serial 是正確的才行！ 接下來就是測試了！請使用 dig 測試自己的設定是否正確！每一個紀錄項目都需要查詢！

​		例題 9.6.A：完成底下的練習 	

1. 完成反解 NS 的 dig 結果
2. 完成反解 SOA 的 dig 結果
3. 完成反解 PTR 的 dig 結果



### 9.7： Master/Slave 的設定

一般來說，一部 DNS 伺服器建立完畢後，除非是內部測試用的環境，否則，具有正解/反解 zone 的 DNS 系統，通常建議至少有兩部 DNS 伺服器提供服務， 可以避免由於伺服器暫時無法提供服務，而導致的困擾。另外，無論 master/slave 模式，這兩部伺服器在網際網路上的角色都一樣！ 所謂的 Master / Slave 只是資料庫檔案建立的方式不同而已，這裡要特別再次強調。

由於我們的環境只有同學們自己的 VLAN 而已，因此，以自己的環境建立 master / slave 來架設 DNS 也是可以的。 底下我們將讓自己的 zone 提供給 client 作為另一個 DNS server 來提供服務喔。

- Master DNS Server 的設定：

Master 的 DNS server 設定，我們之前已經設定妥當了，不過，這裡還是需要修訂！原因是，多了一部 DNS 系統來提供協助嘛！ 因此當然需要這個設定值。此外，我們也需要開放 slave DNS 來要求資料才行！先來設計讓 slave DNS 可以到本系統要求資料庫的設計：

```
acl myslave { 10.255.200.0/24; };

zone "lan200.dic.ksu" IN {
        type master;
        file "named.lan200.dic.ksu";
        allow-transfer { myslave; };
};

zone "200.255.10.in-addr.arpa" {
        type master;
        file "named.10.255.200";
        allow-transfer { myslave; };
};
```

接下來到 /var/named 裡面去修改正解檔案，其實只有增加 NS 與相關的設定而已，有點像底下這樣：

```
$TTL    1D
@       IN SOA  server.lan200.dic.ksu. student.mail.lan200.dic.kus. (
                2016112602 1D 1H 1W 3H )
@       IN NS   server.lan200.dic.ksu.
@       IN NS   client.lan200.dic.ksu.
server.lan200.dic.ksu.      IN A            10.255.200.254
client.lan200.dic.ksu.      IN A            10.255.200.1
....
```

同樣修改反解設定，內容有點像這樣：

```
$TTL    1D
@       IN SOA  server.lan200.dic.ksu. student.mail.lan200.dic.ksu. (
                2016112802 1D 1H 1W 3H )
@       IN NS   server.lan200.dic.ksu.
@       IN NS   client.lan200.dic.ksu.
254     IN PTR  server.lan200.dic.ksu.
1       IN PTR  client.lan200.dic.ksu.
```

之後重新啟動 named-chroot，若有問題請依據問題一項一項解決，然後再測試每個設定項目的結果。其實最重要的只有 NS 這個項目， 可以這樣檢查：

```
[root@localhost ~]# dig server.lan200.dic.ksu
....
;; QUESTION SECTION:
;server.lan200.dic.ksu.         IN      A

;; ANSWER SECTION:
server.lan200.dic.ksu.  86400   IN      A       10.255.200.254

;; AUTHORITY SECTION:
lan200.dic.ksu.         86400   IN      NS      server.lan200.dic.ksu.
lan200.dic.ksu.         86400   IN      NS      client.lan200.dic.ksu.

;; ADDITIONAL SECTION:
client.lan200.dic.ksu.  86400   IN      A       10.255.200.1

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: 日 12月 13 23:22:06 CST 2020
;; MSG SIZE  rcvd: 145
```

你會發現多了一個 NS 的設定喔！

- Slave DNS Server 的設定：

現在，來到你的 client 端，亦即是第二個 DNS 伺服器，依據同樣的方式安裝、設定好你的 DNS 伺服器， 讓它準備提供正常的服務！

```
[root@localhost ~]# yum install bind-chroot
[root@localhost ~]# vim /etc/named.conf
acl mylan { 192.168.254.0/24; 10.255.0.0/16; 127.0.0.0/8; };
...
	listen-on port 53 { any; };
	allow-query     { any; };
	allow-recursion { mylan; };
...
[root@localhost ~]# systemctl start named-chroot
[root@localhost ~]# systemctl enable named-chroot

[root@localhost ~]# ll -d /var/named/slaves/
drwxrwx---. 2 named named 6  8月 25 01:31 /var/named/slaves/
```

觀察一下， /var/named/slaves 這個預設的目錄確實可以讓 named 用戶寫入的！所以，現在從 master 處， 準備下載正確的檔案吧！先在 /etc/named.conf 裡面增加兩個新的 zone，分別是這樣的：

```
zone "lan200.dic.ksu" IN {
        type slave;
        file "slaves/named.lan200.dic.ksu";
        masters { 10.255.200.254; };
};

zone "200.255.10.in-addr.arpa" {
        type slave;
        file "slaves/named.10.255.200";
        masters { 10.255.200.254; };
};
```

然後重新啟動 named-chroot 之後，再測試一下有沒有成功的將檔案新增到該目錄下即可。當然啦，Master 的 firewall 請自行處理囉！

### 9.8： 課後練習

1. (60%)實作題：啟動 Server 作業硬碟 - unit09	

   1. 網路參數的設定，請依據底下的方式來設定好你的網路環境： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 為外部的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.18.255.*/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.18.255.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 使用 teamd 的機制建立內部區域網路的備援功能： 		

         - team 的界面使用 team0 卡號，且連線名稱請命名為 team0
         - team 使用 activebackup 備援功能，不要使用 loadbalance
         - team 的實體網卡 (team slave) 請使用 ens7 及 ens8 ，且其連線名稱名稱亦請命名為 ens7, ens8
         - team0 網路參數為： 172.19.*.254/24，不需要 gateway 

      4. 主機名稱指定為： server*.example.dic

      5. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 基本的伺服器作業系統設定行為： 	

      1. 使用崑山的 FTP 網站作為你的 YUM server 來源，來源倉儲至少需要涵蓋 BaseOS, AppStream, extras, PowerTools 等， 		並且清除一次 yum 清單快取。(請注意，由於最終系統會全系統升級一次，升級後，這些設定檔可能會被更新。 		因此，你在全部升級完畢之後，還需要回來修改這個設定檔喔！)
      2. 安裝相關的軟體，至少須安裝 vim-enhanced, bash-completion, net-tools, mailx, wget, links, bind-utils,  		kernel-tools, kernel-modules (某些軟體可能需要使用 PowerTools 軟體倉儲安裝喔！但是該軟體倉儲預設需要是不啟用 
      3. 全系統自動升級，且每天凌晨 3 點也會自動升級一次。(請寫入 /etc/crontab 為主)
      4. 將 SELinux 修改成為 Enforcing 模式，且未來每次開機都自動為 Enforcing 才行

   3. 實際設定好本機防火牆 

      1. 請關閉 firewalld 服務，並且自行安裝、啟動 iptables 服務
      2. 將預設的規則轉存到 /root/firewall.sh 這個檔案內
      3. 首先將全部的規則刪除 (應該有三條指令)
      4. 設定好預設政策，讓 INPUT 成為 DROP 而 OUTPUT 與 FORWARD 成為 ACCEPT
      5. 針對 INPUT 前三條規則為 (1)回應封包 (2)放行 lo 界面 (3)放行 icmp 封包
      6. 放行你自己的內部區域網路那個網域的連線要求 (針對 LAN 的信任設定)
      7. 讓 ssh 只對外部的區網放行，不會對 Internet 放行 (對 ssh 連線做限制較佳)
      8. 讓 http 針對整個 Internet 放行 (一般公開的服務設計)
      9. 最後讓確定的規則轉存到 /etc/sysconfig/iptables 這個設定檔
      10. 重新啟動 iptables 服務，然後觀察規則是否正確

   4. 實際設定好 Server 的路由功能 

      1. 讓核心支援 IP 轉遞的功能，並且每次重新開機都可以自動生效
      2. 修改 /root/firewall.sh ，在該檔案加入清除 nat 表格的規則與自訂鏈的設定
      3. 增加規則：讓來自內部網路的封包，在路由判斷後，並預計由 ens3 對外網卡出去的封包，全部偽裝成為 ens3 的 IP 位址 	 (一般在數據機上面的就是 public IP)
      4. 在 /etc/sysconfig/iptables-config 當中增加 nf_nat_ftp 及 nf_conntrack_ftp 模組功能
      5. 上述功能在開機後依舊能夠順利啟動

   5. 建立一個 DNS 服務 	

      1. 請使用 named-chroot 服務，不要使用 named 服務。
      2. 關於 DNS 的整體設定方面，底下的設定請修改掉： 		
         - DNS 需要針對所有的界面監聽服務
         - DNS 服務必須要放行給全世界來查詢 (allow-query)
         - DNS 僅有你的兩段區網與 127.0.0.0/8 才可以代詢 (allow-recursion)
      3. 設定一個正解 zone 為 lan*.example.dic，相關設定須有底下的記錄： 		
         - 這個 zone 允許 172.19.*.0/24 的來源進行更新
         - TTL 需要設定為 600 秒
         - SOA 的設定中， 伺服器名為 server.lan*.example.dic， email 需為 student@server.lan*.example.dic，序號需為當日的日期相關， 			其他請自由設定
         - NS 需要設定使用 server.lan*.example.dic 與 client.lan*.example.dic 這兩部主機
         - server.lan*.example.dic 的 A 為 172.19.*.254
         - client.lan*.example.dic 的 A 為 172.19.*.1
         - pc2.lan*.example.dic 的 A 為 172.19.*.2
         - pc3.lan*.example.dic 的 A 為 172.19.*.3
         - pc4.lan*.example.dic 的 A 為 172.19.*.4
         - www.lan*.example.dic, ftp.lan*.example.dic, web.lan*.example.dic 都使用 CNAME 對應到 server.lan*.example.dic
      4. 針對 172.19.*.0/24 的網域設定一個反解的 zone，相關設定須有底下的記錄： 		
         - 這個 zone 允許 172.19.*.0/24 的來源進行更新
         - TTL, SOA, NS 均沿用與上述正解相同的設定
         - 172.19.*.254 對應到 server.lan*.example.dic
         - 172.19.*.1 對應到 client.lan*.example.dic
         - 172.19.*.2 對應到 pc2.lan*.example.dic
         - 172.19.*.3 對應到 pc3.lan*.example.dic
         - 172.19.*.4 對應到 pc4.lan*.example.dic
      5. 防火牆需要放行所有的人都能使用你的 DNS 
      6. 讓你這部 Server 可以使用自己的 IP 作為 DNS 服務的來源設定 (nmcli...)。

2. (30%)實作題：啟動 client 作業硬碟 

   1. 網路參數的設定，請依據底下的方式來設定好： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.19.*.1/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.19.*.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 主機名稱指定為： client.lan*.example.dic

      4. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 實際設定好本機防火牆 

      1. 預設請使用 firewalld 防火牆服務，不要使用 iptables 服務！
      2. 請將預設的領域 (zone) 改為 work 領域
      3. 預計放行的服務主要有 ssh 與 http 兩個服務，其他還可能有預設會啟用的 dhcp 用戶端服務。
      4. 查詢 rich rule (man firewalld.richlanguage)，確認來自本機同一個 LAN 網段的封包，通通給予放行。
      5. 上述放行的防火牆服務，在下次重新開機後，依舊會存在才行

   3. 架設一個 slave DNS 伺服器 	

      1. 請使用 named-chroot 服務，不要使用 named 服務。
      2. 關於 DNS 的整體設定方面，底下的設定請修改掉： 		
         - DNS 需要針對所有的界面監聽服務
         - DNS 服務必須要放行給全世界來查詢 (allow-query)
         - DNS 僅有你的兩段區網與 127.0.0.0/8 才可以代詢 (allow-recursion)
      3. 設定一個正解 zone 為 lan*.exmpale.dic，相關設定為： 		
         - 其 master DNS 來源請設定為 172.19.*.254
      4. 針對 172.19.*.0/24 的網域設定一個反解的 zone，相關設定為： 		
         - 其 master DNS 來源請設定為 172.19.*.254
      5. 防火牆需要放行所有的人都能使用你的 DNS 
      6. 讓你這部 Server 可以使用自己的 IP 作為 DNS 服務的來源設定 (nmcli...)。

3. (10%)簡易問答題： 	從具有 GUI 及中文的用戶端 Linux ，使用『 ssh root@172.19.*.254 』登入你的 Server ，之後建立 /root/ans.txt 的檔案，並將底下各題目的答案寫入你 server 當中！ 

   1. 以崑山科大的 www.dic.ksu.edu.tw 為例，說明何為 hostname, domain name 與 FQDN？
   2. 嘗試說明什麼是正解？反解與 DNS 的 zone
   3. DNS 的資料庫記錄中，依據其資料的設定與取得方式，主要分為幾種類型 (type)？
   4. 在 DNS 資料查詢中，主要的查詢會是向 master DNs 還是 slave DNS 做要求？
   5. 最原本的 6 個 gTLD 主要是哪幾個？每個 gTLD 最早是給什麼單位使用的？

4. 上傳成績 

   1. 請將 Server/Client 的硬碟通通啟動，並且確認兩者間的連線沒有問題；
   2. 在 Server 硬碟上面登入，然後用 root 的身份執行 vbird_server_check_unit ，並依據提示資料填寫你的學號與 IP 尾數
   3. 該程式會偵測你的系統，並且通知你哪個部份可能有問題，你需要持續觀察或者重新處理的部份會交代妥當。
   4. 若一切沒問題，螢幕就會出現如下的字樣，然後你就能夠使用 links 去檢查你的檔案是否有順利的上傳了！
   5. Please use links http://172.18.255.250/upload/unit09 to check your filename

## 網頁伺服器 (Web Server) + FTP

###### 上次更新日期 2020/12/21

目前一般企業想到的『架站』通常就是架設一個 WWW (Web) 網站！這樣的網站格式主要又分為兩大陣營，其中使用率較高的就是 Linux 陣營！ 我們這裡會介紹目前 Linux 上預設的網頁伺服器，就是名為 Apache 的伺服器！快來玩玩！

學習目標

- 了解基礎的 LAMP 網頁伺服器結構
- Apache 的設定檔、主網頁目錄、入口網頁檔名的理解等
- 使用者家目錄 userdir.conf 的設定
- 一般目錄特殊權限的設定
- 加入 https 埠口的支援

- 10.1： WWW 簡介
- 10.2： Apache 基礎安裝與使用
- 10.3： 常見的進階應用
- 10.4： 網頁目錄的瀏覽控制
- 10.5： 使用 https 瀏覽
- 10.6： 課後練習

### 10.1： WWW 簡介

Web 最早是由 Tim Berners-Lee 爵士為了分享他實驗室的成果而開發出來的一個協定，使用的是 HTML 語法搭配 URL 網址列，就可以快速的取得資料。 再透過超連結的互相連結，讓 Web 在 1990 年代後期就開始熱門起來。為了讓資料有地方可以擺放，當然就需要 Server 提供正確的位址， 因此 Tim Berners-Lee 爵士撰寫出第一個網頁伺服器，稱為 httpd。

因為人腦對於數字的記憶比不上人名，因此 httpd 也是得要搭配上一章談到的 DNS ，這樣大家才方便連結到各個不同的主機器， 再搭配類似 google 的搜尋引擎，就可以讓資料在 Web 上面流通得很廣泛了。簡單的說， WWW 就是：

- WWW 是 World Wide Web 的縮寫，其中 Web 有廣播網的意思存在， 所以簡稱為全球資訊網。
- 使用 WWW 時，需要有 server 與 client 的架構，兩者間傳輸的資料如下：
   	![img](https://dic.vbird.tw/images/server_client.gif)
- 相關的 Server/Client 架構簡易說明如下： 	
  - WWW 伺服器不但需要一個可讓用戶端瀏覽的平台，還需要提供用戶端一些資料才行！
  - 上述伺服器所提供的最主要資料是超文件標籤語言 (Hyper Text Markup Language, HTML)、多媒體檔案  		(圖片、影像、聲音、文字等，都屬於多媒體或稱為超媒體)。
  - HTML 只是一些純文字資料，透過所謂的標籤 (<tag>) 來規範所要顯示的資料格式；
  - 在用戶端，透過瀏覽器的對 HTML 以及多媒體的解析，最後呈現在使用者的螢幕上。

- http 協定與 apache 軟體的開發

如前所述，WWW 是由 Tim Berners-Lee 爵士開發出來的，發展的協定稱為超文件傳輸協定 (Hyper Text Transport Protocol, HTTP)， 為了讓這個協定可以順利的被應用在電腦上，因此 Tim 大約在 90 年代初期由伊利諾大學的國家超級電腦應用中心  (NCSA, http://www.ncsa.illinois.edu/) 開發出伺服器 HTTPd (HTTP daemon 之意)。

不過後來 HTTPd 這個伺服器的開發並沒有繼續延續下去，妥善率不是很好，於是一群社群朋友便發起一個計畫，這個計畫主要在改善原本的 HTTPd  伺服器軟體，他們稱這個改良過的軟體為 Apache，取其『一個修修改改的伺服器 (A patch server)』的雙關語！

這個 Apache 在 1996 年以後便成為 WWW 伺服器上市佔率最高的軟體了 (http://httpd.apache.org/)。甚至還自己推出自己的授權協議稱為 Apache 授權哩！

- 什麼是 URL (Uniform Resource Locator)

雖然我們都暱稱 URL 為『網址列』，不過，實際名稱為 Uniform Resource Locator (統一資源定位位址)。基本上 URL 的格式有點像這樣：

- <協定>://<主機位址或主機名稱>[:port]/<目錄資源>

在網頁上使用的協定為 http 或 https (傳輸資料有無加密)，當然，瀏覽器上面還可以輸入類似 ftp:// 等協定。主機名稱就是 DNS 所設計的主機名稱為主 (雖然可以使用 /etc/hosts 的主機名稱，不過，除了內部傳輸之外，大部分當然使用的就是 DNS 主機名)。至於 :port 則是該協定啟動在非正規埠口的意思。 目錄資源則是該資料放在伺服器的哪個相對目錄的位置上。

- 動態 WWW 伺服器

與我們一般說的會動的圖畫 (如 CSS 動畫或 GIF 動畫或影像資料) 不同，所謂的『動態』指的是網站的內容會隨時更新的意思，這才是所謂的動態網站。 為了達成動態網站，你在設計網頁時，當然就要使用網頁程式語言。這個網頁程式語言會主動到資料庫去撈取資料來顯示，同時， 也可以依據使用者的需求或點擊的特性，來給予適當的內容。因此，所謂的動態網站，你就得要有：

- 適合的作業系統
- WWW 伺服器平台
- 網路資料庫系統： 須注意 WWW 伺服器與資料庫系統為兩個獨立的系統，因此需要透過網頁程式語言進行溝通
- 網頁程式語言

![img](https://dic.vbird.tw/images/server_client_2.gif)

在台灣，上述的環境常見的搭配軟體為：Linux + Apache + Mariadb + PHP --> LAMP (燈)

​		例題 10.1.A： 	

1. 寫出第一個 HTTPd 瀏覽器與伺服器的作者名字為 (歐洲人喔！)：
2. 承上，這個 httpd 通訊協定，主要是想傳輸什麼資料？
3. httpd 這個伺服器後來被社群單位接手繼續管理，接手後將 httpd 改名為什麼軟體？
4. URL 網址指的是什麼樣式的網址列？
5. 所謂的動態 WWW 伺服器當中的 LAMP 指的是什麼？



### 10.2： Apache 基礎安裝與使用

在 CentOS 8 上面預設的 WWW 伺服器就是 Apache，而 Apache 的軟體名稱在 CentOS 上面被稱為 httpd。

​		例題 10.2.A： 	

1. 安裝：安裝 Apache 軟體
2. 啟動：使用預設值啟動 Apache 軟體
3. 開機啟動：設定開機會啟動這個軟體
4. 防火牆：你的 Apache 軟體是對全世界放行的，請觀察或重新設定防火牆
5. 測試：打開瀏覽器，輸入網址列的你的主機名稱，看看能否觀察到相關的網頁資料？
6. 測試：同時請觀察已經啟動的埠口，是否有讓 httpd 啟動的號碼？

- CentOS 8 上預設的 Apache 設定

在 CentOS 8 上面，Apache 預設的項目有底下這幾個：

- 基礎設定檔位於： /etc/httpd/conf/httpd.conf
- 附加設定檔位於： /etc/httpd/conf.d/*.conf
- 預設啟動埠口在： port 80
- 預設伺服器管理員 email： root@localhost
- 預設首頁目錄位於： /var/www/html
- 預設首頁檔案檔名： index.html
- 預設所有人均可以瀏覽網頁

​		例題 10.2.B： 	

1. 請改用文字列瀏覽器 curl 檢查本機的網頁首頁
2. 請將預設的首頁改成顯示你的大名與學號即可。
3. 透過 curl 檢查看看能不能看到你修改的資料？

- 修改基礎設定值

你當然可以修改預設的設定值，只是要自己承擔風險！舉例來說，如果你改了連線埠口，那麼就得要告訴別人你的連線埠口即將跑到類似如下的網址，否則將無法被瀏覽：

- http://localhost:85/

為了避免困擾，底下僅告知一般來說，可能會被管理員更動的設定，其他詳細的設定請自行參考 httpd.conf 內的說明了。

```
[root@localhost ~]# vim /etc/httpd/conf/httpd.conf

Listen 80                     # 預設 Apache 的監聽埠口

ServerAdmin root@localhost    # 可以改成任何一個合法的 email address 即可！出問題時，螢幕會顯示出來！

DocumentRoot "/var/www/html"  # 就是預設的首頁目錄位置

<Directory "/var/www/html">   # 針對首頁目錄所進行的各項權限控制項目
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted       # 設定誰可以瀏覽的參數，詳細語法後續會談到。
</Directory>

<IfModule dir_module>         # 設定首頁檔名
    DirectoryIndex index.html
</IfModule>

<Files ".ht*">                # 設定在本伺服器中，只要開頭檔名為 .ht 的檔案，就不可以被瀏覽
    Require all denied
</Files>

<IfModule alias_module>       # 指定 http://server/cgi-bin/ 為 CGI 的主要放置網址
    ScriptAlias /cgi-bin/ "/var/www/cgi-bin/"
</IfModule>
<Directory "/var/www/cgi-bin">
    AllowOverride None
    Options None
    Require all granted
</Directory>

<IfModule mime_module>        # 指定副檔名的其他功能
    TypesConfig /etc/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
    #AddHandler cgi-script .cgi
    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml
</IfModule>

AddDefaultCharset UTF-8             # 指定預設的語系資料，通常可以直接註解即可！

# Some examples:                    # 指定一些常見的錯誤顯示方式，須搭配 Web 常見的錯誤代碼
#ErrorDocument 500 "The server made a boo boo."
#ErrorDocument 404 /missing.html
#ErrorDocument 404 "/cgi-bin/missing_handler.pl"
#ErrorDocument 402 http://www.example.com/subscription_info.html
```

​		例題 10.2.C： 	

1. 多重埠口設計方式： 		
   1. 讓 httpd 可以啟動埠口在 80 以及 7788 兩個埠口，修改完畢之後立即重新啟動。 			(你可能需要自己處理 SELinux 的問題)
   2. 承上，如何讓瀏覽器連結上 7788 這個埠口
   3. 承上，如何確認是連上 port 7788 (hint: 透過 netstat 觀察，而且可能需要透過連續指令下達，否則會看不到連線！)
   4. 承上，如果要讓 port 7788 對 internet 放行，該如何處理？
2. 一般建議設定，不過，可能得要搭配 PHP 等伺服器網頁程式語言的協助才會看到成效！ 		
   1. 讓管理員的 email 改為 student@mail.lanXX.dic.ksu
   2. 讓語系資料交給網頁自己管理，取消強制的 utf8 語系輸出
3. 增加目錄所在的『首頁檔案』檔名設計： 		
   1. 當 index.html 找不到，會再找尋 welcome.html 或 default.html 等檔名作為首頁檔
   2. 當你在網址列輸入 http://localhost/checkwelcome/ 時，就會輸出 welcome.html 的內容，而  			welcome.html 內容請填寫『this filename is welcome.html』即可

上面的例題中，如果你想要查看到 httpd 的連線行為，可能需要特別留意指令操作的速度。這是因為 httpd 連線的功能通常都是『射後不理』， 意思是，WWW server 將資料完全傳給 client 之後，該次連線就會中斷了！並不會持續連線等待用戶端的要求。

### 10.3： 常見的進階應用

基本上，上述的工作完成後，你的 Web 應該可以順利運做了。不過，在某些情況下，你可能還是得要修改一些設定，會讓你的系統運作的更好。

- Apache 系統效能優化處理

預設的 apache 設定值讓你的 Web 伺服器可以提供小型企業的運作，佔用的 Linux 系統資源也比較少。不過，當你的網站開始大起來， 瀏覽的要求比較多的時候，可能會讓你的 Apache 有點卡卡延遲的情況發生。此時，你的 Apache 應該要佔用比較多的 Linux 資源才對， 才不會讓資源閒置結果讓 apache 效能無法提昇。

由於 Apache 針對系統資源的設定中，提供了數個基本的模組，分別是 worker, prefork, event 等，這幾個模組的設定，主要是放置在底下的設定檔當中：

- /etc/httpd/conf.modules.d/00-mpm.conf

你可以自行前往查閱。不過，如果你想要知道目前的多執行緒模組 (Multi-Processing Module, MPM) 實際上用的是那一個，也可以透過底下的方式來查詢：

```
[root@localhost ~]# httpd -t -D DUMP_MODULES |grep mpm
 mpm_event_module (shared)
```

CentOS 8 使用的是 event 這個模組。當你使用 systemctl status httpd 時，應該會看到有預設數個程序在跑 (請立刻查看一下)， 這就是 event 的預設值。如果你想要增加到 10 個預設的  httpd 程序，且未來最多可開到 30 個 httpd 的程序，同時給予一些其他的參數增加連線數， 那可以在 /etc/httpd/conf.d/mpm.conf 這個檔案 (預設不存在，自己手動設定) 增加如下的項目：

```
[root@localhost ~]# httpd -V
Server version: Apache/2.4.37 (centos)
Server built:   Nov  4 2020 03:20:37
Server's Module Magic Number: 20120211:83
Server loaded:  APR 1.6.3, APR-UTIL 1.6.1
Compiled using: APR 1.6.3, APR-UTIL 1.6.1
Architecture:   64-bit
Server MPM:     event
  threaded:     yes (fixed thread count)
    forked:     yes (variable process count)
Server compiled with....
 -D APR_HAS_SENDFILE

[root@localhost ~]# vim /etc/httpd/conf.d/mpm.conf
<IfModule mpm_event_module>
StartServers        10
MinSpareThreads     75
MaxSpareThreads    250
ThreadLimit         64
ThreadsPerChild     50
MaxRequestWorkers  300
MaxConnectionsPerChild    1000
MaxClients         500
</IfModule>

[root@localhost ~]# apachectl configtest
Syntax OK

[root@localhost ~]# systemctl restart httpd
[root@localhost ~]# systemctl status httpd
```

​		例題 10.3.A： 	

1. 依據上述的說明找到正確的模組，並且設定與上述相同的參數來處理 Apache 的資源使用情況
2. 使用 systemctl status httpd 觀察整體程序的輸出是否比之前來的多。

由於 event 這個 MPM 機制會主動的降低 Apache 的 loading，因此，當你的用戶瀏覽的量很少時，httpd 的程序會主動的被降低喔！ 你可以持續的 systemctl status httpd 查閱，就可以看到 process 的數量不會固定！

- Apache 的個人首頁設定

一個主機預設只有一個首頁目錄，當然可以指定使用虛擬主機。不過，如果用在類似教學的環境下，想讓所有的學生都擁有自己帳號的個人首頁， 以方便學生自己上傳自己的網頁資料時，可以使用 apache 的內建個人首頁的設定喔。

你可能會看過類似如下的網址列：

-  http://your.host.name/~username/

後面那個網址『 /~username 』是否很像我們在 Linux 底下要搜尋某用戶的家目錄所使用的『 ll ~username 』呢！沒錯！那就是個人首頁。 預設的個人首頁是放置在 /home/username/public_html/ 目錄下，不過鳥哥不喜歡這個目錄名稱，比較喜歡單純的 /home/username/www/ 這樣的目錄名， 使用者也好記，我們也好管理。

個人首頁的設定預設是取消的，我們需要修改 /etc/httpd/conf.d/userdir.conf 這個檔案的內容才行！

```
[root@localhost ~]# vim /etc/httpd/conf.d/userdir.conf
<IfModule mod_userdir.c>
    UserDir www
</IfModule>
<Directory "/home/*/www">
    AllowOverride FileInfo AuthConfig Limit Indexes
    Options MultiViews Indexes SymLinksIfOwnerMatch IncludesNoExec
    Require method GET POST OPTIONS
</Directory>

[root@localhost ~]# apachectl configtest
Syntax OK

[root@localhost ~]# systemctl restart httpd
```

上面的設定值一個是設定網頁目錄為 www ，另一個則是宣告該目錄擁有的權限這樣。另外，請務必觀察 httpd 與 homedir 有關的 SELinux 設定項目， 一定要啟用才行！

```
[root@localhost ~]# getsebool -a | grep http | grep home
httpd_enable_homedirs --> off

[root@localhost ~]# setsebool -P httpd_enable_homedirs on
[root@localhost ~]# getsebool -a | grep http | grep home
httpd_enable_homedirs --> on
```

​		例題 10.3.B： 處理個人首頁的方法 	

1. 伺服器端的設定行為： 		
   - 先以上述的作法完成 userdir 的個人首頁設定
2. 一般帳號建立個人首頁的情境處理： 		
   1. 建立一個名為 webuser1 的帳號，密碼設定為 thewebman ；
   2. 切換到 webuser1 的身份，然後在家目錄建立名為 www 的目錄，且在該目錄下新增 index.html 檔案， 			檔案內容就設定為『 I am webuser1 』即可。
   3. 嘗試到瀏覽器瀏覽 http://your.server.name/~webuser1 看看出了什麼問題？
       				1) 網頁上面顯示什麼訊息？
       				2) access log 上面顯示什麼訊息？尤其是錯誤代碼的部份
   4. ​					3) error log 上面顯示什麼訊息？ 			

   5. 請嘗試自行修改權限資料 (請務必使用最小可達成目的的權限！)
3. 未來新建帳號都會具有個人首頁的情境處理： 		
   1. 在 WWW 伺服器上，若未來每個用戶新建時，都會自動擁有 www 目錄，且該目錄下都會有 index.html，內容為『 Personal web page ！』， 			又該如何處理？
   2. 上述動作完成後，請建立 webuser2 的帳號，同時修改好正確的權限，然後使用瀏覽器瀏覽，看看能否得到正確答案？

- 以 FTP 提供個人用戶的網頁上傳

我們知道 ssh 可以提供類似 ftp 的功能來傳輸檔案，也可以直接使用 scp ，或者是類似 filezilla 等圖形界面軟體來傳輸網頁。 不過 ssh 並沒有對全世界放行，同時我們也不建議 ssh 對全世界放行。而且，ssh 的 chroot 需要比較多的技術支援。 因此，如果針對教學環境來說，反而使用傳統的簡易型 FTP 軟體更能有效的設定好個人用戶的資料上傳。

CentOS 8 提供了 vsftpd 這個簡易的安全的 FTP 伺服器，安裝好就能立刻使用了：

​		例題 10.3.C： 安裝與設計 FTP 伺服器 	

1. 架設 FTP 伺服器階段 (需要那五個步驟呢？) 		
   1. 安裝 vsftpd
   2. 啟動 vsftpd
   3. 下次開機依舊可以啟動 vsftpd
   4. 設定好 Internet 可以連線到我的 FTP 埠口
   5. 在 /etc/sysconfig/iptables-config 裡面加入 nf_conntrack_ftp 以及 nf_nat_ftp 兩個常用的 FTP 模組。設定完畢後務必重新啟動 iptables 服務。
2. 測試確認 FTP 系統的正確執行，同時更改伺服器匿名登入的測試 		
   1. 在瀏覽器直接輸入 ftp://your.hostname 確認可以使用匿名 FTP (CentOS 8 應該會失敗)
   2. 使用 systemctl status vsftpd 檢查看看到底我們用啥帳號登入的？
   3. 找 vsftpd.conf 這個 man page 的說明，輸入剛剛看到的匿名帳號資料，找到開啟匿名登入的設定後，修改 /etc/vsftpd/vsftpd.conf 的內容， 			重新啟動 vsftpd 之後，再次測試是否能夠使用匿名登入了？
   4. 剛剛 systemctl status vsftpd 時，可以看到 tty 使用的是 ftp，能不能查出 ftp 的家目錄所在？ 			同時，直接查看 ftp 家目錄內容有啥？
   5. 在 /var/ftp/pub 底下丟入幾個檔案，再回上一步去確認有沒有新增檔案在 pub 目錄下了。
3. 一般帳號使用 FTP 的方法： 		
   - 使用瀏覽器輸入 ftp://webuser1@your.hostname/ ，並輸入 webuser1 的密碼，來確認能否登入系統。
   - 測試能不能離開使用者家目錄，並且到其他任意的地方去？

- vsftpd 可以匿名登入也能使用實體帳號登入
- 匿名登入會主動跑到 /var/ftp 目錄下去瀏覽資料
- 實體帳號預設可以離開家目錄，且能到系統任何有權限的目錄去瀏覽。

如上練習的最後一題，因為預設 vsftpd 會開放整個系統的瀏覽權，因此需要進行一些簡易的設定比較好。讓使用者無法離開家目錄才是比較正確的作法：

```
[root@localhost ~]# vim /etc/vsftpd/vsftpd.conf
chroot_local_user=YES
chroot_list_enable=YES
chroot_list_file=/etc/vsftpd/chroot_list
allow_writeable_chroot=YES  # 這一行預設不存在，請自己加入喔！

[root@localhost ~]# touch /etc/vsftpd/chroot_list  # 寫入這個檔案的用戶才可以脫離家目錄

[root@localhost ~]# systemctl restart vsftpd
```

如此一來所有的用戶就能夠透過 FTP 來進行網頁的上傳下載囉！也可以透過 notepad++ 來進行線上編修網頁的作業了！

​		例題 10.3.D：一般帳號的 chroot 使用 	

1. 依據上述的說明，完成 FTP 的 chroot 功能
2. 透過用戶端瀏覽器的功能，測試能否連結到 FTP 伺服器，如 links ftp://webuser1@your.hostname 
3. 測試能不能脫離家目錄？

- 錯誤瀏覽訊息公告

你應該經常有的經驗，就是去瀏覽一個網頁時，對方告訴你 404 耶！什麼是 404 呢？這個是 Web 公認的幾個錯誤代碼～常見的錯誤代碼有：

- 100-199：一些基本的訊息
- 200-299：用戶端的要求已成功的達成
- 300-399：Client 的需求需要其他額外的動作，例如 redirected 等等
- 400-499：Client 的要求沒有辦法完成(例如找不到網頁)
- 500-599：主機的設定錯誤問題

一般來說，正常瀏覽與錯誤瀏覽的 log 記錄位置並不相同！你可以根據底下的檔案來找尋錯誤瀏覽的行為：

- 正確瀏覽的登錄檔： /var/log/httpd/access_log
- 錯誤瀏覽的登錄檔： /var/log/httpd/error_log

你可以根據 httpd.conf 裡面的註解資料當中找到 404 這種錯誤代碼的顯示行為。

​		例題 10.3.E：設定錯誤指引的網頁 	

1. 在主設定檔當中，設定發生 404 找不到網頁時，會主動顯示 http://your.hostname/missing.html 這個檔案
2. 增加 missing.html 這個檔案，內容請自訂 (通常是增加連結到主網頁即可)
3. 故意輸入錯誤的網頁，能不能取得剛剛建立的 missing.html 內容？



### 10.4： 網頁目錄的瀏覽控制

防火牆可以讓你的 httpd 整個被擋住或整個被放行。但想一想，某個目錄我想要保護在內網才能看，其他的則大家都能看。在這樣的情況下， 防火牆似乎就沒有辦法達成了！這個時候得要使用 apache 提供的相關功能來處理較佳。底下提供兩個方案來達成這個分別瀏覽的目的：

- httpd 的目錄保護功能 (僅規範到的 IP 來源可以登入瀏覽)

我們使用的 apache 是 2.4 版，這一版與前一代使用的瀏覽權限設定完全不同，所以你得要注意版本的差異才行。基本上，針對目錄的權限瀏覽我們可以參考網頁根目錄的設定：

```
<Directory "/var/www/html"> 
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>
```

上面那個 Require 就是權限控制的重要參數。一般來說，常見的 Require 有底下的幾個基本語法：

- 全部放行： Require all granted
- 全部拒絕： Require all denied
- 部份放行，針對主機名稱的部份： Require host client.host.name
- 部份放行，針對 IP 的部份： Require ip 192.168. 192.168.0.0/16 10.0.0.0/24 

​		例題 10.4.A：有個目錄放置的資料僅針對內網放行，例如 http://your.hostname/private 這個目錄！ 	

1. 建立保護目錄：
    		建立 private 目錄，且建立 private/index.html 檔案，內容為『This is private data!!!』即可
2. 建立個別設定檔：
    		假設為 /etc/httpd/conf.d/vbird.conf ，內容請針對上述目錄進行處理。其中，該目錄只有你的內網 (10.255.xx.0/24) 		以及你自己 (127.0.0.0/8) 可以瀏覽，其他來源是不能瀏覽的。
3. 重新啟動：
    		請先檢查語法，若無問題請重新啟動 httpd 服務。
4. 嘗試使用內網連線以及外網連線，測試該網頁是否能夠順利的瀏覽與不可瀏覽：
    		http://localhost/private
    http://127.0.0.1/private
    http://10.xxx
    http://192.168..

- 建立使用密碼保護的瀏覽目錄

上述的動作雖然可以讓你的 Apache 保護某些目錄，不過，如果你經常出差，有時需要查閱該保護目錄時，會不會很麻煩？我是覺得很麻煩～ 所以，此時可以使用 Apache 提供的基礎密碼保護功能來處理。

密碼保護的設定有兩種模式：

- 一種是寫死到主設定檔 (含 httpd.conf 以及 conf.d/*.conf 等檔案，接為主設定檔)
- 一種則是透過受保護目錄底下的 .htaccess 修改設定來處理。不過要能使用 .htaccess 也需要主設定檔的支援才行。

你可能會覺得，既然主設定檔也需要修改才能支援 .htaccess ， 那為何不直接寫入主設定檔即可？這是因為主設定檔修改完畢得要重新啟動 httpd ，而修改 .htaccess 只要改完立刻可以生效！無須重啟 httpd。 這對於一般帳號也想要設定密碼保護的情況來說，是相當有幫助的！針對可以使用 .htaccess 的目錄來說，需要增加底下的設定：

```
<Directory "/some/where">
	Options XXX
	AllowOverride AuthConfig
</Directory>

# systemctl restart httpd
```

接下來切換到該目錄下 (/some/where)，建立一個名為 .htaccess 的檔案，這個檔案必須要 (1)指定密碼檔的檔名， (2)指定該密碼檔內可用以驗證的帳號。檔案內容大概像這樣

```
[root@localhost ~]# vim .htaccess
AuthType	basic
AuthName	"你要顯示到彈出式視窗的文字"
AuthUserFile	/some/auth/filename   <==這個檔案需要額外建置
require user 	帳號名稱              <==只針對某些用戶放行
# require valid-user                  <==所有記載在密碼檔的用戶均放行
```

上述的 /some/auth/filename 檔案檔名是自己指定的，但是最好不要放在可被網頁瀏覽的目錄 (就是不要放在 /var/www/html/ 內！)。 至於該檔案的建立方案為：

```
[root@localhost ~]# htpasswd [-c] /some/auth/filename username
```

​		例題 10.4.B： 讓一般用戶的資料可以進行密碼保護 	

1. 伺服器的設定檢查，注意，是找 httpd.conf 或 userdir.conf 或 vbird.conf 呢？ 		
   - 先查閱使用者家目錄底下能否支援 AuthConfig 的設定！若不行，請修改成允許 override authconfig 喔！
   - 想想看，如果有更新，要不要重新啟動 httpd 呢？
2. 用戶自己設定屬於自己的設定檔 (無須重新啟動 httpd 喔) 		
   1. 登入 webuser1 ，讓這個用戶的 http://your.hostname/~webuser1/protect/ 目錄是受密碼保護的，且內部 index.html 顯示『 This is protect directory 』
   2. 假設使用的密碼檔位於瀏覽器瀏覽不到的 /home/webuser1/apache.pw ，且帳號為 nobody 密碼為 iamnobidy
   3. 另一個 somebody 密碼為 hehesomebody ，也能放行這個目錄。
   4. 設定完畢務必瀏覽一次確認



### 10.5： 使用 https 瀏覽

網頁一般都是不加密的，不過這樣的傳輸可能會出問題！因此，進來各主要供應商都建議無論你的資料為何，最好都提供加密的 https 瀏覽為宜。 那麼 https 到底是什麼呢？

- 使用類似 sshd 的金鑰系統，透過 SSL (Secure Socket Layer) 的方式來處理這樣的金鑰系統。 	而啟動的埠口會預設啟動於 443 上面。
- 由於 server 的 public key 預設是可以散佈在 internet 上面的，因此，public key 很可能會被竊取。 	為此，合法的網址 (URL) 通常都會將自己的 public key 製作成為憑證，讓網址與憑證一致， 	再將憑證註冊進合法的第三公正單位資料庫 (Certification Authorities) ，則未來用戶端瀏覽器要瀏覽這個網址時， 	會將取得的憑證與 CA 資料庫進行比對，以確定該網址確實就是某公司的註冊這樣。
- 雖然有時候你覺得你的網站資料並不是非常重要，但是，近期以來，幾乎所有的大型 WWW  	伺服器都將網站使用 https 來瀏覽了！所以大家也需要考慮一下，是否有此需求才好！
- Apache 使用的 https 機制，只需要加上 mod_ssl 這個模組即可！

​		例題 10.5.A：加入 https 的支援 	

- 請安裝 mod_ssl 之後，並重新啟動 httpd，同時觀察是否啟動了 443 埠口？
- 如何連線到 port 443 ？若有連線的憑證問題，如何查閱憑證資料並放行該次連線？
- 若使用 curl 進行連線，又該如何加入參數？



### 10.6： 課後練習

1. (70%)實作題：啟動 Server 作業硬碟 - unit10	

   1. 網路參數的設定，請依據底下的方式來設定好你的網路環境： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 為外部的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.18.255.*/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.18.255.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 使用 teamd 的機制建立內部區域網路的備援功能： 		

         - team 的界面使用 team0 卡號，且連線名稱請命名為 team0
         - team 使用 activebackup 備援功能，不要使用 loadbalance
         - team 的實體網卡 (team slave) 請使用 ens7 及 ens8 ，且其連線名稱名稱亦請命名為 ens7, ens8
         - team0 網路參數為： 172.19.*.254/24，不需要 gateway 

      4. 主機名稱指定為： server*.example.dic

      5. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 基本的伺服器作業系統設定行為： 	

      1. 使用崑山的 FTP 網站作為你的 YUM server 來源，來源倉儲至少需要涵蓋 BaseOS, AppStream, extras, PowerTools 等， 		並且清除一次 yum 清單快取。(請注意，由於最終系統會全系統升級一次，升級後，這些設定檔可能會被更新。 		因此，你在全部升級完畢之後，還需要回來修改這個設定檔喔！)
      2. 安裝相關的軟體，至少須安裝 vim-enhanced, bash-completion, net-tools, mailx, wget, links, bind-utils,  		kernel-tools, kernel-modules (某些軟體可能需要使用 PowerTools 軟體倉儲安裝喔！但是該軟體倉儲預設需要是不啟用 
      3. 全系統自動升級，且每天凌晨 3 點也會自動升級一次。(請寫入 /etc/crontab 為主)
      4. 將 SELinux 修改成為 Enforcing 模式，且未來每次開機都自動為 Enforcing 才行

   3. 實際設定好本機防火牆 

      1. 請關閉 firewalld 服務，並且自行安裝、啟動 iptables 服務
      2. 將預設的規則轉存到 /root/firewall.sh 這個檔案內
      3. 首先將全部的規則刪除 (應該有三條指令)
      4. 設定好預設政策，讓 INPUT 成為 DROP 而 OUTPUT 與 FORWARD 成為 ACCEPT
      5. 針對 INPUT 前三條規則為 (1)回應封包 (2)放行 lo 界面 (3)放行 icmp 封包
      6. 放行你自己的內部區域網路那個網域的連線要求 (針對 LAN 的信任設定)
      7. 讓 ssh 只對外部的區網放行，不會對 Internet 放行 (對 ssh 連線做限制較佳)
      8. 讓 http 針對整個 Internet 放行 (一般公開的服務設計)
      9. 最後讓確定的規則轉存到 /etc/sysconfig/iptables 這個設定檔
      10. 重新啟動 iptables 服務，然後觀察規則是否正確

   4. 實際設定好 Server 的路由功能 

      1. 讓核心支援 IP 轉遞的功能，並且每次重新開機都可以自動生效
      2. 修改 /root/firewall.sh ，在該檔案加入清除 nat 表格的規則與自訂鏈的設定
      3. 增加規則：讓來自內部網路的封包，在路由判斷後，並預計由 ens3 對外網卡出去的封包，全部偽裝成為 ens3 的 IP 位址 	 (一般在數據機上面的就是 public IP)
      4. 在 /etc/sysconfig/iptables-config 當中增加 nf_nat_ftp 及 nf_conntrack_ftp 模組功能
      5. 上述功能在開機後依舊能夠順利啟動

   5. 基礎 Apache 架設 	

      1. WWW 啟動的埠口會同時啟動於 port 80 與 port 1212 這兩個
      2. 管理員的 email 請設定為 student@server.lanXX.example.dic
      3. 取消強制使用 UTF8 的語系設定
      4. 設定 index.html, welcome.html, default.html 作為你的首頁檔名
      5. 當瀏覽 http://localhost 時，會顯示你的學號與姓名
      6. 讓你的伺服器可以同時提供 port 80 與 port 1212 的網路連線 (防火牆功能思考)

   6. 個人首頁的設定 	

      1. 針對個人首頁的 Apache 設定： 		

         - 瀏覽器瀏覽 http://localhost/~username 時，會顯示 /home/username/web/index.html 的內容

      2. 針對新建用戶的設計： 		

         - 預設建立新用戶時，該用戶的家目錄會存在一個名為 web 的目錄
         - 且內含一個 index.html 的檔案，檔案內容填寫『 Personal web page 』即可。

      3. 為了擔心個人用戶用爆系統容量，因此請設定好 /home 這個目錄的檔案系統得要支援磁碟容量配額 (quota) 的功能。 		

         - 若 /home 為獨立 partition，請根據既有的檔案系統設計磁碟配額檔案系統支援
         - 若 /home 並不存在獨立的 partition ，那你可能得要針對根目錄進行 quota 的設定 (雖然這不是個好建議！)。 				但是 Linux 核心預設不能讓根目錄掛載為支援 quota，因此需要動點小手術。請參考  				https://help.directadmin.com/item.php?id=557 				來取得正確的 quota 支援。(註，我們只需要 userquota 即可， projectquota 可以不予理會)

      4. 大量批次建立帳號：建立一隻名為『 /root/webuser.sh 』的腳本 		

         - 建立一個名為 /root/webuser.txt 的檔案，/root/webuser.txt 的內容有點像這樣：

           ```
           alex
           dora
           hank
           ```

         - /root/webuser.sh 的腳本使用 for, do, done 的迴圈功能，會針對上述 /root/webuser.txt 的檔案進行如下動作： 			

           - 使用預設方式建立用戶，且用戶的密碼與帳號相同。
           - 建立用戶後，會給予該用戶 soft/hard 分別為 400MB/500MB 的可用磁碟容量
           - 讓該用戶的家目錄權限設定為 711 

         - 建置完畢後請執行一次該腳本，並使用 http://localhost/~alex 確認該帳號是存在的！  			(很可能需要額外處理權限或者是 SELinux 的問題)

      5. 處理使用者透過 FTP 上傳/下載的問題： 		

         - 讓 alex, dora, hand 可以使用 ftp 上傳/下載資料到伺服器上
         - 且這三個用戶必須是 chroot 的使用環境。
         - 伺服器的防火牆必須要放行 FTP (注意 port 的放行以及 FTP 的相關模組設定與載入)

   7. 受保護目錄的建置 	

      1. 固定來源的目錄保護： 		
         - 在瀏覽 http://localhost/pro_one/ 這個網址時，會顯示『 This is protect one directory 』
         - 只有底下的 IP 或網域，才可以瀏覽上述網址，其餘來源則沒有權限瀏覽：
            			127.0.0.0/8
            			172.18.255.*/32
            			172.19.*.0/24
      2. 密碼保護： 		
         - 在瀏覽 http://localhost/pro_two/ 這個網址時，會顯示『I am Protect two hehe 』的字樣。
         - 但是瀏覽時，會需要輸入帳號與密碼，帳號為 student 密碼為 student，輸入完畢才能瀏覽
         - 額外指定部份： 			
           - 請使用 .htaccess 的方式來處理這個題目
           - 假設密碼檔位於 /var/www/apache.pw 這個檔案內
           - 正確輸入帳密會顯示『 I am Protect two hehe 』的字樣。

2. (10%)實作題：啟動 client 作業硬碟 

   1. 網路參數的設定，請依據底下的方式來設定好： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.19.*.1/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.19.*.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 主機名稱指定為： client.lan*.example.dic

      4. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 實際設定好本機防火牆 

      1. 預設請使用 firewalld 防火牆服務，不要使用 iptables 服務！
      2. 請將預設的領域 (zone) 改為 work 領域
      3. 預計放行的服務主要有 ssh 與 http 兩個服務，其他還可能有預設會啟用的 dhcp 用戶端服務。
      4. 查詢 rich rule (man firewalld.richlanguage)，確認來自本機同一個 LAN 網段的封包，通通給予放行。
      5. 上述放行的防火牆服務，在下次重新開機後，依舊會存在才行

3. (20%)簡易問答題：(第一題 2 分，其餘 3 分) 	從具有 GUI 及中文的用戶端 Linux ，使用『 ssh root@172.19.*.254 』登入你的 Server ，之後建立 /root/ans.txt 的檔案，並將底下各題目的答案寫入你 server 當中！ 

   1. 所謂的 LAMP Server 在 WWW 上面一般指的是什麼意思？
   2. 傳統 FTP 的傳輸有所謂的命令通道與資料流通道，這兩個通道分別透過哪個埠口進行資料連接？
   3. FTP 有所謂的 active mode 與 passive mode，請問這兩種模式是如何進行傳輸的？
   4. 為了解決因為 NAT 造成的 FTP 傳輸困擾，那兩個 iptables 模組可以被拿來做監聽的應用？
   5. 當在 apache 上面設計的網頁出問題，或者是 http 本身出問題，可以查詢那一個登錄檔
   6. 以『 apache code status 』為關鍵字到 google 查詢，查出 200, 403, 404, 500 這四個錯誤碼的實際意義為何 (必須翻譯為你自己了解的語意)？
   7. 查詢 httpd.conf 內的 Options 設定值，裡面的 Indexes, FollowSymLinks, ExecCGI 的意義為何？

4. 上傳成績 

   1. 請將 Server/Client 的硬碟通通啟動，並且確認兩者間的連線沒有問題；
   2. 在 Server 硬碟上面登入，然後用 root 的身份執行 vbird_server_check_unit ，並依據提示資料填寫你的學號與 IP 尾數
   3. 該程式會偵測你的系統，並且通知你哪個部份可能有問題，你需要持續觀察或者重新處理的部份會交代妥當。
   4. 若一切沒問題，螢幕就會出現如下的字樣，然後你就能夠使用 links 去檢查你的檔案是否有順利的上傳了！
   5. Please use links http://172.18.255.250/upload/unit10 to check your filename

## 進階網頁伺服器設定 + proxy

###### 上次更新日期 2021/01/04

完成基礎的 Apache 應用後，再來我們要實際架設一個多功能的 Apache 了！除了常見的 virtualhost 讓你的 WWW 伺服器可以提供多個首頁目錄之外， 我們也要將加密與不加密的網頁分開，不再共用同一個主機名稱。而最終的目的當然是處理一個動態網站的建置！另外， 在資傳系，我們管理系統都使用 web 界面，但是過去已經寫了好多的 shell 腳本！因此，如何透過 PHP 以 root 的身份去執行重要的腳本檔案， 也是另一個需要被關注的議題！

學習目標：

- 理解與實際設定 Apache 的虛擬主機 (virtual host)
- 動態 Web server 的設定，尤其是資料庫的應用
- 透過 PHP 結合，讓 apache 用戶能執行系統腳本

- 11.1： 虛擬主機 virtualhost 的設定
- 11.2： 讓 http 與 https 主網頁分離
- 11.3： 動態 WWW 伺服器建置
- 11.4： 讓 PHP 網頁可以使用 root 權限呼叫 shell script
- 11.5： WGSI 網頁支援
- 11.6： squid proxy server 架設
- 11.7： 課後練習

### 11.1： 虛擬主機 virtualhost 的設定

通常我們跟企業合作去建立一個網站，最重要的是申請主機名稱，然後才是架站，然後放上網頁資料這樣。申請主機名稱與 DNS 有關，當你申請好主機名稱之後， 在網址列只要輸入 http://your.hostname 就搞定了。那我們知道一個 Apache 可以提供一個首頁目錄...這不對吧！如果我們公司有四、五個部門， 每個部門都要有自己的主機名稱與首頁，主機名稱還容易搞定 (DNS 設定多個主機名稱 A 記錄即可)，但是 Apache 要花費多個主機來架設，實在有點不合理啊！ 沒關係！這時透過 Apache 的虛擬主機功能就搞定了！

所謂的虛擬主機 (VirtualHost) 指的是讓不同的主機名稱可以對應到不同的主網頁去，感覺就好像有多個伺服器提供個別的服務這樣。 其實，最簡單的想法，就是讓『一個主機 (ServerName) 對應到一個首頁目錄 (DocuementRoot) 』而已！舉例來說，我們的 server.lanXX.dic.ksu 會使用 /var/www/html， 而 www.lanXX.dic.ksu 則對應到 /var/www/www 的話，那麼兩個主機名稱就分別使用不同的首頁目錄，這當然就達成多個網站的服務了！

| DocumentRoot  | ServerName           |
| ------------- | -------------------- |
| /var/www/html | server.lanXX.dic.ksu |
| /var/www/www  | www.lanXX.dic.ksu    |

至於設定則是相對的簡單啊！只要將底下的設定寫入自己的設定檔即可：

```
[root@localhost ~]# vim /etc/httpd/conf.d/yourfile.conf
<VirtualHost *:80>
    ServerName    server.lanXX.dic.ksu
    DocumentRoot  /var/www/html
</VirtualHost>

<VirtualHost *:80>
    ServerName    www.lanXX.dic.ksu
    DocumentRoot  /var/www/www
</VirtualHost>

<Directory "/var/www/www">
	Options xxx
	AllowOverride xxx
	Require all granted
</Directory>
```

比較需要注意的是，『不是只要設定第二個主機名稱即可，原先預設的主機名稱也是需要設定成為虛擬主機』，這也就是說：『 如果未來有其他新設的主機名稱，但是該主機名稱並沒有寫入設定檔時，則會拿第一個虛擬主機的設定來作為展示的目錄』。

​		例題 11.1.A： 以 root 身份設定簡單的虛擬主機 	

1. 先使用 dns 的 dig 查詢功能，測試上述的 server, www 主機名稱是否對應到同一個IP，若不是，請自行修改 DNS 設定， 		或者先使用 /etc/hosts 進行對應。
2. 前往 /var/www 之後建立 www 目錄，並且在 www 目錄下建立 index.html 檔案，內容就寫『 This is virtual host www 』即可。
3. 依據上述說明建立好你的虛擬主機，先測試設定檔語法，然後重新啟動 httpd，查看一下狀態是否正常。
4. 增加 ftp.lanXX.dic.ksu 這個虛擬主機連結到 /var/ftp 底下，且允許使用類似 FTP 的展示方式來處理檔案的顯示 (Options 的設計)

另外，架設虛擬主機的另一個原因，是因為有同事或者是客戶需要一個網站的緣故，因此虛擬主機可能並不是你要使用的！亦即是該主機名稱是給用戶管理的。 所以，你可能得要注意『目錄的權限』，因為要放行給其他客戶來上傳/下載網頁的緣故啊！例如底下的綜合練習：

​		例題 11.1.B： 含有權限設定功能 	

1. 假設你的系統因為當初安裝規劃的關係，容量較大的 partition 位於 /srv 底下，因此後來客戶要求要架設相關網暫時，你預計客戶的網站資料要放在 /srv 當中。
2. 假設客戶需要的帳號為 cola，密碼為 thiscola，且該帳號的家目錄預計放置於 /srv/cola/ 當中，同時，這個帳號是無法登入取得互動 shell 的。
3. 假設客戶需要的主機名稱已經設定好為 cola.lanXX.dic.ksu (若不存在，請自行設定 DNS 來處理妥當)，請依據上述的虛擬主機來設定， 		同時 cola 客戶也需要 .htaccess 檔案應用的支援。
4. 客戶要求要使用 FTP 功能來協助上傳/下載網頁。
5. 客戶要求要使用 Samba 功能來協助上傳/下載網頁，且假設客戶的 IP 為固定的 172.17.1.1



### 11.2： 讓 http 與 https 主網頁分離

一般來說，如果有加密與不加密的 WWW 網頁時，你可能會希望將兩者分開。舉例來說，讓你的 https 負責需要加密的 open webmail，而 http 則負責不加密的一般網站。 此時，你應該可以想到上面提到的虛擬主機的功能。事實上，CentOS 的 mod_ssl 的設定檔已經預設規劃好虛擬主機的參數了， 你可以直接解開註解來使用即可。

​		例題 11.2.A：完成底下的虛擬主機練習 	

1. 假設你已經安裝了 mod_ssl 這個軟體，請使用 rpm 列出這個軟體的所屬檔案檔名有哪些？
2. 讓你的 https 協定會主動的瀏覽 /var/www/https 這個目錄的內容，且該目錄的 index.html 會顯示『 I am https web here 』

- 自製專屬憑證資料

因為瀏覽器會去檢查你的網址列與憑證的主機名稱是否相同，如果網址列的主機名稱與憑證名稱並不相同時，許多瀏覽器就會顯示錯誤而不給連線。 因此，我們可能得要修改憑證才行。此時就需要重新製作憑證了。

其實憑證的製作方式與之前 LDAP 的環境差不多，不過這裡我們使用另一個 CentOS 預設提供的方法來處理！方法如下：

1. 進入 /etc/pki/tls/certs 後，使用第七章談到的 openssl 製作一對給 apache 使用的 key，使用的指令應該是：

   ```
   # openssl req -new -x509 -nodes -out {公鑰檔名}.crt -keyout {私鑰檔名}.key -days 3650
   ```

2. 將 {私鑰檔名}.key 挪到 /etc/pki/tls/private 底下，並將權限修訂成為 400 (或 600)。

3. 接下來請到 /etc/httpd/conf.d/ssl.conf 裡面調整 localhost.crt 與 localhost.key 的項目，重新啟動 httpd 即可！

​		例題 11.2.B： 讓你的 https 具有自己的專屬憑證 	

1. 製作憑證： 		
   - 依據上述說明建置憑證，假設憑證的檔名都是 dicksu 這一個 (dicksu.crt, dicksu.key)
   - 注意輸入主機名稱時，一定要與你的連線主機名稱相同 (例如 server.lan200.dic.ksu)
2. 修改設定： 		
   - 前往 ssl.conf 設定好然後在網址列輸入你的對外主機名稱，測試是否能夠順利的瀏覽。
   - 使用 firefox 瀏覽 https 伺服器，在列出詳細資訊時，查詢是否正確為自己的設定
   - 注意，在 firefox 的網址列，輸入的必需要是你的憑證紀錄所輸入的主機名稱才行！
   - 若僅有文字瀏覽器，可用 curl -k -v http://your.server.name 處理



### 11.3： 動態 WWW 伺服器建置

如前一章所提到的 LAMP 伺服器，我們還差了資料庫與網頁程式語言需要安裝。一般來說，需要的軟體有：

- 作業系統：Linux
- 網頁伺服器：httpd
- 資料庫伺服器：mariadb, mariadb-server
- 伺服器端網頁程式語言：php, php-mysqlnd (舊版為 php-mysql)

此外，資料庫是獨立於 WWW 伺服器之外的，因此也需要自行安裝與處理。

​		例題 11.3.A：完成 Mariadb 與 PHP 的安裝與設定 	

1. 安裝資料庫系統與伺服器端網頁程式語言，並啟動網路資料庫系統： 		

   - 請安裝 mariadb, mariadb-server, php, php-mysqlnd 等軟體
   - 完成後請不要重新啟動 httpd，留待下一個例題才啟動。
   - 啟動 mariadb 服務，啟動完畢後觀察是否啟動埠口？觀察是否有開機啟動？

2. Mariadb 網路資料庫系統的簡易操作：

   ​			先使用 mysql -u root 來嘗試無密碼登入資料庫看看： 		

   - 使用『 show databases; 』查看所有資料庫
   - 使用『 use mysql; 』切換到 mysql 資料庫
   - 使用『 show tables; 』查看這個資料庫所含有的資料表
   - 使用『 describe user; 』來查看這個資料表內的各個資料欄位
   - 使用『 select * from user; 』來顯示所有的資料內容
   - 使用『 select * from user where Host = 'localhost'; 』來規範條件
   - 最終使用『 exit 』來離開資料庫。

3. 進行本機資料庫的安全強化： 		

   - 由於預設 mariadb 沒有設定 root 密碼，因此執行 mysql_secure_installation 依序完成安全強化作業  			(設定 root 密碼為 2727175 看看，其他幾乎均按下 enter 即可！)
   - 分別使用『 mysql -u root [-p] 』來嘗試無密碼、有密碼的登入行為。

4. 取消、加入網路連線的資料庫功能： 		

   - 先以 netstat -tulnp | grep mysql 找到 mysql 啟動的埠口預設是幾號？
   - 如果這個資料庫系統不是給 apache 等網路環境用的，可以取消網路連線 (port會關閉)， 修改 /etc/my.cnf ，在  			[mysqld] 裡面新增一行『 skip-networking 』後，重新啟動 mariadb 即可！啟動完畢請查閱 3306 是否依舊存在呢？
   - 承上，將上述的 skip-networking 註解掉，重新啟動 mariadb，觀察 3306 是否恢復服務了？

PHP 是嵌入於 apache 的一個模組，所以，如果修改了任何 php 的資訊，一定要重新啟動 httpd 才行。

​		例題 11.3.B：初次執行 PHP 程式 	

1. Apache 尚未支援 PHP 之前的程式碼顯示問題： 		

   - 在尚未重新啟動 httpd 前，請先前往 /var/www/html 建置名為 phptest.php 的檔案，檔案內容如下：

     ```
     [root@localhost ~]# vim /var/www/html/phptest.php
     <?php
             phpinfo();
     ?>
     ```

   - 使用瀏覽器瀏覽 http://localhost/phptest.php ，看看能否看到實際的資料展示？

   - 重新啟動 httpd，然後重新觀察上面的網址，看看出現什麼變化？

2. php-fpm 加速軟體的安裝與觀察： 		

   - 檢查系統是否有安裝 PHP 加速軟體： php-fpm，使用 rpm -qi php-fpm 與 rpm -ql php-fpm 檢查相關的說明與所屬檔案檔名。 			重點是找出設定檔所在喔！
   - 查詢 /etc/php-fpm.conf 以及 /etc/php-fpm.d/www.conf 的相關內容，簡易查詢一下 error 關鍵字
   - 使用『 curl http://localhost/phptest.php | grep -i error_log 』，看看錯誤訊息放在哪裡了？

3. PHP 程式碼錯誤，需要處理的流程參考： 		

   - 重新編輯 phptest.php ，隨便加上幾個字，例如加入莫名其妙的『 hehe 』在 phpinfo() 之前，儲存之後再次以瀏覽器觀察 phptest.php 的內容。
   - 此時請前往上一題找到的 error log 目錄與檔案，觀察 error_log 的內容 (看最後面幾行資料)，確認問題的所在。
   - 確認修改完畢後，再次觀察上述網址。

也就是說，當你發現到 *.php 的檔案顯示的竟然是 PHP 的程式碼時，那就是你的網頁伺服器並沒有支援 PHP 的關係！此時請安裝 PHP 然後重新啟動 httpd 即可。 現在，你的系統已經可以支援動態網頁的設計了！

另外，其實資料庫也是可以多人共用的環境！而資料庫的管理員就是 root 。目前我們已經設定好 Mariadb 的 root 管理員，不過，一般使用資料庫時， 則不建議使用 root，否則被綁架很麻煩。那麼如何建置 Mariadb 的使用者呢？舉例來說，你想要建立的帳號/密碼/資料庫如下：

- 資料庫： dicdb
- 主機名稱： localhost
- 帳號： dicuser
- 密碼： dicpass

```
[root@localhost ~]# mysql -u root -p
Enter password:

MariaDB [(none)]> create database dicdb;
Query OK, 1 row affected (0.00 sec)

MariaDB [(none)]> grant all privileges on dicdb.* to dicuser@localhost identified by 'dicpass';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> use mysql;

MariaDB [(mysql)]> select * from user where user = 'dicuser';

MariaDB [(mysql)]> exit
```

這樣就建置好了你的資料庫。例外，如果你曾經在其他系統上面使用 Mariadb 建立過相關的資料庫，並且已經將資料庫的內容複製下來， 那是可以透過底下的方式來進行復原重建、備份資料的行為喔：

- 備份資料庫： mysqldump -u username -p database_name > /path/to/file.sql
- 復原資料庫： mysql -u username -p database_name < /path/to/file.sql

而如果需要在 Mariadb 的環境下丟棄資料庫，則使用『 drop database database_name 』即可！

​		例題 11.3.C：完成資料庫內容的重建 	

1. 依據上述的說明建立好資料庫、資料庫使用者、資料庫用戶密碼等資訊
2. 以備份的資料庫檔案，重建資料庫系統： 		
   - 下載 [這個檔案](https://dic.vbird.tw/linux_server/download/database.sql) ，此檔案為之前備份的資料庫內容 (建議使用 wget 來抓取這個檔案)
   - 然後依據這個檔案的內容重建你的資料庫！(你需要使用 dicuser 帳號與密碼喔！)
3. 以 dicuser 登入系統，去查閱相關的資料表與實際的資料內容。 		
   - 使用 dicuser 帳密登入
   - 列出所有資料庫後，選擇自己的資料庫使用
   - 列出所有的資料表
   - 隨便選一個資料表，列出所有欄位的參數
   - 列出所有的資料。
   - 離開資料庫

另外，PHP 預設最多只能支援 2M 的檔案上傳，如果未來你的專題需要比較大容量的上傳檔案時，應該要修改 php.ini 才行！

​		例題 11.3.D：完成 PHP 的支援與設定 	

1. 加強 php 支援的變數功能： 		
   - 修改 httpd.conf 的內容，將找不到網頁的 404 內容檔名修訂為 missing.php 這個檔名。
   - 前往 /var/www/html 將原本的 missing.html 更名為 missing.php，並在該檔案裡面呼叫出『 $_SERVER['SERVER_ADMIN'] 』這個變數， 			讓用戶知道出問題時，要找誰詢問。
   - 隨便在網址列輸入一個不存在的網頁，看看回傳的結果為何。
2. 放大上傳的檔案容量： 		
   - 修改 /etc/php.ini 找到 upload_max_filesize 設定值，將該設定值改為 16M；
   - 重新啟動 httpd 即可支援較大的上傳檔案容量了。

- (Options)套裝 PHP 架站機的練習：以 phpBB 討論區為例

很多所謂的架站機大多使用 PHP 網頁程式語言，搭配資料庫系統，就能夠提供中型企業所需要的入口網站！包括 wordpress, Xoops, phpBB 等。 這些架站機與社群網站不同的地方，在於易於查詢，有相關的模組可以搭配使用！

要架設這些簡易的架站機你的系統就必須要是動態網頁伺服器才行。我們在上面的練習過程中已經取得了如下的參數，因此將可以用來作為架站機的基礎資料庫設定。

- 資料庫： dicdb
- 主機名稱： localhost
- 帳號： dicuser
- 密碼： dicpass

phpBB 是透過 PHP 搭配資料庫系統所建置的一套討論區軟體，在社群網站尚未流行前，是一個相當熱門的討論區自由軟體。這個軟體也有中文化喔！官方網站與台灣支援網站如下：

- 官方網站： https://www.phpbb.com/
- 台灣支援： [http://www.phpbb-tw.net/phpbb/(竹貓星球)](http://www.phpbb-tw.net/phpbb/)

因為 phpBB 是一個用 PHP 與資料庫軟體撰寫的套裝軟體啊，所以你得要下載這個軟體包才行。此外，因為 phpBB 支援多國語系，但預設為英文語系， 所以，你也得要下載語言包才行。官網的下載點如下：

- phpBB 套裝軟體：https://www.phpbb.com/downloads/ (記得下載 .bz2 格式)
- 語言包：https://www.phpbb.com/languages/

​		例題 11.3.E：完成底下的動作 	

1. 全班請推派一人進行網際網路下載 (只要一人，不要多！)，假設名稱為 A 同學。
2. 請 A 同學下載完畢後，自行放置到 FTP 可下載的位址 (注意，提供的是匿名下載的功能喔！)
3. 請全部同學到 A 同學提供的 IP 位址去下載這兩個資料即可。

假設未來我們想要的網址為 http://server.lanXX.dic.ksu/phpbb ，因此應該要將下載的檔案放置於 /var/www/html/phpbb 目錄才行。 假設下載的檔案放置在 /root 處，請依序進行底下的任務即可：

```
# su -
# cd /var/www/html
# tar -jxvf /root/phpBB-3.3.2.tar.bz2
# ll 
drwxr-xr-x. 19 student student 4096 10月 13 00:45 phpBB3

# mv phpBB3 phpbb
# ll
drwxr-xr-x. 19 student student 4096 10月 13 00:45 phpbb

# chcon -Rv .
```

然後開始中文化的軟體包處理！

```
# cd /dev/shm
# unzip /home/student/mandarin_chinese_traditional_script_3_3_2.zip
# mv /dev/shm/mandarin_chinese_traditional_script_3_3_2/language/zh_cmn_hant/ \
> /var/www/html/phpbb/language/
# mv /dev/shm/mandarin_chinese_traditional_script_3_3_2/styles/prosilver/theme/zh_cmn_hant/ \
> /var/www/html/phpbb/styles/prosilver/theme/
# mv /dev/shm/mandarin_chinese_traditional_script_3_3_2/ext/phpbb/viglink/language/zh_cmn_hant/ \
> /var/www/html/phpbb/ext/phpbb/viglink/language//
```

接下來使用瀏覽器來進行後續的安裝即可：

1. 選擇『 INSTALL 』畫面底下按下『 Proceed to next step 』

2. 出現的畫面當中，幾乎都必須要是 yes 或 Avaliable 才行！所以可能需要額外增加軟體：

   ```
   # yum install php-gd ImageMagick
   # systemctl restart httpd
   # chmod 777 /var/www/html/phpbb/cache/
   # chmod 777 /var/www/html/phpbb/files/
   # chmod 777 /var/www/html/phpbb/store/
   # chmod 666 /var/www/html/phpbb/config.php
   ```

   ​		如果再次按下『 test again 』沒問題就會通過測試！若持續有問題，就會出現錯誤訊息在瀏覽器上！

3. 出現『MySQL with MySQLi Extension』的選擇後，分別輸入底下的資料即可： 	

   - 資料庫主機名： localhost
   - 資料庫 port ： 3306
   - 資料庫資料名： dicdb
   - 資料庫用戶名： dicuser
   - 資料庫密碼欄： dicpass
   - 資料庫前導字： phpbb_

   搞定後按下『 Proceed to next stop 』

4. 若一切順利，則資料庫會被主動的連接與建立！繼續按下『 Proceed to next step 』

5. 出現管理員設定畫面，幾個項目可以這樣選擇的： 	

   - 預設語系： 正體中文
   - 管理員帳號： 自己填自己喜歡的
   - 管理員密碼： 填自己喜歡的
   - 管理員密碼： 填自己喜歡的
   - 管理員email：填自己的 email

   搞定後按下『 Proceed to next stop 』

6. 一直按下『 Proceed to next step 』直到出現 Email settings 的部份，通常必須要使用 smtp 的 email， 	因為你的本機並不是正確的 email server 才對！只是就得要填寫你的帳號與密碼了！有點困難～所以先不要設定！

7. 最終出現『 Login 』畫面後，直接使用你剛剛建立的管理員帳號來登入吧！

8. 最終系統還是需要進行一些修訂維護的動作～使用底下的方式來處理：

   ```
   # chmod 444 /var/www/html/phpbb/config.php
   # rm -rf /var/www/html/phpbb/install/
   ```

大致上安裝就是這麼簡單～不過，如果有其他額外的模組要安裝，就請自行參考 phpBB 官網或台灣竹貓星球的介紹了。

### 11.4： 讓 PHP 網頁可以使用 root 權限呼叫 shell script

要透過 PHP 去運作 bash 或者是其他的程式是可行的！不過預設的 PHP 是使用 apache 這個帳號的權限，因此許多程式是無法順利運作的。 所以，當你要讓 PHP 去呼叫 shell script 時，就得要透過不用密碼執行的 sudo 囉！

​		例題 11.4.A：讓 apache 這個用戶不用密碼即可使用 root 的權限 	

1. 更改 apache 這個帳號的參數設定： 		

   - 可能得要改變 apache 的 shell ，請將 apache 的 shell 改成 /bin/bash 喔！
   - 使用 visudo ，進去修改設定值，讓 apache 加上不用密碼即可使用的功能

2. 一個簡單的範例：不過？仍然需要修訂 SELinux 與權限喔： 		

   - 編輯 /var/www/html/checkls.php，內容使用類似如下的語法來處理 (注意，所有指令最好都以絕對路徑來撰寫較佳！)：

     ```
     <?php
             $log = shell_exec('/bin/sudo /bin/bash -c "/bin/ls -al /var/www/"');
     ?>
     <pre>
     <?php echo $log; ?>
     </pre>
     ```

   - 使用各種方式去瀏覽該網頁，一開始你會發現無法顯示任何資訊，請觀察 /var/log/messages 以及 /var/log/httpd/error_log  			然後自行設法克服之。 (注意，每個系統多多少少都不太一樣，因此很可能會發生多重 SELinux 的修訂，且每部系統產生的問題都可能不相同！ 			故，請以自己的系統訊息來解決喔！)

透過上述的練習，你的 apache 應該可以順利的去呼叫外部程式來執行！這讓你的系統管理界面可以逐漸的在 Web 面進行，已達到管理界面網頁化的目的。 當然啦，個人建議，這樣的界面還是鎖在外部無法連接的環境下較佳，避免某天不小心因為系統漏洞的關係而被攻擊啊！

### 11.5： WGSI 網頁支援

在台灣我們比較慣用 PHP 網頁程式語言，但是現在因為 python 的流行相當廣泛，所以目前很多的 Web server 也都支援 python 網頁的喔！ 那如何讓你的 apache 支援 python 呢？這就得要使用所謂的 WSGI (Web Server Gateway Interface) 來處理了。要達成 WSGI 似乎也沒有這麼麻煩， 只要直接安裝 mod_wsgi 就可以！

```
[root@localhost ~]# yum search mod_wsgi
python3-mod_wsgi.x86_64 : A WSGI interface for Python web applications in Apache
python38-mod_wsgi.x86_64 : A WSGI interface for Python web applications in Apache

[root@localhost ~]# yum install python3-mod_wsgi
```

一般來說，我們會將可執行 WSGI 的程式碼通通放置到某個目錄下，那就得要額外的一些設定項目才行，亦即需要在目錄執行權限加上 ExecCGI 的項目才可以。 此外，我們也需要指定副檔名～例如 php 的副檔名為 .php ，那麼 WSGI 的副檔名就讓我們指定為 .wsgi 吧！假設所有的腳本都放置到 /var/www/html/wsgi 裡面， 那麼我們的設定就得要變成：

```
[root@localhost ~]# vim /etc/httpd/conf.d/yourfile.conf
<Directory "/var/www/html/wsgi">
        Options +ExecCGI
        Require all granted
        AddHandler wsgi-script .wsgi
</Directory>
```

完成設定並且重新啟動 httpd 之後，可以嘗試寫一隻 python 的腳本在該目錄下，例如寫一隻很簡單的顯示訊息的腳本：( https://www.server-world.info/en/note?os=CentOS_8&p=httpd&f=10)

```
[root@localhost ~]# vim /var/www/html/wsgi/showip.wsgi
#!/usr/bin/python3
def application(environ, start_response):
    status = '200 OK'
    html = '<html>\n' \
     '<body>\n' \
     '<div style="width: 100%; font-size: 40px; font-weight: bold; text-align: center;">\n' \
     'WSGI Test Page\n' \
     '</div>\n' \
     '</body>\n' \
     '</html>\n'.encode("utf-8")
    response_header = [('Content-type','text/html')]
    start_response(status,response_header)
    return [html]
```

接下來瀏覽該腳本，例如： curl http://localhost/wsgi/showip.wsgi，理論上就可以看到一個『WSGI Test Page』的字樣了！

- url 與腳本的對應

以上面的例子來說，除非我在 index.html 後面再加一個首頁檔名，否則 showip.wsgi 就得要使用超連結才能連結到該檔案去執行。 不過，有沒有辦法不要設定上述的項目，而是讓使用者輸入 http://localost/wsgi/ 就能執行該腳本呢？可以的！透過腳本對應即可。 基本語法是這樣的：

```
WSGIScriptAlias /url/ /real/path/filename.wsgi
```

就讓我們來測試一下吧！

​		例題 11.4.A：以上述的腳本對應功能，讓使用者輸入 http://your.hostname/wsgi/ 時，就可以直接執行 showip.wsgi 的檔案。 



### 11.6： squid proxy server 架設

早期的網路世界，由於頻寬難得，因此會有許多降低頻寬使用率的方式來協助 LAN 內的 Web 使用狀態。其中一個常用來『假裝好像加速器』的服務， 那就是網頁代理伺服器 (Proxy server)。為何說這是假性加速器呢？原因是，基本上 Proxy Server 會將找過的網頁資料存一份在自己的硬碟， 當下次有人要搜尋同一個網址時，Proxy server 會直接從硬碟或快取中將資料直接回傳給用戶，這就免除再次前往較慢的網路搜尋的時間， 所以感覺好像是有『加速』的感覺！所以，最單純的 Proxy 功能如下圖所示：

![Proxy server](https://dic.vbird.tw/linux_server/images/proxy_server_02.gif)

- Proxy server 的運作流程

當 Proxy server 第一次發現要去的 URL 網址時，他的資料存取流程如下：

1. Client 端向 Server 端發送一個資料需求封包；
2. Server 端接收之後，先比對這個封包的『來源』與預計要前往的『目標』網站是否為可接受？ 如果來源與目標都是合法的，或者說，來源與目標網站我們的  	Proxy 都能幫忙取得資料時，那麼 Server 端會開始替 Client 取得資料。這個步驟中比較重要的就是『比對政策』啦，有點像是認證的感覺啦；
3. Server 發現快取並沒有 Client 所需要的資料，準備前往網際網路抓取資料；
4. Server 開始向 Internet 發送要求與取得相關資料；
5. 最後當然就是將資料回傳給 Client 端囉！

當 Proxy server 本身的快取就有用戶要求的 URL 資料時：

1. Client 端向 Server 端發送一個資料需求封包；
2. Server 端接收之後，開始進行政策比對 (如同前一組步驟 2 的說明)；
3. Server 首先會檢查自己快取 (新的資料可能在記憶體中，較舊的資料則放置在硬碟上) 資料， 如果有 Client 所需的資料，那就將資料準備取出，而不經過向  	Internet 要求資料的程序；
4. 最後當然就是將資料回傳給 Client 端囉！

- 近期 proxy server 的功能

不過由於目前台灣地區的島內頻寬算是夠用了，因此 Proxy server 對於國內的使用來說，目前似乎沒有這個需求了！不過，如果以資傳系來說， 系上的色彩管理國際課程需要連結美國去進行取得課程資料以及考試，而台灣的 TANET 學術網路連結到美國的速度似乎有點過慢。 此時，透過外部的 proxy server (例如中華電信或seed net等其他家電信公司) 連結，跑不同的 gateway 時，其速度會比較快速喔。 其原理有點像這樣：

![Proxy server](https://dic.vbird.tw/linux_server/images/proxy_server_parent_more.gif)

所以，透過這個 proxy server 就可以進行特別的路由判斷哩！雖然是假的，不過，確實有加速網頁讀取的功能！另外， 其實目前頻寬足夠的情況下，proxy server 似乎無須進行 cache 喔！都透過直接再次讀取，速度也不慢 (有時加上 cache 速度反而會變慢， 因為 proxy server 還得要計算與搜尋內部的 cache 資料之故。)

另外，某些網頁設定只給 LAN 使用，此時透過內部 proxy server 並加上驗證，就能夠透過這部 proxy server 來存取內部的服務了。 這也是目前很常用的一個方式 (也不容易被攻擊，因為攻擊者不知道可以透過這個流向來存取內部服務之故。)

- Squid server

雖然 apache 也有內建的 proxy 功能，不過，說到 proxy server，應該還是使用原生的 squid 這個用來作為 proxy 之用的軟體比較好。 所以，底下就來處理一下 squid 這個 proxy server 的服務設定吧。

​		例題 11.6.A：安裝好 squid ，啟動 squid 並且觀察 squid 啟動的埠口是幾號？ 

其實最簡易的 squid 設定就是只給本機使用而已，若要放行外部的使用權限，就得要透過存取控制 (access control list) 來處理了。 基本上的語法很簡單，就是分別規定 (1)能使用 proxy 的來源用戶端，或者是 (2)規定能外出的目的 Web server 端而已。 基本語法有點像這樣：

```
[root@localhost ~]# vim /etc/squid/squid.conf
acl yourname  src IP/32 Net1/24 Net2/24...   # 控制的是用戶端來源 IP
acl yourname2 dst IP/32 Net1/24 ...          # 控制的是要協助代理去哪個 server 的IP
acl yourname3 dstdomain .domain.name ...     # 控制的是要協助代理去哪個 server 的 hostname
http_access deny yourname3                   # 先拒絕不要去的伺服器
http_access deny yourname2
http_access allow yourname                   # 再接受允許的用戶端！
```

基本上，一般我們只會控制信任的來源用戶端而已，因此，最重要的其實只有『 acl yourname src IP... 』那一段，然後再將該段放行『 http_access allow youname 』就搞定了， 相當容易的。

​		例題 11.6.B： 	

1. 放行 squid 的使用權： 		
   - 增加一個名為 mydic 的 acl 名稱，然後放行的是來源 IP 為你的內網
   - 將 mydic 放入支援的存取控制列表 (http_access allow) 當中
   - 重新啟動 squid (systemctl reload squid)
2. 用戶端的設計與伺服器端的登錄資訊： 		
   - 前往用戶端，啟動瀏覽器，設定好 proxy ，測試一下能否連上網。
   - 前往 server 端，觀察一下 cache 目錄是否有變化
   - 查看一下 squid 的登錄檔資訊
3. 若你的 proxy 還需要針對 172.16.0.0/16 這一段做放行，該如何處理 (兩大考量，一個是 squid 的設定，一個是防火牆設定)



### 11.7： 課後練習

1. (70%)實作題：啟動 Server 作業硬碟 - unit11	

   1. 網路參數的設定，請依據底下的方式來設定好你的網路環境： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 為外部的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.18.255.*/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.18.255.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 使用 teamd 的機制建立內部區域網路的備援功能： 		

         - team 的界面使用 team0 卡號，且連線名稱請命名為 team0
         - team 使用 activebackup 備援功能，不要使用 loadbalance
         - team 的實體網卡 (team slave) 請使用 ens7 及 ens8 ，且其連線名稱名稱亦請命名為 ens7, ens8
         - team0 網路參數為： 172.19.*.254/24，不需要 gateway 

      4. 主機名稱指定為： server*.example.dic

      5. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 基本的伺服器作業系統設定行為： 	

      1. 使用崑山的 FTP 網站作為你的 YUM server 來源，來源倉儲至少需要涵蓋 BaseOS, AppStream, extras, PowerTools 等， 		並且清除一次 yum 清單快取。(請注意，由於最終系統會全系統升級一次，升級後，這些設定檔可能會被更新。 		因此，你在全部升級完畢之後，還需要回來修改這個設定檔喔！)
      2. 安裝相關的軟體，至少須安裝 vim-enhanced, bash-completion, net-tools, mailx, wget, links, bind-utils,  		kernel-tools, kernel-modules (某些軟體可能需要使用 PowerTools 軟體倉儲安裝喔！但是該軟體倉儲預設需要是不啟用 
      3. 全系統自動升級，且每天凌晨 3 點也會自動升級一次。(請寫入 /etc/crontab 為主)
      4. 將 SELinux 修改成為 Enforcing 模式，且未來每次開機都自動為 Enforcing 才行

   3. 實際設定好本機防火牆 

      1. 請關閉 firewalld 服務，並且自行安裝、啟動 iptables 服務
      2. 將預設的規則轉存到 /root/firewall.sh 這個檔案內
      3. 首先將全部的規則刪除 (應該有三條指令)
      4. 設定好預設政策，讓 INPUT 成為 DROP 而 OUTPUT 與 FORWARD 成為 ACCEPT
      5. 針對 INPUT 前三條規則為 (1)回應封包 (2)放行 lo 界面 (3)放行 icmp 封包
      6. 放行你自己的內部區域網路那個網域的連線要求 (針對 LAN 的信任設定)
      7. 讓 ssh 只對外部的區網放行，不會對 Internet 放行 (對 ssh 連線做限制較佳)
      8. 讓 http 針對整個 Internet 放行 (一般公開的服務設計)
      9. 最後讓確定的規則轉存到 /etc/sysconfig/iptables 這個設定檔
      10. 重新啟動 iptables 服務，然後觀察規則是否正確

   4. 實際設定好 Server 的路由功能 

      1. 讓核心支援 IP 轉遞的功能，並且每次重新開機都可以自動生效
      2. 修改 /root/firewall.sh ，在該檔案加入清除 nat 表格的規則與自訂鏈的設定
      3. 增加規則：讓來自內部網路的封包，在路由判斷後，並預計由 ens3 對外網卡出去的封包，全部偽裝成為 ens3 的 IP 位址 	 (一般在數據機上面的就是 public IP)
      4. 在 /etc/sysconfig/iptables-config 當中增加 nf_nat_ftp 及 nf_conntrack_ftp 模組功能
      5. 上述功能在開機後依舊能夠順利啟動

   5. 虛擬主機的架設 	

      1. 讓 server*.example.dic 可以瀏覽到 /var/www/html/ 這個目錄，且首頁會顯示『 I am server*.example.dic service 』
      2. 讓 server.lan*.example.dic 可以瀏覽到 /var/www/lan/ 這個目錄，且首頁會顯示『 This is LAN service 』。 		此外，這個目錄會讓 alex 這個用戶具有完整的存取權限 (用戶若不存在，請自行建立。且密碼會跟用戶名稱相同。同時， 		建議使用 acl 進行處理)
      3. 當用戶使用 https://server*.example.dic 或其他的 https:// 瀏覽時，都會自動被導向 /var/www/ssl/ 目錄， 		且首頁會顯示『 Here is HTTPS services 』

   6. 資料庫建置 	

      1. 請使用安全的方式 (包括加上 root 密碼設定為 2727175) 來處理 Mariadb 這個資料庫的建立 (hint: mysql_secure_installation)
      2. 讓你的 Web server 可以支援 PHP，PHP 可支援 Mariadb 資料庫，且上傳的檔案最大容量可達 32MB
      3. 建立如下的資料庫用戶 		
         - 資料庫： mydb
         - 主機名稱： localhost
         - 帳號： myuser
         - 密碼： mypass
      4. 下載 [這個檔案](https://dic.vbird.tw/linux_server/download/database.sql) 的內容，然後依據這個檔案的內容重建你的資料庫！
      5. 以本課程的說明，讓你的 http://server.lan*.example.dic/phpbb/ 目錄可以使用操作你的 phpbb 論壇 (請注意，我們的 CentOS 8 伺服器， 		當初使用最小安裝，因此許多的軟體預設都不會存在。如果出現任何空白畫面，記得前往 server 的 log 檔案查閱，並自行查詢解決方案。 		此外，你也可以設定 setenforce 0，等待安裝完畢後，再轉回 Enforcing 即可)

   7. 其他設定 	

      1. 讓你的 Apache 可以支援 python 等 WSGI 程式，並且透過腳本別名來執行某個特定腳本： 		
         - 利用本節課程當中提到的 showip.wsgi 的檔案，將該檔案放置於 /var/www/wsgi/ 目錄中
         - 設定 web server，讓用戶輸入 http://你的主機名稱/showip/ 時，就會執行該腳本的功能。
      2. 設定好 squid server，讓你的內網可以使用你的 squid 向外瀏覽。另外，當崑山科大資傳系的三段 Class C 中的網域電腦使用這個 proxy 時， 		也可以取得 proxy 的使用權。假設 squild 的設定中，限定使用 ksudic 這個 acl 的暱稱來處理。至於三段 IP 分別是 		120.114.140.0/24, 120.114.141.0/24, 120.114.142.0/24

2. (10%)實作題：啟動 client 作業硬碟 

   1. 網路參數的設定，請依據底下的方式來設定好： 	

      1. 因為我們的系統是 clone 來的，因此裡面的網路卡連線會跑掉。所以，請先刪除所有的連線界面後， 		再依據底下的要求逐次建立好你的網路環境：

      2. 建立 ens3 的連線網卡 (相同的連線界面名稱)，使用 ethernet 類型，且： 		

         - IPv4 的 IP位址： 172.19.*.1/24 ，其中 * 為老師規定的 IP 尾數
         - gateway 為 172.19.*.254
         - DNS 為 172.16.200.254 以及 168.95.1.1

      3. 主機名稱指定為： client.lan*.example.dic

      4. 最終你的主機名稱與 IP 的對應為：

         ```
         server*.example.dic	172.18.255.*		別名為 server*
         server254.example.dic	172.18.255.254		別名為 server254
         server.lan*.example.dic	172.19.*.254		別名為 server
         client.lan*.example.dic	172.19.*.1		別名為 client
         ```

   2. 實際設定好本機防火牆 

      1. 預設請使用 firewalld 防火牆服務，不要使用 iptables 服務！
      2. 請將預設的領域 (zone) 改為 work 領域
      3. 預計放行的服務主要有 ssh 與 http 兩個服務，其他還可能有預設會啟用的 dhcp 用戶端服務。
      4. 查詢 rich rule (man firewalld.richlanguage)，確認來自本機同一個 LAN 網段的封包，通通給予放行。
      5. 上述放行的防火牆服務，在下次重新開機後，依舊會存在才行

3. (20%)簡易問答題：(後面兩題 4 分，其他 3 分) 	從具有 GUI 及中文的用戶端 Linux ，使用『 ssh root@172.19.*.254 』登入你的 Server ，之後建立 /root/ans.txt 的檔案，並將底下各題目的答案寫入你 server 當中！ 

   1. 架設 Apache 虛擬主機時，主機名稱需要那一個服務的支援才能在 internet 上面被查詢到？
   2. 那一個指令運作過後可以讓 Mariadb 在比較安全的狀態下執行？
   3. 那一個指令可以讓 Mariadb 的 thisdata 資料庫完整的備份下來，且備份的檔案名稱為 /mydata.sql (假設操作者資料庫名為 datauser)
   4. 要讓 web server (Apache 這個伺服器) 能夠使用 bash script 的呼叫，且可以切換成為 root 或其他帳號的身份執行腳本，需要如何設定？
   5. 找一下 google，請問底下兩個結果的 $log 有何不同？ 	
      - $log = exec ('some script');
      - $log = shell_exec ('some script');
   6. 在 apache 裡面，想讓 /var/www/html/scripts/ 目錄可以執行 wsgi 的程式，且副檔名假設同時支援 .wsgi 與 .py 時， 	應該要如何設定目錄資源？

4. 上傳成績 

   1. 請將 Server/Client 的硬碟通通啟動，並且確認兩者間的連線沒有問題；
   2. 在 Server 硬碟上面登入，然後用 root 的身份執行 vbird_server_check_unit ，並依據提示資料填寫你的學號與 IP 尾數
   3. 該程式會偵測你的系統，並且通知你哪個部份可能有問題，你需要持續觀察或者重新處理的部份會交代妥當。
   4. 若一切沒問題，螢幕就會出現如下的字樣，然後你就能夠使用 links 去檢查你的檔案是否有順利的上傳了！
   5. Please use links http://172.18.255.250/upload/unit11 to check your filename