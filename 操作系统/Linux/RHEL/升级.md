# 升级

[TOC]

## RHEL 8 --> RHEL 9

使用 Leapp 程序把 Red Hat Enterprise Linux 8 原位 (in-place) 升级到 Red Hat Enterprise Linux 9 。

### 主要迁移术语

**Update（更新）**

更新（有时称为软件补丁）是正在运行的应用程序、操作系统或软件的一个补充。软件更新用于解决存在的问题或漏洞，以便提供更好的使用体验。在 RHEL 中，更新与次版本相关，例如，从 RHEL 8.1 更新到 8.2。

**Upgrade（升级）**

升级是使用一个新的版本替换当前运行的应用程序、操作系统或软件的版本。通常情况下，需要首先对数据进行备份。升级 RHEL 时，有两个选项：

- **原位升级（In-place upgrade）：**在原位升级过程中，可以在不先删除旧版本的情况下将旧版本替换为新版本。安装的应用程序和实用程序，以及相关的配置和首选项都会融合到新版本中。原位升级（in-place upgrade）是把系统升级到下一个主要 RHEL 版本的推荐并支持的方法。
- **全新安装（Clean install）：**干净安装会删除之前安装的操作系统、系统数据、配置和应用程序的所有数据，并安装最新版本的操作系统。如果不需要之前的数据或应用程序，或者您要部署的新项目不依赖于以前的构建，则全新安装是一个理想的选择。

**操作系统转换**

转换是将操作系统从不同的 Linux 发行版转换为 Red Hat Enterprise Linux。通常情况下，您需要首先对数据进行备份。

**Migration（迁移）**

通常，迁移表示对平台（软件或硬件）进行更改。从 Windows 变为 Linux  是一种迁移。用户从使用一个笔记本电脑换为使用另外一个笔记本电脑，公司从使用一个服务器换为使用另一台服务器，都是迁移。但是，大多数迁移都涉及到升级，因此有时此术语可以互换使用。

- **迁移到 RHEL：**将现有操作系统转换到 RHEL 。
- **跨 RHEL 迁移：**从一个 RHEL 升级到另一个版本。

### 支持的升级路径

原位升级会将系统中的 RHEL 8 操作系统替换为 RHEL 9 版本。

> 重要：
>
> 无法执行从 RHEL 7 直接升级到 RHEL 9 的原位升级。但是，可以执行从 RHEL 7 原位升级到 RHEL 8，然后再执行到 RHEL 9 的第二个原位升级。

目前，可以执行从以下源 RHEL 8 次版本的原位升级到以下目标 RHEL 9 次版本：

| 产品变体 | 源操作系统版本 | 目标操作系统版本 |
| -------- | -------------- | ---------------- |
| RHEL     | RHEL 8.7       | RHEL 9.0         |

### 计划升级

应该在升级到 RHEL 9 前考虑以下问题：

- **操作系统** — 在以下情况下使用 `Leapp` 程序升级操作系统：

  - 源操作系统版本安装在有以下支持的构架的系统中：
    - 64 位 Intel、AMD 和 ARM
    - IBM POWER(little endian)
    - 64-bit IBM Z
  - 满足 RHEL 9 的最低[硬件要求](https://access.redhat.com/articles/rhel-limits) 					
  - 访问提供的 RHEL 8.7 和 RHEL 9.0 内容 ; 详情请参阅[为升级准备 RHEL 8 系统](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#preparing-a-rhel-8-system-for-the-upgrade_upgrading-from-rhel-8-to-rhel-9)的步骤 1。 					

- ​					**应用程序** - 您可以使用 `Leapp` 迁移安装在系统中的应用程序。然而，在某些情况下，您必须创建 custom actors，它用来在升级过程中指定 `Leapp` 要执行的操作，例如： 重新配置应用程序或安装特定的硬件驱动程序。如需更多信息，请参阅[处理自定义应用程序和第三方应用程序的迁移](https://access.redhat.com/articles/4977891#actors)。请注意，红帽不支持 custom actor。 			

  重要

  ​						在 RHEL 9 中弃用了 `SHA1`。如果您的系统包含 `RSA/SHA1` 签名的任何软件包，则升级会被禁止。在升级前，可以删除这些软件包，或联系带有 `RSA/SHA256` 签名的软件包的供应商。如需更多信息，请参阅 [Red Hat Enterprise Linux 9 中的 SHA-1 弃用](https://access.redhat.com/articles/6846411)。 				

- ​					**安全性** - 您应该在升级前评估这个方面，并在升级过程完成后采取其他步骤。请特别考虑以下几点： 			

  - ​							在升级前，定义您的系统必须遵守的安全标准，并了解 [RHEL 9 中的安全更改](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/considerations_in_adopting_rhel_9/assembly_security_considerations-in-adopting-rhel-9)。 					

  - ​							在升级过程中，`Leapp` 会将 SELinux 的模式设置为 permissive。 					

  - ​							不支持使用 FIPS 模式进行原位升级。 					

    注意

    ​								红帽不支持先关闭 FIPS，从 RHEL 8 升级到 9，再打开 FIPS。要符合 FIPS，所有加密密钥都必须由 FIPS  验证的加密模块使用。因此，在没有重新生成加密密钥的情况下不支持在升级后启用  FIPS。请注意，红帽不会跟踪每个创建的加密密钥，因此无法自动执行此任务。 						

  - ​							升级完成后，重新评估并重新应用您的安全策略。有关应用和更新安全策略的详情，请参阅[应用安全策略](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#applying-security-policies_upgrading-from-rhel-8-to-rhel-9)。 					

- ​					**存储和文件系统** - 您应该在升级前备份您的系统。例如，您可以使用 [Relax-and-Recover (ReaR)实用程序](https://access.redhat.com/solutions/2115051)、[LVM 快照](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_logical_volumes/index#proc_creating-snapshot-volumes-snapshot-volumes)、[RAID splitting](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_logical_volumes/index#splitting-and-merging-a-raid-image_configuring-raid-logical-volumes) 或虚拟机快照。 			

  注意

  ​						文件系统格式没有改变。因此，文件系统的限制与最初创建的限制相同。 				

- ​					**高可用性** - 如果您使用高可用性附加组件，请按照 [将软件更新应用到 RHEL 高可用性或弹性存储](https://access.redhat.com/articles/2059253) 集群知识库文章。 			

- ​					**停机时间** — 升级过程可能会需要几分钟到几小时。 			

- ​					**satellite** - 如果您通过 Satellite 管理主机，您可以使用 Satellite Web UI 同时将多个主机从 RHEL 8 升级到 RHEL 9。如需更多信息，请参阅 [将主机从 RHEL 7 升级到 RHEL 8](https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html/managing_hosts/upgrading-hosts-from-rhel7-to-rhel8_managing-hosts)。 			

- ​					**公共云** - 支持在带有 [Red Hat Update Infrastructure (RHUI)](https://access.redhat.com/documentation/en-us/red_hat_update_infrastructure/4/html/configuring_and_managing_red_hat_update_infrastructure/assembly_cmg-about-rhui4_configuring-and-managing-red-hat-update-infrastructure) 的 Amazon Web Services (AWS)、Microsoft Azure 和 Google Cloud Platform 中的  Pay-As-You-Go (PAYG) 实例进行原位升级。原位升级还支持在所有使用 RHSM 进行 RHEL 订阅的公共云上生成您的 Own  订阅实例。 			

- ​					**语言** - 无论语言配置如何，所有 `Leapp` 报告、日志和其他生成的文档均为英语。 			

- ​					**Bootloader** - 在 RHEL 8 或 RHEL 9 中无法将引导装载程序从 BIOS 切换到 UEFI。如果您的 RHEL 8 系统使用 BIOS，而您希望 RHEL 9 系统使用 UEFI，请执行全新的 RHEL 9 安装，而不是原位升级。如需更多信息，请参阅 [是否可以在预安装的 Red Hat Enterprise Linux 机器上将 BIOS 引导切换到 UEFI 引导？](https://access.redhat.com/solutions/1990803) 			

- ​					**已知的限制** - 目前已知的重要的 `Leapp` 限制包括： 			

  - ​							目前，对整个磁盘或者分区进行加密，或对文件系统加密还不能用于计划进行原位升级的系统中。 					
  - ​							不能使用基于网络的多路径（Multipath）或者任何类型的网络存储挂载用作系统分区（例如: iSCSI 或 NFS）。 					
  - ​							目前，在使用 Red Hat Update Infrastructure 而不是 Red Hat Subscription  Manager（RHSM）进行订阅 RHEL 的公共云（Huawei Cloud、Alibaba Cloud）上的  on-demand（PAYG）实例还不支持原位升级。 					

​			请参阅 [已知问题](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#known-issues_troubleshooting)。 	

​			您可以使用 **[Red Hat Insights](https://console.redhat.com/insights/dashboard)** 确定您注册到 Insights 的哪些系统位于 RHEL 9 的升级路径中。要做到这一点,进入 Insights 中的相应的[顾问建议](https://console.redhat.com/insights/advisor/recommendations/el8_to_el9_upgrade|RHEL8_TO_RHEL9_UPGRADE_AVAILABLE)，在 *Actions* 下拉菜单下启用建议，并检查*受影响的系统*标题下的列表。请注意： Advisor 推荐只会考虑 RHEL 8 次要版本，它不会执行系统升级前评估。另请参阅 [Advisor Service Recommendations](https://access.redhat.com/documentation/en-us/red_hat_insights/2022/html/assessing_rhel_configuration_issues_using_the_red_hat_insights_advisor_service/index#con-adv-assess-recommendations_adv-assess-recommendations)。 	

# 第 3 章 准备升级

​			要防止升级后出现问题，并确保您的系统已准备好升级到 RHEL 的下一个主要版本，请在升级前完成所有必要的准备步骤。 	

​			您必须在所有系统上执行 [为升级准备 RHEL 8 系统](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#preparing-a-rhel-8-system-for-the-upgrade_upgrading-from-rhel-8-to-rhel-9)中所描述的准备步骤。另外，在注册到 Satellite 服务器的系统上，还必须执行 [为升级准备 Satellite 注册系统 中描述的准备步骤](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#proc_preparing-a-satellite-system-for-the-upgrade_upgrading-from-rhel-8-to-rhel-9)。 	

## 3.1. 为升级准备 RHEL 8 系统

​				这个步骤描述了在使用 `Leapp` 程序对 RHEL 9 进行原位升级前需要进行的步骤。 		

​				如果您在升级过程中不计划使用 Red Hat Subscription Manager (RHSM)，请参阅[在没有 Red Hat Subscription Manager 的情况下升级到 RHEL 9](https://access.redhat.com/articles/4977891#upgrade-without-rhsm-rhel9)。 		

**先决条件**

- ​						系统满足[规划升级](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#planning-an-upgrade_upgrading-from-rhel-8-to-rhel-9)中列出的条件。 				

**流程**

1. ​						如果您之前从 RHEL 7 升级到 RHEL 8，请在您的系统中存在 `/root/tmp_leapp_py3` 目录时删除它： 				

   

   ```none
   # rm -rf /root/tmp_leapp_py3
   ```

   重要

   ​							如果在执行升级时在您的系统中存在 `/root/tmp_leapp_py3` 目录，则该系统可能会在升级后中断。 					

2. ​						使用 Red Hat Subscription Manager 确定您的系统已被成功注册到 Red Hat Content Delivery Network (CDN)或 Red Hat Satellite。 				

3. ​						如果您已将您的系统注册到 Satellite 服务器，请完成 [为升级准备 Satellite 注册系统](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#proc_preparing-a-satellite-system-for-the-upgrade_upgrading-from-rhel-8-to-rhel-9) 中的步骤，以确保您的系统满足升级要求。 				

4. ​						确定已附加了 [Red Hat Enterprise Linux Server 订阅](https://access.redhat.com/solutions/253273)。例如： 				

   

   ```none
   # subscription-manager list --installed
   +-------------------------------------------+
       	  Installed Product Status
   +-------------------------------------------+
   Product Name:  	Red Hat Enterprise Linux x86_64
   Product ID:     479
   Version:        8.6
   Arch:           x86_64
   Status:         Subscribed
   ```

5. ​						确定启用了适当的软件仓库。以下命令为 64 位 Intel 架构启用 Base 和 Appstream 软件仓库；对于其他架构，请参阅 [RHEL 8 软件仓库](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#appendix-rhel-8-repositories_upgrading-from-rhel-8-to-rhel-9)。 				

   

   ```none
   # subscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms --enable rhel-8-for-x86_64-appstream-rpms
   ```

   注意

   ​							另外，您可以启用 CodeReady Linux Builder （也称为 Optional）或 Supplementary 软件仓库。有关存储库 ID 的更多信息，请参阅 [RHEL 8 软件仓库](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#appendix-rhel-8-repositories_upgrading-from-rhel-8-to-rhel-9)。有关这些存储库的内容的更多信息，请参阅 [软件包清单](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/package_manifest)。 					

6. ​						对于使用 RHSM 订阅的系统，将系统锁定到 RHEL 8.7： 				

   

   ```none
   # subscription-manager release --set 8.7
   ```

7. ​						可选： 如果您要使用自定义软件仓库，请根据[配置自定义软件仓库](https://access.redhat.com/articles/4977891#repos-config)中的内容配置它们。 				

8. ​						如果您使用 `dnf versionlock` 插件将软件包锁定到特定版本，请运行以下命令清除锁： 				

   

   ```none
   # dnf versionlock clear
   ```

   ​						如需更多信息，请参阅 [How to restrict dnf to install or upgrade a package to a fixed specific package version?](https://access.redhat.com/solutions/98873)。 				

9. ​						如果您要在公共云上使用 Red Hat Update Infrastructure (RHUI)升级，请启用所需的 RHUI 软件仓库并安装所需的 RHUI 软件包，以确保您的系统已准备好升级： 				

   1. ​								对于 AWS： 						

      

      ```none
      # dnf config-manager --set-enabled rhui-client-config-server-8
      # dnf -y install rh-amazon-rhui-client-ha leapp-rhui-aws
      ```

   2. ​								对于 Microsoft Azure： 						

      

      ```none
      # dnf config-manager --set-enabled rhui-microsoft-azure-rhel8
      # dnf -y install rhui-azure-rhel8 leapp-rhui-azure
      ```

   3. ​								对于 Google Cloud Platform，请遵循 [Google Cloud Platform (GCP)](https://access.redhat.com/articles/6981918) 知识库文章。 						

10. ​						将所有软件包更新到最新的 RHEL 8 版本： 				

    

    ```none
    # dnf update
    ```

11. ​						重启系统： 				

    

    ```none
    # reboot
    ```

12. ​						安装 `Leapp`： 				

    

    ```none
    # dnf install leapp-upgrade
    ```

    ​						请注意，您目前需要版本 0.15.0 或更高版本的 `leapp` 软件包，版本 0.17.0 或更高版本的 `leapp-repository` 软件包，其中包含 `leapp-upgrade-el8toel9` RPM 软件包。 				

    注意

    ​							如果您的系统无法访问互联网，请[从红帽客户门户网站下载以下软件包](https://access.redhat.com/downloads/content/479/ver=/rhel---8/8.5/x86_64/packages) ： 					

    - ​									`leapp` 							
    - ​									`leapp-deps` 							
    - ​									`python3-leapp` 							
    - ​									`leapp-upgrade-el8toel9` 							
    - ​									`leapp-upgrade-el8toel9-deps` 							

13. ​						确保您可以访问其它必要的数据文件的最新版本，包括 RPM 软件包更改、RPM 存储库映射和不受支持的驱动程序和设备。 				

    1. ​								如果您使用 RHSM 进行升级，系统可以访问  cloud.redhat.com，并且您尚未下载所需数据的较早版本，则不需要进一步的操作。数据文件从 cloud.redhat.com  自动下载。这也适用于开发人员订阅。如果您的系统位于代理后面，您可以使用 `$LEAPP_PROXY_HOST` 环境变量来访问数据。 						
    2. ​								下载附加到知识库文章 [用于断开连接升级的 RHEL 的 Leapp 工具元数据升级](https://access.redhat.com/articles/3664871) 的数据文件，并将它们放在 `/etc/leapp/files/` 目录中。请注意，您目前需要 `leapp-data19.tar.gz` 归档或更新的数据文件。在以下情况下，这是成功升级所必需的： 						
       1. ​										您使用 RHUI 在公共云上升级。如果您没有红帽订阅或红帽客户门户网站帐户，请创建一个免费 RHEL 开发人员订阅，以便您访问知识库文章并下载所需的数据软件包。如需更多信息，请参阅[如何获取免费 Red Hat Enterprise Linux 开发人员订阅或更新它？](https://access.redhat.com/solutions/4078831) 								
       2. ​										您的系统无法访问互联网。 								
       3. ​										您使用 RHSM 进行升级，并在之前下载了所需数据文件的旧版本，但没有执行升级（例如用于创建自动化脚本）。您还可以删除旧版本的数据文件，以启动最新版本的自动下载。 								

14. ​						临时禁用防病毒软件以防止升级失败。 				

15. ​						确保任何配置管理系统都不会干扰原位升级过程： 				

    - ​								如果您使用客户端-服务器架构的配置管理系统（如 **Puppet**、**Salt** 或 **Chef** ），请在运行 `leapp preupgrade` 命令前禁用系统。在升级完成前，请不要启用配置管理系统，以防止升级过程中出现问题。 						

    - ​								如果您使用无代理架构的配置管理系统（如 **Ansible** ），在原位升级过程中不要执行配置和部署文件（如 Ansible playbook），如 [执行从 RHEL 8 到 RHEL 9 的升级](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#performing-the-upgrade-from-rhel-8-to-rhel-9_upgrading-from-rhel-8-to-rhel-9) 中所述。 						

      ​								红帽不支持使用配置管理系统进行预升级和升级过程的自动化。如需更多信息，请参阅 [使用配置管理系统在 Red Hat Enterprise Linux 上自动化部分 Leapp 预升级和升级过程](https://access.redhat.com/articles/6313281)。 						

16. ​						请确定您的系统没有使用多于一个的、名称基于内核使用的前缀（`eth`）的网络接口卡（NIC）。如需了解如何在原位升级到 RHEL 9 前迁移到另外一个命名模式的更多信息，请参阅 [How to perform an in-place upgrade to RHEL 8 when using kernel NIC names on RHEL 7](https://access.redhat.com/solutions/4067471)。RHEL 7 到 RHEL 8 升级的过程与从 RHEL 8 升级到 RHEL 9 时，迁移命名方案的过程相同。 				

17. ​						如果在 RHEL 7 或更早版本中创建您的 NSS 数据库，请验证数据库已从 DBM 数据库格式转换为 SQLite。如需更多信息，请参阅[将 NSS 数据库从 DBM 更新到 SQLite](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#proc_updating-nss-databases-from-dbm-to-sqlite_applying-security-policies)。 				

18. ​						RHEL 9 不支持旧的 `network-scripts` 软件包，该软件包在 RHEL 8 中已弃用。在升级前，移动自定义网络脚本并编写执行现有自定义脚本的 NetworkManager 分配程序脚本。如需更多信息，请参阅[迁移自定义网络脚本到 NetworkManager 分配程序脚本](https://access.redhat.com/solutions/6900331)。 				

19. ​						确定您有完整的系统备份或者虚拟机快照。请确定您可以按照您的环境中的标准灾难恢复步骤，把系统恢复到升级前的状态。例如，使用 Relax-and-Recover (ReaR) 程序进行备份。如需更多信息，请参阅 [ReaR 文档](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_basic_system_settings/assembly_recovering-and-restoring-a-system_configuring-basic-system-settings)以及 [Relax and Recover (ReaR) 是什么以及如何使用它进行灾难恢复？](https://access.redhat.com/solutions/2115051)或者，您可以使用 [LVM 快照](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_logical_volumes/index#proc_creating-snapshot-volumes-snapshot-volumes)或 [RAID split](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_logical_volumes/index#splitting-and-merging-a-raid-image_configuring-raid-logical-volumes)。如果升级虚拟机，您可以创建整个虚拟机的快照。 				

## 3.2. 为升级准备 Satellite 注册的系统

​				此流程描述了为升级到 RHEL 9 准备已注册到 Satellite 的系统所需的步骤。在 Satellite Server 上执行几个步骤。 		

重要

​					Satellite 系统上的用户必须完成此流程和 [为升级准备 RHEL 8 系统](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#preparing-a-rhel-8-system-for-the-upgrade_upgrading-from-rhel-8-to-rhel-9) 中所描述的步骤。 			

**先决条件**

- ​						您有对 Satellite 服务器的管理特权。 				

**流程**

1. ​						验证 Satellite 是否是完全支持或维护支持的版本。如需更多信息，请参阅 [Red Hat Satellite 产品生命周期](https://access.redhat.com/support/policy/updates/satellite)。 				

2. ​						将带有 RHEL 9 存储库的订阅清单导入到 Satellite 服务器。如需更多信息，请参阅特定版本的 [Red Hat Satellite](https://access.redhat.com/documentation/en-us/red_hat_satellite/) （例如 [6.10](https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html/content_management_guide/managing_subscriptions)）内容管理指南中的管理订阅章节。 				

3. ​						启用并同步所有所需的 RHEL 8 和 RHEL 9 软件仓库与 RHEL 8.7 和 RHEL 9.0 的最新更新。 				

   注意

   ​							对于 RHEL 9 软件仓库，请确保启用每个软件仓库的版本 9.0。如果您只启用了 RHEL 9 版本，则禁止原位升级。 					

   ​						例如，对于没有延长更新支持（EUS）订阅的 Intel 构架，至少启用以下软件仓库： 				

   - ​								Red Hat Enterprise Linux 8 for x86_64 - AppStream (RPMs) 						

     ​								rhel-8-for-x86_64-appstream-rpms 						

     ​								x86_64 8 或 8.7 						

   - ​								Red Hat Enterprise Linux 8 for x86_64 - BaseOS (RPMs) 						

     ​								rhel-8-for-x86_64-baseos-rpms 						

     ​								x86_64 8 或 8.7 						

   - ​								Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs) 						

     ​								rhel-9-for-x86_64-appstream-rpms 						

     ​								x86_64 9.0 						

   - ​								Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs) 						

     ​								rhel-9-for-x86_64-baseos-rpms 						

     ​								x86_64 9.0 						

     ​								有关其他架构，请参阅 [RHEL 8 软件仓库](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#appendix-rhel-8-repositories_upgrading-from-rhel-8-to-rhel-9)和 [RHEL 9 软件仓库](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#appendix_rhel-9-repositories_upgrading-from-rhel-8-to-rhel-9)。 						

     ​								如需更多信息，请参阅 [Red Hat Satellite](https://access.redhat.com/documentation/en-us/red_hat_satellite/) 特定版本（例如 [6.10](https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html/content_management_guide/importing_content)）的*内容管理指南* 中的 *导入内容* 章节。 						

4. ​						将内容主机附加到包含所需的 RHEL 8 和 RHEL 9 软件仓库的内容视图。 				

   ​						如需更多信息，请参阅 [Red Hat Satellite](https://access.redhat.com/documentation/en-us/red_hat_satellite/) 特定版本（例如 [6.10](https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html/content_management_guide/managing_content_views)）的 *内容管理指南* 中的 *管理内容视图* 一章。 				

**验证**

- ​						验证是否最新的 RHEL 8 软件仓库已在 Satellite 服务器上启用了。例如，要验证库生命周期环境中的存储库： 				

  

  ```none
  # hammer repository list --search 'content_label ~ rhel-9' --content-view <content_view_name> --organization <organization> --lifecycle-environment Library
  ```

  ​						将 *content_view_name* 替换为内容视图的名称，将 *organization* 替换为组织。 				

# 第 4 章 查看升级前报告

​			要评估系统的可升级性，请通过 `leapp preupgrade` 命令启动预升级过程。在这个阶段，`Leapp` 会收集有关系统的数据，评估可升级性，并生成预升级报告。 	

​			预升级报告可在 `/var/log/leapp/leapp-report.txt` 文件及 web 控制台中找到。这个报告总结了潜在的问题，并给出了推荐的解决方案。本次报告还帮助您决定升级是否可行。 	

​			在某些配置中，`Leapp` 生成 true/false 问题以确定如何进行。所有问题都存储在 `/var/log/leapp/answerfile` 中，以及 `Missing required answers in the answer file` 信息的预升级报告中。如果没有对所有问题提供答案，`Leapp` 会阻止升级。 	

​			在升级前评估可升级性时有两个选择： 	

1. ​					查看生成的 `leapp-report.txt` 文件中的预升级报告，并使用命令行界面手动解决问题。 			
2. ​					使用 Web 控制台查看报告，在可用的情况下应用自动修复，并使用推荐的修复提示修复剩余的问题。 			

重要

​				在预升级阶段，`Leapp` 并不会模拟整个原位升级过程，也不会下载所有 RPM 软件包。 		

​			如果您决定或需要在不进行原位升级的情况下重新部署 RHEL 8 系统，查看预升级报告也很有用。 	

注意

​				您可以使用自己的自定义脚本处理预升级报告，例如，比较不同环境的多个报告的结果。如需更多信息，请参阅[自动 Red Hat Enterprise Linux 预升级报告工作流](https://access.redhat.com/articles/5777571)。 		

## 4.1. 从命令行评估可升级性

​				使用命令行界面在预升级阶段识别潜在的升级问题。 		

**先决条件**

- ​						[准备升级](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#assembly_preparing-for-the-upgrade_upgrading-from-rhel-8-to-rhel-9)中列出的步骤已完成。 				

**流程**

1. ​						在 RHEL 8 系统中，执行预升级阶段： 				

   

   ```none
   # leapp preupgrade --target 9.0
   ```

   - ​								如果您要使用 `/etc/yum.repos.d/` 目录中的 [自定义程序仓库](https://access.redhat.com/articles/4977891#repos)进行升级，请启用所选程序仓库，如下所示： 						

     

     ```none
     # leapp preupgrade --enablerepo <repository_id1> --enablerepo <repository_id2> ...
     ```

   - ​								如果您要[在没有 RHSM 的情况下升级](https://access.redhat.com/articles/4977891#upgrade-without-rhsm-rhel9) 或使用 RHUI，请添加 `--no-rhsm` 选项。 						

   - ​								如果您有 [扩展升级支持(EUS)](https://access.redhat.com/articles/rhel-eus)、高级更新支持(AUS)或 [SAP 解决方案(E4S)的更新服务](https://access.redhat.com/solutions/3082481) 订阅，请添加 `--channel *channel*` 选项。使用渠道替换 *channel*，如 `eus`、`aus` 或`e4s`。 						

2. ​						通过以下任一方法之一回答 `Leapp` 所需的每个问题： 				

   - ​								执行 `leapp answer` 命令，指定您要回答的问题以及您已确认的答案。 						

     

     ```none
     # leapp answer --section <question_section>.<field_name>=<answer>
     ```

     ​								例如，要对问题 **Are all VDO devices, if any, successfully converted to LVM management?** 确认一个 `True` 的响应，请执行以下命令： 						

     

     ```none
     # leapp answer --section check_vdo.confirm=True
     ```

   - ​								手动编辑 `/var/log/leapp/answerfile` 文件，通过删除 `#` 符号取消对文件的最后一行的注释，并确认您的答案为 `True` 或 `False`; 请参阅 [Leapp answerfile](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#example-leapp_answerfile)。 						

3. ​						检查 `/var/log/leapp/leapp-report.txt` 文件中的报告，并在进行原位升级前手动解决问题。 				

## 4.2. 通过 web 控制台评估可升级性，并应用自动化修复方法

​				找出预升级阶段中的潜在问题，以及如何使用 Web 控制台应用自动化修复方法。 		

**先决条件**

- ​						[准备升级](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#assembly_preparing-for-the-upgrade_upgrading-from-rhel-8-to-rhel-9)中列出的步骤已完成。 				

**流程**

1. ​						安装 `cockpit-leapp` 插件： 				

   

   ```none
   # dnf install cockpit-leapp
   ```

2. ​						进入浏览器中的 Web 控制台，再以 `root` 或 `/etc/sudoers` 文件中配置的用户身份登录。如需有关 Web 控制台的更多信息，请参阅[使用 RHEL 8 Web 控制台管理系统](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_systems_using_the_rhel_8_web_console/index) 。 				

3. ​						在 RHEL 8 系统中，从命令行界面或 web 控制台终端执行预升级： 				

   

   ```none
   # leapp preupgrade --target 9.0
   ```

   - ​								如果您要使用 `/etc/yum.repos.d/` 目录中的 [自定义程序仓库](https://access.redhat.com/articles/4977891#repos)进行升级，请启用所选程序仓库，如下所示： 						

     

     ```none
     # leapp preupgrade --target 9.0 --enablerepo <repository_id1> --enablerepo <repository_id2> ...
     ```

   - ​								如果您要[在没有 RHSM 的情况下升级](https://access.redhat.com/articles/4977891#upgrade-without-rhsm-rhel9) 或使用 RHUI，请添加 `--no-rhsm` 选项。 						

   - ​								如果您有 [扩展升级支持(EUS)](https://access.redhat.com/articles/rhel-eus)、高级更新支持(AUS)或 [SAP 解决方案(E4S)的更新服务](https://access.redhat.com/solutions/3082481) 订阅，请添加 `--channel *channel*` 选项。使用渠道替换 *channel*，如 `eus`、`aus` 或`e4s`。 						

4. ​						在 web 控制台中，从左面菜单中选择 In-place Upgrade Report。 				

   图 4.1. Web 控制台中的原位升级报告

   [![Web 控制台中的原位升级报告](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Upgrading_from_RHEL_8_to_RHEL_9-zh-CN/images/6fef41b8e9b5cbd855edbffd9f9e66aa/leapp-web-console-report.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Upgrading_from_RHEL_8_to_RHEL_9-zh-CN/images/6fef41b8e9b5cbd855edbffd9f9e66aa/leapp-web-console-report.png)

   ​						报告表格提供了对发现问题、风险评估以及修复（如果有）的概述。 				

   - ​								风险因素： 						
     - ​										High - 对系统造成破坏的可能性较高 								
     - ​										Medium - 可能会同时影响到系统和应用程序 								
     - ​										Low - 不应该影响系统，但可能会影响应用程序 								
     - ​										Info - 对系统或应用程序没有预期的影响 								
   - ​								Inhibitor - 阻止升级过程（强制停止），否则系统将变得无法引导、无法访问或无法正常工作。 						
   - ​								修复 - 报告问题的可操作解决方案： 						
     - ​										修复命令 - 可直接通过 Web 控制台执行 								
     - ​										修正提示 - 如何手动解决问题的步骤 								

5. ​						检查报告的内容。您可以点击标头来排序表。要打开详细信息面板，请点击所选行。 				

   图 4.2. 详细信息面板

   ![详细信息面板](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Upgrading_from_RHEL_8_to_RHEL_9-zh-CN/images/9a80f157a5ffc8d651353cffd52f593e/leapp-detail-pane.png)

   ​						详情面板显示以下附加信息： 				

   - ​								问题概述及知识库文档链接更详细地描述了这个问题 						
   - ​								修复 - 您可以运行或调度一个自动修复（如果有），并在应用时查看其结果 						
   - ​								受影响的系统资源：软件包、库、文件（配置、数据）、磁盘、卷 						

6. ​						另外，可以对结果进行过滤。点击报告左上角的过滤器按钮，并根据您的情况应用过滤器。过滤器类别可和另外的过滤器一起使用。 				

   图 4.3. 过滤器

   ![过滤器](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Upgrading_from_RHEL_8_to_RHEL_9-zh-CN/images/7c0ff711f5b098c8e6be52027ed1bc92/leapp-filters.png)

7. ​						选择您要对其应用自动修复的问题。您有两个选项： 				

   1. ​								点击详情框中的 Add to Remediation Plan 按钮选择各个条目。另外，您还可以直接通过点击详情窗格中的 Run Remediation 来执行单独的修复。 						
   2. ​								点击报告右上角的 Add all remediations to plan 按钮选择可以选择提供修复的所有项目。 						

8. ​						在 web 控制台中查看并回答 `Leapp` 所需的问题。每个未回答的问题在升级报告中的 `Missing required answers in the answer file` 部分。选择回答问题的标题： 				

   1. ​								要确认默认的 `True` 答案，请选择 Add to Remediation Plan 以稍后执行修复或 Run Remediation 以立即执行修复。 						

   2. ​								要选择非默认回答，请执行以下任一操作： 						

      1. ​										执行 `leapp answer` 命令，指定您要回答的问题以及您已确认的答案。 								

         

         ```none
         # leapp answer --section <question_section>.<field_name>=<answer>
         ```

         ​										例如，要对问题 **Are all VDO devices, if any, successfully converted to LVM management?** 确认一个 `True` 的响应，请执行以下命令： 								

         

         ```none
         # leapp answer --section check_vdo.confirm=True
         ```

      2. ​										手动编辑 `/var/log/leapp/answerfile` 文件，通过删除 `#` 符号取消对文件的最后一行的注释，并确认您的答案为 `True` 或 `False`; 请参阅 [Leapp answerfile 示例](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#example-leapp_answerfile)。 								

         图 4.4. 缺少未回答的 Leapp 问题

         [![未回答的 Leapp 问题](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Upgrading_from_RHEL_8_to_RHEL_9-zh-CN/images/298369f0f30379f16ba480e03f68af04/leapp-dialog-web.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Upgrading_from_RHEL_8_to_RHEL_9-zh-CN/images/298369f0f30379f16ba480e03f68af04/leapp-dialog-web.png)

9. ​						点击报告右上角的 Remediation plan 链接打开修复计划。修复计划提供所有已执行或已调度的修复列表。 				

   图 4.5. 修复计划

   [![修复计划](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Upgrading_from_RHEL_8_to_RHEL_9-zh-CN/images/d8d34f2853acb020756271bc632b22f8/leapp-remediation-plan.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Upgrading_from_RHEL_8_to_RHEL_9-zh-CN/images/d8d34f2853acb020756271bc632b22f8/leapp-remediation-plan.png)

10. ​						点击 Execute Remediation Plan 处理所有已调度的修复。每个修复条目都包括以下信息： 				

    - ​								修复的唯一 ID 						
    - ​								命令的退出状态 						
    - ​								已执行的修复的持续时间 						
    - ​								标准输出 						
    - ​								标准错误 						

11. ​						执行所选的修复后，使用 `leapp preupgrade` 命令再次生成预升级报告，检查新报告，并在需要时执行额外的修复步骤。 				

# 第 5 章 执行从 RHEL 8 升级到 RHEL 9

​			此流程列出了使用 `Leapp` 程序执行从 RHEL 8 升级到 RHEL 9 所需的步骤。 	

**先决条件**

- ​					[准备升级](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#assembly_preparing-for-the-upgrade_upgrading-from-rhel-8-to-rhel-9) 中所列出的步骤已完成，包括全系统备份。 			
- ​					完成[检查预升级报告](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#reviewing-the-pre-upgrade-report_upgrading-from-rhel-8-to-rhel-9) 中列出的步骤，并解决了所有报告的问题。 			

**流程**

1. ​					在 RHEL 8 系统中，启动升级过程： 			

   

   ```none
   # leapp upgrade --target 9.0
   ```

   - ​							如果您要使用 `/etc/yum.repos.d/` 目录中的 [自定义程序仓库](https://access.redhat.com/articles/4977891#repos)进行升级，请启用所选程序仓库，如下所示： 					

     

     ```none
     # leapp upgrade --target 9.0 --enablerepo <repository_id1> --enablerepo <repository_id2> ...
     ```

   - ​							如果您要[在没有 RHSM 的情况下升级](https://access.redhat.com/articles/4977891#upgrade-without-rhsm-rhel9) 或使用 RHUI，请添加 `--no-rhsm` 选项。 					

   - ​							如果您有 [扩展升级支持(EUS)](https://access.redhat.com/articles/rhel-eus)、高级更新支持(AUS)或 [SAP 解决方案(E4S)的更新服务](https://access.redhat.com/solutions/3082481) 订阅，请添加 `--channel *channel*` 选项。使用 `leapp preupgrade` 命令中使用的值（如 `eus`、`aus`或 `e4s`）替换 *channel*。请注意，您必须在 `leapp preupgrade` 和 `leapp upgrade` 命令中对 `--channel` 选项使用同样的值。 					

2. ​					在升级过程开始时，`Leapp` 会执行预升级阶段，如[检查预升级报告中所述](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#reviewing-the-pre-upgrade-report_upgrading-from-rhel-8-to-rhel-9)。 			

   - ​							如果系统是可升级的，`Leapp` 会下载必要的数据，并为升级准备 RPM 事务。 					
   - ​							如果您的系统没有达到可靠的条件，`Leapp` 会终止升级进程，并在 `/var/log/leapp/leapp-report.txt` 文件中提供描述这个问题和推荐解决方案的记录。如需更多信息，请参阅[故障排除](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#troubleshooting_upgrading-from-rhel-8-to-rhel-9)。 					

3. ​					手动重启系统： 			

   

   ```none
   # reboot
   ```

   ​					在这个阶段，系统会引导进入基于 RHEL 9 的初始 RAM 磁盘镜像 initramfs。`Leapp` 升级所有软件包，然后自动重启到 RHEL 9 系统。 			

   ​					另外，您可以使用 `--reboot` 选项运行 `leapp upgrade` 命令并跳过这个手动步骤。 			

   ​					如果发生故障，请调查日志和已知问题，如[故障排除](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#troubleshooting_upgrading-from-rhel-8-to-rhel-9)中所述。 			

4. ​					登录到 RHEL 9 系统并验证其状态， [RHEL 9 系统升级后状态的验证](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#verifying-the-post-upgrade-state-of-the-rhel-9-system_upgrading-from-rhel-8-to-rhel-9)中所述。 			

5. ​					完成升级后的任务，如执行[升级后的任务](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#performing-post-upgrade-tasks-rhel-8-to-rhel-9_upgrading-from-rhel-8-to-rhel-9)中所述。特别是，重新检查并重新应用您的安全策略。 			

# 第 6 章 验证 RHEL 9 系统的升级后状态

​			此流程列出了在升级到 RHEL 9 后建议执行的验证步骤。 	

**先决条件**

- ​					该系统已根据[从 RHEL 8 升级到 RHEL 9](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#performing-the-upgrade-from-rhel-8-to-rhel-9_upgrading-from-rhel-8-to-rhel-9) 中的步骤进行了升级，并可登录到 RHEL 9。 			

**流程**

​				升级完成后，请确定系统是否处于所需状态，至少： 		

- ​					验证当前操作系统版本是否为 RHEL 9： 			

  

  ```none
  # cat /etc/redhat-release
  Red Hat Enterprise Linux release 9.0 (Plow)
  ```

- ​					检查 OS 内核版本： 			

  

  ```none
  # uname -r
  5.14.0-70.10.1.el9_0.x86_64
  ```

  ​					请注意，`.el9` 很重要，且版本不能早于 5.14.0。 			

- ​					如果您使用 Red Hat Subscription Manager: 			

  - ​							验证是否安装了正确的产品： 					

    

    ```none
    # subscription-manager list --installed
    +-----------------------------------------+
        	  Installed Product Status
    +-----------------------------------------+
    Product Name: Red Hat Enterprise Linux for x86_64
    Product ID:   479
    Version:      9.0
    Arch:         x86_64
    Status:       Subscribed
    ```

  - ​							验证升级后发行版本是否马上设置为 9.0： 					

    

    ```none
    # subscription-manager release
    Release: 9.0
    ```

- ​					例如，验证网络服务是否可操作，试着使用 SSH 连接到服务器。 			

- ​					检查应用程序的升级后状态。在某些情况下，您可能需要手动执行迁移和配置更改。例如，要迁移您的数据库，请按照[配置和使用数据库服务器](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_using_database_servers/index)的说明进行。 			

# 第 7 章 执行升级后的任务

​			此流程列出了在向 RHEL 9 进行原位升级后推荐执行的主要任务。 	

**先决条件**

- ​					该系统已根据[从 RHEL 8 升级到 RHEL 9](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#performing-the-upgrade-from-rhel-8-to-rhel-9_upgrading-from-rhel-8-to-rhel-9) 中的步骤进行了升级，并可登录到 RHEL 9。 			
- ​					已按照 [RHEL 9 系统升级后状态验证原位升级的状态](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#verifying-the-post-upgrade-state-of-the-rhel-9-system_upgrading-from-rhel-8-to-rhel-9)进行验证。 			

**流程**

​				执行升级后，完成以下任务： 		

1. ​					从 `/etc/dnf/dnf.conf` 配置文件中的 exclude 列表中删除剩余的 `Leapp` 软件包，其中包括 `snactor` 软件包，这是升级扩展开发的工具。在原位升级过程中，使用 `Leapp` 工具安装的`Leapp` 软件包会自动添加到 排除列表中，以防止删除或更新重要的文件。在原位升级后，在从系统中删除 `Leapp` 软件包之前，必须将它们从排除列表中删除。 			

   - ​							要从 exclude 列表中手动删除软件包，请编辑 `/etc/dnf/dnf.conf` 配置文件并从 exclude 列表中删除所需的 `Leapp` 软件包。 					

   - ​							从 exclude 列表中删除所有软件包： 					

     

     ```none
     # dnf config-manager --save --setopt exclude=''
     ```

2. ​					删除剩余的 RHEL 8 软件包，包括剩余的 `Leapp` 软件包。 			

   1. ​							找到剩余的 RHEL 8 软件包： 					

      

      ```none
      # rpm -qa | grep -e '\.el[78]' | grep -vE '^(gpg-pubkey|libmodulemd|katello-ca-consumer)' | sort
      ```

   2. ​							从 RHEL 9 系统中删除剩余的 RHEL 8 软件包，包括旧的内核软件包。 					

   3. ​							删除剩余的 `Leapp` 依赖软件包： 					

      

      ```none
      # dnf remove leapp-deps-el9 leapp-repository-deps-el9
      ```

3. ​					确定您的系统在原位升级后仍然被支持。RHEL 9.1 正式发布后，请确定您的系统更新至 RHEL 9.1 或 RHEL 9.0 延长更新支持 (EUS)。 			

   1. ​							将系统更新至 RHEL 9.1： 					

      1. ​									取消设置 Red Hat Subscription Manager 以使用最新 RHEL 9.1 的内容： 							

         

         ```none
         # subscription-manager release --unset
         ```

      2. ​									将您的系统更新至最新的 RHEL 9.1 版本： 							

         

         ```none
         # dnf update
         ```

   2. ​							确定您的系统更新至 RHEL 9.0 EUS。 					

      ​							如果您使用 `--channel` 选项在原位升级过程中设置 EUS 频道，则不需要进一步的步骤。否则，将系统更新至 RHEL 9.0 EUS： 					

      1. ​									启用 RHEL 9 EUS 软件仓库： 							

         

         ```none
         # subscription-manager repos --enable repository_id1 --enable repository_id2 …
         ```

         ​									使用您的订阅提供的 EUS 软件仓库 ID 替换 *repository_id**。 							

         ​									至少启用 BaseOS 和 AppStream 软件仓库。例如：在 Intel 64 构架中： 							

         

         ```none
         # subscription-manager repos --enable  rhel-9-for-x86_64-baseos-eus-rpms --enable rhel-9-for-x86_64-appstream-eus-rpms
         ```

      2. ​									将您的系统更新至最新的 RHEL 9.0 EUS 版本： 							

         

         ```none
         # dnf update
         ```

4. ​					重新检查并重新应用您的安全策略。特别是，需要将 SELinux 模式改为 enforcing。详情请参阅[应用安全策略](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#applying-security-policies_upgrading-from-rhel-8-to-rhel-9)。 			

# 第 8 章 应用安全策略

​			在原位升级过程中，SELinux 策略必须切换到 permissive 模式。另外，安全配置集可能包含主要版本之间的更改。本节介绍了保护升级的 RHEL 系统并包括在安全相关组件的预升级步骤时。 	

## 8.1. 将 SELinux 模式改为 enforcing

​				在原位升级过程中，`Leapp` 会将 SELinux 的模式设置为 permissive。当成功升级系统时，您必须手动将 SELinux 模式改为 enforcing。 		

**先决条件**

- ​						系统已被升级，并执行了 [RHEL 9 系统升级后状态](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#verifying-the-post-upgrade-state-of-the-rhel-9-system_upgrading-from-rhel-8-to-rhel-9) 中描述的验证步骤。 				

**流程**

1. ​						确保没有 SELinux denials，例如，使用 `ausearch` 工具程序： 				

   

   ```none
   # ausearch -m AVC,USER_AVC -ts boot
   ```

   ​						请注意，上一步只涵盖最常见的情况。要检查所有可能的 SELinux denials，请查看使用 SELinux 中的 [识别 SELinux denials](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/using_selinux/troubleshooting-problems-related-to-selinux_using-selinux#identifying-selinux-denials_troubleshooting-problems-related-to-selinux) 部分。 				

2. ​						在您选择的文本编辑器中打开 `/etc/selinux/config` 文件，例如： 				

   

   ```none
   # vi /etc/selinux/config
   ```

3. ​						配置 `SELINUX=enforcing` 选项： 				

   

   ```none
   # This file controls the state of SELinux on the system.
   # SELINUX= can take one of these three values:
   #       enforcing - SELinux security policy is enforced.
   #       permissive - SELinux prints warnings instead of enforcing.
   #       disabled - No SELinux policy is loaded.
   SELINUX=enforcing
   # SELINUXTYPE= can take one of these two values:
   #       targeted - Targeted processes are protected,
   #       mls - Multi Level Security protection.
   SELINUXTYPE=targeted
   ```

4. ​						保存更改，重启系统： 				

   

   ```none
   # reboot
   ```

**验证**

1. ​						系统重启后，确认 `getenforce` 命令返回 `Enforcing`: 				

   

   ```none
   $ getenforce
   Enforcing
   ```

**其它资源**

- ​						[故障排除与 SELinux 相关的问题](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/using_selinux/troubleshooting-problems-related-to-selinux_using-selinux) 				
- ​						[更改 SELinux 状态和模式](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/using_selinux/getting-started-with-selinux_using-selinux#selinux-states-and-modes_getting-started-with-selinux) 				

## 8.2. 系统范围的加密策略

​				系统范围的加密策略是一个系统组件，它可配置核心加密子系统，包括 TLS、IPSec、SSH、DNSSec 和 Kerberos 协议。 		

​				原位升级过程会保留您在 RHEL 8 中使用的加密策略。例如，如果您在 RHEL 8 中使用 `DEFAULT` 加密策略，您的系统升级到 RHEL 9 也可以使用 `DEFAULT`。请注意，预定义的策略中的特定设置有所不同，RHEL 9 加密策略包含更为严格且更安全的默认值。例如，RHEL 9 `DEFAULT` 加密策略限制 SHA-1 使用签名，而 `LEGACY` 策略不再允许 DH 和 RSA 密码小于 2048 位。如需更多信息，请参阅 [安全强化文档](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/index) 中的 [Strong crypto defaults](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/using-the-system-wide-cryptographic-policies_security-hardening) 部分。自定义加密策略会在原位升级过程中保留。 		

​				要查看或更改当前系统范围的加密策略，请使用 update-crypto-policies 工具： 		



```none
$ update-crypto-policies --show
DEFAULT
```

​				例如，以下命令可将系统范围内的加密策略切换到 `FUTURE`，这样可防止任何近期可能出现的安全攻击： 		



```none
# update-crypto-policies --set FUTURE
Setting system policy to FUTURE
```

​				如果您需要使用 SHA-1 来验证现有或第三方加密签名，您可以输入以下命令启用它： 		



```none
# update-crypto-policies --set DEFAULT:SHA1
```

​				或者，您可以将系统范围的加密策略切换到 `LEGACY` 策略。但是，`LEGACY` 还支持许多不安全的其他算法。 		

警告

​					启用 `SHA` 子策略会使您的系统比默认的 RHEL 9 设置更加容易。切换到 `LEGACY` 策略甚至不太安全，您应该谨慎使用。 			

​				您还可以自定义系统范围的加密策略。详情请查看使用 [policy modifiers 自定义系统范围的加密策略](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/using-the-system-wide-cryptographic-policies_security-hardening#customizing-system-wide-cryptographic-policies-with-policy-modifiers_using-the-system-wide-cryptographic-policies)以及[创建以及设置自定义系统范围加密策略](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/using-the-system-wide-cryptographic-policies_security-hardening#creating-and-setting-a-custom-system-wide-cryptographic-policy_using-the-system-wide-cryptographic-policies) 部分的内容。如果您使用自定义加密策略，请考虑查看和更新策略，以便在加密和计算机硬件中提前缓解出现的威胁。 		

**其他资源**

- ​						[使用系统范围的加密策略](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/using-the-system-wide-cryptographic-policies_security-hardening) 				
- ​						`update-crypto-policies(8)` 手册页。 				

## 8.3. 升级系统强化到安全基点

​				要在成功升级到 RHEL 9 后获得完全强化的系统，您可以使用 OpenSCAP 套件提供的自动化补救功能。OpenSCAP  修复使您的系统符合安全基线，如 PCI-DSS、OSPP 或 ACSC Essential Eight。由于安全产品的演进，配置合规性建议在  RHEL 的主要版本之间有所不同。 		

​				当升级一个强化的 RHEL 8 系统时，**Leapp** 工具 *不* 提供保持完整强化的直接方法。根据组件配置中的更改，该系统可能会在升级过程中偏离 RHEL 9 的建议。 		

注意

​					您不能使用相同的 SCAP 内容扫描 RHEL 8 和 RHEL 9。如果系统的合规性（如 Red Hat Satellite 或 Red Hat Insights ）进行管理，则更新管理平台。 			

​				作为自动化修复的替代方法，您可以按照 OpenSCAP 生成的报告手动进行更改。有关生成合规性报告的详情，请参阅 [扫描系统的安全合规性和漏洞](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9-beta/html/security_hardening/scanning-the-system-for-configuration-compliance-and-vulnerabilities_security-hardening#configuration-compliance-scanning_scanning-the-system-for-configuration-compliance-and-vulnerabilities)。 		

重要

​					在默认配置中，自动化修复支持 RHEL 系统。因为升级后更改了系统配置，因此运行自动补救可能无法使系统完全与所需的安全配置集兼容。您可能需要手动修复一些要求。 			

​				以下示例流程根据 PCI-DSS 配置集强化您的系统设置。 		

**先决条件**

- ​						`scap-security-guide` 软件包会在 RHEL 9 系统中安装。 				

**流程**

1. ​						查找合适的安全合规数据流 `.xml` 文件： 				

   

   ```none
   $ ls /usr/share/xml/scap/ssg/content/
   ...
   ssg-rhel9-ds.xml
   ...
   ```

   ​						如需更多信息，请参阅 [Viewing compliance profiles](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/scanning-the-system-for-configuration-compliance-and-vulnerabilities_security-hardening#viewing-profiles-for-configuration-compliance_configuration-compliance-scanning) 部分。 				

2. ​						根据从合适的数据流所选的配置文件来修复系统： 				

   

   ```none
   # oscap xccdf eval --profile pci-dss --remediate /usr/share/xml/scap/ssg/content/ssg-rhel9-ds.xml
   ```

   ​						您可以根据您要强化系统的配置集 ID 替换 `--profile` 参数中的 `pci-dss` 值。有关 RHEL 9 支持的配置集的完整列表，请参阅 RHEL [支持的 SCAP 安全配置集](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/scanning-the-system-for-configuration-compliance-and-vulnerabilities_security-hardening#scap-security-guide-profiles-supported-in-rhel-9_scanning-the-system-for-configuration-compliance-and-vulnerabilities)。 				

   警告

   ​							如果没有谨慎使用，在启用 `--remediate` 选项的情况下运行系统评估可能会导致系统无法正常工作。红帽不提供任何自动的方法来恢复由安全补救机制所做的更改。默认配置的 RHEL 系统支持自动安全补救功能。如果在安装后更改了您的系统，运行补救可能无法使其与所需安全配置兼容。 					

3. ​						重启您的系统： 				

   

   ```none
   # reboot
   ```

**验证**

1. ​						验证系统是否遵从配置文件，并将结果保存到 HTML 文件中： 				

   

   ```none
   $ oscap xccdf eval --report pcidss_report.html --profile pci-dss /usr/share/xml/scap/ssg/content/ssg-rhel9-ds.xml
   ```

**其他资源**

- ​						`scap-security-guide(8)` 和 `oscap(8)` 手册页 				
- ​						[扫描系统以了解安全合规和漏洞](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/scanning-the-system-for-configuration-compliance-and-vulnerabilities_security-hardening) 				
- ​						[Red Hat Insights 安全策略](https://access.redhat.com/documentation/en-us/red_hat_insights/2022/html/assessing_and_monitoring_security_policy_compliance_of_rhel_systems/index) 				
- ​						[Red Hat Satellite 安全策略](https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html/administering_red_hat_satellite/chap-administering-security_compliance_management) 				

## 8.4. 验证 USBGuard 策略

​				使用 USBGuard 软件框架，您可以使用基于内核中 USB 设备的授权功能，保护您的系统不受入侵 USB 设备的影响。 		

**先决条件**

- ​						您已为 USB 设备创建了一个规则集，它会在升级前反映您的要求。 				
- ​						`usbguard` 服务已安装在您的 RHEL 9 系统上运行。 				

**流程**

1. ​						备份 `/etc/usbguard/` 目录中存储的 *.conf 文件。 				
2. ​						使用 `usbguard generate-policy` 生成新的策略文件。请注意，命令只为当前可用的 USB 设备生成规则。 				
3. ​						将新生成的规则与前面策略中的规则进行比较： 				
   1. ​								如果您在为同一设备生成新策略和预升级规则时识别规则中的不同，请针对以后插入的设备相应地修改原始规则。 						
   2. ​								如果新生成的和预升级规则之间没有区别，您可以在不修改的情况下使用在 RHEL 8 中创建的策略文件。 						

**其他资源**

- ​						[保护系统免受入侵 USB 设备](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/protecting-systems-against-intrusive-usb-devices_security-hardening). 				

## 8.5. 更新 fapolicyd 数据库

​				`fapolicyd` 软件框架根据用户定义的策略来控制应用程序的执行。 		

​				在个别情况下，可能会出现 `fapolicyd` 信任数据库格式的问题。重建数据库： 		

1. ​						停止该服务： 				

   

   ```none
   # systemctl stop fapolicyd
   ```

2. ​						删除数据库： 				

   

   ```none
   # fapolicyd-cli --delete-db
   ```

3. ​						启动服务： 				

   

   ```none
   # systemctl start fapolicyd
   ```

​				如果您将自定义信任文件添加到信任数据库中，请使用 `fapolicyd-cli -f update *<FILE>*` 命令单独进行更新，或使用 `fapolicyd-cli -f update` 以前进行更新。要应用这些更改，请使用 `fapolicyd-cli --update` 命令或重启 `fapolicyd` 服务。 		

​				另外，自定义二进制文件可能需要为新 RHEL 版本重新构建。在更新 fapolicyd 数据库前执行任何这样的更新。 		

**其他资源**

- ​						[使用 fapolicyd 阻止和允许应用程序](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/assembly_blocking-and-allowing-applications-using-fapolicyd_security-hardening) 				

## 8.6. 将 NSS 数据库从 DBM 更新至 SQLite

​				在将 `NSS_DEFAULT_DB_TYPE` 环境变量设置为系统上的 `sql` 值后，许多应用程序会自动将 NSS 数据库格式从 DBM 转换为 SQLite。您可以使用 `certutil` 工具来确保转换所有数据库。 		

注意

​					在升级到 RHEL 9 前，将存储在 DBM 格式的 NSS 数据库转换。换句话说，在您要升级到 RHEL 9 的 RHEL 系统（6、7 和 8）中执行以下步骤。 			

**先决条件**

- ​						`nss-utils` 软件包安装在您的系统中。 				

**流程**

1. ​						将系统上的 `NSS_DEFAULT_DB_TYPE` 设置为 `sql` ： 				

   

   ```none
   # export NSS_DEFAULT_DB_TYPE=sql
   ```

2. ​						在每个目录中使用转换命令[[1\]](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#ftn.idm140125334092800) 其中包括 DBM 格式的 NSS 数据库文件，例如： 				

   

   ```none
   # certutil -K -X -d /etc/ipsec.d/
   ```

   ​						请注意，如果您的数据库文件受密码保护，则必须提供密码或密码文件的路径作为 `-f` 选项的值，例如： 				

   

   ```none
   # certutil -K -X -f /etc/ipsec.d/nsspassword -d /etc/ipsec.d/
   ```

**其他资源**

- ​						`certutil(1)` 手册页。 				

------

[[1\] ](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#idm140125334092800) 						RHEL 在 `/etc/pki/nssdb` 目录中包含系统范围 NSS 数据库。其他位置取决于您使用的应用程序。例如，Libreswan 将数据库存储在 `/etc/ipsec.d/` 目录中，Firefox 使用 `/home/<username>/.mozilla/firefox/` 目录。 					

## 8.7. 将 Cyrus SASL 数据库从 Berkeley DB 格式迁移到 GDBM

​				RHEL 9 `cyrus-sasl` 软件包构建时没有 `libdb` 依赖项，`sasldb` 插件使用 GDBM 数据库格式而不是 Berkeley DB。 		

**先决条件**

- ​						`cyrus-sasl-lib` 软件包已安装在您的系统中。 				

**流程**

- ​						要迁移以旧 Berkeley DB 格式存储的现有简单身份验证和安全层(SASL)数据库，请使用 `cyrusbdb2current` 工具，语法如下： 				

  

  ```none
  # cyrusbdb2current <sasldb_path> <new_path>
  ```

**其他资源**

- ​						`cyrusbdb2current(1)` man page 				

# 第 9 章 故障排除

​			您可以参阅以下内容来排除从 RHEL 8 升级到 RHEL 9 进行故障排除。 	

## 9.1. 故障排除资源

​				您可以参考以下故障排除资源。 		

​				**控制台输出** 		

​				默认情况下，`Leapp` 只会将错误和严重日志级别的信息输出到控制台输出中要改变日志级别，在`leapp upgrade` 命令中使用 `--verbose` 或 `--debug` 选项。 		

- ​						在 *verbose* 模式中，`Leapp` 会输出 info, warning, error, 和 critical 信息。 				
- ​						在 *debug* 模式中，`Lapp` 会输出 debug、info、warning、error 和 critical 信息。 				

​				**日志** 		

- ​						`/var/log/leapp/leapp-upgrade.log` 文件列出了 initramfs 阶段里的问题。 				
- ​						`/var/log/leapp/dnf-debugdata/` 目录包含了事务故障排除数据。只有在 `leapp upgrade` 命令使用了 `--debug` 选项执行时，才会生成这个目录。 				
- ​						`/var/log/leapp/answerfile` 包含 `Leapp` 回答所需的问题。 				
- ​						`Journalctl` 实用程序提供完整的日志。 				

​				**Reports** 		

- ​						`/var/log/leapp/leapp-report.txt` 文件列出了在预升级阶段里发现的问题。这个报告也可以在 web 控制台中获得，请参阅 [评估可升级性并通过 web 控制台应用自动化修复](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#assessing-upgradability-and-applying-automated-remediations-through-the-web-console_upgrading-from-rhel-8-to-rhel-9)。 				
- ​						`/var/log/leapp/leapp-report.json` 文件以机器可读格式列出了在预升级阶段发现的问题，它可让您使用自定义脚本处理报告。如需更多信息，请参阅[自动 Red Hat Enterprise Linux 预升级报告工作流](https://access.redhat.com/articles/5777571)。 				

## 9.2. 故障排除窍门

​				您可以参考以下故障排除信息。 		

​				**预升级阶段** 		

- ​						验证您的系统满足[规划升级](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#planning-an-upgrade_upgrading-from-rhel-8-to-rhel-9)中列出的所有条件。 				
- ​						请确定您遵循了 [准备升级](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#assembly_preparing-for-the-upgrade_upgrading-from-rhel-8-to-rhel-9) 中描述的所有步骤，例如：您的系统没有使用多个网络接口卡(NIC)，它们的名称基于内核使用的前缀(`eth`)。 				
- ​						确保您已回答了 `/var/log/leapp/answerfile` 文件中 `Leapp` 所需的所有问题。如果缺少回答，`Leapp` 会阻止升级。例如： 				
  - ​								系统中没有 VDO 设备？ 						
- ​						请确定您解决了在预升级报告（位于 `/var/log/leapp/leapp-report.txt` ）中发现的所有问题。您也可以使用 web 控制台来达到此目的，如[评估可升级性并通过 web 控制台应用自动化修复](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#assessing-upgradability-and-applying-automated-remediations-through-the-web-console_upgrading-from-rhel-8-to-rhel-9)中所述。 				

例 9.1. Leapp answerfile

​					以下是一个未编辑的 `/var/log/leapp/answerfile` 文件，它有一个未回答的问题： 			



```none
[check_vdo]
# Title:              None
# Reason:             Confirmation
# ============================= check_vdo.confirm =============================
# Label:              Are all VDO devices, if any, successfully converted to LVM management?
# Description:        Enter True if no VDO devices are present on the system or all VDO devices on the system have been successfully converted to LVM management. Entering True will circumvent check of failures and undetermined devices. Recognized VDO devices that have not been converted to LVM management can still block the upgrade despite the answer.All VDO devices must be converted to LVM management before upgrading.
# Reason:             To maximize safety all block devices on a system that meet the criteria as possible VDO devices are checked to verify that, if VDOs, they have been converted to LVM management. If the devices are not converted and the upgrade proceeds the data on unconverted VDO devices will be inaccessible. In order to perform checking the 'vdo' package must be installed. If the 'vdo' package is not installed and there are any doubts the 'vdo' package should be installed and the upgrade process re-run to check for unconverted VDO devices. If the check of any device fails for any reason an upgrade inhibiting report is generated. This may be problematic if devices are dynamically removed from the system subsequent to having been identified during device discovery. If it is certain that all VDO devices have been successfully converted to LVM management this dialog may be answered in the affirmative which will circumvent block device checking.
# Type:               bool
# Default:            None
# Available choices: True/False
# Unanswered question. Uncomment the following line with your answer
# confirm =
```

​					`Label` 字段指定需要回答的问题。在本例中，问题是 **Are all VDO devices, if any, successfully converted to LVM management?** 			

​					要回答问题，请取消对最后一行的注释并输入回答 `True` 或 `False`。在本例中，所选答案为 `True` ： 			



```none
[check_vdo]
...
# Available choices: True/False
# Unanswered question. Uncomment the following line with your answer
confirm = True
```

​				**下载阶段** 		

- ​						如果在下载 RPM 软件包时出现问题，请检查位于 `/var/log/leapp/dnf-debugdata/` 目录的事务调试数据。 				

  注意

  ​							如果没有生成事务调试数据，`/var/log/leapp/dnf-debugdata/` 目录为空，则不存在。当所需的软件仓库不可用时，会出现这种情况。 					

​				**initramfs 阶段** 		

- ​						在此阶段，潜在的故障会进入 Dracut shell。检查 Journal 日志： 				

  

  ```none
  # journalctl
  ```

  ​						或者，使用 `reboot` 命令从 Dracut shell 重启系统，并检查 `/var/log/leapp/leapp-upgrade.log` 文件。 				

​				**升级后阶段** 		

- ​						如果您的系统看上去成功升级，但是使用旧的 RHEL 8 内核引导，重启系统并检查 GRUB 中默认条目的内核版本。 				

- ​						确保您遵循了 [RHEL 9 系统升级后状态的验证](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#verifying-the-post-upgrade-state-of-the-rhel-9-system_upgrading-from-rhel-8-to-rhel-9)中推荐的步骤。 				

- ​						如果您的应用程序或服务在您将 SELinux 切换到 enforcing 模式后停止工作或者行为不正确，请使用 **ausearch**, **journalctl**, 或 **dmesg** 检查拒绝： 				

  

  ```none
  # ausearch -m AVC,USER_AVC -ts boot
  # journalctl -t setroubleshoot
  # dmesg | grep -i -e selinux -e type=1400
  ```

  ​						最常见的问题是由错误的标记造成的。更多详情请参阅[SELinux 故障排除](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/using_selinux/troubleshooting-problems-related-to-selinux_using-selinux)。 				

## 9.3. 已知问题

​				从 RHEL 8 升级到 RHEL 9 时可能会遇到的已知问题： 		

- ​						在进行原位升级时，如果 Network Manager 被禁用或没有安装，则 network teaming 功能无法正常工作。 				

- ​						如果您使用 HTTP 代理，则必须将 Red Hat Subscription Manager 配置为使用代理服务器，或在执行 `subscription-manager` 命令时使用 `--proxy <hostname>` 选项 。否则，`subscription-manager` 命令的执行会失败。如果您使用 `--proxy` 选项而不是配置更改，升级过程会失败，因为 `Leapp` 无法检测到代理。要防止这个问题发生，请手动编辑 `rhsm.conf` 文件，如 [How to configure HTTP Proxy for Red Hat Subscription Management](https://access.redhat.com/solutions/57669) 所述。(BZ#[1689294](https://bugzilla.redhat.com/show_bug.cgi?id=1689294)) 				

- ​						如果您的 RHEL 8 系统使用由红帽提供但在 RHEL 9 中不可用的设备驱动程序，`Leapp` 将会限制升级。但是，如果 RHEL 8 系统使用 `Leapp` 在 `/etc/leapp/files/device_driver_deprecation_data.json` 文件中没有数据的第三方设备驱动程序，`Leapp` 不会检测这样的驱动程序并进行升级。然后，该系统可能会在升级后无法引导。 				

- ​						如果系统上安装的第三方软件包（不是红帽签名的）的名称与红帽提供的软件包名称相同，则原位升级会失败。要临时解决这个问题，请在升级前选择以下选项之一： 				

  1. ​								删除第三方软件包 						
  2. ​								使用红帽提供的软件包替换第三方软件包 						

- ​						在 RHEL 8 中，可以使用 VDO 管理器或逻辑卷管理器(LVM)来管理 Virtual Data  Optimizer(VDO)卷。在 RHEL 9 中，只能使用 LVM 管理 VDO 卷。要升级后继续使用 VDO 管理的卷，请将这些卷导入到  LVM 管理的 VDO 卷： 				

  1. ​								验证 RHEL 8 系统中是否安装了 VDO 和 LVM 的最新版本。 						

  2. ​								在开始原位升级前，将 VDO 管理的 VDO 卷导入到 LVM 管理的 VDO 卷： 						

     

     ```none
     # lvm_import_vdo --name <volume_group_name>/<lvm_name> /dev/mapper/<vdo_name>
     ```

     ​								将 *volume_group_name* 替换为新卷组名称，*lvm_name* 替换为 LVM 管理的 VDO 卷的新名称，且 *vdo_name* 替换为您要导入的 VDO-managed 卷的名称。 						

     重要

     ​									您无法将 LVM 管理的 VDO 卷导入到 VDO 管理的 VDO 卷。因此，如果您打算将来通过 VDO 管理器访问这些  VDO 卷，则无法反向导入过程。有关 LVM 管理的 VDO 卷的更多信息，请参阅 RHEL 指南中的重复数据删除和压缩逻辑卷。 							

- ​						在带有软件冗余磁盘阵列 (RAID) 的系统中，原位升级会失败。(BZ#[1957192](https://bugzilla.redhat.com/show_bug.cgi?id=1957192)) 				

- ​						在原位升级过程中，`Leapp` 通常会在 RHEL 8 和 RHEL 9 之间保留网络接口控制器(NIC)。但是，在某些系统上，如带有网络绑定的系统，可能需要在 RHEL 8 和 RHEL 9 之间更新 NIC 名称。在这些系统上，设置 `LEAPP_NO_NETWORK_RENAMING=1` 环境变量，执行原位升级，然后验证您的网络是否按预期工作。如果需要，请手动更新网络配置。(BZ#[1919382](https://bugzilla.redhat.com/show_bug.cgi?id=1919382)) 				

- ​						在执行升级前，原位升级可能会停止，因为 `Leapp` 程序错误地检测到没有足够的可用磁盘空间。如果您的系统包含格式化为 XFS 文件系统的分区，您可以在没有 ftype 属性的情况下将 `LEAPP_OVL_SIZE` 环境变量中默认大小更改为帐户，至少可在容器内指定磁盘空间。建议增加默认大小，使其大于指定缺少的磁盘空间，以防止重复错误信息。例如，如果 `Leapp` 程序检测到需要额外的 400 MB，将默认大小从 2048 MB 增加到至少 2500 MB。 				

  注意

  ​							这个临时解决方案可能需要在 `/var` 分区中有大量可用空间。 					

  ​						如果这个临时解决方案没有解决这个问题，或者您的系统没有 ftype 属性中没有包含这些分区，请联系红帽支持。(BZ#[1832730](https://bugzilla.redhat.com/show_bug.cgi?id=1832730)) 				

- ​						使用 RoCE Express 适配器在 IBM Z 上原位升级会破坏网络。RHEL 9.0 为 RoCE Express  适配器使用可预测接口名称。它们与 RHEL 8.6 发行版中的名称不同。因此，如果您执行从 RHEL 8 升级到 RHEL 9，则 RoCE  Express 适配器的现有网络配置会破坏当前的 RHEL 9.0 版本。 				

- ​						RHEL 8.7 包括了一些 RHEL 9.0  发行版本没有提供的新功能。因此，如果需要任何这样的功能，系统或应用程序可能会出现问题。要临时解决这个问题，请更新系统设置使其与 RHEL 9.0 兼容，或者在升级到 RHEL 9.0 后手动更新系统到 RHEL 9.1，其中包含缺少的功能。 				

## 9.4. 获取支持

​				要创建一个支持问题单，请选择 *RHEL 8* 作为产品，并提供您系统的 `sosreport`。 		

- ​						要在您的系统中生成 `sosreport`，请运行： 				



```none
# sosreport
```

​				请注意：您可以将问题单 ID 留空。 		

​				有关生成 sosreport 的详情，请参阅 [What is an sosreport and how to create one in Red Hat Enterprise Linux?](https://access.redhat.com/solutions/3592)。 		

​				有关在客户门户网站中建立和管理支持问题单的详情，请参阅 [How do I open and manage a support case on the Customer Portal?](https://access.redhat.com/articles/38363)。 		

# 第 10 章 相关信息

​			您可以参考以下说明： 	

- ​					[Red Hat Enterprise Linux 的技术功能及限制](https://access.redhat.com/articles/rhel-limits) 			
- ​					[支持的 Red Hat Enterprise Linux 原位升级路径](https://access.redhat.com/articles/4263361) 			
- ​					[使用 RHEL 9 时的注意事项](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html-single/considerations_in_adopting_rhel_9/) 			
- ​					[定制 Red Hat Enterprise Linux 原位升级](https://access.redhat.com/articles/4977891) 			
- ​					[自动执行 Red Hat Enterprise Linux 预升级报告工作流](https://access.redhat.com/articles/5777571) 			
- ​					[使用配置管理系统在 Red Hat Enterprise Linux 上自动化部分 Leapp 预升级和升级过程](https://access.redhat.com/articles/6313281)。 			
- ​					[Leapp 为断开连接的升级进行 RHEL 的原位升级](https://access.redhat.com/articles/3664871) 			
- ​					[从 RHEL 7 升级至 RHEL 8](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/upgrading_from_rhel_7_to_rhel_8/) 			
- ​					[如何从 CentOS 或 Oracle Linux 转换到 RHEL](https://access.redhat.com/articles/2360841) 			
- ​					[Red Hat Insights 文档](https://access.redhat.com/documentation/en-us/red_hat_insights) 			

# 附录 A. RHEL 8 软件仓库

​			在升级前，请确保启用了适当的软件仓库，如[准备 RHEL 8 系统用于升级](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/upgrading_from_rhel_8_to_rhel_9/index#preparing-a-rhel-8-system-for-the-upgrade_upgrading-from-rhel-8-to-rhel-9)的步骤 4 所述。 	

​			如果您计划在升级过程中使用 Red Hat Subscription Manager，您 **需要**在升级前使用 `subscription-manager repos --enable *repository_id*` 命令启用以下软件仓库： 	

表 A.1. RHEL 8 软件仓库

| 架构                     | 软件仓库                             | 仓库 ID                          |
| ------------------------ | ------------------------------------ | -------------------------------- |
| 64 位 Intel 和 AMD       | Base                                 | `rhel-8-for-x86_64-baseos-rpms`  |
| Appstream                | `rhel-8-for-x86_64-appstream-rpms`   |                                  |
| 64-bit ARM               | Base                                 | `rhel-8-for-aarch64-baseos-rpms` |
| Extras                   | `rhel-8-for-aarch64-appstream-rpms`  |                                  |
| IBM POWER(little endian) | Base                                 | `rhel-8-for-ppc64le-baseos-rpms` |
| Appstream                | `rhel-8-for-ppc64le-appstream-rpmss` |                                  |
| IBM Z                    | Base                                 | `rhel-8-for-s390x-baseos-rpms`   |
| Appstream                | `rhel-8-for-s390x-appstream-rpms`    |                                  |

​			升级前，可以使用 `subscription-manager repos --enable *repoid*` 命令**启用以下仓库**： 	

表 A.2. Voluntary RHEL 8 软件仓库

| 架构                     | 软件仓库                                | 仓库 ID                                     |
| ------------------------ | --------------------------------------- | ------------------------------------------- |
| 64 位 Intel 和 AMD       | Code Ready Linux Builder                | `codeready-builder-for-rhel-8-x86_64-rpms`  |
| Supplementary            | `rhel-8-for-x86_64-supplementary-rpms`  |                                             |
| 64-bit ARM               | Code Ready Linux Builder                | `codeready-builder-for-rhel-8-aarch64-rpms` |
| Supplementary            | `rhel-8-for-aarch64-supplementary-rpms` |                                             |
| IBM POWER(little endian) | Code Ready Linux Builder                | `codeready-builder-for-rhel-8-ppc64le-rpms` |
| Supplementary            | `rhel-8-for-ppc64le-supplementary-rpms` |                                             |
| IBM Z                    | Code Ready Linux Builder                | `codeready-builder-for-rhel-8-s390x-rpms`   |
| Supplementary            | `rhel-8-for-s390x-supplementary-rpms`   |                                             |

注意

​				如果您在原位升级前启用了 RHEL 8 Code Ready Linux Builder 或 RHEL 8 Supplementary 软件仓库，`Leapp` 会相应地启用 RHEL 8 CodeReady Linux Builder 或 RHEL 8 Supplementary 软件仓库。有关更多信息，请参阅[软件包清单](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/package_manifest)。 		

​			如果您决定使用自定义软件仓库，请根据[配置自定义软件仓库中](https://access.redhat.com/articles/4977891#repos-config)的内容启用它们。 	

# 附录 B. RHEL 9 软件仓库

​			如果您的系统使用 Red Hat Subscription Manager(RHSM)注册到 Red Hat Content  Delivery Network(CDN)，则 RHEL 9 软件仓库会在原位升级过程中自动启用。但是，在使用 RHSM 注册了 Red Hat Satellite 的系统中，在运行预升级报告前手动启用并同步 RHEL 8 和 RHEL 9 软件仓库。 	

注意

​				确保启用每个存储库的版本 9.0。如果您只启用了 RHEL 9 版本，则禁止原位升级。 		

​			如果您计划在升级过程中使用 Red Hat Satellite，在升级前，使用 Satellite Web UI 或 `hammer repository-set enable` 和 `hammer product synchronize` 命令**启用并同步**至少以下的 RHEL 9 仓库： 	

表 B.1. RHEL 9 软件仓库

| 架构                      | 软件仓库                            | 仓库 ID                                                      | 仓库名称                                                     | 发行版本    |
| ------------------------- | ----------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ----------- |
| 64 位 Intel 和 AMD        | BaseOS                              | `rhel-9-for-x86_64-baseos-rpms`                              | Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs)        | x86_64 9.0  |
| Appstream                 | `rhel-9-for-x86_64-appstream-rpms`  | Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs)     | x86_64 9.0                                                   |             |
| 64-bit ARM                | BaseOS                              | `rhel-9-for-aarch64-baseos-rpms`                             | Red Hat Enterprise Linux 9 for ARM 64 - BaseOS (RPMs)        | aarch64 9.0 |
| Appstream                 | `rhel-9-for-aarch64-appstream-rpms` | Red Hat Enterprise Linux 9 for ARM 64 - AppStream (RPMs)     | aarch64 9.0                                                  |             |
| IBM Power (little endian) | BaseOS                              | `rhel-9-for-ppc64le-baseos-rpms`                             | Red Hat Enterprise Linux 9 for Power, little endian - BaseOS (RPMs) | ppc64le 9.0 |
| Appstream                 | `rhel-9-for-ppc64le-appstream-rpms` | Red Hat Enterprise Linux 9 for Power, little endian - AppStream (RPMs) | ppc64le 9.0                                                  |             |
| IBM Z                     | BaseOS                              | `rhel-9-for-s390x-baseos-rpms`                               | Red Hat Enterprise Linux 9 for IBM z Systems - BaseOS (RPMs) | s390x 9.0   |
| Appstream                 | `rhel-9-for-s390x-appstream-rpms`   | Red Hat Enterprise Linux 9 for IBM z Systems - AppStream (RPMs) | s390x 9.0                                                    |             |

​                

​                      

​                [                                                                                                                              ](https://redhat.com)

[                       ](https://redhat.com)[                       ](https://redhat.com)

[                                    ](https://redhat.com)              

### Quick Links

- [Downloads](https://access.redhat.com/downloads/)
- [Subscriptions](https://access.redhat.com/management)
- [Support Cases](https://access.redhat.com/support)
- [Customer Service](https://access.redhat.com/support/customer-service)
- [Product Documentation](https://access.redhat.com/documentation)

### Help

- [Contact Us](https://access.redhat.com/support/contact/)
- [Customer Portal FAQ](https://access.redhat.com/articles/33844)
- [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

- [Trust Red Hat](https://www.redhat.com/en/trust)
- [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
- [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
- [Awards and Recognition](https://access.redhat.com/recognition/)
- [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

- [redhat.com](https://www.redhat.com/)
- [developers.redhat.com](http://developers.redhat.com/)
- [connect.redhat.com](https://connect.redhat.com/)
- [cloud.redhat.com](https://cloud.redhat.com/)

### About

- [Red Hat Subscription Value](https://access.redhat.com/subscription-value)
- [About Red Hat](https://www.redhat.com/about/)
- [Red Hat Jobs](http://jobs.redhat.com)

[                         All systems operational                                              ](https://status.redhat.com)

Copyright © 2023 Red Hat, Inc.

- [Privacy Statement](http://www.redhat.com/en/about/privacy-policy)
- [Customer Portal Terms of Use](https://access.redhat.com/help/terms/)
- [All Policies and Guidelines](http://www.redhat.com/en/about/all-policies-guidelines)
- Cookie 偏好设置

[                         ![Red Hat Summit](https://access.redhat.com/chrome_themes/nimbus/img/rh-summit-red-a.svg)                     ](http://www.redhat.com/summit/)

​                        [Twitter](https://twitter.com/RedHatSupport)                                            