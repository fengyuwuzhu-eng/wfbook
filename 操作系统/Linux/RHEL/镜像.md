# 创建自定义 RHEL 系统镜像

Red Hat Enterprise Linux 9

## 在 Red Hat Enterprise Linux 9 上使用镜像构建器创建自定义系统镜像

Red Hat Customer Content Services

[法律通告](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#idm140347056339440)

**摘要**

​				镜像构建器是用于创建部署就绪的自定义系统镜像的工具：安装磁盘、虚拟机、特定于云供应商的镜像等。使用镜像构建器，如果与手动过程相比，您可以更快地创建这些镜像，因为它消除了每种输出类型所需的特定配置。本文档论述了如何设置镜像构建器并使用它来创建镜像。 		

------

# 使开源包含更多

​			红帽致力于替换我们的代码、文档和 Web 属性中存在问题的语言。我们从这四个术语开始：master、slave、黑名单和白名单。由于此项工作十分艰巨，这些更改将在即将推出的几个发行版本中逐步实施。详情请查看 [CTO Chris Wright 的信息](https://www.redhat.com/en/blog/making-open-source-more-inclusive-eradicating-problematic-language)。 	

# 对红帽文档提供反馈

​			我们感谢您对我们文档的反馈。让我们了解如何改进它。 	

**根据具体内容提交评论**

1. ​					查看 **Multi-page HTML** 格式的文档，并确保在页面完全加载后可看到右上角的 **Feedback** 按钮。 			
2. ​					使用光标突出显示您要评论的文本部分。 			
3. ​					点在高亮文本旁的 **Add Feedback** 按钮。 			
4. ​					添加您的反馈并点击 **Submit**。 			

**通过 Bugzilla（需要帐户）提交反馈**

1. ​					登录到 [Bugzilla](https://bugzilla.redhat.com/enter_bug.cgi?product=Red Hat Enterprise Linux 9&component=Documentation) 网站。 			
2. ​					从 **Version** 菜单中选择正确的版本。 			
3. ​					在 **Summary** 字段中输入描述性标题。 			
4. ​					在 **Description** 字段中输入您的改进建议。包括文档相关部分的链接。 			
5. ​					点 **Submit Bug**。 			

# 第 1 章 镜像构建器描述

​			要在云平台中部署系统，请创建一个系统镜像。要创建 RHEL 系统镜像，请使用镜像构建器工具。 	

## 1.1. 什么是镜像构建器？

​				您可以使用镜像构建器来创建 RHEL 的自定义系统镜像，包括为在云平台上进行部署的系统镜像。镜像构建器自动处理每个输出类型的设置详情，因此比手动创建镜像方法更易于使用和更快地使用。您可以通过 `composer-cli` 工具中的命令行界面或 RHEL web 控制台中的图形用户界面来访问镜像构建器的功能。 		

注意

​					从 RHEL 8.3 开始，`osbuild-composer` 后端替换了 `lorax-composer`。新服务为镜像构建提供 REST API。 			

## 1.2. 镜像构建器术语

- 蓝图（Blueprint）

  ​							蓝图是自定义系统镜像的描述。它列出了将成为系统一部分的软件包和自定义。您可以使用自定义编辑蓝图，并将其保存为特定版本。从蓝图创建系统镜像时，该镜像与 RHEL web 控制台的镜像构建器界面中的蓝图相关联。 					 						您可以使用 TOML 格式创建蓝图。 					

- 组合（Compose）

  ​							compose 是基于特定蓝图的特定版本的系统镜像构建。作为一个术语，Compose 代表系统镜像以及来自其创建、输入、元数据和进程本身的日志。 					

- 自定义（Customizations）

  ​							自定义是不是软件包的镜像的规格。这包括用户、组和 SSH 密钥。 					

## 1.3. 镜像构建器输出格式

​				镜像构建器可以以多种输出格式创建镜像，如下表中所示。要检查支持的类型，请运行以下命令： 		



```none
# composer-cli compose types
```

表 1.1. 镜像构建器输出格式

| Description                 | CLI 名称                    | 文件扩展 |
| --------------------------- | --------------------------- | -------- |
| QEMU QCOW2 镜像             | `qcow2`                     | `.qcow2` |
| TAR 归档                    | `tar`                       | `.tar`   |
| Amazon 机器镜像磁盘         | `ami`                       | `.raw`   |
| Azure 磁盘镜像              | `vhd`                       | `.vhd`   |
| Google Cloud Platform       | `gce`                       | `.vhd`   |
| VMware 虚拟机磁盘           | `vmdk`                      | `.vmdk`  |
| Openstack                   | `openstack`                 | `.qcow2` |
| 用于边缘提交的 RHEL         | `edge-commit`               | `.tar`   |
| 用于边缘容器的 RHEL         | `edge-container`            | `.tar`   |
| 用于边缘安装程序的 RHEL     | `edge-installer`            | `.iso`   |
| 用于 Edge Raw 的 RHEL       | `edge-raw-image`            | `.tar`   |
| 用于边缘简化安装程序的 RHEL | `edge-simplified-installer` | `.iso`   |
| ISO 镜像                    | `image-installer`           | `.iso`   |

## 1.4. 镜像构建器系统要求

​				镜像构建器运行的环境（如专用的虚拟机）必须满足下表中列出的要求。 		

表 1.2. 镜像构建器系统要求

| 参数     | 最低要求值                                                   |
| -------- | ------------------------------------------------------------ |
| 系统类型 | 专用虚拟机。请注意，容器上不支持镜像构建器，包括 Red Hat Universal Base Images (UBI)。 |
| 处理器   | 2 个内核                                                     |
| 内存     | 4 GiB                                                        |
| 磁盘空间 | `/var` 文件系统中有 20 GiB 的可用空间                        |
| 访问权限 | 管理员级别(root)                                             |
| Network  | 互联网连接                                                   |

注意

​					如果您没有互联网连接，您可以在隔离的网络中使用镜像构建程序（如果您重新配置它以不连接到 Red Hat Content  Delivery Network (CDN)。为此，您必须覆盖默认软件仓库以指向您的本地存储库。确保您有内部镜像的内容或使用 Red Hat  Satellite。如需了解更多详细信息，请参阅[管理软件仓库](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/index#managing-repositories_composing-a-customized-rhel-system-image)。 			

**其他资源**

- ​						[使用红帽镜像构建器镜像置备 Satellite](https://access.redhat.com/documentation/zh-cn/red_hat_satellite/6.6/html/provisioning_guide/provisioning_using_a_red_hat_image_builder_image) 				

# 第 2 章 安装镜像构建器

​			在使用镜像构建器之前，您必须在虚拟机中安装镜像构建器。 	

## 2.1. 在虚拟机中安装镜像构建器

​				要在专用虚拟机(VM)上安装镜像构建程序，请按照以下步骤操作： 		

**前提条件**

- ​						您必须连接到 RHEL 虚拟机。 				
- ​						镜像构建器的虚拟机必须正在运行并订阅到 Red Hat Subscription Manager (RHSM) 或 Red Hat Satellite。 				

**流程**

1. ​						在虚拟机上安装镜像构建程序和其他必要的软件包： 				

   - ​								`osbuild-composer` - 从 RHEL 8.3 开始支持 						
   - ​								`composer-cli` 						
   - ​								`cockpit-composer` 						
   - ​								`bash-completion` 						

   

   ```none
   # dnf install osbuild-composer composer-cli cockpit-composer bash-completion
   ```

   ​						Web 控制台作为 *cockpit-composer* 软件包的依赖项安装。 				

2. ​						在每次重启后启动镜像构建器： 				

   

   ```none
   # systemctl enable --now osbuild-composer.socket
   # systemctl enable --now cockpit.socket
   ```

   ​						`osbuild-composer` 和 `cockpit` 服务在第一次访问时自动启动。 				

3. ​						载入 shell 配置脚本，以便在不重启的情况下立即启动 `composer-cli` 命令的自动完成功能： 				

   

   ```none
   $ source /etc/bash_completion.d/composer-cli
   ```

重要

​					`osbuild-composer` 软件包是新的后端引擎，它将是从 Red Hat Enterprise Linux 8.3 及更高版本开始的所有新功能的首选默认和重点。之前的后端 `lorax-composer` 软件包被视为已弃用，将只接收 Red Hat Enterprise Linux 8 生命周期剩余部分所选定的修复，并将在以后的主发行版本中被忽略。建议卸载 `lorax-composer` ，使用 osbuild-composer。 			

**验证**

​					您可以使用系统日志来跟踪镜像构建器服务活动。此外，您还可以在文件中找到日志消息。 			

- ​						要查找回溯的日志输出，请运行以下命令： 				

  

  ```none
  $ journalctl | grep osbuild
  ```

- ​						显示远程或本地 worker： 				

  

  ```none
  $ journalctl -u osbuild-worker*
  ```

- ​						显示运行的服务： 				

  

  ```none
  $ journalctl -u osbuild-composer.service
  ```

# 第 3 章 管理镜像构建器存储库

## 3.1. 镜像构建器默认系统存储库

​				`osbuild-composer` 后端不会继承位于 `/etc/yum.repos.d/` 目录中的系统存储库。相反，它拥有自己的一组在 `/usr/share/osbuild-composer/repositories` 目录中定义的官方存储库。这包括红帽官方存储库，其中包含基础系统 RPM，用于向新版本安装附加软件或更新已安装的程序。如果要覆盖官方存储库，您必须在 `/etc/osbuild-composer/repositories` 中定义覆盖。这个目录用于用户定义的覆盖，以及位于该目录中且优先于 `/usr` 目录中文件的文件。 		

​				配置文件不是 `/etc/yum.repos.d/` 中常见的 DNF 存储库格式。相反，它们是简单的 JSON 文件。 		

## 3.2. 覆盖系统存储库

​				您可以按照以下步骤在 `/etc/osbuild-composer/repositories` 目录中为镜像构建器配置存储库覆盖。 		

**前提条件**

- ​						您有一个可从主机系统访问的自定义存储库 				

**流程**

1. ​						创建一个要存储存储库覆盖的目录： 				

   

   ```none
   $ sudo mkdir -p /etc/osbuild-composer/repositories
   ```

2. ​						您可以创建自己的 JSON 文件结构。 				

3. ​						使用与 RHEL 版本相对应的名称，创建一个 JSON 文件。或者，您还可以从 `/usr/share/osbuild-composer/` 中复制用于分发的文件，并修改其内容。 				

   ​						对于 RHEL 9，使用 `/etc/osbuild-composer/repositories/rhel-91.json`。 				

4. ​						在 JSON 文件中添加以下结构，例如： 				

   

   ```none
   {
       "<ARCH>": [
           {
               "name": "baseos",
               "baseurl": "http://mirror.example.com/composes/released/RHEL-9/9.0/BaseOS/x86_64/os/",
               "gpgkey": "-----BEGIN PGP PUBLIC KEY BLOCK-----\n\n (…)",
               "check_gpg": true,
               "metadata_expire": ""
           }
       ]
   }
   ```

   ​						仅指定以下属性之一： 				

   - ​								`baseurl` - string ：存储库的基本 URL。 						

   - ​								`metalink` - string ：包含有效镜像存储库列表的 metalink 文件的 URL。 						

   - ​								`mirrorlist` - 字符串：包含有效镜像存储库列表列表的 mirrorlist 文件的 URL 						

     ​								剩余的字段是可选的。 						

     1. ​										或者，您也可以复制 JSON 文件以用于您的分发。 								

        1. ​												将存储库文件复制到您创建的目录中。在以下命令中，将 `rhel-version.json` 替换为您的 RHEL 版本，例如：rhel-9.json。 										

           

           ```none
           $  cp /usr/share/osbuild-composer/repositories/rhel-version.json /etc/osbuild-composer/repositories/
           ```

5. ​						使用文本编辑器，编辑 `rhel-9.json` 文件中的 `baseurl` 路径并保存它。例如： 				

   

   ```none
   $ vi /etc/osbuild-composer/repositories/rhel-version.json
   ```

6. ​						重启 `osbuild-composer.service` ： 				

   

   ```none
   $ sudo systemctl restart osbuild-composer.service
   ```

**验证**

- ​						检查存储库是否指向正确的 URL： 				

  

  ```none
  $ cat /etc/yum.repos.d/redhat.repo
  ```

  ​						您可以看到仓库指向从 `/etc/yum.repos.d/redhat.repo` 文件中复制的正确 URL。 				

**其他资源**

- ​						[存储库中可用的最新的 RPM 版本对 `osbuild-composer` 不可见。](https://access.redhat.com/solutions/6957312) 				

## 3.3. 覆盖支持订阅的系统存储库

​				`osbuild-composer` 服务可以使用 `/etc/yum.repos.d/redhat.repo` 文件中定义的系统订阅。要使用 `osbuild-composer` 中的系统订阅，请定义具有以下内容的存储库覆盖： 		

- ​						与 `/etc/yum.repos.d/redhat.repo` 中定义的存储库相同的 `baseurl`。 				
- ​						JSON 对象中定义的 `"rhsm": true` 值。 				

**前提条件**

- ​						您的系统有一个在 `/etc/yum.repos.d/redhat.repo` 中定义的订阅 				
- ​						您已创建了一个存储库覆盖。请参阅 [覆盖系统存储库](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#overriding-a-system-repository_managing-repositories)。 				

**流程**

1. ​						从 `/etc/yum.repos.d/redhat.repo` 文件中获取 `baseurl` ： 				

   

   ```none
   # cat /etc/yum.repos.d/redhat.repo
   [AppStream]
   name = AppStream mirror example
   baseurl = https://mirror.example.com/RHEL-9/9.0/AppStream/x86_64/os/
   enabled = 1
   gpgcheck = 0
   sslverify = 1
   sslcacert = /etc/pki/ca1/ca.crt
   sslclientkey = /etc/pki/ca1/client.key
   sslclientcert = /etc/pki/ca1/client.crt
   metadata_expire = 86400
   enabled_metadata = 0
   ```

2. ​						配置存储库覆盖以使用相同的 `baseurl`，并将 `rhsm` 设为 true： 				

   

   ```none
   {
       "x86_64": [
           {
               "name": "AppStream mirror example",
               "baseurl": "https://mirror.example.com/RHEL-9/9.0/AppStream/x86_64/os/",
               "gpgkey": "-----BEGIN PGP PUBLIC KEY BLOCK-----\n\n (…)",
               "check_gpg": true,
               "rhsm": true
           }
       ]
   }
   ```

   注意

   ​							`osbuild-composer` 不自动使用 `/etc/yum.repos.d/` 中定义的存储库。您需要手动将它们指定为系统存储库覆盖 ，或使用 `composer-cli` 指定为额外的 `源`。系统存储库覆盖通常用于"BaseOS"和"AppStream"存储库，而 `composer-cli` 源则用于所有其他存储库。 					

​				因此，镜像构建器从主机系统读取 `/etc/yum.repos.d/redhat.repo` 文件，并使用它作为订阅源。 		

**其他资源**

- ​						[当主机注册到 Satellite 6 时，镜像构建器使用 CDN 存储库](https://access.redhat.com/solutions/5773421) 				

# 第 4 章 使用镜像构建器命令行界面创建系统镜像

​			镜像构建器是创建自定义系统镜像的工具。要控制镜像构建器并创建自定义系统镜像，您可以使用命令行界面(CLI)或 Web 控制台界面。但是，目前 CLI 是镜像构建器的首选方法。 	

## 4.1. 镜像构建器命令行界面简介

​				镜像构建器命令行界面(CLI)目前是使用镜像构建器的首选方法。它提供比 [Web 控制台界面](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#creating-system-images-with-composer-web-console-interface_composing-a-customized-rhel-system-image)更多的功能。要使用 CLI，请使用适当的选项和子命令运行 `composer-cli` 命令。 		

​				命令行界面的工作流总结如下： 		

1. ​						将蓝图定义导出（*保存*）到纯文本文件 				
2. ​						在文本编辑器中编辑这个文件 				
3. ​						将蓝图文本文件导入(*push*)回镜像构建器 				
4. ​						运行 compose 来从蓝图构建镜像 				
5. ​						导出镜像文件以下载它 				

​				除了实现此过程的基本子命令外，`composer-cli` 命令还提供多个子命令来检查配置的蓝图和组合的状态。 		

​				要以非 root 身份运行 `composer-cli` 命令，用户必须在 `weldr` 或 `root` 组中。 		

- ​						要在 `weldr` 或 `root` 组中添加用户，请运行以下命令： 				

  

  ```none
  $ sudo usermod -a -G weldr user
  $ newgrp weldr
  ```

## 4.2. 使用命令行界面创建镜像构建器蓝图

​				您可以使用命令行界面 (CLI) 创建新的镜像构建器蓝图。蓝图描述了最终的镜像及其自定义，如软件包和内核自定义。 		

**前提条件**

- ​						访问镜像构建器工具。 				

**流程**

1. ​						创建一个包含以下内容的纯文本文件： 				

   

   ```none
   name = "BLUEPRINT-NAME"
   description = "LONG FORM DESCRIPTION TEXT"
   version = "0.0.1"
   modules = []
   groups = []
   ```

   ​						用您的蓝图的名称和描述替换 *BLUEPRINT-NAME* 和 *LONG FORM DESCRIPTION TEXT*。 				

   ​						根据 [Semantic Versioning](https://semver.org/) 方案，将 *0.0.1* 替换为一个版本号。 				

2. ​						对于您要包含在蓝图中的每个软件包，请在文件中添加以下行： 				

   

   ```none
   [[packages]]
   name = "package-name"
   version = "package-version"
   ```

   ​						使用软件包名称替换 *package-name*，比如 **httpd**、**gdb-doc** 或者 **coreutils**。 				

   ​						将 *package-version* 替换为要使用的版本。此字段支持 `dnf` 版本规范： 				

   - ​								对于特定版本，请使用确切的版本号，如 **8.7.0**。 						
   - ​								对于最新可用版本，请使用星号 *****。 						
   - ​								对于最新的次版本，请使用以下格式，如 **8.***。 						

3. ​						自定义蓝图以满足您的需要。例如，禁用 Simultaneous Multi Threading (SMT)，在蓝图文件中添加以下行： 				

   

   ```none
   [customizations.kernel]
   append = "nosmt=force"
   ```

   ​						有关其他可用的定制信息，请参阅 [支持的镜像自定义](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#image-customizations_creating-system-images-with-composer-command-line-interface)。 				

4. ​						将文件保存为 例如 *BLUEPRINT-NAME*.toml，并关闭文本编辑器。 				

5. ​						推送（导入）蓝图： 				

   

   ```none
   # composer-cli blueprints push BLUEPRINT-NAME.toml
   ```

   ​						将 *BLUEPRINT-NAME* 替换为您在前面步骤中使用的值。 				

   注意

   ​							以非 root 身份运行 `composer-cli` 命令创建镜像，请将您的用户添加到 `weldr` 或 `root` 组中。 					

   

   ```none
   # usermod -a -G weldr user
   $ newgrp weldr
   ```

**验证**

- ​						列出现有的蓝图以验证蓝图是否已推送并已存在： 				

  

  ```none
  # composer-cli blueprints list
  ```

- ​						显示您刚刚添加的蓝图配置： 				

  

  ```none
  # composer-cli blueprints show BLUEPRINT-NAME
  ```

- ​						检查蓝图中列出的组件和版本是否有效： 				

  

  ```none
  # composer-cli blueprints depsolve BLUEPRINT-NAME
  ```

  ​						如果镜像构建器无法从自定义存储库中解压缩软件包，请按照以下步骤执行： 				

- ​						删除 osbuild-composer 缓存： 				

  

  ```none
  $ sudo rm -rf /var/cache/osbuild-composer/*
  $ sudo systemctl restart osbuild-composer
  ```

**其他资源**

- ​						[`osbuild-composer` 无法从我的自定义存储库中解决软件包](https://access.redhat.com/solutions/6537251)。 				
- ​						[使用代理服务器编写自定义的 RHEL 系统镜像](https://access.redhat.com/solutions/5720761)。 				

## 4.3. 使用命令行界面编辑镜像构建器蓝图

​				您可以在命令行(CLI)界面中编辑现有的镜像构建器蓝图，例如添加新软件包或定义新组，以创建自定义镜像。为此，请按照以下步骤操作： 		

**前提条件**

- ​						您已创建了蓝图。 				

**流程**

1. ​						将蓝图保存（导出）到本地文本文件： 				

   

   ```none
   # composer-cli blueprints save BLUEPRINT-NAME
   ```

2. ​						使用文本编辑器编辑 *BLUEPRINT-NAME*.toml 文件并进行更改。 				

3. ​						在完成编辑前，请验证该文件是否是一个有效的蓝图： 				

   1. ​								如果存在，删除此行： 						

      

      ```none
      packages = []
      ```

   2. ​								增加版本号，如从 0.0.1 增加到 0.1.0。请记住，镜像构建器蓝图版本必须使用 [Semantic Versioning](https://semver.org/) 方案。请注意，如果您没有更改版本，**补丁**版本组件会自动增加。 						

   3. ​								检查内容是否是有效的 TOML 规格。如需更多信息，请参阅 [TOML 文档](https://github.com/toml-lang/toml#toml/)。 						

      注意

      ​									TOML 文档是一款社区产品，红帽不支持。您可以使用该工具报告任何问题： https://github.com/toml-lang/toml/issues 							

4. ​						保存文件并关闭文本编辑器。 				

5. ​						将蓝图推送（导入）回镜像构建器： 				

   

   ```none
   # composer-cli blueprints push BLUEPRINT-NAME.toml
   ```

   注意

   ​							要将蓝图导入回镜像构建器，请提供文件名，包括 `.toml` 扩展名，而其他命令则只使用蓝图名称。 					

6. ​						要验证上传到镜像构建器的内容是否与您的编辑匹配，请列出蓝图的内容： 				

   

   ```none
   # composer-cli blueprints show BLUEPRINT-NAME
   ```

7. ​						检查蓝图中列出的组件和版本是否有效： 				

   

   ```none
   # composer-cli blueprints depsolve BLUEPRINT-NAME
   ```

**其他资源**

- ​						[支持的镜像自定义](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#image-customizations_creating-system-images-with-composer-command-line-interface). 				

## 4.4. 在命令行界面中使用镜像构建器创建系统镜像

​				您可以使用镜像构建器命令行界面构建自定义镜像。 		

**前提条件**

- ​						您已为镜像准备了蓝图。请参阅[使用命令行界面创建镜像构建器蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#creating-a-composer-blueprint-with-command-line-interface_creating-system-images-with-composer-command-line-interface)。 				

**流程**

1. ​						启动 compose： 				

   

   ```none
   # composer-cli compose start BLUEPRINT-NAME IMAGE-TYPE
   ```

   ​						将 *BLUEPRINT-NAME* 替换为蓝图的名称，将 *IMAGE-TYPE* 替换为镜像的类型。有关可用值，请查看 `composer-cli compose types` 命令的输出。 				

   ​						compose 进程在后台启动，并显示 composer Universally Unique Identifier (UUID)。 				

2. ​						等待 compose 过程完成。镜像创建最多可能需要十分钟才能完成。 				

   ​						检查 Compose 的状态： 				

   

   ```none
   # composer-cli compose status
   ```

   ​						完成的 compose 显示 **FINISHED** 状态值。要识别列表中您的 compose，请使用其 UUID。 				

3. ​						完成 compose 过程后，下载生成的镜像文件： 				

   

   ```none
   # composer-cli compose image UUID
   ```

   ​						使用前面步骤中显示的 *UUID* 值替换 UUID。 				

**验证**

​					创建镜像后，您可以使用以下命令检查镜像创建进度： 			

- ​						检查 compose 状态： 				

  

  ```none
  $ sudo composer-cli compose status
  ```

- ​						下载镜像元数据： 				

  

  ```none
  $ sudo composer-cli compose metadata UUID
  ```

- ​						下载镜像的日志： 				

  

  ```none
  $ sudo composer-cli compose logs UUID
  ```

  ​						该命令会创建一个 `.tar` 文件，其中包含创建镜像的日志。如果日志为空，您可以检查日志。 				

- ​						检查日志： 				

  

  ```none
  $ journalctl | grep osbuild
  ```

- ​						检查清单： 				

  

  ```none
  $ sudo cat /var/lib/osbuild-composer/jobs/job_UUID.json
  ```

  ​						您可以在日志中找到 *job_UUID*.json。 				

**其他资源**

- ​						[追踪镜像构建器](https://access.redhat.com/solutions/6537251) 				

## 4.5. 基本镜像构建器命令行命令

​				镜像构建器命令行界面提供以下子命令。 		

**蓝图操作**

- 列出所有可用的蓝图

  `# composer-cli blueprints list`

- 显示 TOML 格式的蓝图内容

  `# composer-cli blueprints show *BLUEPRINT-NAME*`

- 将蓝图内容以 TOML 格式保存（导出）到文件 `BLUEPRINT-NAME.toml`中

  `# composer-cli blueprints save *BLUEPRINT-NAME*`

- 删除蓝图

  `# composer-cli blueprints delete *BLUEPRINT-NAME*`

- 将 TOML 格式的蓝图文件推送(导入)到镜像构建器

  `# composer-cli blueprints push *BLUEPRINT-NAME*`

**从蓝图制作镜像**

- 列出可用的镜像类型

  `# composer-cli compose types`

- 启动一个目录

  `# composer-cli compose start *BLUEPRINT* *COMPOSE-TYPE*` 						将 *BLUEPRINT* 替换为要构建的蓝图名称，将 *COMPOSE-TYPE* 替换为输出镜像类型。 					

- 列出所有 compose

  `# composer-cli compose list`

- 列出所有 compose 及其状态

  `# composer-cli compose status`

- 取消正在运行的 compose

  `# composer-cli compose cancel *COMPOSE-UUID*`

- 删除完成的 compose

  `# composer-cli compose delete *COMPOSE-UUID*`

- 显示有关 compose 的详细信息

  `# composer-cli compose info *COMPOSE-UUID*`

- 下载 compose 的镜像文件

  `# composer-cli compose image *COMPOSE-UUID*`

- 更多子命令和选项

  `# composer-cli help`

**其他资源**

- ​						*composer-cli*(1) man page 				

## 4.6. 镜像构建器蓝图格式

​				镜像构建器蓝图以以 TOML 格式的纯文本形式呈现给用户。 		

​				典型的蓝图文件元素包括： 		

- 蓝图元数据

  `name = "*BLUEPRINT-NAME*" description = "*LONG FORM DESCRIPTION TEXT*" version = "*VERSION*"` 						*BLUEPRINT-NAME* 和 *LONG FORM DESCRIPTION TEXT* 字段是您的蓝图的名称和描述。 					 						*VERSION* 是 [Semantic Versioning](https://semver.org/) 方案的版本号。 					 						这部分只针对整个蓝图文件显示一次。 					 						*modules* 条目列出了要安装到镜像中的软件包名称和版本。 					 						*group* 条目描述要安装到镜像中的一组软件包。组使用以下软件包类别： 					 								Mandatory（必需） 							 								Default（默认） 							 								Optional（可选） 							 								蓝图安装必需的和默认的软件包。没有选择可选软件包的机制。 							

- 镜像中包含的组

  `[[groups]] name = "*group-name*"` 						*group-name* 是组的名称，例如 **anaconda-tools**, **widget**, **wheel** 或 **users**。 					

- 镜像中包含的软件包

  `[[packages]] name = "*package-name*" version = "*package-version*"` 						*package-name* 是软件包的名称，如 **httpd**、**gdb-doc** 或 **coreutils**。 					 						*package-version* 是要使用的版本。此字段支持 `dnf` 版本规范： 					 								对于特定版本，请使用确切的版本号，如 **8.7.0**。 							 								对于最新的可用版本，请使用星号 *****。 							 								对于最新的次版本，请使用以下格式，如 **8.***。 							 						为每个要包括的软件包重复这个块。 					

注意

​					目前镜像构建器工具中的软件包和模块之间没有区别。两者都被视为 RPM 软件包依赖项。 			

## 4.7. 支持的镜像自定义

​				您可以通过启用服务或自定义内核命令行参数来在蓝图中添加额外的 RPM 软件包来自定义镜像。您可以在蓝图中使用多个镜像自定义。要使用这些选项，您必须在蓝图中配置自定义，并将其导入(推送)到镜像构建器。 		

注意

​					在 web 控制台中使用镜像构建器时，不支持这些自定义。 			

- 选择一个软件包组

  `[[packages]] name = "*package_group_name*"` 						将 "*package_group_name*" 替换为组的名称。例如："@server with gui"。 					

- 设置镜像主机名

  `[customizations] hostname = "*baseimage*"`

- 生成系统镜像的用户规范

  `[[customizations.user]] name = "*USER-NAME*" description = "*USER-DESCRIPTION*" password = "*PASSWORD-HASH*" key = "*PUBLIC-SSH-KEY*" home = "/home/*USER-NAME*/" shell = "*/usr/bin/bash*" groups = [*"users", "wheel"*] uid = *NUMBER* gid = *NUMBER*` 						GID 是可选的，且必须已存在于镜像中。（可选）软件包创建它，或者蓝图使用 `[[customizations.group]` 条目创建 GID。 					重要 							要生成 `密码哈希`，您必须在系统上安装 **python3**。 						`# dnf install python3` 						将 *PASSWORD-HASH* 替换为实际的 `密码哈希`。要生成 `密码哈希`，请使用如下命令： 					`$ python3 -c 'import crypt,getpass;pw=getpass.getpass();print(crypt.crypt(pw) if (pw==getpass.getpass("Confirm: ")) else exit())'` 						将 *PUBLIC-SSH-KEY* 替换为实际公钥。 					 						使用适当的值替换其他占位符。 					 						您必须输入 `name`。您可以省略您不需要的任何行。 					 						为每个要包含的用户重复这个块。 					

- 生成系统镜像的组规范

  `[[customizations.group]] name = "*GROUP-NAME*" gid = *NUMBER*` 						为每个组重复此块。 					

- 设置现有的用户 SSH 密钥

  `[[customizations.sshkey]] user = "*root*" key = "*PUBLIC-SSH-KEY*"`注意 							"设置现有用户 SSH 密钥"自定义仅适用于现有用户。要创建用户并设置 SSH 密钥，请参阅 **生成的系统镜像的用户规格** 自定义。 						

- 在默认值中附加一个内核引导参数选项

  `[customizations.kernel] append = "*KERNEL-OPTION*"`

- 默认情况下，镜像构建器将默认内核构建到镜像中。但是，您可以使用蓝图中的以下配置自定义内核

  `[customizations.kernel] name = "*KERNEL-rt*"`

- 定义要在镜像中使用的内核名称

  `[customizations.kernel.name] name = "*KERNEL-NAME*"`

- 为生成的系统镜像设置时区和 *网络时间协议* **(NTP)** 服务器

  `[customizations.timezone] timezone = "*TIMEZONE*" ntpservers = "*NTP_SERVER*"` 						如果您没有设置时区，系统将默认使用 *Universal Time, Coordinated* **（UTC）**。设置 NTP 服务器是可选的。 					

- 为生成的系统镜像设置区域设置

  `[customizations.locale] languages = *["LANGUAGE"]* keyboard = "*KEYBOARD*"` 						设置语言和键盘选项是必需的。您可以添加许多其他语言。您添加的第一个语言是主要语言，其他语言为次要语言。例如： 					`[customizations.locale] languages = ["en_US.UTF-8"] keyboard = "us"` 						要列出语言支持的值，请运行以下命令： 					`$ localectl list-locales` 						要列出键盘支持的值，请运行以下命令： 					`$ localectl list-keymaps`

- 为生成的系统镜像设置防火墙

  `[customizations.firewall] port = *["PORTS"]*` 						要启用列表，您可以使用数字端口或 `/etc/services` 文件中的名称。 					

- 自定义防火墙服务

  ​							查看可用的防火墙服务。 					`$ firewall-cmd --get-services` 						在蓝图中，在 `customs.firewall.service` 部分下指定要自定义的防火墙服务。 					`[customizations.firewall.services] enabled = *["SERVICES"]* disabled = *["SERVICES"]*` 						`firewall.services` 中列出的服务与 `/etc/services` 文件中提供的服务名不同。 					注意 							如果您不想自定义防火墙服务，请省略蓝图中的 `[customizations.firewall]` 和 `[customizations.firewall.services]` 部分。 						

- 设置在引导时要启用哪个服务

  `[customizations.services] enabled = *["SERVICES"]* disabled = *["SERVICES"]*` 						您可以控制在引导期间要启用哪些服务。有些镜像类型已经启用或禁用了服务，以确保镜像正常工作，此设置无法被覆盖。蓝图中的 `[customizations.services]` 自定义不会替换这些服务，而是将它们添加到镜像模板中已存在的服务列表中。 					注意 							每次构建启动时，它会克隆主机系统的存储库。如果您引用具有大量历史记录的存储库，则可能需要一些时间来克隆，并且其使用大量的磁盘空间。另外，克隆是临时的，构建会在创建 RPM 软件包后将其删除。 						

- 指定自定义文件系统配置

  ​							您可以在蓝图中指定自定义的文件系统配置，因此可以使用特定的磁盘布局创建镜像，而不是默认的布局配置。通过使用蓝图中的非默认布局配置，您可以受益于： 					 								安全基准合规性 							 								防止磁盘不足错误 							 								提高了性能 							 								与现有设置的一致性 							 								要在蓝图中自定义文件系统配置： 							`[[customizations.filesystem]] mountpoint = *"MOUNTPOINT"* size = *MINIMUM-PARTITION-SIZE*` 								蓝图支持以下 `挂载点` 及其子目录： 							 										`/` - root 挂载点 									 										`/var` 									 										`/home` 									 										`/opt` 									 										`/srv` 									 										`/usr` 									 										`/app` 									 										`/data` 									 										`/boot` - 从 RHEL 8.7 和 RHEL 9.1 开始支持。 									注意 											仅从 RHEL 8.5 和 RHEL 9.0 发行版起支持使用 CLI 自定义挂载点。在之前的发行版本中，您只能将 `root` 分区指定为挂载点，并将 `size` 参数指定为镜像大小的别名。 										 										如果您在自定义镜像中有多个分区，您可以在 LVM  上创建带有自定义文件系统分区的镜像，并在运行时调整这些分区大小。要做到这一点，您可以在蓝图中指定自定义的文件系统配置，因此可以创建具有所需磁盘布局的镜像。默认文件系统布局保持不变 - 如果您使用没有文件系统自定义的普通镜像，`cloud-init` 会调整 root 分区的大小。 									注意 											从 8.6 开始，对于 `osbuild-composer-46.1-1.el8` RPM 及更新的版本，物理分区不再可用，文件系统自定义会创建逻辑卷。 										 										蓝图自动将文件系统自定义转换为 LVM 分区。 									 										`MINIMUM-PARTITION-SIZE` 值没有默认大小格式。蓝图自定义支持以下值和单位：kB 到 TB 和 KiB 到 TiB。例如，您可以以字节为单位定义挂载点大小： 									`[[customizations.filesystem]] mountpoint = "/var" size = 1073741824` 										您也可以使用单位定义挂载点大小。 									注意 											您只能使用为 RHEL 8.6 和 RHEL 9.0 后续发行版提供的软件包版本的单元来定义挂载点大小。 										 										例如： 									`[[customizations.filesystem]] mountpoint = "/opt" size = "20 GiB" or [[customizations.filesystem]] mountpoint = "/boot" size = "1 GiB"`

**其他资源**

- ​						[在添加文件系统自定义 "size" 后，蓝图导入会失败](https://access.redhat.com/solutions/6971352)。 				

## 4.8. 镜像构建器安装的软件包

​				当使用镜像构建器创建系统镜像时，系统会安装一组基本软件包。 		

表 4.1. 支持创建镜像类型的默认软件包

| 镜像类型                    | 默认软件包                                                   |
| --------------------------- | ------------------------------------------------------------ |
| `ami`                       | `checkpolicy, chrony, cloud-init,  cloud-utils-growpart, @Core, dhcp-client, gdisk, insights-client,  kernel, langpacks-en, net-tools, NetworkManager, redhat-release,  redhat-release-eula, rng-tools, rsync, selinux-policy-targeted, tar,  yum-utils` |
| `openstack`                 | `@core, langpacks-en`                                        |
| `qcow2`                     | `@core, chrony, dnf, kernel, dnf,  nfs-utils, dnf-utils, cloud-init, python3-jsonschema, qemu-guest-agent,  cloud-utils-growpart, dracut-norescue, tar, tcpdump, rsync,  dnf-plugin-spacewalk, rhn-client-tools, rhnlib, rhnsd, rhn-setup,  NetworkManager, dhcp-client, cockpit-ws, cockpit-system,  subscription-manager-cockpit, redhat-release, redhat-release-eula,  rng-tools, insights-client` |
| `tar`                       | `policycoreutils, selinux-policy-targeted`                   |
| `vhd`                       | `@core, langpacks-en`                                        |
| `vmdk`                      | `@core, chrony, cloud-init, firewalld, langpacks-en, open-vm-tools, selinux-policy-targeted` |
| `edge-commit`               | `attr, audit, basesystem, bash,  bash-completion, chrony, clevis, clevis-dracut, clevis-luks,  container-selinux, coreutils,criu, cryptsetup, curl, dnsmasq,  dosfstools, dracut-config-generic, dracut-network, e2fsprogs, firewalld, fuse-overlayfs, fwupd, glibc, glibc-minimal-langpack, gnupg2,  greenboot, gzip, hostname, ima-evm-utils, iproute, iptables, iputils,  keyutils, less, lvm2, NetworkManager, NetworkManager-wifi,  NetworkManager-wwan, nss-altfiles, openssh-clients, openssh-server,  passwd, pinentry, platform-python, podman, policycoreutils,  policycoreutils-python-utils, polkit, procps-ng, redhat-release,  rootfiles, rpm, rpm-ostree, rsync, selinux-policy-targeted,  setools-console, setup, shadow-utils, shadow-utils, skopeo, slirp4netns, sudo, systemd, tar, tmux, traceroute, usbguard, util-linux,  vim-minimal, wpa_supplicant, xz` |
| `edge-container`            | `dnf, dosfstools, e2fsprogs, glibc,  lorax-templates-generic, lorax-templates-rhel, lvm2, policycoreutils,  python36, python3-iniparse, qemu-img, selinux-policy-targeted, systemd,  tar, xfsprogs, xz` |
| `edge-installer`            | `aajohan-comfortaa-fonts,  abattis-cantarell-fonts, alsa-firmware, alsa-tools-firmware, anaconda,  anaconda-install-env-deps, anaconda-widgets, audit, bind-utils,  bitmap-fangsongti-fonts, bzip2, cryptsetup, dbus-x11, dejavu-sans-fonts, dejavu-sans-mono-fonts, device-mapper-persistent-data, dnf, dump,  ethtool, fcoe-utils, ftp, gdb-gdbserver, gdisk, gfs2-utils,  glibc-all-langpacks, google-noto-sans-cjk-ttc-fonts,  gsettings-desktop-schemas, hdparm, hexedit, initscripts, ipmitool,  iwl3945-firmware, iwl4965-firmware, iwl6000g2a-firmware,  iwl6000g2b-firmware, jomolhari-fonts, kacst-farsi-fonts,  kacst-qurn-fonts, kbd, kbd-misc, kdump-anaconda-addon,  khmeros-base-fonts, libblockdev-lvm-dbus, libertas-sd8686-firmware,  libertas-sd8787-firmware, libertas-usb8388-firmware,  libertas-usb8388-olpc-firmware, libibverbs, libreport-plugin-bugzilla,  libreport-plugin-reportuploader, libreport-rhel-anaconda-bugzilla,  librsvg2, linux-firmware, lklug-fonts, lldpad, lohit-assamese-fonts,  lohit-bengali-fonts, lohit-devanagari-fonts, lohit-gujarati-fonts,  lohit-gurmukhi-fonts, lohit-kannada-fonts, lohit-odia-fonts,  lohit-tamil-fonts, lohit-telugu-fonts, lsof, madan-fonts, metacity, mtr, mt-st, net-tools, nmap-ncat, nm-connection-editor, nss-tools,  openssh-server, oscap-anaconda-addon, pciutils, perl-interpreter, pigz,  python3-pyatspi, rdma-core, redhat-release-eula, rpm-ostree, rsync,  rsyslog, sg3_utils, sil-abyssinica-fonts, sil-padauk-fonts,  sil-scheherazade-fonts, smartmontools, smc-meera-fonts, spice-vdagent,  strace, system-storage-manager, thai-scalable-waree-fonts,  tigervnc-server-minimal, tigervnc-server-module, udisks2, udisks2-iscsi, usbutils, vim-minimal, volume_key, wget, xfsdump,  xorg-x11-drivers,xorg-x11-fonts-misc,xorg-x11-server-utils,xorg-x11-server-Xorg, xorg-x11-xauth` |
| `edge-simplified-installer` | `attr, basesystem, binutils, bsdtar,  clevis-dracut, clevis-luks, cloud-utils-growpart, coreos-installer,  coreos-installer-dracut, coreutils, device-mapper-multipath, dnsmasq,  dosfstools, dracut-live, e2fsprogs, fcoe-utils, fdo-init, gzip,  ima-evm-utils, iproute, iptables, iputils, iscsi-initiator-utils,  keyutils, lldpad, lvm2, passwd, policycoreutils,  policycoreutils-python-utils, procps-ng, rootfiles, setools-console,  sudo, traceroute, util-linux` |
| `image-installer`           | `anaconda-dracut, curl,  dracut-config-generic, dracut-network, hostname, iwl100-firmware,  iwl1000-firmware, iwl105-firmware, iwl135-firmware, iwl2000-firmware,  iwl2030-firmware, iwl3160-firmware, iwl5000-firmware, iwl5150-firmware,  iwl6000-firmware, iwl6050-firmware, iwl7260-firmware, kernel, less,  nfs-utils, openssh-clients, ostree, plymouth, prefixdevname, rng-tools,  rpcbind, selinux-policy-targeted, systemd, tar, xfsprogs, xz` |
| `edge-raw-image`            | `dnf, dosfstools, e2fsprogs, glibc,  lorax-templates-generic, lorax-templates-rhel, lvm2, policycoreutils,  python36, python3-iniparse, qemu-img, selinux-policy-targeted, systemd,  tar, xfsprogs, xz` |
| `gce`                       | `@core, langpacks-en, acpid, dhcp-client, dnf-automatic, net-tools, python3, rng-tools, tar, vim` |

注意

​					当您在蓝图中添加其他组件时，请确保添加的组件中的软件包不会与任何其他软件包组件冲突。否则，系统无法解决依赖项并创建自定义镜像失败。您可以通过运行以下命令检查软件包之间没有冲突： 			



```none
# composer-cli blueprints depsolve BLUEPRINT-NAME
```

**其他资源**

- ​						[镜像构建器描述](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#composer-output-formats_composer-description) 				

## 4.9. 在自定义镜像中启用服务

​				当使用镜像构建器配置自定义镜像时，镜像使用的默认服务是由以下内容决定的： 		

- ​						使用 `osbuild-composer` 工具的 RHEL 发行版本 				
- ​						镜像类型 				

​				例如，`ami` 镜像类型默认启用 `sshd`、`chronyd` 和 `cloud-init` 服务。如果没有启用这些服务，则自定义镜像不会引导。 		

表 4.2. 启用服务来支持镜像类型创建

| 镜像类型           | 默认启用的服务                                               |
| ------------------ | ------------------------------------------------------------ |
| `ami`              | sshd, cloud-init, cloud-init-local, cloud-config, cloud-final |
| `openstack`        | sshd, cloud-init, cloud-init-local, cloud-config, cloud-final |
| `qcow2`            | cloud-init                                                   |
| `rhel-edge-commit` | 默认没有启用任何额外服务                                     |
| `tar`              | 默认没有启用任何额外服务                                     |
| `vhd`              | sshd, chronyd, waagent, cloud-init, cloud-init-local, cloud-config, cloud-final |
| `vmdk`             | sshd、chronyd、vmtoolsd、cloud-init                          |

​				备注：您可以自定义在系统引导过程中要启用的服务。但是，自定义不会覆盖上述镜像类型默认启用的服务。 		

**其他资源**

- ​						[支持的镜像自定义](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#image-customizations_creating-system-images-with-composer-command-line-interface) 				

# 第 5 章 使用镜像构建器 Web 控制台界面创建系统镜像

​			镜像构建器是创建自定义系统镜像的工具。要控制镜像构建器并创建自定义系统镜像，您可以使用 Web 控制台界面。请注意, [命令行界面](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#creating-system-images-with-composer-command-line-interface_composing-a-customized-rhel-system-image) 目前为首选，因为它提供了更多的功能。 	

## 5.1. 在 RHEL web 控制台中访问镜像构建器 GUI

​				使用 RHEL web 控制台的 **cockpit-composer** 插件，您可以使用图形界面管理镜像构建器蓝图和 compose。控制镜像构建器的首选方法是命令行界面。 		

**前提条件**

- ​						您必须有对该系统的根权限。 				
- ​						已安装镜像构建器。 				

**流程**

1. ​						在安装了镜像构建器的系统上的 Web 浏览器中打开 `https://localhost:9090/`。 				

   ​						有关如何远程访问镜像构建器的更多信息，请参阅 [*使用 RHEL web 控制台管理系统*](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html/managing_systems_using_the_rhel_8_web_console) 文档。 				

2. ​						以 root 用户身份登录 Web 控制台。 				

3. ​						要显示镜像构建器控制，请单击窗口左上角的 `镜像构建器` 图标。 				

   ​						镜像构建器视图打开，列出现有的蓝图。 				

**其他资源**

- ​						[使用镜像构建器命令行界面创建系统镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#creating-system-images-with-composer-command-line-interface_composing-a-customized-rhel-system-image) 				

## 5.2. 在 web 控制台界面中创建镜像构建程序蓝图

​				在描述自定义系统镜像前，创建蓝图是一个必要的步骤。 		

**前提条件**

- ​						您已在浏览器中从 Web 控制台打开了镜像构建器应用。请参阅 [在 RHEL web 控制台中访问镜像构建器 GUI](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#accessing-composer-gui-in-the-rhel-8-web-console_creating-system-images-with-composer-web-console-interface)。 				

**流程**

1. ​						点右上角的 Create Blueprint。 				

   ​						此时会打开一个对话框向导，其中包含蓝图名称和描述字段。 				

2. ​						输入蓝图的名称，以及可选的描述。 				

3. ​						点 Create。 				

​				镜像构建器视图打开，列出现有的蓝图。 		

## 5.3. 在 web 控制台界面中使用镜像构建器创建系统镜像

​				您可以通过完成以下步骤，从蓝图创建系统镜像： 		

**前提条件**

- ​						在浏览器中，您从 Web 控制台打开了镜像构建器应用。 				
- ​						您创建了蓝图。 				

**流程**

1. ​						点 Back to blueprints 以显示蓝图表。 				

2. ​						在蓝图表中，找到您要构建镜像的蓝图。 				

   1. ​								另外，您可以使用搜索框找到蓝图。输入蓝图名称。 						

3. ​						在所选蓝图的右侧，点 Create Image。**Create image** 对话框向导将打开。 				

4. ​						在 **Image 输出**页面中完成以下步骤： 				

   1. ​								从 **Image 输出类型** 列表中，选择您想要的镜像类型。 						
      1. ​										您可以将一些镜像上传到其目标云环境，如 **Amazon Web Service** 和 **Oracle Cloud Infrastructure**。为此，选中 **上传至目标云** 框。 								
      2. ​										系统将提示您在下一页中为云环境添加凭证。 								

5. ​						在 **Image Size** 字段中输入镜像大小。最小值取决于镜像类型。点 Next。 				

6. ​						在 **Upload to \*Targeted_Cloud\*** 页面中，完成以下步骤： 				

   ​						注意：如果您没有选择将您的镜像上传到云环境的复选框，则此页面是不可见的。 				

   1. ​								在 **Authentication** 页面中，输入与目标云帐户 ID 相关的信息，然后点 Next。 						
   2. ​								在 **Destination 页**中，输入与目标云帐户类型相关的信息，然后点 Next。 						

7. ​						在 **Customizations** 页面中，完成以下步骤： 				

   1. ​								在 **System** 页面中，输入 Hostname。如果没有输入主机名，操作系统会决定系统的主机名。 						
   2. ​								在 **Users** 页面中，点 Add user: 						
      1. ​										必需：输入用户名。 								
      2. ​										输入密码。 								
      3. ​										输入 SSH 密钥。 								
      4. ​										如果要使用户成为服务器管理员，请选中该框。点 Next。 								

8. ​						在 **Package** 页面中，完成以下步骤： 				

   1. ​								在 **Available packages** 搜索字段中，输入您要添加到系统镜像的软件包名称。 						

      注意

      ​									搜索软件包可能需要一些时间才能完成。 							

   2. ​								点 > 箭头添加所选软件包。点 Next。 						

9. ​						在 **Review** 页面中，查看镜像创建的详情。点 Save blueprint 保存添加到蓝图中的自定义。点 Create image。 				

   ​						镜像构建启动，需要 20 分钟完成。 				

# 第 6 章 使用镜像构建器创建引导 ISO 安装程序镜像

​			您可以使用镜像构建器创建可引导的 ISO 安装程序镜像。这些镜像由一个带有根文件系统的 `.tar` 文件组成。您可以使用可引导的 ISO 镜像来将文件系统安装到裸机服务器上。 	

​			镜像构建器构建一个清单，该清单会创建一个包含根文件系统的引导 ISO。要创建 ISO 镜像，请选择映像类型 **image-installer**。镜像构建器使用以下内容构建 `.tar` 文件： 	

- ​					标准 Anaconda 安装程序 ISO 			
- ​					嵌入式 RHEL 系统 tar 文件 			
- ​					安装提交的默认 Kickstart 文件，其要求最小 			

​			创建的安装程序 ISO 镜像包含一个预先配置的系统镜像，您可以直接安装到裸机服务器。 	

## 6.1. 在命令行界面中使用镜像构建器创建引导 ISO 安装程序镜像

​				您可以使用镜像构建器命令行界面创建自定义引导 ISO 安装程序镜像。 		

**前提条件**

- ​						您已为镜像创建了一个包含用户的蓝图，并将其推送回镜像构建器。请参阅 [用户的蓝图自定义](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#image-customizations_creating-system-images-with-composer-command-line-interface)。 				

**流程**

1. ​						创建 ISO 镜像： 				

   

   ```none
   # composer-cli compose start BLUEPRINT-NAME image-installer
   ```

   - ​								带有您创建的蓝图名称的 *BLUEPRINT-NAME* 						

   - ​								*image-installer* 是镜像类型 						

     ​								compose 进程在后台启动，并显示 Compose 的 UUID。 						

2. ​						等待 compose 完成。请注意，这可能需要几分钟时间。 				

   ​						检查 Compose 的状态： 				

   

   ```none
   # composer-cli compose status
   ```

   ​						完成的 compose 显示 **FINISHED** 状态值。根据 UUID 识别列表中的内容。 				

3. ​						完成 compose 后，下载创建的镜像文件： 				

   

   ```none
   # composer-cli compose image UUID
   ```

   ​						将 *UUID* 替换为前面步骤中获取的 UUID 值。 				

   ​						因此，镜像构建器构建一个包含 `.tar` 文件的 `.iso` 文件。`.tar` 文件是要为操作系统安装的镜像。建立 `. iso` 是为了引导 Anaconda 并安装 tar 文件来建立系统。 				

**验证**

1. ​						导航到下载镜像文件的文件夹。 				

2. ​						找到您下载的 `.iso` 镜像。 				

3. ​						挂载 ISO。 				

   

   ```none
   $ mount -o ro path_to_ISO /mnt
   ```

   ​						您可以在 `/mnt/liveimg.tar.gz` 目录中找到 `.tar` 文件。 				

4. ​						提取 `.tar` 文件内容。 				

   

   ```none
   $ tar xzf /mnt/liveimg.tar.gz
   ```

​				您可以使用在硬盘上创建的 ISO 镜像文件，或者在虚拟机中引导，例如在 HTTP 引导或 USB 安装中。 		

**其他资源**

- ​						[使用镜像构建器命令行界面创建系统镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-command-line-interface_composing-a-customized-rhel-system-image) 				
- ​						[为 RHEL 创建可引导的安装介质](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/performing_a_standard_rhel_9_installation/assembly_creating-a-bootable-installation-medium_installing-rhel) 				

## 6.2. 在 GUI 中使用镜像构建器创建引导 ISO 安装程序镜像

​				您可以使用镜像构建器 GUI 构建自定义引导 ISO 安装程序镜像。 		

**前提条件**

- ​						您已为镜像创建了一个蓝图。请参阅[在 web 控制台界面中创建镜像构建程序蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#creating-a-composer-blueprint-in-the-web-console-interface_creating-system-images-with-composer-web-console-interface)。 				

**流程**

1. ​						在浏览器中打开 RHEL web 控制台的镜像构建器界面。请参阅[使用命令行界面创建镜像构建器蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#creating-a-composer-blueprint-with-command-line-interface_creating-system-images-with-composer-command-line-interface)。 				

2. ​						找到您要用来构建镜像的蓝图。要做到这一点，请在左上角的搜索框中输入蓝图名称或部分名称，然后点 Enter。 				

3. ​						在蓝图的右侧，点对应的 Create Image 按钮。 				

   ​						**Create image** 对话框向导将打开。 				

4. ​						在 **Create image** 对话框向导中： 				

   1. ​								在 **Image Type** 列表中，选择 `"RHEL Installer (.iso)` "。 						
   2. ​								点 Create。 						

​				镜像构建器将 RHEL ISO 镜像的组成添加到队列。 		

注意

​					镜像构建过程需要几分钟时间才能完成。 			

​				过程完成后，您可以看到镜像构建完成状态。镜像构建器创建 ISO 镜像。 		

**验证**

​					成功创建镜像后，您可以下载该镜像。 			

1. ​						点 **Download** 将 `"RHEL Installer (.iso) "` 镜像保存到您的系统中。 				

2. ​						进入您下载 `"RHEL Installer(.iso)"` 镜像的文件夹。 				

3. ​						找到您下载的 .tar 镜像。 				

4. ​						提取 `"RHEL 安装程序(.iso)"` 镜像内容。 				

   

   ```none
   $ tar -xf content.tar
   ```

​				您可以使用在硬盘上生成的 ISO 镜像文件，或者在虚拟机中引导，例如在 HTTP 引导或 USB 安装中。 		

**其他资源**

- ​						[在 Web 控制台界面中创建镜像构建器蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-web-console-interface_composing-a-customized-rhel-system-image#creating-a-composer-blueprint-in-the-web-console-interface_creating-system-images-with-composer-web-console-interface)。 				
- ​						[使用镜像构建器命令行界面创建系统镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-command-line-interface_composing-a-customized-rhel-system-image)。 				
- ​						[为 RHEL 创建可引导安装介质](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/performing_a_standard_rhel_9_installation/assembly_creating-a-bootable-installation-medium_installing-rhel)。 				

## 6.3. 将镜像构建器 ISO 镜像安装到裸机系统

​				使用镜像构建器将您创建的可引导 ISO 镜像安装到裸机系统。 		

**前提条件**

- ​						您已使用镜像构建器创建了可引导的 ISO 镜像。请参阅[在命令行界面中使用镜像构建器创建引导 ISO 安装程序镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#creating-a-boot-iso-installer-image-with-image-builder-in-the-command-line-interface_creating-a-boot-iso-installer-image-with-image-builder)。 				
- ​						您已下载了可引导 ISO 镜像。 				
- ​						已安装 `dd` 工具。 				
- ​						您有一个有足够容量的 USB 闪存驱动器 ISO 镜像。所需的大小因您在蓝图中选择的软件包而异，但推荐的最小值为 8 GB。 				

**流程**

1. ​						使用 `dd` 工具将可引导 ISO 镜像直接写入 USB 驱动器。例如： 				

   

   ```none
   dd if=installer.iso of=/dev/sdX
   ```

   ​						其中 `installer.iso` 是 ISO 镜像文件名，`/dev/sdX` 是您的 USB 闪存驱动器设备路径。 				

2. ​						将闪存驱动器插入到您要引导的计算机的 USB 端口中。 				

3. ​						从 USB 闪存引导 ISO 镜像。 				

   ​						当安装环境启动时，您可能需要手动完成安装，类似于默认的 Red Hat Enterprise Linux 安装。 				

**其他资源**

- ​						[引导安装](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/performing_a_standard_rhel_9_installation/assembly_installing-on-amd64-intel-64-and-64-bit-arm_installing-rhel#booting-the-installer_assembly_installing-on-amd64-intel-64-and-64-bit-arm)。 				
- ​						[自定义安装](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/performing_a_standard_rhel_9_installation/assembly_customizing-your-installation_installing-rhel). 				
- ​						在 [Linux 中创建可引导 USB 设备](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/performing_a_standard_rhel_9_installation/assembly_preparing-for-your-installation_installing-rhel#create-bootable-usb-linux_assembly_creating-a-bootable-installation-medium)。 				

# 第 7 章 使用镜像构建器 OpenSCAP 集成创建预先强化的镜像

​			内部镜像构建器支持 OpenSCAP 集成，以生成预先强化的 RHEL 镜像。使用与 OpenSCAP  集成的内部镜像构建器，您可以生成预先强化的 RHEL  镜像。您可以设置蓝图，从一组预定义的安全配置集中选择、添加一组软件包或附加文件，并构建了一个自定义的 RHEL  镜像，供您部署到更适合于您的环境的选择平台上。 	

​			红帽为构建系统时可以选择的安全强化配置集定期更新版本，以便您能够满足您的当前部署指南。 	

## 7.1. Kickstart 和预先强化的镜像之间的区别

​				对于使用 Kickstart 文件创建的传统镜像，您需要选择要安装哪些软件包，并确保系统不受安全漏洞的影响。借助镜像构建器 OpenSCAP 集成，您可以构建安全强化型镜像。在镜像构建过程中，OSBuild `oscap remediation stage` 在文件系统树的 chroot 中运行 `OpenSCAP` 工具。`OpenSCAP` 工具为您选择的配置集运行标准评估，并将补救应用于镜像。因此，如果您与在实时系统上运行补救进行比较，您可以构建更加全面的强化型镜像。 		

## 7.2. OpenSCAP 蓝图自定义

​				通过对蓝图自定义进行 OpenSCAP 支持，您可以创建蓝图，然后使用它们构建自己的预先强化的镜像。要创建预先强化的镜像，您可以自定义挂载点并根据所选的安全配置集配置文件系统布局。在镜像构建过程中，OpenSCAP 应用第一次引导补救。 		

​				选择 OpenSCAP 配置集后，OpenSCAP 蓝图自定义配置镜像，以便在使用所选配置集的镜像构建过程中触发补救。 		

​				要在镜像蓝图中使用 OpenSCAP 蓝图，请输入以下信息： 		

- ​						到 `datastream` 补救指令的数据流路径。您可以在 `/usr/share/xml/scap/ssg/content/` 目录中找到。 				

- ​						所需的安全配置集的 `profile_id`。`profile_id` 字段接受长和简短形式，例如： `cis` 或 `xccdf_org.ssgproject.content_profile_cis`。如需了解更多详细信息，请参阅 [RHEL 9 支持的 SCAP 安全指南配置集](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/security_hardening/index#scap-security-guide-profiles-supported-in-rhel-9_scanning-the-system-for-configuration-compliance-and-vulnerabilities)。 				

  ​						以下是一个带有 OpenSCAP 自定义示例的蓝图： 				

  

  ```none
  [customizations]
  [customizations.openscap]
  datastream = "/usr/share/xml/scap/ssg/content/ssg-rhel8-ds.xml"
  profile_id = "xccdf_org.ssgproject.content_profile_cis"
  ```

  ​						最常见的 SCAP 文件类型是 SCAP 源数据流。要显示 `scap-security-guide` 软件包中的 SCAP 源数据流详情，请输入以下命令： 				

  

  ```none
  $ oscap info /usr/share/xml/scap/ssg/content/ssg-rhel8-ds.xml
  ```

  ​						`oscap` 工具在镜像树上运行，以执行挂载在任意路径的文件系统的离线扫描。您可以使用它扫描 `oscap-docker` 或 `oscap-vm` 不支持的自定义对象，如 Docker 以外的格式的容器。`oscap-chroot` 模拟 `oscap` 工具的使用和选项。 				

  ​						镜像构建器根据您的蓝图自定义生成 `osbuild` 阶段所需的配置。另外，镜像构建器为镜像添加两个软件包： 				

- ​						`openscap-scanner` - `OpenSCAP` 工具。 				

- ​						`scap-security-guide` - 包含补救指令的软件包。 				

  注意

  ​							补救阶段将 `scap-security-guide` 软件包用于 datastream，因为这个软件包默认安装在镜像中。如果要使用不同的数据流，将必要的软件包添加到蓝图中，并在 `oscap` 配置中指定到 datastream 的路径。 					

**其他资源**

- ​						[RHEL 9 支持的 SCAP 安全指南配置集](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/security_hardening/index#scap-security-guide-profiles-supported-in-rhel-9_scanning-the-system-for-configuration-compliance-and-vulnerabilities)。 				

## 7.3. 使用镜像构建器创建预先强化的镜像

​				使用 OpenSCAP 和镜像构建器集成，您可以创建预先强化的镜像。 		

**流程**

1. ​						使用 TOML 格式创建蓝图，其内容如下： 				

   

   ```none
   name = "blueprint_name"
   description = "blueprint_description"
   version = "0.0.1"
   modules = []
   groups = []
    distro = ""
   
   [customizations]
   [[customizations.user]]
   name = "scap-security-guide"
   description = "Admin account"
   password = secure_password_hash
   key = ssh-key
   home = "/home/scap-security-guide"
   group = ["wheel"]
   
   
   [[customizations.filesystem]]
   mountpoint = "/tmp"
   size = 13107200
   [customizations.openscap]
   datastream = "/usr/share/xml/scap/ssg/content/ssg-rhel8-ds.xml "
   profile_id = "cis"
   ```

2. ​						启动 OpenSCAP 镜像的构建： 				

   

   ```none
   # composer-cli compose start blueprint_name qcow2
   ```

   ​						其中 *blueprint_name* 是蓝图名称。 				

   ​						镜像构建就绪后，您可以在部署中使用预先强化的镜像。请参阅[创建虚拟机](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#creating-a-virtual-machine-from-a-kvm-guest-image_preparing-and-deploying-kvm-guest-images-with-image-builder)。 				

**验证**

​					在虚拟机中部署预先强化的镜像后，可以执行配置合规性扫描，以验证镜像是否与所选安全配置集一致。 			

重要

​					执行配置合规性扫描不能保证系统是合规的。如需更多信息，请参阅[配置合规性扫描](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/security_hardening/index#configuration-compliance-scanning_scanning-the-system-for-configuration-compliance-and-vulnerabilities)。 			

1. ​						使用 SSH 连接到镜像。 				

2. ​						运行 `oscap` 扫描程序。 				

   

   ```none
   # scap-workbench
   ```

3. ​						选择您要扫描的系统版本。点 Load content。 				

4. ​						选择您要扫描的配置集，然后点 Scan。OpenSCAP 检查系统的所有要求。 				

5. ​						扫描完成后，点 Show Report。 				

   ​						您可以从系统安全的结果中看到。 				

**其他资源**

- ​						[OpenSCAP](https://github.com/OpenSCAP/openscap/blob/maint-1.3/docs/manual/manual.adoc). 				
- ​						[OpenSCAP 可用安全配置集](https://www.osbuild.org/guides/user-guide/oscap-remediation.html). 				

# 第 8 章 使用镜像构建器准备和部署 KVM 客户机镜像

​			要创建在 Red Hat Virtualization 上使用的专用镜像，您可以使用镜像构建器来制作 `KVM` 客户机镜像。但请注意，只有 Red Hat Virtualization 中的 `rhel-guest-image` 支持 KVM 客户机镜像。 	

​			使用自定义 KVM 客户机镜像涉及以下高级别步骤： 	

1. ​					使用镜像构建器创建 KVM 客户机 `.qcow2` 镜像。 			
2. ​					从 KVM 客户机镜像创建虚拟机。 			

## 8.1. 使用镜像构建器创建自定义 KVM 客户机镜像

​				您可以使用镜像构建器创建自定义 `.qcow2` KVM 客户机镜像。 		

**前提条件**

- ​						您必须有访问系统的 root 或 wheel 组用户权限。 				
- ​						`cockpit-composer` 软件包已安装。 				
- ​						在 RHEL 系统上，您已打开 web 控制台的镜像构建器仪表盘。 				
- ​						您已创建了蓝图。请参阅[在 web 控制台界面中创建镜像构建程序蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-web-console-interface_composing-a-customized-rhel-system-image#creating-a-composer-blueprint-in-the-web-console-interface_creating-system-images-with-composer-web-console-interface)。 				

**流程**

1. ​						点您创建的蓝图名称。 				
2. ​						选择 **Images** 选项卡。 				
3. ​						单击 **Create Image** 来创建自定义镜像。此时会打开弹出窗口。 				
4. ​						在 **Type** 下拉菜单中选择 `QEMU Image (.qcow2)`。 				
5. ​						在实例化时设置您想要的镜像大小，并点击 **Create**。 				
6. ​						窗口右上角的小弹窗通知您已将镜像创建添加到队列中。镜像创建过程完成后，您可以看到**镜像构建完成**状态。 				

**验证**

1. ​						点击 breadcrumbs 图标，并选择 **Download** 选项。镜像构建器将 KVM 客户机镜像 `.qcow2` 文件下载到默认下载位置。 				

**其他资源**

- ​						[在 Web 控制台界面中创建镜像构建器蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-web-console-interface_composing-a-customized-rhel-system-image#creating-a-composer-blueprint-in-the-web-console-interface_creating-system-images-with-composer-web-console-interface)。 				

## 8.2. 从 KVM 客户机镜像创建虚拟机

​				使用镜像构建器，您可以构建 `.qcow2` 镜像，并使用 KVM 客户机镜像来创建虚拟机。使用镜像构建器创建的 KVM 客户机镜像已安装并启用了 `cloud-init`。 		

**前提条件**

- ​						您已使用镜像构建器创建了一个 `.qcow2` 镜像。请参阅 [在 web 控制台界面中创建镜像构建器蓝图。](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#creating-a-composer-blueprint-in-the-web-console-interface_creating-system-images-with-composer-web-console-interface) 				
- ​						`qemu-kvm` 软件包已安装在您的系统上。您可以检查您系统中是否有 `/dev/kvm` 文件夹。 				
- ​						在您的系统上已安装了 `libvirt` 和 `virt-install` 软件包。 				
- ​						`genisoimage` 工具已安装在您的系统上。 				

**流程**

1. ​						将您使用镜像构建器创建的 KVM 客户机镜像移到 `/var/lib/libvirt/images` 目录。 				

2. ​						创建一个目录，如 `cloudinitiso` ，并导航到这个新创建的目录： 				

   

   ```none
   $ mkdir cloudinitiso
   $ cd cloudinitiso
   ```

3. ​						创建一个名为 `meta-data` 的文件。在此文件中添加以下信息： 				

   

   ```none
   instance-id: citest
   local-hostname: vmname
   ```

4. ​						创建一个名为 `user-data` 的文件。在文件中添加以下信息： 				

   

   ```none
   #cloud-config
   user: admin
   password: password
   chpasswd: {expire: False}
   ssh_pwauth: True
   ssh_authorized_keys:
     - ssh-rsa AAA...fhHQ== your.email@example.com
   ```

   ​						其中，`ssh_authorized_keys` 是您的 SSH 公钥。您可以在 `~/.ssh/id_rsa.pub` 中找到 SSH 公钥。 				

5. ​						使用 `genisoimage` 命令创建一个包含 `user-data` 和 `meta-data` 文件的 ISO 镜像。 				

   

   ```none
   # genisoimage -output cloud-init.iso -volid cidata -joliet -rock user-data meta-data
   
   I: -input-charset not specified, using utf-8 (detected in locale settings)
   Total translation table size: 0
   Total rockridge attributes bytes: 331
   Total directory bytes: 0
   Path table size(bytes): 10
   Max brk space used 0
   183 extents written (0 MB)
   ```

6. ​						使用 `virt-install` 命令从 KVM 客户机映像创建一个新虚拟机。将您在第 4 步中创建的 ISO 镜像作为虚拟机镜像的附件。 				

   

   ```none
   # virt-install \
       --memory 4096 \
       --vcpus 4 \
       --name myvm \
       --disk rhel-9-x86_64-kvm.qcow2,device=disk,bus=virtio,format=qcow2 \
       --disk cloud-init.iso,device=cdrom \
       --os-variant rhel 9 \
       --virt-type kvm \
       --graphics none \
       --import
   ```

   ​						其中, 				

   - ​								--graphics none - 表示它是一个无头的 RHEL 9 虚拟机。 						
   - ​								--vcpus 4 - 表示它使用 4 个虚拟 CPU。 						
   - ​								--memory 4096 - 表示它使用 4096 MB RAM。 						

7. ​						虚拟机安装开始： 				

   

   ```none
   Starting install...
   Connected to domain mytestcivm
   ...
   [  OK  ] Started Execute cloud user/final scripts.
   [  OK  ] Reached target Cloud-init target.
   
   Red Hat Enterprise Linux 9 (Ootpa)
   Kernel 4.18.0-221.el8.x86_64 on an x86_64
   ```

**验证**

​					引导完成后，虚拟机会显示文本登录界面。登录到虚拟机： 			

1. ​						输入 `admin` 作为用户名，然后按 Enter 键。 				

2. ​						输入 `password` 作为密码，然后按 Enter 键。 				

   ​						登录身份验证完成后，您可以使用 CLI 访问虚拟机。 				

**其他资源**

- ​						[启用虚拟化](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/getting-started-with-virtualization-in-rhel-8_configuring-and-managing-virtualization#enabling-virtualization-in-rhel8_virt-getting-started). 				
- ​						[为 RHEL 9 配置和管理 cloud-init](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html/configuring_and_managing_cloud-init_for_rhel_8/index)。 				
- ​						[cloud-init 重要目录和文件](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html/configuring_and_managing_cloud-init_for_rhel_8/red-hat-support-for-cloud-init_cloud-content#cloud-init-significant-directories-and-files_red-hat-support-for-cloud-init). 				

# 第 9 章 将容器推送到 registry 中并将其嵌入到镜像中

​			通过对蓝图中的容器自定义的支持，您可以创建容器并将其直接嵌入到您创建的镜像中。 	

## 9.1. 蓝图自定义，将容器嵌入到镜像中

​				要从 [registry.access.redhat.com](http://registry.access.redhat.com/ubi9/ubi) registry 中嵌入容器，您必须在蓝图中添加容器自定义。例如： 		



```none
[[containers]]
source = "registry.access.redhat.com/ubi9/ubi:latest"
name =  "local-name"
tls-verify = true
```

- ​						`source` - 必需的字段。它是对 registry 中的容器镜像的引用。这个示例使用 `registry.access.redhat.com` registry。您可以指定标签版本。默认标签版本为 `latest`。 				

- ​						`name` - 本地 registry 中的容器名称。 				

- ​						`tls-verify` - 可选布尔值字段。`tls-verify` 布尔值字段控制传输层安全性。默认值为 `true`。 				

  ​						镜像构建器在镜像构建过程中拉取容器，并将容器存储到镜像中。默认本地容器存储位置取决于镜像类型，因此所有支持 `container-tools` （如 Podman）都可以使用它。嵌入的容器没有启动。要访问受保护的容器资源，您可以使用 `containers-auth.json` 文件。 				

## 9.2. 容器 registry 凭证

​				`osbuild-worker` 服务负责与容器 registry 的通信。要启用此功能，您可以设置 `/etc/osbuild-worker/osbuild-worker.toml` 配置文件。 		

注意

​					在设置 `/etc/osbuild-worker/osbuild-worker.toml` 配置文件后，您必须重启 `osbuild-worker` 服务，因为在 `osbuild-worker` 服务启动时，它只会读取 `/etc/osbuild-worker/osbuild-worker.toml` 配置文件一次。 			

​				`/etc/osbuild-worker/osbuild-worker.toml` 配置文件有一个 containers 部分，它带有 `auth_field_path` 条目，其值是是一个字符串代表用于访问受保护的资源的 `containers-auth.json` 文件路径。容器 registry 凭证仅在将容器嵌入到镜像中时用于从 registry 中拉取容器镜像。 		

​				以下是一个示例： 		



```none
[containers]
auth_file_path = "/etc/osbuild-worker/containers-auth.json"
```

**其他资源**

- ​						[`containers-auth.json` man page](https://www.mankier.com/5/containers-auth.json)。 				

## 9.3. 将容器工件直接推送到容器 registry

​				使用镜像构建程序 CLI 后，您可以将容器工件（如 RHEL for Edge 容器镜像）直接推送到容器 registry。为此，您必须设置 `上传供应商` ，以及可选的凭证，然后您可以构建容器镜像，将 registry 和存储库作为参数传递到 `composer-cli`。镜像就绪后，可在您设置的容器 registry 中提供。 		

**前提条件**

- ​						访问 [quay.io registry](https://quay.io)。本例使用 `quay.io` 容器 registry 作为目标 registry，但您可以使用您选择的容器 registry。 				

**流程**

1. ​						设置 `registry-config.toml` 文件以选择容器提供程序。 				

   

   ```none
   provider = "container_provider"
   
   [settings]
   tls_verify = false
   username = "admin"
   password = "your_password"
   ```

2. ​						使用 `.toml` 格式创建蓝图。这是您在蓝图中安装 `nginx` 软件包的容器蓝图。 				

   

   ```none
   name = "simple-container"
   description = "Simple RHEL container"
   version = "0.0.1"
   
   [[packages]]
   name = "nginx"
   version = "*"
   ```

3. ​						推送蓝图： 				

   

   ```none
   # composer-cli blueprints push blueprint.toml
   ```

4. ​						构建容器镜像： 				

   

   ```none
   # composer-cli compose start simple-container container "quay.io:8080/osbuild/repository" registry-config.toml
   ```

   - ​								simple-container - 是蓝图名称。 						

   - ​								Container - 是镜像类型。 						

   - ​								"quay.io:8080/osbuild/*repository*" - `quay.io` 是目标 registry, `osbuild` 是机构，`repository` 是在构建完成后要推送到的容器的位置。另外，您可以设置一个 `tag`。如果没有为 `:tag` 设置值，则默认为 `:latest` 标签。 						

     注意

     ​									构建容器镜像需要很长时间，因为需要处理自定义软件包。 							

5. ​						在镜像构建完成后，您创建的容器将出现在 [quay.io](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/quay.io) 中。 				

6. ​						访问 [quay.io](https://quay.io)，再点 `Repository Tags`。 				

   

   ```none
    You can see details about the container you created, such as:
   - last modified
   - image size
   - the `manifest ID`, that you can copy to the clipboard.
   ```

7. ​						复制 `清单 ID` 值以构建您要嵌入容器的镜像。 				

**其他资源**

- ​						[Quay.io - 使用标签](https://access.redhat.com/documentation/zh-cn/red_hat_quay/3.4/html/use_red_hat_quay/working_with_tags)。 				

## 9.4. 构建镜像并将容器提取到镜像中

​				创建容器镜像后，您可以构建自定义镜像并将容器镜像提取到其中。为此，您必须在蓝图中指定 **容器自定义**，以及最终镜像的 **容器名称**。在构建过程中，会获取容器镜像，并放置在本地 Podman 容器存储中。 		

**前提条件**

- ​						您创建了容器镜像并将其推送到本地 `quay.io` 容器 registry 实例。 				

- ​						您可以访问 [registry.access.redhat.com](https://access.redhat.com/terms-based-registry/#/)。 				

- ​						您有一个容器 `清单 ID`。 				

- ​						已安装 `qemu-kvm` 和 `qemu-img` 软件包。要安装它，请运行以下命令： 				

  

  ```none
  # yum install qemu-kvm qemu-img
  ```

**流程**

1. ​						创建蓝图来构建 `qcow2` 镜像。蓝图必须包含  自定义。 				

   

   ```none
   name = "image"
   description = "A qcow2 image with a container"
   version = "0.0.1"
   distro = "rhel-90"
   
   [[packages]]
   name = "podman"
   version = "*"
   
   [[containers]]
   source = "registry.access.redhat.com/ubi9:8080/osbuild/container/container-image@sha256:manifest-ID-from-Repository-tag: tag-version"
   name =  "source-name"
   tls-verify = true
   ```

2. ​						推送蓝图： 				

   

   ```none
   # composer-cli blueprints push blueprint-image.toml
   ```

3. ​						构建容器镜像： 				

   

   ```none
   # composer-cli start compose image qcow2
   ```

   ​						其中： 				

   - ​								*image* 是蓝图名称。 						

   - ​								`qcow2` 是镜像类型。 						

     注意

     ​									构建镜像需要一些时间，因为它将检查 `quay.io` registry 上的容器。 							

     ​								镜像构建状态变为 "FINISHED" 后，您可以使用您在虚拟机中创建的 `qcow2` 镜像。 						

**验证**

1. ​						将 `.qcow2` 镜像从 `composer-cli` 拉取到本地文件系统： 				

   

   ```none
   # composer-cli compose image COMPOSE-UUID
   ```

2. ​						在虚拟机中启动 `qcow2` 镜像。请参阅[从 KVM 客户机镜像创建虚拟机](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html-single/composing_a_customized_rhel_system_image/index#creating-a-virtual-machine-from-a-kvm-guest-image_preparing-and-deploying-kvm-guest-images-with-image-builder)。 				

3. ​						`qemu` 向导将打开。登录到 `qcow2` 镜像。 				

   1. ​								输入用户名和密码。这些可以是您在 "customizations.user" 部分的 `.qcow2` 蓝图中设置的用户名和密码，或是在引导时使用 `cloud-init` 创建的。 						

4. ​						运行容器镜像，并在容器内打开 shell 提示符： 				

   

   ```none
   # podman run -it registry.access.redhat.com/ubi9:8080/osbuild/repository /bin/bash/
   ```

   ​						其中： 				

   - ​								`registry.access.redhat.com` 是目标 registry，`osbuild` 是机构，`repository` 则是在完成构建时推送容器的位置。 						

5. ​						检查您添加到蓝图中的软件包是否可用： 				

   

   ```none
   # type -a nginx
   ```

   ​						输出显示 `nginx` 软件包路径。 				

**其他资源**

- ​						[红帽容器 Registry 身份验证](https://access.redhat.com/RegistryAuthentication). 				
- ​						[访问和配置红帽 Registry](https://access.redhat.com/documentation/zh-cn/openshift_container_platform/3.11/html/configuring_clusters/install-config-configuring-red-hat-registry)。 				
- ​						[基本 Podman 命令](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux_atomic_host/7/html/managing_containers/finding_running_and_building_containers_with_podman_skopeo_and_buildah)。 				
- ​						[在容器中运行 Skopeo](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html-single/building_running_and_managing_containers/index#proc_running-skopeo-in-a-container_assembly_running-skopeo-buildah-and-podman-in-a-container)。 				

# 第 10 章 使用镜像构建器准备并上传云镜像

​			镜像构建器可以创建自定义系统镜像，以便在各种云平台上使用。要在云中使用自定义的 RHEL 系统镜像，请使用镜像构建器使用相应的输出类型创建系统镜像，配置您的系统以上传镜像，并将镜像上传到您的云帐户。您可以通过 RHEL web 控制台中的 `镜像构建器应用程序` 推送自定义镜像云，其可用于我们支持的服务提供商的子集，如 **AWS** 和 **Microsoft Azure** 云。请参阅 [将镜像推送到 AWS Cloud AMI](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#pushing-ami-images-to-aws-cloud_creating-cloud-images-with-composer) 和 [将 VHD 镜像推送到 Microsoft Azure 云](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#pushing-vhd-imaged-to-azure-cloud_creating-cloud-images-with-composer)。 	

## 10.1. 准备上传 AWS AMI 镜像

​				在上传 AWS AMI 镜像前，您必须配置系统来上传镜像。 		

**前提条件**

- ​						您必须在 [AWS IAM account manager](https://aws.amazon.com/iam/) 中配置了一个 Access Key ID。 				
- ​						您必须具有一个可写的 [S3 存储桶](https://docs.aws.amazon.com/AmazonS3/latest/gsg/CreatingABucket.html)。 				

**流程**

1. ​						安装 Python 3 和 `pip` 工具： 				

   

   ```none
   # dnf install python3
   # dnf install python3-pip
   ```

2. ​						使用 `pip` 安装 [AWS 命令行工具](https://aws.amazon.com/cli/) ： 				

   

   ```none
   # pip3 install awscli
   ```

3. ​						运行以下命令设定您的配置集。终端提示您提供凭证、地区和输出格式： 				

   

   ```none
   $ aws configure
   AWS Access Key ID [None]:
   AWS Secret Access Key [None]:
   Default region name [None]:
   Default output format [None]:
   ```

4. ​						为存储桶定义名称，并使用以下命令创建存储桶： 				

   

   ```none
   $ BUCKET=bucketname
   $ aws s3 mb s3://$BUCKET
   ```

   ​						使用实际存储桶名称替换 *bucketname*。它必须是全局唯一的名称。因此，您的存储桶会被创建。 				

5. ​						要授予访问 S3 存储桶的权限，如果您还没有这样做，请在 AWS Identity and Access Management (IAM) 中创建一个 `vmimport` S3 角色： 				

   

   ```none
   $ printf '{ "Version": "2012-10-17", "Statement": [ { "Effect": "Allow", "Principal": { "Service": "vmie.amazonaws.com" }, "Action": "sts:AssumeRole", "Condition": { "StringEquals":{ "sts:Externalid": "vmimport" } } } ] }' > trust-policy.json
   $ printf '{ "Version":"2012-10-17", "Statement":[ { "Effect":"Allow", "Action":[ "s3:GetBucketLocation", "s3:GetObject", "s3:ListBucket" ], "Resource":[ "arn:aws:s3:::%s", "arn:aws:s3:::%s/*" ] }, { "Effect":"Allow", "Action":[ "ec2:ModifySnapshotAttribute", "ec2:CopySnapshot", "ec2:RegisterImage", "ec2:Describe*" ], "Resource":"*" } ] }' $BUCKET $BUCKET > role-policy.json
   $ aws iam create-role --role-name vmimport --assume-role-policy-document file://trust-policy.json
   $ aws iam put-role-policy --role-name vmimport --policy-name vmimport --policy-document file://role-policy.json
   ```

**其他资源**

- ​						[使用 AWS CLI 中的高级(s3)命令](https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-commands.html) 				

## 10.2. 使用 CLI 将 AMI 镜像上传到 AWS

​				您可以使用镜像构建器构建 `ami` 镜像，并使用 CLI 将它们直接推送到 Amazon AWS Cloud 服务提供商。 		

**前提条件**

- ​						您已在 [AWS IAM](https://aws.amazon.com/iam/) 账号管理器中配置了一个 `Access Key ID`。 				
- ​						您已准备好了一个可写的 [S3 存储桶](https://aws.amazon.com/s3/)。 				
- ​						您有一个定义的蓝图。 				

**流程**

1. ​						使用文本编辑器，使用以下内容创建配置文件： 				

   

   ```none
   provider = "aws"
   
   [settings]
   accessKeyID = "AWS_ACCESS_KEY_ID"
   secretAccessKey = "AWS_SECRET_ACCESS_KEY"
   bucket = "AWS_BUCKET"
   region = "AWS_REGION"
   key = "IMAGE_KEY"
   ```

   ​						将字段中的值替换为您的 `accessKeyID`、`secretAccessKey`、`bucket` 和 `region` 的凭证。`IMAGE_KEY` 值是要上传到 EC2 的虚拟机镜像的名称。 				

2. ​						将文件保存为 *CONFIGURATION-FILE*.toml，然后关闭文本编辑器。 				

3. ​						启动 compose： 				

   

   ```none
   # composer-cli compose start BLUEPRINT-NAME IMAGE-TYPE IMAGE_KEY CONFIGURATION-FILE.toml
   ```

   ​						替换： 				

   - ​								将 *BLUEPRINT-NAME* 替换为您创建的蓝图名称 						

   - ​								将 *IMAGE-TYPE* 替换为 `ami` 镜像类型。 						

   - ​								将 *IMAGE_KEY* 替换为要上传到 EC2 的虚拟机镜像的名称。 						

   - ​								将 *CONFIGURATION-FILE*.toml 替换为云供应商的配置文件的名称。 						

     注意

     ​									对于要将自定义镜像发送到的存储桶，您必须拥有正确的 IAM 设置。在将镜像上传到存储桶前，您必须对存储桶设置策略。 							

4. ​						检查镜像构建的状态，并将其上传到 AWS： 				

   

   ```none
   # composer-cli compose status
   ```

   ​						完成镜像上传过程后，您可以看到"FINISHED"状态。 				

**验证**

​					要确认镜像上传成功： 			

1. ​						访问菜单中的 [EC2](https://us-east-2.console.aws.amazon.com/ec2/v2/home?region=us-east-2#Images:sort=name)，并在 AWS 控制台中选择正确的区域。镜像必须具有 `available` 状态，以指示它已被成功上传。 				
2. ​						在控制面板中，选择您的镜像并点 `Launch`。 				

**其它资源**

- ​						[导入虚拟机所需的服务角色](https://docs.aws.amazon.com/vm-import/latest/userguide/vmie_prereqs.html#vmimport-role) 				

## 10.3. 将镜像推送到 AWS Cloud AMI

​				您可以将您创建的输出镜像推送到 **Amazon AWS Cloud AMI** 服务供应商。 		

**前提条件**

- ​						您必须有访问系统的 `root` 或 `wheel` 组用户权限。 				
- ​						您已在浏览器中打开了 RHEL web 控制台的镜像构建器界面。 				
- ​						您已创建了一个蓝图。请参阅[在 web 控制台界面中创建镜像构建程序蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-web-console-interface_composing-a-customized-rhel-system-image#creating-a-composer-blueprint-in-the-web-console-interface_creating-system-images-with-composer-web-console-interface)。 				
- ​						您必须在 [AWS IAM account manager](https://aws.amazon.com/iam/) 中配置了一个 Access Key ID。 				
- ​						您必须具有一个可写的 [S3 存储桶](https://aws.amazon.com/s3/)。 				

**流程**

1. ​						点**蓝图名称**。 				

2. ​						选择选项卡 Images。 				

3. ​						单击 Create Image 来创建自定义镜像。 				

   ​						此时会打开弹出窗口。 				

   1. ​								在 **Type** 下拉菜单中选择 `Amazon Machine Image Disk (.raw)`。 						

   2. ​								选中 **"Upload to AWS"** 复选框，将您的镜像上传到 AWS 云,并点击 Next。 						

   3. ​								要验证您是否可以访问 AWS ，请在对应的字段中输入您的`"AWS access key ID"`和`"AWS secret access key"`。点 Next。 						

      注意

      ​									您只能在创建新 Access Key ID 时查看 AWS secret access key 。如果您不知道您的 Secret Key，请生成一个新的 Access Key ID。 							

   4. ​								在 `Image name` 字段中输入镜像名称，在 `Amazon S3 bucket name` 字段中输入 Amazon bucket 名称，并为您要添加自定义镜像的存储桶输入 `AWS region` 字段。点 Next。 						

   5. ​								查看信息并点 Finish。 						

      ​								（可选）您可以点击 Back 来修改任何不正确的详情。 						

      注意

      ​									您必须具有要发送自定义镜像的存储桶的正确 IAM 设置。此流程使用 IAM 导入和导出，因此您必须在将镜像上传到存储桶前为存储桶设置 **策略**。如需更多信息，请参阅 [IAM 用户所需的权限](https://docs.aws.amazon.com/vm-import/latest/userguide/vmie_prereqs.html#iam-permissions-image)。 							

4. ​						右上角的一个小弹出会通知您保存的进度。它还告知镜像创建过程、创建此镜像的过程以及后续的上传到 AWS Cloud。 				

   ​						完成这个过程后，您可以看到 **镜像构建完成**状态。 				

5. ​						点菜单中的 [Service→EC2](https://us-east-2.console.aws.amazon.com/ec2/v2/home?region=us-east-2#Images:sort=name)，然后在 AWS 控制台中选择 [正确的区域](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-regions)。镜像必须具有 `Available` 状态，以指示它已被上传。 				

6. ​						在控制面板中，选择您的镜像并点 `Launch`。 				

7. ​						此时会打开一个新窗口。根据启动镜像所需的资源选择实例类型。点 Review and `Launch`。 				

8. ​						查看您的实例启动详情。如果需要进行任何更改，您可以编辑任何部分。点 `Launch` 				

9. ​						在启动实例之前，选择一个访问它的公钥。 				

   ​						您可以使用您已有的密钥对，也可以创建一个新的密钥对。或者，您可以使用 `镜像构建器` 使用预设置的公钥将用户添加到镜像。如需了解更多详细信息，请参阅[使用 SSH 密钥创建用户帐户](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-web-console-interface_composing-a-customized-rhel-system-image#creating-a-user-account-with-ssh-key_creating-system-images-with-composer-web-console-interface)。 				

   ​						按照以下步骤在 EC2 中创建新的密钥对，并将它连接到新实例。 				

   1. ​								在下拉菜单中选择 **"Create a new key pair"**。 						
   2. ​								输入新密钥对名称。它生成一个新的密钥对。 						
   3. ​								点 **"下载密钥对"** 在您的本地系统中保存新密钥对。 						

10. ​						然后，您可以点 `Launch Instance` 来启动您的实例。 				

    ​						您可以检查实例的状态，它显示为 **Initializing**。 				

11. ​						实例状态变为 **running** 后，连接按钮将变为可用。 				

12. ​						点 连接。此时会出现一个弹出窗口，其中包含有关如何使用 SSH 连接的说明。 				

    1. ​								选择 **A standalone SSH client** 作为首选连接方法并打开终端。 						

    2. ​								在您存储私钥的位置，确保您的密钥是公开可见的，以便 SSH 可以正常工作。要做到这一点，请运行以下命令： 						

       

       ```none
       $ chmod 400 <your-instance-name.pem>_
       ```

    3. ​								使用其公共 DNS 连接到您的实例： 						

       

       ```none
       $ ssh -i "<_your-instance-name.pem_"> ec2-user@<_your-instance-IP-address_>
       ```

    4. ​								键入 `yes` 以确认您要继续连接。 						

       ​								因此，您使用 SSH 连接到实例。 						

**验证**

1. ​						检查在使用 SSH 连接到实例后您是否能够执行任何操作。 				

**其他资源**

- ​						[在红帽客户门户网站中创建一个问题单](https://access.redhat.com/support/cases/#/case/new/open-case?intcmp=hp|a|a3|case&caseCreate=true) 				
- ​						[使用 SSH 连接到您的 Linux 实例](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html) 				
- ​						[创建支持问题单](https://console.aws.amazon.com/support/home?region=us-east-2#/) 				

## 10.4. 准备上传 Microsoft Azure VHD 镜像

​				您可以使用镜像构建器准备可上传到 `Microsoft Azure` 云的 VHD 镜像。 		

**前提条件**

- ​						您必须具有可用的 Microsoft Azure 资源组和存储帐户。 				
- ​						已安装 python2，因为 `AZ CLI` 工具依赖于 python 2.7。 				

**流程**

1. ​						导入 Microsoft 存储库密钥： 				

   

   ```none
   # rpm --import https://packages.microsoft.com/keys/microsoft.asc
   ```

2. ​						创建本地的 `azure-cli` 存储库信息： 				

   

   ```none
   # sh -c 'echo -e "[azure-cli]\nname=Azure CLI\nbaseurl=https://packages.microsoft.com/yumrepos/azure-cli\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/azure-cli.repo'
   ```

3. ​						安装 Microsoft Azure CLI： 				

   

   ```none
   # dnfdownloader azure-cli
   # rpm -ivh --nodeps azure-cli-2.0.64-1.el7.x86_64.rpm
   ```

   注意

   ​							下载的 Microsoft Azure CLI 软件包版本可能会因当前可用的版本而异。 					

4. ​						运行 Microsoft Azure CLI： 				

   

   ```none
   $ az login
   ```

   ​						终端会显示以下信息 `Note, we have launched a browser for you to login.For old experience with device code, use "az login --use-device-code`.然后，终端会打开浏览器，其中包含可从其登录 https://microsoft.com/devicelogin 的链接。 				

   注意

   ​							如果您正在运行远程(SSH)会话 [，https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) 链接不会在浏览器中打开。在这种情况下，您可以将链接复制到浏览器，并登录以验证您的远程会话。要登录，使用网页浏览器打开页面 https://microsoft.com/devicelogin 并输入要进行身份验证的设备代码。 					

5. ​						列出 Microsoft Azure 中存储帐户的密钥： 				

   

   ```none
   $ GROUP=resource-group-name
   $ ACCOUNT=storage-account-name
   $ az storage account keys list --resource-group $GROUP --account-name $ACCOUNT
   ```

   ​						将 *resource-group-name* 替换为 Microsoft Azure 资源组的名称，将 *storage-account-name* 替换为 Microsoft Azure 存储帐户的名称。 				

   注意

   ​							您可以使用以下命令列出可用资源： 					

   

   ```none
   $ az resource list
   ```

6. ​						记录上一个命令输出中的 `key1` 值，并将其分配给环境变量： 				

   

   ```none
   $ KEY1=value
   ```

7. ​						创建存储容器： 				

   

   ```none
   $ CONTAINER=storage-account-name
   $ az storage container create --account-name $ACCOUNT \
   --account-key $KEY1 --name $CONTAINER
   ```

   ​						将 *storage-account-name* 替换为存储帐户的名称。 				

**其他资源**

- ​						[Microsoft Azure CLI。](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-yum?view=azure-cli-latest) 				

## 10.5. 将 VHD 镜像上传到 Microsoft Azure 云

​				创建了自定义的 VHD 镜像后，您可以将其上传到 Microsoft Azure 云。 		

**前提条件**

- ​						必须为上传 Microsoft Azure VHD 镜像建立您的系统。请参阅 [准备上传 Microsoft Azure VHD 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#preparing-for-uploading-azue-vhd-images_creating-cloud-images-with-composer)。 				

- ​						您必须有一个由镜像构建器创建的 Microsoft Azure VHD 镜像。 				

  - ​								在 CLI 中，使用 `vhd` 输出类型。 						

  - ​								在 GUI 中，使用 `Azure Disk Image (.vhd)` 镜像类型。 						

    注意

    ​									使用 CLI 创建 `.vhd` 镜像时，镜像构建器会将临时文件写入 `/var` 子目录。要防止 `.vhd` 镜像创建失败，请将 `/var` 子目录容量增加到至少 15 到 20 GB 的可用空间，以确保可用性。 							

**流程**

1. ​						将镜像推送到 Microsoft Azure 并从中创建一个实例： 				

   

   ```none
   $ VHD=25ccb8dd-3872-477f-9e3d-c2970cd4bbaf-disk.vhd
   $ az storage blob upload --account-name $ACCOUNT --container-name $CONTAINER --file $VHD --name $VHD --type page
   ...
   ```

2. ​						上传到 Microsoft Azure Blob 存储后，会从中创建一个 Microsoft Azure 镜像： 				

   

   ```none
   $ az image create --resource-group $GROUP --name $VHD --os-type linux --location eastus --source https://$ACCOUNT.blob.core.windows.net/$CONTAINER/$VHD
    - Running ...
   ```

**验证**

1. ​						使用 Microsoft Azure 门户创建实例，或者使用以下命令： 				

   

   ```none
   $ az vm create --resource-group $GROUP --location eastus --name $VHD --image $VHD --admin-username azure-user --generate-ssh-keys
    - Running ...
   ```

2. ​						通过 SSH 使用您的私钥访问生成的实例。以 `azure-user` 用户身份登录。 				

**其它资源**

- ​						[生成 `.vhd` 格式的镜像失败。](https://access.redhat.com/solutions/6955577) 				

## 10.6. 上传 VMDK 镜像并在 vSphere 中创建 RHEL 虚拟机

​				使用 `govc import.vmdk` CLI 工具将 .vmdk 镜像上传到 VMware vSphere。 		

注意

​					不支持通过 UI 上传镜像。 			

**前提条件**

- ​						已使用用户名和密码自定义创建了蓝图。 				

- ​						您使用镜像构建器创建了一个 `.vmdk` 镜像，并将其下载到主机系统。 				

- ​						您已安装了 `govc import.vmdk` CLI 工具。 				

- ​						您已配置了 `govc import.vmdk` CLI 工具客户端。 				

  - ​								您必须在环境中设置以下值： 						

    

    ```none
    GOVC_URL
    GOVC_DATACENTER
    GOVC_FOLDER
    GOVC_DATASTORE
    GOVC_RESOURCE_POOL
    GOVC_NETWORK
    ```

**流程**

1. ​						导航到您下载 `.vmdk` 镜像的目录。 				

2. ​						按照以下步骤在 vSphere 上启动镜像： 				

   1. ​								将 `.vmdk` 镜像导入到 vSphere ： 						

      

      ```none
      $ govc import.vmdk ./composer-api.vmdk foldername
      ```

   2. ​								在 VSphere 中创建虚拟机而不开机： 						

      

      ```none
      govc vm.create \
      -net.adapter=vmxnet3 \
      -m=4096 -c=2 -g=rhel8_64Guest \
      -firmware=efi -disk=”foldername/composer-api.vmdk” \
      -disk.controller=scsi -on=false \
       vmname
      ```

   3. ​								打开虚拟机： 						

      

      ```none
      govc vm.power -on vmname
      ```

   4. ​								检索虚拟机 IP 地址： 						

      

      ```none
      HOST=$(govc vm.ip vmname)
      ```

   5. ​								使用您在蓝图中指定的用户名和密码，使用 SSH 登录到虚拟机： 						

      

      ```none
      $ ssh admin@HOST
      ```

      注意

      ​									如果您使用 `govc datastore.upload` 命令将 `.vmdk` 镜像从本地主机复制到目的地，则不支持使用该镜像。在 vSphere GUI 中没有使用 `import.vmdk` 命令的选项，vSphere GUI 不支持直接上传，因此 `.vmdk` 镜像不能直接从 vSphere GUI 使用。 							

## 10.7. 使用镜像构建器将镜像上传到 GCP

​				使用镜像构建器，您可以构建 `gce` 镜像，为用户或 GCP 服务帐户提供凭证，然后将 `gce` 镜像直接上传到 GCP 环境。 		

### 10.7.1. 使用 CLI 将 gce 镜像上传到 GCP

​					按照以下步骤使用凭证设置配置文件，将 `gce` 镜像上传到 GCP。 			

**前提条件**

- ​							有用户或服务帐户 Google 凭证，以便将镜像上传到 GCP。与凭证关联的帐户必须至少分配以下 IAM 角色： 					
  - ​									`roles/storage.admin` - 用于创建和删除存储对象 							
  - ​									`roles/compute.storageAdmin` - 将虚拟机镜像导入到 Compute Engine。 							
- ​							您有一个现有的 GCP 存储桶。 					

**流程**

1. ​							使用文本编辑器，创建包含以下内容的 `gcp-config.toml` 配置文件： 					

   

   ```none
   provider = "gcp"
   
   [settings]
   bucket = "GCP_BUCKET"
   region = "GCP_STORAGE_REGION"
   object = "OBJECT_KEY"
   credentials = "GCP_CREDENTIALS"
   ```

   ​							其中： 					

   - ​									`GCP_BUCKET` 指向现有的存储桶。它用于存储正在上传的镜像的中间存储对象。 							

   - ​									`GCP_STORAGE_REGION` 是常规的 Google 存储区域，是一个双区域或多区域。 							

   - ​									`OBJECT_KEY` 是中间存储对象的名称。它在上传过程前不能存在，并在上传过程完成后被删除。如果对象名称不以 `.tar.gz` 结尾，则扩展会自动添加到对象名称中。 							

   - ​									`GCP_CREDENTIALS` 是一个从 GCP 下载的凭证 JSON 文件的 Base64 编码方案。凭证决定了 GCP 将镜像上传到的项目。 							

     注意

     ​										如果您使用不同的 GCP 机制与 GCP 进行身份验证，在 `gcp-config.toml` 中指定 `GCP_CREDENTIALS` 是可选的。如需有关使用 GCP 验证的不同方法的更多详情，请参阅[使用 GCP 进行身份验证](https://www.osbuild.org/guides/user-guide/uploading-to-gcp.html#authenticating-with-gcp)。 								

2. ​							使用附加镜像名称和云供应商配置集创建 compose： 					

   

   ```none
   $ sudo composer-cli compose start BLUEPRINT-NAME gce IMAGE_KEY gcp-config.toml
   ```

   ​							备注：镜像构建、上传和云注册过程最多可能需要十分钟才能完成。 					

**验证**

- ​							验证镜像状态为 FINISHED： 					

  

  ```none
  $ sudo composer-cli compose status
  ```

**其他资源**

- ​							[身份和访问权限管理](https://cloud.google.com/storage/docs/access-control/iam)。 					
- ​							[创建存储存储桶](https://cloud.google.com/storage/docs/creating-buckets)。 					

### 10.7.2. 使用 GCP 进行身份验证

​					您可以将几种不同类型的凭证与镜像构建器一起使用来通过 GCP 进行身份验证。如果镜像构建器配置被设置为使用多个凭证集合通过 GCP 进行身份验证，它会按以下首选顺序使用凭证： 			

1. ​							在配置文件中，使用 `composer-cli` 命令指定的凭证。 					

2. ​							凭证在 `osbuild-composer` worker 配置中被配置。 					

3. ​							`Google GCP SDK` 库中的应用程序默认凭证，它尝试使用以下选项自动找到身份验证的方法： 					

   1. ​									如果设置了 *GOOGLE_APPLICATION_CREDENTIALS* 环境变量，应用程序默认凭据会尝试加载并从文件中使用由变量指向的凭证。 							

   2. ​									应用默认凭据尝试使用附加到运行代码的资源的服务帐户进行身份验证。例如，Google Compute Engine 虚拟机。 							

      注意

      ​										您必须使用 GCP 凭证来决定将镜像上传到的 GCP 项目。因此，除非要将所有镜像上传到同一 GCP 项目，您必须使用 `composer-cli` 命令指定 `gcp-config.toml` 配置文件中的凭证。 								

#### 10.7.2.1. 使用 composer-cli 命令指定凭证

​						您可以在提供的上传目标配置 `gcp-config.toml` 中指定 GCP 验证凭证。使用 Google 帐户凭证 JSON 文件的 `Base64` 编码方案来节省时间。 				

**流程**

- ​								在提供的上传目标配置 `gcp-config.toml` 中，设置凭证： 						

  

  ```none
  provider = "gcp"
  
  [settings]
  provider = "gcp"
  
  [settings]
  ...
  credentials = "GCP_CREDENTIALS"
  ```

- ​								要获得 Google 帐户凭证文件的编码内容，且路径保存在 `GOOGLE_APPLICATION_CREDENTIALS` 环境变量中，请运行以下命令： 						

  

  ```none
  $ base64 -w 0 "${GOOGLE_APPLICATION_CREDENTIALS}"
  ```

#### 10.7.2.2. 在 osbuild-composer worker 配置中指定凭证

​						您可以将 GCP 身份验证凭据配置为全局用于 GCP 用于所有镜像构建。这样，如果您想要将镜像导入到同一 GCP 项目，则您可以对上传到 GCP 的所有镜像使用相同的凭据。 				

**流程**

- ​								在 `/etc/osbuild-worker/osbuild-worker.toml` worker 配置中，设置以下凭证值： 						

  

  ```none
  [gcp]
  credentials = "PATH_TO_GCP_ACCOUNT_CREDENTIALS"
  ```

## 10.8. 使用 GUI 镜像构建器工具将 VMDK 镜像推送到 vSphere

​				您可以使用 GUI 镜像构建器工具构建 VMware 镜像，并将镜像直接推送到 vSphere 实例，以避免下载镜像文件并手动推送它。要使用镜像构建器直接向 vSphere 实例服务提供商创建 `.vmdk` 镜像，请按照以下步骤执行： 		

**前提条件**

- ​						您有可以访问系统的 `root` 或 `wheel` 组用户权限。 				
- ​						您已在浏览器中打开了 RHEL web 控制台的 [镜像构建器](http://localhost:9090/) 界面。 				
- ​						您已创建了蓝图。请参阅[在 web 控制台界面中创建镜像构建程序蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-web-console-interface_composing-a-customized-rhel-system-image#creating-a-composer-blueprint-in-the-web-console-interface_creating-system-images-with-composer-web-console-interface)。 				
- ​						您有 [vSphere 帐户](https://my.vmware.com/web/vmware/login)。 				

**流程**

1. ​						对于您创建的蓝图，点 Images 选项卡。 				

2. ​						单击 Create Image 来创建自定义镜像。 				

   ​						此时将打开镜像类型窗口。 				

3. ​						在 **Image type** 窗口中： 				

   1. ​								从下拉菜单中，选择 Type:VMware VSphere(.vmdk)。 						
   2. ​								选中 **Upload to VMware** 复选框，来将镜像上传到 vSphere。 						
   3. ​								可选：设置您要实例化的镜像的大小。最小的默认大小为 2GB。 						
   4. ​								点 Next。 						

4. ​						在 **Upload to VMware** 窗口中，在 **Authentication** 下输入以下详情： 				

   1. ​								**用户名** ：vSphere 帐户的用户名。 						
   2. ​								**Password** ：vSphere 帐户的密码。 						

5. ​						在 **Upload to VMware** 窗口中，在 **Destination** 下输入以下详情： 				

   1. ​								**Image name**：要上传的镜像的名称。 						
   2. ​								**主机** ：上传镜像的 VMware vSphere 的 URL。 						
   3. ​								**集群** ：上传镜像的集群名称。 						
   4. ​								**数据中心** ：上传镜像的数据中心的名称。 						
   5. ​								**Data store** ：镜像将要上传到的数据存储的名称。 						
   6. ​								点 **Next**。 						

6. ​						在 **Review** 窗口中，查看镜像创建的详情并点 Finish。 				

   ​						您可以点击 Back 来修改任何不正确的详情。 				

   ​						镜像构建器将 RHEL vSphere 镜像的组成添加到队列，创建镜像并将其上传到您指定的 vSphere 实例上的集群。 				

   注意

   ​							镜像构建和上传过程需要几分钟时间才能完成。 					

   ​						完成这个过程后，您可以看到 **镜像构建完成**状态。 				

**验证**

​					成功完成镜像上传后，您可以从上传的镜像创建虚拟机(VM)，并登录到虚拟机。要做到这一点： 			

1. ​						访问 VMware vSphere 客户端。 				

2. ​						在您指定的 vSphere 实例上的集群中搜索镜像。 				

3. ​						您可以从上传的镜像创建一个新虚拟机： 				

   1. ​								选择您上传的镜像。 						

   2. ​								右键点所选镜像。 						

   3. ​								点 `New Virtual Machine`。 						

      ​								此时 **New Virtual Machine** 窗口打开。 						

      ​								**New Virtual Machine** 窗口中提供了以下详情： 						

      1. ​										选择 `New Virtual Machine`。 								
      2. ​										为您的虚拟机选择一个名称和文件夹。 								
      3. ​										选择计算资源：为此操作选择一个目标计算资源。 								
      4. ​										选择存储：例如，选择 NFS-Node1 								
      5. ​										选择兼容性：该镜像应仅为 BIOS。 								
      6. ​										选择客户端操作系统：例如，选择 *Linux* 和 *Red Hat Fedora (64 位)。* 								
      7. ​										**自定义硬件** ：创建虚拟机时，在右上角的 **Device Configuration** 按钮，删除默认的 New Hard Disk，并使用下拉菜单来选择 Existing Hard Disk 磁盘镜像： 								
      8. ​										准备完成：查看详情并点 **Finish** 创建镜像。 								

   4. ​								导航至 **VMs** 选项卡。 						

      1. ​										从列表中选择您创建的虚拟机。 								

      2. ​										单击面板上的 **Start** 按钮。此时会显示一个新窗口，显示正在加载 VM 镜像。 								

      3. ​										使用您为蓝图创建的凭证登录。 								

      4. ​										您可以验证添加到蓝图中的软件包是否已安装。例如： 								

         

         ```none
         $ rpm -qa | grep firefox
         ```

**其他资源**

- ​						[安装 vSphere 客户端](https://docs.vmware.com/en/VMware-vSphere/5.5/com.vmware.vsphere.hostclient.doc/GUID-DE4F3DF7-F2C3-4679-B096-A8DE255CA0AD.html)。 				

## 10.9. 使用 GUI 镜像构建器工具将 VHD 镜像推送到 Microsoft Azure 云

​				您可以使用镜像构建器创建 `.vhd` 镜像。然后，您可以将 `.vhd` 镜像推送到 Microsoft Azure Cloud 服务供应商的 Blob 存储。 		

**前提条件**

- ​						有对系统的 root 访问权限。 				
- ​						您已在浏览器中打开了 RHEL web 控制台的镜像构建器界面。 				
- ​						您创建了蓝图。请参阅[在 web 控制台界面中创建镜像构建程序蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-web-console-interface_composing-a-customized-rhel-system-image#creating-a-composer-blueprint-in-the-web-console-interface_creating-system-images-with-composer-web-console-interface)。 				
- ​						您已创建了 [Microsoft 存储帐户](https://portal.azure.com/#create/Microsoft.StorageAccount)。 				
- ​						您有一个可写入 [Blob Storage](https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Storage%2FStorageAccounts)。 				

**流程**

1. ​						对于 `蓝图名称`，点 Images 选项卡。 				

2. ​						单击 Create Image 来创建自定义镜像。 				

   ​						此时会打开弹出窗口。 				

   1. ​								在 **Type** 下拉菜单中选择 `Azure Disk Image (.vhd)` 镜像。 						

   2. ​								选中 **Upload to Microsoft Azure** 复选框，以将您的镜像上传到 Microsoft Azure Cloud，然后点 Next。 						

   3. ​								要验证您是否可以访问 Microsoft Azure，请在相应的字段中输入您的"存储帐户"和"存储访问密钥"。点 Next。 						

      ​								您可以在 Settings→Access Key 菜单列表中找到您的 [Microsoft Storage 帐户详情](https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json&tabs=azure-portal)。 						

   4. ​								键入要用于上传的镜像文件的 **"Image name"** ，以及您要将镜像推送到的 Blob "存储容器"。点 Next。 						

   5. ​								查看您提供的信息，然后点 Finish。 						

      ​								（可选）您可以点击 Back 来修改任何不正确的详情。 						

3. ​						当镜像创建过程启动时，右上角会显示一个小的弹出窗口，其中包含以下信息：`镜像创建已添加到队列`。 				

   ​						镜像创建完成后，点您从其创建镜像的蓝图。在 `Images` 选项卡中，您可以看到您创建的镜像的**镜像构建完成**状态。 				

4. ​						要访问推送到 **Microsoft Azure Cloud** 的镜像，请访问 [**Microsoft Azure 门户网站**](https://portal.azure.com)。 				

5. ​						在搜索栏中，输入 **Images** ，并选择 **Services** 下的第一项。您将被重定向到 **镜像仪表盘**。 				

6. ​						点 +Add。您将被重定向到 **Create a Image** 仪表盘。 				

   ​						插入以下详情： 				

   1. ​								**Name**:为您的新镜像选择一个名称。 						

   2. ​								**资源组** ：选择一个**资源组**。 						

   3. ​								**位置** ：选择与分配给您的存储帐户的区域匹配的**位置**。否则您将无法选择 blob。 						

   4. ​								`操作系统类型` ：将操作系统类型设置为 **Linux**。 						

   5. ​								**虚拟机生成** ：在 **Gen 1** 上保留虚拟机生成集。 						

   6. ​								**Storage Blob**:点 **Storage blob input** 右面的 **Browse**。使用对话框查找您之前上传的镜像。 						

      ​								将剩余的字段保留为默认值。 						

7. ​						点 Create 来创建镜像。创建镜像后，您可以看到右上角的 **Successfully created image** 信息。 				

8. ​						点 Refresh 查看新创建的镜像并打开它。 				

9. ​						点 + Create VM。您将被重定向到 **Create a virtual machine** 仪表盘。 				

10. ​						在 `Basic` 选项卡中，在 `Project Details` 下，您的`订阅`和`资源组`已预先设置。 				

    ​						如果要创建一个新的 `资源组`： 				

    1. ​								点 Create new。 						

       ​								弹出提示您创建 **Resource Group Name** 容器。 						

    2. ​								插入名称并单击 OK。 						

       ​								如果要保留已预设置的**资源组** ： 						

11. ​						在 **Instance Details** 下输入： 				

    1. ​								**Virtual machine name** 						

    2. ​								**区域** 						

    3. ​								**镜像** ：您创建的镜像默认是预先选择的镜像。 						

    4. ​								**大小** ：选择最适合您的需求的虚拟机大小。 						

       ​								剩余的字段保留默认值。 						

12. ​						在 **Administrator account** 下输入以下详情： 				

    1. ​								**Username** ：帐户管理员的名称。 						

    2. ​								**SSH public key source** ：从下拉菜单中选择 **Generate new key pair**。 						

       ​								您可以使用您已有的密钥对，也可以创建一个新的密钥对。或者，您可以使用 `镜像构建器` 使用预设置的公钥将用户添加到镜像。如需了解更多详细信息，请参阅[创建带有 SSH 密钥的用户帐户](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/securing_networks/assembly_using-secure-communications-between-two-systems-with-openssh_securing-networks#generating-ssh-key-pairs_assembly_using-secure-communications-between-two-systems-with-openssh)。 						

    3. ​								**Key pair name** ：插入密钥对的名称。 						

13. ​						在 **Inbound port rules** 下，为每个字段选择值： 				

    1. ​								**公共入站端口** ：**允许所选端口**。 						
    2. ​								**选择入站端口** ：使用默认设置 **SSH(22)**。 						

14. ​						点击 **Review + Create**。您将被重定向到 **Review + create** 选项卡，并收到验证通过的确认信息。 				

15. ​						检查详情并点击 Create。 				

    ​						（可选）您可以点击 Previous 来修复之前选择的选项。 				

16. ​						此时会打开**生成新密钥对**窗口。点 **Download private key and create resources**。 				

    ​						将密钥文件保存为 "*yourKey*.pem"。 				

17. ​						部署完成后，点 Go to resource。 				

18. ​						您会被重定向到带有虚拟机详情的新窗口。选择页面右上方的公共 IP 地址并将其复制到您的剪贴板中。 				

​				现在，要创建与虚拟机的 SSH 连接，来连接到虚拟机。 		

1. ​						打开终端。 				

2. ​						在提示符后打开到您的虚拟机的 SSH 连接。将 IP 地址替换为您虚拟机的 IP 地址，并将 .pem 的路径替换为下载密钥文件的路径。 				

   

   ```none
   # ssh -i ./Downloads/yourKey.pem azureuser@10.111.12.123
   ```

3. ​						需要确认是否要继续连接。键入 `yes` 以继续。 				

​				因此，推送到 Microsoft Azure Storage Blob 的输出镜像已准备好置备。 		

**其他资源**

- ​						[Microsoft Azure Storage 文档](https://docs.microsoft.com/en-us/azure/storage/). 				
- ​						[创建 Microsoft Azure Storage 帐户](https://docs.microsoft.com/en-us/azure/storage/common/storage-account-create?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json&tabs=azure-portal)。 				
- ​						[在红帽客户门户网站中创建问题单](https://access.redhat.com/support/cases/#/case/new/open-case?intcmp=hp|a|a3|case&caseCreate=true)。 				
- ​						[帮助 + 支持](https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview)。 				
- ​						[联系红帽](https://access.redhat.com/support/contact/)。 				

## 10.10. 将 QCOW2 镜像上传到 OpenStack

​				使用镜像构建器工具，您可以创建适合上传到 OpenStack 云部署的自定义 `.qcow2` 镜像，并在那里启动实例。 		

警告

​					不要将您使用镜像构建器创建的通用 `QCOW2` 命令类型输出格式与 OpenStack 镜像类型的相混淆，后者虽然也是 QCOW2 格式，但包含了针对 OpenStack 的进一步更改。 			

**前提条件**

- ​						您已创建了蓝图。 				
- ​						使用镜像构建器创建 `QCOW2` 镜像。查看 				

**流程**

1. ​						启动 `QCOW2` 镜像的 compose。 				

   

   ```none
   # composer-cli compose start blueprint_name openstack
   ```

2. ​						检查构建的状态。 				

   

   ```none
   # composer-cli compose status
   ```

   ​						镜像构建完成后，您可以下载镜像。 				

3. ​						下载 `QCOW2` 镜像： 				

   

   ```none
   # composer-cli compose image UUID
   ```

4. ​						访问 OpenStack 仪表盘，并单击 +Create Image。 				

5. ​						在左侧菜单中，选择 `Admin` 选项卡。 				

   1. ​								从`系统面板`中，点`镜像`。 						

      ​								`Create An Image` 向导将打开。 						

6. ​						在 `Create An Image` 向导中： 				

   1. ​								输入镜像的名称 						

   2. ​								点 `Browse`，上传 `QCOW2` 镜像。 						

   3. ​								从 `格式` 下拉列表中，选择 `QCOW2 - QEMU Emulator`。 						

   4. ​								点 Create Image。 						

      ​								[![composer openstack upload image](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_a_customized_RHEL_system_image-zh-CN/images/a27cd8c1d12d87331c88a398335105a9/composer-openstack-upload-image.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_a_customized_RHEL_system_image-zh-CN/images/a27cd8c1d12d87331c88a398335105a9/composer-openstack-upload-image.png) 							

7. ​						在左侧菜单中，选择 `Project` 选项卡。 				

   1. ​								从 `Compute` 菜单中，选择 `Instances`。 						

   2. ​								点`启动实例`按钮。 						

      ​								此时会打开 `Launch Instance` 向导。 						

   3. ​								在 `Details` 页面中，输入实例的名称。点 Next。 						

   4. ​								在 `Source` 页面中，选择您上传的镜像的名称。点 Next。 						

   5. ​								在 `Flavor` 页面中，选择最适合您的需要的机器资源。点 `Launch`。 						

      ​								[![composer openstack start instance](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_a_customized_RHEL_system_image-zh-CN/images/03af63aa9192bfc684112aadd15f44c0/composer-openstack-start-instance.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_a_customized_RHEL_system_image-zh-CN/images/03af63aa9192bfc684112aadd15f44c0/composer-openstack-start-instance.png) 							

8. ​						您可以使用任何机制（CLI 或 OpenStack Web UI）来从镜像运行镜像实例。通过 SSH 使用您的私钥访问生成的实例。以 `cloud-user` 用户身份登录。 				

## 10.11. 准备将自定义 RHEL 镜像上传到 Alibaba

​				要将自定义 RHEL 镜像部署到 `Alibaba Cloud`，首先需要验证自定义镜像。镜像需要特定的配置才能成功引导，因为在使用镜像前，Alibaba Cloud 需要自定义镜像来满足某些要求。 		

注意

​					镜像构建器生成符合 Alibaba 要求的镜像。但是，红帽建议使用 Alibaba **image_check** 工具来验证镜像的格式合规性。 			

**前提条件**

- ​						您必须使用镜像构建器创建了一个 Alibaba 镜像。 				

**流程**

1. ​						使用 Alibaba **image_check 工具**连接到含您要检查的镜像的系统。 				

2. ​						下载 **image_check 工具**： 				

   

   ```none
   $ curl -O http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/73848/cn_zh/1557459863884/image_check
   ```

3. ​						更改镜像合规工具的文件权限： 				

   

   ```none
   # chmod +x image_check
   ```

4. ​						运行命令启动镜像合规工具检查： 				

   

   ```none
   # ./image_check
   ```

   ​						该工具会验证系统配置，并生成在屏幕上显示的报告。image_check 工具会在运行镜像合规工具的同一目录中保存此报告。 				

**故障排除**

​					如果任何**检测项**失败，请按照终端中的说明进行更正。请参阅链接：[检测项目部分。](https://www.alibabacloud.com/help/doc-detail/73848.htm) 			

**其他资源**

- ​						[镜像合规工具。](https://www.alibabacloud.com/help/doc-detail/73848.htm) 				

## 10.12. 将自定义 RHEL 镜像上传到 Alibaba

​				您可以使用镜像构建器将您创建的自定义 `AMI` 镜像上传到对象存储服务 (OSS)。 		

**前提条件**

- ​						设置您的系统以上传 Alibaba 镜像。请参阅[准备将镜像上传到 Alibaba](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#preparing-uploading-images-to-alibaba_creating-cloud-images-with-composer)。 				
- ​						已使用镜像构建器创建了 `ami` 镜像。 				
- ​						您有一个存储桶。请参阅[创建存储桶](https://www.alibabacloud.com/help/doc-detail/31885.htm?spm=a2c63.p38356.b99.19.5c3f465a0WnfaV)。 				
- ​						您有一个[活跃的 Alibaba 帐户](https://account.alibabacloud.com/register/intl_register.htm?spm=a2c63.p38356.879954.7.2ce96962qvmvAi)。 				
- ​						已激活了 [OSS](https://www.alibabacloud.com/help/doc-detail/31884.htm?spm=a2c63.p38356.879954.10.7c0a64baufqGup#task-njz-hf4-tdb)。 				

**流程**

1. ​						登录到 [OSS 控制台](https://oss.console.aliyun.com/?spm=a2c63.p38356.879954.10.2171455fhuA3H5)。 				
2. ​						在左侧的 Bucket 菜单中，选择要向其上传镜像的存储桶。 				
3. ​						在右菜单中点 **Files** 标签页。 				
4. ​						点 Upload。一个对话框窗口会在右侧打开。配置以下内容： 				
   - ​								**上传到** ：选择将文件上传到 **Current** 目录或一个 **指定的**目录。 						
   - ​								**文件 ACL** ：选择上传文件的权限类型。 						
5. ​						点 Upload。 				
6. ​						选择您要上传的镜像。 				
7. ​						点 Open。 				

​				因此，自定义的 `AMI` 镜像会上传到 OSS 控制台。 		

**其他资源**

- ​						[上传对象。](https://www.alibabacloud.com/help/doc-detail/31886.htm?spm=a2c63.p38356.b99.20.454c5dc4qRcnad) 				
- ​						[从自定义镜像创建实例。](https://www.alibabacloud.com/help/doc-detail/25542.htm?spm=a2c63.p38356.879954.20.7c0a64batcdSMD#ImportImage) 				
- ​						[导入镜像。](https://www.alibabacloud.com/help/doc-detail/48226.htm) 				

## 10.13. 将镜像导入到 Alibaba

​				要将使用镜像构建器创建的自定义 Alibaba RHEL 镜像导入到 Elastic Cloud Console (ECS)，请按照以下步骤执行： 		

**前提条件**

- ​						设置您的系统以上传 Alibaba 镜像。请参阅[准备将镜像上传到 Alibaba](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#preparing-uploading-images-to-alibaba_creating-cloud-images-with-composer)。 				
- ​						已使用镜像构建器创建了 `ami` 镜像。 				
- ​						您有一个存储桶。请参阅[创建存储桶](https://www.alibabacloud.com/help/doc-detail/31885.htm?spm=a2c63.p38356.b99.19.5c3f465a0WnfaV)。 				
- ​						您有一个[活跃的 Alibaba 帐户](https://account.alibabacloud.com/register/intl_register.htm?spm=a2c63.p38356.879954.7.2ce96962qvmvAi)。 				
- ​						已激活了 [OSS](https://www.alibabacloud.com/help/doc-detail/31884.htm?spm=a2c63.p38356.879954.10.7c0a64baufqGup#task-njz-hf4-tdb)。 				
- ​						您已将镜像上传到对象存储服务(OSS)。请参阅[将镜像上传到 Alibaba](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#uploading-images-to-alibaba_creating-cloud-images-with-composer)。 				

**流程**

1. ​						登录到 [ECS 控制台。](https://account.alibabacloud.com/login/login.htm?oauth_callback=https%3A%2F%2Fecs.console.aliyun.com%2F%3Fspm%3Da2c63.p38356.879954.13.7c0a64bajaDXMi) 				

   1. ​								在左侧菜单中，点 Images。 						

   2. ​								在右上角，点 Import Image。此时会打开一个对话框窗口。 						

   3. ​								确认您已设置了镜像所在的正确区域。输入以下信息： 						

      1. ​										`OSS 对象地址` ：了解如何获取 [OSS 对象地址](https://www.alibabacloud.com/help/doc-detail/31912.htm?spm=5176.2020520101.0.0.34cc7d33vYKnS3)。 								
      2. ​										`镜像名称` 								
      3. ​										`操作系统` 								
      4. ​										`系统磁盘大小` 								
      5. ​										`系统架构` 								
      6. ​										`平台` ：Red Hat 								

   4. ​								另外,还可提供以下详情： 						

      1. ​										`镜像格式`:`qcow2` 或 `ami`，具体取决于上传的镜像格式。 								

      2. ​										`镜像描述` 								

      3. ​										`添加数据磁盘的镜像` 								

         ​										地址可以在 OSS 管理控制台中确定。在左侧菜单中选择所需的存储桶之后： 								

2. ​						选择 `Files` 部分。 				

3. ​						点相应镜像右侧的 **Details** 链接。 				

   ​						窗口会出现在屏幕右侧，显示镜像详情。`OSS` 对象地址位于 `URL` 框中。 				

4. ​						点 确定。 				

   注意

   ​							导入过程的时间可能因镜像大小而异。 					

​				自定义镜像导入到 `ECS` 控制台。 		

**其他资源**

- ​						[导入镜像的备注。](https://www.alibabacloud.com/help/doc-detail/48226.htm) 				
- ​						[从自定义镜像创建实例。](https://www.alibabacloud.com/help/doc-detail/25542.htm?spm=a2c63.p38356.879954.20.7c0a64batcdSMD#ImportImage) 				
- ​						[上传对象。](https://www.alibabacloud.com/help/doc-detail/31886.htm?spm=a2c63.p38356.b99.20.454c5dc4qRcnad) 				

## 10.14. 使用 Alibaba 创建自定义 RHEL 镜像实例

​				您可以使用 `Alibaba ECS 控制台` 创建自定义 RHEL 镜像的实例。 		

**前提条件**

- ​						您已激活了 [OSS](https://www.alibabacloud.com/help/doc-detail/31884.htm?spm=a2c63.p38356.879954.10.7c0a64baufqGup#task-njz-hf4-tdb) 并上传您的自定义镜像。 				
- ​						您已成功将镜像导入到 ECS 控制台。请参阅 [将镜像导入到 Alibaba](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#importing-images-to-alibaba_creating-cloud-images-with-composer)。 				

**流程**

1. ​						登录到 [ECS 控制台。](https://account.alibabacloud.com/login/login.htm?oauth_callback=https%3A%2F%2Fecs.console.aliyun.com%2F%3Fspm%3Da2c63.p38356.879954.13.7c0a64bajaDXMi) 				

2. ​						在左侧菜单中，选择 **Instances**。 				

3. ​						在右上角，点 **Create Instance**。您会被重新定向到新窗口。 				

4. ​						完成所有必需的信息。如需了解更多详细信息，请参阅[使用向导创建实例](https://www.alibabacloud.com/help/doc-detail/87190.htm?spm=a2c63.p38356.879954.13.581344d6KkTITK#task-vwq-5g4-r2b)。 				

5. ​						点 **Create Instance** 并确认顺序。 				

   注意

   ​							根据订阅，您可以看到 **Create Order** 选项，而不是 **Create Instance** 选项。 					

​				因此，您有一个活跃的实例准备好从 `Alibaba ECS 控制台进行部署`。 		

**其他资源**

- ​						[使用自定义镜像创建实例。](https://www.alibabacloud.com/help/doc-detail/25465.htm?spm=a2c63.p38356.b99.108.6f3f33f9vAQ1Vb) 				
- ​						[使用向导创建实例。](https://www.alibabacloud.com/help/doc-detail/87190.htm?spm=a2c63.p38356.b99.107.26bd44d6rRcb4v) 				

# 法律通告

​		Copyright © 2023 Red Hat, Inc. 

​		The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license  ("CC-BY-SA"). An explanation of CC-BY-SA is available at http://creativecommons.org/licenses/by-sa/3.0/. In accordance with CC-BY-SA, if you distribute this document or an  adaptation of it, you must provide the URL for the original version. 

​		Red Hat, as the licensor of this document, waives the right to  enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law. 

​		Red Hat, Red Hat Enterprise Linux, the Shadowman logo, the Red Hat  logo, JBoss, OpenShift, Fedora, the Infinity logo, and RHCE are  trademarks of Red Hat, Inc., registered in the United States and other  countries. 

​		Linux® is the registered trademark of Linus Torvalds in the United States and other countries. 

​		Java® is a registered trademark of Oracle and/or its affiliates. 

​		XFS® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries. 

​		MySQL® is a registered trademark of MySQL AB in the United States, the European Union and other countries. 

​		Node.js® is an official trademark of  Joyent. Red Hat is not formally related to or endorsed by the official  Joyent Node.js open source or commercial project. 

​		The OpenStack® Word Mark and OpenStack  logo are either registered trademarks/service marks or  trademarks/service marks of the OpenStack Foundation, in the United  States and other countries and are used with the 

# 准备、安装和管理 RHEL for Edge 镜像

Red Hat Enterprise Linux 9

## 使用 Red Hat Enterprise Linux 9 创建、部署和管理边缘系统

Red Hat Customer Content Services

[法律通告](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#idm140004322135872)

**摘要**

​				使用镜像构建器工具制作为 Edge 优化的自定义 RHEL (rpm-ostree)镜像。然后，您可以在 Edge 服务器上远程安装并安全地管理和扩展镜像部署。 		

------

# 让开源更具包容性

​			红帽致力于替换我们的代码、文档和 Web 属性中存在问题的语言。我们从这四个术语开始：master、slave、黑名单和白名单。由于此项工作十分艰巨，这些更改将在即将推出的几个发行版本中逐步实施。详情请查看 [CTO Chris Wright 的信息](https://www.redhat.com/en/blog/making-open-source-more-inclusive-eradicating-problematic-language)。 	

# 对红帽文档提供反馈

​			我们感谢您对我们文档的反馈。帮助我们如何进行改进。 	

**根据具体内容提交评论**

1. ​					查看 **Multi-page HTML** 格式的文档，在页面完全加载后会看到右上角的 **Feedback** 按钮。 			
2. ​					用鼠标指针高亮显示您想评论的文本部分。 			
3. ​					点高亮文本旁的 **Add Feedback** 按钮。 			
4. ​					添加您的反馈并点 **Submit**。 			

**通过 Bugzilla 提交反馈（需要有一个 Bugzilla 的帐户）**

1. ​					登录到 [Bugzilla](https://bugzilla.redhat.com/enter_bug.cgi?product=Red Hat Enterprise Linux 9&component=Documentation) 网站。 			
2. ​					从 **Version** 菜单中选择正确的版本。 			
3. ​					在 **Summary** 字段中输入描述性标题。 			
4. ​					在 **Description** 字段中输入您的建议以改进。包括文档相关部分的链接。 			
5. ​					点 **Submit Bug**。 			

# 第 1 章 RHEL for Edge 镜像

​			RHEL for Edge 镜像是一个 `rpm-ostree` 镜像，其中包含在 Edge 服务器中远程安装 RHEL 的系统软件包。 	

​			系统软件包包括： 	

- ​					`Base OS` 软件包 			
- ​					podman 作为容器引擎 			
- ​					其他 RPM 内容 			

​			与 RHEL 镜像不同，RHEL for Edge 是一个不可变的操作系统，即它包含一个具有以下特征的 `只读` 根目录： 	

- ​					软件包与根目录隔离 			
- ​					软件包安装创建层，使其易于回滚到以前的版本 			
- ​					对断开连接环境的有效更新 			
- ​					支持多个操作系统分支和存储库 			
- ​					有一个混合 `rpm-ostree` 软件包系统 			

​			您可以在裸机、设备和 Edge 服务器上部署 RHEL for Edge 镜像。 	

​			您可以使用镜像构建器工具制作自定义的 RHEL for Edge 镜像。您还可以通过访问 Red Hat Hybrid Cloud Console 平台中的 [边缘管理](https://console.redhat.com/edge/fleet-management) 应用程序，并配置自动化管理来创建 RHEL for Edge 镜像。 	

​			边缘管理应用程序简化了您可以提供和注册镜像的方法。要了解更多有关边缘管理的信息，请参阅 [创建 RHEL for Edge 镜像及配置自动化管理](https://access.redhat.com/documentation/zh-cn/edge_management/2022/html/create_rhel_for_edge_images_and_configure_automated_management/index) 文档。 	

​			在 RHEL for Edge 镜像中，您可以实现： 	

[![主要特性](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/8244d26e830b925375cfbb7e5b5ec4d7/edge-features.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/8244d26e830b925375cfbb7e5b5ec4d7/edge-features.png)

## 1.1. RHEL for Edge 支持的构架

​				目前，您可以在 AMD 和 Intel 64 位系统中部署 RHEL for Edge 镜像。 		

注意

​					目前，RHEL for Edge 不支持 ARM 系统。 			

## 1.2. 如何编写和部署 RHEL for Edge 镜像

​				制作和部署 RHEL for Edge 镜像分为两个阶段： 		

1. ​						使用镜像构建器工具制作 RHEL `rpm-ostree` 镜像。您可以通过 `composer-cli` 工具中的命令行界面访问镜像构建器，或者在 RHEL web 控制台中使用图形用户界面。 				
2. ​						使用 RHEL 安装程序部署镜像。 				

​				在制作 RHEL for Edge 镜像时，您可以选择以下任何一种镜像类型。编写不同的 RHEL for Edge 镜像可能需要或可能不需要网络访问。请参阅表： 		

表 1.1. RHEL for Edge 镜像类型

| 镜像类型                                        | 描述                                                         | 适用于基于网络的部署 | 适用于基于非网络的部署 |
| ----------------------------------------------- | ------------------------------------------------------------ | -------------------- | ---------------------- |
| **RHEL for Edge Commit (`.tar`)**               | Commit 镜像不能直接引导，即使它包含了完整的操作系统。要引导 Commit 镜像类型，您必须部署它。 | 是                   | 否                     |
| **RHEL for Edge Container (`.tar`)**            | 容器创建一个 `OSTree` 提交，并将其嵌入到带有 Web 服务器的 OCI 容器中。当容器启动时，web 服务器会将提交充当 OSTree 存储库。 | 否                   | 是                     |
| **RHEL for Edge Installer (`.iso`)**            | RHEL for Edge Installer 镜像类型从正在运行的容器拉取提交，并创建一个可安装的引导 ISO，并带有一个 配置为使用嵌入的 OSTree 提交的 Kickstart 文件。 | 否                   | 是                     |
| **RHEL for Edge Raw 镜像 (.raw.xz)**            | 压缩的原始镜像由一个文件组成，该文件中包含有现有部署有 OSTree 提交的分区布局。您可以在硬盘上闪存 RHEL Raw 镜像，也可以在虚拟机上引导。 | 是                   | 是                     |
| **RHEL for Edge Simplified Installer (`.iso`)** | Simplified Installer 镜像类型从正在运行的容器中拉取提交，并创建一个带有配置为使用嵌入式 OSTree 提交的 Kickstart 文件的可安装的引导 ISO。 | 是                   | 是                     |

​				镜像类型在内容上有所不同，因此适合不同类型的部署环境。 		

**其他资源**

- ​						[执行标准 RHEL 9 安装](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/performing_a_standard_rhel_9_installation/). 				

## 1.3. 非基于网络的部署

​				使用镜像构建器创建灵活的 RHEL `rpm-ostree` 镜像以满足您的要求，然后使用 Anaconda 在您的环境中部署它们。 		

​				您可以通过 `composer-cli` 工具中的命令行界面访问镜像构建器，或者在 RHEL web 控制台中使用图形用户界面。 		

​				在非网络部署中制作和部署 RHEL for Edge 镜像涉及以下高级别的步骤： 		

1. ​						安装并注册 RHEL 系统 				
2. ​						安装镜像构建器 				
3. ​						使用镜像构建器，为 RHEL for Edge 容器镜像创建带有自定义的蓝图 				
4. ​						在镜像构建器中导入 RHEL for Edge 蓝图 				
5. ​						创建嵌入在 OCI 容器中的 RHEL for Edge 镜像，其中包含 webserver 可将提交部署为 OSTree 存储库 				
6. ​						下载 RHEL for Edge 容器镜像文件 				
7. ​						使用 RHEL for Edge 容器提交部署容器提供存储库 				
8. ​						使用镜像构建器，为 RHEL for Edge Installer 镜像创建另一个蓝图 				
9. ​						创建一个 RHEL for Edge 安装程序镜像，以便从嵌入的、使用 RHEL for Edge 容器镜像的正在运行的容器中拉取提交 				
10. ​						下载 RHEL for Edge 安装程序镜像 				
11. ​						运行安装 				

​				下图显示了 RHEL for Edge 镜像非网络部署工作流： 		

图 1.1. 在非网络环境中部署 RHEL for Edge

[![RHEL for Edge 非网络部署工作流](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/7e7bb5d0cb4a69c2a481b08c6c6a7b02/edge_non-network-deployment-workflow.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/7e7bb5d0cb4a69c2a481b08c6c6a7b02/edge_non-network-deployment-workflow.png)

## 1.4. 基于网络的部署

​				使用镜像构建器创建灵活的 RHEL `rpm-ostree` 镜像以满足您的要求，然后使用 Anaconda 在您的环境中部署它们。镜像构建器会自动标识部署设置的详情，并将镜像输出生成为 `edge-commit` 作为 `.tar` 文件。 		

​				您可以通过 `composer-cli` 工具中的命令行界面访问镜像构建器，或者在 RHEL web 控制台中使用图形用户界面。 		

​				您可以通过执行以下高级别步骤编写和部署 RHEL for Edge 镜像： 		

1. ​						安装并注册 RHEL 系统 				
2. ​						安装镜像构建器 				
3. ​						使用镜像构建器，为 RHEL for Edge 镜像创建蓝图 				
4. ​						在镜像构建器中导入 RHEL for Edge 蓝图 				
5. ​						创建 RHEL for Edge Commit (`.tar`)镜像 				
6. ​						下载 RHEL for Edge 镜像文件 				
7. ​						设置 Web 服务器 				
8. ​						为 RHEL for Edge Installer (`.iso`)创建一个新蓝图 				
9. ​						创建 RHEL for Edge Installer (`.iso`)镜像，指向 RHEL for Edge Commit (`.tar`)工件中的 OSTree 内容 				
10. ​						下载您创建的 RHEL for Edge installer ISO 镜像 				
11. ​						使用 RHEL for Edge Installer ISO 镜像引导边缘设备 				

​				下图显示了 RHEL for Edge 网络镜像部署工作流： 		

图 1.2. 在网络基础环境中部署 RHEL for Edge

[![RHEL for Edge 网络部署工作流](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/1ade9df16e6fde0abab1e4a498dabc88/edge-deployment-workflow.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/1ade9df16e6fde0abab1e4a498dabc88/edge-deployment-workflow.png)

## 1.5. RHEL RPM 镜像和 RHEL for Edge 镜像之间的区别

​				您可以以基于传统软件包的 RPM 格式创建 RHEL 系统镜像，并作为 RHEL for Edge (`rpm-ostree`)镜像。 		

​				您可以使用基于软件包的传统 RPM 在传统数据中心上部署 RHEL。但是，您可以使用 RHEL for Edge 镜像在传统数据中心以外的服务器上部署 RHEL。这些服务器包括最接近数据生成边缘服务器来源处理大量数据的系统。 		

​				RHEL for Edge (`rpm-ostree`)镜像不是软件包管理器。它们只支持完整的可引导文件系统树，而不是单个文件。这些镜像没有有关单个文件的信息，如这些文件是如何生成，或与其原始文件相关的任何东西。 		

​				`rpm-ostree` 镜像需要单独的机制（软件包管理器）来在 `/var` 目录中安装其他应用程序。因此，`rpm-ostree` 镜像会使操作系统保持不变，同时维护 `/var` 和 `/etc` 目录的状态。原子更新启用回滚和更新的后台暂存。 		

​				请参阅下表以了解 RHEL for Edge 镜像与基于软件包的 RHEL RPM 镜像有何不同。 		

表 1.2. RHEL RPM 镜像和 RHEL for Edge 镜像之间的区别

| 主要属性       | RHEL RPM 镜像                                              | RHEL for Edge 镜像                                           |
| -------------- | ---------------------------------------------------------- | ------------------------------------------------------------ |
| `OS assemble`  | 您可以在本地编译软件包以组成镜像。                         | 软件包组合在一个 ostree 中，您可以在系统中安装。             |
| `OS 更新`      | 您可以使用 `dnf update` 来应用已启用的存储库中的可用更新。 | 如果 `/etc/ostree/remotes.d/` 的 ostree 远程中存在任何新的提交，则可以使用 `rpm-ostree upgrade` 升级来暂存更新。该更新会在系统重启时生效。 |
| `软件仓库`     | 软件包包含 DNF 存储库                                      | 软件包包含 Ostree 远程存储库                                 |
| `用户访问权限` | 读取写入                                                   | 只读(`/usr`)                                                 |
| `数据持久性`   | 您可以将镜像挂载到任何非 tmpfs 挂载点                      | `/etc` 和 `/var` 已启用读写权限，并包含持久性数据。          |

# 第 2 章 设置镜像构建器

​			使用镜像构建器创建自定义的 RHEL for Edge 镜像。在 RHEL 系统上安装镜像构建器后，镜像构建器可在 RHEL web 控制台中作为应用程序提供。您还可以通过 `composer-cli` 工具中的命令行界面访问镜像构建器。 	

注意

​				建议在虚拟机上安装镜像构建器。 		

​			在您要安装镜像构建器的环境中，确保您首先满足系统要求，然后安装它。 	

## 2.1. 镜像构建器系统要求

​				镜像构建器运行的环境（如虚拟机）必须满足下表中列出的要求。 		

表 2.1. 镜像构建器系统要求

| 参数     | 最低要求值       |
| -------- | ---------------- |
| 系统类型 | 专用虚拟机       |
| 处理器   | 2 个内核         |
| 内存     | 4 GiB            |
| 磁盘空间 | 20 GiB           |
| 访问权限 | 管理员级别(root) |
| 网络     | 连接至互联网     |

注意

​					20 GiB 磁盘空间要求足以在主机上安装并运行镜像构建器。要构建和部署镜像构建，您必须分配额外的专用磁盘空间。 			

## 2.2. 安装镜像构建器

​				要在专用的虚拟机上安装镜像构建器，请按照以下步骤操作： 		

**先决条件**

- ​						虚拟机已创建并处于开机状态。 				
- ​						已安装 RHEL，并且已订阅了 RHSM 或红帽卫星。 				

**步骤**

1. ​						在虚拟机上安装以下软件包： 				

   - ​								osbuild-composer 						
   - ​								composer-cli 						
   - ​								cockpit-composer 						
   - ​								bash-completion 						
   - ​								firewalld 						

   

   ```none
   # dnf install osbuild-composer composer-cli cockpit-composer bash-completion firewalld
   ```

   ​						镜像构建器在 RHEL web 控制台中安装为应用程序。 				

2. ​						重启虚拟机 				

3. ​						将系统防火墙配置为允许访问 Web 控制台： 				

   

   ```none
   # firewall-cmd --add-service=cockpit && firewall-cmd --add-service=cockpit --permanent
   ```

4. ​						启用镜像构建器。 				

   

   ```none
   # systemctl enable osbuild-composer.socket cockpit.socket --now
   ```

   ​						osbuild-composer 和 cockpit 服务在第一次访问时自动启动。 				

5. ​						载入 shell 配置脚本，以便在不重启的情况下立即启动 `composer-cli` 命令的自动完成功能： 				

   

   ```none
   $ source /etc/bash_completion.d/composer-cli
   ```

**其他资源**

- ​						[管理存储库.](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/managing-repositories_composing-installing-managing-rhel-for-edge-images) 				

# 第 3 章 管理镜像构建器存储库

## 3.1. 镜像构建器默认系统存储库

​				`osbuild-composer` 后端不会继承位于 `/etc/yum.repos.d/` 目录中的系统存储库。相反，它拥有自己的一组在 `/usr/share/osbuild-composer/repositories` 目录中定义的官方存储库。这包括红帽官方存储库，其中包含基础系统 RPM，用于向新版本安装附加软件或更新已安装的程序。如果要覆盖官方存储库，您必须在 `/etc/osbuild-composer/repositories` 中定义覆盖。这个目录用于用户定义的覆盖，以及位于该目录中且优先于 `/usr` 目录中文件的文件。 		

​				配置文件不是 `/etc/yum.repos.d/` 中常见的 DNF 存储库格式。相反，它们是简单的 JSON 文件。 		

## 3.2. 覆盖系统存储库

​				您可以按照以下步骤在 `/etc/osbuild-composer/repositories` 目录中为镜像构建器配置存储库覆盖。 		

**先决条件**

- ​						您有一个可从主机系统访问的自定义存储库 				

**步骤**

1. ​						创建一个要存储存储库覆盖的目录： 				

   

   ```none
   $ sudo mkdir -p /etc/osbuild-composer/repositories
   ```

2. ​						您可以创建自己的 JSON 文件结构。 				

3. ​						使用与 RHEL 版本相对应的名称，创建一个 JSON 文件。或者，您还可以从 `/usr/share/osbuild-composer/` 中复制用于分发的文件，并修改其内容。 				

   ​						对于 RHEL 9，使用 `/etc/osbuild-composer/repositories/rhel-91.json`。 				

4. ​						在 JSON 文件中添加以下结构，例如： 				

   

   ```none
   {
       "<ARCH>": [
           {
               "name": "baseos",
               "baseurl": "http://mirror.example.com/composes/released/RHEL-9/9.0/BaseOS/x86_64/os/",
               "gpgkey": "-----BEGIN PGP PUBLIC KEY BLOCK-----\n\n (…)",
               "check_gpg": true,
               "metadata_expire": ""
           }
       ]
   }
   ```

   ​						仅指定以下属性之一： 				

   - ​								`baseurl` - string ：存储库的基本 URL。 						

   - ​								`metalink` - string ：包含有效镜像存储库列表的 metalink 文件的 URL。 						

   - ​								`mirrorlist` - 字符串：包含有效镜像存储库列表列表的 mirrorlist 文件的 URL 						

     ​								剩余的字段是可选的。 						

     1. ​										或者，您也可以复制 JSON 文件以用于您的分发。 								

        1. ​												将存储库文件复制到您创建的目录中。在以下命令中，将 `rhel-version.json` 替换为您的 RHEL 版本，例如：rhel-9.json。 										

           

           ```none
           $  cp /usr/share/osbuild-composer/repositories/rhel-version.json /etc/osbuild-composer/repositories/
           ```

5. ​						使用文本编辑器，编辑 `rhel-9.json` 文件中的 `baseurl` 路径并保存它。例如： 				

   

   ```none
   $ vi /etc/osbuild-composer/repositories/rhel-version.json
   ```

6. ​						重启 `osbuild-composer.service` ： 				

   

   ```none
   $ sudo systemctl restart osbuild-composer.service
   ```

**验证**

- ​						检查存储库是否指向正确的 URL： 				

  

  ```none
  $ cat /etc/yum.repos.d/redhat.repo
  ```

  ​						您可以看到仓库指向从 `/etc/yum.repos.d/redhat.repo` 文件中复制的正确 URL。 				

**其他资源**

- ​						[存储库中可用的最新的 RPM 版本对 `osbuild-composer` 不可见。](https://access.redhat.com/solutions/6957312) 				

## 3.3. 覆盖支持订阅的系统存储库

​				`osbuild-composer` 服务可以使用 `/etc/yum.repos.d/redhat.repo` 文件中定义的系统订阅。要使用 `osbuild-composer` 中的系统订阅，请定义具有以下内容的存储库覆盖： 		

- ​						与 `/etc/yum.repos.d/redhat.repo` 中定义的存储库相同的 `baseurl`。 				
- ​						JSON 对象中定义的 `"rhsm": true` 值。 				

**先决条件**

- ​						您的系统有一个在 `/etc/yum.repos.d/redhat.repo` 中定义的订阅 				
- ​						您已创建了一个存储库覆盖。请参阅 [覆盖系统存储库](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#overriding-a-system-repository_managing-repositories)。 				

**步骤**

1. ​						从 `/etc/yum.repos.d/redhat.repo` 文件中获取 `baseurl` ： 				

   

   ```none
   # cat /etc/yum.repos.d/redhat.repo
   [AppStream]
   name = AppStream mirror example
   baseurl = https://mirror.example.com/RHEL-9/9.0/AppStream/x86_64/os/
   enabled = 1
   gpgcheck = 0
   sslverify = 1
   sslcacert = /etc/pki/ca1/ca.crt
   sslclientkey = /etc/pki/ca1/client.key
   sslclientcert = /etc/pki/ca1/client.crt
   metadata_expire = 86400
   enabled_metadata = 0
   ```

2. ​						配置存储库覆盖以使用相同的 `baseurl`，并将 `rhsm` 设为 true： 				

   

   ```none
   {
       "x86_64": [
           {
               "name": "AppStream mirror example",
               "baseurl": "https://mirror.example.com/RHEL-9/9.0/AppStream/x86_64/os/",
               "gpgkey": "-----BEGIN PGP PUBLIC KEY BLOCK-----\n\n (…)",
               "check_gpg": true,
               "rhsm": true
           }
       ]
   }
   ```

   注意

   ​							`osbuild-composer` 不自动使用 `/etc/yum.repos.d/` 中定义的存储库。您需要手动将它们指定为系统存储库覆盖 ，或使用 `composer-cli` 指定为额外的 `源`。系统存储库覆盖通常用于"BaseOS"和"AppStream"存储库，而 `composer-cli` 源则用于所有其他存储库。 					

​				因此，镜像构建器从主机系统读取 `/etc/yum.repos.d/redhat.repo` 文件，并用它作为订阅源。 		

**其他资源**

- ​						[当主机注册到 Satellite 6 时，镜像构建器使用 CDN 存储库](https://access.redhat.com/solutions/5773421) 				

# 第 4 章 在 RHEL web 控制台中使用镜像构建器制作 RHEL for Edge 镜像

​			使用镜像构建器创建自定义的 RHEL for Edge 镜像(OSTree 提交)。 	

​			要访问镜像构建器并创建自定义的 RHEL for Edge 镜像，您可以使用 RHEL web 控制台界面或命令行界面。 	

​			您可以通过执行以下高级步骤，再 RHEL web 控制台中使用镜像构建器制作 RHEL for Edge 镜像： 	

1. ​					在 RHEL web 控制台中访问镜像构建器 			
2. ​					为 RHEL for Edge 镜像创建一个蓝图。 			
3. ​					创建 RHEL for Edge 镜像。您可以创建以下镜像： 			
   - ​							RHEL for Edge Commit 镜像。 					
   - ​							RHEL for Edge 容器镜像。 					
   - ​							RHEL for Edge 安装程序镜像。 					
4. ​					下载 RHEL for Edge 镜像 			

## 4.1. 在 RHEL web 控制台中访问镜像构建器

​				要在 RHEL web 控制台中访问镜像构建器，请确保您满足以下先决条件，然后按照以下流程操作。 		

**先决条件**

- ​						已安装 RHEL 系统。 				
- ​						您对系统具有管理权限。 				
- ​						您已向 Red Hat Subscription Manager (RHSM)或 Red Hat Satellite Server 订阅了 RHEL 系统。 				
- ​						系统开机并通过网络访问。 				
- ​						您已在系统上安装了镜像构建器。 				

**步骤**

1. ​						在 RHEL 系统中，在网页浏览器中访问 https://localhost:9090/。 				

2. ​						有关如何远程访问镜像构建器的更多信息，请参阅 [使用 RHEL 9 web 控制台管理系统](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/managing_systems_using_the_rhel_9_web_console/index) 文档。 				

3. ​						使用管理用户帐户登录 Web 控制台。 				

4. ​						在 Web 控制台中，在左侧菜单中点 Apps。 				

5. ​						单击 image builder。 				

   ​						镜像构建器仪表盘在右侧窗格中打开。现在，您可以继续为 RHEL for Edge 镜像创建蓝图。 				

## 4.2. 在 RHEL web 控制台中使用镜像构建器为 RHEL for Edge Commit 镜像创建蓝图

​				要在 RHEL web 控制台中使用镜像构建器为 RHEL for Edge Commit 镜像创建蓝图，请确保您满足以下先决条件，然后按照以下流程操作。 		

**先决条件**

- ​						在 RHEL 系统上，您已打开镜像构建器仪表盘。 				

**步骤**

1. ​						在镜像构建器仪表盘上，点 Create Blueprint。 				

   ​						此时会打开 **Create Blueprint** 对话框。 				

2. ​						指定名称，以及可选的您要创建的蓝图的描述。 				

3. ​						点 Create。 				

   ​						镜像构建器仪表盘列出了您创建的蓝图。 				

## 4.3. 在 RHEL web 控制台中使用镜像构建器创建 RHEL for Edge Commit 镜像

​				**"RHEL for Edge Commit (.tar) "** 镜像类型包含一个完整的操作系统，但它不能直接启动。要引导 Commit 镜像类型，您必须将它部署在正在运行的容器中。 		

​				要在 RHEL web 控制台中使用镜像构建器创建 RHEL for Edge Commit 镜像，请按照以下步骤： 		

**先决条件**

- ​						在 RHEL 系统上，您已访问了镜像构建器仪表盘。 				

**步骤**

1. ​						在镜像构建器仪表盘上，针对您为 **RHEL for Edge Commit** 镜像创建的蓝图，点 Create Image。 				

   ​						要搜索特定蓝图，在 **Filter By Name** 文本框中输入蓝图名称，然后按 Enter 键。 				

2. ​						在 **Create Image** 向导中执行以下步骤： 				

   1. ​								在 **Image output** 页面上，从 **Image output type** 下拉列表中，为基于网络的部署选择 **“RHEL for Edge Commit (.tar)”**。 						
   2. ​								在 **OSTree** 页面中，输入： 						
      1. ​										**Repository URL** ：指定要嵌入镜像中提交的 OSTree 存储库的 URL。例如：http://10.0.2.2:8080/repo/。 								
      2. ​										**Parent commit** ：指定之前的提交，如果此时还没有提交，则保留为空。 								
      3. ​										在 **Ref** textbox 中，指定创建您的提交的参考路径。默认情况下，Web 控制台指定 `rhel/9/$ARCH/edge`。"$ARCH" 值由主机机器决定。点 Next。 								

3. ​						从 **Customization page** 页面中： 				

   1. ​								在 **System** 页面上： 						
      1. ​										输入主机名。如果将字段留空，系统将确定主机名。点 Next。 								
   2. ​								在 **Users** 页面上，点 Add user。 						
      1. ​										输入用户名和密码。 								
      2. ​										可选：输入 SSH 密钥，并检查 `Server administrator` 字段。点 Next。 								
   3. ​								在 **Packages** 页面上： 						
      1. ​										在 **Available packages** 搜索字段中输入您要添加的软件包。 								
         1. ​												点击 > 按钮选择一个软件包。 										
         2. ​												可选：点击 >> 按钮选择所有软件包。点 Next。 										
   4. ​								在 **Review** 页面上，检查自定义。点 Save blueprint。 						

4. ​						点 Create。 				

   ​						镜像构建器开始为您创建的蓝图创建一个 RHEL for Edge Commit 镜像。 				

   注意

   ​							镜像创建过程需要 20 分钟才能完成。 					

**验证**

1. ​						检查 RHEL for Edge Commit 镜像创建进度： 				
   1. ​								点蓝图名称。 						
   2. ​								点 Images 选项卡。 						

​				镜像创建过程完成后，您可以下载生成的 **"RHEL for Edge Commit(.tar)"** 镜像。 		

**其他资源**

- ​						[下载 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console_composing-installing-managing-rhel-for-edge-images#downloading-a-rhel-for-edge-image_composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console) 				

## 4.4. 在 RHEL web 控制台中使用镜像构建器创建 RHEL for Edge 容器镜像

​				您可以通过选择 **“RHEL for Edge Container (.tar)”** 创建 RHEL for Edge 镜像。**RHEL for Edge Container(.tar)** 镜像类型会创建一个 OSTree 提交，并将其嵌入到带有 web 服务器的 OCI 容器中。容器启动后，Web 服务器将提交充当 OSTree 存储库。 		

​				按照此流程中的步骤，再 RHEL web 控制台中使用镜像构建器创建 RHEL for Edge 容器镜像。 		

**先决条件**

- ​						在 RHEL 系统上，您已访问了镜像构建器仪表盘。 				
- ​						您已创建了蓝图。 				

**步骤**

1. ​						在镜像构建器仪表盘上，针对您为 **RHEL for Edge Container** 镜像创建的蓝图，点击 **Create Image**。要搜索特定蓝图，在 **Filter By Name** 文本框中输入蓝图名称，然后按 Enter 键。 				

2. ​						在 **Create Image** 向导中执行以下步骤： 				

   1. ​								在 **Image output** 页面上，在 **Image output type** 下拉列表中，为基于网络的部署选择 **“RHEL for Edge Container (.tar)”**。 						

   2. ​								在 **OSTree** 页面中，输入： 						

      1. ​										**Repository URL** ：指定要嵌入镜像中提交的 OSTree 存储库的 URL。例如：http://10.0.2.2:8080/repo/。默认情况下，RHEL for Edge 容器镜像的存储库文件夹为 "/repo"。 								

         ​										要查找要使用的正确 URL，请访问正在运行的容器并检查 `nginx.conf` 文件。要查找要使用哪个 URL，请访问正在运行的容器并检查 `nginx.conf` 文件。在 `nginx.conf` 文件中，找到 `root` 目录条目，以搜索 `/repo/` 文件夹信息。请注意，如果您在使用镜像构建器创建 RHEL for Edge 容器镜像 `(.tar)` 时没有指定存储库 URL，则会在 'nginx.conf' 文件中创建默认的 `/repo/` 条目。 								

      2. ​										**Parent commit** ：指定之前的提交，如果此时还没有提交，则保留为空。 								

      3. ​										在 **Ref** textbox 中，指定创建您的提交的参考路径。默认情况下，Web 控制台指定 `rhel/9/$ARCH/edge`。"$ARCH" 值由主机机器决定。点 Next。 								

3. ​						从 **Customization page** 页面中： 				

   1. ​								在 **System** 页面上： 						
      1. ​										输入主机名。如果将字段留空，系统将确定主机名。点 Next。 								
   2. ​								在 **Users** 页面上，点 Add user。 						
      1. ​										输入用户名和密码。 								
      2. ​										可选：输入 SSH 密钥，并检查 `Server administrator` 字段。点 Next。 								
   3. ​								在 **Packages** 页面上： 						
      1. ​										在 **Available packages** 搜索字段中输入您要添加的软件包。 								
         1. ​												点击 > 按钮选择一个软件包。 										
         2. ​												可选：点击 >> 按钮选择所有软件包。点 Next。 										
   4. ​								在 **Review** 页面上，检查自定义。点 Save blueprint。 						

4. ​						点 Create。 				

   ​						镜像构建器开始为您创建的蓝图创建一个 RHEL for Edge Commit 镜像。 				

   注意

   ​							镜像创建过程需要 20 分钟才能完成。 					

**验证**

1. ​						检查 RHEL for Edge Commit 镜像创建进度： 				
   1. ​								点蓝图名称。 						
   2. ​								点 Images 选项卡。 						

​				镜像创建过程完成后，您可以下载生成的 **"RHEL for Edge Container(.tar)"** 镜像。 		

**其他资源**

- ​						[下载 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console_composing-installing-managing-rhel-for-edge-images#downloading-a-rhel-for-edge-image_composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console) 				

## 4.5. 在 RHEL web 控制台中使用镜像构建器创建 RHEL for Edge Installer 镜像

​				您可以通过选择 `RHEL for Edge Installer (.iso)` 来为非基于网络的部署创建 RHEL for Edge Installer 镜像。`RHEL for Edge Installer (.iso)` 镜像类型从 `RHEL for Edge Container (.tar)` 服务的正在运行的容器中拉取 OSTree 提交存储库，并创建一个带有配置为使用嵌入式 OSTree 提交的 Kickstart 文件的可安装的引导 ISO 镜像。 		

​				按照此流程中的步骤，在 RHEL web 控制台中使用镜像构建器创建 RHEL for Edge 镜像。 		

**先决条件**

- ​						在 RHEL 系统上，您已访问了镜像构建器仪表盘。 				
- ​						您创建了蓝图。 				
- ​						您已创建了 RHEL for Edge 容器镜像，并将其加载到正在运行的容器中。请参阅[为非基于网络的部署创建 RHEL for Edge 容器镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#building-a-rhel-for-edge-container-commit-for-non-network-based-deployments_assembly_deploying-a-non-network-rhel-for-edge-image)。 				

**步骤**

1. ​						在镜像构建器仪表盘上，对于您为 **RHEL for Edge Installer** 镜像创建的蓝图，点 Create Image。 				

   ​						要搜索特定蓝图，在 **Filter By Name** 文本框中输入蓝图名称，然后按 Enter 键。 				

2. ​						在 **Create Image** 向导中执行以下步骤： 				

3. ​						在 **Image output** 页面上，从镜像 **Image output type** 下拉列表中选择 `RHEL for Edge Installer (.iso)` 镜像。 				

   1. ​								在 **OSTree** 页面中，输入： 						
      1. ​										**Repository URL** ：指定要嵌入镜像中提交的 OSTree 存储库的 URL。例如：http://10.0.2.2:8080/repo/。 								
      2. ​										在 **Ref** textbox 中，指定创建您的提交的参考路径。默认情况下，Web 控制台指定 `rhel/9/$ARCH/edge`。"$ARCH" 值由主机机器决定。点 Next。 								

4. ​						从 **Customization page** 页面中： 				

   1. ​								在 **System** 页面上： 						
      1. ​										输入主机名。如果将字段留空，系统将确定主机名。点 Next。 								
   2. ​								在 **Users** 页面上，点 Add user。 						
      1. ​										输入用户名和密码。 								
      2. ​										可选：输入 SSH 密钥，并检查 `Server administrator` 字段。点 Next。 								
   3. ​								在 **Packages** 页面上： 						
      1. ​										在 **Available packages** 搜索字段中输入您要添加的软件包。 								
         1. ​												点击 > 按钮选择一个软件包。 										
         2. ​												可选：点击 >> 按钮选择所有软件包。点 Next。 										
   4. ​								在 **Review** 页面上，检查自定义。点 Save blueprint。 						

5. ​						点 Create。 				

   ​						镜像构建器开始为您创建的蓝图创建一个 RHEL for Edge Commit 镜像。 				

   注意

   ​							镜像创建过程需要 20 分钟才能完成。 					

**验证**

1. ​						检查 RHEL for Edge Commit 镜像创建进度： 				
   1. ​								点蓝图名称。 						
   2. ​								点 Images 选项卡。 						

​				镜像创建过程完成后，您可以下载生成的 `RHEL for Edge Installer (.iso)` 镜像。 		

1. ​						从 **Type** 下拉列表中选择 `RHEL for Edge Installer (.iso)`。 				

2. ​						在 **Repository URL** 文本框中，指定提交的运行中容器 OSTree 存储库的 URL，以嵌入到镜像中。例如：http://10.0.2.2:8080/repo/。 				

3. ​						在 **Parent commit** 文本框中，您可以指定之前的提交或留空；如果此时没有提交。 				

4. ​						在 **Ref** 文本框中，引用路径必须与 RHEL for Edge Container image compose 中的 **Ref** 匹配。 				

   1. ​								点 Create。 						

      ​								镜像构建器开始为您创建的蓝图创建 **RHEL for Edge Installer** 镜像。 						

   2. ​								检查 RHEL for Edge Installer 镜像创建进度： 						

5. ​						点击面包屑导航栏中的蓝图名称。 				

6. ​						点 Images 选项卡。 				

   注意

   ​							镜像创建过程需要 20 分钟才能完成。要取消镜像创建过程，请点击 **More Options** 菜单中的 Stop。 					

​				镜像创建过程完成后，您可以下载生成的 `RHEL for Edge 安装程序(.iso)` 镜像并将 ISO 镜像引导到设备中。 		

**其他资源**

- ​						[下载 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console_composing-installing-managing-rhel-for-edge-images#downloading-a-rhel-for-edge-image_composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console)。 				

## 4.6. 下载 RHEL for Edge 镜像

​				使用镜像构建器成功创建 RHEL for Edge 镜像后，将镜像下载到本地主机上。 		

**步骤**

​					下载镜像： 			

1. ​						在 **More Options** 菜单中点 Download。 				

   ​						镜像构建器工具将文件下载到默认的下载位置。 				

​				下载的文件包含一个 `.tar` 文件，其中包含适用于 RHEL for Edge Commit 和 RHEL for Edge 容器镜像的 OSTree 存储库，或 RHEL for Edge 安装程序镜像（带有 OSTree 存储库）的 `.iso` 文件。此存储库包含提交和 `json` 文件，其中包含有关存储库内容的信息元数据。 		

## 4.7. 其他资源

- ​						[使用镜像构建器命令行制作 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-a-rhel-for-edge-image-using-image-builder-command-line_composing-installing-managing-rhel-for-edge-images)。 				

# 第 5 章 使用镜像构建器命令行制作 RHEL for Edge 镜像

​			您可以使用镜像构建器创建自定义的 RHEL for Edge 镜像(OSTree 提交)。 	

​			要访问镜像构建器并创建自定义的 RHEL for Edge 镜像，您可以使用 RHEL web 控制台界面或命令行界面。 	

​			对于基于网络的部署，使用 CLI 编写 RHEL for Edge 镜像的工作流涉及以下高级别步骤： 	

1. ​					为 RHEL for Edge 镜像创建蓝图 			
2. ​					创建 RHEL for Edge Commit 镜像 			
3. ​					下载 RHEL for Edge Commit 镜像 			

​			对于不是基于网络的部署，使用 CLI 编写 RHEL for Edge 镜像的工作流涉及以下高级别步骤： 	

1. ​					为 RHEL for Edge 镜像创建蓝图 			
2. ​					为 RHEL for Edge Installer 镜像创建一个蓝图 			
3. ​					创建 RHEL for Edge 容器镜像 			
4. ​					为 Edge 安装程序创建 RHEL 			
5. ​					下载 RHEL for Edge 镜像 			

​			要执行这些步骤，请使用 `composer-cli` 软件包。 	

注意

​				要以非 root 身份运行 `composer-cli` 命令，您必须是 `weldr` 组的一部分，或者您必须具有系统的管理员访问权限。 		

## 5.1. 基于网络的部署工作流

​				这提供了如何构建 `OSTree` 提交的步骤。这些 `OSTree` 提交包含完整的操作系统，但不能直接启动。要引导它们，您需要使用 Kickstart 文件进行部署。 		

### 5.1.1. 使用镜像构建器命令行界面创建 RHEL for Edge Commit 镜像蓝图

​					使用 CLI 为 RHEL for Edge Commit 镜像创建一个蓝图。 			

**前提条件**

- ​							您没有现有的蓝图。要验证，列出现有的蓝图： 					

  

  ```none
  $ sudo composer-cli blueprints list
  ```

**步骤**

1. ​							以 TOML 格式创建一个纯文本文件，其内容如下： 					

   

   ```none
   name = "blueprint-name"
   description = "blueprint-text-description"
   version = "0.0.1"
   modules = [ ]
   groups = [ ]
   ```

   ​							其中, 					

   - ​									*blueprint-name* 是名称，print-text-description 是您的蓝图的描述。 							

   - ​									*0.0.1* 是 Semantic Versioning 方案的版本号。 							

   - ​									*模块* 描述了要安装到镜像中的软件包名称和匹配版本的 glob，例如：软件包名称 = "tmux"，匹配的版本 glob 是 version = "2.9a"。 							

     ​									请注意，目前软件包和模块之间没有区别。 							

   - ​									*组*是要安装到镜像中的软件包组，如组软件包 anaconda-tools。 							

     ​									此时，如果您不知道模块和组，请将它们留空。 							

2. ​							包含所需的软件包，并在蓝图中自定义其他详情以满足您的要求。 					

   ​							对于要包含在蓝图中的每个软件包，请在文件中添加以下行： 					

   

   ```none
   [[packages]]
   name = "package-name"
   version = "package-version"
   ```

   ​							其中, 					

   - ​									package-name 是软件包的名称，如 httpd、gdb-doc 或 coreutils。 							

   - ​									package-version 是您要使用的软件包的版本号。 							

     ​									package-version 支持以下 dnf 版本规格： 							

   - ​									对于特定版本，请使用准确版本号，如 9.0。 							

   - ​									对于最新可用版本，请使用星号 *。 							

   - ​									对于最新的次版本，请使用格式（如 9.*）。 							

3. ​							将蓝图推送（导入）到镜像构建器服务器： 					

   

   ```none
   # composer-cli blueprints push blueprint-name.toml
   ```

4. ​							列出现有的蓝图，以检查创建的蓝图是否已成功推送并存在。 					

   

   ```none
   # composer-cli blueprints show BLUEPRINT-NAME
   ```

5. ​							检查蓝图中列出的组件和版本是否有效： 					

   

   ```none
   # composer-cli blueprints depsolve blueprint-name
   ```

**其他资源**

- ​							[支持的镜像自定义](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-command-line-interface_composing-a-customized-rhel-system-image#image-customizations_creating-system-images-with-composer-command-line-interface). 					

### 5.1.2. 使用镜像构建器命令行界面创建 RHEL for Edge Commit 镜像

​					要使用镜像构建器命令行界面创建 RHEL for Edge Commit 镜像，请确保您满足以下先决条件，并按照流程操作。 			

**先决条件**

- ​							您已为 RHEL for Edge Commit 镜像创建了一个蓝图。 					

**步骤**

1. ​							创建 RHEL for Edge Commit 镜像。 					

   

   ```none
   # composer-cli compose start blueprint-name image-type
   ```

   ​							其中, 					

   - ​									*blueprint-name* 是 RHEL for Edge 蓝图名称。 							

   - ​									*image-type* 是 `edge-commit`（对于 **network-based deployment**）。 							

     ​									这时将显示一个确认已添加到队列中的 composer 进程。它还显示创建的镜像的通用唯一标识符 (UUID) 号。使用 UUID 号来跟踪构建。另外，记录 UUID 号以易于执行进一步的任务。 							

2. ​							检查镜像 compose 状态。 					

   

   ```none
   # composer-cli compose status
   ```

   ​							输出以以下格式显示状态： 					

   

   ```none
   <UUID> RUNNING date blueprint-name blueprint-version image-type
   ```

   注意

   ​								镜像创建过程需要 20 分钟才能完成。 						

   ​							要中断镜像创建过程，请运行： 					

   

   ```none
   # composer-cli compose cancel <UUID>
   ```

   ​							要删除现有镜像，请运行： 					

   

   ```none
   # composer-cli compose delete <UUID>
   ```

   ​							镜像就绪后，您可以下载该镜像并使用**网络部署**上的镜像。 					

**其他资源**

- ​							[使用镜像构建器命令行制作 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-a-rhel-for-edge-image-using-image-builder-command-line_composing-installing-managing-rhel-for-edge-images) 					

### 5.1.3. 使用镜像构建器命令行界面，通过 ref 提交创建 RHEL for Edge 镜像更新

​					如果您在现有蓝图中进行了更改，例如，您添加了一个新的软件包，并希望使用这个新软件包更新现有的 RHEL for Edge 镜像，则您可以使用 `--parent` 参数来生成更新的 `RHEL for Edge Commit (.tar)` 镜像。`--parent` 参数必须是 `ref`，它存在于 `URL` 参数指定的存储库中。`--ref` 参数使您能够指定一个现有 `ref`，其会为您要构建的新提交检索父项。您必须将父提交指定为要解析和拉取的 `ref` 值，而不是作为提交 ID，如 `rhel/9/x86_64/edge`。当您将父提交指定为 `ref` 值时，镜像构建器可以从影响您要构建的新提交的一部分的父提交中读取信息。因此，镜像构建器读取父提交的用户数据库，并为软件包创建的系统用户和组保留 UID 和 GID。 			

​					要使用镜像构建器 CLI 使用父参数创建 RHEL for Edge 镜像，请确保您满足以下先决条件，并按照流程操作。 			

**先决条件**

- ​							您已为 RHEL for Edge 镜像更新了现有蓝图。 					
- ​							您有一个现有的 RHEL for Edge 镜像(OSTree commit)。请参阅[提取 RHEL for Edge 镜像提交](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images#extracting-the-tar-file-commit_installing-rpm-ostree-images) 					
- ​							正在构建的 `ref` 位于 URL 指定的 `OSTree` 存储库中。 					

**步骤**

1. ​							创建 RHEL for Edge commit 镜像： 					

   

   ```none
   # composer-cli compose start-ostree --ref rhel/9/x86_64/edge --parent parent-OSTree-REF --url URL blueprint-name image-type
   ```

   ​							例如： 					

   - ​									要根据 `parent` 和新的 `ref` 创建新的 RHEL for Edge 提交，请运行以下命令： 							

     

     ```none
     # composer-cli compose start-ostree --ref rhel/9/x86_64/edge --parent rhel/9/x86_64/edge --url _http://10.0.2.2:8080/repo rhel_update edge-commit
     ```

   - ​									要根据同一 `ref` 创建新的 RHEL for Edge 提交，请运行以下命令： 							

     

     ```none
     # composer-cli compose start-ostree --ref rhel/9/x86_64/edge --url http://10.0.2.2:8080/repo rhel_update edge-commit
     ```

     ​									其中： 							

     - ​											*--ref* 参数指定用于构建 OSTree 存储库的相同路径值。 									

     - ​											*--parent* 参数将父提交指定为 ref 来解析和拉取，而不是作为提交 ID，如 `rhel/9/x86_64/edge`。 									

     - ​											*blueprint-name* 是 RHEL for Edge 蓝图名称。 									

     - ​											`--url` 参数指定要嵌入到镜像中的提交的 OSTree 存储库的 URL，例如 http://10.0.2.2:8080/repo。 									

     - ​											*image-type* 是 `edge-commit`（对于 **network-based deployment**）。 									

       注意

       - ​														`--parent` 参数只能用于 `RHEL for Edge Commit (.tar)` 镜像类型。将 `--url` 和 `--parent` 参数一起使用会导致 `RHEL for Edge Container (.tar)` 镜像类型出错。 												
       - ​														如果省略 `parent ref` 参数，系统会退回到 `--ref` 参数指定的 `ref`。 												

       ​											这时将显示一个确认已添加到队列中的 composer 进程。它还显示创建的镜像的通用唯一标识符 (UUID) 号。使用 UUID 号来跟踪构建。另外，记录 UUID 号以易于执行进一步的任务。 									

2. ​							检查镜像 compose 状态。 					

   

   ```none
   # composer-cli compose status
   ```

   ​							输出以以下格式显示状态： 					

   

   ```none
   <UUID> RUNNING date blueprint-name blueprint-version image-type
   ```

   注意

   ​								完成镜像创建过程需要几分钟时间。 						

   ​							（可选）要中断镜像创建过程，请运行： 					

   

   ```none
   # composer-cli compose cancel <UUID>
   ```

   ​							（可选）要删除现有镜像，请运行： 					

   

   ```none
   # composer-cli compose delete <UUID>
   ```

​					镜像创建完成后，要升级现有的 OSTree 部署，您需要： 			

- ​							设置存储库。请参阅[部署 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images)。 					
- ​							将此存储库添加为远程，也就是托管 OSTree 内容的 http 或 https 端点。 					
- ​							将新 OSTree 提交拉取到其现有的正在运行的实例。请参阅[手动部署 RHEL for Edge 镜像更新](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images)。 					

**其他资源**

- ​							[在命令行界面中使用镜像构建器创建系统镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-a-rhel-for-edge-image-using-image-builder-command-line_composing-installing-managing-rhel-for-edge-images)。 					
- ​							[使用镜像构建器命令行界面下载 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-a-rhel-for-edge-image-using-image-builder-command-line_composing-installing-managing-rhel-for-edge-images#downloading-a-rhel-for-edge-image-using-the-command-line_composing-a-rhel-for-edge-image-using-image-builder-command-line)。 					

### 5.1.4. 使用镜像构建器命令行界面下载 RHEL for Edge 镜像

​					要使用镜像构建器命令行界面下载 RHEL for Edge 镜像，请确保您满足以下先决条件，然后按照流程操作。 			

**先决条件**

- ​							您已创建了 RHEL for Edge 镜像。 					

**步骤**

1. ​							查看 RHEL for Edge 镜像状态。 					

   

   ```none
   # composer-cli compose status
   ```

   ​							输出必须显示以下内容： 					

   

   ```none
   $ <UUID> FINISHED date blueprint-name blueprint-version image-type
   ```

2. ​							下载镜像。 					

   

   ```none
   # composer-cli compose image <UUID>
   ```

   ​							镜像构建器将镜像作为 `tar` 文件下载到当前目录。 					

   ​							UUID 号和镜像大小会同时显示。 					

   

   ```none
   $ <UUID>-commit.tar: size MB
   ```

​					镜像包含提交和 `json` 文件，其中包含有关存储库内容的信息元数据。 			

**其他资源**

- ​							[在网络基础环境中部署 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html-single/composing_installing_and_managing_rhel_for_edge_images/index#installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images)。 					

## 5.2. 非基于网络的部署工作流

​				要构建一个使用 "RHEL for Edge Container" 和 "RHEL for Edge Installer" 镜像安装基于 OSTree 系统的引导 ISO 镜像，并且以后可以在断开连接的环境中部署到设备，请按照以下步骤执行。 		

### 5.2.1. 使用镜像构建器 CLI 创建 RHEL for Edge 容器蓝图

​					要为 RHEL for Edge 容器镜像创建蓝图，请执行以下步骤： 			

**步骤**

1. ​							以 TOML 格式创建一个纯文本文件，其内容如下： 					

   

   ```none
   name = "blueprint-name"
   description = "blueprint-text-description"
   version = "0.0.1"
   modules = [ ]
   groups = [ ]
   ```

   ​							其中, 					

   - ​									*blueprint-name* 是名称，print-text-description 是您的蓝图的描述。 							

   - ​									*0.0.1* 是 Semantic Versioning 方案的版本号。 							

   - ​									*模块* 描述了要安装到镜像中的软件包名称和匹配版本的 glob，例如：软件包名称 = "tmux"，匹配的版本 glob 是 version = "2.9a"。 							

     ​									请注意，目前软件包和模块之间没有区别。 							

   - ​									*组*是要安装到镜像中的软件包组，如组软件包 anaconda-tools。 							

     ​									此时，如果您不知道模块和组，请将它们留空。 							

2. ​							包含所需的软件包，并在蓝图中自定义其他详情以满足您的要求。 					

   ​							对于要包含在蓝图中的每个软件包，请在文件中添加以下行： 					

   

   ```none
   [[packages]]
   name = "package-name"
   version = "package-version"
   ```

   ​							其中, 					

   - ​									package-name 是软件包的名称，如 httpd、gdb-doc 或 coreutils。 							

   - ​									package-version 是您要使用的软件包的版本号。 							

     ​									package-version 支持以下 dnf 版本规格： 							

   - ​									对于特定版本，请使用准确版本号，如 9.0。 							

   - ​									对于最新可用版本，请使用星号 *。 							

   - ​									对于最新的次版本，请使用格式（如 9.*）。 							

3. ​							将蓝图推送（导入）到镜像构建器服务器： 					

   

   ```none
   # composer-cli blueprints push blueprint-name.toml
   ```

4. ​							列出现有的蓝图，以检查创建的蓝图是否已成功推送并存在。 					

   

   ```none
   # composer-cli blueprints show BLUEPRINT-NAME
   ```

5. ​							检查蓝图中列出的组件和版本是否有效： 					

   

   ```none
   # composer-cli blueprints depsolve blueprint-name
   ```

**其他资源**

- ​							[支持的镜像自定义](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_a_customized_rhel_system_image/creating-system-images-with-composer-command-line-interface_composing-a-customized-rhel-system-image#image-customizations_creating-system-images-with-composer-command-line-interface). 					

### 5.2.2. 使用镜像构建器 CLI 创建 RHEL for Edge Installer 蓝图

​					您可以创建一个蓝图来构建 `RHEL for Edge Installer(.iso)` 镜像，并指定用户帐户以在安装时自动在系统中创建一个或多个用户。请参阅[为 RHEL for Edge 镜像蓝图创建管理用户帐户](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console_composing-installing-managing-rhel-for-edge-images#creating-an-administrative-user-account-for-a-rhel-for-edge-image-blueprint_composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console)。它在安装时会创建新用户。 			

警告

​						当您在带有 `customizations.user` 自定义的蓝图中创建用户时，蓝图会在 `/usr/lib/passwd` 目录下创建用户，在 `/usr/etc/shadow` 目录下创建密码。请注意，您无法使用 `OSTree` 更新在运行的系统中更改镜像其他版本中的密码。使用蓝图创建的用户必须仅用于获得对创建的系统的访问权限。访问系统后，您需要创建用户，例如，使用 `useradd` 命令。 				

​					要为 RHEL for Edge Installer 镜像创建一个蓝图，请执行以下步骤： 			

**步骤**

1. ​							以 TOML 格式创建一个纯文本文件，其内容如下： 					

   

   ```none
   name = "blueprint-installer"
   description = "blueprint-for-installer-image"
   version = "0.0.1"
   
   [[customizations.user]]
   name = "user"
   description = "account"
   password = "user-password"
   key = "user-ssh-key "
   home = "path"
   groups = ["user-groups"]
   ```

   ​							其中, 					

   - ​									*blueprint-name* 是名称，print-text-description 是您的蓝图的描述。 							
   - ​									*0.0.1* 是 Semantic Versioning 方案的版本号。 							

2. ​							将蓝图推送（导入）到镜像构建器服务器： 					

   

   ```none
   # composer-cli blueprints push blueprint-name.toml
   ```

3. ​							列出现有的蓝图，以检查创建的蓝图是否已成功推送并存在。 					

   

   ```none
   # composer-cli blueprints show blueprint-name
   ```

4. ​							检查蓝图中列出的组件和版本是否有效： 					

   

   ```none
   # composer-cli blueprints depsolve blueprint-name
   ```

**其他资源**

- ​							[支持的镜像自定义](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html-single/composing_installing_and_managing_rhel_for_edge_images/index#image-customizations_composing-a-rhel-for-edge-image-using-image-builder-command-line). 					

### 5.2.3. 使用镜像构建器 CLI 创建 RHEL for Edge 容器镜像

​					要使用镜像构建器命令行界面创建 RHEL for Edge 容器镜像，请确保您满足以下先决条件，并按照流程操作。 			

**先决条件**

- ​							您已为 RHEL for Edge 容器镜像创建了一个蓝图。 					

**步骤**

1. ​							创建 RHEL for Edge 容器镜像。 					

   

   ```none
   # composer-cli compose start-ostree --ref rhel/9/x86_64/edge --url URL-OSTree-repository blueprint-name image-type
   ```

   ​							其中, 					

   - ​									`--ref` 与用来构建 ostree 存储库的值相同 							

   - ​									`--url` 是要嵌入到镜像中的提交的 OSTree 存储库的 URL。例如：http://10.0.2.2:8080/repo/。默认情况下，RHEL for Edge 容器镜像的存储库文件夹为 "/repo"。请参阅 [设置 web 服务器以安装 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images#setting-up-a-web-server-to-install-rhel-for-edge-image_installing-rpm-ostree-images)。 							

     ​									要查找要使用的正确 URL，请访问正在运行的容器并检查 `nginx.conf` 文件。要查找要使用哪个 URL，请访问正在运行的容器并检查 `nginx.conf` 文件。在 `nginx.conf` 文件中，找到 `root` 目录条目，以搜索 `/repo/` 文件夹信息。请注意，如果您在使用镜像构建器创建 RHEL for Edge 容器镜像 `(.tar)` 时没有指定存储库 URL，则会在 'nginx.conf' 文件中创建默认的 `/repo/` 条目。 							

   - ​									*blueprint-name* 是 RHEL for Edge 蓝图名称。 							

   - ​									*image-type* 是用于**非基于网络的部署**的 `edge-container`。 							

     ​									这时将显示一个确认已添加到队列中的 composer 进程。它还显示创建的镜像的通用唯一标识符 (UUID) 号。使用 UUID 号来跟踪构建。另外，记录 UUID 号以易于执行进一步的任务。 							

2. ​							检查镜像 compose 状态。 					

   

   ```none
   # composer-cli compose status
   ```

   ​							输出以以下格式显示状态： 					

   

   ```none
   <UUID> RUNNING date blueprint-name blueprint-version image-type
   ```

   注意

   ​								镜像创建过程需要 20 分钟才能完成。 						

   ​							要中断镜像创建过程，请运行： 					

   

   ```none
   # composer-cli compose cancel <UUID>
   ```

   ​							要删除现有镜像，请运行： 					

   

   ```none
   # composer-cli compose delete <UUID>
   ```

   ​							镜像就绪后，它可用于**非网络部署**。请参阅[为非基于网络的部署创建 RHEL for Edge 容器镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#building-a-rhel-for-edge-container-commit-for-non-network-based-deployments_assembly_deploying-a-non-network-rhel-for-edge-image)。 					

**其他资源**

- ​							[使用镜像构建器命令行制作 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-a-rhel-for-edge-image-using-image-builder-command-line_composing-installing-managing-rhel-for-edge-images) 					

### 5.2.4. 使用命令行界面为非网络部署创建 RHEL for Edge 安装程序镜像

​					要使用镜像构建器命令行界面创建嵌入 `OSTree` 提交的 RHEL for Edge Installer 镜像，请确保您满足以下先决条件，然后按照流程操作。 			

**先决条件**

- ​							您已为 RHEL for Edge Installer 镜像创建了蓝图。 					
- ​							您已创建了 RHEL for Edge Container 镜像，并使用 web 服务器进行部署。 					

**步骤**

1. ​							开始创建 RHEL for Edge Installer 镜像。 					

   

   ```none
   # composer-cli compose start-ostree --ref rhel/9/x86_64/edge --url URL-OSTree-repository blueprint-name image-type
   ```

   ​							其中, 					

   - ​									*ref* 与用于构建 ostree 存储库的客户的值相同 							

   - ​									*URL-OSTree-repository* 是要嵌入到镜像中的提交 OSTree 存储库的 URL。例如：http://10.0.2.2:8080/repo。请参阅[为非基于网络的部署创建 RHEL for Edge 容器镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/assembly_deploying-a-non-network-rhel-for-edge-image_composing-installing-managing-rhel-for-edge-images#building-a-rhel-for-edge-container-commit-for-non-network-based-deployments_assembly_deploying-a-non-network-rhel-for-edge-image)。 							

   - ​									*blueprint-name* 是 RHEL for Edge Installer 蓝图名称。 							

   - ​									*image-type* 是 `edge-installer`。 							

     ​									这时将显示一个确认已添加到队列中的 composer 进程。它还显示创建的镜像的通用唯一标识符 (UUID) 号。使用 UUID 号来跟踪构建。另外，记录 UUID 号以易于执行进一步的任务。 							

2. ​							检查镜像 compose 状态。 					

   

   ```none
   # composer-cli compose status
   ```

   ​							命令输出以以下格式显示状态： 					

   

   ```none
   <UUID> RUNNING date blueprint-name blueprint-version image-type
   ```

   注意

   ​								完成镜像创建过程需要几分钟时间。 						

   ​							要中断镜像创建过程，请运行： 					

   

   ```none
   # composer-cli compose cancel <UUID>
   ```

   ​							要删除现有镜像，请运行： 					

   

   ```none
   # composer-cli compose delete <UUID>
   ```

   ​							镜像就绪后，您可以将它用于**非网络部署**。请参阅[为非基于网络的部署安装 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/assembly_deploying-a-non-network-rhel-for-edge-image_composing-installing-managing-rhel-for-edge-images#installing-the-rhel-for-edge-image-for-non-network-based-deployments_assembly_deploying-a-non-network-rhel-for-edge-image)。 					

### 5.2.5. 使用镜像构建器 CLI 下载 RHEL for Edge Installer 镜像

​					要使用镜像构建器命令行界面下载 RHEL for Edge Installer 镜像，请确保您满足以下先决条件，然后按照流程操作。 			

**先决条件**

- ​							您已创建了 RHEL for Edge Installer 镜像。 					

**步骤**

1. ​							查看 RHEL for Edge 镜像状态。 					

   

   ```none
   # composer-cli compose status
   ```

   ​							输出必须显示以下内容： 					

   

   ```none
   $ <UUID> FINISHED date blueprint-name blueprint-version image-type
   ```

2. ​							下载镜像。 					

   

   ```none
   # composer-cli compose image <UUID>
   ```

   ​							镜像构建器将镜像作为 `.iso` 文件下载到当前目录。 					

   ​							UUID 号和镜像大小会同时显示。 					

   

   ```none
   $ <UUID>-boot.iso: size MB
   ```

​					生成的镜像是可引导 ISO 镜像。 			

**其他资源**

- ​							[在非基于网络的环境中部署 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html-single/composing_installing_and_managing_rhel_for_edge_images/index#assembly_deploying-a-non-network-rhel-for-edge-image_composing-installing-managing-rhel-for-edge-images)。 					

## 5.3. 支持的镜像自定义

​				您可以通过启用服务或自定义内核命令行参数来在蓝图中添加额外的 RPM 软件包来自定义镜像。您可以在蓝图中使用多个镜像自定义。要使用这些选项，您必须在蓝图中配置自定义，并将其导入(push)到镜像构建器。 		

注意

​					在 web 控制台中使用镜像构建器时，不支持这些自定义。 			

- 选择软件包组

  `[[packages]] name = "*package_group_name*"` 						将 "*package_group_name*" 替换为组的名称。例如："@server with gui"。 					

- 设置镜像主机名

  `[customizations] hostname = "*baseimage*"`

- 生成系统镜像的用户规范

  `[[customizations.user]] name = "*USER-NAME*" description = "*USER-DESCRIPTION*" password = "*PASSWORD-HASH*" key = "*PUBLIC-SSH-KEY*" home = "/home/*USER-NAME*/" shell = "*/usr/bin/bash*" groups = [*"users", "wheel"*] uid = *NUMBER* gid = *NUMBER*` 						GID 是可选的，且必须已存在于镜像中。（可选）软件包创建它，或者蓝图使用 `[[customizations.group]` 条目创建 GID。 					重要 							要生成 `密码哈希`，您必须在系统上安装 **python3**。 						`# dnf install python3` 						将 *PASSWORD-HASH* 替换为实际的 `密码哈希`。要生成 `密码哈希`，请使用如下命令： 					`$ python3 -c 'import crypt,getpass;pw=getpass.getpass();print(crypt.crypt(pw) if (pw==getpass.getpass("Confirm: ")) else exit())'` 						将 *PUBLIC-SSH-KEY* 替换为实际公钥。 					 						使用适当的值替换其他占位符。 					 						您必须输入 `name`。您可以省略您不需要的任何行。 					 						为每个要包含的用户重复这个块。 					

- 生成系统镜像的组规范

  `[[customizations.group]] name = "*GROUP-NAME*" gid = *NUMBER*` 						为每个组重复此块。 					

- 设置现有的用户 SSH 密钥

  `[[customizations.sshkey]] user = "*root*" key = "*PUBLIC-SSH-KEY*"`注意 							"设置现有用户 SSH 密钥"自定义仅适用于现有用户。要创建用户并设置 SSH 密钥，请参阅 **生成的系统镜像的用户规格** 自定义。 						

- 在默认值中附加一个内核引导参数选项

  `[customizations.kernel] append = "*KERNEL-OPTION*"`

- 默认情况下，镜像构建器将默认内核构建到镜像中。但是，您可以使用蓝图中的以下配置自定义内核

  `[customizations.kernel] name = "*KERNEL-rt*"`

- 定义要在镜像中使用的内核名称

  `[customizations.kernel.name] name = "*KERNEL-NAME*"`

- 为生成的系统镜像设置时区和 *网络时间协议* **(NTP)** 服务器

  `[customizations.timezone] timezone = "*TIMEZONE*" ntpservers = "*NTP_SERVER*"` 						如果您没有设置时区，系统将默认使用 *Universal Time, Coordinated* **（UTC）**。设置 NTP 服务器是可选的。 					

- 为生成的系统镜像设置区域设置

  `[customizations.locale] languages = *["LANGUAGE"]* keyboard = "*KEYBOARD*"` 						设置语言和键盘选项是必需的。您可以添加许多其他语言。您添加的第一个语言是主要语言，其他语言为次要语言。例如： 					`[customizations.locale] languages = ["en_US.UTF-8"] keyboard = "us"` 						要列出语言支持的值，请运行以下命令： 					`$ localectl list-locales` 						要列出键盘支持的值，请运行以下命令： 					`$ localectl list-keymaps`

- 为生成的系统镜像设置防火墙

  `[customizations.firewall] port = *["PORTS"]*` 						要启用列表，您可以使用数字端口或 `/etc/services` 文件中的名称。 					

- 自定义防火墙服务

  ​							查看可用的防火墙服务。 					`$ firewall-cmd --get-services` 						在蓝图中，在 `customs.firewall.service` 部分下指定要自定义的防火墙服务。 					`[customizations.firewall.services] enabled = *["SERVICES"]* disabled = *["SERVICES"]*` 						`firewall.services` 中列出的服务与 `/etc/services` 文件中提供的服务名称不同。 					注意 							如果您不想自定义防火墙服务，请省略蓝图中的 `[customizations.firewall]` 和 `[customizations.firewall.services]` 部分。 						

- 设置在引导时要启用哪个服务

  `[customizations.services] enabled = *["SERVICES"]* disabled = *["SERVICES"]*` 						您可以控制在引导期间要启用哪些服务。有些镜像类型已经启用或禁用了服务，以确保镜像正常工作，此设置无法被覆盖。蓝图中的 `[customizations.services]` 自定义不会替换这些服务，但会将它们添加到镜像模板中已存在的服务列表中。 					注意 							每次构建启动时，它都会克隆主机系统的存储库。如果您引用具有大量历史记录的存储库，则可能需要一些时间来克隆，并且其使用大量的磁盘空间。另外，克隆是临时的，构建会在创建 RPM 软件包后将其删除。 						

- 指定自定义文件系统配置

  ​							您可以在蓝图中指定自定义的文件系统配置，因此可以使用特定的磁盘布局创建镜像，而不是默认的布局配置。通过使用蓝图中的非默认布局配置，您可以受益于： 					 								安全基准合规性 							 								防止磁盘不足错误 							 								提高了性能 							 								与现有设置的一致性 							 								要在蓝图中自定义文件系统配置： 							`[[customizations.filesystem]] mountpoint = *"MOUNTPOINT"* size = *MINIMUM-PARTITION-SIZE*` 								蓝图支持以下 `挂载点` 及其子目录： 							 										`/` - root 挂载点 									 										`/var` 									 										`/home` 									 										`/opt` 									 										`/srv` 									 										`/usr` 									 										`/app` 									 										`/data` 									 										`/boot` - 从 RHEL 8.7 和 RHEL 9.1 开始支持。 									注意 											仅从 RHEL 8.5 和 RHEL 9.0 发行版起支持使用 CLI 自定义挂载点。在之前的发行版本中，您可以只将 `root` 分区指定为挂载点，并将 `size` 参数指定为镜像大小的别名。 										 										如果您在自定义镜像中有多个分区，您可以在 LVM  上创建带有自定义文件系统分区的镜像，并在运行时调整这些分区大小。要做到这一点，您可以在蓝图中指定自定义文件系统配置，因此可以创建具有所需磁盘布局的镜像。默认文件系统布局保持不变 - 如果您使用没有文件系统自定义的普通镜像，`cloud-init` 会调整 root 分区的大小。 									注意 											从 8.6 开始，对于 `osbuild-composer-46.1-1.el8` RPM 及更新的版本，物理分区不再可用，文件系统自定义会创建逻辑卷。 										 										蓝图自动将文件系统自定义转换为 LVM 分区。 									 										`MINIMUM-PARTITION-SIZE` 值没有默认大小格式。蓝图自定义支持以下值和单位：kB 到 TB 和 KiB 到 TiB。例如，您可以以字节为单位定义挂载点大小： 									`[[customizations.filesystem]] mountpoint = "/var" size = 1073741824` 										您也可以使用单位定义挂载点大小。 									注意 											您只能使用为 RHEL 8.6 和 RHEL 9.0 后续发行版提供的软件包版本的单元来定义挂载点大小。 										 										例如： 									`[[customizations.filesystem]] mountpoint = "/opt" size = "20 GiB" or [[customizations.filesystem]] mountpoint = "/boot" size = "1 GiB"`

**其他资源**

- ​						[在添加文件系统自定义 "size" 后，蓝图导入会失败](https://access.redhat.com/solutions/6971352)。 				

## 5.4. 其他资源

- ​						[在 RHEL web 控制台中使用镜像构建器制作 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console_composing-installing-managing-rhel-for-edge-images)。 				

# 第 6 章 构建简化的安装程序镜像以置备 RHEL for Edge 镜像

​			您可以构建 RHEL for Edge Simplified Installer 镜像，该镜像针对以无人值守的形式在设备中安装进行了优化，并将镜像置备到 RHEL for Edge 镜像。 	

## 6.1. 简化的安装程序镜像构建和部署

​				使用新镜像类型 `edge-simplified-installer` 构建 RHEL for Edge Simplified Installer 镜像。 		

​				要构建 RHEL for Edge Simplified Installer 镜像，请提供现有的 `OSTree` 提交。生成的简化镜像包含部署了 OSTree 提交的原始镜像。引导简化的安装程序 ISO 镜像后，它提供边缘系统的 RHEL ，您可以在硬盘上使用它，也可以在虚拟机中用作引导镜像。 		

​				RHEL for Edge Simplified Installer 镜像针对以无人值守的方式在设备中安装进行了优化，并支持基于网络的部署和非基于网络的部署。但是，对于基于网络的部署，它只支持 UEFI HTTP 引导。 		

​				制作并部署简化的 RHEL for Edge 镜像涉及以下高级别的步骤： 		

1. ​						安装并注册 RHEL 系统 				
2. ​						安装镜像构建器 				
3. ​						使用镜像构建器，为 RHEL for Edge 容器镜像创建带有自定义的蓝图 				
4. ​						在镜像构建器中导入 RHEL for Edge 蓝图 				
5. ​						创建嵌入在 OCI 容器中的 RHEL for Edge 镜像，其中包含 webserver 可将提交部署为 OSTree 存储库 				
6. ​						为 `edge-simplified-installer` 创建一个蓝图 				
7. ​						构建一个简化的 RHEL for Edge 镜像 				
8. ​						下载 RHEL for Edge 简化镜像 				
9. ​						使用 virt-install 安装原始镜像 				

​				下图显示了 RHEL for Edge Simplified 的构建与置备工作流： 		

图 6.1. 在基于网络的环境中构建并置备 RHEL for Edge

[![RHEL for Edge Simplified 的工作流](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/c30b3cddb9768927f71a93631132b1aa/RHEL_for_Edge_simplified_workflow.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/c30b3cddb9768927f71a93631132b1aa/RHEL_for_Edge_simplified_workflow.png)

## 6.2. 使用镜像构建器 CLI 为简化的镜像创建蓝图

​				要为简化的 RHEL for Edge 镜像创建一个蓝图，请执行以下步骤： 		

**步骤**

1. ​						以 Tom’s Obvious, Minimal Language (TOML) 格式创建一个纯文本文件，其内容如下： 				

   

   ```none
   name = "simplified-installer-blueprint"
   description = "blueprint for the simplified installer image"
   version = "0.0.1"
   packages = []
   modules = []
   groups = []
   distro = ""
   
   [customizations]
   installation_device = "/dev/vda"
   
   [customizations.fdo]
   manufacturing_server_url = "http://10.0.0.2:8080"
   diun_pub_key_insecure = "true"
   ```

   ​						其中, 				

   - ​								*name* 是蓝图的名称，*description* 是蓝图的描述信息。 						
   - ​								*0.0.1* 是 Semantic Versioning 方案的版本号。 						
   - ​								*模块* 描述了要安装到镜像中的软件包名称和匹配版本的 glob，例如：软件包名称 = "tmux"，匹配的版本 glob 是 version = "2.9a"。请注意，目前软件包和模块之间没有区别。 						
   - ​								*组*是要安装到镜像中的软件包组，如 `anaconda-tools` 组软件包。如果您不知道模块和组，请将其留空。 						
   - ​								*Installation-device* 是自定义的，可对您的设备进行无人值守安装。 						
   - ​								*manufacturing_server_url* 是执行初始设备凭证交换的 URL。 						

2. ​						将蓝图推送（导入）到镜像构建器服务器： 				

   

   ```none
   # composer-cli blueprints push blueprint-name.toml
   ```

3. ​						列出现有的蓝图，以检查创建的蓝图是否已成功推送并存在。 				

   

   ```none
   # composer-cli blueprints show blueprint-name
   ```

4. ​						检查蓝图中列出的组件和版本是否有效： 				

   

   ```none
   # composer-cli blueprints depsolve blueprint-name
   ```

**其他资源**

- ​						[使用镜像构建器命令行制作 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-a-rhel-for-edge-image-using-image-builder-command-line_composing-installing-managing-rhel-for-edge-images)。 				

## 6.3. 使用镜像构建器 CLI 创建 RHEL for Edge Simplified Installer 镜像

​				要使用镜像构建器命令行界面创建 RHEL for Edge Simplified 镜像，请确保您满足以下先决条件，然后按照流程操作。 		

**先决条件**

- ​						为 RHEL for Edge Simplified 的镜像创建了蓝图。 				
- ​						您提供提交的 OSTree 存储库来嵌入镜像中。例如：http://10.0.2.2:8080/repo。请参阅 [设置 web 服务器以安装 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images#setting-up-a-web-server-to-install-rhel-for-edge-image_installing-rpm-ostree-images)。 				

**步骤**

1. ​						创建可引导 ISO 镜像。 				

   

   ```none
   # composer-cli compose start-ostree \
   blueprint-name \
   edge-simplified-installer \
   --ref rhel/9/x86_64/edge \
   --url URL-OSTree-repository \
   ```

   ​						其中, 				

   - ​								`blueprint-name` 是 RHEL for Edge 蓝图名称。 						

   - ​								`edge-simplified-installer` 是镜像类型。 						

   - ​								`--ref` 指定创建您的提交的位置的引用。 						

   - ​								`--url` 是要嵌入到镜像中的提交的 OSTree 存储库的 URL。例如：http://10.0.2.2:8080/repo/。您可以启动一个 RHEL for Edge Container，或设置 web 服务器。请参阅[为非基于网络的部署创建 RHEL for Edge 容器镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/assembly_deploying-a-non-network-rhel-for-edge-image_composing-installing-managing-rhel-for-edge-images#building-a-rhel-for-edge-container-commit-for-non-network-based-deployments_assembly_deploying-a-non-network-rhel-for-edge-image)，以及[设置 web 服务器来安装 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images#setting-up-a-web-server-to-install-rhel-for-edge-image_installing-rpm-ostree-images)。 						

     ​								这时将显示一个确认已添加到队列中的 composer 进程。它还显示创建的镜像的通用唯一标识符 (UUID) 号。使用 UUID 号来跟踪构建。另外，记录 UUID 号以易于执行进一步的任务。 						

2. ​						检查镜像 compose 状态。 				

   

   ```none
   # composer-cli compose status
   ```

   ​						输出以以下格式显示状态： 				

   

   ```none
   <UUID> RUNNING date blueprint-name blueprint-version image-type
   ```

   注意

   ​							镜像创建过程可能需要最多十分钟才能完成。 					

   ​						要中断镜像创建过程，请运行： 				

   

   ```none
   # composer-cli compose cancel <UUID>
   ```

   ​						要删除现有镜像，请运行： 				

   

   ```none
   # composer-cli compose delete <UUID>
   ```

**其他资源**

- ​						[使用镜像构建器命令行制作 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-a-rhel-for-edge-image-using-image-builder-command-line_composing-installing-managing-rhel-for-edge-images)。 				

## 6.4. 使用镜像构建器命令行界面下载简化的 RHEL for Edge 镜像

​				要使用镜像构建器命令行界面下载 RHEL for Edge 镜像，请确保您满足以下先决条件，然后按照流程操作。 		

**先决条件**

- ​						您已创建了 RHEL for Edge 镜像。 				

**步骤**

1. ​						查看 RHEL for Edge 镜像状态。 				

   

   ```none
   # composer-cli compose status
   ```

   ​						输出必须显示以下内容： 				

   

   ```none
   $ <UUID> FINISHED date blueprint-name blueprint-version image-type
   ```

2. ​						下载镜像。 				

   

   ```none
   # composer-cli compose image <UUID>
   ```

   ​						镜像构建器将镜像作为 `.iso` 文件下载到运行该命令的当前目录路径中 。 				

   ​						UUID 号和镜像大小会同时显示。 				

   

   ```none
   $ <UUID>-simplified-installer.iso: size MB
   ```

​				因此，您下载了一个 RHEL for Edge Simplified Installer ISO 镜像。您可以直接使用它作为引导 ISO 来安装 RHEL for Edge 系统。 		

## 6.5. 设置 UEFI HTTP 引导服务器

​				要建立 **UEFI HTTP Boot** 服务器，以便您可以通过连接到这个 UEFI HTTP Boot 服务器，通过网络开始提供 RHEL for Edge 虚拟机，请按照以下步骤执行： 		

**先决条件**

- ​						您已创建了 ISO 简化的安装程序镜像。 				
- ​						提供 ISO 内容的 http 服务器。 				

**步骤**

1. ​						将 ISO 镜像推送到您选择的目录中： 				

   

   ```none
   # mkdir /mnt/rhel9-install/
   # mount -o loop,ro -t iso9660 /path_directory/installer.iso /mnt/rhel9-install/
   ```

   ​						使用 RHEL for Edge 可引导 ISO 镜像的路径替换 `/path_directory/installer.iso`。 				

2. ​						将挂载镜像中的文件复制到 HTTP 服务器 root 中。这个命令创建包含镜像内容的 `/var/www/html/rhel9-install/` 目录。 				

   

   ```none
   # mkdir /var/www/html/httpboot/
   # cp -R /mnt/rhel9-install/* /var/www/html/httpboot/
   # chmod -R +r /var/www/html/httpboot/*
   ```

   注意

   ​							某些复制方法可以跳过 `.treeinfo` 文件（一个有效的安装源需要这个文体） 。对于整个目录运行 `cp` 命令，如此过程所示，可正确复制 `.treeinfo`。 					

3. ​						更新 `/var/www/html/EFI/BOOT/grub.cfg` 文件： 				

   1. ​								`coreos.inst.install_dev=/dev/sda` with `coreos.inst.install_dev=/dev/vda` 						

   2. ​								使用 `linuxefi /images/pxeboot/vmlinuz` 替换 `linux /images/pxeboot/vmlinuz` 						

   3. ​								使用 `initrdefi /images/pxeboot/initrd.img` 替换 `initrd /images/pxeboot/initrd.img` 						

   4. ​								使用 `coreos.inst.image_url=http://{IP-ADDRESS}/disk.img.xz` 替换 `coreos.inst.image_file=/run/media/iso/disk.img.xz`。 						

      ​								*IP-ADDRESS* 是该计算机的 ip 地址，它将充当 http 引导服务器。 						

4. ​						启动 httpd 服务： 				

   

   ```none
   # systemctl start httpd.service
   ```

   ​						因此，在设置 **UEFI HTTP 引导**服务器后，您可以使用 **UEFI HTTP** 引导安装 RHEL for Edge 设备。 				

## 6.6. 在虚拟机中部署简化的 ISO 镜像

​				使用以下安装源创建 RHEL for Edge Simplified 镜像，以此部署您生成的 RHEL for Edge ISO 镜像： 		

- ​						**UEFI HTTP 引导** 				
- ​						**virt-install** 				

​				本例演示了如何从 ISO 镜像为**基于网络的**安装创建 **virt-install** 安装源。 		

**先决条件**

- ​						您已创建了 ISO 镜像。 				
- ​						您可以设置网络配置来支持 UEFI HTTP 引导。 				

**步骤**

1. ​						设置网络配置以支持 **UEFI HTTP** 引导。请参阅[使用 libvirt 设置 UEFI HTTP 引导](https://www.redhat.com/sysadmin/uefi-http-boot-libvirt)。 				

2. ​						使用 `virt-install` 命令从 UEFI HTTP 引导创建 RHEL for Edge 虚拟机。 				

   

   ```none
   # virt-install \
       --name edge-install-image \
       --disk path=”  “, ,format=qcow2
       --ram 3072 \
       --memory 4096 \
       --vcpus 2 \
       --network network=integration,mac=mac_address \
       --os-type linux
       --os-variant rhel9 \
       --cdrom "/var/lib/libvirt/images/”ISO_FILENAME"
       --boot uefi,loader_ro=yes,loader_type=pflash,nvram_template=/usr/share/edk2/ovmf/OVMF_VARS.fd,loader_secure=no
       --virt-type kvm \
       --graphics none \
        --wait=-1
        --noreboot
   ```

​				运行命令后，虚拟机安装将启动。 		

**验证**

- ​						登录到创建的虚拟机。 				

## 6.7. 从 USB 闪存驱动器部署简化的 ISO 镜像

​				使用 **USB 安装**创建 RHEL for Edge Simplified 镜像，从而部署您生成的 RHEL for Edge ISO 镜像。 		

​				本例演示了如何从 ISO 镜像创建 **USB 安装**源。 		

**先决条件**

- ​						您已创建了简化的安装程序镜像，该镜像是 ISO 镜像。 				
- ​						您有一个 8 GB USB 闪存。 				

**步骤**

1. ​						将 ISO 镜像文件复制到 USB 闪存驱动器中。 				

2. ​						将 USB 闪存连接到您要引导的计算机的端口。 				

3. ​						从 USB 闪存驱动器引导 ISO 镜像。引导菜单显示以下选项： 				

   

   ```none
   Install Red Hat Enterprise Linux 9
   Test this media & install Red Hat Enterprise Linux 9
   ```

4. ​						选择安装 Red Hat Enterprise Linux 9。这将启动系统安装。 				

**其他资源**

- ​						[引导安装](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/performing_a_standard_rhel_9_installation/assembly_installing-on-amd64-intel-64-and-64-bit-arm_installing-rhel#booting-the-installer_assembly_installing-on-amd64-intel-64-and-64-bit-arm)。 				

# 第 7 章 使用 FDO 自动置备和注册 RHEL for Edge 设备

​			您可以构建 RHEL for Edge Simplified Installer 镜像，并将其置备为 RHEL for Edge 镜像。FIDO 设备加入(FDO)流程自动调配和板载您的边缘设备，并与网络连接的其他设备和系统交换数据。 	

重要

​				红帽提供了 `FDO` 流程作为技术预览功能，应在安全网络上运行。技术预览功能不受红帽产品服务等级协议（SLA）支持，且功能可能并不完整。这些技术预览功能可以使用户提早试用新的功能，并有机会在开发阶段提供反馈意见。如需有关 [技术预览功能支持范围](https://access.redhat.com/support/offerings/techpreview) 的信息，请参阅红帽客户门户网站中的技术预览功能支持范围。 		

## 7.1. FIDO 设备载入(FDO)进程

​				设备载入是以下进程： 		

- ​						提供和载入物理设备。 				
- ​						自动配置此设备的凭证。 				
- ​						允许此设备在网络上安全连接和交互。 				

​				使用 FIDO 设备载入(FDO)，您可以通过将新设备添加到 IOT  架构来执行安全的设备载入。这包括需要被信任并与其他正在运行的系统集成的指定的设备配置，以及要部署准备使用的新系统。FDO  身份验证是一个自动载入过程，由新设备的安装触发，以便安全地载入设备。FDO  协议可以解决信任和所有者链，以及大规模安全地载入设备所需的自动化。它会在制造阶段执行设备初始化，并为其实际使用执行后期设备绑定。这意味着，首先将设备绑定到管理系统的实际绑定会在设备第一次引导时进行。通过使用 FDO  协议，您可以支持自动的安全设备载入，即零接触安装，以及在边缘位置无需任何专业人员的载入。载入设备后，您可以连接到该设备，并应用补丁、更新和回滚。 		

​				有了 FDO，您可以从以下方面获益： 		

- ​						FDO 是向管理平台注册设备的一种安全、简单的方法。FDO 不是将 Kickstart 配置嵌入镜像中，而是应用自定义，如将敏感数据作为凭证、密钥或证书包含到 ISO 镜像中。 				
- ​						FDO 解决了之后绑定到设备的问题，使任何敏感数据可以通过安全的 FDO 通道共享。 				
- ​						FDO 口令在注册并将配置和其他 secret 传递给系统之前以加密方式识别系统身份和所有权。这可让非技术用户加电系统。 				

​				要构建 RHEL for Edge 简化的安装程序镜像并自动加入它，请提供现有的 OSTree 提交。生成的简化镜像包含部署了  OSTree 提交的原始镜像。引导简化的安装程序 ISO 镜像后，它提供边缘系统的 RHEL  ，您可以在硬盘上使用它，也可以在虚拟机中用作引导镜像。 		

​				RHEL for Edge Simplified Installer 镜像针对以无人值守的方式在设备中安装进行了优化，并支持基于网络的部署和非基于网络的部署。但是，对于基于网络的部署，它只支持 UEFI HTTP 引导。 		

​				FDO 协议基于以下服务器： 		

- ​						制造服务器 				

  ​						这个服务器位于制造服务器位置。制造服务器： 				

  1. ​								为设备签名。 						
  2. ​								在稍后的过程中，创建一个用来设置设备所有权的凭据。 						
  3. ​								将设备绑定到特定的管理平台。 						

- ​						Rendezvous 服务器 				

  ​						此服务器位于所有者服务器位置，或者位于设备管理系统将所在的平台，例如云。Rendezvous 服务器： 				

  1. ​								通过第一个设备引导过程中的制造服务器获取生成的凭据。 						
  2. ​								将设备 UUID 与目标平台匹配，并提供有关此设备必须使用的所有者服务器端点的信息。 						

- ​						所有者管理服务器 				

  ​						这个服务器位于所有者服务器位置，或者位于要部署设备的平台。所有者管理服务器： 				

  1. ​								在设备身份验证后，在设备和所有者服务器间创建一个安全通道。 						
  2. ​								使用安全通道来发送所需信息，如将自动化载入到设备的文件和脚本。 						

- ​						设备客户端 				

  ​						这是安装在服务器上的设备。设备客户端 				

  1. ​								将对要执行载入自动化的多个服务器启动查询。 						
  2. ​								使用 TCP/IP 协议与服务器进行通信。 						

​				下图代表 FIDO 设备加入工作流： 		

图 7.1. 在非网络环境中部署 RHEL for Edge

[![FDO 设备加入](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/aad63c45a51082e284eed7381872bf75/239_RHEL_for_Edge_FDO_0322.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/aad63c45a51082e284eed7381872bf75/239_RHEL_for_Edge_FDO_0322.png)

​				在 **制造服务器** 上，该设备获取 FDO 凭证、要安装在操作系统上的一组证书和密钥，以及 Rendezvous 服务器端点(URL)。它还会获得所有权凭据，在需要更改所有者分配时单独维护。 		

1. ​						设备客户端读取设备凭证 				

2. ​						设备客户端连接到网络 				

3. ​						早期，所有者管理系统会通知制造 Rendezvous 服务器有关所有者管理系统的位置 				

4. ​						连接到网络后，设备客户端会联系 Rendezvous 服务器 				

5. ​						Rendezvous 服务器向设备客户端发送所有者端点 URL ，并注册设备。这个操作会连接并启动设备。 				

6. ​						设备客户端连接到 Rendezvous 服务器共享的所有者管理系统，通过使用设备密钥签署声明来证明它是正确的设备 				

7. ​						所有者管理系统通过使用所有者凭证的最后密钥签署声明来证明自己 				

8. ​						所有者管理系统提供设备的配置，例如设备客户端存储在 SSH 密钥中 				

9. ​						设备客户端接收和验证所有权凭证 				

10. ​						然后，设备客户端会检索其设备凭证 				

11. ​						之后，所有者管理系统将设备客户端报告为已载入。 				

    ​						整个 FDO 进程已完成，不再在此设备中使用。 				

## 7.2. 自动置备和注册 RHEL for Edge 设备

​				自动置备和加入 RHEL for Edge 设备涉及以下高级别步骤： 		

1. ​						安装并注册 RHEL 系统 				

2. ​						安装镜像构建器 				

3. ​						使用镜像构建器，为 RHEL for Edge 容器镜像创建带有自定义的蓝图 				

4. ​						在镜像构建器中导入 RHEL for Edge 蓝图 				

5. ​						创建嵌入在 OCI 容器中的 RHEL for Edge 镜像，其中包含 webserver 可将提交部署为 OSTree 存储库 				

6. ​						使用存储设备路径的自定义和 FDO 自定义为 `edge-simplified-installer` 创建蓝图 				

   

   ```none
   name = "fdo"
   description = "FDO blueprint"
   version = "0.0.1"
   packages = []
   modules = []
   groups = []
   distro = ""
   
   [customizations]
   installation_device = "/dev/vda"
   
   [customizations.fdo]
   manufacturing_server_url = "http://10.0.0.2:8080"
   diun_pub_key_insecure = "true"
   ```

7. ​						构建简化的安装程序 RHEL for Edge 镜像 				

8. ​						下载 RHEL for Edge 简化的安装程序镜像 				

9. ​						将简化的安装程序 ISO 镜像安装到设备。FIDO FDO 客户端在简化的安装程序 ISO 上运行，UEFI 目录结构使镜像启动。 				

10. ​						网络配置可让设备连接到 manufacturing 服务器，以执行初始设备凭据交换。 				

11. ​						系统到达端点后，会为该设备创建设备凭据。 				

12. ​						板上的服务器使用设备凭证对服务器进行身份验证。加入服务器将配置传递给设备/系统：在系统连接到系统后，它会连接到其板载服务器，接收配置。 				

13. ​						加入服务器使用 SSH 密钥提供设备并安装系统。 				

14. ​						然后，它会重启系统并使用存储在 TPM 中的强大密钥对其进行加密。 				

15. ​						您可以使用您创建的蓝图中的凭证登录到系统，并检查在简化的安装程序 ISO 镜像中创建的配置。 				

**其他资源**

- ​						[FDO 自动加入技术](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#ref_fdo-automatic-onboarding-technologies_edge-terminology-and-commands) 				

## 7.3. 生成密钥和证书

​				要运行 FIDO 设备载入(FDO)基础架构，您需要生成密钥和证书。FDO 生成这些密钥和证书来配置生产服务器。在安装服务时，FDO 会自动生成证书和 `.yaml` 配置文件，重新创建它们是可选的。安装并启动服务后，它会使用默认设置运行。 		

重要

​					红帽提供了 `fdo-admin-tool generate-key-and-cert` 工具作为技术预览功能，并且应在安全网络上运行。技术预览功能不受红帽产品服务等级协议（SLA）支持，且功能可能并不完整。这些技术预览功能可以使用户提早试用新的功能，并有机会在开发阶段提供反馈意见。如需有关 [技术预览功能支持范围](https://access.redhat.com/support/offerings/techpreview) 的信息，请参阅红帽客户门户网站中的技术预览功能支持范围。 			

**先决条件**

- ​						您已安装了 `fdo-admin-cli` RPM 软件包 				

**步骤**

1. ​						为密钥和证书创建一个目录： 				

   

   ```none
   $ mkdir /etc/fdo/keys
   ```

2. ​						在您创建的目录中生成密钥和证书： 				

   

   ```none
   $ for i in "diun" "manufacturer" "device_ca" "owner"; do fdo-admin-tool generate-key-and-cert $i; done
   $ ls keys
   device_ca_cert.pem device_ca_key.der diun_cert.pem diun_key.der manufacturer_cert.pem manufacturer_key.der owner_cert.pem owner_key.der
   ```

   注意

   ​							如果您使用了源代码并编译了它，则正确的路径为 `./target/debug/fdo-admin-tool` 或 `./target/debug/fdo-admin-tool`，具体取决于您的构建选项。 					

3. ​						检查创建的密钥和证书： 				

   

   ```none
   $ tree keys
   ```

   ​						您可以看到以下输出： 				

   

   ```none
   – device_ca_cert.pem
   – device_ca_key.der
   – diun_cert.pem
   – diun_key.dre
   – manufacturer_cert.pem
   – manufacturer_key.der
   – owner_cert.pem
   – owner_key.pem
   ```

**其他资源**

- ​						`fdo-admin-tool generate-key-and-cert –help` 				

## 7.4. 安装 manufacturing 服务器软件包

​				`manufacturing server` RPM 软件包提供了凭据，以便安全地加入该设备。在设备安装期间，对 Rendezvous 服务器的 manufacturing 服务器请求，为服务器提供设备凭据身份验证，并将设备凭据安装到安装的系统中。 		

重要

​					红帽提供了 `fdo-manufacturing-server` 工具作为技术预览功能，应在安全网络上运行。技术预览功能不受红帽产品服务等级协议（SLA）支持，且功能可能并不完整。这些技术预览功能可以使用户提早试用新的功能，并有机会在开发阶段提供反馈意见。如需有关 [技术预览功能支持范围](https://access.redhat.com/support/offerings/techpreview) 的信息，请参阅红帽客户门户网站中的技术预览功能支持范围。 			

​				要安装 `manufacturing 服务器` RPM 软件包，请完成以下步骤： 		

**步骤**

1. ​						安装 `fdo-admin-cli` 软件包： 				

   

   ```none
   # dnf install -y fdo-admin-cli
   ```

2. ​						安装 `manufacturing server` RPM 软件包： 				

   

   ```none
   # dnf install fdo-manufacturing-server --refresh
   ```

3. ​						检查是否已正确安装了这些文件： 				

   

   ```none
   $ ls /usr/share/doc/fdo
   ```

   ​						您可以看到以下输出： 				

   

   ```none
   Output:
   manufacturing server.yml
   Owner-onboarding-server.yml
   rendezvous-server.yml
   ```

4. ​						可选：检查每个文件的内容，例如： 				

   

   ```none
   $ cat /usr/share/doc/fdo/manufacturing-server.yml
   ```

5. ​						配置 manufacturing 服务器。您必须提供以下： 				

   - ​								manufacturing 服务器 URL 						
   - ​								rendezvous 服务器的 IP 地址或 DNS 名称 						
   - ​								您生成的密钥和证书的路径。请参阅生成密钥和证书部分。 						

6. ​						将 RHEL for Edge 网络简化的镜像安装到您的设备后，请确保制造商服务器在 Podman 容器上运行。manufacturing 服务器负责在新设备上创建和启用设备凭据。 				

   

   ```none
   $ cat /usr/share/doc/fdo/manufacturing-server.yml
   ```

**其他资源**

- ​						[manufacturing-server.yml 示例](https://github.com/fedora-iot/fido-device-onboard-rs/blob/main/examples/config/manufacturing-server.yml) 				
- ​						[FDO 自动加入术语](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#ref_fdo-terminology_edge-terminology-and-commands) 				

## 7.5. 使用 FDO 身份验证自动加入 RHEL for Edge 设备

​				要准备好设备以自动加入 RHEL for Edge 设备，请完成以下步骤： 		

**先决条件**

- ​						您构建并提供 OSTree 容器。 				

- ​						设备组装并置备。这个示例使用虚拟机机器，但您可以在真实设备中使用它。 				

- ​						您正在运行 UEFI HTTP 引导服务器。 				

- ​						您已安装了 `fdo-manufacturing-server` RPM 软件包。运行： 				

  

  ```none
  # dnf install -y fdo-admin-cli
  ```

**步骤**

1. ​						使用 ISO 简化的镜像运行安装。您可以使用 CD-ROM 或 USB 闪存驱动器安装它，例如： 				

   ​						安装运行 ISO 简化的安装程序镜像，其中 FDO 客户端运行并且 UEFI 目录结构使镜像可以被启动，以刻录 ISO 中的原始镜像。 				

2. ​						通过终端验证设备已达到制造服务来执行初始设备凭证交换，并生成所有权凭据： 				

   

   ```none
   $ ls /etc/fdo/aio/stores/owner_vouchers
   ```

   ​						输出应显示 `ownership_voucher` ID，以指示添加到该设备中的正确设备凭据。 				

   ​						onboarding （加入）服务器使用设备凭据对服务器进行身份验证。然后，它会将配置传递给设备。设备从 onboarding  服务器接收配置后，它会接收 SSH 密钥并在设备上安装操作系统。最后，系统会自动重启，使用存储在 TPM 中的强大密钥对其进行加密。 				

   ​						设备自动重新启动后，设备联系加入服务器，并且 FDO 自动调配用户凭据。 				

**验证**

​					设备自动重启后，您可以使用您为蓝图创建的凭证登录到该设备。 			

1. ​						通过提供您为蓝图创建的用户名和密码登录到该设备。 				
2. ​						可选：验证在原始镜像中创建的配置。 				

**其他资源**

- ​						[设置 UEFI HTTP 引导服务器](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/building-and-provisioning-simplified-installer-images_composing-installing-managing-rhel-for-edge-images#setting-up-an-uefi-http-boot-server_building-and-provisioning-simplified-installer-images) 				
- ​						[从 USB 闪存驱动器部署简化的 ISO 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/building-and-provisioning-simplified-installer-images_composing-installing-managing-rhel-for-edge-images#deploying-the-simplified-iso-image-from-a-usb-flash-drive_building-and-provisioning-simplified-installer-images) 				

# 第 8 章 在网络基础环境中部署 RHEL for Edge 镜像

​			您可以使用 RHEL 安装程序图形用户界面或 Kickstart 文件部署 RHEL for Edge 镜像。部署 RHEL for Edge 镜像的整体流程取决于部署环境是基于网络的还是非基于网络的。 	

注意

​				要在裸机上部署镜像，请使用 Kickstart 文件。 		

**基于网络的部署**

​				在基于网络的环境中部署 RHEL for Edge 镜像涉及以下高级别步骤： 		

1. ​					提取镜像文件内容。 			
2. ​					设置 Web 服务器 			
3. ​					安装镜像 			

## 8.1. 提取 RHEL for Edge 镜像提交

​				下载提交后，提取 `.tar` 文件，并记下 ref 名称和提交 ID。 		

​				下载的提交文件由一个 `.tar` 文件和 `OSTree` 存储库组成。`OSTree` 存储库有一个提交和一个 `compose.json` 文件。 		

​				`compose.json` 文件包含与提交相关的信息（如 "Ref"、引用 ID 和提交 ID）的信息元数据。提交 ID 具有 RPM 软件包。 		

​				要提取软件包内容，请执行以下步骤： 		

**先决条件**

- ​						创建一个 Kickstart 文件或使用现有的文件。 				

**步骤**

1. ​						提取下载的镜像 `.tar` 文件： 				

   

   ```none
   # tar xvf <UUID>-commit.tar
   ```

2. ​						转到已提取 `.tar` 文件的目录。 				

   ​						它有一个 `compose.json` 文件和一个 OSTree 目录。`compose.json` 文件有提交号，`OSTree` 目录有 RPM 软件包。 				

3. ​						打开 `compose.json` 文件，再记下提交 ID 号。当您继续设置 Web 服务器时，您需要这个数字。 				

   ​						如果您安装了 `jq` JSON 处理程序，您还可以通过使用 `jq` 工具来检索提交 ID： 				

   

   ```none
   # jq '.["ostree-commit"]' < compose.json
   ```

4. ​						列出提交中的 RPM 软件包。 				

   

   ```none
   # rpm-ostree db list rhel/9/x86_64/edge --repo=repo
   ```

5. ​						使用 Kickstart 文件运行 RHEL 安装程序。另外，您可以使用任何现有的文件，或使用 Kickstart Generator 工具创建一个文件。 				

   ​						在 Kickstart 文件中，确保包含有关如何置备文件系统、创建用户以及如何获取和部署 RHEL for Edge 镜像的详细信息。RHEL 安装程序在安装过程中使用此信息。 				

   ​						以下是 Kickstart 文件示例： 				

   

   ```none
   lang en_US.UTF-8
   keyboard us
   timezone Etc/UTC --isUtc
   text
   zerombr
   clearpart --all --initlabel
   autopart
   reboot
   user --name=core --group=wheel
   sshkey --username=core "ssh-rsa AAAA3Nza…."
   rootpw --lock
   network --bootproto=dhcp
   
   ostreesetup --nogpg --osname=rhel --remote=edge --url=https://mirror.example.com/repo/ --ref=rhel/9/x86_64/edge
   ```

   ​						基于 OStree 的安装使用 `ostreesetup` 命令来设置配置。它使用以下标记获取 OSTree 提交： 				

   - ​								`--nogpg` - 禁用 GNU Privacy Guard (GPG)密钥验证。 						

   - ​								`--osname` - 操作系统安装的管理根。 						

   - ​								`--remote` - 操作系统安装的管理根 						

   - ​								`--url` - 要从中安装的存储库的 URL。 						

   - ​								`--ref` - 安装使用的存储库中的分支名称。 						

   - ​								`--URL=https://mirror.example.com/repo/` - 是您提取边缘提交并通过 `nginx` 提供服务的主机系统的地址。您可以使用该地址从客户机计算机访问主机系统。 						

     ​								例如，如果您在 `/var/www/html` 目录中提取了提交镜像，并在主机名为 `www.example.com` 的计算机上通过 `nginx` 提供提交服务，则 `--url` 参数的值为 `http://www.example.com/repo`。 						

     注意

     ​									使用 http 协议启动一个服务来提供提交，因为 Apache HTTP 服务器上没有启用 https。 							

**其他资源**

- ​						[下载 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-a-rhel-for-edge-image-using-image-builder-command-line_composing-installing-managing-rhel-for-edge-images#downloading-a-rhel-for-edge-image-using-the-command-line_composing-a-rhel-for-edge-image-using-image-builder-command-line) 				
- ​						[创建 Kickstart 文件](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/performing_an_advanced_rhel_9_installation/creating-kickstart-files_installing-rhel-as-an-experienced-user) 				

## 8.2. 设置 web 服务器以安装 RHEL for Edge 镜像

​				提取 RHEL for Edge 镜像内容后，设置一个 web 服务器，以使用 HTTP 向 RHEL 安装程序提供镜像提交详情。 		

​				下例提供了使用容器建立 Web 服务器的步骤。 		

**先决条件**

- ​						已在您的系统上安装了 Podman。请参阅 [如何在 RHEL 中安装 Podman](https://access.redhat.com/solutions/3650231) 				

**步骤**

1. ​						使用以下步骤创建 `nginx` 配置文件： 				

   

   ```none
   events {
   
   }
   
   http {
       server{
           listen 8080;
           root /usr/share/nginx/html;
                   }
            }
   
   pid /run/nginx.pid;
   daemon off;
   ```

2. ​						使用以下说明创建 Dockerfile： 				

   

   ```none
   FROM registry.access.redhat.com/ubi8/ubi
   RUN dnf -y install nginx && dnf clean all
   COPY kickstart.ks /usr/share/nginx/html/
   COPY repo /usr/share/nginx/html/
   COPY nginx /etc/nginx.conf
   EXPOSE 8080
   CMD ["/usr/sbin/nginx", "-c", "/etc/nginx.conf"]
   ARG commit
   ADD ${commit} /usr/share/nginx/html/
   ```

   ​						其中, 				

   - ​								`*Kickstart.ks*` 是 RHEL for Edge 镜像的 Kickstart 文件的名称。Kickstart 文件包含指令信息。为帮助您稍后管理镜像，建议包含 Greenboot 检查的检查和设置。因此，您可以更新 Kickstart 文件以含以下设置： 						

     

1. - ```none
     lang en_US.UTF-8
     keyboard us
     timezone Etc/UTC --isUtc
     text
     zerombr
     clearpart --all --initlabel
     autopart
     reboot
     user --name=core --group=wheel
     sshkey --username=core "ssh-rsa AAAA3Nza…."
     
     ostreesetup --nogpg --osname=rhel --remote=edge
     --url=https://mirror.example.com/repo/
     --ref=rhel/9/x86_64/edge
     
     %post
     cat << EOF > /etc/greenboot/check/required.d/check-dns.sh
     #!/bin/bash
     
     DNS_SERVER=$(grep nameserver /etc/resolv.conf | cut -f2 -d" ")
     COUNT=0
     
     # check DNS server is available
     ping -c1 $DNS_SERVER
     while [ $? != '0' ] && [ $COUNT -lt 10 ]; do
     
     							
     							
     							
     							
     							
     							COUNT++
     echo "Checking for DNS: Attempt $COUNT ."
     sleep 10
     ping -c 1 $DNS_SERVER
     done
     EOF
     %end
     ```

     ​								任何 HTTP 服务都可以托管 OSTree 存储库，而使用容器的示例只是如何执行此操作的一个选项。Dockerfile 执行以下任务： 						

     1. ​										使用最新的通用基础镜像(UBI) 								
     2. ​										安装 Web 服务器(nginx) 								
     3. ​										向服务器添加 Kickstart 文件 								
     4. ​										将 RHEL for Edge 镜像提交添加到服务器 								

2. ​						构建 Docker 容器 				

   

   ```none
   # podman build -t name-of-container-image --build-arg commit=uuid-commit.tar .
   ```

3. ​						运行容器 				

   

   ```none
   # podman run --rm -d -p port:8080 localhost/name-of-container-image
   ```

   ​						因此，服务器建立好了，可以通过使用 `commit.tar` 存储库和 Kickstart 文件来准备启动 RHEL 安装程序。 				

## 8.3. 下载 RHEL Boot.iso 镜像

​				您可以从红帽客户门户网站下载 Red Hat Boot ISO 镜像。Red Hat Boot ISO 镜像用于启动 RHEL 安装程序。安装程序会获取您提供的用于安装 RHEL for Edge 镜像的 Kickstart 文件。 		

**先决条件**

- ​						您有一个有效的红帽订阅。 				
- ​						您已登陆到红帽客户门户网站的产品下载部分，地址为 https://access.redhat.com/downloads。 				

**步骤**

1. ​						打开浏览器并访问 https://access.redhat.com/downloads。 				
2. ​						在 Infrastructure Management 下，点 `Red Hat Enterprise Linux 9` 产品。 				
3. ​						点击 "Red Hat Enterprise Linux 9 Boot ISO" 选项的 Download Now 按钮 				

**其他资源**

- ​						[下载 RHEL 安装 ISO 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/performing_a_standard_rhel_9_installation/downloading-a-specific-beta-iso-image_downloading-beta-installation-images)。 				

## 8.4. 使用 Kickstart 文件安装 RHEL for Edge 镜像

​				要安装使用 Kickstart 文件的 RHEL for Edge 镜像，请使用 web 服务器。web 服务器使用 RHEL for Edge 镜像 `提交.tar` 存储库和 Kickstart 文件来启动 RHEL 安装程序。 		

**先决条件**

- ​						在 RHEL 安装程序中获取提交的服务器可用且正在运行。 				
- ​						安装您创建的提交的 `.qcow2` 磁盘镜像。请参阅 [使用 CLI 中的镜像构建器创建系统镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_a_customized_rhel_system_image/index#creating-a-system-image-with-composer-in-the-command-line-interface_creating-system-images-with-composer-command-line-interface)。 				

**步骤**

1. ​						使用 `libvirt virt-install` 运行 RHEL Anaconda 安装程序： 				

   

   ```none
   virt-install \
   --name rhel-edge-test-1 \
   --memory 2048 \
   --vcpus 2 \
   --disk path=prepared_disk_image.qcow2,format=qcow2,size=8 \
   --os-variant rhel9 \
   --cdrom /home/username/Downloads/rhel-9-x86_64-boot.iso
   ```

2. ​						在安装屏幕中： 				

   图 8.1. Red Hat Enterprise Linux 引导菜单

   [![Red Hat Enterprise Linux 引导菜单](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/8f5c464e3fdb798e591185beecd98379/rhel-8.6-boot.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/8f5c464e3fdb798e591185beecd98379/rhel-8.6-boot.png)

   1. ​								按 e 键添加额外的内核参数： 						

      

      ```none
      inst.ks=http://edge_device_ip:port/kickstart.ks
      ```

      ​								kernel 参数指定您要使用 Kickstart 文件而不是 RHEL 安装程序中包含的 RHEL 镜像来安装 RHEL。 						

   2. ​								添加内核参数后，按 **Ctrl**+**X** 使用 Kickstart 文件引导 RHEL 安装。 						

      ​								RHEL 安装程序启动、从服务器 (HTTP) 端点获取 Kickstart 文件并执行命令，包括从 HTTP 端点安装 RHEL for Edge 镜像提交的 命令。安装完成后，RHEL 安装程序会提示您登录详情。 						

**验证**

1. ​						在登录屏幕中，输入您的用户帐户凭证并点 Enter。 				

2. ​						验证 RHEL for Edge 镜像是否已成功安装。 				

   

   ```none
   $ rpm-ostree status
   ```

   ​						命令输出提供镜像提交 ID，并显示安装成功。 				

   ​						以下是输出示例： 				

   

   ```none
   State: idle
   Deployments:
   * ostree://edge:rhel/9/x86_64/edge
   		  Timestamp: 2020-09-18T20:06:54Z
   			Commit: 836e637095554e0b634a0a48ea05c75280519dd6576a392635e6fa7d4d5e96
   ```

**其他资源**

- ​						[如何将 Kickstart 文件嵌入到 ISO 镜像中](https://access.redhat.com/solutions/60959)。 				
- ​						[引导安装](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html-single/performing_a_standard_rhel_8_installation/index#boot-menu_booting-the-installer)。 				

# 第 9 章 在非基于网络的环境中部署 RHEL for Edge 镜像

​			RHEL for Edge Container (`.tar`)与 RHEL for Edge Installer (`.iso`)镜像类型相结合将生成一个 ISO 镜像。ISO 镜像可以在镜像部署到设备过程中在断开连接的环境中使用。但是，网络访问可能需要网络访问权限来构建不同的工件。 	

​			在非网络环境中部署 RHEL for Edge 镜像涉及以下高级别步骤： 	

1. ​					下载 RHEL for Edge 容器。有关如何下载 RHEL for Edge 镜像的信息，请参阅 [下载 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console_composing-installing-managing-rhel-for-edge-images#downloading-a-rhel-for-edge-image_composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console) 。 			
2. ​					将 RHEL for Edge 容器镜像加载到 Podman 中 			
3. ​					在 Podman 中运行 RHEL for Edge 容器镜像 			
4. ​					加载 RHEL for Edge Installer 蓝图 			
5. ​					构建 RHEL for Edge 安装程序镜像 			
6. ​					准备一个 `.qcow2` 磁盘 			
7. ​					引导虚拟机 (VM) 			
8. ​					安装镜像 			

## 9.1. 为非网络部署创建 RHEL for Edge 容器镜像

​				您可以通过将下载的 RHEL for Edge Container OSTree 提交加载到 Podman 来构建正在运行的容器。为此，请按照以下步骤执行： 		

**先决条件**

- ​						您创建并下载了一个 RHEL for Edge Container OSTree 提交。 				
- ​						已在您的系统上安装了 `Podman`。请参阅 [如何在 RHEL 中安装 Podman](https://access.redhat.com/solutions/3650231)。 				

**步骤**

1. ​						进入您下载了 RHEL for Edge Container OSTree 提交的目录。 				

2. ​						将 RHEL for Edge 容器 OSTree 提交加载到 `Podman` 中。 				

   

   ```none
   $ sudo podman load -i UUID-container.tar
   ```

   ​						命令输出提供了镜像 ID，例如 `：@8e0d51f061ff1a51d157804362bc875b649b27f2ae1e66566a15e7e6530cec63` 				

3. ​						使用上一步中生成的镜像 ID，标记新的 RHEL for Edge 容器镜像。 				

   

   ```none
   $ sudo podman tag image-ID localhost/edge-container
   ```

   ​						`podman tag` 命令为本地镜像分配额外名称。 				

4. ​						运行名为 `edge-container` 的容器。 				

   

   ```none
   $ sudo podman run -d --name=edge-container -p 8080:8080 localhost/edge-container
   ```

   ​						`podman run -d --name=edge-container` 命令根据 `localhost/edge-container` 镜像将名称分配给容器。 				

5. ​						列出容器： 				

   

   ```none
   $ sudo podman ps -a
   CONTAINER ID  IMAGE                               	COMMAND	CREATED    	STATUS                	PORTS   NAMES
   2988198c4c4b  …./localhost/edge-container   /bin/bash  3 seconds ago  Up 2 seconds ago      	edge-container
   ```

​				因此，`Podman` 运行一个容器，它会使用一个带有 RHEL for Edge 容器提交的 OSTree 存储库。 		

## 9.2. 为非网络部署创建 RHEL for Edge 安装程序镜像

​				构建正在运行的容器来为带有 `RHEL for Edge Container` 提交的存储库提供服务后，创建一个 `RHEL for Edge Installer (.iso)` 镜像。`RHEL for Edge Installer (.iso)` 拉取 `RHEL for Edge Container (.tar)` 提供的提交。在 Podman 中载入 `RHEL for Edge Container` 提交后，它会以 URL 格式公开 `OSTree`。 		

​				要在 CLI 中创建 RHEL for Edge Installer 镜像，请按照以下步骤操作： 		

**先决条件**

- ​						为 RHEL for Edge 镜像创建了一个蓝图。 				
- ​						您创建了一个 RHEL for Edge Container 镜像，并使用 web 服务器部署。 				

**步骤**

1. ​						开始创建 RHEL for Edge Installer 镜像。 				

   

   ```none
   # composer-cli compose start-ostree --ref rhel/9/x86_64/edge --url URL-OSTree-repository blueprint-name image-type
   ```

   ​						其中, 				

   - ​								*ref* 与用于构建 ostree 存储库的客户的值相同 						

   - ​								*URL-OSTree-repository* 是要嵌入到镜像中的提交 OSTree 存储库的 URL。例如：http://10.0.2.2:8080/repo/。请参阅[为非基于网络的部署创建 RHEL for Edge 容器镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/assembly_deploying-a-non-network-rhel-for-edge-image_composing-installing-managing-rhel-for-edge-images#building-a-rhel-for-edge-container-commit-for-non-network-based-deployments_assembly_deploying-a-non-network-rhel-for-edge-image)。 						

   - ​								*blueprint-name* 是 RHEL for Edge Installer 蓝图名称。 						

   - ​								*image-type* 是 `edge-installer`。 						

     ​								这时将显示一个确认已添加到队列中的 composer 进程。它还显示创建的镜像的通用唯一标识符 (UUID) 号。使用 UUID 号来跟踪构建。另外，记录 UUID 号以易于执行进一步的任务。 						

2. ​						检查镜像 compose 状态。 				

   

   ```none
   # composer-cli compose status
   ```

   ​						命令输出以以下格式显示状态： 				

   

   ```none
   <UUID> RUNNING date blueprint-name blueprint-version image-type
   ```

   注意

   ​							完成镜像创建过程需要几分钟时间。 					

   ​						要中断镜像创建过程，请运行： 				

   

   ```none
   # composer-cli compose cancel <UUID>
   ```

   ​						要删除现有镜像，请运行： 				

   

   ```none
   # composer-cli compose delete <UUID>
   ```

   ​						镜像构建器在镜像构建过程中拉取由正在运行的容器提供的提交。 				

   ​						镜像构建完成后，您可以下载生成的 ISO 镜像。 				

3. ​						下载镜像。请参阅[下载 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-a-rhel-for-edge-image-using-image-builder-command-line_composing-installing-managing-rhel-for-edge-images#proc_downloading-a-rhel-for-edge-installer-image-using-the-image-builder-cli_composing-a-rhel-for-edge-image-using-image-builder-command-line)。 				

   ​						镜像就绪后，您可以将它用于**非网络部署**。请参阅[为非基于网络的部署安装 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/assembly_deploying-a-non-network-rhel-for-edge-image_composing-installing-managing-rhel-for-edge-images#installing-the-rhel-for-edge-image-for-non-network-based-deployments_assembly_deploying-a-non-network-rhel-for-edge-image)。 				

**其他资源**

- ​						[使用命令行界面为非基于网络的部署创建 RHEL for Edge 安装程序镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-a-rhel-for-edge-image-using-image-builder-command-line_composing-installing-managing-rhel-for-edge-images#creating-a-rhel-for-edge-installer-image-using-command-line-interface-for-non-network-based-deployments_composing-a-rhel-for-edge-image-using-image-builder-command-line)。 				

## 9.3. 为非网络部署安装 RHEL for Edge 镜像

​				要安装 RHEL for Edge 镜像，请按照以下步骤执行： 		

**先决条件**

- ​						您创建了 RHEL for Edge Installer ISO 镜像。 				

- ​						已停止运行的容器。 				

- ​						安装您创建的提交的磁盘镜像。 				

- ​						已安装 `edk2-ovmf` 软件包。 				

- ​						已安装 `virt-viewer` 软件包。 				

- ​						您可以使用用户帐户自定义您的蓝图。请参阅[为 RHEL for Edge 镜像蓝图创建管理用户帐户](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console_composing-installing-managing-rhel-for-edge-images#creating-an-administrative-user-account-for-a-rhel-for-edge-image-blueprint_composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console)。 				

  警告

  ​							如果您没有在蓝图中定义用户帐户自定义，您将无法登录到 ISO 镜像。 					

**步骤**

1. ​						创建 `qcow` VM 磁盘文件来安装 (.iso) 镜像。这是虚拟机 (VM) 的硬盘驱动器镜像。例如： 				

   

   ```none
   $ qemu-img create -f qcow2 diskfile.qcow2 20G
   ```

2. ​						使用 `virt-install` 命令，使用磁盘作为驱动器引导虚拟机，安装程序 ISO 作为 CD-ROM。例如： 				

   

   ```none
   $ virt-install \
   --boot uefi \
   --name VM_NAME
   --memory 2048 \
   --vcpus 2 \
   --disk path=diskfile.qcow2
   --cdrom /var/lib/libvirt/images/UUID-installer.iso \
   --os-variant rhel9.0
   ```

   ​						这个命令指示 `virt-install` 进行： 				

   - ​								指示虚拟机使用 UEFI 引导，而不是 BIOS。 						

   - ​								挂载安装 ISO。 						

   - ​								使用在第一步中创建的硬盘驱动器镜像。 						

     ​								它为您提供 Anaconda 安装程序。RHEL 安装程序启动，从 ISO 中加载 Kickstart 文件并执行命令，包括安装 RHEL for Edge 镜像提交的命令。安装完成后，安装程序会提示输入登录详细信息。 						

     注意

     ​									Anaconda 已预先配置为在安装过程中使用容器提交。但是，您需要在分区之间设置系统配置，如磁盘分区、时区等。 							

3. ​						使用 `virt-viewer` 连接到 Anaconda GUI 来设置系统配置： 				

   

   ```none
   $ virt-viewer --connect qemu:///system --wait VM_NAME
   ```

4. ​						重启系统以完成安装。 				

5. ​						在登录屏幕中，指定您的用户帐户凭证并点 Enter。 				

**验证步骤**

1. ​						验证 RHEL for Edge 镜像是否已成功安装。 				

   

   ```none
   $  rpm-ostree status
   ```

​				命令输出提供镜像提交 ID，并显示安装成功。 		

# 第 10 章 管理 RHEL for Edge 镜像

​			要管理 RHEL for Edge 镜像，您可以执行以下任何管理任务： 	

- ​					在 RHEL web 控制台中使用镜像构建器编辑 RHEL for Edge 镜像蓝图 			
- ​					使用镜像构建器命令行编辑 RHEL for Edge 镜像蓝图 			
- ​					更新 RHEL for Edge 镜像 			
- ​					在节点上配置 `rpm-ostree` 远程，以更新节点策略 			
- ​					手动恢复 RHEL for Edge 镜像，或使用 Greenboot 自动恢复镜像 			

## 10.1. 在 RHEL web 控制台中使用镜像构建器编辑 RHEL for Edge 镜像蓝图

​				您可以将 RHEL for Edge 镜像蓝图编辑为： 		

- ​						添加您可能需要的其他组件 				
- ​						修改任何现有组件的版本 				
- ​						删除任何现有组件 				

### 10.1.1. 在 RHEL web 控制台中使用镜像构建器向 RHEL for Edge 镜像蓝图中添加组件

​					要在 RHEL for Edge 镜像蓝图中添加组件，请确保您满足以下先决条件，然后按照步骤编辑对应的蓝图。 			

**先决条件**

- ​							在 RHEL 系统上，您已访问了镜像构建器仪表盘。 					
- ​							您已为 RHEL for Edge 镜像创建了蓝图。 					

**步骤**

1. ​							在镜像构建器仪表盘中，点击您要编辑的 RHEL for Edge 镜像蓝图。 					

   ​							要搜索特定蓝图，请在 Filter By Name 文本框中输入蓝图名称，然后按 Enter 键。 					

2. ​							在蓝图的右上角点 Edit Packages。 					

   ​							视图更改为 Edit Packages 模式。 					

3. ​							在 Filter By Name 文本框中输入您要添加的组件名称，然后按 Enter 键。 					

   ​							此时会显示组件名称的列表。 					

4. ​							单击组件旁边的 + 符号。 					

   ​							组件添加到蓝图中。 					

5. ​							点 Commit。 					

   ​							蓝图更新会被保存，并会显示一条消息待处理提交。 					

6. ​							在摘要对话框上，检查更改，然后单击 Commit。 					

   ​							这时将显示确认成功提交的消息。 					

   ​							因此，会创建一个新版本的蓝图，右侧窗格会列出最新的组件。 					

### 10.1.2. 使用 RHEL web 控制台更改 RHEL for Edge 镜像蓝图中现有组件的版本

​					您已选择默认 (最新) 版本，或为您包含在蓝图中的组件选择一个版本。如果需要，现在可以更改您可能想要的任何组件的版本。 			

​					为此，请确保您满足以下先决条件，然后按照以下步骤更改相应蓝图中的组件版本。 			

**先决条件**

- ​							在 RHEL 系统上，您已访问了镜像构建器仪表盘。 					
- ​							您已为 RHEL for Edge 镜像创建了蓝图。 					
- ​							您已在 RHEL for Edge 蓝图中添加至少一个组件。 					

**步骤**

1. ​							在镜像构建器仪表盘上，点击您要编辑的蓝图。 					

   ​							要搜索特定蓝图，请在 Filter By Name 文本框中输入蓝图名称，然后按 Enter 键。 					

2. ​							在蓝图的右上角点 Edit Packages。 					

   ​							视图中对 Edit Packages 模式的更改，右侧面板中列出了当前提交到蓝图的组件名称。 					

3. ​							点组件名称。 					

4. ​							从组件选项版本下拉列表中选择所需的版本。 					

5. ​							点 Apply Changes。 					

   ​							保存更改，右侧窗格列出最新的更改。 					

6. ​							点 Commit。 					

   ​							新版本保存在蓝图中。将显示含有待提交的消息。 					

7. ​							在摘要对话框上，检查更改，然后单击 Commit。 					

   ​							这时将显示确认成功提交的消息。 					

   ​							因此会创建一个新版本的蓝图，右侧窗格会列出最新的组件。 					

### 10.1.3. 在 RHEL web 控制台中使用镜像构建器从 RHEL for Edge 镜像蓝图中删除组件

​					要从您创建的 RHEL for Edge 镜像蓝图中删除一个或多个不需要的组件，请确保您满足以下先决条件，然后按照以下步骤操作。 			

**先决条件**

- ​							在 RHEL 系统上，您已访问了镜像构建器仪表盘。 					
- ​							您已为 RHEL for Edge 镜像创建了蓝图。 					
- ​							您已在 RHEL for Edge 蓝图中添加至少一个组件。 					

**步骤**

1. ​							在镜像构建器仪表盘上，点击您要编辑的蓝图。 					

   ​							要搜索特定蓝图，请在 Filter By Name 文本框中输入蓝图名称，然后按 Enter 键。 					

2. ​							在蓝图的右上角点 Edit Packages。 					

   ​							视图更改为 Edit Packages 模式。右侧面板列出了当前提交至蓝图的组件名称。 					

3. ​							在 More Options 菜单中点 Remove。 					

   ​							（可选）点组件名称，然后点 Remove。 					

4. ​							点 Commit。 					

   ​							将显示含有待提交的消息。 					

5. ​							检查您的更改，然后单击 Commit。 					

   ​							这时将显示确认成功提交的消息。 					

   ​							因此，会创建一个新版本的蓝图，右侧窗格会列出最新的组件。 					

### 10.1.4. 使用命令行界面编辑 RHEL for Edge 镜像蓝图

​					您可以使用镜像构建器命令行更改 RHEL for Edge 镜像蓝图的规格。为此，请确保您满足以下先决条件，然后按照步骤编辑对应的蓝图。 			

**先决条件**

- ​							您有访问镜像构建器命令行的权限。 					
- ​							您已创建了 RHEL for Edge 镜像蓝图。 					

**步骤**

1. ​							将蓝图保存（导出）到本地文本文件： 					

   

   ```none
   # composer-cli blueprints save BLUEPRINT-NAME
   ```

2. ​							使用您选择的文本编辑器编辑 `BLUEPRINT-NAME.toml` 文件并进行更改。 					

   ​							在完成编辑前，验证该文件是否为一个有效的蓝图： 					

3. ​							增加版本号。 					

   ​							确保您使用 Semantic Versioning 方案。 					

   注意

   ​								如果您不更改版本，则会自动增加版本的补丁组件。 						

4. ​							检查内容是否是有效的 TOML 规格。如需更多信息，请参阅 TOML 文档。 					

   注意

   ​								TOML 文档是一款社区产品，不受红帽支持。您可以在 https://github.com/toml-lang/toml/issues 中报告任何问题。 						

5. ​							保存文件并关闭编辑器。 					

6. ​							将蓝图推送（导入）回镜像构建器命令行中： 					

   

   ```none
   # composer-cli blueprints push BLUEPRINT-NAME.toml
   ```

   注意

   ​								将蓝图推送回镜像构建器命令行时，请提供包括 `.toml` 扩展名的文件名。 						

7. ​							验证上传到镜像构建器的内容是否与您的编辑匹配： 					

   

   ```none
   # composer-cli blueprints show BLUEPRINT-NAME
   ```

8. ​							检查蓝图中列出的组件和版本是否有效： 					

   

   ```none
   # composer-cli blueprints depsolve BLUEPRINT-NAME
   ```

## 10.2. 更新 RHEL for Edge 镜像

### 10.2.1. RHEL for Edge 镜像如何更新

​					使用 RHEL for Edge  镜像，您可以手动部署更新，也可以自动部署部署过程。更新以原子方式应用，其中知道每个更新的状态，更新仅在重启时暂存和应用。由于在重新引导设备之前不会看到任何更改，因此您可以调度重新引导以确保尽可能最高的正常运行时间。 			

​					在镜像更新过程中，只有更新的操作系统内容通过网络传输。与传输整个镜像相比，这可以使部署过程更有效率。`/usr` 中的操作系统二进制文件和库是 `只读的`，`/var` 和 `/etc` 目录保持 `读和写` 状态。 			

​					移至新部署时，`/etc` 和 `/var` 目录会复制到新部署中，具有 `读和写` 权限。`/usr` 目录作为软链接复制到新部署目录，具有 `只读` 权限。 			

​					下图演示了 RHEL for Edge 镜像更新部署过程： 			

[![镜像部署](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/fce86ffb0e9c5a01ceed74d72d223153/edge-os-upgrade.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/fce86ffb0e9c5a01ceed74d72d223153/edge-os-upgrade.png)

​					默认情况下，使用类似于 `chroot` 操作的流程引导新系统。新的 `/sysroot` 目录主要有以下部分： 			

- ​							位于 `/sysroot/ostree/repo` 目录中的存储库数据库。 					
- ​							位于 `/sysroot/ostree/deploy/rhel/deploy` 目录中的文件系统修订，其由系统更新中的每个操作创建。 					
- ​							`/sysroot/ostree/boot` 目录，它链接到在之前点上的部署。请注意，`/ostree` 是到 `/sysroot/ostree` 的软链接。`/sysroot/ostree/boot` 目录中的文件不会重复。如果部署期间文件没有改变，则使用同一文件。这些文件是硬链接到存储在 `/sysroot/ostree/repo/objects` 目录中的另一个文件。 					

​					操作系统使用以下方法选择部署： 			

1. ​							`dracut` 工具解析 `initramfs root` 文件系统中的 `ostree` 内核参数，并将 `/usr` 目录设置为 `只读` 绑定挂载。 					
2. ​							将 `/sysroot` 中的部署目录绑定到 `/` 目录。 					
3. ​							使用 `MS_MOVE` 挂载标志重新挂载已挂载 `dirs` 的操作系统 					

​					如果出现错误，您可以使用 `rpm-ostree` 清楚命令，通过删除旧部署来执行部署回滚。每个客户端机器都包含一个存储在 `/ostree/repo` 中的 `OSTree` 存储库，以及存储在 `/ostree/deploy/$STATEROOT/$CHECKSUM` 中的一组部署。 			

​					借助 RHEL for Edge 镜像中的部署更新，您可以从跨多个设备的更好的系统一致性、更容易的可重复性，以及系统状态更改前后之间更好的隔离中受益。 			

### 10.2.2. 手动部署 RHEL for Edge 镜像更新

​					编辑 RHEL for Edge 蓝图后，您可以更新镜像提交。镜像构建器为更新的 RHEL for Edge 镜像生成一个新的提交。使用此新提交来部署具有最新软件包版本或附加软件包的镜像。 			

​					要部署 RHEL for Edge 镜像更新，请确保您满足先决条件，然后按照以下步骤操作。 			

**先决条件**

- ​							在 RHEL 系统上，您已访问了镜像构建器仪表盘。 					
- ​							您已创建了 RHEL for Edge 镜像蓝图。 					
- ​							您编辑了 RHEL for Edge 镜像蓝图。请参阅 [在 RHEL web 控制台中使用镜像构建器编辑 RHEL for Edge 镜像蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/managing-rhel-for-edge-images_composing-installing-managing-rhel-for-edge-images#editing_a_rhel_for_edge_image_blueprint_using_image_builder_in_rhel_web_console)。 					

**步骤**

1. ​							在镜像构建器仪表盘上，对于您编辑的蓝图，点 Create Image。 					

2. ​							在 `Create Image` 窗口中，执行以下步骤： 					

   1. ​									从 `Image output type` 下拉列表中，选择 `RHEL for Edge Commit (.tar)`。点 Next。 							

   2. ​									在 `OSTree settings` 页面中，输入： 							

      1. ​											在 `Repository URL` 中，输入要嵌入到镜像中的提交的 OSTree 存储库的 URL。例如：http://10.0.2.2:8080/repo/。请参阅 [设置 web 服务器以安装 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images#setting-up-a-web-server-to-install-rhel-for-edge-image_installing-rpm-ostree-images)。 									
      2. ​											在`父提交`文本框中，指定之前生成的父提交 ID。请参阅[提取 RHEL for Edge 镜像提交](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images#extracting-the-tar-file-commit_installing-rpm-ostree-images) 									
      3. ​											在 `Ref` 文本框中，您可以指定提交的名称或将其留空。默认情况下，web 控制台将 `Ref` 指定为 `rhel/9/arch_name/edge`。点 Next。 									

   3. ​									在 `Customizations` 页面中： 							

      1. ​											可选：在 `System` 中，输入主机名。如果没有添加它，操作系统会决定主机名。点 Next。 									
      2. ​											可选：单击 Add User。输入用户名、密码和 SSH 密钥。您可以将用户标记为服务器管理员。 									

   4. ​									可选：在软件包页面中： 							

      1. ​											在 Available 软件包中，输入要自定义镜像的软件包名称。点 Next。 									

   5. ​									在 Review 页面中，检查自定义。点 Save blueprint。它会激活 Create image 按钮。 							

   6. ​									点 Create image。镜像构建器为更新的蓝图创建一个 RHEL for Edge 镜像。 							

      ​									要查看 RHEL for Edge 镜像创建进度，点 breadcrumbs 中的蓝图名称，然后单击 `Images` 选项卡。 							

      注意

      ​										完成镜像创建过程需要几分钟时间。 								

      ​									生成的镜像包含您添加的最新软件包（若有），并且具有原始 `提交 ID` 作为父项。 							

3. ​							下载生成的 RHEL for Edge 镜像。有关下载 RHEL for Edge 镜像的更多信息，请参阅下载 [RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console_composing-installing-managing-rhel-for-edge-images#downloading-a-rhel-for-edge-image_composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console)。 					

4. ​							提取 OSTree 提交。有关提取 OSTree 提交的更多信息，请参阅 [提取 RHEL for Edge 镜像提交](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images#extracting-the-tar-file-commit_installing-rpm-ostree-images)。 					

5. ​							构建 docker 容器，这一次提供子提交 ID。 					

   

   ```none
   # podman build -t name-of-server --build-arg commit=uuid-child_commit.tar .
   ```

6. ​							运行容器。 					

   

   ```none
   # podman run --rm -p 8000:80 name-of-server
   ```

7. ​							在置备的 RHEL 系统上，从原始边缘镜像验证当前状态。 					

   

   ```none
   $ rpm-ostree status
   ```

   ​							如果没有新的提交 ID，请运行以下命令验证是否有可用的升级： 					

   

   ```none
   $ rpm-ostree upgrade --check
   ```

   ​							命令输出提供当前活动的 OSTree 提交 ID。 					

8. ​							更新 OSTree，使新 OSTree 提交 ID 可用。 					

   

   ```none
   $ rpm-ostree upgrade
   ```

   ​							ostree 验证存储库是否有更新。如果是，它将获取您重新引导系统的更新和请求，以便您可以激活此新提交更新的部署。 					

9. ​							再次检查当前状态： 					

   

   ```none
   $ rpm-ostree status
   ```

   ​							现在，您可以看到有 2 个提交可用： 					

   - ​									活跃的父级提交。 							
   - ​									一个未激活且包含 1 个添加的差异的新提交。 							

10. ​							要激活新部署并使新提交处于活动状态，请重启您的系统。 					

    

    ```none
    # systemctl reboot
    ```

    ​							Anaconda 安装程序将重新引导至新部署。在登录屏幕上，您可以看到可供您引导的新部署。 					

11. ​							如果要引导到最新的部署(提交)，`rpm-ostree` upgrade 命令会自动排序引导条目，因此新部署使列表中的第一个。（可选）您可以使用键盘中的箭头键选择 GRUB 菜单条目并按 Enter。 					

12. ​							提供您的登录用户帐户凭证。 					

13. ​							验证 OSTree 状态： 					

    

    ```none
    $ rpm-ostree status
    ```

    ​							命令输出提供活动的提交 ID。 					

14. ​							要查看更改的软件包（如果有），请在父提交和新提交之间运行差异： 					

    

    ```none
    $ rpm-ostree db diff parent_commit new_commit
    ```

    ​							更新显示您已安装的软件包可用并可供使用。 					

### 10.2.3. 使用命令行手动部署 RHEL for Edge 镜像更新

​					编辑 RHEL for Edge 蓝图后，您可以更新镜像提交。镜像构建器为更新的 RHEL for Edge 镜像生成一个新的提交。使用新的提交，通过 CLI 使用最新的软件包版本或使用其他软件包来部署镜像。 			

​					要使用 CLI 部署 RHEL for Edge 镜像更新，请确保您满足先决条件，然后按照以下步骤执行。 			

**先决条件**

- ​							已创建 RHEL for Edge 镜像蓝图。 					
- ​							已编辑 RHEL for Edge 镜像蓝图。请参阅 [使用命令行界面编辑 RHEL for Edge 镜像蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#editing-a-rhel-for-edge-image-blueprint-using-command-line-interface_managing-rhel-for-edge-images)。 					

**步骤**

1. ​							使用以下参数创建 RHEL for Edge Commit(`.tar`)镜像： 					

   

   ```none
   # composer-cli compose start-ostree --ref ostree_ref --url URL-OSTree-repository -blueprint_name_ image-type
   ```

   ​							其中 					

   - ​									`*ref*` 是您在为 Edge Container 提交创建 RHEL 时提供的引用。例如： `rhel/9/x86_64/edge`。 							

   - ​									`*URL-OSTree-repository*` 是要嵌入到镜像中的提交的 OSTree 存储库的 URL。例如：http://10.0.2.2:8080/repo/。请参阅 [设置 web 服务器以安装 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images#setting-up-a-web-server-to-install-rhel-for-edge-image_installing-rpm-ostree-images)。 							

   - ​									`*image-type*` 为 `edge-commit`。 							

     ​									镜像构建器为更新的蓝图创建一个 RHEL for Edge 镜像。 							

2. ​							检查 RHEL 中的 Edge 镜像创建进度： 					

   

   ```none
   # composer-cli compose status
   ```

   注意

   ​								镜像创建过程可能需要长达十到 30 分钟才能完成。 						

   ​							生成的镜像包含您添加的最新软件包（若有），并且具有原始 `提交 ID` 作为父项。 					

3. ​							下载生成的 RHEL for Edge 镜像。如需更多信息，请参阅 [使用镜像构建器命令行界面下载 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#downloading-a-rhel-for-edge-image-using-the-command-line_composing-a-rhel-for-edge-image-using-image-builder-command-line)。 					

4. ​							提取 OSTree 提交。如需更多信息，请参阅 [为 Edge 镜像提交提取 RHEL](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#extracting-the-tar-file-commit_installing-rpm-ostree-images)。 					

5. ​							使用 httpd 为 OSTree 提交提供服务。请参阅 [设置 web 服务器以安装 RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/composing_installing_and_managing_rhel_for_edge_images/installing-rpm-ostree-images_composing-installing-managing-rhel-for-edge-images#setting-up-a-web-server-to-install-rhel-for-edge-image_installing-rpm-ostree-images)。 					

6. ​							在从原始边缘镜像置备的 RHEL 系统中，验证当前状态： 					

   

   ```none
   $ rpm-ostree status
   ```

   ​							如果没有新的提交 ID，请运行以下命令验证是否有可用的升级： 					

   

   ```none
   $ rpm-ostree upgrade --check
   ```

   ​							命令输出提供当前活动的 OSTree 提交 ID。 					

7. ​							更新 OSTree 以使新的 OSTree 提交 ID 可用： 					

   

   ```none
   $ rpm-ostree upgrade
   ```

   ​							ostree 验证存储库是否有更新。如果是，它将获取您重新引导系统的更新和请求，以便您可以激活此新提交更新的部署。 					

8. ​							再次检查当前状态： 					

   

   ```none
   $ rpm-ostree status
   ```

   ​							现在，您应看到有 2 个可用的提交： 					

   - ​									活跃的父级提交 							
   - ​									一个未激活且包含 1 个添加的差异的新提交。 							

9. ​							要激活新部署并使新提交处于活动状态，请重启您的系统。 					

   

   ```none
   # systemctl reboot
   ```

   ​							Anaconda 安装程序将重新引导至新部署。在登录屏幕上，您可以看到可供您引导的新部署。 					

10. ​							如果要引导进入最新的部署，`rpm-ostree upgrade` 命令会自动订购引导条目，以便新部署在列表中第一个。（可选）您可以使用键盘中的箭头键选择 GRUB 菜单条目并按 Enter。 					

11. ​							使用您的帐户凭据登录。 					

12. ​							验证 OSTree 状态： 					

    

    ```none
    $ rpm-ostree status
    ```

    ​							命令输出提供活动的提交 ID。 					

13. ​							要查看更改的软件包（如果有），请在父提交和新提交之间运行差异： 					

    

    ```none
    $ rpm-ostree db diff parent_commit new_commit
    ```

    ​							更新显示您已安装的软件包可用并可供使用。 					

### 10.2.4. 为非网络部署手动部署 RHEL for Edge 镜像更新

​					编辑 RHEL for Edge 蓝图后，您可以更新镜像提交。镜像构建器为更新的 RHEL for Edge 镜像生成一个新的提交。使用此新提交来部署具有最新软件包版本或附加软件包的镜像。 			

​					要部署 RHEL for Edge 镜像更新，请确保您满足先决条件，然后按照以下步骤操作。 			

**先决条件**

- ​							RHEL for Edge 系统已启动且正在运行。 					
- ​							OSTree 存储库通过 HTTP 提供。 					
- ​							您已创建了 RHEL for Edge 镜像蓝图。 					
- ​							您编辑了 RHEL for Edge 镜像蓝图。[请参阅在 RHEL web 控制台中使用镜像构建器编辑 RHEL for Edge 镜像蓝图](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#editing_a_rhel_for_edge_image_blueprint_using_image_builder_in_rhel_web_console)。 					

**步骤**

1. ​							在镜像构建器仪表盘上，对于您编辑的蓝图，点 Create Image。 					

2. ​							在 **Create Image** 窗口中，执行以下步骤： 					

   1. ​									从 `类型` 下拉列表中，选择 `RHEL for Edge Container (.tar)`。 							

   2. ​									在 `父提交` 文本框中，指定之前生成的父提交 ID。请参阅[提取 RHEL for Edge 镜像提交](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#extracting-the-tar-file-commit_installing-rpm-ostree-images) 							

   3. ​									在 `Repository` 文本框中，指定要嵌入到镜像中的提交 OSTree 存储库的 URL。例如：http://10.0.2.2:8080/repo/。 							

   4. ​									在 `Ref` 文本框中，指定您在创建 RHEL for Edge 容器提交时提供的相同参考，以嵌入到镜像中。例如，`rhel/edge/test`。 							

   5. ​									点 Create。镜像构建器为更新的蓝图创建一个 RHEL for Edge 镜像。 							

      ​									要查看 RHEL for Edge 镜像的进度，请点击 breadcrumbs 中的蓝图名称，然后单击 `Images` 选项卡。 							

      注意

      ​										完成镜像创建过程需要几分钟时间。 								

      ​									生成的镜像包含您添加的最新软件包（若有），并且具有原始 `提交 ID` 作为父项。 							

3. ​							下载生成的 RHEL for Edge 镜像。有关下载 RHEL for Edge 镜像的更多信息，请参阅下载 [RHEL for Edge 镜像](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#downloading-a-rhel-for-edge-image_composing-rhel-for-edge-images-using-image-builder-in-rhel-web-console)。 					

4. ​							将 RHEL for Edge 容器镜像加载到 Podman 中，这一次提供子提交 ID。 					

   

   ```none
   $ cat ./child-commit_ID-container.tar | sudo podman load
   ```

5. ​							运行 `Podman`。 					

   

   ```none
   #  sudo podman run -p 8080:8080 localhost/edge-test
   ```

6. ​							在置备的 RHEL 系统上，从原始边缘镜像验证当前状态。 					

   

   ```none
   $ rpm-ostree status
   ```

   ​							如果没有新的提交 ID，请运行以下命令验证是否有可用的升级： 					

   

   ```none
   $ rpm-ostree upgrade --check
   ```

   ​							如果有可用的更新，命令输出提供关于 OSTree 存储库中可用更新的信息，如当前活动的 OSTree 提交 ID。否则，它会提示一条信息通知没有可用的更新。 					

7. ​							更新 OSTree，使新 OSTree 提交 ID 可用。 					

   

   ```none
   $ rpm-ostree upgrade
   ```

   ​							ostree 验证存储库是否有更新。如果是，它将获取您重新引导系统的更新和请求，以便您可以激活此新提交更新的部署。 					

8. ​							检查当前状态： 					

   

   ```none
   $ rpm-ostree status
   ```

   ​							现在，您可以看到有 2 个提交可用： 					

   - ​									活跃的父级提交。 							
   - ​									一个未激活且包含 1 个添加的差异的新提交。 							

9. ​							要激活新部署并使新提交处于活动状态，请重启您的系统。 					

   

   ```none
   # systemctl reboot
   ```

   ​							Anaconda 安装程序将重新引导至新部署。在登录屏幕上，您可以看到可供您引导的新部署。 					

10. ​							如果要引导进入最新的提交/部署，`rpm-ostree upgrade` 命令会自动订购引导条目，以便新部署在列表中第一个。（可选）您可以使用键盘中的箭头键选择 GRUB 菜单条目并按 Enter。 					

11. ​							提供您的登录用户帐户凭证。 					

12. ​							验证 OSTree 状态： 					

    

    ```none
    $ rpm-ostree status
    ```

    ​							命令输出提供活动的提交 ID。 					

13. ​							要查看更改的软件包（如果有），请在父提交和新提交之间运行差异： 					

    

    ```none
    $ rpm-ostree db diff parent_commit new_commit
    ```

    ​							更新显示您已安装的软件包可用并可供使用。 					

## 10.3. 升级 RHEL for Edge 系统

### 10.3.1. 将 RHEL 8 系统升级到 RHEL 9

​					您可以使用 `rpm-ostree rebase` 命令将 RHEL 8  系统升级到 RHEL 9。它完全支持从 RHEL 8 的最新更新升级到 RHEL 9 的最新更新的 RHEL for Edge  更新的默认软件包集。升级会在后台下载并安装 RHEL 9 镜像。升级完成后，您必须重启系统以使用新的 RHEL 9 镜像。 			

注意

​						升级并不支持所有可能的 `rpm` 软件包版本并包括所有软件包。您必须测试您的软件包，以确保它正常工作。 				

**先决条件**

- ​							您有一个正在运行的 RHEL for Edge 8 系统 					
- ​							您有一个 OSTree 软件仓库服务器 (HTTP) 					
- ​							您为您要升级的 RHEL for Edge 9 镜像创建了蓝图 					

**步骤**

1. ​							在运行镜像构建器的系统上，创建一个 RHEL for Edge 9 镜像： 					

   1. ​									启动镜像合成： 							

      

      ```none
      $ sudo composer-cli compose start blueprint-name edge-commit
      ```

   2. ​									完成合成后，下载镜像。 							

   3. ​									将下载的镜像提取到 `/var/www/html/` 文件夹： 							

      

      ```none
      $ sudo tar -xf image_file -C /var/www/html
      ```

   4. ​									启动 `httpd` 服务： 							

      

      ```none
      $ systemctl start httpd.service
      ```

2. ​							在 RHEL for Edge 设备上，检查当前的远程存储库配置： 					

   

   ```none
   $ sudo cat /etc/ostree/remotes.d/edge.conf
   ```

   注意

   ​								根据 Kickstart 文件的配置方式，`/etc/ostree/remotes.d` 存储库可以为空。如果您配置了远程存储库，您可以看到其配置。对于 `edge-installer`、`raw-image` 和 `simplified-installer` 镜像，默认配置了远程。 						

3. ​							检查当前的 URL 存储库： 					

   

   ```none
   $ sudo ostree remote show-url edge
   ```

   ​							*edge* 是 Ostree 存储库。 					

4. ​							列出远程引用分支： 					

   

   ```none
   $ ostree remote refs edge
   ```

   ​							您可以看到以下输出： 					

   

   ```none
   Error: Remote refs not available; server has no summary file
   ```

5. ​							添加新存储库： 					

   1. ​									配置 URL 密钥以添加远程存储库。例如： 							

      

      ```none
      $ sudo ostree remote add \ --no-gpg-verify rhel9 http://192.168.122.1/repo/
      ```

   2. ​									将 URL 键配置为指向升级的 RHEL 9 提交。例如： 							

      

      ```none
      $ sudo cat /etc/ostree/remotes.d/edge.conf [remote "edge"] url=http://192.168.122.1/ostree/repo/ gpg-verify=false
      ```

   3. ​									确认 URL 是否已设置为新的远程存储库： 							

      

      ```none
      $ sudo cat /etc/ostree/remotes.d/rhel9.conf [remote "edge"] url=http://192.168.122.1/repo/ gpg-verify=false
      ```

   4. ​									查看新 URL 存储库： 							

      

      ```none
      $ sudo ostree remote show-url rhel9 http://192.168.122.1/ostree-rhel9/repo/
      ```

   5. ​									列出当前的远程列表选项： 							

      

      ```none
      $ sudo ostree remote list
      
      output:
      edge
      rhel9
      ```

6. ​							将您的系统升级到 RHEL 版本，为 RHEL 9 版本提供参考路径： 					

   

   ```none
   $ rpm-ostree rebase rhel9:rhel/9/x86_64/edge
   ```

7. ​							重启您的系统。 					

   

   ```none
   $ systemctl reboot
   ```

8. ​							输入您的用户名和密码。 					

9. ​							检查当前系统状态： 					

   

   ```none
   $ rpm-ostree status
   ```

**验证**

1. ​							检查当前运行的部署的当前状态： 					

   

   ```none
   $ rpm-ostree status
   ```

2. ​							可选：列出内核实时管理的处理器和任务。 					

   

   ```none
   $ top
   ```

3. ​							如果升级不支持您的要求，您可以选择手动回滚到以前的稳定部署 RHEL 8 版本： 					

   

   ```none
   $ sudo rpm-ostree rollback
   ```

4. ​							重启您的系统。输入您的用户名和密码： 					

   

   ```none
   $ systemctl reboot
   ```

   ​							重新引导后，您的系统成功运行了 RHEL 9。 					

   注意

   ​								如果升级成功，且您不想使用以前的部署 RHEL 8 版本，您可以删除旧软件仓库： 						

   

   ```none
   $ sudo ostree remote delete edge
   ```

## 10.4. 部署 RHEL for Edge 自动镜像更新

​				在 Edge 设备中安装 RHEL for Edge 镜像后，您可以检查可用的镜像更新（如果有）并可自动应用。 		

​				`rpm-ostreed-automatic.service` (systemd 服务)和 `rpm-ostreed-automatic.timer` (systemd 计时器)控制检查和升级的频率。可用的更新（若有）显示为暂存部署。 		

​				部署自动镜像更新涉及以下高级别步骤： 		

- ​						更新镜像更新策略 				
- ​						启用自动下载和暂存更新 				

### 10.4.1. 更新 RHEL for Edge 镜像更新策略

​					要更新镜像更新策略，请使用边缘设备上位于 `/etc/rpm-ostreed.conf` 处的 `rpm-ostreed.conf` 文件中的 `AutomaticUpdatePolicy` 和 `IdleExitTimeout` 设置。 			

​					`AutomaticUpdatePolicy` 设置控制自动更新策略，并有以下更新检查选项： 			

- ​							`none`:禁用自动更新。默认情况下，`AutomaticUpdatePolicy` 设置被设为 `none`。 					
- ​							`check` ：下载足够的元数据以显示具有 `rpm-ostree` 状态的可用更新。 					
- ​							`stage` ：下载并解压缩重启时应用的更新。 					

​					`IdleExitTimeout` 设置控制守护进程退出前不活跃的时间，并具有以下选项： 			

- ​							0:禁用自动退出. 					
- ​							60:默认情况下，`IdleExitTimeout` 设置被设置为 `60`。 					

​					要启用自动更新，请执行以下步骤： 			

**步骤**

1. ​							在 `/etc/rpm-ostreed.conf` 文件中更新以下内容： 					

   - ​									把 `AutomaticUpdatePolicy` 的值改为 `check`。 							
   - ​									要运行更新检查，请为 `IdleExitTimeout` 指定一个以秒为单位的值。 							

2. ​							重新加载 `rpm-ostreed` 服务并启用 `systemd` 定时器。 					

   

   ```none
   # systemctl reload rpm-ostreed
   # systemctl enable rpm-ostreed-automatic.timer --now
   ```

3. ​							验证 `rpm-ostree` 状态，以确保配置了自动更新策略，并且时间处于活跃状态。 					

   

   ```none
   # rpm-ostree status
   ```

   ​							命令输出显示以下内容： 					

   

   ```none
   State: idle; auto updates enabled (check; last run <minutes> ago)
   ```

   ​							此外，输出中也显示有关可用更新的信息。 					

### 10.4.2. 启用 RHEL for Edge 自动下载和保存更新

​					在更新了镜像更新策略以检查镜像更新后，如果显示了任何更新详情，则进行更新。如果您决定应用更新，请启用策略来自动下载和暂存更新。然后，下载并暂存可用的镜像更新以进行部署。更新会被应用并在重启 Edge 设备时生效。 			

​					要启用自动下载和暂存更新的策略，请执行以下操作： 			

**步骤**

1. ​							在 `/etc/rpm-ostreed.conf` 文件中，将 'AutomaticUpdatePolicy' 更新为 `stage`。 					

2. ​							重新载入 rpm-ostreed 服务。 					

   

   ```none
   # systemctl enable rpm-ostreed-automatic.timer --now
   ```

3. ​							验证 rpm-ostree 状态 					

   

   ```none
   # rpm-ostree status
   ```

   ​							命令输出显示以下内容： 					

   

   ```none
   State: idle
   AutomaticUpdates: stage; rpm-ostreed-automatic.timer: last run <time> ago
   ```

4. ​							要启动更新，您可以等待计时器启动更新，也可以手动启动该服务。 					

   

   ```none
   # systemctl start rpm-ostreed-automatic.service
   ```

   ​							启动更新后，rpm-ostree 状态将显示如下： 					

   

   ```none
   # rpm-ostree status
   State: busy
   AutomaticUpdates: stage; rpm-ostreed-automatic.service: running
   Transaction: automatic (stage)
   ```

   ​							更新完成后，部署列表中会暂存新的部署，原始引导的部署将保持不变。您可以决定您是否要使用新部署引导系统，或者可以等待下一次更新。 					

   ​							要查看部署列表，请运行 `rpm-ostree status` 命令。 					

   ​							以下是输出示例： 					

   

   ```none
   # rpm-ostree status
   State: idle
   AutomaticUpdates: stage; rpm-ostreed-automatic.timer: last run <time> ago
   Deployments:
   ```

   ​							要使用更新的软件包详情查看部署列表，请运行 `rpm-ostree status -v` 命令。 					

## 10.5. RHEL for Edge 镜像的回滚

​				您可以验证更新的镜像是否已成功部署。如果部署不成功，您可以回滚到以前的版本（提交）。要回滚到以前的功能状态，您可以手动执行这些步骤，也可以使用自动流程。 		

### 10.5.1. RHEL for Edge 镜像如何回滚

​					对于 RHEL for Edge 镜像，仅将事务更新应用到操作系统。通过事务更新，您可以轻松地将失败的更新回滚到最后已知的良好状态，从而防止更新期间系统失败。 			

​					您可以在 Greenboot 中使用智能回滚，从而消除在应用程序稳定性和安全更新应用程序之间进行选择的问题。 			

​					Greenboot 利用 `rpm-ostree`，并运行在系统启动时运行的自定义健康检查。如果出现问题，系统会回滚更改，并保留最后一个工作状态。当您部署 `rpm-ostree` 更新时，它会运行脚本来检查关键服务是否在更新后仍然可以工作。如果系统无法正常工作，更新会回滚到系统的最后一个已知工作版本。此过程可确保您的 RHEL for Edge 设备处于可操作状态。 			

​					以下是 Greenboot 目录结构： 			

例 10.1. Greenboot 目录结构



```none
etc
└─ greenboot
   ├─ check
   |   └─ required.d
   |   └─ init.py
   └─ green.d
   └─ red.d
```

- `/etc/greenboot/check/required.d`

  ​								包含不能失败的健康检查。 						

- `/etc/greenboot/check/wanted.d`

  ​								包含可能失败的健康检查。 						

- `/etc/greenboot/green.d`

  ​								包含成功引导后要运行的脚本。 						

- `/etc/greenboot/red.d`

  ​								包含在引导失败后要运行的脚本。系统会尝试引导三次，并在失败时执行脚本。 						

​					下图演示了 RHEL for Edge 镜像回滚过程。 			

[![镜像恢复过程](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/fc6f14d57259a680af9bb97d41772c62/edge-image-restore.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Composing_installing_and_managing_RHEL_for_Edge_images-zh-CN/images/fc6f14d57259a680af9bb97d41772c62/edge-image-restore.png)

### 10.5.2. 手动回滚 RHEL for Edge 镜像

​					如果 RHEL for Edge 镜像更新部署失败，或者更新无法成功完成，您可以手动回滚到以前的部署版本。 			

​					要回滚到以前的版本，请执行以下步骤： 			

**步骤**

1. ​							运行 `rollback` 命令： 					

   

   ```none
   # rpm-ostree rollback
   ```

   ​							命令输出提供有关正在移动的提交 ID 的详细信息，并指示与正在删除的软件包的详细信息相关的已完成事务。 					

2. ​							重启系统。 					

   

   ```none
   # systemctl reboot
   ```

   ​							命令将激活上一个带有稳定内容的提交。应用更改并恢复之前的版本。 					

### 10.5.3. 使用自动化流程回滚 RHEL for Edge 镜像

​					Greenboot 检查提供了一个框架，它集成到引导过程中，并可在健康检查失败时触发 `rpm-ostree` 回滚。对于健康检查，您可以创建一个自定义脚本来指示健康检查是否通过或失败。根据结果，您可以决定何时触发回滚。 			

​					要创建健康检查脚本，请执行以下步骤： 			

**步骤**

1. ​							创建返回标准退出代码 `0` 的脚本。 					

   ​							例如，以下脚本确保配置的 DNS 服务器可用： 					

   

   ```none
   #!/bin/bash
   
   DNS_SERVER=$(grep ^nameserver /etc/resolv.conf | head -n 1 | cut -f2 -d" ")
   COUNT=0
   # check DNS server is available
   ping -c1 $DNS_SERVER
   while [ $? != '0' ] && [ $COUNT -lt 10 ]; do
   ((COUNT++))
   echo "Checking for DNS: Attempt $COUNT ."
   sleep 10
   ping -c 1 $DNS_SERVER
   done
   ```

2. ​							在 `/etc/greenboot/check/required.d/` 中包括健康检查的可执行文件。 					

   

   ```none
   chmod +x check-dns.sh
   ```

   ​							在下一次重启期间，将在系统进入 boot-complete.target 之前，作为引导过程的一部分来执行 脚本。如果健康检查成功，则不执行任何操作。如果健康检查失败，系统会在将更新标记为失败并回滚到上一更新之前多次重启。 					

**验证步骤**

​						要检查默认网关是否可访问，请运行以下健康检查脚本： 				

1. ​							创建返回标准退出代码 `0` 的脚本。 					

   

   ```none
   #!/bin/bash
   
   DEF_GW=$(ip r | awk '/^default/ {print $3}')
   SCRIPT=$(basename $0)
   
   count=10
   connected=0
   ping_timeout=5
   interval=5
   
   while [ $count -gt 0 -a $connected -eq 0 ]; do
     echo "$SCRIPT: Pinging default gateway $DEF_GW"
     ping -c 1 -q -W $ping_timeout $DEF_GW > /dev/null 2>&1 && connected=1 || sleep $interval
     ((--count))
   done
   
   if [ $connected -eq 1 ]; then
     echo "$SCRIPT: Default gateway $DEF_GW is reachable."
     exit 0
   else
     echo "$SCRIPT: Failed to ping default gateway $DEF_GW!" 1>&2
     exit 1
   fi
   ```

2. ​							在 `/etc/greenboot/check/required.d/` 目录中包括健康检查的可执行文件。 					

   

   ```none
   chmod +x check-gw.sh
   ```

# 附录 A. 术语和命令

​			了解有关 `rpm ostree` 术语和命令的更多信息。 	

## A.1. OSTree 和 rpm-ostree 术语

​				以下是一些在上下文与 OSTree 和 `rpm-ostree` 镜像有关的术语。 		

表 A.1. OSTree 和 rpm-ostree 术语

| 术语             | 定义                                                         |
| ---------------- | ------------------------------------------------------------ |
| `OSTree`         | 此工具用于管理基于 Linux 的操作系统版本。OSTree 树视图与 Git 类似，它基于相似的概念。 |
| `rpm-ostree`     | 托管操作系统更新的混合镜像或系统软件包。                     |
| `Commit（提交）` | 操作系统的发行版本或镜像版本。镜像构建器为 RHEL for Edge 镜像生成一个 ostree 提交。您可以使用这些镜像在 Edge 服务器上安装或更新 RHEL。 |
| `Refs`           | 代表 ostree 中的分支。Refs 始终解析为最新的提交。例如： `rhel/9/x86_64/edge`。 |
| `修订 (Rev)`     | 特定提交的 SHA-256。                                         |
| `远程`           | 托管 ostree 内容的 http 或 https 端点。这类似于 dnf 存储库的 baseurl。 |
| `static-delta`   | 对 ostree 镜像的更新始终是 delta 更新。如果是 RHEL for Edge 镜像，则 TCP  开销可能高于预期值，因为更新了文件的数量。为避免 TCP 开销，您可以在特定提交之间生成  static-delta，并在单个连接中发送更新。这种优化有助于连接受限的大型部署。 |

## A.2. OSTree 命令

​				下表提供了几个您可以在安装或管理 OSTree 镜像时使用的 OSTree 命令，。 		

表 A.2. ostree 命令

| ostree pull                               | `ostree pull-local --repo [path] src` 						 						  							`ostree pull-local <path> <rev> --repo=<repo-path>` 						 						  							`ostree pull <URL> <rev> --repo=<repo-path>` |
| ----------------------------------------- | ------------------------------------------------------------ |
| ostree 概况                               | `ostree summary -u --repo=<repo-path>`                       |
| 查看 refs                                 | `ostree refs --repo ~/Code/src/osbuild-iot/build/repo/ --list` |
| 查看 repo 中的提交                        | `ostree log --repo=/home/gicmo/Code/src/osbuild-iot/build/repo/ <REV>` |
| 检查一个提交                              | `ostree show --repo build/repo <REV>`                        |
| 列出 repo 的远程                          | `ostree remote list --repo <repo-path>`                      |
| 解析一个 REV                              | `ostree rev-parse --repo ~/Code/src/osbuild-iot/build/repo fedora/x86_64/osbuild-demo` 						 						  							`ostree rev-parse --repo ~/Code/src/osbuild-iot/build/repo b3a008eceeddd0cfd` |
| 创建 static-delta                         | `ostree static-delta generate --repo=[path] --from=REV --to=REV` |
| 使用 GPG 密钥签署一个`现有的` ostree 提交 | `ostree gpg-sign --repo=<repo-path> --gpg-homedir <gpg_home> COMMIT KEY-ID…` |

## A.3. rpm-ostree 命令

​				下表提供了几个您可以在安装或管理 OSTree 镜像时使用的 `rpm-ostree` 命令。 		

表 A.3. rpm-ostree 命令

| 命令                                                         | 描述                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| `rpm-ostree --repo=/home/gicmo/Code/src/osbuild-iot/build/repo/ db list <REV>` | 此命令会列出 <REV> 提交到存储库中的现有软件包。              |
| `rpm-ostree rollback`                                        | OSTree 管理引导装载程序条目的有序列表，称为 `部署`。index 0 处的条目是默认的引导装载程序条目。每个条目都有一个单独的 `/etc` 目录，但所有条目共享单个 `/var` 目录。您可以通过按 Tab 键中断启动，来使用启动加载程序在条目之间进行选择。这会回滚到以前的状态，即默认部署更改在非默认位置。 |
| `rpm-ostree status`                                          | 此命令提供有关当前正在使用的部署的信息。按顺序列出所有可能部署的名称和 refspec，使得列表中的第一个部署是启动时的默认部署。标记为 * 的部署是当前的引导部署，使用 'r' 标记代表最新的升级。 |
| `rpm-ostree db list`                                         | 使用此命令查看提交或提交中的软件包。您必须至少指定一个提交，但多个提交也起作用。 |
| `rpm-ostree db diff`                                         | 使用此命令显示两个 rev（修订）中的树之间的软件包如何不同。如果没有提供 revs，则引导的提交将与待处理提交进行比较。如果只提供单个 rev，则引导的提交将与该 rev 进行比较。 |
| `rpm-ostree upgrade`                                         | 此命令将下载当前树的最新版本并进行部署，将当前树设置为下一次启动的默认树。这不会影响运行的文件系统树。您必须重启才能使任何更改生效。 |

**其他资源**

- ​						[citetitle] `rpm-ostree` 手册页。 				

## A.4. FDO 自动加入术语

​				了解有关 FDO 术语的更多信息。 		

表 A.4. FDO 术语

| 命令              | 描述                                                         |
| ----------------- | ------------------------------------------------------------ |
| FDO               | FIDO Device Onboarding（FIDO 设备加入）。                    |
| 设备              | 任何硬件、设备或计算机。                                     |
| 所有者            | 设备的最终所有者 - 公司或 IT 部门。                          |
| 制造商            | 设备制造商。                                                 |
| 制造商服务器      | 为该设备创建设备凭证。                                       |
| 制造商客户端      | 告知 manufacturing 服务器的位置。                            |
| 所有权变量(OV)    | 单独设备的所有权的记录。包含以下信息： 						 						  							* Owner (`fdo-owner-onboarding-service`) 						 						  							* Rendezvous Server - FIDO server (`fdo-rendezvous-server`) 						 						  							* Device (at least one combination) (`fdo-manufacturing-service`) |
| 设备凭据(DC)      | 存储在制造商设备的密钥凭证和 rendezvous。                    |
| Keys              | 配置 manufacturing 服务器的密钥 						 						  							* key_path 						 						  							* cert_path 						 						  							* key_type 						 						  							* mfg_string_type: 设备序列号 						 						  							* allowed_key_storage_types:文件系统和受信任的平台模块(TPM)，用于保护用来验证您使用的设备的数据。 |
| Rendezvous 服务器 | 指向设备使用的服务器及之后使用的服务器，用于查找该设备的所有者是谁 |

**其他资源**

- ​						[FIDO IoT 规格](https://fidoalliance.org/specs/fidoiot/FIDO-IoT-spec-v1.0-wd-20200730.html#OV) 				

## A.5. FDO 自动加入技术

​				以下是在上下文中用于 FDO 自动加入的技术。 		

表 A.5. OSTree 和 rpm-ostree 术语

| 技术             | 定义                                                    |
| ---------------- | ------------------------------------------------------- |
| UEFI             | 统一可扩展固件接口.                                     |
| RHEL             | Red Hat® Enterprise Linux® operating system             |
| `rpm-ostree`     | 基于镜像的后台升级。                                    |
| Greenboot        | `rpm-ostree` 上的 systemd 的 `Healthcheck` 框架。       |
| osbuild          | 用于操作系统工件的基于管道的构建系统。                  |
| Container        | Linux® 容器是与系统其余部分隔离的一个或多个进程的集合。 |
| Coreos-installer | 辅助安装 RHEL 镜像，使用 UEFI 引导系统。                |
| FIDO FDO         | 调配配置和加入设备的规格协议。                          |

# 法律通告

​		Copyright © 2023 Red Hat, Inc. 

​		The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license  ("CC-BY-SA"). An explanation of CC-BY-SA is available at http://creativecommons.org/licenses/by-sa/3.0/. In accordance with CC-BY-SA, if you distribute this document or an  adaptation of it, you must provide the URL for the original version. 

​		Red Hat, as the licensor of this document, waives the right to  enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law. 

​		Red Hat, Red Hat Enterprise Linux, the Shadowman logo, the Red Hat  logo, JBoss, OpenShift, Fedora, the Infinity logo, and RHCE are  trademarks of Red Hat, Inc., registered in the United States and other  countries. 

​		Linux® is the registered trademark of Linus Torvalds in the United States and other countries. 

​		Java® is a registered trademark of Oracle and/or its affiliates. 

​		XFS® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries. 

​		MySQL® is a registered trademark of MySQL AB in the United States, the European Union and other countries. 

​		Node.js® is an official trademark of  Joyent. Red Hat is not formally related to or endorsed by the official  Joyent Node.js open source or commercial project. 

​		The OpenStack® Word Mark and OpenStack  logo are either registered trademarks/service marks or  trademarks/service marks of the OpenStack Foundation, in the United  States and other countries and are used with the OpenStack Foundation's  permission. We are not affiliated with, endorsed or sponsored by the  OpenStack Foundation, or the OpenStack community. 

​		All other trademarks are the property of their respective owners. 

​                