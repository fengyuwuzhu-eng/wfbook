# OS自动化部署

## CentOS

### 方法1：PXE + DHCP + TFTP + VSftpd + Kickstart

![img](..\..\Image\k\kickstart) 

PXE(**P**reboot e**x**ecute **e**nvironment)：一种能够让计算机通过网络启动的引导方式，只要网卡支持PXE协议即可使用。

Kickstart：是一种无人值守的安装方式，工作原理就是预先把原本需要运维人员手工填写的参数保存成一个ks.cfg文件，当安装过程中出现需要填写参数时则自动匹配Kickstart生成的文件。

简单文本传输协议TFTP(**T**rivial **F**ile **T**ransfer **P**rotocol)：是一种基于UDP协议的传输协议，TFTP协议不具备FTP的许多功能（例如列出目录，密码认证等等），但TFTP协议配置非常简单，而且资源消耗更低，非常适合传输不敏感的文件。

#### DHCP

```bash
# 安装DHCP
yum install dhcp

# 编辑配置文件
vim /etc/dhcp/dhcpd.conf

allow booting;
allow bootp;
ddns-update-style interim;
ignore client-updates;

subnet 192.168.10.0 netmask 255.255.255.0 {
     option subnet-mask      255.255.255.0;
     option domain-name-servers  192.168.10.10;
     range dynamic-bootp 192.168.10.100 192.168.10.200;
     default-lease-time      21600;
     max-lease-time          43200;
     next-server             192.168.10.10;
     filename                "pxelinux.0";
}

# 重启服务并开机启动
systemctl restart dhcpd
systemctl enable dhcpd

# 添加防火墙对dhcpd服务允许的规则
firewall-cmd --permanent --add-service=dhcp
firewall-cmd --reload 
```

#### TFTP

```bash
# 安装tftp服务程序：
yum install tftp-server
# 编辑xinetd配置文件，启动TFTP服务程序
vim /etc/xinetd.d/tftp

//将disable的值修改为no。
service tftp
{
    socket_type             = dgram
    protocol                = udp
    wait                    = yes
    user                    = root
    server                  = /usr/sbin/in.tftpd
    server_args             = -s /var/lib/tftpboot
    disable                 = no
    per_source              = 11
    cps                     = 100 2
    flags                   = IPv4

# 重启xinetd服务并添加到开机启动项中
systemctl restart xinetd
systemctl enable xinetd

# 添加防火墙对tftp服务允许的规则
firewall-cmd --permanent --add-port=69/udp
firewall-cmd --reload
```

#### SYSLinux

用于提供引导加载的服务程序，目的是简化安装Linux系统的时间。

```bash
# 安装syslinux服务程序
yum install syslinux

# 将引导相关文件复制到tftp目录以供客户端下载（请确保光盘镜像已挂载到/media/cdrom）
cd /var/lib/tftpboot
cp /usr/share/syslinux/pxelinux.0 .
cp /media/cdrom/images/pxeboot/{vmlinuz,initrd.img} .
cp /media/cdrom/isolinux/{vesamenu.c32,*.msg} .

# 将引导模板文件复制tftp目录
mkdir pxelinux.cfg
cp /media/cdrom/isolinux/isolinux.cfg pxelinux.cfg/default

# 编辑引导模板文件

vim pxelinux.cfg/default
//将第1行修改为：
default linux
//将第64行修改为：
append initrd=initrd.img inst.stage2=ftp://192.168.10.10 ks=ftp://192.168.10.10/pub/ks.cfg quiet
//将第70行修改为：
append initrd=initrd.img inst.stage2=ftp://192.168.10.10 rd.live.check ks=ftp://192.168.10.10/pub/ks.cfg quiet
```

#### VSFtpd

```bash
# 安装vsftpd服务程序
yum install vsftpd

# 重启vsftpd服务程序并添加到开机启动项
systemctl restart vsftpd
systemctl enable vsftpd

# 添加防火墙对vsftpd服务允许的规则
firewall-cmd --permanent --add-service=ftp
firewall-cmd --reload 

# 将光盘镜像文件的内容复制到FTP目录中（请先确保您的光盘已经挂载到/media/cdrom目录）
cp -r /media/cdrom/* /var/ftp

# 设置SELinux对于FTP协议的允许策略
setsebool -P ftpd_connect_all_unreserved=on
```

#### 创建KickStart应答文件

```bash
# 复制一份应答文件模板并给于权限
cp ~/anaconda-ks.cfg /var/ftp/pub/ks.cfg
chmod +r /var/ftp/pub/ks.cfg

# 编辑模板文件
vim /var/ftp/pub/ks.cfg 

//将第6行的cdrom修改为
 url --url=ftp://192.168.10.10
//将第21行的时区修改为
 timezone Asia/Shanghai --isUtc
//将第28行修改为
 clearpart --all –initlabel
```

#### 自动部署客户机

  

### 方法2 Cobbler

## Ubuntu

