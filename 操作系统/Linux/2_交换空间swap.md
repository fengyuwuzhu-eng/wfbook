# 交换空间

[TOC]

## 概述

现代操作系统都实现了“虚拟内存”这一技术，不但在功能上突破了物理内存的限制，使程序可以操纵大于实际物理内存的空间，更重要的是，“虚拟内存”是隔离每个进程的安全保护网，使每个进程都不受其他程序的干扰。

交换空间是受 Linux 内核内存管理子系统控制的磁盘区域。内核使用交换空间，通过保存不活动的内存页面来补充系统 RAM 。系统 RAM 和交换空间组合在一起称为虚拟内存。

当系统上的内存使用量超过定义的限制时，内核将搜索 RAM ，寻找已分配给进程但空闲的内存页。内核将空闲的内存页写入到交换区，并向其他进程重新分配 RAM 页面。如果某个程序需要访问磁盘上的页面，则内核会找到另一个空闲的内存页，将其写入到磁盘，然后从交换区重新调用所需的页面。

由于交换区位于磁盘上，与 RAM 相比，交换会比较慢。虽然是用于增加系统 RAM ，但对于 RAM 不足以满足工作负载需求的问题，不应将交换空间视为可持续性的解决方案。

注意：并不是所有从物理内存中交换出来的数据都会被放到 swap 分区中，有相当一部分数据被直接交换到文件系统中。例如，有的程序会打开一些文件，对文件进行读 / 写（其实每个程序至少要打开一个文件，那就是运行程序本身），当需要将这些程序的内存空间交换出去时，就没有必要将文件部分的数据放到 swap 分区中了，而可以直接将其放到文件中。如果是读文件操作，那么内存数据被直接释放，不需要交换出来，因为当下次需要时，可直接从文件系统中恢复；如果是写文件操作，那么只要将变化的数据保存到文件中，以便恢复。

## 空间配置建议

分配太多的 swap 分区会浪费硬盘空间，而 swap 分区太小，如果系统的物理内存用完了，系统就会运行得很慢，但仍能运行；如果 swap 分区用完了，系统就会发生错误。

通常情况下，swap 分区应大于或等于物理内存的大小，一般官方文档会建议 swap 分区的大小应是物理内存的 2倍。但现在的服务器通常有 16GB/32GB 内存，是不是 swap 分区也要扩大到 32GB/64GB 呢？其实，大可不必。根据服务器实际负载、运行情况及未来可能的应用来综合考虑 swap 分区的大小即可，如桌面系统，只需要较小的 swap 分区；而服务器系统，尤其是数据库服务器和 Web 服务器，则对 swap 分区要求较高。

| RAM          | 交换空间 | 允许Hibernate时的交换空间 |
| ------------ | -------- | ------------------------- |
| 2GiB或以下   | 2倍RAM   | 3倍RAM                    |
| 2GiB ~ 8GiB  | 同等RAM  | 2倍RAM                    |
| 8GiB ~ 64GiB | 至少4GiB | 1.5倍RAM                  |
| 64GiB以上    | 至少4GiB | 不建议Hibernate           |

> 笔记本电脑和台式机的 Hibernate 功能会在关闭系统电源之前使用交换空间来保存 RAM 内容。重新打开系统时，内核将从交换空间恢复 RAM 内容，无需完全启动系统。交换空间需要超过 RAM 量。

## 创建交换空间

```bash
parted /dev/vdb
mkpart
Partition name?  []?		swap1
File system type? [ext2]?	linux-swap
Start?						1001MB
End?						1257MB
quit

udevadm settle
```

## 格式化设备

```bash
# 向设备应用交换签名。与其他格式化实用程序不同，mkswap在设备开头写入单个数据块，而将设备的其余部分保留为格式化。
mkswap /dev/vdb2
```

## 激活/关闭交换空间

```bash
swapon /dev/vdb2

swapon -a
# 激活/etc/fstab文件中列出的所有交换空间。

# 持久激活交换空间/etc/fstab
UUID=39e2556b-9358-42fc-9442-c4c734604772	swap	swap	defaults	0 0
# 重启systemctl
systemctl daemon-reload

swapoff
# 停用交换空间。如交换空间具有写入的页面，会尝试将这些页面移动到其他活动交换空间或将其写回到内存中。
```

## 检查可用交换空间

```bash
swapon --show

free
```

## 设置交换空间优先级

默认情况下，系统会按顺序使用交换空间。可以设置优先级，强制按照数据使用交换空间。

在 `/etc/fstab` 中使用 `pri` 选项。默认优先级为-2。数值越大，优先级越高。当交换空间具有相同的优先级时，内核会轮循方式向其中写入。

```bash
UUID=39e2556b-9358-42fc-9442-c4c734604772	swap	swap	pri=4	0 0
```

显示交换空间的优先级

```bash
swapon --show
```

