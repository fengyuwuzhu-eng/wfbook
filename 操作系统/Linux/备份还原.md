# 备份与还原

[TOC]

在大多数站点中，存储在计算机中的信息要比计算机本身更有价值。这些信息也很难替代。保护这些信息是系统管理员最重要的（而且很遗憾，也是最单调乏味的）任务之一。

丢失数据的方式成百上千，这些方式有的很有创造性，而有的则“不那么有创造性”。照例，软件缺陷（bug）会损坏数据文件。用户会意外地删除他们毕生的劳动成果。黑客以及那些对公司不满的雇员会删除磁盘上的数据。硬件问题和自然灾害则会破坏掉整个机房。

如果执行过正确的备份，那么就能让管理员把文件系统（或者是文件系统的任何部分）恢复成它上次备份时的状态。备份必须仔细进行，并且应该有严格的时间表。备份系统和备份介质也必须定期进行检查以确保它们能正确工作。

备份介质的完整性直接影响着公司的基本运营。高级管理人员需要理解备份实际上应该做什么，而不是他们想让备份做什么。如果某个大学计算机科学系丢失了一天的工作数据，可能没有太大影响，但如果是一个日用品贸易公司，就不会没有影响了。

我们将以一些备份的基本思想来开始本章的内容，随后讨论最常用的备份设备和备份介质（它们的优缺点以及成本等）。接下来，我们将讨论 Linux 的备份和存档命令，并且就哪种情况下最好使用哪个命令给出一些建议。然后，我们将讨论如何设计备份方案，并回顾一下流行的 dump 和 restore 工具的使用技巧。

## 备份基本原理

在我们深入介绍备份之前，我们想讲述一些我们不断学到的普遍经验（通常是以艰难的方式学到的）。在这些建议中，没有任何一条经验是绝对的规则，但您会发现，您遵循的规则越多，进行备份的过程就会越顺利。

### 从一台机器执行所有的转储

许多备份工具都允许通过网络执行转储（dump）。尽管这么做会有一些性能上的损失，但由此带来的管理上的轻松却使之值得去做。我们已经发现的最好方法就是，在一个中心位置上运行一个脚本（通过 rsh 或者 ssh 的方式）在需要转储的每台机器上执行 rdump，或者使用一个能够自动完成这个过程的软件包（商用的、免费的或者共享的软件）。所有转储都应该保存到同一个备份设备中（当然这个备份设备是非自动倒带的设备）。

如果网络太大，不能用一个单独的设备进行备份，也应该让备份系统尽可能集中。集中可以使管理更容易，还可以核实备份的完整性。根据所用备份介质的不同，往往可以在一台服务器上配置一台以上的备份介质设备而不会影响性能。

### 给备份介质加卷标

清楚而完整地给每个备份设备添加卷标是非常重要的。没有卷标的磁带是空磁带。应该在带身上做标记，唯一地标识出它的内容。诸如文件系统的列表和转储日期这样的详细信息都可以写在盒子上。

您必须能做到，不看转储脚本，就可以恢复根和 /usr 文件系统。给文件系统的备份介质添加卷标时，可以用它们的格式、创建它们的 dump 命令的准确语法、以及不参考在线文档来恢复它们时所需的任何其他信息。

现在有一些免费的或者是商用的给备份添加卷标的程序。为了解决这个令您头痛的大问题，您可以考虑买一种这样的软件。如果您为自己的激光打印机购买了标签，那么通常情况下标签厂商会提供生成这些标签的（Windows）软件。更好的做法是，购买一种专用的 Windows 标签打印机。它们价格不贵，而且效果好。

### 选择合理的备份间隔

备份的频率越高，在系统崩溃时可能丢失的数据量就会越少。然而，备份会占用系统资源和操作者的时间。系统管理员必须以合理的时间和材料消耗为代价，提供充分的数据完整性。在那些繁忙的系统中，通常情况下，每个工作日对主（home）目录中的文件系统进行备份是比较合适的。在那些使用不很频繁的系统或者那些数据变化不大的系统中，可能一周内做几次备份就足够了。在只有一个用户的小型系统中，一个星期做一次备份可能就够了。您的用户愿意丢失多少数据呢?

### 仔细选择文件系统

那些很少进行修改的文件系统不必像用户的主目录那样频繁地备份。如果在某个静态文件系统中只有少数文件有变化（比如说根文件系统中的 /etc/passwd），那么每天都应该把这些文件复制到另外一个定期做备份的分区中。

如果 /tmp 是一个独立的文件系统，那么就不应该备份它。/tmp 目录不应该包含任何重要的信息，所以没有任何理由去保存它。尽管这是很明显的，但据我们所知，有一个大型站点每天都对 /tmp 进行备份。

### 在一卷磁带上做日常转储

在一种完美的情况下，可以把自己的所有用户文件系统每天转储到一卷磁带上。对于某些站点而言，像 DLT、AIT 和 LTO 这样的高密度介质就可以完成。可以每天在下班之前安装上一卷磁带，然后在晚上让 cron 替您做备份。这样，转储操作就会在文件不太可能发生变化的时候进行，并且转储操作对用户造成的影响也是最小的。

随着我们工作习惯的改变以及远程办公方式变得更为流行，适合做备份的时间范围正在缩小。根据我们的日志，我们看到凌晨 3:00 到 6:00 是最好的时间。不过，在 3 个小时候内备份 80TB 的数据不太可能。另一个主要问题是因为硬盘价格的降低造成计算机磁盘空间迅速膨胀。用户不再会购买磁盘空间不到 100GB 的台式机。当您只需要花上很少的钱就能够解决这个问题的时候，为什么还要对硬盘进行清理以及强行使用磁盘配额呢？遗憾的是，让计算机的联机存储容量超过备份能力所及太容易了。

如果一卷磁带装不下您的日常备份，那么还有几种选择：

* 购买一个更大容量的备份设备。
* 购买一台自动换带机或者磁带库，把多个存储介质安装到一台设备中去。
* 改变转储顺序。
* 编写更智能的脚本。
* 使用多个备份设备。

自动转储系统应该始终记录下它转储的每个文件系统的名称。保存好记录可以让您在需要恢复文件时能够迅速向前跳到正确的文件系统。在磁带的外部记录文件系统的顺序也是不错的想法（前面已提到过，但应当经常重申这个问题：一定要使用非自动倒带的磁带设备来把多次转储写入到磁带中）。

### 使文件系统小于转储设备

dump 以及其他容易得到的工具都能够完美地胜任将文件系统转储到多卷磁带中的操作。但如果一次转储跨越了多卷磁带，那么操作者必须待在现场来更换磁带，并且还应该对磁带仔细标记，使将来的恢复过程能够很容易地完成。除非您有充分的理由要去创建一个确实很大的文件系统，否则不要那么做。

### 异地保存磁带

多数机构都是把备份异地保存，这样一来，诸如失火这样的灾难就不会同时破坏原始数据和备份数据。异地保存的位置可以是任何地方，从银行里的保险箱，到总裁或者 CEO 的家里都行。那些专营安全保存备份介质的公司，能够为您的存档提供一个既安全又有空调的环境。一定要确保异地存储服务的提供商信誉好、有担保并且保险。现如今还有在线（但是异地）公司专营数据保护业务。

将磁带移至异地的速度应该取决于需要恢复文件的频率以及所能接受的等待时间的多少。一些站点通过每天进行两次转储的方式来避开非做决策不可的情形（这两次是转储到不同的磁带设备中）：一份转储放置在本地，另外一份转储被立刻移至异地。

### 保护备份

安全顾问 Dan Geer 说,“备份会做些什么呢？它毫无疑问会在异地使文件权限受到侵害。”

做好备份磁带的安全工作。因为它们包含了单位的所有数据，任何能在物理上接触到备份的人都能读取它们。不仅应该把那些磁带保存在异地，还应该妥善保存它们。如果您为了达到这个目的而使用了商用存储设施，那么与您打交道的那个公司应该保证磁带在其关照之下的机密性。

对备份磁带加密是一种可以考虑的方法。许多商业备份工具都能让加密相当轻松。另一方面，必须保证加密密钥不会丢失或者破坏，而且在紧急时刻能拿到。有些公司非常看重备份的重要性，所以做了双备份，实际上这的确是个不错的主意。

### 执行转储期间限制活动

在转储过程中应该对文件系统的活动进行限制，因为那些变化会引起备份工具出错。可以通过在只有很少的活动用户时（半夜或者周末的时候）进行转储操作，或者通过使文件系统只能由备份工具访问的方式来限制活动（后一种预防措施从理论上讲还不错，但却很少能实现。用户想要对所有文件系统具有 24/7 的访问能力。如今已不可能在没有磁盘活动的情况下做备份了）。

类似 Network Appliance 公司制造的专用文件服务器，可以通过定期对文件系统做“快照（snapshot）”来提供在线备份，而且这个时间间隔是可调的。这项功能可以对活动的文件系统进行安全备份，这也是使用专用文件服务器的重要优点之一。

### 检查磁带

我们已经听说过很多关于系统管理员的可怕故事，这些系统管理员直到发生了一起严重的系统错误之后才发现转储工作的问题。关键在于，您应该连续监视备份过程，并且验证它在正确工作。操作人员的错误对转储的破坏比任何其他问题都要多。

第一项检查就是在完成转储之后让转储软件马上试着去重新读取这些磁带（可以用 restore -C 来校验转储磁带和目录树）。扫描磁带以验证它包含了期望数目的文件，就是一次良好的检查。如果能够扫描每卷磁带，那就最好了。但对于每天使用数百卷磁带的大型机构而言，这种方法就不可行。在这种环下，最谨慎的做法是随机抽查。

为每个文件系统生成一个目录（dump 命令的用户可以使用 restore -t 命令），并且把结果存储在磁盘上，这往往是有用的。这些编目的名字应该和对应的磁带相关，比如说，okra:usr.Jan.13 。有了一个星期的记录，就可以很容易地找到某个丢失的文件在哪卷磁带上。您只需使用 grep 命令检索要找的文件名，然后挑出最新的一个实例即可。

除了提供磁带的编目之外，成功从磁盘读取目录，可以表明转储结果良好，在您需要的时候就能够读取该磁带。迅速尝试一下恢复任意一个文件将会增强您对自己能从磁带中恢复文件系统的自信（例如，restore-t命令只读取转储磁带的目录，此目录保存在磁带的开头。在真正开始恢复一个文件时，则相当于在测试该介质更大范围的区域。）。

还应该定期尝试从不同的磁带恢复备份，以确认备份仍能恢复。应该时常试着从旧转储磁带（几个月或者几年之前的磁带）中进行恢复操作。随着时间的推移驱动器的磁头会无法和磁道对齐，从而不能读取那些旧磁带。这些磁带的数据可以通过专门提供这种服务的公司来进行恢复，但这非常昂贵。

还有一项相关检查，就是验证您不只能在自己的硬件上读取这些磁带。如果机房失火，那么即使知道转储磁带能够被某个已经毁坏的磁带驱动器读取也是没有多大用处的。以前，DAT 磁带特别容易发生这种问题，但是这一技术最近的版本已经得到改进。

### 发掘磁带的寿命

磁带只有有限的使用寿命。能循环使用存储介质当然很好，但一定要遵守制造商们关于磁带寿命的建议。大多数制造商是根据磁带能够承受的周转次数来对磁带的寿命进行量化的：一次备份、一次恢复以及一次 mt fsf（文件向前跳进）操作都代表一次磁带周转。非磁带技术的寿命则长得多，有时候用平均故障时间（MTTF，mean-time-to-failure）来表示。

在把老磁带扔进垃圾箱之前，要记得清除磁带或者让它们不可读取。批量磁带清除机（一种大型电磁设备）有助于完成这项工作，但要确保让它远离计算机和正在用的磁带。剪断或者拽出一盘备份磁带的一部分都不能真正保护数据，因为很容易接合断开的磁带或者把磁带重新绕回去。付费的话就能让文件销毁公司把磁带切碎。

### 为备份而设计数据

随着硬盘变得那么便宜，而且新的存储体系结构又那么可靠，不对所有数据进行备份成为诱人的目标。有了一种合理的存储体系结构——它是随着磁盘需要的增加而设计出来的，而不是随意出现的——很容易就能完成大量备份工作。您可以从制作一份自己的存储需求清单开始：

* 站点要处理的不同类型的数据。
* 每种类型的数据预期的变更率。
* 为避免可能丢失数据而确定的备份频率。
* 数据会散布的行政范围。

可以使用这个信息，在考虑到备份和潜在增长的条件下设计自己站点的存储体系结构。将项目目录和用户主目录保存在一个专用的文件服务器中可以使数据管理以及数据安全的保障更容易一些。

### 作最坏的准备

在建立起一个备份过程之后，应该研究一下可能出现的最坏情形：您的站点被完全破坏了。确定一下有多少数据会丢失，以及需要花上多长时间才能让自己的系统重新开始工作（包括花在购买新硬件上的时间）。然后决定自己能否承受这个后果。

## 备份设备和介质

因为很多类型的故障都可以一次破坏好几个硬件设备，所以备份应该写入到某种可移动的介质中去。例如，将一个硬盘中的数据备份到另外一个硬盘中（尽管这比完全不进行备份要好一些）几乎不能保护不受硬盘控制器故障的影响。在过去的几年中，通过 Internet 对数据进行备份的那些公司已经进入到了这种移动存储的时代，但大多数备份仍然是在本地保存。

很多类型的介质都是使用磁性颗粒来保存数据的。这些介质容易受到电场或者磁场的破坏。下面是要避免的一些特殊危险：音频扬声器、变压器和电源、没有外壳的电机、硬盘风扇、CRT 监视器、甚至长期暴露在地球的背景辐射。所有磁带经过若干年后都会变得不可读。大多数介质可以保存 3 年，但如果您打算把数据保存得更长一些，那么就应该使用别的介质或者重新把数据记录在磁带上。

下面的几小节将描述一些用于备份的介质。对这些介质的介绍大体上是根据容量从小到大的顺序来进行的。

制造商喜欢根据压缩后的数据来提供磁带的容量，他们常常会乐观地假定 2:1 或者更高的数据压缩比率。在下面几节中，我们会忽略掉压缩，而只提出能够物理存储在每个存储介质中的实际字节数。

假定的压缩比率还会影响驱动器的吞吐速率。如果一个驱动器在物理意义上能够以 1MB/s 的速率写入到磁带中，但制造商假定了 2:1 的压缩比率，那么吞吐量就会神奇地上升到 2MB/s 。和磁带容量的表示一样，下面我们也忽略掉了吞吐量的夸大。

尽管成本和介质容量都是重要的考虑因素，但考虑吞吐量也很重要。人们更乐于使用速度快的介质，而且使用速度快的介质在转储的安排上也更灵活。

在本书的上一版里，我们提到了传统和超级容量（例如，Zip 盘）两种软盘，把它们也当作备份介质。这些介质发展都很成熟，但是由于您不大容易再买到带有软驱的膝上机，所以我们现在把这两种介质从我们的清单中剔除。虽然软盘对于交换数据来说很有用，但是它们的成本太高，选用它们做备份很不合适。

### 光盘：CD-R/RW、DVD+R/RW 和 DVD-RAM

CD 和 DVD 的成本只有大约每张 0.40 美元，对于小型独立系统的备份而言，是一种很有吸引力的选择。CD 的容量大约为 650MB，DVD 的容量为 4.7GB 。正在成为主流的双层 DVD 容量有 8.5GB 。

每种常见的总线（SCSI、IDE 和 USB 等）都有能写这类介质的驱动器，而且在许多情况下，这些设备都便宜到近乎于不要钱的程度。CD 光盘过去也大量使用，但是现在似乎已经过气了。既然 CD 和 DVD 的价格相称，所以除了现实中 CD 的光驱仍然比较常见之外，没有理由不用 DVD 而用 CD 。

光学介质是通过在光化学过程中使用一束激光来写数据的。虽然“硬”保存的数据寿命还不好说，但是人们普遍认为光学介质肯定要比磁性介质的寿命长。不过,一次性刻录的光学介质（CD-R、DVD-R 和 DVD+R）没有制成品（压制）的 CD 和 DVD 经久耐用。

CD-R 不合适用于常规备份，但适合做未来长时间以后恢复的数据存档。CD-RW 适合做定期小批量个人数据的存档。

现如今，快速 DVD 刻录机的速度如果不比磁带机块，也已经和它一样快了。DVD 的一次性刻录版本是 DVD-R（Pioneer 公司在 1997 年的研发成果）和 DVD+R（多家公司在 2002 年联合研发的成果）。DVD-RW、DVD+RW 和 DVD-RAM 都可以刻录。DVD-RAM 系统内建纠错管理功能，因此比其他光学存储介质更可靠。另一方面，它的价格也更贵。

据制造商估计，如果这些光学介质得到妥善保存，那么它们的预计寿命可达数百年。制造商建议的正确保存方法包括采用单独的外套，保存在一个温度恒定在 41~68 华氏度之间，相对湿度在 30%~50% 之间，不会受到阳光直射的环境里，并且用水溶性记号笔标记。在平均条件下，有 1~5 年的可靠保质期可能更实际一些。

根据多种第三方的评估，光学介质的可靠性经证实特别依赖于制造商。购买高质量的介质就能有好效果。遗憾的是，甚至在一家制造商的生产线上，产品之间的质量也不一样，所以没有能打保票的制造商。近年来，Taiyo Yuden 公司在可靠性上力拔头筹，但也仅限于在日本制造的介质，Taiyo Yuden 在其他国家生产的介质良莠不齐。

Blu-Ray 光盘最近进入光学数据存储市场，它的各种形式能够存储 25~100GB 的数据。容量大是读写光盘采用了短波激光（405nm）的缘故（Blu-Ray 中的  Blue [蓝]由此得名）。它的第一种播放器于 2006 年 6 月在美国面世。这项技术值得关注，它有希望成为备份的良好解决方案。

### 可移动硬盘（USB 和火线）

通过 USB 或者火线（IEEE 1394）端口连接的外部存储设备已经变得很常见了。支撑它的存储技术通常是硬盘的某种形式，但是在低端（无处不在的 “JumpDrive”）采用闪存设备的情况也很多。它的容量从不到 1MB 到 600GB 以上。目前闪存设备容量的上限大约为 4GB 。

这些设备的主要局限性在于总线速率，除非采用了 USB2.0 和 FireWire 800 ，两者的吞吐率都能达到可观的 50~90MB/s 这个范围。

闪存设备的寿命几乎就取决于写数据的次数。中等程度的设备应该能写数百万次。

### 小型磁带机：8 毫米磁带和 DDS/DAT

各种 8 毫米和 DDS/DAT 磁带机组成了低端磁盘存储市场。Exabytes 公司的 8mm 磁带机是早期的型号，但是这种磁带机每隔 6~12 个月磁头就无法对齐磁道，需要送修。这种磁带 2~7GB 的容量使得它们都不适合用于备份现如今的桌面系统，更不用说服务器了。

DDS/DAT（Digital Audio Tape，数字音频磁带）磁带机是使用 4mm 盒式磁带的螺旋扫描设备。虽然这类设备通常叫做 DAT 磁带机，但它们实际上是 DDS（Digital Data Storge，数字数据存储）磁带机。准确地区别它们并不重要。这种磁带一开始的格式容量为 2GB，但是后几代产品大大提高了 DDS 的容量。目前这一代产品（DAT 72）的数据容量达到 32GB，传输速率为 3.5MB/s 。这种磁带应该经得起 100 次备份操作，根据报告，它们的寿命有 10 年。

### DLT 和 S-DLT

DLT/S-DLT（Digital Linear Tape，数字线性磁带 / Super Digital Linear Tape，超级数字线性磁带）是一种主流的备份介质。这类磁带机性能可靠，价格不高，并且可以保存大量数据。它们源自 DEC 的 TK-50 和 TK-70 盒式磁带机。DEC 将这项技术卖给了 Quantum 公司，Quantum 公司通过提高它们的速度和容量以及降低它们的价格使之得到了普及。2002年，Quantum 公司获得了 Benchmark Storage Innovations 公司的 Super DLT 技术，这项技术让记录磁头前后倾斜，减少了相邻磁道之间的串扰。

Quantum 公司现在提供两种硬件产品线：高性能产品线和高性价产品线。用户花什么样的价钱就能买到什么样的产品。磁带容量从 DLT-4 的 800GB 到 DLT-4 高性价产品线的 160GB，两者的传输速率分别为 60MB/S 和 10MB/S 。制造商宣传这种磁带的寿命有 20~30 年——也就是说，如果能读它们的硬件还存在，这种磁带就能用。可现如今还有多少 9 道磁带机仍然可以工作还能用呢？

S-DLT 的缺点是磁带的价格高，每盘大约 30~45 美元。对于大学来说昂贵了点，或许对于华尔街的投资公司来说并不贵。

### AIT 和 SAIT

AIT（Advanced Intelligent Tape，先进智能磁带）是 Sony 公司自己的 8mm 产品。1996 年，Sony 公司解除了它和 Exabyte 公司的关系,并推出了 AIT-1，这是一种 8mm 螺旋扫描设备，其容量是 Exabyte 公司 8mm 磁带容量的两倍。自从最初产品发布以来，Sony 公司已经推出了一种 AIT-1 的高容量版本以及后续的 AIT-4，AIT-4 的容量达到 200GB，最高传输速率为 24MB/S 。

SAIT 是索尼的半高产品，它使用的磁带比 AIT 大，容量也比 AIT 大。SAIT 磁带能够保存 500GB 的数据，传输速率达到 30MB/s 。这种磁带以磁带库产品的形式使用最为流行。AIT 磁带机中使用的 AME（Advanced Metal Evaporated，高级金属薄膜）磁带具有很长的使用寿命。它们还包含一个内置的 EEPROM，能让介质本身有一些智能。但是，任何 EEPROM 的实际使用都需要有软件支持。这种磁带机和磁带的价格和 DLT 大致相同。

### VXA 和 VXA-X

Exabyte 公司现在的产品包括 VXA 和 VXA-X 技术。VXA 驱动器使用 Exabyte 公司称之为分组数据传输的技术。VXA-X 产品仍然依赖 Sony 公司的 AME 磁带，V 系列产品随着更大容量的磁带出现可以随之升级。VXA 和 X 系列的产品标称容量在 33~160GB，传输速率为 24MB/s 。

### LTO

IBM、HP 和 Quantum 公司共同开发了 LTO（线性磁带开放标准，Linear Tape-Open）用做专有 DLT 格式的替代格式。最新版的 LTO-3 容量为 400GB，速度达到 80MB/s 。LTO 磁带的预计存储寿命为 30 年，但是容易受到漏磁的影响。400GB 磁带的成本大约为 80 美元。

### 自动选带机、自动换带机以及磁带库
现在随着低成本硬盘的使用，大多数站点的硬盘空间都相当大，以至于一次完整的备份即使在每卷磁带存储 100GB 数据的情况下，也需要多卷磁带才能完成。对于这些站点而言，一种可能的解决方案就是使用自动换带机（stacker）、自动选带机（jukebox）或者磁带库（jukebox 和 stacker 最大的区别就在于，iukebox  能够以任意次序选取磁带，因此较为智能。而 stacker 则只能依次更换磁带，所以把它们分别称为自动选带机和自动换带机）。

自动换带机是和标准磁带机一起使用的一种简单的更换磁带设备。它具有可装载磁带的送带箱。当那些已写满的磁带从驱动器中弹出时，它会退出磁带，然后用送带箱中的空白磁带替换它们。大多数自动换带机都能存放大约 10 卷磁带。

自动选带机是一种能够在一定数目的磁带机中自动调换可移动磁带的硬件设备，这和一种老式的能够在一个转盘上更换唱片的自动点唱机很相似。这里讨论的所有磁带都可以使用自动选带机。自动选带机经常和能够理解如何操纵更换机的专用备份软件捆绑销售。Storage Technology 公司（现在的
Sun 微系统公司）和 Sony 公司是生产这类产品的两个制造商。

磁带库是一种用于大型数据集合——它们通常达到太字节(TeraBytes，10<sup>12</sup> 字节)——的硬件备份解决方案。它们是带有多卷磁带（或者 CD）机的厨柜大小的机械装置，还有一个用来在磁带库的很多层架子上对介质进行检索和归档的机械臂。可以想象，购买和维护它们是非常昂贵的，而且它们要求有专用的电源、空间以及空调。大多数磁带库的购买者还需要购买一份来自制造商的运行合同来优化和运行设备。当然，磁带库还有一个软件部件，它在设备上实际运行。Storage Technology 公司（Sun 微系统公司）是磁带库制造商中的领头羊。

### 硬盘

不断降低的硬盘驱动器成本成为考虑从硬盘到硬盘做备份的一个吸引人的原因。尽管我们建议不要在同一台机器上将一个硬盘上的数据复制到另外一个硬盘里去，但在网络上，硬盘是一个低成本的好解决方案。

一个明显的问题就是硬盘的存储空间是有限的，并且最终必须重新使用。但是，从硬盘到硬盘的备份是防止文件被意外删除的极好办法。如果通过 NFS 或 CIFS 共享，在大家熟知的位置上保留一个每天更新的硬盘映像，那么用户无需管理员的帮助就能够进行错误恢复。另一种流行的选择是采用如今的大容量火线和 U 盘做台式机的备份。Cintre ZDisc 1-Button Instant Backup 是一种 3.5 英寸的外置 USB 2.0硬盘，这种富有吸引力的设备价格大约在 100 美元。

### 介质类型小结

介质的类型太多啦！下表对上面各小节中讨论到的介质的特性进行了汇总。

| 介质        | 容量 <sup>a</sup> | 速度 <sup>a</sup> | 驱动器 | 介质 | 每GB成本 | 能否重用？ | 是否随机方式？ <sup>b</sup> |
| ----------- | ----------------- | ----------------- | ------ | ---- | -------- | ---------- | --------------------------- |
| CD-R        | 650MB             | 4MB/s             | $15    | 20   | 32       | 否         | 是                          |
| CD-RW       | 650MB             | 4MB/s             | $20    | 30   | 48       | 是         | 是                          |
| DVD±R       | 4.7GB             | 10MB/s            | $50    | 40   | 9        | 否         | 是                          |
| DVD+R DL    | 8.5GB             | 10MB/s            | $50    | $2   | 24       | 否         | 是                          |
| DVD±RW      | 4.7GB             | 10MB/s            | $50    | 80   | 17       | 是         | 是                          |
| DDS-4 (4mm) | 20GB              | 10MB/s            | $300   | $5   | 25       | 是         | 否                          |
| DLT/S-DLT   | 160GB             | 10MB/s            | $1000  | $20  | 13       | 是         | 否                          |
| AIT-4 (8mm) | 200GB             | 6MB/s             | $2500  | $40  | 20       | 是         | 否                          |
| SAIT-1      | 500GB             | 30MB/s            | $6500  | $126 | 25       | 是         | 否                          |
| VXA-172     | 86GB              | 12MB/s            | $600   | $30  | 35       | 是         | 否                          |
| VXA-320     | 160GB             | 12MB/s            | $800   | $60  | 35       | 是         | 否                          |
| LTO-3       | 400GB             | 30MB/s            | $3000  | $65  | 16       | 是         | 否                          |

a. 未经压缩的容量和速度。

b. 能随机访问介质的任意地方吗？

### 设备选型

当您要购置一套备份系统的时候，最好能把上表的内容搞得很清楚。所有种类的介质都能有比较好的表现，在那些价格比较接近的技术中，一般没有非选哪一种不可的理由。只要购置能够满足您的要求和预算的系统就行了。

对于小型工作组和存储量很大的个人计算机来说，DDS、AIT 和 LTO 驱动器是优秀的解决方案。它们的启动成本相当适中，磁带也到处都能买到，而且每种标准都有多家制造商采用。这几种系统的速度都足够快，可以在有限的时间里备份大量数据。

DLT、AIT 和 LTO-3 大致可比。在这三者之间没有一个很明显的赢家，即使有过，这一情形也毫无疑问将在几个月之内随着新版格式的发布而改变。所有这些格式都相当成熟，而且很容易集成到您的环境中，即大学和企业的环境。

## 用 dump 建立增量备份机制

dump 和 restore 命令是用来创建备份以及从备份恢复的最常见的方法。这两个程序已经存在很长时间了，它们的用法众所周知。在大多数站点中，dump 和 restore 都是支撑自动备份软件使用的命令。

根据在最初安装 Linux 时所作的选择的不同，可能不得不在 Linux 系统上明确安装 dump 和 restore 命令。当前的 Red Hat 和 Fedora Core 在安装时就提供给系统管理员一个包含 dump 的软件包。

在 Linux 下，没有什么是静态链接的，所以您需要 /lib 下的共享库来做些有用的事情。静态链接能够让灾难恢复更容易，因为静态链接的 restore 自己包含了要链接的库。

###  转储文件系统

dump 命令用来建立一份自上次转储操作以来进行过修改的文件列表，然后把这些文件打包成一个单独的大型文件，在外部设备上存档。dump 命令和本章后面要讲到的大多数其他工具相比较而言，具有以下一些优点：

* 备份可以跨越多卷磁带。
* 任何类型的文件（甚至是设备）都能备份和恢复。
* 访问权限、归属关系和修改时间都被保存下来。
* 有“孔洞”的文件能够被正确处理。（孔洞是指从未包含任何数据的文件块。如果您打开一个文件，写入一个字节，在文件中向前搜索 1MB，然后再写入另外一个字节，这样即使文件的逻辑大小要大得多，但得到的“稀疏”文件只会占用两个磁盘块。用伯克利 DB 和 ndbm 命令创建的文件都会包含很多孔洞。）
* 备份能够以增量的方式进行（只把那些最近修改过的文件写到磁带上去）。

Linux 上使用的 tar 是 GNU 的版本，它也能提供所有这些功能。不过，dump 对增量备份的处理要比 tar 稍微高级一点儿。如果您的需求比较复杂，那么您就会发现这多出来的功能是有用处的。

实际上，在 Linux 环境下，非要选择 dump 而不是 tar 的理由和 Linux 根本没有什么关系。遗憾的是，大多数主流 UNIX 发行版本所附带的 tar 版本缺乏 GNU 的 tar 所具备的许多功能。如果您必须对 UNIX 和 Linux 都提供备份支持，那么 dump 是您最好的选择。它是唯一能够在不同平台上（相当）一致地处理好这些问题的命令，这样一来，您只要是一条命令的专家就够了，不必熟悉两条命令。如果您很幸运，处在一个纯 Linux 环境里，那么就可以选用自己最喜欢的工具啦。dump 的功能不足，而 tar 就好用多了！

dump 命令懂得原始文件系统的布局，它直接读取一个文件系统的 inode 表以决定哪些文件必须备份。有关文件系统的这些知识使得 dump 非常有效，但它也带来了一些限制。()

第一条限制就是每个文件系统必须单独转储备份。如果您有一个已经分过区的硬盘，那么必须对每个分区单独进行转储备份。另一项限制就是只有本地计算机中的文件系统才能够进行转储。从一台远程计算机安装的 NFS 文件系统不能转储备份。但可以使用 dump 的配套命令 rdump 把本地文件系统转储到远程的磁带驱动器中。

dump 命令最重要的特性就是它支持“增量”备份这一概念。尽管有可能每天都对整个文件系统进行备份，但这在通常情况下并不切合实际。利用增量备份，可以只对那些从上次备份之后进行了修
改的文件进行备份。在做备份的时候，要指定一个备份级别，它是0~9之间的一个整数。级别为N的转储会对从上次进行的级别小于N的转储操作以来修改过的所有文件进行备份。级别为0的备份会把整个文件系统转储到磁带上。使用增量备份系统后，要把文件系统重新恢复到它在上次备份时所处的状态，就得从若干套备份磁带中恢复文件“。
dump 命令的另外一个好特性就是它不关心文件名的长度。目录层次可以任意深，还可以正确处理长文件名。
dump 命令的第一个参数必须是增量转储级别。dump 使用/etc/dumpdates 文件来决定增量转储必须倒回去多远。-u标志可以使 dump 命令在转储完成之后自动更新/etc/dumpdates 文件，将日期、转储级别和文件系统的名称都记录下来。如果您从来没有指定过-u标志，那么所有转储都会变为级别 0，

!!! Note Throughout this chapter the command structures use "device"  to specify both a target location for backup, and the source location  when restoring. The device can be either external media or a local file. You should get a feel for this as the chapter unfolds, but you can  always refer back to this note for clarification if you need to.

The backup will answer a need to conserve and restore data in a sure and effective way.

The backup allows you to protect yourself from the following:

- **Destruction**: voluntary or involuntary. Human or technical. Virus, ...
- **Deletion**: voluntary or involuntary. Human or technical. Virus, ...
- **Integrity** : data becomes unusable.

No system is infallible, no human is infallible, so to avoid losing  data, it must be backed up to be able to restore after a problem.

The backup media should be kept in another room (or building) than  the server so that a disaster does not destroy the server and the  backups.

In addition, the administrator must regularly check that the media are still readable.

## 概论

There are two principles, the **backup** and the **archive**.

- The archive destroys the information source after the operation.
- The backup preserves the source of information after the operation.

These operations consist of saving information in a file, on a peripheral or a supported media (tapes, disks, ...).

### The process[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#the-process)

Backups require a lot of discipline and rigor from the system administrator. It is necessary to ask the following questions:

- What is the appropriate medium?
- What should be backed up?
- How many copies?
- How long will the backup take?
- Method?
- How often?
- Automatic or manual?
- Where to store it?
- How long will it be kept?

### Backup methods[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#backup-methods)

- **Complete**: one or more **filesystems** are backed up (kernel, data, utilities, ...).
- **Partial**: one or more **files** are backed up (configurations, directories, ...).
- **Differential**: only files modified since the last **complete** backup are backed up.
- **Incremental**: only files modified since the last backup are backed up.

### Periodicity[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#periodicity)

- **Pre-current** : at a given time (before a system update, ...).
- **Periodic**: Daily, weekly, monthly, ...

!!! Tip Before a system change, it can be useful to make a backup.  However, there is no point in backing up data every day that is only  changed every month.

### Restoration methods[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#restoration-methods)

Depending on the utilities available, it will be possible to perform several types of restorations.

- **Complete restoration**: trees, ...
- **Selective restoration**: part of tree, files, ...

It is possible to restore a whole backup but it is also possible to  restore only a part of it. However, when restoring a directory, the  files created after the backup are not deleted.

!!! Tip To recover a directory as it was at the time of the backup,  it is necessary to completely delete its contents before launching the  restoration.

### The tools[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#the-tools)

There are many utilities to make backups.

- **editor tools** ;
- **graphical tools**;
- **command line tools**: `tar`, `cpio`, `pax`, `dd`, `dump`, ...

The commands we will use here are `tar` and `cpio`.

- `tar`:
- easy to use ;
- allows adding files to an existing backup.
- `cpio` :
- retains owners;
- retains groups, dates and rights;
- skips damaged files;
- complete file system.

!!! Note These commands save in a proprietary and standardized format.

### Naming convention[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#naming-convention)

The use of a naming convention makes it possible to quickly target  the contents of a backup file and thus avoid hazardous restorations.

- name of the directory;
- utility used;
- options used;
- date.

!!! Tip The name of the backup must be an explicit name.

!!! Note The notion of extension under Linux does not exist. In other words, our use of extensions here is for the human operator. If the  systems administrator sees a `.tar.gz` or `.tgz` file extension, for instance, then he knows how to deal with the file.

### Contents of a backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#contents-of-a-backup)

A backup generally contains the following elements:

- the file;
- the name;
- the owner;
- the size;
- the permissions
- access date.

!!! Note The `inode` number is missing.

### Storage modes[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#storage-modes)

There are two different storage modes:

- file on disk;
- device.

## Tape ArchiveR - `tar`[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#tape-archiver-tar)

The `tar` command allows saving on several successive media (multi-volume options).

It is possible to extract all or part of a backup.

`tar` implicitly backs up in relative mode even if the  path of the information to be backed up is mentioned in absolute mode.  However, backups and restores in absolute mode are possible.

### Restoration guidelines[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#restoration-guidelines)

The right questions to ask are:

- what: partial or complete;
- where: the place where the data will be restored;
- how: absolute or relative.

!!! Warning Before a restoration, it is important to take time to  think about and determine the most appropriate method to avoid mistakes.

Restorations are usually performed after a problem has occurred that  needs to be resolved quickly. A poor restoration can, in some cases,  make the situation worse.

### Backing up with `tar`[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#backing-up-with-tar)

The default utility for creating backups on UNIX systems is the `tar` command. These backups can be compressed by `bzip2`, `xz`, `lzip`, `lzma`, `lzop`, `gzip`, `compress` or `zstd`.

`tar` allows you to extract a single file or a directory from a backup, view its contents or validate its integrity.

#### Estimate the size of a backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#estimate-the-size-of-a-backup)

The following command estimates the size in kilobytes of a possible *tar* file:

```
$ tar cf - /directory/to/backup/ | wc -c
20480
$ tar czf - /directory/to/backup/ | wc -c
508
$ tar cjf - /directory/to/backup/ | wc -c
428
```

!!! Warning Beware, the presence of "-" in the command line disturbs `zsh`. Switch to `bash`!

#### Naming convention for a `tar` backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#naming-convention-for-a-tar-backup)

Here is an example of a naming convention for a `tar` backup, knowing that the date is to be added to the name.

| keys    | Files   | Suffix           | Observation                                  |
| ------- | ------- | ---------------- | -------------------------------------------- |
| `cvf`   | `home`  | `home.tar`       | `/home` in relative mode, uncompressed form  |
| `cvfP`  | `/etc`  | `etc.A.tar`      | `/etc` in absolute mode, no compression      |
| `cvfz`  | `usr`   | `usr.tar.gz`     | `/usr` in relative mode, *gzip* compression  |
| `cvfj`  | `usr`   | `usr.tar.bz2`    | `/usr` in relative mode, *bzip2* compression |
| `cvfPz` | `/home` | `home.A.tar.gz`  | `home` in absolute mode, *gzip* compression  |
| `cvfPj` | `/home` | `home.A.tar.bz2` | `home` in absolute mode, *bzip2* compression |
| …       |         |                  |                                              |

#### Create a backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#create-a-backup)

##### Create a backup in relative mode[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#create-a-backup-in-relative-mode)

Creating a non-compressed backup in relative mode is done with the `cvf` keys:

```
tar c[vf] [device] [file(s)]
```

Example:

```
[root]# tar cvf /backups/home.133.tar /home/
```

| Key  | Description                                            |
| ---- | ------------------------------------------------------ |
| `c`  | Creates a backup.                                      |
| `v`  | Displays the name of the processed files.              |
| `f`  | Allows you to specify the name of the backup (medium). |

!!! Tip The hyphen (`-`) in front of the `tar` keys is not necessary!

##### Create a backup in absolute mode[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#create-a-backup-in-absolute-mode)

Creating a non-compressed backup explicitly in absolute mode is done with the `cvfP` keys:

```
$ tar c[vf]P [device] [file(s)]
```

Example:

```
[root]# tar cvfP /backups/home.133.P.tar /home/
```

| Key  | Description                       |
| ---- | --------------------------------- |
| `P`  | Create a backup in absolute mode. |

!!! Warning With the `P` key, the path of the files to be backed up must be entered as **absolute**. If the two conditions (key `P` and path **absolute**) are not indicated, the backup is in relative mode.

##### Creating a compressed backup with `gzip`[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#creating-a-compressed-backup-with-gzip)

Creating a compressed backup with `gzip` is done with the `cvfz` keys:

```
$ tar cvzf backup.tar.gz dirname/
```

| Key  | Description                      |
| ---- | -------------------------------- |
| `z`  | Compresses the backup in *gzip*. |

!!! Note The `.tgz` extension is an equivalent extension to `.tar.gz`.

!!! Note Keeping the `cvf` (`tvf` or `xvf`) keys unchanged for all backup operations and simply adding the  compression key to the end of the keys makes the command easier to  understand (e.g. `cvfz` or `cvfj`, etc.).

##### Creating a compressed backup with `bzip`[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#creating-a-compressed-backup-with-bzip)

Creating a compressed backup with `bzip` is done with the keys `cvfj`:

```
$ tar cvfj backup.tar.bz2 dirname/
```

| Key  | Description                       |
| ---- | --------------------------------- |
| `j`  | Compresses the backup in *bzip2*. |

!!! Note The `.tbz` and `.tb2` extensions are equivalent to `.tar.bz2` extensions.

##### Compression `compress`, `gzip`, `bzip2`, `lzip` and `xz`[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#compression-compress-gzip-bzip2-lzip-and-xz)

Compression, and consequently decompression, will have an impact on resource consumption (time and CPU usage).

Here is a ranking of the compression of a set of text files, from least to most efficient:

- compress (`.tar.Z`)
- gzip (`.tar.gz`)
- bzip2 (`.tar.bz2`)
- lzip (`.tar.lz`)
- xz (`.tar.xz`)

#### Add a file or directory to an existing backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#add-a-file-or-directory-to-an-existing-backup)

It is possible to add one or more items to an existing backup.

```
tar {r|A}[key(s)] [device] [file(s)]
```

To add `/etc/passwd` to the backup `/backups/home.133.tar`:

```
[root]# tar rvf /backups/home.133.tar /etc/passwd
```

Adding a directory is similar. Here add `dirtoadd` to `backup_name.tar`:

```
$ tar rvf backup_name.tar dirtoadd
```

| Key  | Description                                                  |
| ---- | ------------------------------------------------------------ |
| `r`  | Adds one or more files at the end of a direct access media backup (hard disk). |
| `A`  | Adds one or more files at the end of a backup on sequential access media (tape). |

!!! Note It is not possible to add files or folders to a compressed backup.

````

```
$ tar rvfz backup.tgz filetoadd
tar: Cannot update compressed archives
Try `tar --help' or `tar --usage' for more information.
```

````

!!! Note If the backup was performed in relative mode, add files in  relative mode. If the backup was done in absolute mode, add files in  absolute mode.

```
Mixing modes can cause problems when restoring.
```

#### List the contents of a backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#list-the-contents-of-a-backup)

Viewing the contents of a backup without extracting it is possible.

```
tar t[key(s)] [device]
```

| Key  | Description                                           |
| ---- | ----------------------------------------------------- |
| `t`  | Displays the content of a backup (compressed or not). |

Examples:

```
$ tar tvf backup.tar
$ tar tvfz backup.tar.gz
$ tar tvfj backup.tar.bz2
```

When the number of files in a backup becomes large, it is possible to *pipe* the result of the `tar` command to a *pager* (`more`, `less`, `most`, etc.):

```
$ tar tvf backup.tar | less
```

!!! Tip To list or retrieve the contents of a backup, it is not  necessary to mention the compression algorithm used when the backup was  created. That is, a `tar tvf` is equivalent to `tar tvfj`, to read the contents, and a `tar xvf` is equivalent to `tar xvfj`, to extract.

!!! Tip Always check the contents of a backup.

#### Check the integrity of a backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#check-the-integrity-of-a-backup)

The integrity of a backup can be tested with the `W` key at the time of its creation:

```
$ tar cvfW file_name.tar dir/
```

The integrity of a backup can be tested with the key `d` after its creation:

```
$ tar vfd file_name.tar dir/
```

!!! Tip By adding a second `v` to the previous key, you  will get the list of archived files as well as the differences between  the archived files and those present in the file system.

````

```
$ tar vvfd  /tmp/quodlibet.tar .quodlibet/
drwxr-x--- rockstar/rockstar     0 2021-05-21 00:11 .quodlibet/
-rw-r--r-- rockstar/rockstar     0 2021-05-19 00:59 .quodlibet/queue
[…]
-rw------- rockstar/rockstar  3323 2021-05-21 00:11 .quodlibet/config
.quodlibet/config: Mod time differs
.quodlibet/config: Size differs
[…]
```

````

The `W` key is also used to compare the content of an archive against the filesystem:

```
$ tar tvfW file_name.tar
Verify 1/file1
1/file1: Mod time differs
1/file1: Size differs
Verify 1/file2
Verify 1/file3
```

The verification with the `W` key cannot be done with a compressed archive. The key `d` must be used:

```
$ tar dfz file_name.tgz
$ tar dfj file_name.tar.bz2
```

#### Extract (*untar*) a backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#extract-untar-a-backup)

Extract (*untar]*) a `*.tar` backup is done with the `xvf` keys:

Extract the `etc/exports` file from the `/savings/etc.133.tar` backup into the `etc` directory of the active directory:

```
$ tar xvf /backups/etc.133.tar etc/exports
```

Extract all files from the compressed backup `/backups/home.133.tar.bz2` into the active directory:

```
[root]# tar xvfj /backups/home.133.tar.bz2
```

Extract all files from the backup `/backups/etc.133.P.tar` to their original directory:

```
$ tar xvfP /backups/etc.133.P.tar
```

!!! Warning Go to the right place.

```
Check the contents of the backup.
```

| Key  | Description                                       |
| ---- | ------------------------------------------------- |
| `x`  | Extract files from the backup, compressed or not. |

Extracting a *tar-gzipped* (`*.tar.gz`) backup is done with the `xvfz` keys:

```
$ tar xvfz backup.tar.gz
```

Extracting a *tar-bzipped* (`*.tar.bz2`) backup is done with the `xvfj` keys:

```
$ tar xvfj backup.tar.bz2
```

!!! Tip To extract or list the contents of a backup, it is not  necessary to mention the compression algorithm used to create the  backup. That is, a `tar xvf` is equivalent to `tar xvfj`, to extract the contents, and a `tar tvf` is equivalent to `tar tvfj`, to list.

!!! Warning To restore the files in their original directory (key `P` of a `tar xvf`), you must have generated the backup with the absolute path. That is, with the `P` key of a `tar cvf`.

##### Extract only a file from a *tar* backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#extract-only-a-file-from-a-tar-backup)

To extract a specific file from a *tar* backup, specify the name of that file at the end of the `tar xvf` command.

```
$ tar xvf backup.tar /path/to/file
```

The previous command extracts only the `/path/to/file` file from the `backup.tar` backup. This file will be restored to the `/path/to/` directory created, or already present, in the active directory.

```
$ tar xvfz backup.tar.gz /path/to/file
$ tar xvfj backup.tar.bz2 /path/to/file
```

##### Extract a folder from a backup *tar*[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#extract-a-folder-from-a-backup-tar)

To extract only one directory (including its subdirectories and  files) from a backup, specify the directory name at the end of the `tar xvf` command.

```
$ tar xvf backup.tar /path/to/dir/
```

To extract multiple directories, specify each of the names one after the other:

```
$ tar xvf backup.tar /path/to/dir1/ /path/to/dir2/
$ tar xvfz backup.tar.gz /path/to/dir1/ /path/to/dir2/
$ tar xvfj backup.tar.bz2 /path/to/dir1/ /path/to/dir2/
```

##### Extract a group of files from a *tar* backup using regular expressions (*regex*)[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#extract-a-group-of-files-from-a-tar-backup-using-regular-expressions-regex)

Specify a *regex* to extract the files matching the specified selection pattern.

For example, to extract all files with the extension `.conf` :

```
$ tar xvf backup.tar --wildcards '*.conf'
```

keys :

- **--wildcards \*.conf** corresponds to files with the extension `.conf`.

## *CoPy Input Output* - `cpio`[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#copy-input-output-cpio)

The `cpio` command allows saving on several successive media without specifying any options.

It is possible to extract all or part of a backup.

There is no option, unlike the `tar` command, to backup and compress at the same time. So it is done in two steps: backup and compression.

To perform a backup with `cpio`, you have to specify a list of files to backup.

This list is provided with the commands `find`, `ls` or `cat`.

- `find` : browse a tree, recursive or not;
- `ls` : list a directory, recursive or not;
- `cat` : reads a file containing the trees or files to be saved.

!!! Note `ls` cannot be used with `-l` (details) or `-R` (recursive).

```
It requires a simple list of names.
```

### Create a backup with `cpio` command[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#create-a-backup-with-cpio-command)

Syntax of the `cpio` command:

```
[files command |] cpio {-o| --create} [-options] [<file-list] [>device]
```

Example:

With a redirection of the output of `cpio`:

```
$ find /etc | cpio -ov > /backups/etc.cpio
```

Using the name of a backup media :

```
$ find /etc | cpio -ovF /backups/etc.cpio
```

The result of the `find` command is sent as input to the `cpio` command via a *pipe* (character `|`, AltGr + 6).

Here, the `find /etc` command returns a list of files corresponding to the contents of the `/etc` directory (recursively) to the `cpio` command, which performs the backup.

Do not forget the `>` sign when saving or the `F save_name_cpio`.

| Options | Description                                    |
| ------- | ---------------------------------------------- |
| `-o`    | Creates a backup (*output*).                   |
| `-v`    | Displays the name of the processed files.      |
| `-F`    | Designates the backup to be modified (medium). |

Backup to a media :

```
$ find /etc | cpio -ov > /dev/rmt0
```

The support can be of several types:

- tape drive: `/dev/rmt0`  ;
- a partition: `/dev/sda5`, `/dev/hda5`, etc.

### Type of backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#type-of-backup)

#### Backup with relative path[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#backup-with-relative-path)

```
$ cd /
$ find etc | cpio -o > /backups/etc.cpio
```

#### Backup with absolute path[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#backup-with-absolute-path)

```
$ find /etc | cpio -o > /backups/etc.A.cpio
```

!!! Warning If the path specified in the `find` command is **absolute** then the backup will be performed in **absolute**.

```
If the path indicated in the `find` command is **relative** then the backup will be done in **relative**.
```

### Add to a backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#add-to-a-backup)

```
[files command |] cpio {-o| --create} -A [-options] [<fic-list] {F|>device}
```

Example:

```
$ find /etc/shadow | cpio -o -AF SystemFiles.A.cpio
```

Adding files is only possible on direct access media.

| Option | Description                                 |
| ------ | ------------------------------------------- |
| `-A`   | Adds one or more files to a backup on disk. |
| `-F`   | Designates the backup to be modified.       |

### Compressing a backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#compressing-a-backup)

- Save **then** compress

```
$ find /etc | cpio  –o > etc.A.cpio
$ gzip /backups/etc.A.cpio
$ ls /backups/etc.A.cpio*
/backups/etc.A.cpio.gz
```

- Save **and** compress

```
$ find /etc | cpio –o | gzip > /backups/etc.A.cpio.gz
```

There is no option, unlike the `tar` command, to save and compress at the same time. So it is done in two steps: saving and compressing.

The syntax of the first method is easier to understand and remember, because it is done in two steps.

For the first method, the backup file is automatically renamed by the `gzip` utility which adds `.gz` to the end of the file name. Similarly the `bzip2` utility automatically adds `.bz2`.

### Read the contents of a backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#read-the-contents-of-a-backup)

Syntax of the `cpio` command to read the contents of a *cpio* backup:

```
cpio -t [-options] [<fic-list]
```

Example:

```
$ cpio -tv </backups/etc.152.cpio | less
```

| Options | Description               |
| ------- | ------------------------- |
| `-t`    | Reads a backup.           |
| `-v`    | Displays file attributes. |

After making a backup, you need to read its contents to be sure that there were no errors.

In the same way, before performing a restore, you must read the contents of the backup that will be used.

### Restore a backup[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#restore-a-backup)

Syntax of the `cpio` command to restore a backup:

```
cpio {-i| --extract} [-E file] [-options] [<device]
```

Example:

```
$ cpio -iv </backups/etc.152.cpio | less
```

| Options                      | Description                                                  |
| ---------------------------- | ------------------------------------------------------------ |
| `-i`                         | Restore a complete backup.                                   |
| `-E file`                    | Restores only the files whose name is contained in file.     |
| `--make-directories` or `-d` | Rebuilds the missing tree structure.                         |
| `-u`                         | Replaces all files even if they exist.                       |
| `--no-absolute-filenames`    | Allows to restore a backup made in absolute mode in a relative way. |

!!! Warning By default, at the time of restoration, files on the disk whose last modification date is more recent or equal to the date of the backup are not restored (in order to avoid overwriting recent  information with older information).

```
The `u` option, on the other hand, allows you to restore older versions of the files.
```

Examples:

- Absolute restoration of an absolute backup

```
$ cpio –ivF home.A.cpio
```

- Absolute restoration on an existing tree structure

The `u` option allows you to overwrite existing files at the location where the restore takes place.

```
$ cpio –iuvF home.A.cpio
```

- Restore an absolute backup in relative mode

The long option `no-absolute-filenames` allows a restoration in relative mode. Indeed the `/` at the beginning of the path will be removed.

```
$ cpio --no-absolute-filenames -divuF home.A.cpio
```

!!! Tip The creation of directories is perhaps necessary, hence the use of the `d` option

- Restore a relative backup

```
$ cpio –iv <etc.cpio
```

- Absolute restoration of a file or directory

The restoration of a particular file or directory requires the creation of a list file that must then be deleted.

```
echo "/etc/passwd" > tmp
cpio –iuE tmp -F etc.A.cpio
rm -f tmp
```

## Compression - decompression utilities[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#compression-decompression-utilities)

Using compression at the time of a backup can have a number of drawbacks:

- Lengthens the backup time as well as the restore time.
- It makes it impossible to add files to the backup.

!!! Note It is therefore better to make a backup and compress it than to compress it during the backup.

### Compressing with `gzip`[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#compressing-with-gzip)

The `gzip` command compresses data.

Syntax of the `gzip` command:

```
gzip [options] [file ...]
```

Example:

```
$ gzip usr.tar
$ ls
usr.tar.gz
```

The file receives the extension `.gz`.

It keeps the same rights and the same last access and modification dates.

### Compressing with `bunzip2`[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#compressing-with-bunzip2)

The `bunzip2` command also compresses data.

Syntax of the `bzip2` command:

```
bzip2 [options] [file ...]
```

Example:

```
$ bzip2 usr.cpio
$ ls
usr.cpio.bz2
```

The file name is given the extension `.bz2`.

Compression by `bzip2` is better than compression by `gzip` but it takes longer to execute.

### Decompressing with `gunzip`[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#decompressing-with-gunzip)

The `gunzip` command decompresses compressed data.

Syntax of the `gunzip` command:

```
gunzip [options] [file ...]
```

Example:

```
$ gunzip usr.tar.gz
$ ls
usr.tar
```

The file name is truncated by `gunzip` and the extension `.gz` is removed.

`gunzip` also decompresses files with the following extensions:

- `.z` ;
- `-z` ;
- `_z` .

### Decompressing with `bunzip2`[¶](https://docs.rockylinux.org/zh/books/admin_guide/09-backups/#decompressing-with-bunzip2)

The `bunzip2` command decompresses compressed data.

Syntax of the `bzip2` command:

```
bzip2 [options] [file ...]
```

Example:

```
$ bunzip2 usr.cpio.bz2
$ ls
usr.cpio
```

The file name is truncated by `bunzip2` and the extension `.bz2` is removed.

`bunzip2` also decompresses the file with the following extensions:

- `-bz` ;
- `.tbz2` ;
- `tbz` .