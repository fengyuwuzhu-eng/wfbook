# 用户管理

[TOC]

## 概述

Linux 是多用户操作系统，可让不同计算机中的多个用户访问在同一机器中安装的单一系统。每个用户都在其自身帐户下运行。

## 类型 	

- 普通用户帐户

  为特定系统用户创建普通帐户。这些帐户可以在正常的系统管理过程中添加、删除和修改。

- 系统用户帐户

  代表系统中的特定应用程序标识符。此类帐户通常仅在软件安装时添加或操作，且不会在以后进行修改。

  > 警告：
  >
  > 系统帐户假定在一个系统中本地可用。如果这些帐户是远程配置和提供的，如 LDAP 配置的实例中，则可能会出现系统中断和服务启动故障。

  对于系统帐户，1000 以下的用户 ID 被保留。对于普通帐户，使用从 1000 开始的 ID。但推荐做法是使用从 5000 开始的 ID。有关分配 ID 的信息，请查看 `/etc/login.defs` 文件。

- 组

  组是出于共同目的将多个用户帐户连接在一起的实体，例如对特定文件授予访问权限。

## 使用命令行工具管理帐户和组

- 显示用户和组群 ID

  ```bash
  id
  
  uid=1000(example.user) gid=1000(example.user) groups=1000(example.user),10(wheel) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
  ```

- 要创建新用户帐户，请执行以下操作

  ```bash
  useradd example.user
  ```

- 为 *example.user* 所属用户帐户分配新密码

  ```bash
  passwd example.user
  ```

- 将用户添加到组中

  ```bash
  usermod -a -G example.group example.user	
  ```

## Web 控制台中管理的系统用户帐户

RHEL web 控制台显示系统中的所有用户帐户。因此，在首次登录 web 控制台后，至少可以看到一个可用的用户帐户。 		

登录到 RHEL web 控制台后，您可以执行以下操作：

- 创建新用户帐户
- 更改其参数
- 锁定帐户
- 终止用户会话

## 使用 Web 控制台添加新帐户

1. 登录到 RHEL web 控制台。

2. 点 Account 。

3. 点 Create New Account 。

4. 在 **Full Name** 字段中输入用户全名。

   RHEL web 控制台会自动在全名中推荐用户名并在 **User Name** 字段中填充该用户名。如果不想使用原始命名规则（由名的第一个字母和完整的姓组成），对它进行更新。

5. 在 **Password/Confirm** 字段中输入密码并重新输入该密码以便验证您的密码是否正确。

   下面的颜色栏显示您输入密码的安全级别，这不允许您创建使用弱密码的用户。

6. 点 Create 保存设置并关闭对话框。

7. 选择新创建的帐户。

8. 在 **Roles** 项中选择 **Server Administrator** 。

   ![](../../Image/c/cockpit-terminate-session-pf4.png)

   现在，可以在 **Accounts** 设置中看到新帐户，可以使用其凭证连接到该系统。 				



Each user is a member of at least one group: **this is their main group**.

Several users can be part of the same group.

Users can belong to other groups. These users are *invited* to these **secondary groups**.

!!! Note Each user has a primary group and can be invited into one or more secondary groups.

Groups and users are managed by their unique numerical identifiers `GID` and `UID`.

Account and group declaration files are located in `/etc`. * `UID`: *User IDentifier*. Unique user ID. * `GID`: *Group IDentifier*. Unique group identifier.

!!! Danger You should always use the administration commands instead of manually editing the files.

## Group management

Modified files, added lines:

- `/etc/group`
- `/etc/gshadow`

### `groupadd` command

The `groupadd` command adds a group to the system.

```
groupadd [-f] [-g GID] group
```



Example:

```
$ sudo groupadd -g 1012 GroupeB
```

| Option   | Description                                                  |
| -------- | ------------------------------------------------------------ |
| `-g GID` | `GID` of the group to create.                                |
| `-f`     | The system chooses a `GID` if the one specified by the `-g` option already exists. |
| `-r`     | Creates a system group with a `GID` between `SYS_GID_MIN` and `SYS_GID_MAX`. These two variables are defined in `/etc/login.defs`. |

Group naming rules:

- No accents or special characters;
- Different from the name of an existing user or system files.

!!! Note Under **Debian**, the administrator should use, except in scripts intended to be portable to all Linux distributions, the `addgroup` and `delgroup` commands as specified in the `man`:

````

```
$ man addgroup
DESCRIPTION
adduser and addgroup add users and groups to the system according to command line options and configuration information
in /etc/adduser.conf. They are friendlier front ends to the low level tools like useradd, groupadd and usermod programs,
by default choosing Debian policy conformant UID and GID values, creating a home directory with skeletal configuration,
running a custom script, and other features.
```

````

### Command `groupmod`

The `groupmod` command allows you to modify an existing group on the system.

```
groupmod [-g GID] [-n nom] group
```

Example:

```
$ sudo groupmod -g 1016 GroupP
$ sudo groupmod -n GroupC GroupB
```

| Option    | Description                       |
| --------- | --------------------------------- |
| `-g GID`  | New `GID` of the group to modify. |
| `-n name` | New name.                         |

It is possible to change the name of a group, its `GID` or both simultaneously.

After modification, the files belonging to the group have an unknown `GID`. They must be reassigned the new `GID`.

```
$ sudo find / -gid 1002 -exec chgrp 1016 {} \;
```

### `groupdel` command

The `groupdel` command is used to delete an existing group on the system.

```
groupdel group
```

Example:

```
$ sudo groupdel GroupC
```

!!! Tip To be deleted, a group must no longer contain users.

Deleting the last user of an eponymous group will cause the system to delete the group.

!!! Tip Each group has a unique `GID`. A group can be duplicated. By convention, the `GID` of system groups range from 0 (`root`) to 999.

!!! Tip Since a user is necessarily part of a group, it is best to  create the groups before adding the users. Therefore, a group may not  have any members.

### `/etc/group` file

This file contains the group information (separated by `:`).

```
$ sudo tail -1 /etc/group
GroupP:x:516:patrick
  (1)  (2)(3)   (4)
```

- 1: Name of the group.
- 2: Password (`x` if defined in `/etc/gshadow`).
- 3: GID.
- 4: Guest members (separated by commas, does not contain core members).

!!! Note Each line in the `/etc/group` file corresponds to a group. Users whose group is their main group are not listed at this  level. This membership information is in fact already provided by the `/etc/passwd` file...

### `/etc/gshadow` file

This file contains the security information about the groups (separated by `:`).

```
$ sudo grep GroupA /etc/gshadow
GroupA:$6$2,9,v...SBn160:alain:rockstar
   (1)      (2)            (3)      (4)
```

- 1: Name of the group.
- 2: Encrypted password.
- 3: Administrator of the group.
- 4: Guest members (separated by commas, does not contain core members).

!!! Warning For each line in the `/etc/group` file there must be a corresponding line in the `/etc/gshadow` file.

A `!` in the password indicates that it is locked. Thus no user can use the password to access the group (since group members do  not need it).

## User management

### Definition

A user is defined as follows in the `/etc/passwd` file:

- 1: Login;
- 2: Password;
- 3: UID;
- 4: GID of the main group;
- 5: Comments;
- 6: Home directory;
- 7: Shell (`/bin/bash`, `/bin/nologin`, ...).

There are three types of users:

- **root**: the system administrator ;
- **system users**: Used by the system to manage application access rights ;
- **regular user**: Other account to log in to the system.

Modified files, added lines:

- `/etc/passwd`
- `/etc/shadow`

### `useradd` command

The `useradd` command is used to add a user.

```
useradd [-u UID] [-g GID] [-d directory] [-s shell] login
```

Example:

```
$ sudo useradd -u 1000 -g 1013 -d /home/GroupC/carine carine
```

| Option         | Description                                                  |
| -------------- | ------------------------------------------------------------ |
| `-u UID`       | `UID` of the user to create.                                 |
| `-g GID`       | `GID` of the main group.                                     |
| `-d directory` | Home directory.                                              |
| `-s shell`     | Shell.                                                       |
| `-c`           | Add a comment.                                               |
| `-U`           | Adds the user to a group with the same name created simultaneously. |
| `-M`           | Does not create the connection directory.                    |

At creation, the account has no password and is locked.

A password must be assigned to unlock the account.

Account naming rules:

- No accents, capital letters or special characters;
- Different from the name of an existing group or system file;
- Set the options `-u`, `-g`, `-d` and `-s` at creation.

!!! Warning The home directory tree must be created except for the last directory.

The last directory is created by the `useradd` command, which takes the opportunity to copy the files from `/etc/skel` into it.

**A user can belong to several groups in addition to their main group.**

For secondary groups, the `-G` option must be used.

Example:

```
$ sudo useradd -u 1000 -g GroupA -G GroupP,GroupC albert
```

!!! Note Under **Debian**, you will have to specify the `-m` option to force the creation of the login directory or set the `CREATE_HOME` variable in the `/etc/login.defs` file. In all cases, the administrator should use the `adduser` and `deluser` commands as specified in the `man`, except in scripts intended to be portable to all Linux distributions:

````

```
$ man useradd
DESCRIPTION
    **useradd** is a low level utility for adding users. On Debian, administrators should usually use **adduser(8)**
     instead.
```

````

#### Default value for user creation.

Modification of the file `/etc/default/useradd`.

```
useradd -D [-b directory] [-g group] [-s shell]
```

Example:

```
$ sudo useradd -D -g 1000 -b /home -s /bin/bash
```

| Option         | Description                                                  |
| -------------- | ------------------------------------------------------------ |
| `-D`           | Sets the default values for user creation.                   |
| `-b directory` | Sets the default login directory.                            |
| `-g group`     | Sets the default group.                                      |
| `-s shell`     | Sets the default shell.                                      |
| `-f`           | The number of days after the password expires before the account is disabled. |
| `-e`           | The date the account will be disabled.                       |

### `usermod` command

The `usermod` command allows to modify a user.

```
usermod [-u UID] [-g GID] [-d directory] [-m] login
```

Example:

```
$ sudo usermod -u 1044 carine
```

Options identical to the `useradd` command.

| Option          | Description                                                  |
| --------------- | ------------------------------------------------------------ |
| `-m`            | Associated with the `-d` option, moves the contents of the old login directory to the new one. |
| `-l login`      | New name.                                                    |
| `-e AAAA-MM-JJ` | Account expiration date.                                     |
| `-L`            | Locks the account.                                           |
| `-U`            | Unlocks the account.                                         |
| `-a`            | Prevents the user from being deleted from a subgroup when added to another subgroup. |
| `-G`            | Specifies multiple subgroups when adding.                    |

With the `usermod` command, locking an account results in the addition of `!` before the password in the `/etc/shadow` file.

!!! Tip To be modified, a user must be disconnected and have no running processes.

After changing the identifier, the files belonging to the user have an unknown `UID`. It must be reassigned the new `UID`.

```
$ sudo find / -uid 1000 -exec chown 1044: {} \;
```

Where `1000` is the old `UID` and `1044` is the new one.

It is possible to invite a user into one or more subgroups with the options *-a* and *-G*.

Example:

```
$ sudo usermod -aG GroupP,GroupC albert
```

The `usermod` command acts as a modification and not as an addition.

For a user invited to a group by this command and already positioned  as a guest in other secondary groups, it will be necessary to indicate  in the group management command all the groups to which he belongs  otherwise he will disappear from them.

The *-a* option changes this behavior.

Examples:

- Invite `albert` in the group `GroupP`.

```
$ sudo usermod -G GroupP albert
```

- Invites `albert` into the `GroupG` group, but removes him from the `GroupP` guest list.

```
$ sudo usermod -G GroupG albert
```

- So either :

```
$ sudo usermod -G GroupP,GroupG albert
```

- Or :

```
$ sudo usermod -aG GroupG albert
```

### `userdel` 命令

The `userdel` command allows you to delete a user's account.

```
$ sudo userdel -r carine
```

| Option | Description                                               |
| ------ | --------------------------------------------------------- |
| `-r`   | Deletes the connection directory and the contained files. |

!!! Tip To be deleted, a user must be logged out and have no running processes.

`userdel` removes the user's line from the `/etc/passwd` and `/etc/gshadow` files.

### `/etc/passwd` 文件

This file contains user information (separated by `:`).

```
$ sudo head -1 /etc/passwd
root:x:0:0:root:/root:/bin/bash
(1)(2)(3)(4)(5)  (6)    (7)
```

- 1: Login.
- 2: Password (`x` if defined in `/etc/shadow`).
- 3: UID.
- 4: GID of the main group.
- 5: Comment.
- 6: Home directory.
- 7: Shell.

### `/etc/shadow` 文件

This file contains the users' security information (separated by `:`).

```
$ sudo tail -1 /etc/shadow
root:$6$...:15399:0:99999:7:::
 (1)    (2)  (3) (4) (5) (6)(7,8,9)
```



- 1: Login.
- 2: Encrypted password.
- 3: Date of last change.
- 4: Minimum lifetime of the password.
- 5: Maximum lifetime of the password.
- 6: Number of days before warning.
- 7: Time to deactivate account after expiration.
- 8: Account expiration time.
- 9: Reserved for future use.

!!! Danger For each line in the `/etc/passwd` file there must be a corresponding line in the `/etc/shadow` file.

## File owners

!!! Danger All files necessarily belong to one user and one group.

The main group of the user creating the file is, by default, the group that owns the file.

### Modification commands

#### `chown` 命令

The `chown` command allows you to change the owners of a file.

```
chown [-R] [-v] login[:group] file
```



Examples:

```
$ sudo chown root myfile
$ sudo chown albert:GroupA myfile
```



| Option | Description                                           |
| ------ | ----------------------------------------------------- |
| `-R`   | Changes the owners of the directory and its contents. |
| `-v`   | Displays the executed changes.                        |

To change only the owner user:

```
$ sudo chown albert file
```

To modify only the owner group:

```
$ sudo chown :GroupA file
```

Changing the user and owner group:

```
$ sudo chown albert:GroupA file
```

In the following example the group assigned will be the main group of the specified user.

```
$ sudo chown albert: file
```

### `chgrp` 命令

The `chgrp` command allows you to change the owner group of a file.

```
chgrp [-R] [-v] group file
```

Example:

```
$ sudo chgrp group1 file
```



| Option | Description                                                  |
| ------ | ------------------------------------------------------------ |
| `-R`   | Modifies the owner groups of the directory and its contents (recursion). |
| `-v`   | Displays the executed changes.                               |

!!! Note It is possible to apply to a file an owner and an owner group by taking as reference those of another file:

```
chown [options] --reference=RRFILE FILE
```

For example:

```
chown --reference=/etc/groups /etc/passwd
```

## Guest management

### `gpasswd` 命令

The command `gpasswd` allows to manage a group.

```
gpasswd [-a login] [-A login] [-d login] [-M login] group
```

Examples:

```
$ sudo gpasswd -A alain GroupA
[alain]$ gpasswd -a patrick GroupA
```

| Option     | Description                          |
| ---------- | ------------------------------------ |
| `-a login` | Adds the user to the group.          |
| `-A login` | Sets the group administrator.        |
| `-d login` | Remove the user from the group.      |
| `-M login` | Defines the complete list of guests. |

The command `gpasswd -M` acts as a modification, not an addition.

```
# gpasswd GroupeA
New Password :
Re-enter new password :
```



### `id` 命令

The `id` command displays the group names of a user.

```
id login
```

Example:

```
$ sudo id alain
uid=1000(alain) gid=1000(GroupA) groupes=1000(GroupA),1016(GroupP)
```



### `newgrp` 命令

The `newgrp` command allows you to temporarily use a secondary group for file creation.

```
newgrp [secondarygroups]
```

Example:

```
[alain]$ newgrp GroupB
```



!!! Note After using this command, the files will be created with the `GID` of its subgroup.

The command `newgrp` without parameters reassigns the main group.

## Securing

### `passwd` 命令

The `passwd` command is used to manage a password.

```
passwd [-d] [-l] [-S] [-u] [login]
```

Examples:

```
$ sudo passwd -l albert
$ sudo passwd -n 60 -x 90 -w 80 -i 10 patrick
```



| Option    | Description                                          |
| --------- | ---------------------------------------------------- |
| `-d`      | Removes the password.                                |
| `-l`      | Locks the account.                                   |
| `-S`      | Displays the account status.                         |
| `-u`      | Unlocks the account.                                 |
| `-e`      | Expires the password.                                |
| `-n days` | Minimum password lifetime.                           |
| `-x days` | Maximum password lifetime.                           |
| `-w days` | Warning time before expiration.                      |
| `-i days` | Delay before deactivation when the password expires. |

With the `passwd` command, locking an account is accomplished by adding `!!` before the password in the `/etc/shadow` file.

Using the command `usermod -U` command only removes one of the `!`. So the account remains locked.

Example:

- Alain changes his password:

```
[alain]$ passwd
```

- root changes Alain's password

```
$ sudo passwd alain
```

!!! Note The `passwd` command is available to users to  change their password (the old password is requested). The administrator can change the passwords of all users without restriction.

They will have to comply with the security restrictions.

When managing user accounts by shell script, it may be useful to set a default password after creating the user.

This can be done by passing the password to the `passwd` command.

Example:

```
$ sudo echo "azerty,1" | passwd --stdin philippe
```

!!! Warning The password is entered in clear text, `passwd` takes care of encrypting it.



### `chage` 命令

The `chage` command is used to manage the account strategy.

```
chage [-d date] [-E date] [-I days] [-l] [-m days] [-M days] [-W days] [login]
```

Example:

```
$ sudo chage -m 60 -M 90 -W 80 -I 10 alain
```



| Option          | Description                                  |
| --------------- | -------------------------------------------- |
| `-I days`       | Delay before deactivation, password expired. |
| `-l`            | Displays the policy details.                 |
| `-m days`       | Minimum lifetime of the password.            |
| `-M days`       | Maximum lifetime of the password.            |
| `-d AAAA-MM-JJ` | Last password change.                        |
| `-E AAAA-MM-JJ` | Account expiration date.                     |
| `-W days`       | Warning time before expiration.              |

The `chage` command also offers an interactive mode.

The `-d` option forces the password to be changed at login.

Examples:

```
$ sudo chage philippe
$ sudo chage -d 0 philippe
```



!!! Note If no user is specified, the order will concern the user who enters it.

![User account management with chage](https://docs.rockylinux.org/books/admin_guide/images/chage-timeline.png)

## Advanced management

配置文件：

* `/etc/default/useradd`
* `/etc/login.defs` 
* `/etc/skel`

!!! Note Editing the `/etc/default/useradd` file is done with the `useradd` command.

```
The other files are to be modified with a text editor.
```

### `/etc/default/useradd` 

文件)ns are not specified, the system uses the default values defined in /etc/default/useradd.

!!! Tip When creating a user, if the options are not specified, the system uses the default values defined in `/etc/default/useradd`.

This file is modified by the command `useradd -D` (`useradd -D` entered without any other option displays the contents of the `/etc/default/useradd` file).

| Value               | Comment                                                      |
| ------------------- | ------------------------------------------------------------ |
| `GROUP`             | Default group.                                               |
| `HOME`              | Path where the login directory for the user's name will be created. |
| `INACTIVE`          | Number of days after the password expires before the account is disabled. |
| `EXPIRE`            | Account expiration date.                                     |
| `SHELL`             | Command interpreter.                                         |
| `SKEL`              | Skeleton directory of the login directory.                   |
| `CREATE_MAIL_SPOOL` | Mailbox creation in `/var/spool/mail`.                       |

!!! Warning Without the `-g` option, the `useradd` command creates a group of the user's name name and places it there.

In order for the `useradd` command to retrieve the value of the `GROUP` field from the `/etc/default/useradd` file, you must specify the `-N` option.

Example:

```
$ sudo useradd -u 501 -N GroupeA
```



### `/etc/login.defs` 文件

用于在创建用户时，对用户的一些基本属性做默认设置，例如指定用户 UID 和 GID 的范围，用户的过期时间，密码的最大长度，等等。

> **注意:**
>
> 该文件的用户默认配置对 root 用户无效。并且，当此文件中的配置与 /etc/passwd 和 /etc/shadow 文件中的用户信息有冲突时，系统会以 /etc/passwd 和 /etc/shadow 为准。

This file contains many default parameters useful for creating or  modifying users. This information is grouped by paragraph according to  their use:

- Mailboxes;
- Passwords ;
- UID and GID ;
- Umask ;
- Connections;
- Terminals.

```bash
#
# Please note that the parameters in this configuration file control the
# behavior of the tools from the shadow-utils component. None of these
# tools uses the PAM mechanism, and the utilities that use PAM (such as the
# passwd command) should therefore be configured elsewhere. Refer to
# /etc/pam.d/system-auth for more information.
#

# *REQUIRED*
#   Directory where mailboxes reside, _or_ name of file, relative to the
#   home directory.  If you _do_ define both, MAIL_DIR takes precedence.
#   QMAIL_DIR is for Qmail
#
#QMAIL_DIR      Maildir
MAIL_DIR        /var/spool/mail
# 创建用户时，系统会在目录 /var/spool/mail 中创建一个用户邮箱。
#MAIL_FILE      .mail

# Default initial "umask" value used by login(1) on non-PAM enabled systems.
# Default "umask" value for pam_umask(8) on PAM enabled systems.
# UMASK is also used by useradd(8) and newusers(8) to set the mode for new
# home directories if HOME_MODE is not set.
# 022 is the default value, but 027, or even 077, could be considered
# for increased privacy. There is no One True Answer here: each sysadmin
# must make up their mind.
UMASK           022

# HOME_MODE is used by useradd(8) and newusers(8) to set the mode for new
# home directories.
# If HOME_MODE is not set, the value of UMASK is used to create the mode.
HOME_MODE       0700

# Password aging controls:
#
#       PASS_MAX_DAYS   Maximum number of days a password may be used.
#                       密码有效期，99999 是自 1970 年 1 月 1 日起，密码有效的天数，相当于 273 年，可理解为密码始终有效。
#       PASS_MIN_DAYS   Minimum number of days allowed between password changes.
#                       表示自上次修改密码以来，最少隔多少天后用户才能再次修改密码，默认值是 0。
#       PASS_MIN_LEN    Minimum acceptable password length.
#                       指定密码的最小长度，默认不小于 5 位，但是现在用户登录时验证已经被 PAM 模块取代，所以这个选项并不生效。
#       PASS_WARN_AGE   Number of days warning given before a password expires.
#                       指定在密码到期前多少天，系统就开始通知用户密码即将到期，默认为 7 天。
#
PASS_MAX_DAYS   99999
PASS_MIN_DAYS   0
PASS_MIN_LEN    5
PASS_WARN_AGE   7

#
# Min/max values for automatic uid selection in useradd
#
UID_MIN                  1000
# 指定最小 UID 为 1000，也就是说，添加用户时，默认 UID 从 1000 开始。
# 注意，如果手工指定了一个用户的 UID 是 1050，那么下一个创建的用户的 UID 就会从 1051 开始，哪怕 1000~1049 之间的 UID 没有使用。
UID_MAX                 60000
# 指定用户最大的 UID 为 60000。
# System accounts
SYS_UID_MIN               201
SYS_UID_MAX               999

#
# Min/max values for automatic gid selection in groupadd
#
GID_MIN                  1000
# 指定最小 GID 为 1000，也就是在添加组时，组的 GID 从 1000 开始。
GID_MAX                 60000
# 用户 GID 最大为 60000。
# System accounts
SYS_GID_MIN               201
SYS_GID_MAX               999

#
# If defined, this command is run when removing a user.
# It should remove any at/cron/print jobs etc. owned by
# the user to be removed (passed as the first argument).
#
#USERDEL_CMD    /usr/sbin/userdel_local

#
# If useradd should create home directories for users by default
# On RH systems, we do. This option is overridden with the -m flag on
# useradd command line.
#
CREATE_HOME     yes
# 指定在创建用户时，是否同时创建用户主目录，yes 表示创建，no 则不创建，默认是 yes。

# This enables userdel to remove user groups if no members exist.
#
USERGROUPS_ENAB yes
# 指定删除用户的时候是否同时删除用户组，准备地说，这里指的是删除用户的初始组，此项的默认值为 yes。

# Use SHA512 to encrypt password.
# 指定用户密码采用的加密规则，默认采用 SHA512，这是新的密码加密模式，原先的 Linux 只能用 DES 或 MD5 加密。
ENCRYPT_METHOD SHA512
```

### `/etc/skel` directory

When a user is created, their home directory and environment files are created.

These files are automatically copied from the `/etc/skel` directory.

- `.bash_logout`
- `.bash_profile`
- `.bashrc`

All files and directories placed in this directory will be copied to the user tree when they are created.

## Identity change

### `su` 命令

The `su` command allows you to change the identity of the connected user.

```
su [-] [-c command] [login]
```

Examples:

```
$ sudo su - alain
[albert]$ su -c "passwd alain"
```

| Option       | Description                                     |
| ------------ | ----------------------------------------------- |
| `-`          | Loads the user's complete environment.          |
| `-c` command | Executes the command under the user's identity. |

If the login is not specified, it will be `root`.

Standard users will have to type the password for the new identity.

!!! Tip There are successive 'layers' created (a stack of `bash` environments). To switch from one user to another, you must first type the `exit` command to take back your identity and then the `su` command to take another identity.

#### Profile loading

`root` endorses the identity of the user `alain` with `su`:

```
...
/home/GroupA/alain/.bashrc
/etc/bashrc
...
```

`root` assumes the identity of the user `alain` with `su -`:

```
...
/home/GroupA/alain/.bash_profile
/home/GroupA/alain/.bashrc
/etc/bashrc
...
```

A user can temporarily (for another command or an entire session) assume the identity of another account.

If no user is specified, the command will be for `root` (`su -`).

It is necessary to know the password of the user whose identity is being endorsed unless it is `root` that is executing the command.

An administrator can thus work on a standard user account and use the rights of the `root` account only occasionally.

# 管理用户和组群帐户简介

​			用户和组群的控制是 Red Hat Enterprise Linux（RHEL）系统管理的核心元素。每个 RHEL 用户都有不同的登录凭证，并可分配给不同的组以自定义其系统权限。 	

## 18.1. 用户和组介绍

​				创建文件的用户是该文件的拥有者*以及*该文件的组所有者。这个文件会单独为拥有者、组和组以外的成员分配读、写和执行权限。文件所有者只能由 `root` 用户更改。`root` 用户和文件拥有者都可以更改对该文件的访问权限。常规用户可以将他们拥有的文件的组群所有权改为他们所属的组。 		

​				每个用户都与一个唯一数字身份号关联，称为 *user ID* (**UID**)。每个组都与一个 *group ID* (**GID**)关联。组群中的用户共享相同的读取、写入和执行该组所拥有的文件的权限。 		

## 18.2. 配置保留的用户和组群 ID

​				RHEL 为系统用户和组保留在 1000 以下的用户和组群 ID。您可以在 `setup` 软件包中找到保留的用户和组群 ID。要查看保留的用户和组群 ID，请使用： 		



```none
cat /usr/share/doc/setup*/uidgid
```

​				建议从 5000 开始将 ID 分配给新用户和组，因为保留范围将来可能会增加。 		

​				要使分配给新用户的 ID 默认从 5000 开始，修改 `/etc/login.defs` 文件中的 `UID_MIN` 和 `GID_MIN` 参数。 		

**流程**

​					要修改并使 ID 默认分配给从 5000 开始的新用户： 			

1. ​						在您选择的编辑器中打开 `/etc/login.defs` 文件。 				

2. ​						找到为自动 UID 选择定义最小值的行。 				

   

   ```none
   # Min/max values for automatic uid selection in useradd
   #
   UID_MIN                  1000
   ```

3. ​						修改 `UID_MIN` 值从 5000 开始。 				

   

   ```none
   # Min/max values for automatic uid selection in useradd
   #
   UID_MIN                  5000
   ```

4. ​						找到自动选择 GID 最小值的行。 				

   

   ```none
   # Min/max values for automatic gid selection in groupadd
   #
   GID_MIN                  1000
   ```

5. ​						修改 `GID_MIN` 值，以从 5000 开始。 				

   

   ```none
   # Min/max values for automatic gid selection in groupadd
   #
   GID_MIN                  5000
   ```

   ​						常规用户动态分配的 UID 和 GID 现在从 5000 开始。 				

   注意

   ​							在更改 UID_MIN 和 GID_MIN 值之前创建的用户和组的 UID 和 GID 不会更改。 					

   ​						这将允许新用户的组拥有与 UID 和 GID 相同的 5000+ ID。 				

   警告

   ​							不要通过更改 `SYS_UID_MAX` 来提高系统 1000 以上保留的 ID，以避免与保留 1000 限制的系统冲突。 					

## 18.3. 用户私人组群

​				RHEL 使用 *用户私人组群*（**UPG**）系统配置，这可让 UNIX 组更容易管理。无论何时在系统中添加新用户，都会创建一个用户私人组群。用户私人组群的名称与为其创建的用户的名称相同，该用户是该用户私人组群中的唯一成员。 		

​				UPG 简化了多个用户之间在项目上的协作。此外，UPG 系统配置可以安全地为新创建的文件或目录设置默认权限，因为它允许该用户和此用户所属的组对文件或目录进行修改。 		

​				所有组群列表都保存在 `/etc/group` 配置文件中。 		

# 第 19 章 在 Web 控制台中管理用户帐户

​			RHEL web 控制台提供了一个图形界面，可让您执行各种管理任务，而无需直接访问终端。例如，您可以添加、编辑或删除系统用户帐户。 	

​			在阅读这个部分后，您将了解： 	

- ​					现有帐户来自哪里。 			
- ​					如何添加新帐户。 			
- ​					如何设置密码过期。 			
- ​					如何和何时终止用户会话。 			

**先决条件**

- ​					设置 RHEL web 控制台。详情请参阅 [开始使用 RHEL web 控制台](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/managing_systems_using_the_rhel_9_web_console/getting-started-with-the-rhel-9-web-console_system-management-using-the-rhel-9-web-console)。 			
- ​					使用分配了管理员权限的帐户登录到 RHEL web 控制台。详情请参阅 [登录到 RHEL web 控制台](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/managing_systems_using_the_rhel_9_web_console/getting-started-with-the-rhel-9-web-console_system-management-using-the-rhel-9-web-console#logging-in-to-the-web-console_getting-started-with-the-rhel-9-web-console)。 			

## 19.1. Web 控制台中管理的系统用户帐户

​				您可在 RHEL web 控制台中显示用户帐户： 		

- ​						在访问系统时验证用户。 				
- ​						设置系统的访问权限。 				

​				RHEL web 控制台显示系统中的所有用户帐户。因此，在首次登录 web 控制台后，至少可以看到一个可用的用户帐户。 		

​				登录到 RHEL web 控制台后，您可以执行以下操作： 		

- ​						创建新用户帐户。 				
- ​						更改其参数。 				
- ​						锁定帐户。 				
- ​						终止用户会话。 				

## 19.2. 使用 Web 控制台添加新帐户

​				使用以下步骤将用户帐户添加到系统，并通过 RHEL web 控制台为帐户设置管理权限。 		

**先决条件**

- ​						必须安装并可以访问 RHEL web 控制台。详情请参阅[安装 Web 控制台](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/9/html/managing_systems_using_the_rhel_9_web_console/getting-started-with-the-rhel-9-web-console_system-management-using-the-rhel-9-web-console#installing-the-web-console_getting-started-with-the-rhel-9-web-console)。 				

**流程**

1. ​						登录到 RHEL web 控制台。 				

2. ​						点 Account。 				

3. ​						点 Create New Account。 				

4. ​						在 **Full Name** 字段中输入用户全名。 				

   ​						RHEL web 控制台会自动在全名中推荐用户名并在 **User Name** 字段中填充该用户名。如果您不想使用原始命名规则（由名的第一个字母和完整的姓组成），对它进行更新。 				

5. ​						在 **Password/Confirm** 字段中输入密码并重新输入该密码以便验证您的密码是否正确。 				

   ​						下面的颜色栏显示您输入密码的安全级别，这不允许您创建使用弱密码的用户。 				

6. ​						点 Create 保存设置并关闭对话框。 				

7. ​						选择新创建的帐户。 				

8. ​						在 **Roles** 项中选择 **Server Administrator**。 				

   ​						[![cockpit terminate session pf4](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Configuring_basic_system_settings-zh-CN/images/61b3085ccf79b2035be698dff0dcffe2/cockpit-terminate-session-pf4.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Configuring_basic_system_settings-zh-CN/images/61b3085ccf79b2035be698dff0dcffe2/cockpit-terminate-session-pf4.png) 					

   ​						现在，您可以在 **Accounts** 设置中看到新帐户，您可以使用其凭证连接到该系统。 				

## 19.3. 在 web 控制台中强制密码过期

​				默认情况下，用户帐户将密码设定为永远不会过期。您可以设置系统密码在指定的天数后过期。当密码过期时，下次登录尝试会提示密码更改。 		

**流程**

1. ​						登录到 RHEL 9 web 控制台。 				
2. ​						点 Account。 				
3. ​						选择要强制密码过期的用户帐户。 				
4. ​						在用户帐户设置中，点第二个 编辑。 				
5. ​						在 **Password Expiration** 对话框中选择 **Require password change every … days** 并输入一个正数，代表密码过期的天数。 				
6. ​						点 Change。 				

**验证步骤**

- ​						要验证是否设定了密码过期时间，打开帐户设置。 				

  ​						RHEL 9 web 控制台显示与过期日期的链接。 				

  ​						[![cockpit password expiration date](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Configuring_basic_system_settings-zh-CN/images/5eafe8a863cb6a6cbd826aa6fffc922c/cockpit-password-expiration-date.png)](https://access.redhat.com/webassets/avalon/d/Red_Hat_Enterprise_Linux-9-Configuring_basic_system_settings-zh-CN/images/5eafe8a863cb6a6cbd826aa6fffc922c/cockpit-password-expiration-date.png) 					

## 19.4. 在 web 控制台中终止用户会话

​				用户在登录系统时创建用户会话。终止用户会话意味着从系统中注销用户。如果您需要执行对配置更改敏感的管理任务，比如升级系统，这非常有用。 		

​				在 RHEL 9web 控制台中的每个用户帐户中，您可以终止该帐户的所有会话，但您当前使用的 web 控制台会话除外。这可防止您丢失对您的系统的访问。 		

**流程**

1. ​						登录到 RHEL 9 web 控制台。 				

2. ​						点 Account。 				

3. ​						点击要终止会话的用户帐户。 				

4. ​						点 Terminate Session。 				

   ​						如果 Terminate Session 按钮不可用，这个用户就不能登录到系统。 				

   ​						RHEL web 控制台会终止会话。 				

# 第 20 章 从命令行管理用户

​			您可以使用命令行界面（**CLI**）来管理用户和组。这可让您在 Red Hat Enterprise Linux 环境中添加、删除和修改用户和组。 	

## 20.1. 使用命令行添加新用户

​				这部分描述了如何使用 `useradd` 工具来添加新用户。 		

**先决条件**

- ​						`根` 访问权限 				

**流程**

- ​						要添加新用户，请使用： 				

  

  ```none
  # useradd options username
  ```

  ​						使用 `useradd` 命令的选项替换 *options*，并使用用户名称替换 *username*。 				

  例 20.1. 添加新用户

  ​							添加用户 ID 为 `5000` 的用户 `sarah`，使用： 					

  

  ```none
  # useradd -u 5000 sarah
  ```

**验证步骤**

- ​						要验证新用户是否已添加，使用 `id` 工具程序。 				

  

  ```none
  # id sarah
  ```

  ​						输出返回： 				

  

  ```none
  uid=5000(sarah) gid=5000(sarah) groups=5000(sarah)
  ```

**其他资源**

- ​						`useradd` 手册页 				

## 20.2. 使用命令行添加新组

​				这部分描述了如何使用 `groupadd` 工具来添加新组。 		

**先决条件**

- ​						`根` 访问权限 				

**流程**

- ​						要添加新组，请使用： 				

  

  ```none
  # groupadd options group-name
  ```

  ​						使用 `groupadd` 命令的命令行选项替换 *options*，并使用 *group-name* 替换 group-name。 				

  例 20.2. 添加新组

  ​							要添加组 ID 为 `5000` 的组 `sysadmins`，请使用： 					

  

  ```none
  # groupadd -g 5000 sysadmins
  ```

**验证步骤**

- ​						要验证新组是否已添加，使用 `tail` 实用程序。 				

  

  ```none
  # tail /etc/group
  ```

  ​						输出返回： 				

  

  ```none
  sysadmins:x:5000:
  ```

**其他资源**

- ​						`groupadd` 手册页 				

## 20.3. 从命令行将用户添加到补充组中

​				您可以将用户添加到补充组中，以管理权限或启用对特定文件或设备的访问权限。 		

**先决条件**

- ​						`root` 访问权限 				

**流程**

- ​						要在用户的附加组中添加一个组，请使用： 				

  

  ```none
  # usermod --append -G group-name username
  ```

  ​						使用组群名称替换 *group- name*，并将 *group-name* 替换为组的名称。 				

  例 20.3. 将用户添加到补充组中

  ​							要将用户 `sysadmin` 添加到 `system-administrators` 组中，请使用： 					

  

  ```none
  # usermod --append -G system-administrators sysadmin
  ```

**验证步骤**

- ​						要验证新的组被添加到用户 `sysadmin` 的附加组中，请使用： 				

  

  ```none
  # groups sysadmin
  ```

  ​						输出显示： 				

  

  ```none
  sysadmin : sysadmin system-administrators
  ```

## 20.4. 创建组目录

​				在 UPG 系统配置下，您可以将 *set-group 身份权限* （**setgid** 位）应用到目录。`setgid` 位使得管理共享目录的组项目变得更加简单。当您将 `setgid` 位应用到某个目录中时，在该目录中创建的文件会自动分配给拥有该目录的组群。在此组中具有写和执行权限的任何用户现在可以在目录中创建、修改和删除文件。 		

​				下面的部分论述了如何创建组目录。 		

**先决条件**

- ​						`根` 访问权限 				

**流程**

1. ​						创建目录： 				

   

   ```none
   # mkdir directory-name
   ```

   ​						使用目录名替换 *directory-name*。 				

2. ​						创建组： 				

   

   ```none
   # groupadd group-name
   ```

   ​						用组群的名称替换 *group-name*。 				

3. ​						向组中添加用户： 				

   

   ```none
   # usermod --append -G group-name username
   ```

   ​						使用组群名称替换 *group- name*，并将 *group-name* 替换为组的名称。 				

4. ​						将目录的用户和组群所有权与 *group-name* 组关联： 				

   

   ```none
   # chgrp group-name directory-name
   ```

   ​						用组群名称替换 *group-name*，并用 目录名替换 *directory-name*。 				

5. ​						设置写入权限，允许用户创建和修改文件和目录，并设置 `setgid` 位使其在 *directory-name* 目录中应用这个权限： 				

   

   ```none
   # chmod g+rwxs directory-name
   ```

   ​						使用目录名替换 *directory-name*。 				

   ​						现在，`*group-name*` 组的所有成员都可以在 `*directory-name*` 目录中创建并编辑文件。新创建的文件保留 `*group-name* `组的组群所有权。 				

**验证步骤**

- ​						要验证设置权限的正确性，请使用： 				

  

  ```none
  # ls -ld directory-name
  ```

  ​						使用目录名替换 *directory-name*。 				

  ​						输出会返回： 				

  

  ```none
  drwxrwsr-x. 2 root group-name 6 Nov 25 08:45 directory-name
  ```

# 第 21 章 使用命令行编辑用户组

​			用户属于某个组集合，允许用户的逻辑组集合对文件和文件夹具有类似的访问权限。您可以从命令行编辑主和补充用户组，以更改用户的权限。 	

## 21.1. 主和补充用户组

​				组是出于共同目的将多个用户帐户连接在一起的实体，例如对特定文件授予访问权限。 		

​				在 Linux 上，用户组可以充当主或补充组。主和补充组具有以下属性： 		

- 主组

  ​									每个用户始终只有一个主组。 							 								您可以更改用户的主组。 							

- 补充组

  ​									您可以将现有用户添加到现有的补充组中，以使用相同的安全和访问权限管理组中的用户。 							 								用户可以是零个或多个补充组的成员。 							

## 21.2. 列出用户的主和补充组

​				您可以列出用户的组，以查看他们所属的主和补充组。 		

**流程**

- ​						显示用户的主组以及任何补充组的名称： 				

  

  ```none
  $ groups user-name
  ```

  ​						使用用户名称替换 *user-name*。如果不提供用户名，则命令将显示当前用户的组成员身份。第一个组是主组，后跟可选的补充组。 				

  例 21.1. 列出用户 sarah 的组：

  

  ```none
  $ groups sarah
  ```

  ​							输出显示： 					

  

  ```none
  sarah : sarah wheel developer
  ```

  ​							用户 `arah` 有一个主组 `sarah`，它是补充组 `wheel` 和 `developer` 的成员。 					

  例 21.2. 列出用户 marc 的组：

  

  ```none
  $ groups marc
  ```

  ​							输出显示： 					

  

  ```none
  marc : marc
  ```

  ​							用户 `marc` 仅有一个主组 `marc`，没有补充组。 					

## 21.3. 更改用户的主组

​				您可以将现有用户的主组更改为一个新组。 		

**先决条件：**

1. ​						`root` 访问权限 				
2. ​						新组必须存在 				

**流程**

- ​						更改用户的主组： 				

  

  ```none
  # usermod -g group-name user-name
  ```

  ​						使用新主组的名称替换 *group-name*，并使用用户名替换 *user-name*。 				

  注意

  ​							更改用户的主组时，命令还会将用户主目录中所有文件的组所有权自动更改为新的主组。您必须手动修复用户主目录外文件的组所有权。 					

  例 21.3. 更改用户的主组的示例：

  ​							如果用户 `arah` 属于主组 `sarah1`，且您想将用户的主组更改为 `sarah2`，请使用： 					

  

  ```none
  # usermod -g sarah2 sarah
  ```

**验证步骤**

- ​						验证您是否更改了用户的主组： 				

  

  ```none
  $ groups sarah
  ```

  ​						输出显示： 				

  

  ```none
  sarah : sarah2
  ```

## 21.4. 从命令行将用户添加到补充组中

​				您可以将用户添加到补充组中，以管理权限或启用对特定文件或设备的访问权限。 		

**先决条件**

- ​						`root` 访问权限 				

**流程**

- ​						要在用户的附加组中添加一个组，请使用： 				

  

  ```none
  # usermod --append -G group-name username
  ```

  ​						使用组群名称替换 *group- name*，并将 *group-name* 替换为组的名称。 				

  例 21.4. 将用户添加到补充组中

  ​							要将用户 `sysadmin` 添加到 `system-administrators` 组中，请使用： 					

  

  ```none
  # usermod --append -G system-administrators sysadmin
  ```

**验证步骤**

- ​						要验证新的组被添加到用户 `sysadmin` 的附加组中，请使用： 				

  

  ```none
  # groups sysadmin
  ```

  ​						输出显示： 				

  

  ```none
  sysadmin : sysadmin system-administrators
  ```

## 21.5. 从补充组中删除用户

​				您可以从补充组中删除现有的用户，以限制他们对文件和设备的权限或访问。 		

**先决条件**

- ​						`root` 访问权限 				

**流程**

- ​						从补充组中删除用户： 				

  

  ```none
  # gpasswd -d user-name group-name
  ```

  ​						使用用户名替换 *user-name*，并使用补充组的名称替换 *group-name*。 				

  例 21.5. 从补充组中删除用户

  ​							如果用户 sarah 有一个主组 `sarah2`，并且属于次要组 `wheel` 和 `developers`，并且您想从组 `developers` 中删除该用户，请使用： 					

  

  ```none
  # gpasswd -d sarah developers
  ```

**验证步骤**

- ​						验证您是否从次要组 developers 中删除了用户 sarah： 				

  

  ```none
  $ groups sarah
  ```

  ​						输出显示： 				

  

  ```none
  sarah : sarah2 wheel
  ```

## 21.6. 更改用户的所有补充组

​				您可以覆盖您希望用户保留其成员的补充组的列表。 		

**先决条件**

- ​						`root` 访问权限 				
- ​						补充组必须存在 				

**流程**

- ​						覆盖用户的补充组的列表： 				

  

  ```none
  # usermod -G group-names username
  ```

  ​						使用一个或多个补充组的名称替换 *group-names*。要将用户一次添加到多个补充组中，请使用逗号分隔组名称，并且没有插入空格。例如：`wheel,developer`。 				

  ​						使用用户名称替换 *user-name*。 				

  重要

  ​							如果用户是当前您未指定的组的成员，则该命令会从组中删除该用户。 					

  例 21.6. 更改用户的补充组的列表

  ​							如果用户 `sarah` 有一个主组 `sarah2`，并且属于补充组 `wheel`，您希望用户属于多个补充组 `developer`、`sysadmin` 和 `security`，请使用： 					

  

  ```none
  # usermod -G wheel,developer,sysadmin,security sarah
  ```

**验证步骤**

- ​						验证您是否正确设置了补充组列表： 				

  

  ```none
  # groups sarah
  ```

  ​						输出显示： 				

  

  ```none
  sarah : sarah2 wheel developer sysadmin security
  ```