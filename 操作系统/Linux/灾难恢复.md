# 灾难恢复

## 硬盘分区表破坏

通过备份硬盘的 MBR 来备份硬盘分区表

```
[root@FCoE ~]# dd if=/dev/sda of=/mnt/sda.mbr bs=512 count=1
1+0 records in
1+0 records out
512 bytes (512 B) copied, 0.000777948 s, 658 kB/s
```

写零硬盘分区表来实现类似分区表被破坏的结果

```
[root@FCoE ~]# dd if=/dev/zero of=/dev/sda bs=1 count=64 skip=446 seek=446
64+0 records in
64+0 records out
64 bytes (64 B) copied, 0.00160668 s, 39.8 kB/s
```

Linux当主机硬盘分区表丢失了之后，再次启动后 GRUB 会因找不到配置文件而进入命令行模式

启动援救模式

通过原来备份的 sda.mbr 文件来恢复硬盘设备 sda 的硬盘分区表

```
bash-4.1# dd if=/usb/sda.mbr of=/dev/sda bs=1 count=64 skip=446 seek=446
64+0 records in
64+0 records out
64 bytes (64 B) copied, 0.038358 s, 4.6 kB/s
```



## 系统 GRUB 损坏

写零 Bootloader 来实现 GRUB 被破坏的结果

```
[root@FCoE grub]# dd if=/dev/zero of=/dev/sda bs=446 count=1
1+0 records in
1+0 records out
446 bytes (446 B) copied, 0.0017583 s, 254 kB/s
```

重启后系统会因找不到 GRUB 而卡在“Booting from Hard Disk …”

挂载系统安装光盘然后选择进入 Rescue 模式，然后恢复 GRUB

```
bash-4.1# chroot /mnt/sysimage
sh-4.1# grub
grub > root hd(0,0)
grub > setup (hd0)
grub > quit
```

## 系统内核文件丢失

启动后会提示找不到文件

![](../../Image/k/kernel_missing.jpeg)

进入援救模式

从挂载的系统安装盘强制重新安装内核

```
sh-4.1# mount – o loop /dev/sr0 /media
sh-4.1# cd /media/Server/Packages
sh-4.1# rpm -ivh --force kernel-2.6.32-71.el6.x86_64.rpm
warning: kernel-2.6.32-71.el6.x86_64.rpm: Header V3 RSA/SHA256 Signature, \key ID fd431d51: NOKEY
Preparing...                ########################################### [100%]     1:kernel                  ########################################### [100%]
```

## 系统镜像文件丢失initramfs

主机启动后黑屏

进入援救模式

重新生成镜像文件

```
sh-4.1# cd /boot 
sh-4.1# mkinit
sh-4.1# ls
config-2.6.32-71.el6.x86_64           lost+found
efi                                        symvers-2.6.32-71.el6.x86_64.gz
grub                                       System.map-2.6.32-71.el6.x86_64
initramfs-2.6.32-71.el6.x86_64.img   vmlinuz-2.6.32-71.el6.x86_64
```

## 系统 /boot 分区损坏

/boot 分区损坏，会先尝试修复文件系统。如果文件系统损坏不能修复，那么可以参照前述的方法来依次新建 /boot分区，重新安装内核和镜像，然后安装 GURB 再手工编辑引导菜单，以最终来恢复系统可正常引导。

### 创建分区

进入援救模式

新建一个分区并且设置它为启动分区

重启主机以更新分区表，然后进入援救模式，并在新创建的分区上创建文件系统

### 安装内核镜像文件

### 安装 GRUB

```
sh-4.1# grub-install /dev/sda
Installation finished. No error reported.
This is the contents of the device map /boot/grub/device.map.
Check if this is correct or not. If any of the lines is incorrect,
fix it and re-run the script grub-install'.
(fd0)   /dev/fd0
(hd0)   /dev/sda
(hd1)   /dev/sdb
```

### 编辑引导菜单

由于创建了新的分区，其对应的 UUID 会发生变化，可以通过命令 blkid 来查询分区的 UUID

```
bash-4.1# blkid
/dev/loop0: TYPE="squashfs"
/dev/sda2: UUID="7b1e0fac-ff06-492c-848d-497e2a38c54e" TYPE="swap"
/dev/sda3: UUID="ef89764e-04ff-4f26-ae82-dcab267ecc66" TYPE="ext4"
/dev/sdb1: UUID="2b824352-df2a-44c6-a547-838d46f526fa" SEC_TYPE="ext2" TYPE="ext3"
/dev/loop1: LABEL="RHEL_6.0 x86_64 Disc 1" TYPE="iso9660"
/dev/sda1: UUID="cec964af-1618-48ff-ac33-4ef71b9d3265" TYPE="ext4"
```

编辑 /boot/grub/grub.conf 文件更新其对应的 UUID

```
title Red Hat Enterprise Linux 6
root (hd0,0)
kernel /vmlinuz-2.6.32-71.el6.x86_64 \ 
root=UUID=ef89764e-04ff-4f26-ae82-dcab267ecc66 rhgb quiet
initrd /initramfs-2.6.32-71.el6.x86_64.img
```

### 更新 /etc/fstab

```
#
# /etc/fstab
# Created by anaconda on Sun Mar 18 04:35:07 2012
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
UUID=ef89764e-04ff-4f26-ae82-dcab267ecc66 /                  ext4    defaults        1 1
UUID=cec964af-1618-48ff-ac33-4ef71b9d3265 /boot              ext4    defaults        1 2
UUID=7b1e0fac-ff06-492c-848d-497e2a38c54e swap               swap    defaults        0 0
tmpfs                   /dev/shm                tmpfs   defaults        0 0
devpts                  /dev/pts                devpts  gid=5,mode=620  0 0
sysfs                   /sys                     sysfs   defaults        0 0
proc                    /proc                    proc    defaults        0 0
```