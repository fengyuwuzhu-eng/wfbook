# VDO

RHEL 包含虚拟数据优化器（VDO）驱动程序，可以优化块设备上数据的空间占用。VDO是一个Linux设备映射器驱动程序，可以减少块设备上的磁盘空间使用，同时最大限度减少数据重复，从而节省磁盘空间，甚至提高数据吞吐量。

包括两个内核模块：

* kvdo，用于以透明的方式控制数据压缩。
* uds，用于重复数据删除。

VDO层位于现有块存储设备（如RAID设备或本地磁盘）的顶部。这些块设备也可以是加密设备。存储层（如LVM逻辑卷和文件系统）位于VDO设备之上。

VDO会按以下顺序对数据实施三个阶段的处理，以减少存储设备上的空间占用：

1. 零块消除将过滤掉仅包含零（0）的数据块，且仅在元数据中记录这些块的信息。非零数据块随即被传递到下一个处理阶段。该阶段将启用VDO设备中的精简配置功能。
2. 重复数据删除将去除冗余的数据块。在创建相同数据的多个副本时，VDO会检测重复数据块并更新元数据，以便使用这些重复块来引用原始数据块，而不会创建冗余数据块。通用重复数据删除服务(UDS)内核模块将通过其维护的元数据来检查数据的冗余。该内核模块是作为VDO的一部分而提供的。
3. 最后一个阶段是压缩。kvdo内核模块使用LZ4压缩对块进行压缩，并以4KB块进行分组。

## 实施虚拟数据优化器

VDO卷的逻辑大小可以大于实际块设备的物理大小。由于采用了精简配置，只能看到正在使用的逻辑空间，无法了解实际可用的物理空间。在创建卷时，如未指定逻辑大小，则会将实际物理大小视为卷的逻辑大小。这种采用1:1的比率映射逻辑大小与物理大小的方式有利于提高性能，但也会降低存储空间的使用效率。应根据基础架构要求来确定是优先考虑性能还是空间效率。

当VDO卷的逻辑大小超过实际物理大小时，应使用 `vdostats --verbose` 命令主动监控卷统计信息，以查看实际使用情况。

### 启用VDO

```bash
yum install vdo kmod-kvdo
```

### 创建VDO卷

```bash
vdo create --name=vdo1 --device=/dev/vdd --vdoLogicalSize=50G
# 如不指定逻辑大小，则生成的VDO卷将与物理设备的大小相同。
```

### 分析VDO卷

```bash
vdo status [--name=vdo1]

vdo list
# 显示当前启动的VDO卷的列表。

vdo start 和 vdo stop 启动和停止VDO卷。
```

### 挂载

```bash
/etc/fstab
UUID=9328...d7ce /vdo01	xfs defaults,x-systemd.requires=vdo.service 0 0
```

