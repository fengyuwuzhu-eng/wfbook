# 文件系统

[TOC]

## 本地文件系统

本地文件系统是在单一本地服务器中运行并直接附加到存储中的文件系统。

例如，本地文件系统是内部 SATA 或 SAS 磁盘的唯一选择，可在当服务器具有带有本地驱动器的内部硬件 RAID 控制器时使用。当 SAN 上导出的设备未共享时，本地文件系统也是 SAN 连接的存储上最常用的文件系统。

所有本地文件系统都与 POSIX 兼容。与 POSIX 兼容的文件系统为一组定义良好的系统调用提供支持，如 `read()`、`write()` 和 `seek()`。

从应用程序员的角度来看，本地文件系统之间的差别相对较少。从用户的角度来看，最显著的差异与可扩展性和性能相关。在考虑文件系统的选择时，考虑文件系统需要多大、应具有哪些独特功能，以及它在工作负载下性能如何。

### 列表

* AFP (Apple文件归档协议,Apple Filing Protocol)

* amufs5

* amufs4

* amufs3

* amufs2

* amufs1

* amufs0

* amufs

* apfs1

* apfs2

* affs7

* affs4

* affs3

* affs2

* affs1

* affs0

* asfs

* btrfs

* EXT (扩展文件系统,Extended Filesystem)

  * ext2

  * ext3

  * ext4

    在 Linux 中具有长寿的优势。因此，几乎所有 Linux 应用程序都支持它。在大多数情况下，它与 XFS 在性能上竞争。ext4 通常用于主目录。

* FAT (文件分配表,File Allocation Table)

  * FAT16
  * FAT32

* hfs   HFS+(分级文件系统,Hierarchical File System)

* hfsx

* hfs+

* hp-ufs

* ISO9660

* JFS

* linux-swap(v1)

* linux-swap(v0)

* linux-swap

* linux-swap(new)

* linux-swap(old)

* LOOPBACKFS (回送文件系统,Loopback File System)

* nilfs2

* NTFS (新技术文件系统,New TechnologyFile System)

* PROCFS (进程文件系统,ProcessFile System)

* ReiserFS

* sun-ufs

* swsusp

* TMPFS (临时文件系统)

* UDF (通用磁盘格式)

* UFS (Unix文件系统,UnixFile System)

* XFS

### XFS

XFS 是一个高度可扩展、高性能、健壮且成熟的 64 位日志文件系统，其支持单个主机上非常大的文件和文件系统。是 RHEL 9 中的默认文件系统。

XFS 最初于 1990 年代由 SGI  早期开发，并在非常大型的服务器和存储阵列中运行有很长的历史记录。 

由于它将文件布局为扩展数据块，所以不像 ext4 那样易受碎片的影响。红帽建议将 XFS 部署为本地文件系统。	

**功能包括：**

- 可靠性
  * 元数据日志，其确保系统崩溃后文件系统的完整性，方法是保留系统重启和重新挂载文件系统时可以重新执行的文件系统操作的记录
  * 广泛的运行时元数据一致性检查
  * 可扩展且快速修复工具
  * 配额日志。这可避免在崩溃后进行冗长的配额一致性检查。
- 可伸缩性和性能
  * 支持最多 1024 TiB 的文件系统大小
  * 支持大量并发操作的能力
  * B-tree 索引，用于空闲空间的可扩展性管理
  * 复杂的元数据读头算法
  * 优化流视频工作负载 							
- 分配方案
  * 基于扩展数据块的分配
  * 条带化分配策略
  * 延迟分配
  * 空间预分配
  * 动态分配的 inode 							
- 其他功能
  * 基于 Reflink 的文件副本
  * 严格集成备份和恢复工具
  * 在线清理
  * 在线文件系统增大
  * 全面的诊断功能
  * 扩展属性(`xattr`)。这允许系统能够按文件关联多个额外的名称/值对。
  * 项目或目录配额。这允许对目录树的配额限制。
  * 小于秒的时间戳 							

**性能特性**

XFS 在具有企业工作负载的大型系统上具有高性能。大型系统是一个有相对较多的 CPU 、多个 HBA 和连接外部磁盘阵列的系统。XFS 在具有多线程、并行 I/O 工作负载的较小系统上也表现良好。

对于单线程、元数据密集型工作负载，XFS 的性能相对较低：例如，在单个线程中创建或删除大量小文件的工作负载。

### ext4

ext4 通常用于主目录。 						

ext4 是 ext 文件系统系列的第四代。	

ext4 驱动程序可以对 ext2 和 ext3 文件系统进行读写，但 ext4 文件系统格式与 ext2 和 ext3 驱动程序不兼容。 		

ext4 添加了几个新的改进的功能，例如： 		

- 支持的文件系统大小高达 50 TiB 				
- 基于扩展的元数据 				
- 延迟分配 				
- 日志的 checksum 				
- 大型存储支持 				

基于扩展数据块的元数据和延迟分配功能提供了一种更加紧凑和高效的方法来跟踪文件系统中的已用空间。这些功能提高了文件系统性能，并减少了元数据所占用的空间。延迟分配允许文件系统延迟选择新写入用户数据的永久位置，直到数据刷新到磁盘。这可实现更高的性能，因为它允许更大的、连续的分配，允许文件系统根据更佳的信息做出决策。 		

ext4 中使用 `fsck` 工具的文件系统修复时间比 在 ext2 和 ext3 中要快得多。一些文件系统修复的性能会增加最多 6 倍。 		

### XFS 和 ext4 的比较 		

- 元数据错误行为

  在 ext4 中，当文件系统遇到元数据错误时您可以配置行为。默认的行为是继续操作。当 XFS 遇到不可恢复的元数据错误时，它会关闭文件系统，并返回 `EFSCORRUPTED` 错误。

- 配额

  在 ext4 中，您可以在创建文件系统时启用配额，或稍后在现有文件系统上启用配额。然后您可以使用挂载选项配置配额强制。

  XFS 配额不是一个可重新挂载的选项。您必须在初始挂载中激活配额。

  在 XFS 文件系统上运行 `quotacheck` 命令没有效果。当您第一次打开配额记帐时，XFS 会自动检查配额。

- 文件系统重新定义大小

  XFS 没有工具来缩小文件系统的大小。您只能增大 XFS 文件系统的大小。而 ext4 支持扩展和缩小文件系统大小。

- 内节点（inode）号

  ext4 文件系统不支持超过 2 <sup>32</sup> 内节点。

  XFS 动态分配内节点。只要文件系统上存在空闲空间，XFS 文件系统就无法耗尽 inode 。

  某些应用程序无法正确处理 XFS 文件系统上大于2 <sup>32</sup> 的 inode 数。这些应用程序可能会导致 32 位 stat 调用失败，返回值为 `EOVERFLOW` 。在以下情况下，inode 数超过 2 <sup>32</sup>: 

  * 文件系统大于 1 TiB，其 inode 为 256 字节。
  * 文件系统大于 2 TiB，其 inode 为 512 字节。

  如果您的应用程序由于 inode 数太大而失败，请使用 `-o inode32` 选项挂载 XFS 文件系统，来强制inode 数低于 2 <sup>32</sup>。请注意，使用 `inode32` 不会影响已分配了 64 位数的 inode。
  
  > 重要:
  >
  > 除非特定环境需要，否则 *请勿* 使用 `inode32` 选项。`inode32` 选项可改变分配行为。因此，如果没有可用空间在较低磁盘块中分配 inode ，则可能会出现 `ENOSPC` 错误。 						

### 本地文件系统选择

需要了解要在其上部署文件系统的目标系统。

* 有一个大的服务器吗？
* 有大的存储要求或一个本地的慢速的 SATA 驱动器吗？
* 所期望的应用程序存在哪一种 I/O 工作负载？
* 对吞吐量和延迟的要求是什么？
* 服务器和存储硬件稳定性如何？
* 文件和数据组的典型大小是什么？
* 如果系统失败，可以承受多少停机时间？ 				

如果您的服务器和存储设备都很大，那么 XFS 是最佳选择。即使存储阵列较小，当平均文件大小较大（例如，几百兆字节）时，XFS 也表现良好。 		

如果现有工作负载在 ext4 上表现良好，则继续使用 ext4 会为您和您的应用程序提供一个非常熟悉的环境。 		

ext4 文件系统在 I/O 能力有限的系统上往往表现更好。它在有限带宽（小于 200MB/s）上性能更好，最高可达到 1000 IOPS 的能力。对于较高能力的任何事情，XFS 往往会更快。

与 ext4 相比，XFS 消耗大约两倍的每个元数据所使用的 CPU ，因此如果有一个很少并发的 CPU 绑定工作负载，则 ext4  将更快。通常，如果应用程序使用单个读/写线程和小文件，则 ext4 更佳；而当应用程序使用多个读/写线程和较大的文件时，XFS 会更出色。 		

无法缩小 XFS 文件系统。如果需要缩小文件系统，考虑使用 ext4 ，其支持离线缩小。 	

通常，红帽建议使用 XFS，除非有 ext4 的特定用例。还应衡量目标服务器和存储系统上特定应用的性能，以确保选择了合适的文件系统类型。

| 场景                             | 推荐的文件系统 |
| -------------------------------- | -------------- |
| 没有特殊用例                     | XFS            |
| 大服务器                         | XFS            |
| 大存储设备                       | XFS            |
| 大文件                           | XFS            |
| 多线程 I/O                       | XFS            |
| 单线程 I/O                       | ext4           |
| 有限 I/O 功能（在 1000 IOPS 下） | ext4           |
| 有限带宽（在 200MB/s 下）        | ext4           |
| CPU 绑定工作负载                 | ext4           |
| 支持离线缩小                     | ext4           |

### 创建文件系统

```bash
mkfs.xfs /dev/vdb1
```

### 扫描连接到计算机的块设备并检索文件系统UUID

```bash
lsblk --fs
```
## 分布式文件系统

* ceph

  支持FUSE，客户端已经进入了linux-2.6.34内核，也就是说可以像ext3/rasierFS一样，选择ceph为文件系统。彻底的分布式，没有单点依赖，用C编写，性能较好。

* fastDFS

  国人在mogileFS的基础上进行改进的key-value型文件系统，不支持FUSE，提供比mogileFS更好的性能。

* GFS

  Google

* GFS2

  GFS2 为计算集群成员提供共享写入访问。其重点在于稳定性和可靠性，获得与本地文件系统类似的体验。

* lustre

  Oracle公司的企业级产品，非常庞大，对内核和ext3深度依赖。

* mogileFS

  Key-Value型元文件系统，不支持FUSE，应用程序访问它时需要API，主要用在web领域处理海量小图片，效率相比mooseFS高很多。

* mooseFS

## 网络文件系统

网络文件系统也称为客户端/服务器文件系统，使客户端系统能够访问存储在共享服务器上的文件。这使得多个系统上的多个用户可以共享文件和存储资源。 		

此类文件系统构建自一个或多个服务器，它们将一组文件系统导出到一个或多个客户端。客户端节点无法访问底层的块存储，而是使用允许更好的访问控制的协议来与存储进行交互。

* NFS (网络文件系统,Network File System)

  老牌网络文件系统。

* Samba (SMB/CIFS)

  使用 SMB 进行与微软 Windows 系统的文件共享。

* WebDAV
## /etc/fstab

```bash
UUID=a89929229-44dd-409a-68be2c9f5571	/		xfs		defaults	0 0
# 指定设备，使用UUID或者设备文件，如/dev/vdb1。
# 目录挂载点。
# 文件系统类型。
# 以逗号分隔的、应用于设备的选项列表。
# dump命令使用第5个字段来备份设备。其他备份应用通常不使用此字段。
# fsck顺序字段，决定了在系统启动时是否执行fsck命令，以验证文件系统是否干净。值指示了fsck的运行顺序。
# 对于XFS,不使用fsck来检查自己的文件系统状态，为0。
# 对于ext4,根文件系统，为1;如果是其他ext文件系统，为2。
```

在 `/etc/fstab` 文件中添加或删除条目时，运行如下命令，以便让systemd注册新配置。

```bash
systemctl daemon-reload
```

### 验证

1. 卸载新文件系统。

2. 挂载文件系统

   ```bash
   mount /mountpoint
   ```

替代方法

```bash
findmnt --verify
```