# 磁带

磁带设备应只用于定期的文件归档或将数据从一台服务器传送至另一台。通常磁带设备与 Unix 机器连接，用 mt 或 mtx 控制。

## 术语

* 存储容量：指整个磁介质表面能记录的二进制数码的总量，与记录介质的长度和记录密度直接相关。
* 记录密度：每英寸磁带所记录的二进制代码的位数。与磁带机轨数有关。每毫米32位，63位和246位。
* 存取时间：磁头从起始位置移动到指定位置，并开始读写数据所需的时间。用平均值来衡量。与走带速度和带长有关。
* 数据传输速率：单位时间内所能读写的二进制代码数量。与位密度和记录介质的运动速度成正比。
* 记录格式：对磁带记录内容和记录位置所做的规定。目前采用的记录格式由美国地球物理勘探协会（SEG）制定的标准，SEG-A,SEG-B,SEG-C,SEG-D,SEG-Y,SEG-2等

## 磁带技术

DAT  
DDS  
DLT  
Super DLT  
LTO  
VXA  

## 磁带机分类

### 带速
高速机，中速机，低速机

### 磁带的缓冲方式
真空缓冲箱式，摆杆式

### 读写磁带的方式
数据流磁带机，螺旋扫描磁带机

## 磁带文件标记和块大小

![](../Image/a/p.jpg)

每个磁带设备能存储多个备份文件。磁带备份文件通过 cpio，tar，dd 等命令创建。同时，磁带设备可以由多种程序打开、写入数据、及关闭。你可以存储若干备份（磁带文件）到一个物理磁带上。在每个磁带文件之间有个“磁带文件标记”。这用来指示一个物理磁带上磁带文件的结尾以及另一个文件的开始。你需要使用 mt 命令来定位磁带（快进，倒带和标记）。磁头在空白间隔内启停。

## 磁带上的数据存储

![](../Image/a/q.jpg)

所有的数据使用 tar 以连续磁带存储格式连续地存储。第一个磁带归档会从磁带的物理开始端开始存储（tar #0）。接下来的就是 tar #1，以此类推。常用的标准格式有不归零（NRZI）、相位编码（PE）和成组编码（GCR）三种。

## Unix 上的磁带设备名

    /dev/rmt/0 或 /dev/rmt/1 或 /dev/rmt/[0-127] ：Unix 上的常规磁带设备名。磁带自动倒回。
    /dev/rmt/0n ：以无倒回为特征，换言之，磁带使用之后，停留在当前状态等待下个命令。
    /dev/rmt/0b ：使用磁带接口，也就是 BSD 的行为。各种类型的操作系统比如 AIX，Windows，Linux，FreeBSD 等的行为更有可读性。
    /dev/rmt/0l ：设置密度为低。
    /dev/rmt/0m ：设置密度为中。
    /dev/rmt/0u ：设置密度为高。
    /dev/rmt/0c ：设置密度为压缩。
    /dev/st[0-9] ：Linux 特定 SCSI 磁带设备名。
    /dev/sa[0-9] ：FreeBSD 特定 SCSI 磁带设备名。
    /dev/esa0 ：FreeBSD 特定 SCSI 磁带设备名，在关闭时弹出（如果可以的话）。

磁带设备名示例

    /dev/rmt/1cn 指明正在使用 unity 1，压缩密度，无倒回。
    /dev/rmt/0hb 指明正在使用 unity 0，高密度，BSD 行为。
    Linux 上的自动倒回 SCSI 磁带设备名：/dev/st0
    Linux 上的无倒回 SCSI 磁带设备名：/dev/nst0
    FreeBSD 上的自动倒回 SCSI 磁带设备名：/dev/sa0
    FreeBSD 上的无倒回 SCSI 磁带设备名：/dev/nsa0

## 列出已经安装的　scsi 磁带设备

    ### Linux ###
    lsscsi
    lsscsi -g

    ### IBM AIX ###
    lsdev -Cc tape
    lsdev -Cc adsm
    lscfg -vl rmt*

    ### Solaris Unix ###
    cfgadm –a
    cfgadm -al
    luxadm probe
    iostat -En

    ### HP-UX Unix ###
    ioscan Cf
    ioscan -funC tape
    ioscan -fnC tape
    ioscan -kfC tape

## mt 命令示例

在 Linux 和类 Unix 系统上，mt 命令用来控制磁带驱动器的操作，比如查看状态或查找磁带上的文件或写入磁带控制标记。下列大多数命令需要作为 root 用户执行。语法如下：

mt -f /tape/device/name operation

设置环境

你可以设置 TAPE shell 变量。这是磁带驱动器的路径名。在 FreeBSD 上默认的（如果变量没有设置，而不是 null）是 /dev/nsa0。可以通过 mt 命令的 -f 参数传递变量覆盖它，就像下面解释的那样。

 ### 添加到你的 shell 配置文件 ###
 TAPE=/dev/st1 #Linux
 TAPE=/dev/rmt/2 #Unix
 TAPE=/dev/nsa3 #FreeBSD
 export TAPE

1：显示磁带/驱动器状态

mt status  ### Use default
mt -f /dev/rmt/0  status ### Unix
mt -f /dev/st0 status ### Linux
mt -f /dev/nsa0 status ### FreeBSD
mt -f /dev/rmt/1 status ### Unix unity 1 也就是 tape device no. 1

你可以像下面一样使用 shell 循环语句遍历一个系统并定位其所有的磁带驱动器：

for d in 0 1 2 3 4 5
do
 mt -f "/dev/rmt/${d}" status
done

2：倒带

mt rew
mt rewind
mt -f /dev/mt/0 rewind
mt -f /dev/st0 rewind

3：弹出磁带

mt off
mt offline
mt eject
mt -f /dev/mt/0 off
mt -f /dev/st0 eject

4：擦除磁带（倒带，在支持的情况下卸载磁带）

mt erase
mt -f /dev/st0 erase  #Linux
mt -f /dev/rmt/0 erase #Unix

5：张紧磁带盒

如果磁带在读取时发生错误，你重新张紧磁带，清洁磁带驱动器，像下面这样再试一次：

mt retension
mt -f /dev/rmt/1 retension #Unix
mt -f /dev/st0 retension #Linux

6：在磁带当前位置写入 EOF 标记

mt eof
mt weof
mt -f /dev/st0 eof

7：将磁带前进指定的文件标记数目，即跳过指定个 EOF 标记

磁带定位在下一个文件的第一个块，即磁带会定位在下一区域的第一个块（见图01）：

mt fsf
mt -f /dev/rmt/0 fsf
mt -f /dev/rmt/1 fsf 1 #go 1 forward file/tape (see fig.01)

8：将磁带后退指定的文件标记数目，即倒带指定个 EOF 标记

磁带定位在下一个文件的第一个块，即磁带会定位在 EOF 标记之后（见图01）：

mt bsf
mt -f /dev/rmt/1 bsf
mt -f /dev/rmt/1 bsf 1 #go 1 backward file/tape (see fig.01)

这里是磁带定位命令列表：

   fsf    前进指定的文件标记数目。磁带定位在下一个文件的第一块。

   fsfm   前进指定的文件标记数目。磁带定位在前一文件的最后一块。

   bsf    后退指定的文件标记数目。磁带定位在前一文件的最后一块。

   bsfm   后退指定的文件标记数目。磁带定位在下一个文件的第一块。

   asf    磁带定位在指定文件标记数目的开始位置。定位通过先倒带，再前进指定的文件标记数目来实现。

   fsr    前进指定的记录数。

   bsr    后退指定的记录数。

   fss    （SCSI tapes）前进指定的 setmarks。

   bss    （SCSI tapes）后退指定的 setmarks。

基本备份命令

让我们来看看备份和恢复命令。
9：备份目录（tar 格式）

tar cvf /dev/rmt/0n /etc
tar cvf /dev/st0 /etc

10：恢复目录（tar 格式）

tar xvf /dev/rmt/0n -C /path/to/restore
tar xvf /dev/st0 -C /tmp

11：列出或检查磁带内容（tar 格式）

mt -f /dev/st0 rewind; dd if=/dev/st0 of=-

### tar 格式 ###
tar tvf {DEVICE} {Directory-FileName}
tar tvf /dev/st0
tar tvf /dev/st0 desktop
tar tvf /dev/rmt/0 foo > list.txt

12：使用 dump 或 ufsdump 备份分区

### Unix 备份 c0t0d0s2 分区 ###
ufsdump 0uf /dev/rmt/0  /dev/rdsk/c0t0d0s2

### Linux 备份 /home 分区 ###
dump 0uf /dev/nst0 /dev/sda5
dump 0uf /dev/nst0 /home

### FreeBSD 备份 /usr 分区 ###
dump -0aL -b64 -f /dev/nsa0 /usr

12：使用 ufsrestore 或 restore 恢复分区

### Unix ###
ufsrestore xf /dev/rmt/0
### Unix 交互式恢复 ###
ufsrestore if /dev/rmt/0

### Linux ###
restore rf /dev/nst0
### 从磁带媒介上的第6个备份交互式恢复 ###
restore isf 6 /dev/nst0

### FreeBSD 恢复 ufsdump 格式 ###
restore -i -f /dev/nsa0

13：从磁带开头开始写入（见图02）

### 这会覆盖磁带上的所有数据 ###
mt -f /dev/st1 rewind

### 备份 home ###
tar cvf /dev/st1 /home

### 离线并卸载磁带 ###
mt -f /dev/st0 offline

从磁带开头开始恢复：

mt -f /dev/st0 rewind
tar xvf /dev/st0
mt -f /dev/st0 offline

14：从最后一个 tar 后开始写入（见图02）

### 这会保留之前写入的数据 ###
mt -f /dev/st1 eom

### 备份 home ###
tar cvf /dev/st1 /home

### 卸载 ###
mt -f /dev/st0 offline

15：从 tar number 2 后开始写入（见图02）

### 在 tar number 2 之后写入（应该是 2+1）###
mt -f /dev/st0 asf 3
tar cvf /dev/st0 /usr

### asf 等效于 fsf ###
mt -f /dev/sf0 rewind
mt -f /dev/st0 fsf 2

从 tar number 2 恢复 tar：

mt -f /dev/st0 asf 3
tar xvf /dev/st0
mt -f /dev/st0 offline

如何验证使用 tar 创建的备份磁带？

定期做全系统修复和服务测试是很重要的，这是唯一确定整个系统正确工作的途径。参见我们的验证 tar 命令磁带备份的教程以获取更多信息。
示例 shell 脚本

    #!/bin/bash
    # A UNIX / Linux shell script to backup dirs to tape device like /dev/st0 (linux)
    # This script make both full and incremental backups.
    # You need at two sets of five  tapes. Label each tape as Mon, Tue, Wed, Thu and Fri.
    # You can run script at midnight or early morning each day using cronjons.
    # The operator or sys admin can replace the tape every day after the script has done.
    # Script must run as root or configure permission via sudo.
    # -------------------------------------------------------------------------
    # Copyright (c) 1999 Vivek Gite <vivek@nixcraft.com>
    # This script is licensed under GNU GPL version 2.0 or above
    # -------------------------------------------------------------------------
    # This script is part of nixCraft shell script collection (NSSC)
    # Visit http://bash.cyberciti.biz/ for more information.
    # -------------------------------------------------------------------------
    # Last updated on : March-2003 - Added log file support.
    # Last updated on : Feb-2007 - Added support for excluding files / dirs.
    # -------------------------------------------------------------------------
    LOGBASE=/root/backup/log

    # Backup dirs; do not prefix /
    BACKUP_ROOT_DIR="home sales"

    # Get todays day like Mon, Tue and so on
    NOW=$(date +"%a")

    # Tape devie name
    TAPE="/dev/st0"

    # Exclude file
    TAR_ARGS=""
    EXCLUDE_CONF=/root/.backup.exclude.conf

    # Backup Log file
    LOGFIILE=$LOGBASE/$NOW.backup.log

    # Path to binaries
    TAR=/bin/tar
    MT=/bin/mt
    MKDIR=/bin/mkdir

    # ------------------------------------------------------------------------
    # Excluding files when using tar
    # Create a file called $EXCLUDE_CONF using a text editor
    # Add files matching patterns such as follows (regex allowed):
    # home/vivek/iso
    # home/vivek/*.cpp~
    # ------------------------------------------------------------------------
    [ -f $EXCLUDE_CONF ] && TAR_ARGS="-X $EXCLUDE_CONF"

    #### Custom functions #####
    # Make a full backup
    full_backup(){
        local old=$(pwd)
        cd /
        $TAR $TAR_ARGS -cvpf $TAPE $BACKUP_ROOT_DIR
        $MT -f $TAPE rewind
        $MT -f $TAPE offline
        cd $old
    }

    # Make a  partial backup
    partial_backup(){
        local old=$(pwd)
        cd /
        $TAR $TAR_ARGS -cvpf $TAPE -N "$(date -d '1 day ago')" $BACKUP_ROOT_DIR
        $MT -f $TAPE rewind
        $MT -f $TAPE offline
        cd $old
    }

    # Make sure all dirs exits
    verify_backup_dirs(){
        local s=0
        for d in $BACKUP_ROOT_DIR
        do
            if [ ! -d /$d ];
            then
                echo "Error : /$d directory does not exits!"
                s=1
            fi
        done
        # if not; just die
        [ $s -eq 1 ] && exit 1
    }

    #### Main logic ####

    # Make sure log dir exits
    [ ! -d $LOGBASE ] && $MKDIR -p $LOGBASE

    # Verify dirs
    verify_backup_dirs

    # Okay let us start backup procedure
    # If it is Monday make a full backup;
    # For Tue to Fri make a partial backup
    # Weekend no backups
    case $NOW in
        Mon)    full_backup;;
        Tue|Wed|Thu|Fri)    partial_backup;;
        *) ;;
    esac > $LOGFIILE 2>&1


## 第三方备份工具

    Amanda
    Bacula
    rsync
    duplicity
    rsnapshot



    mt -f /dev/st0 status

    检视磁带机的硬件信息。

    mt -f /dev/st0 erase

    将磁带机中的磁带进行数据删除动作。

    mt -f /dev/st0 rewind

    将磁带进行回带动作。

    mt -f /dev/st0 offline

    将磁带进行回带并由磁带机中退出。

    mt –f /dev/st0 unload

    将磁带由磁带机中退出。

    mt -f /dev/st0 compression off

    将硬件压缩功能关闭。


pax命令

    1.

    拷贝一个目录中所有的文件到磁带上







    使用下面的步骤来用

    pax

    命令将当前目录下的所有文件拷贝到磁带上。







    (1)

    改变到包含想要拷贝的文件的目录中。







    (2)

    向磁带驱动器中插入可写磁带。







    (3)

    输入

    pax -w -f > /dev/st0

    并回车。

    -w

    选项将当前目录里写的内容写

    到磁带上。

    -f

    选项标识出磁带驱动器。

    命令最后的据点

    (.)

    指明了当前目录。

    Pax

    命令在拷贝时并列出拷贝的文件。







    (4)

    输入

    pax -l -f < /dev/st0

    并回车。

    -l

    选项列出了磁带上的文件来确

    认已经拷贝完成的文件。







    (5)

    从磁带驱动器中拿出磁带并在磁带标签上写明文件名。







    下面的例子向驱动器

    0

    中磁带上拷贝所有文件。







    %pax -w -f > /dev/st0





    2.

    恢复磁带上所有的文件







    使用下面的步骤来用

    pax

    命令将磁带上所有的文件拷贝到当前的目录中。







    (1)

    改变到想要拷贝文件的目录中。







    (2)

    向磁带驱动器中插入可写磁带。







    (3)

    输入

    pax -r -f < /dev/st0

    并回车。

    -r

    选项将磁带上的内容读取到当

    前目录。

    -f

    选项标识磁带驱动器。命令末尾句点

    (.)

    指明当前工作目录。

    Pax

    命

    令在拷贝时并不列出拷贝文件。







    (4)

    输入

    ls -l

    并回车。







    Ls

    -l

    命令列出了当前目录下的文件及其许可权，

    以此来验证文件拷贝的完

    成。







    (5)

    从磁带驱动器中拿走磁带并在磁带标签上写下文件名。







    下面的例子显示了从驱动器

    0

    中的磁带上拷贝所有的文件。



          % pax -r -f /dev/rmt/0  





    % ls -l



## 维护

1. 请定期清洁和检查磁带机，以确保其正确操作。请将磁带存储在远离磁性设备的无尘安全位置。　　
2. 应该创建一个日志并对其进行维护，该日志用于跟踪存储每个作业(备份)的介质(磁带卷)和每个备份文件的位置。
3. 注意物理安全。在保存备份磁带的位置，应该考虑一般性的物理安全：必须保护磁带免遭偷窃、蓄意破坏以及可能的环境破坏。
4. 正确保存磁带介。一些媒介有特殊的要求，必须加以考虑。比如盒式磁带的磁带卷轴要垂直放置(垂直于地面，就像汽车的轮胎一样)，并且与驱动器接触的边朝下(从而重力把磁带拖离磁带轴)。

## 厂商

HP  
IBM  
FUJITSU


The default tape device to operate on is taken from the file /usr/include/sys/mtio.h when mt is compiled. It can be overridden by giving a device file name in the environment variable TAPE or by a command line option (see below), which also overrides the environment variable.

The device must be either a character special file or a remote tape drive. To use a tape drive on another machine as the archive, use a filename that starts with 'HOSTNAME:'. The hostname can be preceded by a username and an '@' to access the remote tape drive as that user, if you have permission to do so (typically an entry in that user's '~/.rhosts' file).

The available operations are listed below. Unique abbreviations are accepted. Not all operations are available on all systems, or work on all types of tape drives. Some operations optionally take a repeat count, which can be given after the operation name and defaults to 1.
mt syntax

mt [-V] [-f device] [--file=device] [--rsh-command=command] [--version]
   operation [count]

Operations
eof, weof 	Write count EOF marks at current position.
fsf 	Forward space count files. The tape is positioned on the first block of the next file.
bsf 	Backward space count files. The tape is positioned on the first block of the next file.
fsr 	Forward space count records.
bsr 	Backward space count records.
bsfm 	Backward space count file marks. The tape is positioned on the beginning-of-the-tape side of the file mark.
fsfm 	Forward space count file marks. The tape is positioned on the beginning-of-the-tape side of the file mark.
asf 	Absolute space to file number count. Equivalent to rewind followed by fsf count.
seek 	Seek to block number count.
eom 	Space to the end of the recorded media on the tape (for appending files onto tapes).
rewind 	Rewind the tape.
offline, rewoffl 	Rewind the tape and, if applicable, unload the tape.
status 	Print status information about the tape unit.
retension 	Rewind the tape, then wind it to the end of the reel, then rewind it again.
erase 	Erase the tape.
Options
-f, --file=device 	Use device as the file name of the tape drive to operate on. To use a tape drive on another machine, use a filename that starts with 'HOSTNAME:'. The hostname can be preceded by a username and an '@' to access the remote tape drive as that user, if you have permission to do so (typically an entry in that user's '~/.rhosts' file).
--rsh-command=command 	Notifies mt that it should use command to communicate with remote devices instead of /usr/bin/ssh or /usr/bin/rsh.
-V, --version 	Print the version number of mt.
Exit Status

mt exits with a status of 0 if the operation succeeded, 1 if the operation or device name given was invalid, or 2 if the operation failed.
Related commands

during restoration(恢复) of files from a tape with multiple archives, the need arises to position the tape to the archive that holds the necessary files. to accomplish this control, use the mt command,(the name comes from "magnetic(有磁性的,有吸收力的) tape"). the mt command uses a set of simple instructions that directs the tape drive to perform a particular action.
mt
  mt [-h] [-f device_file] operation [count]
  description control a tape drive. the tape drive is intructed to perform the specified operation once, unless count is specified.
  -h print usage information, including iperation names, and exit.
  -f device_file specify the device file. if omitted, the default is used. as defined in the header file /usr/include/sys/mtio.h. the typical default is /dev/tape.
   popular tape operations
   fsf [count] forward space files. move forward the number of files specified by count(archives, in the case of tar). leaving the tape positioned at the first block of the next file.
   rewind rewind to the beginning of the tape.
   offline eject(驱逐,放逐) the tape. this is appropriate for 8 mm or similar drives. where the tape is handled automatically by the mechanism. ejecting the tape at the end of a backup may prevent at accidental subsequent backup to the same media. this operation is meaningless on devices that cannot eject the tape.
  status display status information about the tape drive being used
  tell for some SCSI tape drives. report the position of the tape in blocks
  example:
   move the tape in /dev/sto to the third archive on the tape by skipping forward over two archives:
  mt -f /dev/nst0 fsf 2
  rewind the tape in /dev/st0:
  mt -f /dev/st0 rewind
  eject the tape cartridge:
  mt -f /dev/st0 offline
  detemine what device is represented by the default /dev/tape:
   ls -l /dev/tape

Magnetic tape is a non-volatile storage medium consisting of a magnetic coating on a thin plastic strip. Nearly all recording tape is of this type, whether used for video, audio storage or general purpose digital data storage using a computer. How do I make backup using tapes under Linux operating systems?

Linux (and other Unixish system) use mt command to control magnetic tape drive operation. You need to use mt command while working with tape drive. It allows you to reading and writing to tape.

The default tape drive under Linux is /dev/st0 (first SCSI tape device name). You can read more about tape drives naming convention used under Linux here. Following paragraph summaries command you need to use control tape drive for backup/restore purpose.

Rewind tape drive:# mt -f /dev/st0 rewindBackup directory /www and /home with tar command (z – compressed):# tar -czf /dev/st0 /www /homeFind out what block you are at with mt command:# mt -f /dev/st0 tellDisplay list of files on tape drive:# tar -tzf /dev/st0Restore /www directory:# cd /
# mt -f /dev/st0 rewind
# tar -xzf /dev/st0 wwwUnload the tape:# mt -f /dev/st0 offlineDisplay status information about the tape unit:# mt -f /dev/st0 statusErase the tape:# mt -f /dev/st0 eraseYou can go BACKWARD or FORWARD on tape with mt command itself:
(a) Go to end of data:# mt -f /dev/nst0 eod(b) Goto previous record:# mt -f /dev/nst0 bsfm 1(c) Forward record:# mt -f /dev/nst0 fsf 1 Replace /dev/st0 with your actual tape drive name.
Linux Tape Backup Example

To backup to multiple tape use the following command (backup /home file system):
# tar -clpMzvf /dev/st0 /home
To compare tape backup, enter:
# tar -dlpMzvf /dev/st0 /home
To restore tape in case of data loss or hard disk failure:
# tar -xlpMzvf /dev/st0 /home
Where,

    d : find differences between archive and file system
    x : extract files from an archive
    l : list the contents of an archive
    p : ignore umask when extracting files
    M : create/list/extract multi-volume archive (multiple tapes)
    z : Compress backup using gzip
    v : verbosely list files processed
    f /dev/st0 : Tape device name
    /home : Backup /home file system

Putting it all tougher

#!/bin/bash
# A UNIX / Linux shell script to backup dirs to tape device like /dev/st0 (linux)
# This script make both full and incremental backups.
# You need at two sets of five  tapes. Label each tape as Mon, Tue, Wed, Thu and Fri.
# You can run script at midnight or early morning each day using cronjons.
# The operator or sys admin can replace the tape every day after the script has done.
# Script must run as root or configure permission via sudo.
# -------------------------------------------------------------------------
# Copyright (c) 1999 Vivek Gite <vivek@nixcraft.com>
# This script is licensed under GNU GPL version 2.0 or above
# -------------------------------------------------------------------------
# This script is part of nixCraft shell script collection (NSSC)
# Visit http://bash.cyberciti.biz/ for more information.
# -------------------------------------------------------------------------
# Last updated on : March-2003 - Added log file support.
# Last updated on : Feb-2007 - Added support for excluding files / dirs.
# -------------------------------------------------------------------------
LOGBASE=/root/backup/log

# Backup dirs; do not prefix /
BACKUP_ROOT_DIR="home sales"

# Get todays day like Mon, Tue and so on
NOW=$(date +"%a")

# Tape devie name
TAPE="/dev/st0"

# Exclude file
TAR_ARGS=""
EXCLUDE_CONF=/root/.backup.exclude.conf

# Backup Log file
LOGFIILE=$LOGBASE/$NOW.backup.log

# Path to binaries
TAR=/bin/tar
MT=/bin/mt
MKDIR=/bin/mkdir

# ------------------------------------------------------------------------
# Excluding files when using tar
# Create a file called $EXCLUDE_CONF using a text editor
# Add files matching patterns such as follows (regex allowed):
# home/vivek/iso
# home/vivek/*.cpp~
# ------------------------------------------------------------------------
[ -f $EXCLUDE_CONF ] && TAR_ARGS="-X $EXCLUDE_CONF"

#### Custom functions #####
# Make a full backup
full_backup(){
	local old=$(pwd)
	cd /
	$TAR $TAR_ARGS -cvpf $TAPE $BACKUP_ROOT_DIR
	$MT -f $TAPE rewind
	$MT -f $TAPE offline
	cd $old
}

# Make a  partial backup
partial_backup(){
	local old=$(pwd)
	cd /
	$TAR $TAR_ARGS -cvpf $TAPE -N "$(date -d '1 day ago')" $BACKUP_ROOT_DIR
	$MT -f $TAPE rewind
	$MT -f $TAPE offline
	cd $old
}

# Make sure all dirs exits
verify_backup_dirs(){
	local s=0
	for d in $BACKUP_ROOT_DIR
	do
		if [ ! -d /$d ];
		then
			echo "Error : /$d directory does not exits!"
			s=1
		fi
	done
	# if not; just die
	[ $s -eq 1 ] && exit 1
}

#### Main logic ####

# Make sure log dir exits
[ ! -d $LOGBASE ] && $MKDIR -p $LOGBASE

# Verify dirs
verify_backup_dirs

# Okay let us start backup procedure
# If it is monday make a full backup;
# For Tue to Fri make a partial backup
# Weekend no backups
case $NOW in
	Mon)	full_backup;;
	Tue|Wed|Thu|Fri) 	partial_backup;;
	*) ;;
esac > $LOGFIILE 2>&1

Customize above shell script as per your needs and setup a cron job to execute it:
@midnight /path/to/tapebackup.sh
See also:

    Howto – Use tar command through network over ssh session (i.e. writing to tape on a remote Linux server system)
    Download : Linux / UNIX Tar Full and Incremental Tape Backup Shell Script
    This small how-to covered all options used in day today life; however, it is highly recommended that you go through man pages of mt and tar command for more options/information.

Share this tutorial on:
TwitterFacebookGoogle+Download PDF version Found an error/typo on this page?
About the author: Vivek Gite is a seasoned sysadmin and a trainer for the Linux/Unix & shell scripting. Follow him on Twitter. OR read more like this:

    Verify tar command tape backup under Linux or UNIX
    Tape drives naming convention under Linux
    Howto: Use tar Command Through Network Over SSH Session
    Linux Set the Block Size for a SCSI Tape Device
    Creating A tar File in Linux Via Command Line Options
    Backup Home Directories in Linux
    How do I use cpio command under Linux?
    Solaris UNIX Tape Backup And Recovery With tar And cpio Commands
    How to: HP-UX UNIX Backup and Recover Data to Tape Device
    Can I use tape drive with XEN VPS / Guest oses?

{ 42 comments… add one }

    vinayak nageli October 4, 2006, 5:33 am

    I am new to Red Hat Linux. I want to know How to copy the whole content of tape drive to thum drive or on system directory
    Reply Link
    nikto October 6, 2006, 3:45 pm

    I think you should talk about verifying the backup just after copying files to tape
    Reply Link
    Leon November 26, 2006, 3:55 pm

    Hi. My name in leon. I thanks you for the support shown for linux. I wish you all the very best and good luck on your work.
    Reply Link
    Chris April 8, 2007, 2:37 pm

    Info about how to manage multiple tapes, and what happens when a tape gets full would be handy!
    Reply Link
    Vijay March 5, 2008, 10:36 am

    whall all should be checked as regular health check of the HP proliant servers having Linux OS platform. what all are the commands to do so?

    Regards,
    Reply Link
    Athan March 10, 2008, 4:26 am

    Hi am new to linux redhat and require some information in determining if tape drive compression is enabled on the system (ibm ultrium lto3
    Reply Link
        Thanh September 27, 2013, 9:48 pm

        tapeinfo -f /dev/st#
        Reply Link
    Glen April 7, 2008, 5:10 pm

    I have found that on RHL FC8 the mt command doesn’t work. I have had to use the full mount command and it tells me its already mounted. Has the command changed for the free version versus enterprise?

    some help on this would be appreciated.
    Reply Link
    orionsune April 23, 2008, 5:43 pm

    mt is not mount… if mt doesn’t work then you don’t have the utility installed.
    mt stands for magentic tape, it is not short for ‘mount’ like your probably thinking.
    Reply Link
    vz June 25, 2008, 10:05 pm

    Hi Glen,

    On my fedora FC8 mt was not installed from the beginning. The suitable package for installation is mt-st (something, mt-st-0.9b-4.fc8.i386)
    Reply Link
    Daniele December 30, 2008, 1:48 am

    For multiple tapes just add the -M option.

    Typical use:
    tar -clpMzvf /dev/st0 /anydir <— to backup to tape
    tar -dlpMzvf /dev/st0 /anydir <— to compare
    tar -xlpMzvf /dev/st0 /anydir <— to restore
    Reply Link
    Paolo May 5, 2009, 2:12 pm

    Thank you very much for this tutorial. It’s really useful.

    Thanks to Daniele too.
    Reply Link
    roberto June 4, 2009, 4:34 am

    Thank you! Works great.
    Reply Link
    rafi July 7, 2009, 7:01 am

    thanks to all of you
    Reply Link
    Anoop July 20, 2009, 7:10 pm

    I just wanted the TAR commands to Backup my data in etc folder to Tape media in Red hat enterprise 5.3 Linux OS. The mt option is not enabled then how can i verify and rewind the files written on the Tape ? How to enable the mt commands in Linux?

    Please let me know about this. I can see both the Tape Drives in the Library online from the Host operating system ( Red hat Entrerprise Linux 5.3 ).
    Reply Link
    k -dat software in redhat linux November 18, 2009, 3:05 pm

    my k-dat software is crashed
    what is solution
    Reply Link
    Jorge November 25, 2009, 3:07 pm

    You can’t use -M (multiple tapes) with -z option (compression).

    $ tar -clpMzvf /dev/st0 /anydir
    tar: Cannot use multi-volume compressed archives
    Reply Link
    Shafi Mohammad December 4, 2009, 6:33 am

    # mount (disk name like = /dev/sdc1) /mnt/backup
    Reply Link
    mahesh March 1, 2010, 6:12 am

    part3/radhika/Maildir/.Sent/cur/1214196153.M754850P28131V0000000000001609I004A8301_0.webmail.srishti,S=60346:2,S

    tar: /dev/st0: Cannot write: No space left on device

    tar: Error is not recoverable: exiting now

    no I want to know that in this case Backup is happen or not.

    please Reply me as soon as possible.
    Reply Link
    Yusoff April 8, 2010, 6:15 am

    Very useful article.

    Just one thing to add. I tried the various commands above. For my end, when I run the command:-
    # tar -clpMzvf /dev/nst0 /home
    I got the following error:-
    Cannot use Multi-volume compressed archive.

    So I had to drop the “z” before it runs.
    Just wondering if you’d know the reason why. In any case, just to highlight.
    Reply Link
        Jane October 16, 2010, 5:39 am

        I tried using the multiple tape option. Since my data is now bigger than my tape. However, it does not prompt me to put in the next tape the backup would just stop. Is there a way to pause and wait for the next tape to be inserted?

        Cheers!
        Reply Link
    Gopinath April 12, 2010, 11:31 am

    Hello ,

    thanking for this help menu… How we check the size of tape after writing or tack backup files …
    Reply Link
    Chandrakant September 30, 2010, 2:52 pm

    Hello,
    I am using IBM Server with OS RHEL ver 5.0
    I am using tar command to take the backup as follows
    tar -cvfr /dev/st0 —file names—
    This is appending the files to earlier backups no of times.
    How to list out all files available in the dat?
    How to restore the files which have appended no of times. i.e. 2,3,4,5 —.
    Will you help me with the examples.
    Reply Link
    Camilo Macias November 11, 2010, 10:14 pm

    Hi everyone!!!!
    I’m trying to record my Backp in a DAT 72 tape.

    I’m using the following command:

    tar cvMf /dev/nst0 $(date –date=’1 month ago’ +’%B”%Y’)

    and in some part of the recording… shows the message:

    Prepare volume #2 for `/dev/nst0′ and hit return:

    I know it’s an stupid question, but….
    I’ve done everything to eject “volume #1” from the drive,
    but anything works….
    I’ve pushed “Enter”, but, it just read the same tape,
    and shows the message again:

    repare volume #3 for `/dev/nst0′ and hit return:

    I’ve pushed the button “eject” right from the drive, nothing happens..
    I’ve writen the eject command as follows:

    mt -f /dev/nst0 eject

    But once again…. nothing happens…

    Am I doing something wrong??
    Your support and guidance will be very helpfull.

    Thanks!

    pdt: Sorry for my horrible english! I’m from Bogota, Colombia.
    Reply Link
        Aravind January 20, 2011, 10:34 pm

        For eject try the below command
        mt -f /dev/nst0 offline
        Reply Link
    Lucy Clark February 9, 2011, 4:16 pm

    I need help writing a script for Linux that will copy everything from tape to system directory. I built a Linux box with 3 TB hardware space. Now I have 60 tapes to move data from on to the system directory. I am using the following commands in order
    1) mt â€“f /dev/st0 rewind
    2) tar â€“xvf /dev/st0
    3) tar â€“xvf /dev/st0 fsf (Using this to move to the next segment of the tape)
    and then
    4) tar -xvf/dev/st0

    I keep repeating steps 3 and 4 until the end of the tape. This is very cumbersome. Being a nubie with Linux I am not sure how to simply the process. I am thinking there has to be a way of having the above in shell script or a command that copies everything from tape to system directory of the new box.
    Thanks for your help
    Reply Link
        Paul June 4, 2015, 5:11 am

        Hey Lucy,

        I know this thread/post is a couple years old and I was wondering if you figured this out. I have multipe LTO6 tapes and need to copy everything off of them, but don’t want to do one TAR at a time. I am not sure how many TARs are on the files. I thought there was a (0..100) type code I could write in Cygwin, but sure.

        Thanks,
        P
        Reply Link
    Marsupilamies March 16, 2011, 7:53 am

    I’ve noticed a trouble when you’re not on english system (for exemple, mine, french):
    NOW=$(date +”%a”) gives not “Mon” for monday but “Lun.”
    Maybe you can change NOW=$(date +”%a”) by NOW=$(date +”%u”), so $NOW will be a number (the same in each system).

    And just change:
    case $NOW in
    Mon ) full_backup;;
    Tue|Wed|Thu|Fri) partial_backup;;
    *) ;;

    by:
    case $NOW in
    1) full_backup;;
    2|3|4|5) partial_backup;;
    *) ;;

    Hope it’ll help ;-)
    Reply Link
    martin March 22, 2011, 7:43 pm

    Hi,

    My files are backed up as
    srv/scripts/…
    srv/www/.,..
    srv/blablabla…

    How to restore file srv/www/site1 to home dir?
    Is it just
    cd TOTHEDIRIWANTFILETOBERESTORED
    # tar -xzf /dev/st0 srv/www/site1
    ?
    Thank you
    Reply Link
    mahesh June 28, 2011, 4:58 am

    Hi all,

    Please tell me how to find free space in the tape drive.
    And how to restore the backup from the tape drive ( have to move the backup to other server).
    Please give me clarity about tape drive information because iam confused about tape drive.

    Thanks in adv…
    Reply Link
        Peter August 3, 2011, 12:01 pm

        I am also having a similar problem. please if you’ve receive a solution to your question then let me know the solution so that i can also apply it . Thanks.
        Reply Link
    Poppy February 7, 2012, 3:10 am

    Just to avoid snomoee having to spend a few hours restoring from backups; The first example would copy the files from server Y to server X, not the other way around.
    Reply Link
    Abdull February 10, 2012, 5:22 am

    ubunut/linux has been left beinhd quite a bit. i’m open to any helping out especially for linux and macos
    Reply Link
    DONALDO October 17, 2012, 8:36 am

    Great script at the end, very handy as i have 1.1tb to back up on an 800gb SDLT
    Reply Link
    Eslam Esmaiel February 27, 2013, 9:21 am

    Please I need your help and support for the Following Issue:
    How I can backup data from Linux to a SDLT tapes 600GB?

    Eslam
    Reply Link
    krishna chaitanya July 17, 2013, 5:00 am

    I have taken a Backup in LTO from RHEL 5.6 using tar command and i want to check the total size of data present in LTO..Please suggest me the command through which i can check the size?????
    Reply Link
    shiva December 23, 2013, 4:21 pm

    Could you please guide me the procedure to take multiple backups on single tape?

    how to take the backup using append method
    Reply Link
    mohammed March 28, 2014, 1:19 pm

    To estimate the size of the backups, calculate the size of /home and /etc directories.
    i) What command(s) did you use for this?

    ii) What are the sizes?

    Note that compressed archives will take about 30% less space.
    However you will need to store one complete backup of /home and two backups of /etc.

    iii) What is the estimate of the total space required for your backups?

    iv) What would happen if the root partition (/) ran out of space?
    Reply Link
    Byloon November 26, 2014, 6:43 am

    To estimate the size of the backups, calculate the size of /home and /etc directories.

    i) What command(s) did you use for this?

    ii) What are the sizes?

    Note that compressed archives will take about 30% less space.

    However you will need to store one complete backup of /home and two backups of /etc.

    iii) What is the estimate of the total space required for your backups?

    iv) What would happen if the root partition (/) ran out of space?

    Examine the space available on your drive, both free space (if any) as well as volumes that are using only a small amount of their allocated space. You will not only need space for the new /tmp volume, but also for a backup snap-shot volume, about 20% of the size of the /home volume.

    v) How much free disk space do you need altogether?

    If you don’t have sufficient free space available on your volume group then you must shrink one (or more) existing logical volumes to free up enough space for the new volumes.

    vi) Which volumes will you need to shrink, and what will be the new sizes of those volumes?

    Now that the volume group has sufficient free space for the new /tmp volume, create a new logical volume and then format it. Here is an example of creating a 1 gigabyte volume for /tmp, using the name LogVol04:

    vgdisplay # Note available space

    lvcreate -n LogVol04 -L 1G VolGroup00

    mkfs -t ext4 /dev/VolGroup00/LogVol04

    vi /etc/fstab # add entry for /tmp

    # Move old /tmp contents to new /tmp partition. This will likely require a reboot before the new /tmp files get used.

    mv /tmp /oldtmp

    mkdir /tmp

    chmod 1777 /tmp

    mount /tmp

    cd /oldtmp

    cp -a $(/bin/ls -A) /tmp

    # Do this after the next reboot:

    rm -ri /oldtmp

    vii) What is the exact find command which will find the names of all files and directories in /etc that have been modified in the past 24 hours?

    viii) What is the purpose of the -print0 find option, and why should you use it in a production-quality script?

    ix) What are the matching options for tar and cpio, to make an archive of the files found by find?

    x) Backup /home using dump. Use a level 0 dump. Since we don’t want to shut the system down to single user mode (or unmount /home). What are the exact commands you used?

    xi) Completely backup /etc using a compressed tar archive. What is the exact command(s) you used for this?

    xii) Completely backup /etc using a cpio archive. Now compress the resulting archive using either gzip or bzip2, whichever method you used for the tar archive in the previous step. What are the exact commands you used for this step?

    xiii) Which archive is smaller, the tar or the cpio archive of /etc, and by how much? Do you think the difference is significant?

    xiv) For each of the two archives, compute the MD5 checksum and store it in a file /tmp/name-of-archive.md5.

    xv) Copy the tar archive backup of /etc along with the matching MD5 checksum file, to your home directory on the YborStudent.hccfl.edu server using scp command. What is the exact

    command(s) you used? Before running this command, check your quota on YborStudent and make sure you won’t go over your hard limit!

    xvi) Copy the cpio archive backup of /etc, along with the matching MD5 checksum file, to your home directory on the YborStudent.hccfl.edu server using rsync command. What is the exact command(s) you used? (Note by default a modern rsync uses a secure SSH tunnel, the same as scp.) Before running this command, check your quota on YborStudent and make sure you won’t go over your hard limit!

    xvii) Describe briefly what the following command does, and list the meaning of each option used in your own words:

    rsync -HavRuzc /var/www/html/ example.com:/var/www/html/

    Now log into YborStudent and verify the integrity of the backup copies, using the MD5 checksum files.

    xviii) What are the exact commands to do that, and what are the results?

    xix) Still logged on YborStudent, extract the file /etc/group to your home directory from the tar archive. Then extract the file /etc/hosts to your home directory from the cpio archive. What are the exact commands needed for this? Be careful not to try to extract the absolute pathname or you will attempt to over-write /etc/group. (Don’t worry, you don’t have permission to do that!)

    xx) When done, delete both archives.
    Reply Link
    ravindrapatil January 12, 2015, 5:52 pm

    Hi
    I need to take backup on hp tape drive.
    Please share the procedure of backup the directory using wtar
    Reply Link
    Georg March 21, 2016, 3:20 pm

    Thank you so much guys. Helping me out again and again.. :)
    Reply Link
    Bruno July 28, 2016, 2:25 pm

    How to start writing after the last tar? (mt -f /dev/st1 eom) Is not workind!!! Plz help!!!!
    Reply Link

Security: Are you a robot or human?

Leave a Comment

Name

Email

Comment
Receive Email Notifications?
Or, you can subscribe without commenting.

You can use these HTML tags and attributes: <strong> <em> <pre> <code> <a href="" title="">

   Tagged with: /dev/st0, backup directory, linux how to read tape, linux mt command, linux mt tape, linux multiple tape backup, linux tape backup, mt command, scsi tape device, ssh session, tape, tar backup to tape drive, tar command, tar command lto tape, tar to tape, tar xzf command
