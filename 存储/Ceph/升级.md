# 升级 Ceph

[TOC]

## 概述

作为存储管理员，可以使用 `cephadm` Orchestrator 升级 Ceph 。 	

自动化升级流程遵循 Ceph 最佳实践。例如： 	

- 升级顺序从MGR、MON开始，然后是其他守护进程。 			
- 只有在 Ceph 指示集群可用后，每一守护进程才会重新启动。 			

存储集群健康状态可能会在升级过程中切换到 `HEALTH_WARNING`。升级完成后，健康状态应该切回到 HEALTH_OK。 		

升级成功后，不会收到消息。运行 `ceph versions` 和 `ceph orch ps` 命令，以验证新的镜像 ID 和存储集群的版本。

## 开始升级

开始前，需要确认所有主机都在线，且集群状态是 healthy 。

```bash
ceph -s
```

检查服务版本和可用目标容器：

```bash
# RHEL
ceph orch upgrade check --image IMAGE_NAME
```

升级存储集群:

```bash
# RHEL
ceph orch upgrade start --image IMAGE_NAME

# Other
ceph orch upgrade start --ceph-version <version>
ceph orch upgrade start --ceph-version 15.2.1
```

## 监控升级

确定是否正在进行升级，以及集群正在升级到哪个版本:

```bash
ceph orch upgrade status
```

在进行升级时，将在ceph状态输出中看到一个进度条。例如:

```bash
ceph -s

[...]
  progress:
    Upgrade to docker.io/ceph/ceph:v15.2.1 (00h 20m 12s)
      [=======.....................] (time remaining: 01h 43m 31s)
```

也可以查看 cephadm 日志：

```bash
ceph -W cephadm
```

## 取消升级

可以在任何时候取消升级：

```bash
ceph orch upgrade stop
```

## Potential problems

There are a few health alerts that can arise during the upgrade process.

### UPGRADE_NO_STANDBY_MGR

Ceph requires an active and standby manager daemon in order to proceed, but there is currently no standby.

You can ensure that Cephadm is configured to run 2 (or more) managers with:

```
# ceph orch apply mgr 2  # or more
```

You can check the status of existing mgr daemons with:

```
# ceph orch ps --daemon-type mgr
```

If an existing mgr daemon has stopped, you can try restarting it with:

```
# ceph orch daemon restart <name>
```

### UPGRADE_FAILED_PULL

Ceph was unable to pull the container image for the target version. This can happen if you specify an version or container image that does not exist (e.g., 1.2.3), or if the container registry is not reachable from one or more hosts in the cluster.

You can cancel the existing upgrade and specify a different target version with:

```
# ceph orch upgrade stop
# ceph orch upgrade start --ceph-version <version>
```

## Using customized container images

For most users, simplify specifying the Ceph version is sufficient. Cephadm will locate the specific Ceph container image to use by combining the `container_image_base` configuration option (default: `docker.io/ceph/ceph`) with a tag of `vX.Y.Z`.

You can also upgrade to an arbitrary container image.  For example, to upgrade to a development build:

```
# ceph orch upgrade start --image quay.io/ceph-ci/ceph:recent-git-branch-name
```

For more information about available container images, see [Ceph Container Images](https://docs.ceph.com/en/latest/install/containers/#containers).

## 推荐升级步骤

MON

OSD
MDS

RADOSGW







## Starting the upgrade

Before you start, you should verify that all hosts are currently online and your cluster is healthy.

```
# ceph -s
```

To upgrade (or downgrade) to a specific release:

```
# ceph orch upgrade start --ceph-version <version>
```

For example, to upgrade to v15.2.1:

```
# ceph orch upgrade start --ceph-version 15.2.1
```

## Monitoring the upgrade

Determine whether an upgrade is in process and what version the cluster is upgrading to with:

```
# ceph orch upgrade status
```

While the upgrade is underway, you will see a progress bar in the ceph status output.  For example:

```
# ceph -s
[...]
  progress:
    Upgrade to docker.io/ceph/ceph:v15.2.1 (00h 20m 12s)
      [=======.....................] (time remaining: 01h 43m 31s)
```

You can also watch the cephadm log with:

```
# ceph -W cephadm
```

## Canceling an upgrade

You can stop the upgrade process at any time with:

```
# ceph orch upgrade stop
```

## Potential problems

There are a few health alerts that can arise during the upgrade process.

### UPGRADE_NO_STANDBY_MGR

Ceph requires an active and standby manager daemon in order to proceed, but there is currently no standby.

You can ensure that Cephadm is configured to run 2 (or more) managers with:

```
# ceph orch apply mgr 2  # or more
```

You can check the status of existing mgr daemons with:

```
# ceph orch ps --daemon-type mgr
```

If an existing mgr daemon has stopped, you can try restarting it with:

```
# ceph orch daemon restart <name>
```

### UPGRADE_FAILED_PULL

Ceph was unable to pull the container image for the target version. This can happen if you specify an version or container image that does not exist (e.g., 1.2.3), or if the container registry is not reachable from one or more hosts in the cluster.

You can cancel the existing upgrade and specify a different target version with:

```
# ceph orch upgrade stop
# ceph orch upgrade start --ceph-version <version>
```

## Using customized container images

For most users, simplify specifying the Ceph version is sufficient. Cephadm will locate the specific Ceph container image to use by combining the `container_image_base` configuration option (default: `docker.io/ceph/ceph`) with a tag of `vX.Y.Z`.

You can also upgrade to an arbitrary container image.  For example, to upgrade to a development build:

```
# ceph orch upgrade start --image quay.io/ceph-ci/ceph:recent-git-branch-name
```

For more information about available container images, see [Ceph Container Images](https://docs.ceph.com/docs/master/install/containers/#containers).



Red Hat Ceph Storage 5 还包括一个健康检查功能，如果它检测到存储集群中的任何守护进程正在运行多个版本的 RHCS，它会返回 DAEMON_OLD_VERSION 警告。当守护进程继续运行多个版本的红帽 Ceph 存储，超过 `mon_warn_older_version_delay` 选项中设置的时间值时，会触发警告。默认情况下，`mon_warn_older_version_delay` 选项设置为 1 周。此设置允许大多数升级进行，而不会看到警告。如果升级过程暂停了较长的时间，您可以屏蔽健康警告： 			

```none
ceph health mute DAEMON_OLD_VERSION --sticky
```
升级完成后，取消健康警告： 			

```none
ceph health unmute DAEMON_OLD_VERSION
```