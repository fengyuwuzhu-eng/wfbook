# 主机管理

[TOC]

列出关联的主机：

```bash
ceph orch host ls [--format yaml]
```

## 添加主机

添加主机到集群，需要两步：

1. 将集群的 SSH 公钥添加到新主机 root 用户的 `authorized_keys` 文件中：

   ```bash
   ssh-copy-id -f -i /etc/ceph/ceph.pub root@<new-host>
   ```

2. 告知 Ceph 新节点是集群的一部分：

   ```bash
   ceph orch host add <newhost> [<ip>] [<label1> ...]
   ```

   例如：

   ```bash
   ceph orch host add host2 10.10.0.102
   ceph orch host add host3 10.10.0.103 
   ```

   最好显式地提供主机 IP 地址。如果没有提供 IP ，那么将立即通过 DNS 解析主机名，并使用该 IP 。

   One or more labels can also be included to immediately label the new host. 可以立即为新主机添加一个或多个标签。

   默认情况下，`_admin` 标签 将使 cephadm 在 `/etc/ceph` 中维护 `ceph.conf` 和 `client.admin` keyring 文件的副本：
   
   ```bash
   ceph orch host add host4 10.10.0.104 --labels _admin
   ```

## 删除主机

移除主机上的所有守护进程：

```bash
ceph orch host drain <host>
```

主机将具有 `_no_schedule` 标签。

主机上的所有 OSD 将按计划删除。查看 OSD 删除进度：

```bash
ceph orch osd rm status
```

检查主机上是否存在未删除的守护进程：

```bash
ceph orch ps <host>
```

删除所有守护程序后，可以删除主机：

```bash
ceph orch host rm <host>
```

## 主机标签

orchestrator支持为主机分配标签。标签是自由形式的，本身没有特定的含义，每个主机可以有多个标签。它们可用于指定守护进程的位置。

Labels can be added when adding a host with the `--labels` flag:

```bash
ceph orch host add my_hostname --labels=my_label1
ceph orch host add my_hostname --labels=my_label1,my_label2
```

向现有主机添加标签：

```bash
ceph orch host label add my_hostname my_label
```

删除主机的标签：

```bash
ceph orch host label rm my_hostname my_label
```

### 特殊主机标签

以下主机标签对cephadm有特殊的意义。所有的都以 `_` 开头。

- `_no_schedule`

  不要在此主机上计划或部署守护程序。

  此标签阻止cephadm在此主机上部署守护程序。如果将其添加到已包含 Ceph 守护程序的现有主机，将导致 cephadm 将这些守护程序移到其他位置（OSD 除外，不会自动删除）。

- `_no_autotune_memory`

  不要自动调整此主机上的内存。

  即使为该主机上的一个或多个守护程序启用了 `osd_memory_target_autotune` 或类似选项，此标签也将阻止对守护程序内存进行调优。

- `_admin`

  将 `client.admin` 和 `ceph.conf` 分发到此主机。

  默认情况下， `_admin` 标签应用于集群中的第一个主机（引导最初运行的地方）。`client.admin` 密钥通过 `ceph orch client-keyring ...`  功能分发给该主机。将此标签添加到其他主机通常会导致 cephadm 在 `/etc/ceph` 中部署 config 和 keyring 文件。

## 维护模式

将主机置于和退出维护模式（停止主机上的所有 Ceph 守护程序）：

```bash
ceph orch host maintenance enter <hostname> [--force]
ceph orch host maintenace exit <hostname>
```

进入维护模式时，设置强制标志，允许用户绕过警告（而不是警报）。allows the user to bypass warnings (but not alerts)

## Host Specification

多个主机可以一次添加。使用 `ceph orch apply -i` 提交一个 multi-document YAML 文件：

```yaml
---
service_type: host
hostname: node-00
addr: 192.168.0.10
labels:
- example1
- example2
---
service_type: host
hostname: node-01
addr: 192.168.0.11
labels:
- grafana
---
service_type: host
hostname: node-02
addr: 192.168.0.12
```

这可以与服务规范（下面）结合使用，创建一个集群规范文件，以便在一个命令中部署整个集群。请参阅 `cephadm bootstrap --apply-spec` 在引导过程中实现。在添加之前，必须将群集SSH密钥复制到主机。

## SSH 配置

### 默认行为

Cephadm在 MON 中存储一个SSH密钥，用于连接到远程主机。当集群引导时，这个SSH密钥会自动生成，不需要额外的配置。

生成新的 SSH key：

```bash
ceph cephadm generate-key
```

SSH密钥的公共部分可以通过以下方式检索：

```bash
ceph cephadm get-pub-key
```

删除当前存储的SSH密钥：

```bash
ceph cephadm clear-key
```

直接导入现有密钥：

```bash
ceph config-key set mgr/cephadm/ssh_identity_key -i <key>
ceph config-key set mgr/cephadm/ssh_identity_pub -i <pub>
```

需要重新启动 MGR 守护进程，以重新加载配置：

```bash
ceph mgr fail
```

### 设置不同的 SSH 用户

Cephadm 必须能够以有足够权限下载容器映像、启动容器和执行命令，且无需提示输入密码的用户身份登录到所有Ceph集群节点。如果不想使用“root”用户（cephadm中的默认选项），则必须向 cephadm 提供将用于执行所有操作的用户的名称。

```bash
ceph cephadm set-user <user>
```

在运行此操作之前，需要将集群ssh密钥添加到此用户 authorized_keys 文件中，并且非root用户必须具有无密码sudo的权限。

### 自定义SSH配置

Cephadm生成一个适当的 `ssh_config` 配置文件，用于连接到远程主机。此配置如下所示：

```bash
Host *
User root
StrictHostKeyChecking no
UserKnownHostsFile /dev/null
```

有两种方法自定义配置：

1. 导入将由 MON 存储的自定义配置文件：

   ```bash
   ceph cephadm set-ssh-config -i <ssh_config_file>
   ```

   要删除自定义 SSH 配置并恢复为默认行为：

   ```
   ceph cephadm clear-ssh-config
   ```

2. 可以使用以下命令设置 SSH 配置文件的路径：

   ```
   ceph config set mgr mgr/cephadm/ssh_config_file <path>
   ```

   我们不推荐这种方法。路径名必须对任何 MGR 守护程序可见，cephadm 以容器形式运行所有守护程序。这意味着需要将该文件放置在用于部署的自定义容器映像中，或者手动分发到 MGR 数据目录（/var/lib/ceph//mgr.在主机上，在容器内部的/var/lib/ceph/mgr/ceph-处可见）。 (`/var/lib/ceph/<cluster-fsid>/mgr.<id>` on the host, visible at `/var/lib/ceph/mgr/ceph-<id>` from inside the container).



## Fully qualified domain names vs bare host names

cephadm has very minimal requirements when it comes to resolving host names etc. When cephadm initiates an ssh connection to a remote host, the host name  can be resolved in four different ways:

- a custom ssh config resolving the name to an IP
- via an externally maintained `/etc/hosts`
- via explicitly providing an IP address to cephadm: `ceph orch host add <hostname> <IP>`
- automatic name resolution via DNS.

Ceph itself uses the command `hostname` to determine the name of the current host.

Note

cephadm demands that the name of the host given via `ceph orch host add` equals the output of `hostname` on remote hosts.

Otherwise cephadm can’t be sure, the host names returned by `ceph * metadata` match the hosts known to cephadm. This might result in a [CEPHADM_STRAY_HOST](https://docs.ceph.com/en/latest/cephadm/operations/#cephadm-stray-host) warning.

When configuring new hosts, there are two **valid** ways to set the `hostname` of a host:

1. Using the bare host name. In this case:

- `hostname` returns the bare host name.
- `hostname -f` returns the FQDN.

1. Using the fully qualified domain name as the host name. In this case:

- `hostname` returns the FQDN
- `hostname -s` return the bare host name

Note that `man hostname` recommends `hostname` to return the bare host name:

> The FQDN (Fully Qualified Domain Name) of the system is the name that the resolver(3) returns for the host name, such as, ursula.example.com. It is usually the hostname followed by the DNS domain name (the part after the first dot). You can check the FQDN using `hostname --fqdn` or the domain name using `dnsdomainname`.
>
> ```
> You cannot change the FQDN with hostname or dnsdomainname.
> 
> The recommended method of setting the FQDN is to make the hostname
> be an alias for the fully qualified name using /etc/hosts, DNS, or
> NIS. For example, if the hostname was "ursula", one might have
> a line in /etc/hosts which reads
> 
>        127.0.1.1    ursula.example.com ursula
> ```

Which means, `man hostname` recommends `hostname` to return the bare host name. This in turn means that Ceph will return the bare host names when executing `ceph * metadata`. This in turn means cephadm also requires the bare host name when adding a host to the cluster: `ceph orch host add <bare-name>`.