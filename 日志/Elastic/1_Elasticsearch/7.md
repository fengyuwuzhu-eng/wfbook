# Discovery and cluster formation 发现和集群形成

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery.asciidoc)

The discovery and cluster formation processes are responsible for discovering nodes, electing a master, forming a cluster, and publishing the cluster state each time it changes.
发现和集群形成过程负责发现节点、选举主节点、形成集群并在每次集群状态发生变化时发布集群状态。

The following processes and settings are part of discovery and cluster formation:
以下过程和设置是发现和集群形成的一部分：

- [Discovery 发现](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-hosts-providers.html)

  Discovery is the process where nodes find each other when the master is unknown, such as when a node has just started up or when the previous master has failed.  发现是在主节点未知的情况下（例如节点刚刚启动或前一个主节点发生故障时）节点相互发现的过程。

- [Quorum-based decision making 基于法定人数的决策](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-quorums.html)

  How Elasticsearch uses a quorum-based voting mechanism to make decisions even if some nodes are unavailable.  Elasticsearch 如何使用基于仲裁的投票机制在某些节点不可用的情况下做出决策。

- [Voting configurations 投票配置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-voting.html)

  How Elasticsearch automatically updates voting configurations as nodes leave and join a cluster.  当节点离开和加入集群时，Elasticsearch 如何自动更新投票配置。

- [Bootstrapping a cluster 引导集群](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html)

  Bootstrapping a cluster is required when an Elasticsearch cluster starts up for the very first time. In [development mode](https://www.elastic.co/guide/en/elasticsearch/reference/current/bootstrap-checks.html#dev-vs-prod-mode), with no discovery settings configured, this is automatically performed by the nodes themselves. As this auto-bootstrapping is [inherently unsafe](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-quorums.html), running a node in [production mode](https://www.elastic.co/guide/en/elasticsearch/reference/current/bootstrap-checks.html#dev-vs-prod-mode) requires bootstrapping to be [explicitly configured](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html).  当Elasticsearch集群第一次启动时，需要引导集群。在[开发模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/bootstrap-checks.html#dev-vs-prod-mode)下，如果没有配置发现设置，这将由节点本身自动执行。由于这种自动引导[本质上是不安全的](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-quorums.html)，因此在[生产模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/bootstrap-checks.html#dev-vs-prod-mode)下运行节点需要[显式配置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html)引导。

- [Adding and removing master-eligible nodes 添加和删除符合主资格的节点](https://www.elastic.co/guide/en/elasticsearch/reference/current/add-elasticsearch-nodes.html)

  It is recommended to have a small and fixed number of master-eligible nodes in a cluster, and to scale the cluster up and down by adding and removing master-ineligible nodes only. However there are situations in which it may be desirable to add or remove some master-eligible nodes to or from a cluster. This section describes the process for adding or removing master-eligible nodes, including the extra steps that need to be performed when removing more than half of the master-eligible nodes at the same time.  建议在集群中拥有少量且固定数量的符合主资格的节点，并仅通过添加和删除不符合主资格的节点来扩展和缩小集群。然而，在某些情况下，可能需要向集群添加或删除一些符合主节点资格的节点。本节介绍添加或删除 Master 资格节点的过程，包括同时删除超过一半的 Master 资格节点时需要执行的额外步骤。

- [Publishing the cluster state 发布集群状态](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-state-publishing.html)

  Cluster state publishing is the process by which the elected master node updates the cluster state on all the other nodes in the cluster.  集群状态发布是当选出的主节点更新集群中所有其他节点上的集群状态的过程。

- [Cluster fault detection 集群故障检测](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-fault-detection.html)

  Elasticsearch performs health checks to detect and remove faulty nodes.  Elasticsearch 执行健康检查以检测并删除故障节点。

- [Settings 设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html)

  There are settings that enable users to influence the discovery, cluster formation, master election and fault detection processes.  有些设置使用户能够影响发现、集群形成、主选举和故障检测过程。

# Discovery 发现

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/discovery.asciidoc)

Discovery is the process by which the cluster formation module finds other nodes with which to form a cluster. This process runs when you start an Elasticsearch node or when a node believes the master node failed and continues until the master node is found or a new master node is elected.
发现是集群形成模块寻找其他节点来形成集群的过程。当您启动 Elasticsearch 节点或节点认为主节点发生故障时，此过程将运行，并持续到找到主节点或选举出新的主节点为止。

This process starts with a list of *seed* addresses from one or more [seed hosts providers](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-hosts-providers.html#built-in-hosts-providers), together with the addresses of any master-eligible nodes that were in the last-known cluster. The process operates in two phases: First, each node probes the seed addresses by connecting to each address and attempting to identify the node to which it is connected and to verify that it is master-eligible. Secondly, if successful, it shares with the remote node a list of all of its known master-eligible peers and the remote node responds with *its* peers in turn. The node then probes all the new nodes that it just discovered, requests their peers, and so on.
此过程从一个或多个[种子主机提供商](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-hosts-providers.html#built-in-hosts-providers)的*种子*地址列表开始，以及最后一个已知集群中任何符合主节点资格的节点的地址。该过程分两个阶段进行：首先，每个节点通过连接到每个地址并尝试识别其所连接的节点来探测种子地址，并验证其是否具有主节点资格。其次，如果成功，它与远程节点共享其所有已知的主合格对等点的列表，并且远程节点依次*与其*对等点进行响应。然后，该节点探测它刚刚发现的所有新节点，请求它们的对等节点，等等。

If the node is not master-eligible then it continues this discovery process until it has discovered an elected master node. If no elected master is discovered then the node will retry after `discovery.find_peers_interval` which defaults to `1s`.
如果该节点不符合主节点资格，则它将继续此发现过程，直到发现当选的主节点。如果没有发现当选的主节点，则节点将在`discovery.find_peers_interval`之后重试，默认为`1s` 。

If the node is master-eligible then it continues this discovery process until it has either discovered an elected master node or else it has discovered enough masterless master-eligible nodes to complete an election. If neither of these occur quickly enough then the node will retry after `discovery.find_peers_interval` which defaults to `1s`.
如果该节点符合主节点资格，则它会继续此发现过程，直到它发现选举出的主节点，或者发现足够多的无主节点，以完成选举。如果这些都没有足够快地发生，则节点将在`discovery.find_peers_interval`之后重试，默认为`1s` 。

Once a master is elected, it will normally remain as the elected master until it is deliberately stopped. It may also stop acting as the master if [fault detection](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-fault-detection.html) determines the cluster to be faulty. When a node stops being the elected master, it begins the discovery process again.
一旦主节点被选举出来，它通常会保持为选举主节点，直到被故意停止为止。如果[故障检测](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-fault-detection.html)确定集群有故障，它也可能停止充当主节点。当一个节点不再被选举为主节点时，它会再次开始发现过程。

Refer to [Troubleshooting discovery](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-troubleshooting.html) for troubleshooting issues with discovery.
请参阅对[发现进行故障排除](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-troubleshooting.html)以对发现问题进行故障排除。

## Seed hosts providers 种子宿主提供商

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/discovery.asciidoc)

By default the cluster formation module offers two seed hosts providers to configure the list of seed nodes: a *settings*-based and a *file*-based seed hosts provider. It can be extended to support cloud environments and other forms of seed hosts providers via [discovery plugins](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/discovery.html). Seed hosts providers are configured using the `discovery.seed_providers` setting, which defaults to the *settings*-based hosts provider. This setting accepts a list of different providers, allowing you to make use of multiple ways to find the seed hosts for your cluster.
默认情况下，集群形成模块提供两个种子主机提供程序来配置种子节点列表：基于*设置*的种子主机提供程序和基于*文件*的种子主机提供程序。它可以通过[发现插件](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/discovery.html)进行扩展以支持云环境和其他形式的种子主机提供商。种子主机提供程序是使用`discovery.seed_providers`设置进行配置的，该设置默认为基于*设置*的主机提供程序。此设置接受不同提供程序的列表，允许您使用多种方式来查找集群的种子主机。

Each seed hosts provider yields the IP addresses or hostnames of the seed nodes. If it returns any hostnames then these are resolved to IP addresses using a DNS lookup. If a hostname resolves to multiple IP addresses then Elasticsearch tries to find a seed node at all of these addresses. If the hosts provider does not explicitly give the TCP port of the node by then, it will implicitly use the first port in the port range given by `transport.profiles.default.port`, or by `transport.port` if `transport.profiles.default.port` is not set. The number of concurrent lookups is controlled by `discovery.seed_resolver.max_concurrent_resolvers` which defaults to `10`, and the timeout for each lookup is controlled by `discovery.seed_resolver.timeout` which defaults to `5s`. Note that DNS lookups are subject to [JVM DNS caching](https://www.elastic.co/guide/en/elasticsearch/reference/current/networkaddress-cache-ttl.html).
每个种子主机提供商都会生成种子节点的 IP 地址或主机名。如果它返回任何主机名，则使用 DNS 查找将这些主机名解析为 IP 地址。如果主机名解析为多个 IP 地址，则  Elasticsearch 会尝试在所有这些地址处查找种子节点。如果此时主机提供程序没有显式给出节点的 TCP  端口，它将隐式使用以下给出的端口范围中的第一个端口 `transport.profiles.default.port` ，或通过`transport.port`如果 `transport.profiles.default.port` 未设置。并发查找的数量由 `discovery.seed_resolver.max_concurrent_resolvers` 默认为`10` ，每次查找的超时由 `discovery.seed_resolver.timeout` 默认为`5s` 。请注意，DNS 查找受[JVM DNS 缓存的](https://www.elastic.co/guide/en/elasticsearch/reference/current/networkaddress-cache-ttl.html)约束。

### Settings-based seed hosts provider 基于设置的种子主机提供商

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/discovery.asciidoc)

The settings-based seed hosts provider uses a node setting to configure a static list of the addresses of the seed nodes. These addresses can be given as hostnames or IP addresses; hosts specified as hostnames are resolved to IP addresses during each round of discovery.
基于设置的种子主机提供程序使用节点设置来配置种子节点地址的静态列表。这些地址可以作为主机名或 IP 地址给出；指定为主机名的主机在每轮发现期间都会解析为 IP 地址。

The list of hosts is set using the [`discovery.seed_hosts`](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#unicast.hosts) static setting. For example:
主机列表是使用[`discovery.seed_hosts`](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#unicast.hosts)静态设置设置的。例如：

```yaml
discovery.seed_hosts:
   - 192.168.1.10:9300
   - 192.168.1.11 
   - seeds.mydomain.com 
```

|      | The port will default to `transport.profiles.default.port` and fallback to `transport.port` if not specified. 该端口将默认为 `transport.profiles.default.port` 如果未指定，则回退到`transport.port` 。 |
| ---- | ------------------------------------------------------------ |
|      | If a hostname resolves to multiple IP addresses, Elasticsearch will attempt to connect to every resolved address. 如果主机名解析为多个 IP 地址，Elasticsearch 将尝试连接到每个解析的地址。 |

### File-based seed hosts provider 基于文件的种子主机提供商

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/discovery.asciidoc)

The file-based seed hosts provider configures a list of hosts via an external file.  Elasticsearch reloads this file when it changes, so that the list of seed nodes can change dynamically without needing to restart each node. For example, this gives a convenient mechanism for an Elasticsearch instance that is run in a Docker container to be dynamically supplied with a list of IP addresses to connect to when those IP addresses may not be known at node startup.
基于文件的种子主机提供程序通过外部文件配置主机列表。 Elasticsearch 在更改时会重新加载此文件，以便种子节点列表可以动态更改，而无需重新启动每个节点。例如，这为在 Docker  容器中运行的 Elasticsearch 实例提供了一种方便的机制，当这些 IP 地址在节点启动时可能未知时，可以动态地为其提供要连接的 IP  地址列表。

To enable file-based discovery, configure the `file` hosts provider as follows in the `elasticsearch.yml` file:
要启用基于文件的发现，请在`elasticsearch.yml`文件中配置`file`主机提供程序，如下所示：

```yml
discovery.seed_providers: file
```

Then create a file at `$ES_PATH_CONF/unicast_hosts.txt` in the format described below. Any time a change is made to the `unicast_hosts.txt` file the new changes will be picked up by Elasticsearch and the new hosts list will be used.
然后创建一个文件 `$ES_PATH_CONF/unicast_hosts.txt` 采用下面描述的格式。每当对`unicast_hosts.txt`文件进行更改时，Elasticsearch 都会拾取新的更改并使用新的主机列表。

Note that the file-based discovery plugin augments the unicast hosts list in `elasticsearch.yml`: if there are valid seed addresses in `discovery.seed_hosts` then Elasticsearch uses those addresses in addition to those supplied in `unicast_hosts.txt`.
请注意，基于文件的发现插件会扩充`elasticsearch.yml`中的单播主机列表：如果`discovery.seed_hosts`中存在有效的种子地址，则除了`unicast_hosts.txt`中提供的地址之外，Elasticsearch 还会使用这些地址。

The `unicast_hosts.txt` file contains one node entry per line. Each node entry consists of the host (host name or IP address) and an optional transport port number. If the port number is specified, it must come immediately after the host (on the same line) separated by a `:`. If the port number is not specified, Elasticsearch will implicitly use the first port in the port range given by `transport.profiles.default.port`, or by `transport.port` if `transport.profiles.default.port` is not set.
`unicast_hosts.txt`文件每行包含一个节点条目。每个节点条目由主机（主机名或 IP 地址）和可选的传输端口号组成。如果指定了端口号，则它必须紧跟在主机之后（在同一行），并用`:`分隔。如果未指定端口号，Elasticsearch 将隐式使用以下给出的端口范围中的第一个端口 `transport.profiles.default.port` ，或通过`transport.port`如果 `transport.profiles.default.port` 未设置。

For example, this is an example of `unicast_hosts.txt` for a cluster with four nodes that participate in discovery, some of which are not running on the default port:
例如，这是一个包含四个参与发现的节点的集群的`unicast_hosts.txt`示例，其中一些节点不在默认端口上运行：

```txt
10.10.10.5
10.10.10.6:9305
10.10.10.5:10005
# an IPv6 address
[2001:0db8:85a3:0000:0000:8a2e:0370:7334]:9301
```

Host names are allowed instead of IP addresses and are resolved by DNS as described above. IPv6 addresses must be given in brackets with the port, if needed, coming after the brackets.
允许使用主机名代替 IP 地址，并由 DNS 解析，如上所述。 IPv6 地址必须在括号中给出，如果需要，端口位于括号后面。

You can also add comments to this file. All comments must appear on their lines starting with `#` (i.e. comments cannot start in the middle of a line).
您还可以向该文件添加注释。所有注释必须出现在以`#`开头的行中（即注释不能在行的中间开始）。

### EC2 hosts provider EC2 主机提供商

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/discovery.asciidoc)

The [EC2 discovery plugin](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/discovery-ec2.html) adds a hosts provider that uses the [AWS API](https://github.com/aws/aws-sdk-java) to find a list of seed nodes.
[EC2 发现插件](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/discovery-ec2.html)添加了一个主机提供程序，该提供程序使用[AWS API](https://github.com/aws/aws-sdk-java)来查找种子节点列表。

### Azure Classic hosts provider Azure 经典主机提供商

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/discovery.asciidoc)

The [Azure Classic discovery plugin](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/discovery-azure-classic.html) adds a hosts provider that uses the Azure Classic API find a list of seed nodes.
[Azure 经典发现插件](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/discovery-azure-classic.html)添加了一个主机提供程序，该提供程序使用 Azure 经典 API 查找种子节点列表。

### Google Compute Engine hosts provider Google Compute Engine 托管提供商

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/discovery.asciidoc)

The [GCE discovery plugin](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/discovery-gce.html) adds a hosts provider that uses the GCE API find a list of seed nodes.
[GCE 发现插件](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/discovery-gce.html)添加了一个主机提供程序，它使用 GCE API 查找种子节点列表。

# Quorum-based decision making 基于法定人数的决策

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/quorums.asciidoc)

Electing a master node and changing the cluster state are the two fundamental tasks that master-eligible nodes must work together to perform. It is important that these activities work robustly even if some nodes have failed. Elasticsearch achieves this robustness by considering each action to have succeeded on receipt of responses from a *quorum*, which is a subset of the master-eligible nodes in the cluster. The advantage of requiring only a subset of the nodes to respond is that it means some of the nodes can fail without preventing the cluster from making progress. The quorums are carefully chosen so the cluster does not have a "split brain" scenario where it’s partitioned into two pieces such that each piece may make decisions that are inconsistent with those of the other piece.
选举主节点和更改集群状态是符合主节点资格的节点必须共同执行的两项基本任务。即使某些节点发生故障，这些活动也能稳健地运行，这一点很重要。 Elasticsearch 通过在收到来自*quorum*  （集群中符合主节点资格的节点的子集）的响应时认为每个操作已成功来实现这种鲁棒性。仅需要一部分节点做出响应的优点是，这意味着某些节点可能会发生故障，而不会阻止集群取得进展。法定人数是经过精心选择的，因此集群不会出现“裂脑”场景，即集群被分为两部分，这样每一部分都可能做出与另一部分不一致的决策。

Elasticsearch allows you to add and remove master-eligible nodes to a running cluster. In many cases you can do this simply by starting or stopping the nodes as required. See [*Add and remove nodes in your cluster*](https://www.elastic.co/guide/en/elasticsearch/reference/current/add-elasticsearch-nodes.html) for more information.
Elasticsearch 允许您向正在运行的集群添加和删除符合主资格的节点。在许多情况下，您只需根据需要启动或停止节点即可做到这一点。有关详细信息，请参阅[*添加和删除集群中的节点*](https://www.elastic.co/guide/en/elasticsearch/reference/current/add-elasticsearch-nodes.html)。

As nodes are added or removed Elasticsearch maintains an optimal level of fault tolerance by updating the cluster’s [voting configuration](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-voting.html), which is the set of master-eligible nodes whose responses are counted when making decisions such as electing a new master or committing a new cluster state. A decision is made only after more than half of the nodes in the voting configuration have responded. Usually the voting configuration is the same as the set of all the master-eligible nodes that are currently in the cluster. However, there are some situations in which they may be different.
添加或删除节点时，Elasticsearch 通过更新集群的[投票配置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-voting.html)来维持最佳的容错级别，投票配置是一组符合主节点资格的节点，在做出选举新主节点或提交新集群状态等决策时，会计算这些节点的响应。只有在投票配置中超过一半的节点做出响应后才会做出决定。通常，投票配置与集群中当前所有符合主节点资格的节点的集合相同。然而，在某些情况下它们可能会有所不同。

To be sure that the cluster remains available you **must not stop half or more of the nodes in the voting configuration at the same time**. As long as more than half of the voting nodes are available the cluster can still work normally. This means that if there are three or four master-eligible nodes, the cluster can tolerate one of them being unavailable. If there are two or fewer master-eligible nodes, they must all remain available.
为了确保集群保持可用，您**不得同时停止投票配置中一半或更多的节点**。只要有一半以上的投票节点可用，集群就可以正常工作。这意味着如果有三到四个符合主节点资格的节点，集群可以容忍其中一个节点不可用。如果有两个或更少的主节点，它们必须全部保持可用。

If you stop half or more of the nodes in the voting configuration at the same time then the cluster will be unavailable until you bring enough nodes back online to form a quorum again. While the cluster is unavailable, any remaining nodes will report in their logs that they cannot discover or elect a master node. See [*Troubleshooting discovery*](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-troubleshooting.html) for more information.
如果您同时停止投票配置中的一半或更多节点，则集群将不可用，直到您使足够的节点重新上线以再次形成仲裁。当集群不可用时，任何剩余节点将在其日志中报告它们无法发现或选择主节点。有关详细信息，请参阅[*发现故障排除*](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-troubleshooting.html)。

After a master-eligible node has joined or left the cluster the elected master may issue a cluster-state update that adjusts the voting configuration to match, and this can take a short time to complete. It is important to wait for this adjustment to complete before removing more nodes from the cluster. See [Removing master-eligible nodes](https://www.elastic.co/guide/en/elasticsearch/reference/current/add-elasticsearch-nodes.html#modules-discovery-removing-nodes) for more information.
在符合主节点资格的节点加入或离开集群后，当选的主节点可能会发出集群状态更新，以调整投票配置以匹配，这可能需要很短的时间才能完成。在从集群中删除更多节点之前，等待此调整完成非常重要。有关更多信息，请参阅[删除符合主节点资格的节点](https://www.elastic.co/guide/en/elasticsearch/reference/current/add-elasticsearch-nodes.html#modules-discovery-removing-nodes)。

## Master elections 大师选举

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/quorums.asciidoc)

Elasticsearch uses an election process to agree on an elected master node, both at startup and if the existing elected master fails. Any master-eligible node can start an election, and normally the first election that takes place will succeed. Elections only usually fail when two nodes both happen to start their elections at about the same time, so elections are scheduled randomly on each node to reduce the probability of this happening. Nodes will retry elections until a master is elected, backing off on failure, so that eventually an election will succeed (with arbitrarily high probability). The scheduling of master elections are controlled by the [master election settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html#master-election-settings).
Elasticsearch  使用选举过程来就选定的主节点达成一致，无论是在启动时还是在现有选定的主节点发生故障时。任何符合主节点资格的节点都可以开始选举，通常第一次选举就会成功。通常，只有当两个节点恰好同时开始选举时，选举才会失败，因此在每个节点上随机安排选举以减少发生这种情况的可能性。节点将重试选举，直到选举出主节点，失败时进行退缩，以便最终选举成功（具有任意高的概率）。主选举的调度由[主选举设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html#master-election-settings)控制。

## Cluster maintenance, rolling restarts and migrations 集群维护、滚动重启和迁移

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/quorums.asciidoc)

Many cluster maintenance tasks involve temporarily shutting down one or more nodes and then starting them back up again. By default Elasticsearch can remain available if one of its master-eligible nodes is taken offline, such as during a rolling upgrade. Furthermore, if multiple nodes are stopped and then started again then it will automatically recover, such as during a full cluster restart. There is no need to take any further action with the APIs described here in these cases, because the set of master nodes is not changing permanently.
许多集群维护任务涉及暂时关闭一个或多个节点，然后再次启动它们。默认情况下，如果 Elasticsearch 的主节点之一离线（例如在滚动升级期间），则 Elasticsearch  仍可以保持可用。此外，如果多个节点停止然后再次启动，它将自动恢复，例如在整个集群重新启动期间。在这些情况下，无需使用此处描述的 API  采取任何进一步的操作，因为主节点集不会永久更改。

# Voting configurations 投票配置

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/voting.asciidoc)

Each Elasticsearch cluster has a *voting configuration*, which is the set of [master-eligible nodes](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node) whose responses are counted when making decisions such as electing a new master or committing a new cluster state. Decisions are made only after a majority (more than half) of the nodes in the voting configuration respond.
每个 Elasticsearch 集群都有一个*投票配置*，它是一组[符合主节点资格的节点，](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node)在做出选举新主节点或提交新集群状态等决策时，将对这些节点的响应进行计数。仅在投票配置中的大多数（超过一半）节点做出响应后才会做出决定。

Usually the voting configuration is the same as the set of all the master-eligible nodes that are currently in the cluster. However, there are some situations in which they may be different.
通常，投票配置与集群中当前所有符合主节点资格的节点的集合相同。然而，在某些情况下它们可能会有所不同。

To be sure that the cluster remains available you **must not stop half or more of the nodes in the voting configuration at the same time**. As long as more than half of the voting nodes are available the cluster can still work normally. This means that if there are three or four master-eligible nodes, the cluster can tolerate one of them being unavailable. If there are two or fewer master-eligible nodes, they must all remain available.
为了确保集群保持可用，您**不得同时停止投票配置中一半或更多的节点**。只要有一半以上的投票节点可用，集群就可以正常工作。这意味着如果有三到四个符合主节点资格的节点，集群可以容忍其中一个节点不可用。如果有两个或更少的主节点，它们必须全部保持可用。

If you stop half or more of the nodes in the voting configuration at the same time then the cluster will be unavailable until you bring enough nodes back online to form a quorum again. While the cluster is unavailable, any remaining nodes will report in their logs that they cannot discover or elect a master node. See [*Troubleshooting discovery*](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-troubleshooting.html) for more information.
如果您同时停止投票配置中的一半或更多节点，则集群将不可用，直到您使足够的节点重新上线以再次形成仲裁。当集群不可用时，任何剩余节点将在其日志中报告它们无法发现或选择主节点。有关详细信息，请参阅[*发现故障排除*](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-troubleshooting.html)。

After a node joins or leaves the cluster, Elasticsearch reacts by automatically making corresponding changes to the voting configuration in order to ensure that the cluster is as resilient as possible. It is important to wait for this adjustment to complete before you remove more nodes from the cluster. For more information, see [*Add and remove nodes in your cluster*](https://www.elastic.co/guide/en/elasticsearch/reference/current/add-elasticsearch-nodes.html).
当节点加入或离开集群后，Elasticsearch 会自动对投票配置进行相应的更改，以确保集群尽可能具有弹性。在从集群中删除更多节点之前，请务必等待此调整完成。有关更多信息，请参阅[*添加和删除集群中的节点*](https://www.elastic.co/guide/en/elasticsearch/reference/current/add-elasticsearch-nodes.html)。

The current voting configuration is stored in the cluster state so you can inspect its current contents as follows:
当前的投票配置存储在集群状态中，因此您可以检查其当前内容，如下所示：



```console
GET /_cluster/state?filter_path=metadata.cluster_coordination.last_committed_config
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/34.console) 

The current voting configuration is not necessarily the same as the set of all available master-eligible nodes in the cluster. Altering the voting configuration involves taking a vote, so it takes some time to adjust the configuration as nodes join or leave the cluster. Also, there are situations where the most resilient configuration includes unavailable nodes or does not include some available nodes. In these situations, the voting configuration differs from the set of available master-eligible nodes in the cluster.
当前的投票配置不一定与集群中所有可用的符合主节点资格的节点的集合相同。更改投票配置涉及投票，因此当节点加入或离开集群时需要一些时间来调整配置。此外，还存在最具弹性的配置包括不可用节点或不包括某些可用节点的情况。在这些情况下，投票配置与集群中可用的符合主节点资格的节点集不同。

Larger voting configurations are usually more resilient, so Elasticsearch normally prefers to add master-eligible nodes to the voting configuration after they join the cluster. Similarly, if a node in the voting configuration leaves the cluster and there is another master-eligible node in the cluster that is not in the voting configuration then it is preferable to swap these two nodes over. The size of the voting configuration is thus unchanged but its resilience increases.
较大的投票配置通常更具弹性，因此 Elasticsearch  通常更愿意在加入集群后将符合主资格的节点添加到投票配置中。类似地，如果投票配置中的一个节点离开集群，并且集群中存在另一个不属于投票配置的主节点，那么最好交换这两个节点。因此，投票配置的规模保持不变，但其弹性增加。

It is not so straightforward to automatically remove nodes from the voting configuration after they have left the cluster. Different strategies have different benefits and drawbacks, so the right choice depends on how the cluster will be used. You can control whether the voting configuration automatically shrinks by using the [`cluster.auto_shrink_voting_configuration` setting](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html).
在节点离开集群后自动从投票配置中删除节点并不是那么简单。不同的策略有不同的优点和缺点，因此正确的选择取决于集群的使用方式。您可以使用以下命令控制投票配置是否自动收缩 `cluster.auto_shrink_voting_configuration` [环境](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html)。

If `cluster.auto_shrink_voting_configuration` is set to `true` (which is the default and recommended value) and there are at least three master-eligible nodes in the cluster, Elasticsearch remains capable of processing cluster state updates as long as all but one of its master-eligible nodes are healthy.
如果 `cluster.auto_shrink_voting_configuration` 设置为`true` （这是默认值和推荐值），并且集群中至少有 3 个符合主资格的节点，只要除了其中一个符合主资格的节点之外的所有节点都处于健康状态，Elasticsearch 仍然能够处理集群状态更新。

There are situations in which Elasticsearch might tolerate the loss of multiple nodes, but this is not guaranteed under all sequences of failures. If the `cluster.auto_shrink_voting_configuration` setting is `false`, you must remove departed nodes from the voting configuration manually. Use the [voting exclusions API](https://www.elastic.co/guide/en/elasticsearch/reference/current/voting-config-exclusions.html) to achieve the desired level of resilience.
在某些情况下，Elasticsearch 可能会容忍多个节点的丢失，但这并不能保证在所有故障序列下都是如此。如果 `cluster.auto_shrink_voting_configuration` 设置为`false`时，您必须手动从投票配置中删除离开的节点。使用[投票排除 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/voting-config-exclusions.html)来实现所需的弹性级别。

No matter how it is configured, Elasticsearch will not suffer from a "https://en.wikipedia.org/wiki/Split-brain_(computing)[split-brain]" inconsistency. The `cluster.auto_shrink_voting_configuration` setting affects only its availability in the event of the failure of some of its nodes and the administrative tasks that must be performed as nodes join and leave the cluster.
无论如何配置，Elasticsearch 都不会出现“https://en.wikipedia.org/wiki/Split-brain_(computing)[split-brain]”不一致的问题。这 `cluster.auto_shrink_voting_configuration` 设置仅影响其某些节点发生故障时的可用性以及节点加入和离开集群时必须执行的管理任务。

## Even numbers of master-eligible nodes 偶数个符合主节点资格的节点

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/voting.asciidoc)

There should normally be an odd number of master-eligible nodes in a cluster. If there is an even number, Elasticsearch leaves one of them out of the voting configuration to ensure that it has an odd size. This omission does not decrease the failure-tolerance of the cluster. In fact, improves it slightly: if the cluster suffers from a network partition that divides it into two equally-sized halves then one of the halves will contain a majority of the voting configuration and will be able to keep operating. If all of the votes from master-eligible nodes were counted, neither side would contain a strict majority of the nodes and so the cluster would not be able to make any progress.
集群中通常应该有奇数个符合主节点资格的节点。如果有偶数，Elasticsearch  会将其中一个排除在投票配置之外，以确保其大小为奇数。此省略不会降低集群的容错能力。事实上，稍微改进一下：如果集群遇到网络分区，将其分成大小相等的两半，那么其中一半将包含大多数投票配置，并且能够继续运行。如果所有符合主节点资格的节点的投票都被计算在内，那么任何一方都不会拥有绝对多数节点，因此集群将无法取得任何进展。

For instance if there are four master-eligible nodes in the cluster and the voting configuration contained all of them, any quorum-based decision would require votes from at least three of them. This situation means that the cluster can tolerate the loss of only a single master-eligible node. If this cluster were split into two equal halves, neither half would contain three master-eligible nodes and the cluster would not be able to make any progress. If the voting configuration contains only three of the four master-eligible nodes, however, the cluster is still only fully tolerant to the loss of one node, but quorum-based decisions require votes from two of the three voting nodes. In the event of an even split, one half will contain two of the three voting nodes so that half will remain available.
例如，如果集群中有四个符合主节点资格的节点，并且投票配置包含所有这些节点，则任何基于仲裁的决策都需要至少其中三个节点的投票。这种情况意味着集群只能容忍单个主节点的丢失。如果这个集群被分成相等的两半，那么任何一半都不会包含三个符合主节点资格的节点，并且集群将无法取得任何进展。然而，如果投票配置仅包含四个符合主节点资格的节点中的三个，则集群仍然只能完全容忍一个节点的丢失，但基于仲裁的决策需要来自三个投票节点中的两个的投票。如果平分，一半将包含三个投票节点中的两个，因此一半将保持可用。

## Setting the initial voting configuration 设置初始投票配置

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/voting.asciidoc)

When a brand-new cluster starts up for the first time, it must elect its first master node. To do this election, it needs to know the set of master-eligible nodes whose votes should count. This initial voting configuration is known as the *bootstrap configuration* and is set in the [cluster bootstrapping process](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html).
当一个全新的集群第一次启动时，它必须选举第一个主节点。为了进行这次选举，它需要知道一组符合主资格的节点，这些节点的选票应该算在内。此初始投票配置称为*引导配置*，是在[集群引导过程](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html)中设置的。

It is important that the bootstrap configuration identifies exactly which nodes should vote in the first election. It is not sufficient to configure each node with an expectation of how many nodes there should be in the cluster. It is also important to note that the bootstrap configuration must come from outside the cluster: there is no safe way for the cluster to determine the bootstrap configuration correctly on its own.
引导程序配置准确识别哪些节点应该在第一次选举中投票非常重要。根据集群中应该有多少个节点来配置每个节点是不够的。还需要注意的是，引导配置必须来自集群外部：集群没有安全的方法来自行正确确定引导配置。

If the bootstrap configuration is not set correctly, when you start a brand-new cluster there is a risk that you will accidentally form two separate clusters instead of one. This situation can lead to data loss: you might start using both clusters before you notice that anything has gone wrong and it is impossible to merge them together later.
如果引导配置设置不正确，当您启动一个全新的集群时，您可能会意外地形成两个独立的集群，而不是一个。这种情况可能会导致数据丢失：您可能会在发现出现任何问题之前就开始使用两个集群，并且以后不可能将它们合并在一起。

To illustrate the problem with configuring each node to expect a certain cluster size, imagine starting up a three-node cluster in which each node knows that it is going to be part of a three-node cluster. A majority of three nodes is two, so normally the first two nodes to discover each other form a cluster and the third node joins them a short time later. However, imagine that four nodes were erroneously started instead of three. In this case, there are enough nodes to form two separate clusters. Of course if each node is started manually then it’s unlikely that too many nodes are started. If you’re using an automated orchestrator, however, it’s certainly possible to get into this situation-- particularly if the orchestrator is not resilient to failures such as network partitions.
为了说明将每个节点配置为期望特定集群大小的问题，想象一下启动一个三节点集群，其中每个节点都知道它将成为三节点集群的一部分。三个节点中的大多数为两个，因此通常最先发现彼此的两个节点形成一个集群，第三个节点稍后加入它们。但是，假设错误启动了四个节点而不是三个。在这种情况下，有足够的节点来形成两个独立的集群。当然，如果每个节点都是手动启动的，那么不太可能启动太多节点。然而，如果您使用的是自动编排器，那么肯定有可能会遇到这种情况——特别是如果编排器不能适应网络分区等故障。

The initial quorum is only required the very first time a whole cluster starts up. New nodes joining an established cluster can safely obtain all the information they need from the elected master. Nodes that have previously been part of a cluster will have stored to disk all the information that is required when they restart.
仅在整个集群第一次启动时才需要初始仲裁。加入已建立集群的新节点可以安全地从当选的主节点处获取所需的所有信息。以前属于集群的节点将在磁盘中存储重新启动时所需的所有信息。

# Bootstrapping a cluster 引导集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/bootstrapping.asciidoc)

Starting an Elasticsearch cluster for the very first time requires the initial set of [master-eligible nodes](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node) to be explicitly defined on one or more of the master-eligible nodes in the cluster. This is known as *cluster bootstrapping*. This is only required the first time a cluster starts up. Freshly-started nodes that are joining a running cluster obtain this information from the cluster’s elected master.
第一次启动 Elasticsearch 集群需要在集群中的一个或多个符合主资格的节点上显式定义一组初始[符合主资格的节点](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node)。这称为*集群引导*。仅在集群第一次启动时才需要这样做。加入正在运行的集群的新启动节点从集群选出的主节点获取此信息。

The initial set of master-eligible nodes is defined in the [`cluster.initial_master_nodes` setting](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#initial_master_nodes). This should be set to a list containing one of the following items for each master-eligible node:
初始的符合主节点资格的节点集在[`cluster.initial_master_nodes`设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#initial_master_nodes)中定义。对于每个符合主节点资格的节点，应将其设置为包含以下项目之一的列表：

- The [node name](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#node-name) of the node. 
  节点的[节点名称](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#node-name)。
- The node’s hostname if `node.name` is not set, because `node.name` defaults to the node’s hostname. You must use either the fully-qualified hostname or the bare hostname [depending on your system configuration](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html#modules-discovery-bootstrap-cluster-fqdns). 
  如果未设置`node.name` ，则为节点的主机名，因为`node.name`默认为节点的主机名。您必须使用完全限定主机名或裸主机名[，具体取决于您的系统配置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html#modules-discovery-bootstrap-cluster-fqdns)。
- The IP address of the node’s [transport publish address](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#modules-network-binding-publishing), if it is not possible to use the `node.name` of the node. This is normally the IP address to which [`network.host`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#common-network-settings) resolves but [this can be overridden](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#advanced-network-settings). 
  节点的[传输发布地址](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#modules-network-binding-publishing)的 IP 地址（如果无法使用节点的`node.name` ）。这通常是[`network.host`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#common-network-settings)解析的 IP 地址，但[可以覆盖它](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#advanced-network-settings)。
- The IP address and port of the node’s publish address, in the form `IP:PORT`, if it is not possible to use the `node.name` of the node and there are multiple nodes sharing a single IP address. 
  节点发布地址的 IP 地址和端口，格式为`IP:PORT` ，如果无法使用节点的`node.name`并且有多个节点共享单个 IP 地址。

After the cluster has formed, remove the `cluster.initial_master_nodes` setting from each node’s configuration. It should not be set for master-ineligible nodes, master-eligible nodes joining an existing cluster, or nodes which are restarting.
集群形成后，从每个节点的配置中删除`cluster.initial_master_nodes`设置。不应为不符合主节点资格的节点、加入现有集群的符合主节点资格的节点或正在重新启动的节点设置该值。

If you leave `cluster.initial_master_nodes` in place once the cluster has formed then there is a risk that a future misconfiguration may result in bootstrapping a new cluster alongside your existing cluster. It may not be possible to recover from this situation without losing data.
如果在集群形成后将`cluster.initial_master_nodes`保留在原处，则存在未来配置错误可能导致在现有集群旁边引导新集群的风险。在不丢失数据的情况下，可能无法从这种情况中恢复。

The simplest way to create a new cluster is for you to select one of your master-eligible nodes that will bootstrap itself into a single-node cluster, which all the other nodes will then join. This simple approach is not resilient to failures until the other master-eligible nodes have joined the cluster. For example, if you have a master-eligible node with [node name](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#node-name) `master-a` then configure it as follows (omitting `cluster.initial_master_nodes` from the configuration of all other nodes):
创建新集群的最简单方法是选择一个符合主节点资格的节点，该节点将自身引导到单节点集群中，然后所有其他节点都将加入该集群。在其他符合主节点资格的节点加入集群之前，这种简单的方法无法抵御故障。例如，如果您有一个节点名为 master- `master-a`[节点](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#node-name)资格的节点，则按如下方式配置它（从所有其他节点的配置中省略`cluster.initial_master_nodes` ）：

```yaml
cluster.initial_master_nodes: master-a
```

For fault-tolerant cluster bootstrapping, use all the master-eligible nodes. For instance, if your cluster has 3 master-eligible nodes with [node names](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#node-name) `master-a`, `master-b` and `master-c` then configure them all as follows:
对于容错集群引导，请使用所有符合主节点资格的节点。例如，如果您的集群有 3 个符合 master 资格的节点，[节点名称](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#node-name)为`master-a` 、 `master-b`和`master-c` ，则按如下方式配置它们：

```yaml
cluster.initial_master_nodes:
  - master-a
  - master-b
  - master-c
```

You must set `cluster.initial_master_nodes` to the same list of nodes on each node on which it is set in order to be sure that only a single cluster forms during bootstrapping. If `cluster.initial_master_nodes` varies across the nodes on which it is set then you may bootstrap multiple clusters. It is usually not possible to recover from this situation without losing data.
您必须将`cluster.initial_master_nodes`设置为设置它的每个节点上的相同节点列表，以确保在引导期间仅形成单个集群。如果`cluster.initial_master_nodes`在设置它的节点上有所不同，那么您可以引导多个集群。通常不可能在不丢失数据的情况下从这种情况中恢复。



**Node name formats must match
节点名称格式必须匹配**

The node names used in the `cluster.initial_master_nodes` list must exactly match the `node.name` properties of the nodes. By default the node name is set to the machine’s hostname which may or may not be fully-qualified depending on your system configuration. If each node name is a fully-qualified domain name such as `master-a.example.com` then you must use fully-qualified domain names in the `cluster.initial_master_nodes` list too; conversely if your node names are bare hostnames (without the `.example.com` suffix) then you must use bare hostnames in the `cluster.initial_master_nodes` list. If you use a mix of fully-qualified and bare hostnames, or there is some other mismatch between `node.name` and `cluster.initial_master_nodes`, then the cluster will not form successfully and you will see log messages like the following.
`cluster.initial_master_nodes`列表中使用的节点名称必须与节点的`node.name`属性完全匹配。默认情况下，节点名称设置为计算机的主机名，该主机名可能是完全限定的，也可能不是完全限定的，具体取决于您的系统配置。如果每个节点名称都是完全限定域名，例如`master-a.example.com` ，那么您也必须在`cluster.initial_master_nodes`列表中使用完全限定域名；相反，如果您的节点名称是裸主机名（不带`.example.com`后缀），则必须在`cluster.initial_master_nodes`列表中使用裸主机名。如果您混合使用完全限定主机名和裸主机名，或者`node.name`和`cluster.initial_master_nodes`之间存在其他不匹配，则集群将无法成功形成，并且您将看到如下所示的日志消息。

```text
[master-a.example.com] master not discovered yet, this node has
not previously joined a bootstrapped (v7+) cluster, and this
node must discover master-eligible nodes [master-a, master-b] to
bootstrap a cluster: have discovered [{master-b.example.com}{...
```

This message shows the node names `master-a.example.com` and `master-b.example.com` as well as the `cluster.initial_master_nodes` entries `master-a` and `master-b`, and it is clear from this message that they do not match exactly.
此消息显示节点名称`master-a.example.com`和`master-b.example.com`以及`cluster.initial_master_nodes`条目`master-a`和`master-b` ，从该消息可以清楚地看出它们并不完全匹配。

## Choosing a cluster name 选择集群名称

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/bootstrapping.asciidoc)

The [`cluster.name`](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#cluster-name) setting enables you to create multiple clusters which are separated from each other. Nodes verify that they agree on their cluster name when they first connect to each other, and Elasticsearch will only form a cluster from nodes that all have the same cluster name. The default value for the cluster name is `elasticsearch`, but it is recommended to change this to reflect the logical name of the cluster.
[`cluster.name`](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#cluster-name)设置使您能够创建多个彼此分离的集群。节点首次相互连接时会验证它们是否同意集群名称，Elasticsearch 只会由所有具有相同集群名称的节点形成集群。集群名称的默认值是`elasticsearch` ，但建议更改此值以反映集群的逻辑名称。

## Auto-bootstrapping in development mode 开发模式下自动引导

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/bootstrapping.asciidoc)

By default each node will automatically bootstrap itself into a single-node cluster the first time it starts. If any of the following settings are configured then auto-bootstrapping will not take place:
默认情况下，每个节点在第一次启动时都会自动将自身引导到单节点集群中。如果配置了以下任何设置，则不会发生自动引导：

- `discovery.seed_providers`
- `discovery.seed_hosts`
- `cluster.initial_master_nodes`

To add a new node into an existing cluster, configure `discovery.seed_hosts` or other relevant discovery settings so that the new node can discover the existing master-eligible nodes in the cluster. To bootstrap a new multi-node cluster, configure `cluster.initial_master_nodes` as described in the [section on cluster bootstrapping](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html) as well as `discovery.seed_hosts` or other relevant discovery settings.
要将新节点添加到现有集群中，请配置`discovery.seed_hosts`或其他相关发现设置，以便新节点可以发现集群中现有的符合主节点资格的节点。要引导新的多节点集群，请按照[集群引导部分](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html)中所述配置`cluster.initial_master_nodes`以及`discovery.seed_hosts`或其他相关发现设置。



**Forming a single cluster 形成单一簇**

Once an Elasticsearch node has joined an existing cluster, or bootstrapped a new cluster, it will not join a different cluster. Elasticsearch will not merge separate clusters together after they have formed, even if you subsequently try and configure all the nodes into a single cluster. This is because there is no way to merge these separate clusters together without a risk of data loss. You can tell that you have formed separate clusters by checking the cluster UUID reported by `GET /` on each node.
一旦 Elasticsearch  节点加入现有集群或引导新集群，它就不会加入其他集群。即使您随后尝试将所有节点配置到单个集群中，Elasticsearch  也不会在单独的集群形成后将它们合并在一起。这是因为没有办法将这些单独的集群合并在一起而不存在数据丢失的风险。通过检查每个节点上`GET /`报告的集群 UUID，您可以判断您已经形成了单独的集群。

If you intended to add a node into an existing cluster but instead bootstrapped a separate single-node cluster then you must start again:
如果您打算将节点添加到现有集群中，但却引导了一个单独的单节点集群，那么您必须重新启动：

1. Shut down the node. 关闭节点。
2. Completely wipe the node by deleting the contents of its [data folder](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-path). 
   通过删除[数据文件夹](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-path)的内容来彻底擦除节点。
3. Configure `discovery.seed_hosts` or `discovery.seed_providers` and other relevant discovery settings. Ensure `cluster.initial_master_nodes` is not set on any node. 
   配置`discovery.seed_hosts`或`discovery.seed_providers`以及其他相关的发现设置。确保未在任何节点上设置`cluster.initial_master_nodes` 。
4. Restart the node and verify that it joins the existing cluster rather than forming its own one-node cluster. 
   重新启动节点并验证它是否加入现有集群而不是形成自己的单节点集群。

If you intended to form a new multi-node cluster but instead bootstrapped a collection of single-node clusters then you must start again:
如果您打算形成一个新的多节点集群，但却引导了一组单节点集群，那么您必须重新开始：

1. Shut down all the nodes. 
   关闭所有节点。
2. Completely wipe each node by deleting the contents of their [data folders](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-path). 
   通过删除[数据文件夹](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-path)的内容来彻底擦除每个节点。
3. Configure `cluster.initial_master_nodes` as described above. 
   如上所述配置`cluster.initial_master_nodes` 。
4. Configure `discovery.seed_hosts` or `discovery.seed_providers` and other relevant discovery settings. 
   配置`discovery.seed_hosts`或`discovery.seed_providers`以及其他相关的发现设置。
5. Restart all the nodes and verify that they have formed a single cluster. 
   重新启动所有节点并验证它们是否已形成单个集群。
6. Remove `cluster.initial_master_nodes` from every node’s configuration. 
   从每个节点的配置中删除`cluster.initial_master_nodes` 。

# Publishing the cluster state 发布集群状态

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/publishing.asciidoc)

The elected master node is the only node in a cluster that can make changes to the cluster state. The elected master node processes one batch of cluster state updates at a time, computing the required changes and publishing the updated cluster state to all the other nodes in the cluster. Each publication starts with the elected master broadcasting the updated cluster state to all nodes in the cluster. Each node responds with an acknowledgement but does not yet apply the newly-received state. Once the elected master has collected acknowledgements from enough master-eligible nodes, the new cluster state is said to be *committed* and the master broadcasts another message instructing nodes to apply the now-committed state. Each node receives this message, applies the updated state, and then sends a second acknowledgement back to the master.
选出的主节点是集群中唯一可以更改集群状态的节点。选出的主节点一次处理一批集群状态更新，计算所需的更改并将更新的集群状态发布到集群中的所有其他节点。每次发布都以选定的主节点向集群中的所有节点广播更新的集群状态开始。每个节点都会发出确认响应，但尚未应用新接收到的状态。一旦当选的主节点从足够多的主节点合格节点收集到确认，新的集群状态就被称为已*提交*，并且主节点广播另一条消息，指示节点应用现在已提交的状态。每个节点接收此消息，应用更新后的状态，然后将第二个确认发送回主节点。

The elected master allows a limited amount of time for each cluster state update to be completely published to all nodes. It is defined by the `cluster.publish.timeout` setting, which defaults to `30s`, measured from the time the publication started. If this time is reached before the new cluster state is committed then the cluster state change is rejected and the elected master considers itself to have failed. It stands down and starts trying to elect a new master node.
选出的主节点允许在有限的时间内将每个集群状态更新完全发布到所有节点。它由`cluster.publish.timeout`设置定义，默认为`30s` ，从发布开始的时间开始计算。如果在提交新的集群状态之前达到该时间，则集群状态更改将被拒绝，并且当选的主节点将认为自己已失败。它退出并开始尝试选举新的主节点。

If the new cluster state is committed before `cluster.publish.timeout` has elapsed, the elected master node considers the change to have succeeded. It waits until the timeout has elapsed or until it has received acknowledgements that each node in the cluster has applied the updated state, and then starts processing and publishing the next cluster state update. If some acknowledgements have not been received (i.e. some nodes have not yet confirmed that they have applied the current update), these nodes are said to be *lagging* since their cluster states have fallen behind the elected master’s latest state. The elected master waits for the lagging nodes to catch up for a further time, `cluster.follower_lag.timeout`, which defaults to `90s`. If a node has still not successfully applied the cluster state update within this time then it is considered to have failed and the elected master removes it from the cluster.
如果在`cluster.publish.timeout`过去之前提交新的集群状态，则当选的主节点将认为更改已成功。它会等待，直到超时结束或收到集群中每个节点已应用更新状态的确认，然后开始处理和发布下一个集群状态更新。如果尚未收到某些确认（即某些节点尚未确认它们已应用当前更新），则这些节点被认为是*滞后的*，因为它们的集群状态已落后于所选主节点的最新状态。选出的主节点会等待落后节点再赶上一段时间`cluster.follower_lag.timeout` ，默认为`90s` 。如果一个节点在这段时间内仍未成功应用集群状态更新，则该节点被视为失败，选举出的主节点会将其从集群中删除。

Cluster state updates are typically published as diffs to the previous cluster state, which reduces the time and network bandwidth needed to publish a cluster state update. For example, when updating the mappings for only a subset of the indices in the cluster state, only the updates for those indices need to be published to the nodes in the cluster, as long as those nodes have the previous cluster state. If a node is missing the previous cluster state, for example when rejoining a cluster, the elected master will publish the full cluster state to that node so that it can receive future updates as diffs.
集群状态更新通常作为与先前集群状态的差异发布，这减少了发布集群状态更新所需的时间和网络带宽。例如，当仅更新集群状态中索引子集的映射时，只需将这些索引的更新发布到集群中的节点，只要这些节点具有先前的集群状态即可。如果一个节点缺少以前的集群状态，例如重新加入集群时，当选的主节点会将完整的集群状态发布到该节点，以便它可以接收未来的更新作为差异。

Elasticsearch is a peer to peer based system, in which nodes communicate with one another directly. The high-throughput APIs (index, delete, search) do not normally interact with the elected master node. The responsibility of the elected master node is to maintain the global cluster state which includes reassigning shards when nodes join or leave the cluster. Each time the cluster state is changed, the new state is published to all nodes in the cluster as described above.
Elasticsearch 是一种基于点对点的系统，其中节点直接相互通信。高吞吐量  API（索引、删除、搜索）通常不与选定的主节点交互。当选的主节点的职责是维护全局集群状态，其中包括在节点加入或离开集群时重新分配分片。每次集群状态更改时，新状态都会发布到集群中的所有节点，如上所述。

The performance characteristics of cluster state updates are a function of the speed of the storage on each master-eligible node, as well as the reliability and latency of the network interconnections between all nodes in the cluster. You must therefore ensure that the storage and networking available to the nodes in your cluster are good enough to meet your performance goals.
集群状态更新的性能特征是每个符合主节点资格的节点上的存储速度以及集群中所有节点之间网络互连的可靠性和延迟的函数。因此，您必须确保集群中节点可用的存储和网络足以满足您的性能目标。

# Cluster fault detection 集群故障检测

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/fault-detection.asciidoc)

The elected master periodically checks each of the nodes in the cluster to ensure that they are still connected and healthy. Each node in the cluster also periodically checks the health of the elected master. These checks are known respectively as *follower checks* and *leader checks*.
选出的主节点会定期检查集群中的每个节点，以确保它们仍然保持连接且健康。集群中的每个节点也会定期检查选出的主节点的健康状况。这些检查分别称为*追随者检查*和*领导者检查*。

Elasticsearch allows these checks to occasionally fail or timeout without taking any action. It considers a node to be faulty only after a number of consecutive checks have failed. You can control fault detection behavior with [`cluster.fault_detection.*` settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html).
Elasticsearch 允许这些检查偶尔失败或超时，而不采取任何操作。只有在连续多次检查失败后，才认为节点有故障。您可以使用[`cluster.fault_detection.*`设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html)控制故障检测行为。

If the elected master detects that a node has disconnected, however, this situation is treated as an immediate failure. The master bypasses the timeout and retry setting values and attempts to remove the node from the cluster. Similarly, if a node detects that the elected master has disconnected, this situation is treated as an immediate failure. The node bypasses the timeout and retry settings and restarts its discovery phase to try and find or elect a new master.
然而，如果当选的主节点检测到某个节点已断开连接，则这种情况将被视为立即故障。主节点绕过超时和重试设置值并尝试从集群中删除节点。类似地，如果节点检测到选出的主节点已断开连接，则这种情况将被视为立即故障。节点绕过超时和重试设置并重新启动其发现阶段以尝试查找或选举新的主节点。

Additionally, each node periodically verifies that its data path is healthy by writing a small file to disk and then deleting it again. If a node discovers its data path is unhealthy then it is removed from the cluster until the data path recovers. You can control this behavior with the [`monitor.fs.health` settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html).
此外，每个节点通过将小文件写入磁盘然后再次删除来定期验证其数据路径是否正常。如果节点发现其数据路径不健康，则会将其从集群中删除，直到数据路径恢复。您可以使用[`monitor.fs.health`设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html)来控制此行为。

The elected master node will also remove nodes from the cluster if nodes are unable to apply an updated cluster state within a reasonable time. The timeout defaults to 2 minutes starting from the beginning of the cluster state update. Refer to [Publishing the cluster state](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-state-publishing.html) for a more detailed description.
如果节点无法在合理的时间内应用更新的集群状态，则当选的主节点还将从集群中删除节点。超时默认为 2 分钟，从集群状态更新开始算起。有关更详细的说明，请参阅[发布集群状态](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-state-publishing.html)。

## Troubleshooting an unstable cluster 对不稳定集群进行故障排除

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/fault-detection.asciidoc)

Normally, a node will only leave a cluster if deliberately shut down. If a node leaves the cluster unexpectedly, it’s important to address the cause. A cluster in which nodes leave unexpectedly is unstable and can create several issues. For instance:
通常，节点只有在故意关闭的情况下才会离开集群。如果节点意外离开集群，解决原因很重要。节点意外离开的集群是不稳定的，可能会产生一些问题。例如：

- The cluster health may be yellow or red. 
  集群运行状况可能是黄色或红色。
- Some shards will be initializing and other shards may be failing. 
  一些分片将正在初始化，而其他分片可能会失败。
- Search, indexing, and monitoring operations may fail and report exceptions in logs. 
  搜索、索引和监视操作可能会失败并在日志中报告异常。
- The `.security` index may be unavailable, blocking access to the cluster. 
  `.security`索引可能不可用，从而阻止对集群的访问。
- The master may appear busy due to frequent cluster state updates. 
  由于频繁的集群状态更新，主节点可能会显得很忙。

To troubleshoot a cluster in this state, first ensure the cluster has a [stable master](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-troubleshooting.html). Next, focus on the nodes unexpectedly leaving the cluster ahead of all other issues. It will not be possible to solve other issues until the cluster has a stable master node and stable node membership.
要对这种状态下的集群进行故障排除，首先要确保集群有一个[稳定的 master](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-troubleshooting.html) 。接下来，先关注意外离开集群的节点，然后再关注所有其他问题。在集群拥有稳定的主节点和稳定的节点成员资格之前，无法解决其他问题。

Diagnostics and statistics are usually not useful in an unstable cluster. These tools only offer a view of the state of the cluster at a single point in time. Instead, look at the cluster logs to see the pattern of behaviour over time. Focus particularly on logs from the elected master. When a node leaves the cluster, logs for the elected master include a message like this (with line breaks added to make it easier to read):
诊断和统计数据通常在不稳定的集群中没有用处。这些工具仅提供单个时间点集群状态的视图。相反，请查看集群日志以了解一段时间内的行为模式。特别关注来自当选主机的日志。当节点离开集群时，所选主节点的日志将包含如下消息（添加换行符以使其更易于阅读）：

```text
[2022-03-21T11:02:35,513][INFO ][o.e.c.c.NodeLeftExecutor] [instance-0000000000]
    node-left: [{instance-0000000004}{bfcMDTiDRkietFb9v_di7w}{aNlyORLASam1ammv2DzYXA}{172.27.47.21}{172.27.47.21:19054}{m}]
    with reason [disconnected]
```

This message says that the `NodeLeftExecutor` on the elected master (`instance-0000000000`) processed a `node-left` task, identifying the node that was removed and the reason for its removal. When the node joins the cluster again, logs for the elected master will include a message like this (with line breaks added to make it easier to read):
此消息表示所选主节点 ( `instance-0000000000` ) 上的`NodeLeftExecutor`处理了`node-left`任务，识别了已删除的节点及其删除原因。当节点再次加入集群时，所选主节点的日志将包含如下消息（添加换行符以使其更易于阅读）：

```text
[2022-03-21T11:02:59,892][INFO ][o.e.c.c.NodeJoinExecutor] [instance-0000000000]
    node-join: [{instance-0000000004}{bfcMDTiDRkietFb9v_di7w}{UNw_RuazQCSBskWZV8ID_w}{172.27.47.21}{172.27.47.21:19054}{m}]
    with reason [joining after restart, removed [24s] ago with reason [disconnected]]
```

This message says that the `NodeJoinExecutor` on the elected master (`instance-0000000000`) processed a `node-join` task, identifying the node that was added to the cluster and the reason for the task.
此消息表示所选主节点 ( `instance-0000000000` ) 上的`NodeJoinExecutor`处理了`node-join`任务，识别了添加到集群的节点以及执行该任务的原因。

Other nodes may log similar messages, but report fewer details:
其他节点可能会记录类似的消息，但报告的详细信息较少：

```text
[2020-01-29T11:02:36,985][INFO ][o.e.c.s.ClusterApplierService]
    [instance-0000000001] removed {
        {instance-0000000004}{bfcMDTiDRkietFb9v_di7w}{aNlyORLASam1ammv2DzYXA}{172.27.47.21}{172.27.47.21:19054}{m}
        {tiebreaker-0000000003}{UNw_RuazQCSBskWZV8ID_w}{bltyVOQ-RNu20OQfTHSLtA}{172.27.161.154}{172.27.161.154:19251}{mv}
    }, term: 14, version: 1653415, reason: Publication{term=14, version=1653415}
```

These messages are not especially useful for troubleshooting, so focus on the ones from the `NodeLeftExecutor` and `NodeJoinExecutor` which are only emitted on the elected master and which contain more details. If you don’t see the messages from the `NodeLeftExecutor` and `NodeJoinExecutor`, check that:
这些消息对于故障排除并不是特别有用，因此请重点关注来自`NodeLeftExecutor`和`NodeJoinExecutor`的消息，它们仅在选定的 master 上发出，并且包含更多详细信息。如果您没有看到来自`NodeLeftExecutor`和`NodeJoinExecutor`的消息，请检查：

- You’re looking at the logs for the elected master node. 
  您正在查看所选主节点的日志。
- The logs cover the correct time period. 
  日志涵盖正确的时间段。
- Logging is enabled at `INFO` level. 
  日志记录在`INFO`级别启用。

Nodes will also log a message containing `master node changed` whenever they start or stop following the elected master. You can use these messages to determine each node’s view of the state of the master over time.
每当节点启动或停止跟随选定的主节点时，它们也会记录一条包含`master node changed`消息。您可以使用这些消息来确定每个节点对主节点随时间的状态的看法。

If a node restarts, it will leave the cluster and then join the cluster again. When it rejoins, the `NodeJoinExecutor` will log that it processed a `node-join` task indicating that the node is `joining after restart`. If a node is unexpectedly restarting, look at the node’s logs to see why it is shutting down.
如果节点重新启动，它将离开集群，然后再次加入集群。当它重新加入时， `NodeJoinExecutor`将记录它处理了一个`node-join`任务，表明该节点`joining after restart` 。如果节点意外重新启动，请查看该节点的日志以了解其关闭的原因。

The [Health](https://www.elastic.co/guide/en/elasticsearch/reference/current/health-api.html) API on the affected node will also provide some useful information about the situation.
受影响节点上的[Health](https://www.elastic.co/guide/en/elasticsearch/reference/current/health-api.html) API 还将提供一些有关情况的有用信息。

If the node did not restart then you should look at the reason for its departure more closely. Each reason has different troubleshooting steps, described below. There are three possible reasons:
如果节点没有重新启动，那么您应该更仔细地查看其退出的原因。每个原因都有不同的故障排除步骤，如下所述。可能的原因有以下三个：

- `disconnected`: The connection from the master node to the removed node was closed. 
  `disconnected` ：从主节点到被删除节点的连接已关闭。
- `lagging`: The master published a cluster state update, but the removed node did not apply it within the permitted timeout. By default, this timeout is 2 minutes. Refer to [Discovery and cluster formation settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html) for information about the settings which control this mechanism. 
  `lagging` ：主节点发布了集群状态更新，但被删除的节点没有在允许的超时时间内应用它。默认情况下，此超时时间为 2 分钟。有关控制此机制的设置的信息，请参阅[发现和集群形成设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html)。
- `followers check retry count exceeded`: The master sent a number of consecutive health checks to the removed node. These checks were rejected or timed out. By default, each health check times out after 10 seconds and Elasticsearch removes the node removed after three consecutively failed health checks. Refer to [Discovery and cluster formation settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html) for information about the settings which control this mechanism. 
   `followers check retry count exceeded` ：master 向被移除的节点发送了多次连续的健康检查。这些检查被拒绝或超时。默认情况下，每次健康检查会在 10 秒后超时，Elasticsearch 会删除连续 3 次健康检查失败后删除的节点。有关控制此机制的设置的信息，请参阅[发现和集群形成设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html)。

### Diagnosing `disconnected` nodes 诊断`disconnected`节点

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/fault-detection.asciidoc)

Nodes typically leave the cluster with reason `disconnected` when they shut down, but if they rejoin the cluster without restarting then there is some other problem.
节点通常在关闭时会因故`disconnected`离开集群，但如果它们在不重新启动的情况下重新加入集群，则会出现其他问题。

Elasticsearch is designed to run on a fairly reliable network. It opens a number of TCP connections between nodes and expects these connections to remain open [forever](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections). If a connection is closed then Elasticsearch will try and reconnect, so the occasional blip may fail some in-flight operations but should otherwise have limited impact on the cluster. In contrast, repeatedly-dropped connections will severely affect its operation.
Elasticsearch 被设计为在相当可靠的网络上运行。它在节点之间打开许多 TCP 连接，并期望这些连接[永远](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections)保持打开状态。如果连接关闭，Elasticsearch 将尝试重新连接，因此偶尔的故障可能会导致某些正在进行的操作失败，但对集群的影响应该有限。相反，反复断开连接将严重影响其运行。

The connections from the elected master node to every other node in the cluster are particularly important. The elected master never spontaneously closes its outbound connections to other nodes. Similarly, once an inbound connection is fully established, a node never spontaneously it unless the node is shutting down.
从当选的主节点到集群中每个其他节点的连接尤其重要。当选的主节点永远不会自发地关闭其与其他节点的出站连接。类似地，一旦入站连接完全建立，节点就不会自发地建立连接，除非该节点正在关闭。

If you see a node unexpectedly leave the cluster with the `disconnected` reason, something other than Elasticsearch likely caused the connection to close. A common cause is a misconfigured firewall with an improper timeout or another policy that’s [incompatible with Elasticsearch](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections). It could also be caused by general connectivity issues, such as packet loss due to faulty hardware or network congestion. If you’re an advanced user, configure the following loggers to get more detailed information about network exceptions:
如果您发现某个节点由于`disconnected`原因而意外离开集群，则可能是 Elasticsearch 以外的原因导致连接关闭。常见原因是防火墙配置错误、超时不当或其他[与 Elasticsearch 不兼容](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections)的策略。它还可能是由一般连接问题引起的，例如由于硬件故障或网络拥塞导致的数据包丢失。如果您是高级用户，请配置以下记录器以获取有关网络异常的更多详细信息：

```yaml
logger.org.elasticsearch.transport.TcpTransport: DEBUG
logger.org.elasticsearch.xpack.core.security.transport.netty4.SecurityNetty4Transport: DEBUG
```

If these logs do not show enough information to diagnose the problem, obtain a packet capture simultaneously from the nodes at both ends of an unstable connection and analyse it alongside the Elasticsearch logs from those nodes to determine if traffic between the nodes is being disrupted by another device on the network.
如果这些日志没有显示足够的信息来诊断问题，请同时从不稳定连接两端的节点获取数据包捕获，并将其与来自这些节点的 Elasticsearch 日志一起分析，以确定节点之间的流量是否被另一个节点中断。网络上的设备。

### Diagnosing `lagging` nodes 诊断`lagging`节点

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/fault-detection.asciidoc)

Elasticsearch needs every node to process cluster state updates reasonably quickly. If a node takes too long to process a cluster state update, it can be harmful to the cluster. The master will remove these nodes with the `lagging` reason. Refer to [Discovery and cluster formation settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html) for information about the settings which control this mechanism.
Elasticsearch 需要每个节点都能相当快速地处理集群状态更新。如果节点处理集群状态更新的时间过长，可能会对集群造成损害。 Master会删除这些`lagging`原因的节点。有关控制此机制的设置的信息，请参阅[发现和集群形成设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html)。

Lagging is typically caused by performance issues on the removed node. However, a node may also lag due to severe network delays. To rule out network delays, ensure that `net.ipv4.tcp_retries2` is [configured properly](https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config-tcpretries.html). Log messages that contain `warn threshold` may provide more information about the root cause.
滞后通常是由已删除节点上的性能问题引起的。然而，节点也可能由于严重的网络延迟而滞后。要排除网络延迟，请确保[正确配置](https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config-tcpretries.html)`net.ipv4.tcp_retries2` 。包含`warn threshold`的日志消息可能会提供有关根本原因的更多信息。

If you’re an advanced user, you can get more detailed information about what the node was doing when it was removed by configuring the following logger:
如果您是高级用户，您可以通过配置以下记录器来获取有关节点被删除时正在执行的操作的更多详细信息：

```yaml
logger.org.elasticsearch.cluster.coordination.LagDetector: DEBUG
```

When this logger is enabled, Elasticsearch will attempt to run the [Nodes hot threads](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-hot-threads.html) API on the faulty node and report the results in the logs on the elected master. The results are compressed, encoded, and split into chunks to avoid truncation:
启用此记录器后，Elasticsearch 将尝试在故障节点上运行[节点热线程](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-hot-threads.html)API，并在所选主节点的日志中报告结果。结果被压缩、编码并分成块以避免截断：

```text
[DEBUG][o.e.c.c.LagDetector      ] [master] hot threads from node [{node}{g3cCUaMDQJmQ2ZLtjr-3dg}{10.0.0.1:9300}] lagging at version [183619] despite commit of cluster state version [183620] [part 1]: H4sIAAAAAAAA/x...
[DEBUG][o.e.c.c.LagDetector      ] [master] hot threads from node [{node}{g3cCUaMDQJmQ2ZLtjr-3dg}{10.0.0.1:9300}] lagging at version [183619] despite commit of cluster state version [183620] [part 2]: p7x3w1hmOQVtuV...
[DEBUG][o.e.c.c.LagDetector      ] [master] hot threads from node [{node}{g3cCUaMDQJmQ2ZLtjr-3dg}{10.0.0.1:9300}] lagging at version [183619] despite commit of cluster state version [183620] [part 3]: v7uTboMGDbyOy+...
[DEBUG][o.e.c.c.LagDetector      ] [master] hot threads from node [{node}{g3cCUaMDQJmQ2ZLtjr-3dg}{10.0.0.1:9300}] lagging at version [183619] despite commit of cluster state version [183620] [part 4]: 4tse0RnPnLeDNN...
[DEBUG][o.e.c.c.LagDetector      ] [master] hot threads from node [{node}{g3cCUaMDQJmQ2ZLtjr-3dg}{10.0.0.1:9300}] lagging at version [183619] despite commit of cluster state version [183620] (gzip compressed, base64-encoded, and split into 4 parts on preceding log lines)
```

To reconstruct the output, base64-decode the data and decompress it using `gzip`. For instance, on Unix-like systems:
要重建输出，请对数据进行 base64 解码并使用`gzip`对其进行解压缩。例如，在类 Unix 系统上：

```sh
cat lagdetector.log | sed -e 's/.*://' | base64 --decode | gzip --decompress
```

### Diagnosing `follower check retry count exceeded` nodes 诊断 `follower check retry count exceeded` 节点

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/fault-detection.asciidoc)

Nodes sometimes leave the cluster with reason `follower check retry count exceeded` when they shut down, but if they rejoin the cluster without restarting then there is some other problem.
节点有时会因故离开集群 `follower check retry count exceeded` 当它们关闭时，但如果它们重新加入集群而不重新启动，则会出现其他问题。

Elasticsearch needs every node to respond to network messages successfully and reasonably quickly. If a node rejects requests or does not respond at all then it can be harmful to the cluster. If enough consecutive checks fail then the master will remove the node with reason `follower check retry count exceeded` and will indicate in the `node-left` message how many of the consecutive unsuccessful checks failed and how many of them timed out. Refer to [Discovery and cluster formation settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html) for information about the settings which control this mechanism.
Elasticsearch 需要每个节点都能成功且相当快速地响应网络消息。如果节点拒绝请求或根本不响应，则可能对集群有害。如果足够多的连续检查失败，那么主节点将有理由删除该节点 `follower check retry count exceeded` 并将在`node-left`消息中指示有多少连续不成功的检查失败以及其中有多少超时。有关控制此机制的设置的信息，请参阅[发现和集群形成设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html)。

Timeouts and failures may be due to network delays or performance problems on the affected nodes. Ensure that `net.ipv4.tcp_retries2` is [configured properly](https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config-tcpretries.html) to eliminate network delays as a possible cause for this kind of instability. Log messages containing `warn threshold` may give further clues about the cause of the instability.
超时和故障可能是由于受影响节点上的网络延迟或性能问题造成的。确保[正确配置](https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config-tcpretries.html)`net.ipv4.tcp_retries2` ，以消除网络延迟这一可能导致此类不稳定的原因。包含`warn threshold`的日志消息可能会提供有关不稳定原因的进一步线索。

If the last check failed with an exception then the exception is reported, and typically indicates the problem that needs to be addressed. If any of the checks timed out then narrow down the problem as follows.
如果最后一次检查因异常而失败，则会报告该异常，并且通常指示需要解决的问题。如果任何检查超时，则按如下方式缩小问题范围。

- GC pauses are recorded in the GC logs that Elasticsearch emits by default, and also usually by the `JvmMonitorService` in the main node logs. Use these logs to confirm whether or not the node is experiencing high heap usage with long GC pauses. If so, [the troubleshooting guide for high heap usage](https://www.elastic.co/guide/en/elasticsearch/reference/current/high-jvm-memory-pressure.html) has some suggestions for further investigation but typically you will need to capture a heap dump and the [garbage collector logs](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#gc-logging) during a time of high heap usage to fully understand the problem. 
  GC 暂停记录在 Elasticsearch 默认发出的 GC 日志中，通常也由`JvmMonitorService`记录在主节点日志中。使用这些日志来确认节点是否遇到高堆使用率和长时间 GC 暂停的情况。如果是这样，[高堆使用率的故障排除指南](https://www.elastic.co/guide/en/elasticsearch/reference/current/high-jvm-memory-pressure.html)提供了一些进一步调查的建议，但通常您需要在高堆使用率期间捕获堆转储和[垃圾收集器日志](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#gc-logging)，以充分了解问题。

- VM pauses also affect other processes on the same host. A VM pause also typically causes a discontinuity in the system clock, which Elasticsearch will report in its logs. If you see evidence of other processes pausing at the same time, or unexpected clock discontinuities, investigate the infrastructure on which you are running Elasticsearch. 
  VM 暂停还会影响同一主机上的其他进程。 VM 暂停通常还会导致系统时钟不连续，Elasticsearch 会在其日志中报告这一情况。如果您发现其他进程同时暂停的证据，或意外的时钟中断，请调查运行 Elasticsearch 的基础设施。

- Packet captures will reveal system-level and network-level faults, especially if you capture the network traffic simultaneously at the elected master and the faulty node and analyse it alongside the Elasticsearch logs from those nodes. The connection used for follower checks is not used for any other traffic so it can be easily identified from the flow pattern alone, even if TLS is in use: almost exactly every second there will be a few hundred bytes sent each way, first the request by the master and then the response by the follower. You should be able to observe any retransmissions, packet loss, or other delays on such a connection. 
  数据包捕获将揭示系统级和网络级故障，特别是如果您在选定的主节点和故障节点上同时捕获网络流量，并将其与来自这些节点的 Elasticsearch 日志一起分析。用于追随者检查的连接不用于任何其他流量，因此即使使用  TLS，也可以仅从流模式轻松识别它：几乎每秒都会有数百个字节发送到各个方向，首先是请求由主人，然后由追随者响应。您应该能够观察到此类连接上的任何重传、数据包丢失或其他延迟。

- Long waits for particular threads to be available can be identified by taking stack dumps of the main Elasticsearch process (for example, using `jstack`) or a profiling trace (for example, using Java Flight Recorder) in the few seconds leading up to the relevant log message.
  可以通过在导致相关日志的几秒钟内获取主 Elasticsearch 进程的堆栈转储（例如，使用`jstack` ）或分析跟踪（例如，使用 Java Flight Recorder）来识别特定线程可用的长时间等待信息。

  The [Nodes hot threads](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-hot-threads.html) API sometimes yields useful information, but bear in mind that this API also requires a number of `transport_worker` and `generic` threads across all the nodes in the cluster. The API may be affected by the very problem you’re trying to diagnose. `jstack` is much more reliable since it doesn’t require any JVM threads.
  [节点热线程](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-hot-threads.html)API 有时会产生有用的信息，但请记住，此 API 还需要集群中所有节点上的大量`transport_worker`和`generic`线程。 API 可能会受到您尝试诊断的问题的影响。 `jstack`更加可靠，因为它不需要任何 JVM 线程。

  The threads involved in discovery and cluster membership are mainly `transport_worker` and `cluster_coordination` threads, for which there should never be a long wait. There may also be evidence of long waits for threads in the Elasticsearch logs, particularly looking at warning logs from `org.elasticsearch.transport.InboundHandler`. See [Networking threading model](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#modules-network-threading-model) for more information.
  涉及发现和集群成员资格的线程主要是`transport_worker`和`cluster_coordination`线程，永远不应该等待很长时间。 Elasticsearch 日志中也可能有证据表明线程等待时间较长，特别是查看以下警告日志： `org.elasticsearch.transport.InboundHandler` 。有关详细信息，请参阅[网络线程模型](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#modules-network-threading-model)。

By default the follower checks will time out after 30s, so if node departures are unpredictable then capture stack dumps every 15s to be sure that at least one stack dump was taken at the right time.
默认情况下，跟随者检查将在 30 秒后超时，因此如果节点离开不可预测，则每 15 秒捕获一次堆栈转储，以确保在正确的时间至少进行一次堆栈转储。

### Diagnosing `ShardLockObtainFailedException` failures 诊断 `ShardLockObtainFailedException` 失败

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/fault-detection.asciidoc)

If a node leaves and rejoins the cluster then Elasticsearch will usually shut down and re-initialize its shards. If the shards do not shut down quickly enough then Elasticsearch may fail to re-initialize them due to a `ShardLockObtainFailedException`.
如果节点离开并重新加入集群，Elasticsearch 通常会关闭并重新初始化其分片。如果分片关闭得不够快，那么 Elasticsearch 可能会由于以下原因而无法重新初始化它们： `ShardLockObtainFailedException` 。

To gather more information about the reason for shards shutting down slowly, configure the following logger:
要收集有关分片缓慢关闭原因的更多信息，请配置以下记录器：

```yaml
logger.org.elasticsearch.env.NodeEnvironment: DEBUG
```

When this logger is enabled, Elasticsearch will attempt to run the [Nodes hot threads](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-hot-threads.html) API whenever it encounters a `ShardLockObtainFailedException`. The results are compressed, encoded, and split into chunks to avoid truncation:
启用此记录器后，Elasticsearch 每当遇到节点热线程 API 时都会尝试运行[节点热线程](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-hot-threads.html)API。 `ShardLockObtainFailedException` 。结果被压缩、编码并分成块以避免截断：

```text
[DEBUG][o.e.e.NodeEnvironment    ] [master] hot threads while failing to obtain shard lock for [index][0] [part 1]: H4sIAAAAAAAA/x...
[DEBUG][o.e.e.NodeEnvironment    ] [master] hot threads while failing to obtain shard lock for [index][0] [part 2]: p7x3w1hmOQVtuV...
[DEBUG][o.e.e.NodeEnvironment    ] [master] hot threads while failing to obtain shard lock for [index][0] [part 3]: v7uTboMGDbyOy+...
[DEBUG][o.e.e.NodeEnvironment    ] [master] hot threads while failing to obtain shard lock for [index][0] [part 4]: 4tse0RnPnLeDNN...
[DEBUG][o.e.e.NodeEnvironment    ] [master] hot threads while failing to obtain shard lock for [index][0] (gzip compressed, base64-encoded, and split into 4 parts on preceding log lines)
```

To reconstruct the output, base64-decode the data and decompress it using `gzip`. For instance, on Unix-like systems:
要重建输出，请对数据进行 base64 解码并使用`gzip`对其进行解压缩。例如，在类 Unix 系统上：

```sh
cat shardlock.log | sed -e 's/.*://' | base64 --decode | gzip --decompress
```

### Diagnosing other network disconnections 诊断其他网络断开连接

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/discovery/fault-detection.asciidoc)

Elasticsearch is designed to run on a fairly reliable network. It opens a number of TCP connections between nodes and expects these connections to remain open [forever](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections). If a connection is closed then Elasticsearch will try and reconnect, so the occasional blip may fail some in-flight operations but should otherwise have limited impact on the cluster. In contrast, repeatedly-dropped connections will severely affect its operation.
Elasticsearch 被设计为在相当可靠的网络上运行。它在节点之间打开许多 TCP 连接，并期望这些连接[永远](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections)保持打开状态。如果连接关闭，Elasticsearch 将尝试重新连接，因此偶尔的故障可能会导致某些正在进行的操作失败，但对集群的影响应该有限。相反，反复断开连接将严重影响其运行。

Elasticsearch nodes will only actively close an outbound connection to another node if the other node leaves the cluster. See [Troubleshooting an unstable cluster](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-fault-detection.html#cluster-fault-detection-troubleshooting) for further information about identifying and troubleshooting this situation. If an outbound connection closes for some other reason, nodes will log a message such as the following:
仅当另一个节点离开集群时，Elasticsearch 节点才会主动关闭与另一个节点的出站连接。有关识别这种情况并对其进行故障排除的更多信息，请参阅[对不稳定的集群进行故障排除](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-fault-detection.html#cluster-fault-detection-troubleshooting)。如果出站连接由于某种其他原因关闭，节点将记录如下消息：

```text
[INFO ][o.e.t.ClusterConnectionManager] [node-1] transport connection to [{node-2}{g3cCUaMDQJmQ2ZLtjr-3dg}{10.0.0.1:9300}] closed by remote
```

Similarly, once an inbound connection is fully established, a node never spontaneously closes it unless the node is shutting down.
类似地，一旦入站连接完全建立，节点就不会自发地关闭它，除非该节点正在关闭。

Therefore if you see a node report that a connection to another node closed unexpectedly, something other than Elasticsearch likely caused the connection to close. A common cause is a misconfigured firewall with an improper timeout or another policy that’s [incompatible with Elasticsearch](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections). It could also be caused by general connectivity issues, such as packet loss due to faulty hardware or network congestion. If you’re an advanced user, configure the following loggers to get more detailed information about network exceptions:
因此，如果您看到节点报告与另一个节点的连接意外关闭，则可能是 Elasticsearch 之外的其他原因导致连接关闭。常见原因是防火墙配置错误、超时不当或其他[与 Elasticsearch 不兼容](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections)的策略。它还可能是由一般连接问题引起的，例如由于硬件故障或网络拥塞导致的数据包丢失。如果您是高级用户，请配置以下记录器以获取有关网络异常的更多详细信息：

```yaml
logger.org.elasticsearch.transport.TcpTransport: DEBUG
logger.org.elasticsearch.xpack.core.security.transport.netty4.SecurityNetty4Transport: DEBUG
```

If these logs do not show enough information to diagnose the problem, obtain a packet capture simultaneously from the nodes at both ends of an unstable connection and analyse it alongside the Elasticsearch logs from those nodes to determine if traffic between the nodes is being disrupted by another device on the network.
如果这些日志没有显示足够的信息来诊断问题，请同时从不稳定连接两端的节点获取数据包捕获，并将其与来自这些节点的 Elasticsearch 日志一起分析，以确定节点之间的流量是否被另一个节点中断。网络上的设备。

# Add and remove nodes in your cluster 添加和删除集群中的节点

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/setup/add-nodes.asciidoc)

When you start an instance of Elasticsearch, you are starting a *node*. An Elasticsearch *cluster* is a group of nodes that have the same `cluster.name` attribute. As nodes join or leave a cluster, the cluster automatically reorganizes itself to evenly distribute the data across the available nodes.
当您启动 Elasticsearch 实例时，您正在启动一个*节点*。 Elasticsearch*集群*是一组具有相同`cluster.name`属性的节点。当节点加入或离开集群时，集群会自动重新组织自身，以将数据均匀地分布在可用节点上。

If you are running a single instance of Elasticsearch, you have a cluster of one node. All primary shards reside on the single node. No replica shards can be allocated, therefore the cluster state remains yellow. The cluster is fully functional but is at risk of data loss in the event of a failure.
如果您运行的是 Elasticsearch 的单个实例，则您拥有一个只有一个节点的集群。所有主分片都驻留在单个节点上。无法分配副本分片，因此集群状态保持黄色。集群功能齐全，但在发生故障时存在数据丢失的风险。

![A cluster with one node and three primary shards](../../../Image/e/elas_0202.png)

You add nodes to a cluster to increase its capacity and reliability. By default, a node is both a data node and eligible to be elected as the master node that controls the cluster. You can also configure a new node for a specific purpose, such as handling ingest requests. For more information, see [Nodes](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html).
您可以向集群添加节点以提高其容量和可靠性。默认情况下，节点既是数据节点，又有资格被选举为控制集群的主节点。您还可以为特定目的配置新节点，例如处理摄取请求。有关详细信息，请参阅[节点](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html)。

When you add more nodes to a cluster, it automatically allocates replica shards. When all primary and replica shards are active, the cluster state changes to green.
当您向集群添加更多节点时，它会自动分配副本分片。当所有主分片和副本分片都处于活动状态时，集群状态将变为绿色。

![A cluster with three nodes](../../../Image/e/elas_0204.png)

## Enroll nodes in an existing cluster 在现有集群中注册节点

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/setup/add-nodes.asciidoc)

You can enroll additional nodes on your local machine to experiment with how an Elasticsearch cluster with multiple nodes behaves.
您可以在本地计算机上注册其他节点来试验具有多个节点的 Elasticsearch 集群的行为方式。

To add a node to a cluster running on multiple machines, you must also set [`discovery.seed_hosts`](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#unicast.hosts) so that the new node can discover the rest of its cluster.
要将节点添加到在多台计算机上运行的集群中，还必须设置[`discovery.seed_hosts`](https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#unicast.hosts) ，以便新节点可以发现其集群的其余部分。

When Elasticsearch starts for the first time, the security auto-configuration process binds the HTTP layer to `0.0.0.0`, but only binds the transport layer to localhost. This intended behavior ensures that you can start a single-node cluster with security enabled by default without any additional configuration.
当 Elasticsearch 第一次启动时，安全自动配置过程会将 HTTP 层绑定到`0.0.0.0` ，但仅将传输层绑定到 localhost 。此预期行为可确保您无需任何其他配置即可启动默认启用安全性的单节点集群。

Before enrolling a new node, additional actions such as binding to an address other than `localhost` or satisfying bootstrap checks are typically necessary in production clusters. During that time, an auto-generated enrollment token could expire, which is why enrollment tokens aren’t generated automatically.
在注册新节点之前，在生产集群中通常需要执行其他操作，例如绑定到`localhost`以外的地址或满足引导检查。在此期间，自动生成的注册令牌可能会过期，这就是注册令牌不会自动生成的原因。

Additionally, only nodes on the same host can join the cluster without additional configuration. If you want nodes from another host to join your cluster, you need to set `transport.host` to a [supported value](https://www.elastic.co/guide/en/elasticsearch/reference/8.15/modules-network.html#network-interface-values) (such as uncommenting the suggested value of `0.0.0.0`), or an IP address that’s bound to an interface where other hosts can reach it. Refer to [transport settings](https://www.elastic.co/guide/en/elasticsearch/reference/8.15/modules-network.html#transport-settings) for more information.
此外，只有同一主机上的节点才能加入集群，无需额外配置。如果您希望其他主机的节点加入您的集群，则需要将`transport.host`设置为[受支持的值](https://www.elastic.co/guide/en/elasticsearch/reference/8.15/modules-network.html#network-interface-values)（例如取消注释建议值`0.0.0.0` ），或者绑定到其他主机可以访问的接口的 IP 地址它。有关详细信息，请参阅[传输设置](https://www.elastic.co/guide/en/elasticsearch/reference/8.15/modules-network.html#transport-settings)。

To enroll new nodes in your cluster, create an enrollment token with the `elasticsearch-create-enrollment-token` tool on any existing node in your cluster. You can then start a new node with the `--enrollment-token` parameter so that it joins an existing cluster.
要在集群中注册新节点，请使用以下命令创建注册令牌 `elasticsearch-create-enrollment-token` 集群中任何现有节点上的工具。然后，您可以使用`--enrollment-token`参数启动一个新节点，以便它加入现有集群。

1. In a separate terminal from where Elasticsearch is running, navigate to the directory where you installed Elasticsearch and run the [`elasticsearch-create-enrollment-token`](https://www.elastic.co/guide/en/elasticsearch/reference/current/create-enrollment-token.html) tool to generate an enrollment token for your new nodes.
   在运行 Elasticsearch 的单独终端中，导航到安装 Elasticsearch 的目录并运行为新节点生成注册令牌的工具。

   ```sh
   bin\elasticsearch-create-enrollment-token -s node
   ```

   Copy the enrollment token, which you’ll use to enroll new nodes with your Elasticsearch cluster.
   复制注册令牌，您将使用该令牌向 Elasticsearch 集群注册新节点。

2. From the installation directory of your new node, start Elasticsearch and pass the enrollment token with the `--enrollment-token` parameter.
   从新节点的安装目录中，启动 Elasticsearch 并使用`--enrollment-token`参数传递注册令牌。

   ```sh
   bin\elasticsearch --enrollment-token <enrollment-token>
   ```

   Elasticsearch automatically generates certificates and keys in the following directory:
   Elasticsearch 自动在以下目录中生成证书和密钥：

   ```sh
   config\certs
   ```

3. Repeat the previous step for any new nodes that you want to enroll. 
   对要注册的任何新节点重复上一步。

For more information about discovery and shard allocation, refer to [*Discovery and cluster formation*](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery.html) and [Cluster-level shard allocation and routing settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html).
有关发现和分片分配的更多信息，请参阅[*发现和集群形成*](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery.html)和[集群级分片分配和路由设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html)。

## Master-eligible nodes 主节点资格

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/setup/add-nodes.asciidoc)

As nodes are added or removed Elasticsearch maintains an optimal level of fault tolerance by automatically updating the cluster’s *voting configuration*, which is the set of [master-eligible nodes](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node) whose responses are counted when making decisions such as electing a new master or committing a new cluster state.
当添加或删除节点时，Elasticsearch 通过自动更新集群的*投票配置*来保持最佳的容错级别，投票配置是一组[符合主节点资格的节点](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node)，在做出选举新主节点或提交新集群状态等决策时会计算这些节点的响应。

It is recommended to have a small and fixed number of master-eligible nodes in a cluster, and to scale the cluster up and down by adding and removing master-ineligible nodes only. However there are situations in which it may be desirable to add or remove some master-eligible nodes to or from a cluster.
建议在集群中拥有少量且固定数量的符合主资格的节点，并仅通过添加和删除不符合主资格的节点来扩展和缩小集群。然而，在某些情况下，可能需要向集群添加或删除一些符合主节点资格的节点。

### Adding master-eligible nodes 添加符合主节点资格的节点

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/setup/add-nodes.asciidoc)

If you wish to add some nodes to your cluster, simply configure the new nodes to find the existing cluster and start them up. Elasticsearch adds the new nodes to the voting configuration if it is appropriate to do so.
如果您想向集群添加一些节点，只需配置新节点即可找到现有集群并启动它们。如果合适，Elasticsearch 会将新节点添加到投票配置中。

During master election or when joining an existing formed cluster, a node sends a join request to the master in order to be officially added to the cluster.
在 Master 选举期间或加入现有集群时，节点会向 Master 发送加入请求，以便正式添加到集群中。

### Removing master-eligible nodes 删除符合主资格的节点

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/setup/add-nodes.asciidoc)

When removing master-eligible nodes, it is important not to remove too many all at the same time. For instance, if there are currently seven master-eligible nodes and you wish to reduce this to three, it is not possible simply to stop four of the nodes at once: to do so would leave only three nodes remaining, which is less than half of the voting configuration, which means the cluster cannot take any further actions.
删除符合主节点资格的节点时，重要的是不要同时删除太多节点。例如，如果当前有七个符合主节点资格的节点，而您希望将其减少到三个，则不可能简单地立即停止其中四个节点：这样做只会留下三个节点，不到一半投票配置的状态，这意味着集群无法采取任何进一步的操作。

More precisely, if you shut down half or more of the master-eligible nodes all at the same time then the cluster will normally become unavailable. If this happens then you can bring the cluster back online by starting the removed nodes again.
更准确地说，如果您同时关闭一半或更多符合主节点资格的节点，那么集群通常将变得不可用。如果发生这种情况，您可以通过再次启动已删除的节点来使集群重新联机。

As long as there are at least three master-eligible nodes in the cluster, as a general rule it is best to remove nodes one-at-a-time, allowing enough time for the cluster to [automatically adjust](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-quorums.html) the voting configuration and adapt the fault tolerance level to the new set of nodes.
只要集群中至少有三个符合主节点资格的节点，作为一般规则，最好一次删除一个节点，以便集群有足够的时间[自动调整](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-quorums.html)投票配置并适应故障对新节点集的容忍级别。

If there are only two master-eligible nodes remaining then neither node can be safely removed since both are required to reliably make progress. To remove one of these nodes you must first inform Elasticsearch that it should not be part of the voting configuration, and that the voting power should instead be given to the other node. You can then take the excluded node offline without preventing the other node from making progress. A node which is added to a voting configuration exclusion list still works normally, but Elasticsearch tries to remove it from the voting configuration so its vote is no longer required. Importantly, Elasticsearch will never automatically move a node on the voting exclusions list back into the voting configuration. Once an excluded node has been successfully auto-reconfigured out of the voting configuration, it is safe to shut it down without affecting the cluster’s master-level availability. A node can be added to the voting configuration exclusion list using the [Voting configuration exclusions](https://www.elastic.co/guide/en/elasticsearch/reference/current/voting-config-exclusions.html) API. For example:
如果只剩下两个符合主节点资格的节点，则两个节点都不能被安全删除，因为两个节点都需要可靠地取得进展。要删除其中一个节点，您必须首先通知 Elasticsearch  它不应该成为投票配置的一部分，并且投票权应该给予另一个节点。然后，您可以使排除的节点脱机，而不会阻止其他节点取得进展。添加到投票配置排除列表中的节点仍然可以正常工作，但 Elasticsearch 会尝试将其从投票配置中删除，以便不再需要其投票。重要的是，Elasticsearch  永远不会自动将投票排除列表上的节点移回到投票配置中。一旦排除的节点成功地从投票配置中自动重新配置，就可以安全地将其关闭，而不会影响集群的主级可用性。可以使用投票[配置排除](https://www.elastic.co/guide/en/elasticsearch/reference/current/voting-config-exclusions.html)API 将节点添加到投票配置排除列表中。例如：



```console
# Add node to voting configuration exclusions list and wait for the system
# to auto-reconfigure the node out of the voting configuration up to the
# default timeout of 30 seconds
POST /_cluster/voting_config_exclusions?node_names=node_name

# Add node to voting configuration exclusions list and wait for
# auto-reconfiguration up to one minute
POST /_cluster/voting_config_exclusions?node_names=node_name&timeout=1m
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/35.console) 

The nodes that should be added to the exclusions list are specified by name using the `?node_names` query parameter, or by their persistent node IDs using the `?node_ids` query parameter. If a call to the voting configuration exclusions API fails, you can safely retry it. Only a successful response guarantees that the node has actually been removed from the voting configuration and will not be reinstated. If the elected master node is excluded from the voting configuration then it will abdicate to another master-eligible node that is still in the voting configuration if such a node is available.
应添加到排除列表的节点是使用`?node_names`查询参数按名称指定的，或者使用`?node_ids`查询参数按其持久节点 ID 指定的。如果对投票配置排除 API  的调用失败，您可以安全地重试。只有成功的响应才能保证节点实际上已从投票配置中删除并且不会恢复。如果当选的主节点被排除在投票配置之外，那么它将让位于仍在投票配置中的另一个符合主资格的节点（如果这样的节点可用）。

Although the voting configuration exclusions API is most useful for down-scaling a two-node to a one-node cluster, it is also possible to use it to remove multiple master-eligible nodes all at the same time. Adding multiple nodes to the exclusions list has the system try to auto-reconfigure all of these nodes out of the voting configuration, allowing them to be safely shut down while keeping the cluster available. In the example described above, shrinking a seven-master-node cluster down to only have three master nodes, you could add four nodes to the exclusions list, wait for confirmation, and then shut them down simultaneously.
尽管投票配置排除 API  对于将两节点集群缩减为单节点集群最有用，但也可以使用它同时删除多个符合主节点资格的节点。将多个节点添加到排除列表中后，系统会尝试自动重新配置投票配置之外的所有节点，从而允许它们安全关闭，同时保持集群可用。在上述示例中，将七个主节点集群缩小为只有三个主节点，您可以将四个节点添加到排除列表中，等待确认，然后同时关闭它们。

Voting exclusions are only required when removing at least half of the master-eligible nodes from a cluster in a short time period. They are not required when removing master-ineligible nodes, nor are they required when removing fewer than half of the master-eligible nodes.
仅当在短时间内从集群中删除至少一半符合主节点资格的节点时，才需要进行投票排除。当删除不符合主节点资格的节点时不需要它们，当删除少于一半的符合主节点资格的节点时也不需要它们。

Adding an exclusion for a node creates an entry for that node in the voting configuration exclusions list, which has the system automatically try to reconfigure the voting configuration to remove that node and prevents it from returning to the voting configuration once it has removed. The current list of exclusions is stored in the cluster state and can be inspected as follows:
添加节点排除项会在投票配置排除列表中创建该节点的条目，系统会自动尝试重新配置投票配置以删除该节点，并防止其在删除后返回到投票配置。当前的排除列表存储在集群状态中，可以按如下方式检查：



```console
GET /_cluster/state?filter_path=metadata.cluster_coordination.voting_config_exclusions
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/36.console) 

This list is limited in size by the `cluster.max_voting_config_exclusions` setting, which defaults to `10`. See [Discovery and cluster formation settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html). Since voting configuration exclusions are persistent and limited in number, they must be cleaned up. Normally an exclusion is added when performing some maintenance on the cluster, and the exclusions should be cleaned up when the maintenance is complete. Clusters should have no voting configuration exclusions in normal operation.
此列表的大小受到以下限制： `cluster.max_voting_config_exclusions` 设置，默认为`10` 。请参阅[发现和集群形成设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html)。由于投票配置排除是持久的且数量有限，因此必须清理它们。通常在对集群进行某些维护时会添加排除项，并且在维护完成后应清除排除项。在正常操作中，集群不应有投票配置排除。

If a node is excluded from the voting configuration because it is to be shut down permanently, its exclusion can be removed after it is shut down and removed from the cluster. Exclusions can also be cleared if they were created in error or were only required temporarily by specifying `?wait_for_removal=false`.
如果某个节点因要永久关闭而被排除在投票配置之外，则可以在关闭该节点并将其从集群中删除后将其排除。如果排除项是错误创建的或仅通过指定`?wait_for_removal=false`暂时需要，则也可以清除它们。



```console
# Wait for all the nodes with voting configuration exclusions to be removed from
# the cluster and then remove all the exclusions, allowing any node to return to
# the voting configuration in the future.
DELETE /_cluster/voting_config_exclusions

# Immediately remove all the voting configuration exclusions, allowing any node
# to return to the voting configuration in the future.
DELETE /_cluster/voting_config_exclusions?wait_for_removal=false
```

# Full-cluster restart and rolling restart 全集群重启和滚动重启

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/setup/restart-cluster.asciidoc)

There may be [situations where you want to perform a full-cluster restart](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup.html) or a rolling restart. In the case of [full-cluster restart](https://www.elastic.co/guide/en/elasticsearch/reference/current/restart-cluster.html#restart-cluster-full), you shut down and restart all the nodes in the cluster while in the case of [rolling restart](https://www.elastic.co/guide/en/elasticsearch/reference/current/restart-cluster.html#restart-cluster-rolling), you shut down only one node at a time, so the service remains uninterrupted.
在[某些情况下，您可能想要执行整个集群重新启动](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup.html)或滚动重新启动。在[全集群重启](https://www.elastic.co/guide/en/elasticsearch/reference/current/restart-cluster.html#restart-cluster-full)的情况下，您关闭并重新启动集群中的所有节点，而在[滚动重启](https://www.elastic.co/guide/en/elasticsearch/reference/current/restart-cluster.html#restart-cluster-rolling)的情况下，您一次仅关闭一个节点，因此服务保持不间断。

Nodes exceeding the low watermark threshold will be slow to restart. Reduce the disk usage below the [low watermark](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html#cluster-routing-watermark-low) before restarting nodes.
超过低水位阈值的节点重启速度会很慢。在重新启动节点之前将磁盘使用率降低到[低水位线](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html#cluster-routing-watermark-low)以下。

## Full-cluster restart 全集群重启

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/setup/restart-cluster.asciidoc)

1. **Disable shard allocation.
   禁用分片分配。**

   When you shut down a data node, the allocation process waits for `index.unassigned.node_left.delayed_timeout` (by default, one minute) before starting to replicate the shards on that node to other nodes in the cluster, which can involve a lot of I/O. Since the node is shortly going to be restarted, this I/O is unnecessary. You can avoid racing the clock by [disabling allocation](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html#cluster-routing-allocation-enable) of replicas before shutting down [data nodes](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-node):
   当您关闭数据节点时，分配过程会等待 `index.unassigned.node_left.delayed_timeout` （默认情况下，一分钟），然后开始将该节点上的分片复制到集群中的其他节点，这可能涉及大量 I/O。由于节点很快就会重新启动，因此不需要此 I/O。您可以通过在关闭[数据节点](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-node)之前[禁用副本分配](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html#cluster-routing-allocation-enable)来避免争分夺秒：

   

   ```console
   PUT _cluster/settings
   {
     "persistent": {
       "cluster.routing.allocation.enable": "primaries"
     }
   }
   ```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/38.console) 

You can also consider [gateway settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-gateway.html) when restarting large clusters to reduce initial strain while nodes are processing [through discovery](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery.html).
您还可以在重新启动大型集群时考虑[网关设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-gateway.html)，以减少节点[通过发现](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery.html)进行处理时的初始压力。

**Stop indexing and perform a flush.
停止索引并执行刷新。**

Performing a [flush](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-flush.html) speeds up shard recovery.
执行[刷新](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-flush.html)可以加快分片恢复速度。



```console
POST /_flush
```

1. Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/39.console) 

1. **Temporarily stop the tasks associated with active machine learning jobs and datafeeds.** (Optional)
   **暂时停止与活动机器学习作业和数据源相关的任务。** （选修的）

   Machine learning features require specific [subscriptions](https://www.elastic.co/subscriptions).
   机器学习功能需要特定的[订阅](https://www.elastic.co/subscriptions)。

   You have two options to handle machine learning jobs and datafeeds when you shut down a cluster:
   关闭集群时，您有两种选择来处理机器学习作业和数据源：

   - Temporarily halt the tasks associated with your machine learning jobs and datafeeds and prevent new jobs from opening by using the [set upgrade mode API](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-set-upgrade-mode.html):
     使用[设置升级模式 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-set-upgrade-mode.html)暂时停止与机器学习作业和数据源相关的任务，并防止打开新作业：

     

     ```console
     POST _ml/set_upgrade_mode?enabled=true
     ```

- Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/40.console) 

  When you disable upgrade mode, the jobs resume using the last model state that was automatically saved. This option avoids the overhead of managing active jobs during the shutdown and is faster than explicitly stopping datafeeds and closing jobs.
  当您禁用升级模式时，作业将使用自动保存的最后一个模型状态恢复。此选项避免了在关闭期间管理活动作业的开销，并且比显式停止数据馈送和关闭作业更快。

- [Stop all datafeeds and close all jobs](https://www.elastic.co/guide/en/machine-learning/8.15/stopping-ml.html). This option saves the model state at the time of closure. When you reopen the jobs after the cluster restart, they use the exact same model. However, saving the latest model state takes longer than using upgrade mode, especially if you have a lot of jobs or jobs with large model states. 
  [停止所有数据馈送并关闭所有作业](https://www.elastic.co/guide/en/machine-learning/8.15/stopping-ml.html)。此选项保存关闭时的模型状态。当您在集群重新启动后重新打开作业时，它们将使用完全相同的模型。但是，保存最新模型状态比使用升级模式需要更长的时间，特别是当您有很多作业或具有大型模型状态的作业时。

**Shut down all nodes. 关闭所有节点。**

- If you are running Elasticsearch with `systemd`:
  如果您使用`systemd`运行 Elasticsearch：

  ```sh
  sudo systemctl stop elasticsearch.service
  ```

- If you are running Elasticsearch with SysV `init`:
  如果您使用 SysV `init`运行 Elasticsearch：

  ```sh
  sudo -i service elasticsearch stop
  ```

- If you are running Elasticsearch as a daemon:
  如果您将 Elasticsearch 作为守护进程运行：

  ```sh
  kill $(cat pid)
  ```

**Perform any needed changes.
执行任何需要的更改。**

**Restart nodes. 重新启动节点。**

If you have dedicated master nodes, start them first and wait for them to form a cluster and elect a master before proceeding with your data nodes. You can check progress by looking at the logs.
如果您有专用的主节点，请先启动它们并等待它们形成集群并选举主节点，然后再继续处理数据节点。您可以通过查看日志来检查进度。

As soon as enough master-eligible nodes have discovered each other, they form a cluster and elect a master. At that point, you can use the [cat health](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-health.html) and [cat nodes](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-nodes.html) APIs to monitor nodes joining the cluster:
一旦足够多的符合主节点资格的节点相互发现，它们就会形成一个集群并选举一个主节点。此时，您可以使用[cat health](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-health.html)和[cat Nodes](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-nodes.html) API 来监控加入集群的节点：



```console
GET _cat/health

GET _cat/nodes
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/41.console) 

The `status` column returned by `_cat/health` shows the health of each node in the cluster: `red`, `yellow`, or `green`.
`_cat/health`返回的`status`列显示集群中每个节点的运行状况： `red` 、 `yellow`或`green` 。

**Wait for all nodes to join the cluster and report a status of yellow.
等待所有节点加入集群并报告黄色状态。**

When a node joins the cluster, it begins to recover any primary shards that are stored locally. The [`_cat/health`](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-health.html) API initially reports a `status` of `red`, indicating that not all primary shards have been allocated.
当节点加入集群时，它开始恢复本地存储的所有主分片。 [`_cat/health`](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-health.html) API 最初报告`status`为`red` ，表示并非所有主分片都已分配。

Once a node recovers its local shards, the cluster `status` switches to `yellow`, indicating that all primary shards have been recovered, but not all replica shards are allocated. This is to be expected because you have not yet re-enabled allocation. Delaying the allocation of replicas until all nodes are `yellow` allows the master to allocate replicas to nodes that already have local shard copies.
一旦节点恢复其本地分片，集群`status`将变为`yellow` ，表示所有主分片已恢复，但尚未分配所有副本分片。这是可以预料的，因为您尚未重新启用分配。延迟副本的分配，直到所有节点都变成`yellow`允许主节点将副本分配给已经拥有本地分片副本的节点。

**Re-enable allocation. 重新启用分配。**

When all nodes have joined the cluster and recovered their primary shards, re-enable allocation by restoring `cluster.routing.allocation.enable` to its default:
当所有节点都加入集群并恢复其主分片时，通过恢复来重新启用分配 `cluster.routing.allocation.enable` 为其默认值：



```console
PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": null
  }
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/42.console) 

Once allocation is re-enabled, the cluster starts allocating replica shards to the data nodes. At this point it is safe to resume indexing and searching, but your cluster will recover more quickly if you can wait until all primary and replica shards have been successfully allocated and the status of all nodes is `green`.
重新启用分配后，集群开始将副本分片分配给数据节点。此时可以安全地恢复索引和搜索，但是如果您可以等到所有主分片和副本分片已成功分配并且所有节点的状态均为`green` ，您的集群将恢复得更快。

You can monitor progress with the [`_cat/health`](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-health.html) and [`_cat/recovery`](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-recovery.html) APIs:
您可以使用[`_cat/health`](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-health.html)和[`_cat/recovery`](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-recovery.html) API 监控进度：



```console
GET _cat/health

GET _cat/recovery
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/43.console) 

**Restart machine learning jobs.** (Optional)
**重新启动机器学习作业。** （选修的）

If you temporarily halted the tasks associated with your machine learning jobs, use the [set upgrade mode API](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-set-upgrade-mode.html) to return them to active states:
如果您暂时停止与机器学习作业关联的任务，请使用[设置升级模式 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-set-upgrade-mode.html)将它们返回到活动状态：



```console
POST _ml/set_upgrade_mode?enabled=false
```

1. Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/44.console) 

   If you closed all machine learning jobs before stopping the nodes, open the jobs and start the datafeeds from Kibana or with the [open jobs](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-open-job.html) and [start datafeed](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-start-datafeed.html) APIs.
   如果您在停止节点之前关闭了所有机器学习作业，请打开作业并从 Kibana 启动数据馈送，或者使用[打开的作业](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-open-job.html)并[启动数据馈送](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-start-datafeed.html)API。

## Rolling restart 滚动重启

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/setup/restart-cluster.asciidoc)

1. **Disable shard allocation.
   禁用分片分配。**

   When you shut down a data node, the allocation process waits for `index.unassigned.node_left.delayed_timeout` (by default, one minute) before starting to replicate the shards on that node to other nodes in the cluster, which can involve a lot of I/O. Since the node is shortly going to be restarted, this I/O is unnecessary. You can avoid racing the clock by [disabling allocation](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html#cluster-routing-allocation-enable) of replicas before shutting down [data nodes](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-node):
   当您关闭数据节点时，分配过程会等待 `index.unassigned.node_left.delayed_timeout` （默认情况下，一分钟），然后开始将该节点上的分片复制到集群中的其他节点，这可能涉及大量 I/O。由于节点很快就会重新启动，因此不需要此 I/O。您可以通过在关闭[数据节点](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-node)之前[禁用副本分配](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html#cluster-routing-allocation-enable)来避免争分夺秒：

   

   ```console
   PUT _cluster/settings
   {
     "persistent": {
       "cluster.routing.allocation.enable": "primaries"
     }
   }
   ```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/45.console) 

You can also consider [gateway settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-gateway.html) when restarting large clusters to reduce initial strain while nodes are processing [through discovery](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery.html).
您还可以在重新启动大型集群时考虑[网关设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-gateway.html)，以减少节点[通过发现](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery.html)进行处理时的初始压力。

**Stop non-essential indexing and perform a flush.** (Optional)
**停止不必要的索引并执行刷新。** （选修的）

While you can continue indexing during the rolling restart, shard recovery can be faster if you temporarily stop non-essential indexing and perform a [flush](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-flush.html).
虽然您可以在滚动重启期间继续建立索引，但如果您暂时停止非必要的索引并执行[刷新](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-flush.html)，分片恢复会更快。



```console
POST /_flush
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/46.console) 

**Temporarily stop the tasks associated with active machine learning jobs and datafeeds.** (Optional)
**暂时停止与活动机器学习作业和数据源相关的任务。** （选修的）

Machine learning features require specific [subscriptions](https://www.elastic.co/subscriptions).
机器学习功能需要特定的[订阅](https://www.elastic.co/subscriptions)。

You have two options to handle machine learning jobs and datafeeds when you shut down a cluster:
关闭集群时，您有两种选择来处理机器学习作业和数据源：

- Temporarily halt the tasks associated with your machine learning jobs and datafeeds and prevent new jobs from opening by using the [set upgrade mode API](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-set-upgrade-mode.html):
  使用[设置升级模式 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-set-upgrade-mode.html)暂时停止与机器学习作业和数据源相关的任务，并防止打开新作业：

  

  ```console
  POST _ml/set_upgrade_mode?enabled=true
  ```

- Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/47.console) 

  When you disable upgrade mode, the jobs resume using the last model state that was automatically saved. This option avoids the overhead of managing active jobs during the shutdown and is faster than explicitly stopping datafeeds and closing jobs.
  当您禁用升级模式时，作业将使用自动保存的最后一个模型状态恢复。此选项避免了在关闭期间管理活动作业的开销，并且比显式停止数据馈送和关闭作业更快。

- [Stop all datafeeds and close all jobs](https://www.elastic.co/guide/en/machine-learning/8.15/stopping-ml.html). This option saves the model state at the time of closure. When you reopen the jobs after the cluster restart, they use the exact same model. However, saving the latest model state takes longer than using upgrade mode, especially if you have a lot of jobs or jobs with large model states. 
  [停止所有数据馈送并关闭所有作业](https://www.elastic.co/guide/en/machine-learning/8.15/stopping-ml.html)。此选项保存关闭时的模型状态。当您在集群重新启动后重新打开作业时，它们将使用完全相同的模型。但是，保存最新模型状态比使用升级模式需要更长的时间，特别是当您有很多作业或具有大型模型状态的作业时。

- If you perform a rolling restart, you can also leave your machine learning jobs running. When you shut down a machine learning node, its jobs automatically move to another node and restore the model states. This option enables your jobs to continue running during the shutdown but it puts increased load on the cluster. 
  如果执行滚动重启，您还可以让机器学习作业保持运行。当您关闭机器学习节点时，其作业会自动移动到另一个节点并恢复模型状态。此选项使您的作业能够在关闭期间继续运行，但会增加集群的负载。

**Shut down a single node in case of rolling restart.
在滚动重启时关闭单个节点。**

- If you are running Elasticsearch with `systemd`:
  如果您使用`systemd`运行 Elasticsearch：

  ```sh
  sudo systemctl stop elasticsearch.service
  ```

- If you are running Elasticsearch with SysV `init`:
  如果您使用 SysV `init`运行 Elasticsearch：

  ```sh
  sudo -i service elasticsearch stop
  ```

- If you are running Elasticsearch as a daemon:
  如果您将 Elasticsearch 作为守护进程运行：

  ```sh
  kill $(cat pid)
  ```

**Perform any needed changes.
执行任何需要的更改。**

**Restart the node you changed.
重新启动您更改的节点。**

Start the node and confirm that it joins the cluster by checking the log file or by submitting a `_cat/nodes` request:
启动节点并通过检查日志文件或提交`_cat/nodes`请求确认其加入集群：



```console
GET _cat/nodes
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/48.console) 

**Reenable shard allocation.
重新启用分片分配。**

For data nodes, once the node has joined the cluster, remove the `cluster.routing.allocation.enable` setting to enable shard allocation and start using the node:
对于数据节点，一旦该节点加入集群，请删除该节点 `cluster.routing.allocation.enable` 设置启用分片分配并开始使用节点：



```console
PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": null
  }
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/49.console) 

**Repeat in case of rolling restart.
如果滚动重启，请重复此操作。**

When the node has recovered and the cluster is stable, repeat these steps for each node that needs to be changed.
当节点恢复且集群稳定后，对每个需要更改的节点重复这些步骤。

**Restart machine learning jobs.** (Optional)
**重新启动机器学习作业。** （选修的）

If you temporarily halted the tasks associated with your machine learning jobs, use the [set upgrade mode API](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-set-upgrade-mode.html) to return them to active states:
如果您暂时停止与机器学习作业关联的任务，请使用[设置升级模式 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-set-upgrade-mode.html)将它们返回到活动状态：



```console
POST _ml/set_upgrade_mode?enabled=false
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/50.console) 

If you closed all machine learning jobs before stopping the nodes, open the jobs and start the datafeeds from Kibana or with the [open jobs](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-open-job.html) and [start datafeed](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-start-datafeed.html) APIs.
如果您在停止节点之前关闭了所有机器学习作业，请打开作业并从 Kibana 启动数据馈送，或者使用[打开的作业](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-open-job.html)并[启动数据馈送](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-start-datafeed.html)API。

# Remote clusters 远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/remote-clusters.asciidoc)

You can connect a local cluster to other Elasticsearch clusters, known as *remote clusters*. Remote clusters can be located in different datacenters or geographic regions, and contain indices or data streams that can be replicated with cross-cluster replication or searched by a local cluster using cross-cluster search.
您可以将本地集群连接到其他 Elasticsearch 集群，称为*远程集群*。远程集群可以位于不同的数据中心或地理区域，并包含可以通过跨集群复制进行复制或由本地集群使用跨集群搜索进行搜索的索引或数据流。

## Cross-cluster replication 跨集群复制

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/remote-clusters.asciidoc)

With [cross-cluster replication](https://www.elastic.co/guide/en/elasticsearch/reference/current/xpack-ccr.html), you ingest data to an index on a remote cluster. This *leader* index is replicated to one or more read-only *follower* indices on your local cluster. Creating a multi-cluster architecture with cross-cluster replication enables you to configure disaster recovery, bring data closer to your users, or establish a centralized reporting cluster to process reports locally.
通过[跨集群复制](https://www.elastic.co/guide/en/elasticsearch/reference/current/xpack-ccr.html)，您可以将数据提取到远程集群上的索引。该*领导者*索引将被复制到本地集群上的一个或多个只读*追随者*索引。创建具有跨集群复制的多集群架构使您能够配置灾难恢复，使数据更接近用户，或建立集中式报告集群以在本地处理报告。

## Cross-cluster search 跨集群搜索

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/remote-clusters.asciidoc)

[Cross-cluster search](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html) enables you to run a search request against one or more remote clusters. This capability provides each region with a global view of all clusters, allowing you to send a search request from a local cluster and return results from all connected remote clusters. For full cross-cluster search capabilities, the local and remote cluster must be on the same [subscription level](https://www.elastic.co/subscriptions).
[跨集群搜索](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html)使您能够针对一个或多个远程集群运行搜索请求。此功能为每个区域提供所有集群的全局视图，允许您从本地集群发送搜索请求并从所有连接的远程集群返回结果。为了获得完整的跨集群搜索功能，本地和远程集群必须处于相同的[订阅级别](https://www.elastic.co/subscriptions)。

## Add remote clusters 添加远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/remote-clusters.asciidoc)

The instructions that follow describe how to create a remote connection from a self-managed cluster. You can also set up cross-cluster search and cross-cluster replication from an [Elasticsearch Service deployment](https://www.elastic.co/guide/en/cloud/current/ec-enable-ccs.html) or from an [Elastic Cloud Enterprise deployment](https://www.elastic.co/guide/en/cloud-enterprise/current/ece-enable-ccs.html).
以下说明描述了如何从自我管理的集群创建远程连接。您还可以从[Elasticsearch Service 部署](https://www.elastic.co/guide/en/cloud/current/ec-enable-ccs.html)或[Elastic Cloud Enterprise 部署](https://www.elastic.co/guide/en/cloud-enterprise/current/ece-enable-ccs.html)设置跨集群搜索和跨集群复制。

To add remote clusters, you can choose between [two security models](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#remote-clusters-security-models) and [two connection modes](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-proxy-modes). Both security models are compatible with either of the connection modes.
要添加远程集群，您可以在[两种安全模型](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#remote-clusters-security-models)和[两种连接模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-proxy-modes)之间进行选择。两种安全模型都与任一连接模式兼容。

### Security models 安全模型

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/remote-clusters.asciidoc)

- API key based security model  基于API密钥的安全模型

  For clusters on version 8.14 or later, you can use an API key to authenticate and authorize cross-cluster operations to a remote cluster. This model offers administrators of both the local and the remote cluster fine-grained access controls. [Add remote clusters using API key authentication](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html).  对于 8.14 或更高版本的集群，您可以使用 API 密钥对远程集群进行跨集群操作的身份验证和授权。该模型为本地和远程集群的管理员提供细粒度的访问控制。[使用 API 密钥身份验证添加远程集群](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html)。

- Certificate based security model  基于证书的安全模型

  Uses mutual TLS authentication for cross-cluster operations. User authentication is performed on the local cluster and a user’s role names are passed to the remote cluster. In this model, a superuser on the local cluster gains total read access to the remote cluster, so it is only suitable for clusters that are in the same security domain. [Add remote clusters using TLS certificate authentication](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-cert.html).  使用相互 TLS 身份验证进行跨集群操作。用户身份验证在本地集群上执行，并将用户的角色名称传递到远程集群。在此模型中，本地集群上的超级用户获得对远程集群的完全读取访问权限，因此它仅适用于位于同一安全域中的集群。[使用 TLS 证书身份验证添加远程集群](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-cert.html)。

### Connection modes 连接方式

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/remote-clusters.asciidoc)



- Sniff mode 嗅探模式

  In sniff mode, a cluster alias is registered with a name of your choosing and a list of addresses of *seed* nodes specified with the `cluster.remote.<cluster_alias>.seeds` setting. When you register a remote cluster using sniff mode, Elasticsearch retrieves from one of the seed nodes the addresses of up to three *gateway nodes*. Each `remote_cluster_client` node in the local Elasticsearch cluster then opens several TCP connections to the publish addresses of the gateway nodes. This mode therefore requires that the gateway nodes' publish addresses are accessible to nodes in the local cluster.  在嗅探模式下，集群别名将使用您选择的名称以及使用指定的*种子*节点地址列表进行注册。 `cluster.remote.<cluster_alias>.seeds` 环境。当您使用嗅探模式注册远程集群时，Elasticsearch 从种子节点之一检索最多三个*网关节点*的地址。然后，本地 Elasticsearch 集群中的每个`remote_cluster_client`节点都会打开多个与网关节点的发布地址的 TCP 连接。因此，该模式要求本地集群中的节点能够访问网关节点的发布地址。 Sniff mode is the default connection mode. See [Sniff mode remote cluster settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-settings.html#remote-cluster-sniff-settings) for more information about configuring sniff mode. 嗅探模式是默认的连接模式。有关配置嗅探模式的更多信息，请参阅[嗅探模式远程集群设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-settings.html#remote-cluster-sniff-settings)。 The *gateway nodes* selection depends on the following criteria: *网关节点的*选择取决于以下标准：  **version**: Remote nodes must be compatible with the cluster they are registered to.  **version** ：远程节点必须与其注册到的集群兼容。 **role**: By default, any non-[master-eligible](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node) node can act as a gateway node. Dedicated master nodes are never selected as gateway nodes.  **role** ：默认情况下，任何非[主](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node)节点都可以充当网关节点。专用主节点永远不会被选为网关节点。 **attributes**: You can define the gateway nodes for a cluster by setting [`cluster.remote.node.attr.gateway`](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-settings.html#cluster-remote-node-attr) to `true`. However, such nodes still have to satisfy the two above requirements.  **attribute** ：您可以通过设置来定义集群的网关节点为`true` 。但此类节点仍需满足上述两个要求。



- Proxy mode 代理模式

  In proxy mode, a cluster alias is registered with a name of your choosing and the address of a TCP (layer 4) reverse proxy specified with the `cluster.remote.<cluster_alias>.proxy_address` setting. You must configure this proxy to route connections to one or more nodes of the remote cluster. When you register a remote cluster using proxy mode, Elasticsearch opens several TCP connections to the proxy address and uses these connections to communicate with the remote cluster. In proxy mode Elasticsearch disregards the publish addresses of the remote cluster nodes which means that the publish addresses of the remote cluster nodes need not be accessible to the local cluster.  在代理模式下，集群别名是使用您选择的名称以及使用指定的 TCP（第 4 层）反向代理的地址进行注册的。 `cluster.remote.<cluster_alias>.proxy_address` 环境。您必须配置此代理以将连接路由到远程集群的一个或多个节点。当您使用代理模式注册远程集群时，Elasticsearch  会打开多个到代理地址的 TCP 连接，并使用这些连接与远程集群进行通信。在代理模式下，Elasticsearch  忽略远程集群节点的发布地址，这意味着本地集群不需要访问远程集群节点的发布地址。 Proxy mode is not the default connection mode, so you must set `cluster.remote.<cluster_alias>.mode: proxy` to use it. See [Proxy mode remote cluster settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-settings.html#remote-cluster-proxy-settings) for more information about configuring proxy mode. 代理模式不是默认的连接模式，因此您必须设置 `cluster.remote.<cluster_alias>.mode: proxy` 使用它。有关配置代理模式的更多信息，请参阅[代理模式远程集群设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-settings.html#remote-cluster-proxy-settings)。 Proxy mode has the same [version compatibility requirements](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#gateway-nodes-selection) as sniff mode. 代理模式与嗅探模式具有相同的[版本兼容性要求](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#gateway-nodes-selection)。

# Add remote clusters using API key authentication 使用 API 密钥身份验证添加远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-api-key.asciidoc)

API key authentication enables a local cluster to authenticate itself with a remote cluster via a [cross-cluster API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html). The API key needs to be created by an administrator of the remote cluster. The local cluster is configured to provide this API key on each request to the remote cluster. The remote cluster verifies the API key and grants access, based on the API key’s privileges.
API 密钥身份验证使本地集群能够通过[跨集群 API 密钥](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html)向远程集群进行自身身份验证。 API 密钥需要由远程集群的管理员创建。本地集群配置为在每次向远程集群发出请求时提供此 API 密钥。远程集群验证 API 密钥并根据 API 密钥的权限授予访问权限。

All cross-cluster requests from the local cluster are bound by the API key’s privileges, regardless of local users associated with the requests. For example, if the API key only allows read access to `my-index` on the remote cluster, even a superuser from the local cluster is limited by this constraint. This mechanism enables the remote cluster’s administrator to have full control over who can access what data with cross-cluster search and/or cross-cluster replication. The remote cluster’s administrator can be confident that no access is possible beyond what is explicitly assigned to the API key.
来自本地集群的所有跨集群请求都受 API 密钥权限的约束，无论与请求关联的本地用户如何。例如，如果 API 密钥仅允许对远程集群上的`my-index`进行读取访问，则即使来自本地集群的超级用户也会受到此约束的限制。这种机制使远程集群的管理员能够通过跨集群搜索和/或跨集群复制来完全控制谁可以访问哪些数据。远程集群的管理员可以确信，除了显式分配给 API 密钥的访问之外，不可能进行任何访问。

On the local cluster side, not every local user needs to access every piece of data allowed by the API key. An administrator of the local cluster can further configure additional permission constraints on local users so each user only gets access to the necessary remote data. Note it is only possible to further reduce the permissions allowed by the API key for individual local users. It is impossible to increase the permissions to go beyond what is allowed by the API key.
在本地集群端，并不是每个本地用户都需要访问 API key  允许的每一条数据。本地集群的管理员可以进一步对本地用户配置额外的权限限制，以便每个用户只能访问必要的远程数据。请注意，只能进一步减少单个本地用户的 API 密钥允许的权限。不可能将权限增加到超出 API 密钥允许的范围。

In this model, cross-cluster operations use [a dedicated server port](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote_cluster.port) (remote cluster interface) for communication between clusters. A remote cluster must enable this port for local clusters to connect. Configure Transport Layer Security (TLS) for this port to maximize security (as explained in [Establish trust with a remote cluster](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html#remote-clusters-security-api-key)).
在此模型中，跨集群操作使用[专用服务器端口](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote_cluster.port)（远程集群接口）进行集群之间的通信。远程集群必须启用此端口才能使本地集群进行连接。为此端口配置传输层安全性 (TLS) 以最大限度地提高安全性（如[与远程集群建立信任](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html#remote-clusters-security-api-key)中所述）。

The local cluster must trust the remote cluster on the remote cluster interface. This means that the local cluster trusts the remote cluster’s certificate authority (CA) that signs the server certificate used by the remote cluster interface. When establishing a connection, all nodes from the local cluster that participate in cross-cluster communication verify certificates from nodes on the other side, based on the TLS trust configuration.
本地集群必须信任远程集群接口上的远程集群。这意味着本地集群信任远程集群的证书颁发机构 (CA)，该机构对远程集群接口使用的服务器证书进行签名。建立连接时，本地集群中参与跨集群通信的所有节点都会根据 TLS 信任配置验证另一端节点的证书。

To add a remote cluster using API key authentication:
使用 API 密钥身份验证添加远程集群：

1. [Review the prerequisites 查看先决条件](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html#remote-clusters-prerequisites-api-key)
2. [Establish trust with a remote cluster
   与远程集群建立信任](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html#remote-clusters-security-api-key)
3. [Connect to a remote cluster
   连接到远程集群](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html#remote-clusters-connect-api-key)
4. [Configure roles and users
   配置角色和用户](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html#remote-clusters-privileges-api-key)

If you run into any issues, refer to [Troubleshooting](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-troubleshooting.html).
如果您遇到任何问题，请参阅[故障排除](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-troubleshooting.html)。

## Prerequisites 先决条件

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-api-key.asciidoc)

- The Elasticsearch security features need to be enabled on both clusters, on every node. Security is enabled by default. If it’s disabled, set `xpack.security.enabled` to `true` in `elasticsearch.yml`. Refer to [General security settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-settings.html#general-security-settings). 
  需要在两个集群的每个节点上启用 Elasticsearch 安全功能。默认情况下启用安全性。如果禁用，请在`elasticsearch.yml`中将`xpack.security.enabled`设置为`true` 。请参阅[常规安全设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-settings.html#general-security-settings)。
- The nodes of the local and remote clusters must be on version 8.10 or later. 
  本地和远程集群的节点版本必须为8.10或更高版本。
- The local and remote clusters must have an appropriate license. For more information, refer to https://www.elastic.co/subscriptions. 
  本地和远程集群必须具有适当的许可证。有关更多信息，请参阅https://www.elastic.co/subscriptions 。

## Establish trust with a remote cluster 与远程集群建立信任

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-api-key.asciidoc)

If a remote cluster is part of an Elasticsearch Service deployment, it has a valid certificate by default. You can therefore skip steps related to certificates in these instructions.
如果远程集群是 Elasticsearch Service 部署的一部分，则默认情况下它具有有效的证书。因此，您可以跳过这些说明中与证书相关的步骤。

### On the remote cluster 在远程集群上

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-api-key.asciidoc)

1. Enable the remote cluster server on every node of the remote cluster. In `elasticsearch.yml`:
   在远程集群的每个节点上启用远程集群服务器。在`elasticsearch.yml`中：

   1. Set [`remote_cluster_server.enabled`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings) to `true`. 
      将[`remote_cluster_server.enabled`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings)设置为`true` 。
   2. Configure the bind and publish address for remote cluster server traffic, for example using [`remote_cluster.host`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings). Without configuring the address, remote cluster traffic may be bound to the local interface, and remote clusters running on other machines can’t connect. 
      配置远程集群服务器流量的绑定和发布地址，例如使用[`remote_cluster.host`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings) 。如果不配置地址，远程集群流量可能会绑定到本地接口，而运行在其他机器上的远程集群无法连接。
   3. Optionally, configure the remote server port using [`remote_cluster.port`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote_cluster.port) (defaults to `9443`). 
      （可选）使用[`remote_cluster.port`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote_cluster.port) （默认为`9443` ）配置远程服务器端口。

2. Next, generate a certificate authority (CA) and a server certificate/key pair. On one of the nodes of the remote cluster, from the directory where Elasticsearch has been installed:
   接下来，生成证书颁发机构 (CA) 和服务器证书/密钥对。在远程集群的节点之一上，从 Elasticsearch 的安装目录：

   1. Create a CA, if you don’t have a CA already:
      如果您还没有 CA，请创建 CA：

      ```sh
      ./bin/elasticsearch-certutil ca --pem --out=cross-cluster-ca.zip --pass CA_PASSWORD
      ```

      Replace `CA_PASSWORD` with the password you want to use for the CA. You can remove the `--pass` option and its argument if you are not deploying to a production environment.
      将`CA_PASSWORD`替换为您要用于 CA 的密码。如果您不部署到生产环境，则可以删除`--pass`选项及其参数。

   2. Unzip the generated `cross-cluster-ca.zip` file. This compressed file contains the following content:
      解压生成的`cross-cluster-ca.zip`文件。该压缩文件包含以下内容：

      ```txt
      /ca
      |_ ca.crt
      |_ ca.key
      ```

   3. Generate a certificate and private key pair for the nodes in the remote cluster:
      为远程集群中的节点生成证书和私钥对：

      ```sh
      ./bin/elasticsearch-certutil cert --out=cross-cluster.p12 --pass=CERT_PASSWORD --ca-cert=ca/ca.crt --ca-key=ca/ca.key --ca-pass=CA_PASSWORD --dns=example.com --ip=127.0.0.1
      ```

      - Replace `CA_PASSWORD` with the CA password from the previous step. 
        将`CA_PASSWORD`替换为上一步中的 CA 密码。
      - Replace `CERT_PASSWORD` with the password you want to use for the generated private key. 
        将`CERT_PASSWORD`替换为您要用于生成的私钥的密码。
      - Use the `--dns` option to specify the relevant DNS name for the certificate. You can specify it multiple times for multiple DNS. 
        使用`--dns`选项指定证书的相关 DNS 名称。您可以为多个 DNS 多次指定它。
      - Use the `--ip` option to specify the relevant IP address for the certificate. You can specify it multiple times for multiple IP addresses. 
        使用`--ip`选项指定证书的相关 IP 地址。您可以为多个 IP 地址多次指定它。

   4. If the remote cluster has multiple nodes, you can either:
      如果远程集群有多个节点，您可以：

      - create a single wildcard certificate for all nodes; 
        为所有节点创建一个通配符证书；
      - or, create separate certificates for each node either manually or in batch with the [silent mode](https://www.elastic.co/guide/en/elasticsearch/reference/current/certutil.html#certutil-silent). 
        或者，手动或使用[静默模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/certutil.html#certutil-silent)批量为每个节点创建单独的证书。

3. On every node of the remote cluster:
   在远程集群的每个节点上：

   1. Copy the `cross-cluster.p12` file from the earlier step to the `config` directory. If you didn’t create a wildcard certificate, make sure you copy the correct node-specific p12 file. 
      将前面步骤中的`cross-cluster.p12`文件复制到`config`目录。如果您没有创建通配符证书，请确保复制正确的特定于节点的 p12 文件。

   2. Add following configuration to `elasticsearch.yml`:
      将以下配置添加到`elasticsearch.yml` ：

      ```yaml
      xpack.security.remote_cluster_server.ssl.enabled: true
      xpack.security.remote_cluster_server.ssl.keystore.path: cross-cluster.p12
      ```

   3. Add the SSL keystore password to the Elasticsearch keystore:
      将 SSL 密钥库密码添加到 Elasticsearch 密钥库：

      ```sh
      ./bin/elasticsearch-keystore add xpack.security.remote_cluster_server.ssl.keystore.secure_password
      ```

      When prompted, enter the `CERT_PASSWORD` from the earlier step.
      出现提示时，输入先前步骤中的`CERT_PASSWORD` 。

4. Restart the remote cluster. 
   重新启动远程集群。

5. On the remote cluster, generate a cross-cluster API key that provides access to the indices you want to use for cross-cluster search or cross-cluster replication. You can use the [Create Cross-Cluster API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html) API or [Kibana](https://www.elastic.co/guide/en/kibana/8.15/api-keys.html). 
   在远程集群上，生成跨集群 API 密钥，该密钥提供对要用于跨集群搜索或跨集群复制的索引的访问。您可以使用[创建跨集群 API 密钥](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html)API 或[Kibana](https://www.elastic.co/guide/en/kibana/8.15/api-keys.html) 。

6. Copy the encoded key (`encoded` in the response) to a safe location. You will need it to connect to the remote cluster later. 
   将编码密钥（在响应中`encoded` ）复制到安全位置。稍后您将需要它来连接到远程集群。

### On the local cluster 在本地集群上

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-api-key.asciidoc)

1. On every node of the local cluster:
   在本地集群的每个节点上：

   1. Copy the `ca.crt` file generated on the remote cluster earlier into the `config` directory, renaming the file `remote-cluster-ca.crt`. 
      将之前在远程集群上生成的`ca.crt`文件复制到`config`目录中，并将文件重命名`remote-cluster-ca.crt` 。

   2. Add following configuration to `elasticsearch.yml`:
      将以下配置添加到`elasticsearch.yml` ：

      ```yaml
      xpack.security.remote_cluster_client.ssl.enabled: true
      xpack.security.remote_cluster_client.ssl.certificate_authorities: [ "remote-cluster-ca.crt" ]
      ```

   3. Add the cross-cluster API key, created on the remote cluster earlier, to the keystore:
      将之前在远程集群上创建的跨集群 API 密钥添加到密钥库：

      ```sh
      ./bin/elasticsearch-keystore add cluster.remote.ALIAS.credentials
      ```

      Replace `ALIAS` with the same name that you will use to create the remote cluster entry later. When prompted, enter the encoded cross-cluster API key created on the remote cluster earlier.
      将`ALIAS`替换为稍后用于创建远程集群条目的相同名称。出现提示时，输入之前在远程集群上创建的编码跨集群 API 密钥。

2. Restart the local cluster to load changes to the keystore and settings. 
   重新启动本地集群以加载对密钥库和设置的更改。

**Note:** If you are configuring only the cross-cluster API key, you can call the [Nodes reload secure settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html) API, instead of restarting the cluster. Configuring the `remote_cluster_client` settings in `elasticsearch.yml` still requires a restart.
**注意：**如果您仅配置跨集群 API 密钥，则可以调用[节点重新加载安全设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html)API，而不用重新启动集群。在`elasticsearch.yml`中配置`remote_cluster_client`设置仍然需要重新启动。

## Connect to a remote cluster 连接到远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-api-key.asciidoc)

You must have the `manage` cluster privilege to connect remote clusters.
您必须具有`manage`集群权限才能连接远程集群。

The local cluster uses the [remote cluster interface](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html) to establish communication with remote clusters. The coordinating nodes in the local cluster establish [long-lived](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections) TCP connections with specific nodes in the remote cluster. Elasticsearch requires these connections to remain open, even if the connections are idle for an extended period.
本地集群使用[远程集群接口](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html)与远程集群建立通信。本地集群中的协调节点与远程集群中的特定节点建立[长期](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections)TCP 连接。 Elasticsearch 要求这些连接保持打开状态，即使这些连接长时间处于空闲状态也是如此。

To add a remote cluster from Stack Management in Kibana:
要从 Kibana 中的堆栈管理添加远程集群：

1. Select **Remote Clusters** from the side navigation. 
   从侧面导航中选择**远程集群**。
2. Enter a name (*cluster alias*) for the remote cluster. 
   输入远程集群的名称（*集群别名*）。
3. Specify the Elasticsearch endpoint URL, or the IP address or host name of the remote cluster followed by the remote cluster port (defaults to `9443`). For example, `cluster.es.eastus2.staging.azure.foundit.no:9443` or `192.168.1.1:9443`. 
   指定 Elasticsearch 端点 URL，或者远程集群的 IP 地址或主机名，后跟远程集群端口（默认为`9443` ）。例如， `cluster.es.eastus2.staging.azure.foundit.no:9443` 或`192.168.1.1:9443` 。

Alternatively, use the [cluster update settings API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html) to add a remote cluster. You can also use this API to dynamically configure remote clusters for *every* node in the local cluster. To configure remote clusters on individual nodes in the local cluster, define static settings in `elasticsearch.yml` for each node.
或者，使用[集群更新设置 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html)添加远程集群。您还可以使用此 API 为本地集群中的*每个*节点动态配置远程集群。要在本地集群中的各个节点上配置远程集群，请在`elasticsearch.yml`中为每个节点定义静态设置。

The following request adds a remote cluster with an alias of `cluster_one`. This *cluster alias* is a unique identifier that represents the connection to the remote cluster and is used to distinguish between local and remote indices.
以下请求添加别名为`cluster_one`的远程集群。该*集群别名*是唯一标识符，代表与远程集群的连接，用于区分本地索引和远程索引。



```console
PUT /_cluster/settings
{
  "persistent" : {
    "cluster" : {
      "remote" : {
        "cluster_one" : {    
          "seeds" : [
            "127.0.0.1:9443" 
          ]
        }
      }
    }
  }
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/51.console) 

|      | The cluster alias of this remote cluster is `cluster_one`. 该远程集群的集群别名是`cluster_one` 。 |
| ---- | ------------------------------------------------------------ |
|      | Specifies the hostname and remote cluster port of a seed node in the remote cluster. 指定远程集群中种子节点的主机名和远程集群端口。 |

You can use the [remote cluster info API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html) to verify that the local cluster is successfully connected to the remote cluster:
您可以使用[远程集群信息 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html)来验证本地集群是否成功连接到远程集群：



```console
GET /_remote/info
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/52.console) 

The API response indicates that the local cluster is connected to the remote cluster with the cluster alias `cluster_one`:
API 响应表明本地集群已使用集群别名`cluster_one`连接到远程集群：



```console-result
{
  "cluster_one" : {
    "seeds" : [
      "127.0.0.1:9443"
    ],
    "connected" : true,
    "num_nodes_connected" : 1,  
    "max_connections_per_cluster" : 3,
    "initial_connect_timeout" : "30s",
    "skip_unavailable" : true, 
    "cluster_credentials": "::es_redacted::", 
    "mode" : "sniff"
  }
}
```

|      | The number of nodes in the remote cluster the local cluster is connected to. 本地集群连接到的远程集群中的节点数。 |
| ---- | ------------------------------------------------------------ |
|      | Indicates whether to skip the remote cluster if searched through cross-cluster search but no nodes are available. 跨集群搜索但没有可用节点时是否跳过远程集群。 |
|      | If present, indicates the remote cluster has connected using API key authentication. 如果存在，则表示远程集群已使用 API 密钥身份验证进行连接。 |

### Dynamically configure remote clusters 动态配置远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-connect.asciidoc)

Use the [cluster update settings API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html) to dynamically configure remote settings on every node in the cluster. The following request adds three remote clusters: `cluster_one`, `cluster_two`, and `cluster_three`.
使用[集群更新设置 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html)动态配置集群中每个节点上的远程设置。以下请求添加三个远程集群： `cluster_one` 、 `cluster_two`和`cluster_three` 。

The `seeds` parameter specifies the hostname and [remote cluster port](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html) (default `9443`) of a seed node in the remote cluster.
`seeds`参数指定远程集群中种子节点的主机名和[远程集群端口](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html)（默认为`9443` ）。

The `mode` parameter determines the configured connection mode, which defaults to [`sniff`](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-mode). Because `cluster_one` doesn’t specify a `mode`, it uses the default. Both `cluster_two` and `cluster_three` explicitly use different modes.
`mode`参数决定配置的连接模式，默认为[`sniff`](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-mode) 。由于`cluster_one`未指定`mode` ，因此它使用默认值。 `cluster_two`和`cluster_three`都明确使用不同的模式。



```console
PUT _cluster/settings
{
  "persistent": {
    "cluster": {
      "remote": {
        "cluster_one": {
          "seeds": [
            "127.0.0.1:9443"
          ]
        },
        "cluster_two": {
          "mode": "sniff",
          "seeds": [
            "127.0.0.1:9444"
          ],
          "transport.compress": true,
          "skip_unavailable": true
        },
        "cluster_three": {
          "mode": "proxy",
          "proxy_address": "127.0.0.1:9445"
        }
      }
    }
  }
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/53.console) 

You can dynamically update settings for a remote cluster after the initial configuration. The following request updates the compression settings for `cluster_two`, and the compression and ping schedule settings for `cluster_three`.
您可以在初始配置后动态更新远程集群的设置。以下请求更新`cluster_two`的压缩设置以及`cluster_three`的压缩和 ping 计划设置。

When the compression or ping schedule settings change, all existing node connections must close and re-open, which can cause in-flight requests to fail.
当压缩或 ping 计划设置更改时，所有现有节点连接必须关闭并重新打开，这可能会导致正在进行的请求失败。



```console
PUT _cluster/settings
{
  "persistent": {
    "cluster": {
      "remote": {
        "cluster_two": {
          "transport.compress": false
        },
        "cluster_three": {
          "transport.compress": true,
          "transport.ping_schedule": "60s"
        }
      }
    }
  }
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/54.console) 

You can delete a remote cluster from the cluster settings by passing `null` values for each remote cluster setting. The following request removes `cluster_two` from the cluster settings, leaving `cluster_one` and `cluster_three` intact:
您可以通过为每个远程集群设置传递`null`值来从集群设置中删除远程集群。以下请求从集群设置中删除`cluster_two` ，使`cluster_one`和`cluster_three`保持不变：



```console
PUT _cluster/settings
{
  "persistent": {
    "cluster": {
      "remote": {
        "cluster_two": {
          "mode": null,
          "seeds": null,
          "skip_unavailable": null,
          "transport.compress": null
        }
      }
    }
  }
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/55.console) 

### Statically configure remote clusters 静态配置远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-connect.asciidoc)

If you specify settings in `elasticsearch.yml`, only the nodes with those settings can connect to the remote cluster and serve remote cluster requests.
如果您在`elasticsearch.yml`中指定设置，则只有具有这些设置的节点才能连接到远程集群并服务远程集群请求。

Remote cluster settings that are specified using the [cluster update settings API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html) take precedence over settings that you specify in `elasticsearch.yml` for individual nodes.
使用[集群更新设置 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html)指定的远程集群设置优先于您在`elasticsearch.yml`中为各个节点指定的设置。

In the following example, `cluster_one`, `cluster_two`, and `cluster_three` are arbitrary cluster aliases representing the connection to each cluster. These names are subsequently used to distinguish between local and remote indices.
在以下示例中， `cluster_one` 、 `cluster_two`和`cluster_three`是表示与每个集群的连接的任意集群别名。这些名称随后用于区分本地索引和远程索引。

```yaml
cluster:
    remote:
        cluster_one:
            seeds: 127.0.0.1:9443
        cluster_two:
            mode: sniff
            seeds: 127.0.0.1:9444
            transport.compress: true      
            skip_unavailable: true        
        cluster_three:
            mode: proxy
            proxy_address: 127.0.0.1:9445 
```

|      | Compression is explicitly enabled for requests to `cluster_two`. 对`cluster_two`的请求显式启用压缩。 |
| ---- | ------------------------------------------------------------ |
|      | Disconnected remote clusters are optional for `cluster_two`. 对于`cluster_two`来说，断开连接的远程集群是可选的。 |
|      | The address for the proxy endpoint used to connect to `cluster_three`. 用于连接到`cluster_three`代理端点的地址。 |

## Configure roles and users 配置角色和用户

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-api-key.asciidoc)

To use a remote cluster for cross-cluster replication or cross-cluster search, you need to create user roles with [remote indices privileges](https://www.elastic.co/guide/en/elasticsearch/reference/current/defining-roles.html#roles-remote-indices-priv) on the local cluster.
要使用远程集群进行跨集群复制或跨集群搜索，您需要在本地集群上创建具有[远程索引权限](https://www.elastic.co/guide/en/elasticsearch/reference/current/defining-roles.html#roles-remote-indices-priv)的用户角色。

You can manage users and roles from Stack Management in Kibana by selecting **Security > Roles** from the side navigation. You can also use the [role management APIs](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api.html#security-role-apis) to add, update, remove, and retrieve roles dynamically.
您可以通过从侧面导航中选择**安全 > 角色，**从 Kibana 中的堆栈管理中管理用户和角色。您还可以使用[角色管理 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api.html#security-role-apis)动态添加、更新、删除和检索角色。

The following examples use the [Create or update roles](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-role.html) API. You must have at least the `manage_security` cluster privilege to use this API.
以下示例使用[创建或更新角色](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-role.html)API。您必须至少拥有`manage_security`集群权限才能使用此API。

The cross-cluster API key used by the local cluster to connect the remote cluster must have sufficient privileges to cover all remote indices privileges required by individual users.
本地集群用于连接远程集群的跨集群 API 密钥必须具有足够的权限来涵盖各个用户所需的所有远程索引权限。

### Configure privileges for cross-cluster replication 配置跨集群复制的权限

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-api-key.asciidoc)

Assuming the remote cluster is connected under the name of `my_remote_cluster`, the following request creates a role called `remote-replication` on the local cluster that allows replicating the remote `leader-index` index:
假设远程集群以`my_remote_cluster`名称连接，以下请求在本地集群上创建一个名为`remote-replication`角色，该角色允许复制远程`leader-index`索引：



```console
POST /_security/role/remote-replication
{
  "cluster": [
    "manage_ccr"
  ],
  "remote_indices": [
    {
      "clusters": [ "my_remote_cluster" ],
      "names": [
        "leader-index"
      ],
      "privileges": [
        "cross_cluster_replication"
      ]
    }
  ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/56.console) 

After creating the local `remote-replication` role, use the [Create or update users](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-user.html) API to create a user on the local cluster cluster and assign the `remote-replication` role. For example, the following request assigns the `remote-replication` role to a user named `cross-cluster-user`:
创建本地`remote-replication`角色后，使用[创建或更新用户](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-user.html)API 在本地集群上创建用户并分配`remote-replication`角色。例如，以下请求将`remote-replication`角色分配给名为`cross-cluster-user`用户：



```console
POST /_security/user/cross-cluster-user
{
  "password" : "l0ng-r4nd0m-p@ssw0rd",
  "roles" : [ "remote-replication" ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/57.console) 

Note that you only need to create this user on the local cluster.
请注意，您只需要在本地集群上创建该用户。

### Configure privileges for cross-cluster search 配置跨集群搜索的权限

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-api-key.asciidoc)

Assuming the remote cluster is connected under the name of `my_remote_cluster`, the following request creates a `remote-search` role on the local cluster that allows searching the remote `target-index` index:
假设远程集群以`my_remote_cluster`名称连接，以下请求在本地集群上创建一个`remote-search`角色，允许搜索远程`target-index`索引：



```console
POST /_security/role/remote-search
{
  "remote_indices": [
    {
      "clusters": [ "my_remote_cluster" ],
      "names": [
        "target-index"
      ],
      "privileges": [
        "read",
        "read_cross_cluster",
        "view_index_metadata"
      ]
    }
  ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/58.console) 

After creating the `remote-search` role, use the [Create or update users](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-user.html) API to create a user on the local cluster and assign the `remote-search` role. For example, the following request assigns the `remote-search` role to a user named `cross-search-user`:
创建`remote-search`角色后，使用[创建或更新用户](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-user.html)API 在本地集群上创建用户并分配`remote-search`角色。例如，以下请求将`remote-search`角色分配给名为`cross-search-user`用户：



```console
POST /_security/user/cross-search-user
{
  "password" : "l0ng-r4nd0m-p@ssw0rd",
  "roles" : [ "remote-search" ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/59.console) 

Note that you only need to create this user on the local cluster.
请注意，您只需要在本地集群上创建该用户。

# Add remote clusters using TLS certificate authentication 使用 TLS 证书身份验证添加远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-cert.asciidoc)

To add a remote cluster using TLS certificate authentication:
使用 TLS 证书身份验证添加远程集群：

1. [Review the prerequisites 查看先决条件](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-cert.html#remote-clusters-prerequisites-cert)
2. [Establish trust with a remote cluster
   与远程集群建立信任](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-cert.html#remote-clusters-security-cert)
3. [Connect to a remote cluster
   连接到远程集群](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-cert.html#remote-clusters-connect-cert)
4. [Configure roles and users for remote clusters
   为远程集群配置角色和用户](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-cert.html#remote-clusters-privileges-cert)

If you run into any issues, refer to [Troubleshooting](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-troubleshooting.html).
如果您遇到任何问题，请参阅[故障排除](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-troubleshooting.html)。

## Prerequisites 先决条件

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-cert.asciidoc)

1. The Elasticsearch security features need to be enabled on both clusters, on every node. Security is enabled by default. If it’s disabled, set `xpack.security.enabled` to `true` in `elasticsearch.yml`. Refer to [General security settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-settings.html#general-security-settings). 
   需要在两个集群的每个节点上启用 Elasticsearch 安全功能。默认情况下启用安全性。如果禁用，请在`elasticsearch.yml`中将`xpack.security.enabled`设置为`true` 。请参阅[常规安全设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-settings.html#general-security-settings)。

2. The local and remote clusters versions must be compatible.
   本地和远程集群版本必须兼容。

   - Any node can communicate with another node on the same major version. For example, 7.0 can talk to any 7.x node. 
     任何节点都可以与同一主要版本上的另一个节点进行通信。例如，7.0 可以与任何 7.x 节点通信。

   - Only nodes on the last minor version of a certain major version can communicate with nodes on the following major version. In the 6.x series, 6.8 can communicate with any 7.x node, while 6.7 can only communicate with 7.0. 
     只有某个主版本的最后一个小版本上的节点才能与下一个主版本上的节点通信。在6.x系列中，6.8可以与任何7.x节点通信，而6.7只能与7.0通信。

   - Version compatibility is symmetric, meaning that if 6.7 can communicate with 7.0, 7.0 can also communicate with 6.7. The following table depicts version compatibility between local and remote nodes.
     版本兼容性是对称的，意味着如果6.7可以与7.0通信，则7.0也可以与6.7通信。下表描述了本地和远程节点之间的版本兼容性。

     <details open="" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <summary class="title" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">Version compatibility table<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><br><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-block-wrapper-theme-none immersive-translate-target-translation-block-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">版本兼容表</font></font></font></summary>
     <div class="content" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <div class="informaltable" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <table border="1" cellpadding="4px" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <colgroup data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <col class="col_1" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <col class="col_2" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <col class="col_3" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <col class="col_4" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <col class="col_5" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <col class="col_6" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <col class="col_7" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <col class="col_8" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <col class="col_9" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <col class="col_10" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     </colgroup>
     <tbody data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></p></td>
     <td align="center" colspan="9" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="strong strong" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><strong data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">Local cluster<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">本地集群</font></font></font></strong></span></p></td>
     </tr>
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="strong strong" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><strong data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">Remote cluster<font class="notranslate immersive-translate-target-wrapper" data-immersive-translate-translation-element-mark="1" lang="zh-CN"><font class="notranslate" data-immersive-translate-translation-element-mark="1">&nbsp;</font><font class="notranslate immersive-translate-target-translation-theme-none immersive-translate-target-translation-inline-wrapper-theme-none immersive-translate-target-translation-inline-wrapper" data-immersive-translate-translation-element-mark="1"><font class="notranslate immersive-translate-target-inner immersive-translate-target-translation-theme-none-inner" data-immersive-translate-translation-element-mark="1">远程集群</font></font></font></strong></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">5.0–5.5</p></td>
     <td align="center" valign="top"><p>5.6</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">6.0–6.6</p></td>
     <td align="center" valign="top"><p>6.7</p></td>
     <td align="center" valign="top"><p>6.8</p></td>
     <td align="center" valign="top"><p>7.0</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">7.1–7.16</p></td>
     <td align="center" valign="top"><p>7.17</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">8.0–8.15</p></td>
     </tr>
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">5.0–5.5</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     </tr>
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top"><p>5.6</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     </tr>
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">6.0–6.6</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     </tr>
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top"><p>6.7</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     </tr>
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top"><p>6.8</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     </tr>
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top"><p>7.0</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     </tr>
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">7.1–7.16</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     </tr>
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top"><p>7.17</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     </tr>
     <tr data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d">
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d" data-immersive-translate-paragraph="1">8.0–8.15</p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-no.png" alt="No" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     <td align="center" valign="top" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><p data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><span class="image" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"><img src="https://doc-icons.s3.us-east-2.amazonaws.com/icon-yes.png" alt="Yes" width="20" height="15" data-immersive-translate-walked="57c37ff2-fd69-4aba-ab7e-2819b7da909d"></span></p></td>
     </tr>
     </tbody>
     </table>
     </div>
     </div>
     </details>

     Elastic only supports cross-cluster search on a subset of these configurations. See [Supported cross-cluster search configurations](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html#ccs-supported-configurations).
     Elastic 仅支持对这些配置的子集进行跨集群搜索。请参阅[支持的跨集群搜索配置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html#ccs-supported-configurations)。

## Establish trust with a remote cluster 与远程集群建立信任

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-cert.asciidoc)

To use cross-cluster replication or cross-cluster search safely with remote clusters, enable security on all connected clusters and configure Transport Layer Security (TLS) on every node. Configuring TLS security on the transport interface is minimally required for remote clusters. For additional security, configure TLS on the [HTTP interface](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup-https.html) as well.
要对远程集群安全地使用跨集群复制或跨集群搜索，请在所有连接的集群上启用安全性，并在每个节点上配置传输层安全性 (TLS)。远程集群最低限度需要在传输接口上配置 TLS 安全性。为了提高安全性，还可以在[HTTP 接口](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup-https.html)上配置 TLS。

All connected clusters must trust one another and be mutually authenticated with TLS on the transport interface. This means that the local cluster trusts the certificate  authority (CA) of the remote cluster, and the remote cluster trusts the CA of the local cluster. When establishing a connection, all nodes will verify certificates from nodes on the other side. This mutual trust is required to securely connect a remote cluster, because all connected nodes effectively form a single security domain.
所有连接的集群必须相互信任，并通过传输接口上的 TLS 进行相互身份验证。这意味着本地集群信任远程集群的证书颁发机构 (CA)，远程集群也信任本地集群的  CA。建立连接时，所有节点都会验证对方节点的证书。安全连接远程集群需要这种相互信任，因为所有连接的节点实际上形成一个安全域。

User authentication is performed on the local cluster and the user and user’s roles names are passed to the remote clusters. A remote cluster checks the user’s role names against its local role definitions to determine which indices the user is allowed to access.
用户身份验证在本地集群上执行，并将用户和用户的角色名称传递到远程集群。远程集群根据其本地角色定义检查用户的角色名称，以确定允许用户访问哪些索引。

Before using cross-cluster replication or cross-cluster search with secured Elasticsearch clusters, complete the following configuration task:
在对受保护的 Elasticsearch 集群使用跨集群复制或跨集群搜索之前，请完成以下配置任务：

1. Configure Transport Layer Security (TLS) on every node to encrypt internode traffic and authenticate nodes in the local cluster with nodes in all remote clusters. Refer to [set up basic security for the Elastic Stack](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup.html) for the required steps to configure security.
   在每个节点上配置传输层安全性 (TLS)，以加密节点间流量并使用所有远程集群中的节点对本地集群中的节点进行身份验证。请参阅[设置 Elastic Stack 的基本安全性](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup.html)，了解配置安全性所需的步骤。

   This procedure uses the same CA to generate certificates for all nodes. Alternatively, you can add the certificates from the local cluster as a trusted CA in each remote cluster. You must also add the certificates from remote clusters as a trusted CA on the local cluster. Using the same CA to generate certificates for all nodes simplifies this task.
   此过程使用相同的 CA 为所有节点生成证书。或者，您可以将本地集群中的证书添加为每个远程集群中的受信任 CA。您还必须将远程集群的证书添加为本地集群上的受信任 CA。使用相同的 CA 为所有节点生成证书可以简化此任务。

## Connect to a remote cluster 连接到远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-cert.asciidoc)

You must have the `manage` cluster privilege to connect remote clusters.
您必须具有`manage`集群权限才能连接远程集群。

The local cluster uses the [transport interface](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html) to establish communication with remote clusters. The coordinating nodes in the local cluster establish [long-lived](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections) TCP connections with specific nodes in the remote cluster. Elasticsearch requires these connections to remain open, even if the connections are idle for an extended period.
本地集群使用[传输接口](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html)与远程集群建立通信。本地集群中的协调节点与远程集群中的特定节点建立[长期](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections)TCP 连接。 Elasticsearch 要求这些连接保持打开状态，即使这些连接长时间处于空闲状态也是如此。

To add a remote cluster from Stack Management in Kibana:
要从 Kibana 中的堆栈管理添加远程集群：

1. Select **Remote Clusters** from the side navigation. 
   从侧面导航中选择**远程集群**。
2. Enter a name (*cluster alias*) for the remote cluster. 
   输入远程集群的名称（*集群别名*）。
3. Specify the Elasticsearch endpoint URL, or the IP address or host name of the remote cluster followed by the transport port (defaults to `9300`). For example, `cluster.es.eastus2.staging.azure.foundit.no:9300` or `192.168.1.1:9300`. 
   指定 Elasticsearch 端点 URL，或者远程集群的 IP 地址或主机名，后跟传输端口（默认为`9300` ）。例如， `cluster.es.eastus2.staging.azure.foundit.no:9300` 或`192.168.1.1:9300` 。

Alternatively, use the [cluster update settings API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html) to add a remote cluster. You can also use this API to dynamically configure remote clusters for *every* node in the local cluster. To configure remote clusters on individual nodes in the local cluster, define static settings in `elasticsearch.yml` for each node.
或者，使用[集群更新设置 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html)添加远程集群。您还可以使用此 API 为本地集群中的*每个*节点动态配置远程集群。要在本地集群中的各个节点上配置远程集群，请在`elasticsearch.yml`中为每个节点定义静态设置。

The following request adds a remote cluster with an alias of `cluster_one`. This *cluster alias* is a unique identifier that represents the connection to the remote cluster and is used to distinguish between local and remote indices.
以下请求添加别名为`cluster_one`的远程集群。该*集群别名*是唯一标识符，代表与远程集群的连接，用于区分本地索引和远程索引。



```console
PUT /_cluster/settings
{
  "persistent" : {
    "cluster" : {
      "remote" : {
        "cluster_one" : {    
          "seeds" : [
            "127.0.0.1:9300" 
          ]
        }
      }
    }
  }
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/60.console) 

|      | The cluster alias of this remote cluster is `cluster_one`. 该远程集群的集群别名是`cluster_one` 。 |
| ---- | ------------------------------------------------------------ |
|      | Specifies the hostname and transport port of a seed node in the remote cluster. 指定远程集群中种子节点的主机名和传输端口。 |

You can use the [remote cluster info API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html) to verify that the local cluster is successfully connected to the remote cluster:
您可以使用[远程集群信息 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html)来验证本地集群是否成功连接到远程集群：



```console
GET /_remote/info
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/61.console) 

The API response indicates that the local cluster is connected to the remote cluster with the cluster alias `cluster_one`:
API 响应表明本地集群已使用集群别名`cluster_one`连接到远程集群：



```console-result
{
  "cluster_one" : {
    "seeds" : [
      "127.0.0.1:9300"
    ],
    "connected" : true,
    "num_nodes_connected" : 1,  
    "max_connections_per_cluster" : 3,
    "initial_connect_timeout" : "30s",
    "skip_unavailable" : true, 
    "mode" : "sniff"
  }
}
```

|      | The number of nodes in the remote cluster the local cluster is connected to. 本地集群连接到的远程集群中的节点数。 |
| ---- | ------------------------------------------------------------ |
|      | Indicates whether to skip the remote cluster if searched through cross-cluster search but no nodes are available. 跨集群搜索但没有可用节点时是否跳过远程集群。 |

### Dynamically configure remote clusters 动态配置远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-connect.asciidoc)

Use the [cluster update settings API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html) to dynamically configure remote settings on every node in the cluster. The following request adds three remote clusters: `cluster_one`, `cluster_two`, and `cluster_three`.
使用[集群更新设置 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html)动态配置集群中每个节点上的远程设置。以下请求添加三个远程集群： `cluster_one` 、 `cluster_two`和`cluster_three` 。

The `seeds` parameter specifies the hostname and [transport port](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html) (default `9300`) of a seed node in the remote cluster.
`seeds`参数指定远程集群中种子节点的主机名和[传输端口](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html)（默认为`9300` ）。

The `mode` parameter determines the configured connection mode, which defaults to [`sniff`](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-mode). Because `cluster_one` doesn’t specify a `mode`, it uses the default. Both `cluster_two` and `cluster_three` explicitly use different modes.
`mode`参数决定配置的连接模式，默认为[`sniff`](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-mode) 。由于`cluster_one`未指定`mode` ，因此它使用默认值。 `cluster_two`和`cluster_three`都明确使用不同的模式。



```console
PUT _cluster/settings
{
  "persistent": {
    "cluster": {
      "remote": {
        "cluster_one": {
          "seeds": [
            "127.0.0.1:9300"
          ]
        },
        "cluster_two": {
          "mode": "sniff",
          "seeds": [
            "127.0.0.1:9301"
          ],
          "transport.compress": true,
          "skip_unavailable": true
        },
        "cluster_three": {
          "mode": "proxy",
          "proxy_address": "127.0.0.1:9302"
        }
      }
    }
  }
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/62.console) 

You can dynamically update settings for a remote cluster after the initial configuration. The following request updates the compression settings for `cluster_two`, and the compression and ping schedule settings for `cluster_three`.
您可以在初始配置后动态更新远程集群的设置。以下请求更新`cluster_two`的压缩设置以及`cluster_three`的压缩和 ping 计划设置。

When the compression or ping schedule settings change, all existing node connections must close and re-open, which can cause in-flight requests to fail.
当压缩或 ping 计划设置更改时，所有现有节点连接必须关闭并重新打开，这可能会导致正在进行的请求失败。



```console
PUT _cluster/settings
{
  "persistent": {
    "cluster": {
      "remote": {
        "cluster_two": {
          "transport.compress": false
        },
        "cluster_three": {
          "transport.compress": true,
          "transport.ping_schedule": "60s"
        }
      }
    }
  }
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/63.console) 

You can delete a remote cluster from the cluster settings by passing `null` values for each remote cluster setting. The following request removes `cluster_two` from the cluster settings, leaving `cluster_one` and `cluster_three` intact:
您可以通过为每个远程集群设置传递`null`值来从集群设置中删除远程集群。以下请求从集群设置中删除`cluster_two` ，使`cluster_one`和`cluster_three`保持不变：



```console
PUT _cluster/settings
{
  "persistent": {
    "cluster": {
      "remote": {
        "cluster_two": {
          "mode": null,
          "seeds": null,
          "skip_unavailable": null,
          "transport.compress": null
        }
      }
    }
  }
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/64.console) 

### Statically configure remote clusters 静态配置远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-connect.asciidoc)

If you specify settings in `elasticsearch.yml`, only the nodes with those settings can connect to the remote cluster and serve remote cluster requests.
如果您在`elasticsearch.yml`中指定设置，则只有具有这些设置的节点才能连接到远程集群并服务远程集群请求。

Remote cluster settings that are specified using the [cluster update settings API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html) take precedence over settings that you specify in `elasticsearch.yml` for individual nodes.
使用[集群更新设置 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html)指定的远程集群设置优先于您在`elasticsearch.yml`中为各个节点指定的设置。

In the following example, `cluster_one`, `cluster_two`, and `cluster_three` are arbitrary cluster aliases representing the connection to each cluster. These names are subsequently used to distinguish between local and remote indices.
在以下示例中， `cluster_one` 、 `cluster_two`和`cluster_three`是表示与每个集群的连接的任意集群别名。这些名称随后用于区分本地索引和远程索引。

```yaml
cluster:
    remote:
        cluster_one:
            seeds: 127.0.0.1:9300
        cluster_two:
            mode: sniff
            seeds: 127.0.0.1:9301
            transport.compress: true      
            skip_unavailable: true        
        cluster_three:
            mode: proxy
            proxy_address: 127.0.0.1:9302 
```

|      | Compression is explicitly enabled for requests to `cluster_two`. 对`cluster_two`的请求显式启用压缩。 |
| ---- | ------------------------------------------------------------ |
|      | Disconnected remote clusters are optional for `cluster_two`. 对于`cluster_two`来说，断开连接的远程集群是可选的。 |
|      | The address for the proxy endpoint used to connect to `cluster_three`. 用于连接到`cluster_three`代理端点的地址。 |

## Configure roles and users for remote clusters 为远程集群配置角色和用户

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-cert.asciidoc)

After [connecting remote clusters](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-connect.html), you create a user role on both the local and remote clusters and assign necessary privileges. These roles are required to use cross-cluster replication and cross-cluster search.
[连接远程集群](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-connect.html)后，您可以在本地和远程集群上创建用户角色并分配必要的权限。使用跨集群复制和跨集群搜索需要这些角色。

You must use the same role names on both the local and remote clusters. For example, the following configuration for cross-cluster replication uses the `remote-replication` role name on both the local and remote clusters. However, you can specify different role definitions on each cluster.
您必须在本地和远程集群上使用相同的角色名称。例如，以下跨集群复制配置在本地和远程集群上都使用`remote-replication`角色名称。但是，您可以在每个集群上指定不同的角色定义。

You can manage users and roles from Stack Management in Kibana by selecting **Security > Roles** from the side navigation. You can also use the [role management APIs](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api.html#security-role-mapping-apis) to add, update, remove, and retrieve roles dynamically. When you use the APIs to manage roles in the `native` realm, the roles are stored in an internal Elasticsearch index.
您可以通过从侧面导航中选择**安全 > 角色，**从 Kibana 中的堆栈管理中管理用户和角色。您还可以使用[角色管理 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api.html#security-role-mapping-apis)动态添加、更新、删除和检索角色。当您使用 API 管理`native`领域中的角色时，角色将存储在内部 Elasticsearch 索引中。

The following requests use the [create or update roles API](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-role.html). You must have at least the `manage_security` cluster privilege to use this API.
以下请求使用[创建或更新角色 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-role.html) 。您必须至少拥有`manage_security`集群权限才能使用此API。

### Configure privileges for cross-cluster replication 配置跨集群复制的权限

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-cert.asciidoc)

The cross-cluster replication user requires different cluster and index privileges on the remote cluster and local cluster. Use the following requests to create separate roles on the local and remote clusters, and then create a user with the required roles.
跨集群复制用户在远程集群和本地集群上需要不同的集群和索引权限。使用以下请求在本地和远程集群上创建单独的角色，然后创建具有所需角色的用户。

#### Remote cluster 远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-cert.asciidoc)

On the remote cluster that contains the leader index, the cross-cluster replication role requires the `read_ccr` cluster privilege, and `monitor` and `read` privileges on the leader index.
在包含leader索引的远程集群上，跨集群复制角色需要`read_ccr`集群权限，以及对leader索引的`monitor`和`read`权限。

If requests are authenticated with an [API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-api-key.html), the API key requires the above privileges on the **local** cluster, instead of the remote.
如果请求使用[API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-api-key.html)进行身份验证，则 API key 需要**本地**集群（而不是远程集群）上的上述权限。

If requests are issued [on behalf of other users](https://www.elastic.co/guide/en/elasticsearch/reference/current/run-as-privilege.html), then the authenticating user must have the `run_as` privilege on the remote cluster.
如果[代表其他用户](https://www.elastic.co/guide/en/elasticsearch/reference/current/run-as-privilege.html)发出请求，则身份验证用户必须具有远程集群上的`run_as`权限。

The following request creates a `remote-replication` role on the remote cluster:
以下请求在远程集群上创建`remote-replication`角色：



```console
POST /_security/role/remote-replication
{
  "cluster": [
    "read_ccr"
  ],
  "indices": [
    {
      "names": [
        "leader-index-name"
      ],
      "privileges": [
        "monitor",
        "read"
      ]
    }
  ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/65.console) 

#### Local cluster 本地集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-cert.asciidoc)

On the local cluster that contains the follower index, the `remote-replication` role requires the `manage_ccr` cluster privilege, and `monitor`, `read`, `write`, and `manage_follow_index` privileges on the follower index.
在包含 follower 索引的本地集群上， `remote-replication`角色需要 follower 索引的`manage_ccr`集群权限以及`monitor` 、 `read` 、 `write`和`manage_follow_index`权限。

The following request creates a `remote-replication` role on the local cluster:
以下请求在本地集群上创建`remote-replication`角色：



```console
POST /_security/role/remote-replication
{
  "cluster": [
    "manage_ccr"
  ],
  "indices": [
    {
      "names": [
        "follower-index-name"
      ],
      "privileges": [
        "monitor",
        "read",
        "write",
        "manage_follow_index"
      ]
    }
  ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/66.console) 

After creating the `remote-replication` role on each cluster, use the [create or update users API](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-user.html) to create a user on the local cluster cluster and assign the `remote-replication` role. For example, the following request assigns the `remote-replication` role to a user named `cross-cluster-user`:
在每个集群上创建`remote-replication`角色后，使用[创建或更新用户 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-user.html)在本地集群上创建用户并分配`remote-replication`角色。例如，以下请求将`remote-replication`角色分配给名为`cross-cluster-user`用户：



```console
POST /_security/user/cross-cluster-user
{
  "password" : "l0ng-r4nd0m-p@ssw0rd",
  "roles" : [ "remote-replication" ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/67.console) 

You only need to create this user on the **local** cluster.
您只需在**本地**集群上创建该用户即可。

You can then [configure cross-cluster replication](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-getting-started-tutorial.html) to replicate your data across datacenters.
然后，您可以[配置跨集群复制](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-getting-started-tutorial.html)以跨数据中心复制数据。

### Configure privileges for cross-cluster search 配置跨集群搜索的权限

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-cert.asciidoc)

The cross-cluster search user requires different cluster and index privileges on the remote cluster and local cluster. The following requests create separate roles on the local and remote clusters, and then create a user with the required roles.
跨集群搜索用户在远程集群和本地集群上需要不同的集群和索引权限。以下请求在本地和远程集群上创建单独的角色，然后创建具有所需角色的用户。

#### Remote cluster 远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-cert.asciidoc)

On the remote cluster, the cross-cluster search role requires the `read` and `read_cross_cluster` privileges for the target indices.
在远程集群上，跨集群搜索角色需要目标索引的`read`和`read_cross_cluster`权限。

If requests are authenticated with an [API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-api-key.html), the API key requires the above privileges on the **local** cluster, instead of the remote.
如果请求使用[API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-api-key.html)进行身份验证，则 API key 需要**本地**集群（而不是远程集群）上的上述权限。

If requests are issued [on behalf of other users](https://www.elastic.co/guide/en/elasticsearch/reference/current/run-as-privilege.html), then the authenticating user must have the `run_as` privilege on the remote cluster.
如果[代表其他用户](https://www.elastic.co/guide/en/elasticsearch/reference/current/run-as-privilege.html)发出请求，则身份验证用户必须具有远程集群上的`run_as`权限。

The following request creates a `remote-search` role on the remote cluster:
以下请求在远程集群上创建`remote-search`角色：



```console
POST /_security/role/remote-search
{
  "indices": [
    {
      "names": [
        "target-indices"
      ],
      "privileges": [
        "read",
        "read_cross_cluster"
      ]
    }
  ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/68.console) 

#### Local cluster 本地集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-cert.asciidoc)

On the local cluster, which is the cluster used to initiate cross cluster search, a user only needs the `remote-search` role. The role privileges can be empty.
在本地集群（即用于发起跨集群搜索的集群）上，用户只需要`remote-search`角色。角色权限可以为空。

The following request creates a `remote-search` role on the local cluster:
以下请求在本地集群上创建`remote-search`角色：



```console
POST /_security/role/remote-search
{}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/69.console) 

After creating the `remote-search` role on each cluster, use the [create or update users API](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-user.html) to create a user on the local cluster and assign the `remote-search` role. For example, the following request assigns the `remote-search` role to a user named `cross-search-user`:
在每个集群上创建`remote-search`角色后，使用[创建或更新用户 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-user.html)在本地集群上创建用户并分配`remote-search`角色。例如，以下请求将`remote-search`角色分配给名为`cross-search-user`用户：



```console
POST /_security/user/cross-search-user
{
  "password" : "l0ng-r4nd0m-p@ssw0rd",
  "roles" : [ "remote-search" ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/70.console) 

You only need to create this user on the **local** cluster.
您只需在**本地**集群上创建该用户即可。

Users with the `remote-search` role can then [search across clusters](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html).
然后，具有`remote-search`角色的用户可以[跨集群进行搜索](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html)。

### Configure privileges for cross-cluster search and Kibana 配置跨集群搜索和 Kibana 的权限

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-cert.asciidoc)

When using Kibana to search across multiple clusters, a two-step authorization process determines whether or not the user can access data streams and indices on a remote cluster:
当使用 Kibana 跨多个集群进行搜索时，两步授权过程决定用户是否可以访问远程集群上的数据流和索引：

- First, the local cluster determines if the user is authorized to access remote clusters. The local cluster is the cluster that Kibana is connected to. 
  首先，本地集群判断用户是否有权访问远程集群。本地集群是 Kibana 连接到的集群。
- If the user is authorized, the remote cluster then determines if the user has access to the specified data streams and indices. 
  如果用户获得授权，则远程集群将确定用户是否有权访问指定的数据流和索引。

To grant Kibana users access to remote clusters, assign them a local role with read privileges to indices on the remote clusters. You specify data streams and indices in a remote cluster as `<remote_cluster_name>:<target>`.
要授予 Kibana 用户访问远程集群的权限，请为他们分配一个本地角色，该角色对远程集群上的索引具有读取权限。您将远程集群中的数据流和索引指定为 `<remote_cluster_name>:<target>` 。

To grant users read access on the remote data streams and indices, you must create a matching role on the remote clusters that grants the `read_cross_cluster` privilege with access to the appropriate data streams and indices.
要授予用户对远程数据流和索引的读取访问权限，您必须在远程集群上创建一个匹配的角色，该角色授予`read_cross_cluster`权限以访问适当的数据流和索引。

For example, you might be actively indexing Logstash data on a local cluster and and periodically offload older time-based indices to an archive on your remote cluster. You want to search across both clusters, so you must enable Kibana users on both clusters.
例如，您可能会主动为本地集群上的 Logstash 数据建立索引，并定期将较旧的基于时间的索引卸载到远程集群上的存档中。您想要跨两个集群进行搜索，因此必须在两个集群上启用 Kibana 用户。

#### Local cluster 本地集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-cert.asciidoc)

On the local cluster, create a `logstash-reader` role that grants `read` and `view_index_metadata` privileges on the local `logstash-*` indices.
在本地集群上，创建一个`logstash-reader`角色，授予对本地`logstash-*`索引的`read`和`view_index_metadata`权限。

If you configure the local cluster as another remote in Elasticsearch, the `logstash-reader` role on your local cluster also needs to grant the `read_cross_cluster` privilege.
如果您将本地集群配置为 Elasticsearch 中的另一个远程集群，则本地集群上的`logstash-reader`角色还需要授予`read_cross_cluster`权限。



```console
POST /_security/role/logstash-reader
{
  "indices": [
    {
      "names": [
        "logstash-*"
        ],
        "privileges": [
          "read",
          "view_index_metadata"
          ]
    }
  ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/71.console) 

Assign your Kibana users a role that grants [access to Kibana](https://www.elastic.co/guide/en/kibana/8.15/xpack-security-authorization.html), as well as your `logstash_reader` role. For example, the following request creates the `cross-cluster-kibana` user and assigns the `kibana-access` and `logstash-reader` roles.
为您的 Kibana 用户分配一个授予[Kibana 访问](https://www.elastic.co/guide/en/kibana/8.15/xpack-security-authorization.html)权限的角色，以及您的`logstash_reader`角色。例如，以下请求创建`cross-cluster-kibana`用户并分配`kibana-access`和`logstash-reader`角色。



```console
PUT /_security/user/cross-cluster-kibana
{
  "password" : "l0ng-r4nd0m-p@ssw0rd",
  "roles" : [
    "logstash-reader",
    "kibana-access"
    ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/72.console) 

#### Remote cluster 远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/security/authentication/remote-clusters-privileges-cert.asciidoc)

On the remote cluster, create a `logstash-reader` role that grants the `read_cross_cluster` privilege and `read` and `view_index_metadata` privileges for the `logstash-*` indices.
在远程集群上，创建一个`logstash-reader`角色，该角色授予`logstash-*`索引的`read_cross_cluster`权限以及`read`和`view_index_metadata`权限。



```console
POST /_security/role/logstash-reader
{
  "indices": [
    {
      "names": [
        "logstash-*"
        ],
        "privileges": [
          "read_cross_cluster",
          "read",
          "view_index_metadata"
          ]
    }
  ]
}
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/73.console) 

# Migrate remote clusters from certificate to API key authentication 将远程集群从证书迁移到 API 密钥身份验证

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-migration.asciidoc)

The API key based security model for remote clusters offers administrators more fine-grained access controls compared to the TLS certificate based security model. For that reason, you may want to migrate from the certificate based security model to the API key based model.
与基于 TLS 证书的安全模型相比，远程集群基于 API 密钥的安全模型为管理员提供了更细粒度的访问控制。因此，您可能希望从基于证书的安全模型迁移到基于 API 密钥的模型。

While it is possible to migrate by defining a new remote cluster connection, using a new alias, this has several downsides:
虽然可以通过使用新别名定义新的远程集群连接来进行迁移，但这有几个缺点：

- For cross-cluster replication, it’s not possible to change the leader cluster alias for existing tasks. As a result, with a new remote cluster, follower indices would need to be re-created from scratch. 
  对于跨集群复制，无法更改现有任务的领导集群别名。因此，对于新的远程集群，需要从头开始重新创建追随者索引。
- For cross-cluster search, transform and anomaly detection jobs do allow updating the remote cluster alias. However, if the job was created with wildcards, for example `*:source_index`, and `superuser`, adding a new remote cluster will cause the job to do double the amount of work and potentially skew results with duplications. 
  对于跨集群搜索、转换和异常检测作业确实允许更新远程集群别名。但是，如果作业是使用通配符创建的，例如`*:source_index`和`superuser` ，则添加新的远程集群将导致作业执行双倍的工作量，并可能因重复而导致结果出现偏差。

For these reasons, you may prefer to migrate a remote cluster in-place, by following these steps:
由于这些原因，您可能更愿意按照以下步骤就地迁移远程集群：

1. [Review the prerequisites 查看先决条件](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-prerequisites)
2. [Reconfigure the remote cluster and generate a cross-cluster API key
   重新配置远程集群并生成跨集群API密钥](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-remote-cluster)
3. [Stop cross-cluster operations
   停止跨集群操作](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-stop)
4. [Reconnect to the remote cluster
   重新连接到远程集群](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-reconnect)
5. [Resume cross-cluster operations
   恢复跨集群操作](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-resume)
6. [Disable certificate based authentication and authorization
   禁用基于证书的身份验证和授权](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-disable-cert)

If you run into any issues, refer to [Troubleshooting](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-troubleshooting.html).
如果您遇到任何问题，请参阅[故障排除](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-troubleshooting.html)。

## Prerequisites 先决条件

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-migration.asciidoc)

- The nodes of the local and remote clusters must be on version 8.10 or later. 
  本地和远程集群的节点版本必须为8.10或更高版本。
- The local and remote clusters must have an appropriate license. For more information, refer to https://www.elastic.co/subscriptions. 
  本地和远程集群必须具有适当的许可证。有关更多信息，请参阅https://www.elastic.co/subscriptions 。

## Reconfigure the remote cluster and generate a cross-cluster API key 重新配置远程集群并生成跨集群API密钥

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-migration.asciidoc)

On the remote cluster: 在远程集群上：

1. Enable the remote cluster server on every node of the remote cluster. In `elasticsearch.yml`:
   在远程集群的每个节点上启用远程集群服务器。在`elasticsearch.yml`中：

   1. Set [`remote_cluster_server.enabled`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings) to `true`. 
      将[`remote_cluster_server.enabled`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings)设置为`true` 。
   2. Configure the bind and publish address for remote cluster server traffic, for example using [`remote_cluster.host`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings). Without configuring the address, remote cluster traffic may be bound to the local interface, and remote clusters running on other machines can’t connect. 
      配置远程集群服务器流量的绑定和发布地址，例如使用[`remote_cluster.host`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings) 。如果不配置地址，远程集群流量可能会绑定到本地接口，而运行在其他机器上的远程集群无法连接。
   3. Optionally, configure the remote server port using [`remote_cluster.port`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote_cluster.port) (defaults to `9443`). 
      （可选）使用[`remote_cluster.port`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote_cluster.port) （默认为`9443` ）配置远程服务器端口。

2. Next, generate a certificate authority (CA) and a server certificate/key pair. On one of the nodes of the remote cluster, from the directory where Elasticsearch has been installed:
   接下来，生成证书颁发机构 (CA) 和服务器证书/密钥对。在远程集群的节点之一上，从 Elasticsearch 的安装目录：

   1. Create a CA, if you don’t have a CA already:
      如果您还没有 CA，请创建 CA：

      ```sh
      ./bin/elasticsearch-certutil ca --pem --out=cross-cluster-ca.zip --pass CA_PASSWORD
      ```

      Replace `CA_PASSWORD` with the password you want to use for the CA. You can remove the `--pass` option and its argument if you are not deploying to a production environment.
      将`CA_PASSWORD`替换为您要用于 CA 的密码。如果您不部署到生产环境，则可以删除`--pass`选项及其参数。

   2. Unzip the generated `cross-cluster-ca.zip` file. This compressed file contains the following content:
      解压生成的`cross-cluster-ca.zip`文件。该压缩文件包含以下内容：

      ```txt
      /ca
      |_ ca.crt
      |_ ca.key
      ```

   3. Generate a certificate and private key pair for the nodes in the remote cluster:
      为远程集群中的节点生成证书和私钥对：

      ```sh
      ./bin/elasticsearch-certutil cert --out=cross-cluster.p12 --pass=CERT_PASSWORD --ca-cert=ca/ca.crt --ca-key=ca/ca.key --ca-pass=CA_PASSWORD --dns=example.com --ip=127.0.0.1
      ```

      - Replace `CA_PASSWORD` with the CA password from the previous step. 
        将`CA_PASSWORD`替换为上一步中的 CA 密码。
      - Replace `CERT_PASSWORD` with the password you want to use for the generated private key. 
        将`CERT_PASSWORD`替换为您要用于生成的私钥的密码。
      - Use the `--dns` option to specify the relevant DNS name for the certificate. You can specify it multiple times for multiple DNS. 
        使用`--dns`选项指定证书的相关 DNS 名称。您可以为多个 DNS 多次指定它。
      - Use the `--ip` option to specify the relevant IP address for the certificate. You can specify it multiple times for multiple IP addresses. 
        使用`--ip`选项指定证书的相关 IP 地址。您可以为多个 IP 地址多次指定它。

   4. If the remote cluster has multiple nodes, you can either:
      如果远程集群有多个节点，您可以：

      - create a single wildcard certificate for all nodes; 
        为所有节点创建一个通配符证书；
      - or, create separate certificates for each node either manually or in batch with the [silent mode](https://www.elastic.co/guide/en/elasticsearch/reference/current/certutil.html#certutil-silent). 
        或者，手动或使用[静默模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/certutil.html#certutil-silent)批量为每个节点创建单独的证书。

3. On every node of the remote cluster:
   在远程集群的每个节点上：

   1. Copy the `cross-cluster.p12` file from the earlier step to the `config` directory. If you didn’t create a wildcard certificate, make sure you copy the correct node-specific p12 file. 
      将前面步骤中的`cross-cluster.p12`文件复制到`config`目录。如果您没有创建通配符证书，请确保复制正确的特定于节点的 p12 文件。

   2. Add following configuration to `elasticsearch.yml`:
      将以下配置添加到`elasticsearch.yml` ：

      ```yaml
      xpack.security.remote_cluster_server.ssl.enabled: true
      xpack.security.remote_cluster_server.ssl.keystore.path: cross-cluster.p12
      ```

   3. Add the SSL keystore password to the Elasticsearch keystore:
      将 SSL 密钥库密码添加到 Elasticsearch 密钥库：

      ```sh
      ./bin/elasticsearch-keystore add xpack.security.remote_cluster_server.ssl.keystore.secure_password
      ```

      When prompted, enter the `CERT_PASSWORD` from the earlier step.
      出现提示时，输入先前步骤中的`CERT_PASSWORD` 。

4. Restart the remote cluster. 
   重新启动远程集群。

5. On the remote cluster, generate a cross-cluster API key that provides access to the indices you want to use for cross-cluster search or cross-cluster replication. You can use the [Create Cross-Cluster API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html) API or [Kibana](https://www.elastic.co/guide/en/kibana/8.15/api-keys.html). 
   在远程集群上，生成跨集群 API 密钥，该密钥提供对要用于跨集群搜索或跨集群复制的索引的访问。您可以使用[创建跨集群 API 密钥](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html)API 或[Kibana](https://www.elastic.co/guide/en/kibana/8.15/api-keys.html) 。

6. Copy the encoded key (`encoded` in the response) to a safe location. You will need it to connect to the remote cluster later. 
   将编码密钥（在响应中`encoded` ）复制到安全位置。稍后您将需要它来连接到远程集群。

## Stop cross-cluster operations 停止跨集群操作

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-migration.asciidoc)

On the local cluster, stop any persistent tasks that refer to the remote cluster:
在本地集群上，停止引用远程集群的任何持久性任务：

- Use the [Stop transforms](https://www.elastic.co/guide/en/elasticsearch/reference/current/stop-transform.html) API to stop any transforms. 
  使用[停止转换](https://www.elastic.co/guide/en/elasticsearch/reference/current/stop-transform.html)API 来停止任何转换。
- Use the [Close jobs](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-close-job.html) API to close any anomaly detection jobs. 
  使用[关闭作业](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-close-job.html)API 关闭任何异常检测作业。
- Use the [Pause auto-follow pattern](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-pause-auto-follow-pattern.html) API to pause any auto-follow cross-cluster replication. 
  使用[暂停自动跟踪模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-pause-auto-follow-pattern.html)API 来暂停任何自动跟踪跨集群复制。
- Use the [Pause follower](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-post-pause-follow.html) API to pause any manual cross-cluster replication or existing indices that were created from the auto-follow pattern. 
  使用[暂停关注者](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-post-pause-follow.html)API 暂停任何手动跨集群复制或从自动关注模式创建的现有索引。

## Reconnect to the remote cluster 重新连接到远程集群

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-migration.asciidoc)

On the local cluster: 在本地集群上：

1. Enhance any roles used by local cluster users with the required [remote indices privileges](https://www.elastic.co/guide/en/elasticsearch/reference/current/defining-roles.html#roles-remote-indices-priv) for cross-cluster replication and cross-cluster search. Refer to [Configure roles and users](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html#remote-clusters-privileges-api-key). Note:
   通过跨集群复制和跨集群搜索所需的[远程索引权限](https://www.elastic.co/guide/en/elasticsearch/reference/current/defining-roles.html#roles-remote-indices-priv)增强本地集群用户使用的任何角色。请参阅[配置角色和用户](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html#remote-clusters-privileges-api-key)。笔记：

   - You only need to assign additional `remote_indices` privileges to existing roles used for cross-cluster operations. You should be able to copy these privileges from the original roles on the remote cluster, where they are defined under the certification based security model. 
     您只需为用于跨集群操作的现有角色分配额外的`remote_indices`权限。您应该能够从远程集群上的原始角色复制这些权限，它们是在基于认证的安全模型下定义的。
   - The roles on the local cluster can’t exceed the `access` privilege granted by the cross-cluster API key. Any extra local privileges will be suppressed by the cross-cluster API key’s privileges. 
     本地集群上的角色不能超过跨集群API密钥授予的`access`权限。任何额外的本地权限都将被跨集群 API 密钥的权限所抑制。
   - No update is needed if the cross-cluster replication or cross-cluster search tasks have been configured with a `superuser` role. The `superuser` role is automatically updated to allow access to all remote indices. 
     如果跨集群复制或跨集群搜索任务已配置`superuser`角色，则无需更新。 `superuser`角色会自动更新以允许访问所有远程索引。
   - Tasks that are run as regular users with named roles are immediately updated with the new privileges. A task will load a new definition the next time it runs. 
     以具有指定角色的常规用户身份运行的任务将立即使用新权限进行更新。任务将在下次运行时加载新定义。
   - You need to restart tasks that are run using an API key (done in a later step). 
     您需要重新启动使用 API 密钥运行的任务（在后续步骤中完成）。

2. If you’ve dynamically configured the remote cluster (via the cluster settings API):
   如果您已动态配置远程集群（通过集群设置 API）：

   1. Retrieve the current remote cluster configuration, and store it in a safe place. You may need it later in case you need to [roll back](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-rollback). Use the cluster settings API:
      检索当前的远程集群配置，并将其存储在安全的地方。稍后您可能需要它，以防需要[回滚](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-rollback)。使用集群设置 API：

      

      ```console
      GET /_cluster/settings?filter_path=persistent.cluster.remote
      ```

1. Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/74.console) 
2. Remove the existing remote cluster definition by setting the remote cluster settings to `null`. 
   通过将远程集群设置设置为`null`来删除现有的远程集群定义。

If you’ve statically configured the remote cluster (via `elasticsearch.yml`), copy the `cluster.remote` settings from `elasticsearch.yml`, and store them in a safe place. You may need them later in case you need to [roll back](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-rollback). 
如果您已静态配置远程集群（通过`elasticsearch.yml` ），请从`elasticsearch.yml`复制`cluster.remote`设置，并将其存储在安全的地方。稍后您可能需要它们，以防需要[回滚](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-rollback)。

On every node of the local cluster:
在本地集群的每个节点上：

1. Copy the `ca.crt` file generated on the remote cluster earlier into the `config` directory, renaming the file `remote-cluster-ca.crt`. 
   将之前在远程集群上生成的`ca.crt`文件复制到`config`目录中，并将文件重命名`remote-cluster-ca.crt` 。

2. Add following configuration to `elasticsearch.yml`:
   将以下配置添加到`elasticsearch.yml` ：

   ```yaml
   xpack.security.remote_cluster_client.ssl.enabled: true
   xpack.security.remote_cluster_client.ssl.certificate_authorities: [ "remote-cluster-ca.crt" ]
   ```

3. Add the cross-cluster API key, created on the remote cluster earlier, to the keystore:
   将之前在远程集群上创建的跨集群 API 密钥添加到密钥库：

   ```sh
   ./bin/elasticsearch-keystore add cluster.remote.ALIAS.credentials
   ```

   Replace `ALIAS` with the same alias that was used for cross-cluster operations before the migration. When prompted, enter the encoded cross-cluster API key created on the remote cluster earlier.
   将`ALIAS`替换为迁移前用于跨集群操作的相同别名。出现提示时，输入之前在远程集群上创建的编码跨集群 API 密钥。

If you’ve dynamically configured the remote cluster (via the cluster settings API):
如果您已动态配置远程集群（通过集群设置 API）：

1. Restart the local cluster to load changes to the keystore and settings. 
   重新启动本地集群以加载对密钥库和设置的更改。

2. Re-add the remote cluster. Use the same remote cluster alias, and change the transport port into the remote cluster port. For example:
   重新添加远程集群。使用相同的远程集群别名，并将传输端口更改为远程集群端口。例如：

   

   ```console
   PUT /_cluster/settings
   {
     "persistent" : {
       "cluster" : {
         "remote" : {
           "my_remote" : { 
             "mode": "proxy",
             "proxy_address": "my.remote.cluster.com:9443" 
           }
         }
       }
     }
   }
   ```

1. Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/75.console) 

   |      | The remote cluster alias. Use the same alias that was used before the migration. 远程集群别名。使用迁移前使用的相同别名。 |
   | ---- | ------------------------------------------------------------ |
   |      | The remote cluster address with the remote cluster port, which defaults to `9443`. 带有远程集群端口的远程集群地址，默认为`9443` 。 |

If you’ve statically configured the remote cluster (via `elasticsearch.yml`):
如果您已静态配置远程集群（通过`elasticsearch.yml` ）：

1. Update the `cluster.remote` settings in `elasticsearch.yml` on each node of the local cluster. Change the port into the remote cluster port, which defaults to `9443`. 
   更新本地集群每个节点上的`elasticsearch.yml`中的`cluster.remote`设置。将端口更改为远程集群端口，默认为`9443` 。
2. Restart the local cluster to load changes to the keystore and settings. 
   重新启动本地集群以加载对密钥库和设置的更改。

Use the [remote cluster info API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html) to verify that the local cluster has successfully connected to the remote cluster:
使用[远程集群信息 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html)验证本地集群是否已成功连接到远程集群：



```console
GET /_remote/info
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/76.console) 

The API response should indicate that the local cluster has connected to the remote cluster:[                                          ](javascript:void(0))

[                      重试                                           ](javascript:void(0))

[                      错误原因                           ](javascript:void(0))



```console-result
{
  "my_remote": {
    "connected": true, 
    "mode": "proxy",
    "proxy_address": "my.remote.cluster.com:9443",
    "server_name": "",
    "num_proxy_sockets_connected": 0,
    "max_proxy_socket_connections": 18,
    "initial_connect_timeout": "30s",
    "skip_unavailable": false,
    "cluster_credentials": "::es_redacted::" 
  }
}
```

|      | The remote cluster is connected.[                                          ](javascript:void(0)) |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

[                      重试                                           ](javascript:void(0))

1. | [                      错误原因                           ](javascript:void(0)) |                                                              |
   | ------------------------------------------------------------ | ------------------------------------------------------------ |
   |                                                              | If present, indicates the remote cluster has connected using API key authentication. 如果存在，则表示远程集群已使用 API 密钥身份验证进行连接。 |

## Resume cross-cluster operations 恢复跨集群操作

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-migration.asciidoc)

Resume any persistent tasks that you stopped earlier. Tasks should be restarted by the same user or API key that created the task before the migration. Ensure the roles of this user or API key have been updated with the required `remote_indices` privileges. For users, tasks capture the caller’s credentials when started and run in that user’s security context. For API keys, restarting a task will update the task with the updated API key.
恢复您之前停止的所有持久性任务。任务应由迁移前创建任务的同一用户或 API 密钥重新启动。确保已使用所需的`remote_indices`权限更新此用户或API密钥的角色。对于用户，任务在该用户的安全上下文中启动和运行时捕获调用者的凭据。对于 API 密钥，重新启动任务将使用更新后的 API 密钥更新任务。

- Use the [Start transform](https://www.elastic.co/guide/en/elasticsearch/reference/current/start-transform.html) API to start any transforms. 
  使用[启动转换](https://www.elastic.co/guide/en/elasticsearch/reference/current/start-transform.html)API 启动任何转换。
- Use the [Open jobs](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-open-job.html) API to open any anomaly detection jobs. 
  使用[打开作业](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-open-job.html)API 打开任何异常检测作业。
- Use the [Resume follower](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-post-resume-follow.html) API to resume any auto-follow cross-cluster replication. 
  使用[恢复关注者](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-post-resume-follow.html)API 恢复任何自动关注跨集群复制。
- Use the [Resume auto-follow pattern](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-resume-auto-follow-pattern.html) API to resume any manual cross-cluster replication or existing indices that were created from the auto-follow pattern. 
  使用[恢复自动跟踪模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-resume-auto-follow-pattern.html)API 可以恢复任何手动跨集群复制或从自动跟踪模式创建的现有索引。

## Disable certificate based authentication and authorization 禁用基于证书的身份验证和授权

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-migration.asciidoc)

Only proceed with this step if the migration has been proved successful on the local cluster. If the migration is unsuccessful, either [find out what the problem is and attempt to fix it](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-troubleshooting.html) or [roll back](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-rollback).
仅当在本地集群上证明迁移成功时才继续执行此步骤。如果迁移不成功，请[找出问题所在并尝试修复它，](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-troubleshooting.html)或者[回滚](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-migrate.html#remote-clusters-migration-rollback)。

Next, disable the certification based connection. Optionally, you can also revoke the authorization.
接下来，禁用基于认证的连接。您也可以选择撤销授权。

1. There is no particular setting to enable or disable a certificate based cross cluster connection, because it shares the same transport protocol with the intra-cluster node-to-node communication.
   没有特定的设置来启用或禁用基于证书的跨集群连接，因为它与集群内节点到节点通信共享相同的传输协议。

   One way a remote cluster administrator can stop an existing local cluster from connecting, is by changing TLS trust. The exact steps vary, depending on how the clusters have been configured. A generic solution is to [recreate the CA and certificate/key used by the remote transport interface](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup.html#encrypt-internode-communication) so that any existing certificate/key, locally or distributed, is no longer trusted.
   远程集群管理员阻止现有本地集群连接的一种方法是更改​​ TLS 信任。确切的步骤会有所不同，具体取决于集群的配置方式。通用解决方案是[重新创建远程传输接口使用的 CA 和证书/密钥，](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup.html#encrypt-internode-communication)以便任何现有的本地或分布式证书/密钥不再受信任。

   Another solution is to apply IP filters to the transport interface, blocking traffic from outside the cluster.
   另一种解决方案是将 IP 过滤器应用于传输接口，阻止来自集群外部的流量。

2. Optionally, delete any roles on the remote cluster that were only used for cross-cluster operations. These roles are no longer used under the API key based security model. 
   或者，删除远程集群上仅用于跨集群操作的任何角色。在基于 API 密钥的安全模型下不再使用这些角色。

## Rollback 回滚

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-migration.asciidoc)

If you need to roll back, follow these steps on the local cluster:
如果需要回滚，请在本地集群上执行以下步骤：

1. Stop any persistent tasks that refer to the remote cluster. 
   停止引用远程集群的任何持久性任务。
2. Remove the remote cluster definition by setting the remote cluster settings to `null`. 
   通过将远程集群设置设置为`null`来删除远程集群定义。
3. Remove the `remote_indices` privileges from any roles that were updated during the migration. 
   从迁移期间更新的任何角色中删除`remote_indices`权限。
4. On each node, remove the `remote_cluster_client.ssl.*` settings from `elasticsearch.yml`. 
   在每个节点上，从`elasticsearch.yml`中删除`remote_cluster_client.ssl.*`设置。
5. Restart the local cluster to apply changes to the keystore and `elasticsearch.yml`. 
   重新启动本地集群以将更改应用到密钥库和`elasticsearch.yml` 。
6. On the local cluster, apply the original remote cluster settings. If the remote cluster connection has been configured statically (using the `elasticsearch.yml` file), restart the cluster. 
   在本地集群上，应用原始远程集群设置。如果远程集群连接已静态配置（使用`elasticsearch.yml`文件），请重新启动集群。
7. Use the [remote cluster info API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html) to verify that the local cluster has connected to the remote cluster. The response should have `"connected": true` and not have `"cluster_credentials": "::es_redacted::"`. 
   使用[远程集群信息 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html)验证本地集群是否已连接到远程集群。响应应该有`"connected": true`且没有 `"cluster_credentials": "::es_redacted::"` 。
8. Restart any persistent tasks that you’ve stopped earlier. 
   重新启动您之前停止的所有持久性任务。

# Remote cluster settings 远程集群设置

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-settings.asciidoc)

The following settings apply to both [sniff mode](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-mode) and [proxy mode](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#proxy-mode). Settings that are specific to sniff mode and proxy mode are described separately.
以下设置适用于[嗅探模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-mode)和[代理模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#proxy-mode)。特定于嗅探模式和代理模式的设置将单独描述。

- `cluster.remote.<cluster_alias>.mode`

  The mode used for a remote cluster connection. The only supported modes are `sniff` and `proxy`. The default is `sniff`. See [Connection modes](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-proxy-modes) for further information about these modes, and [Sniff mode remote cluster settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-settings.html#remote-cluster-sniff-settings) and [Proxy mode remote cluster settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-settings.html#remote-cluster-proxy-settings) for further information about their settings.  用于远程集群连接的模式。唯一支持的模式是`sniff`和`proxy` 。默认是`sniff` 。有关这些模式的更多信息，请参阅[连接模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-proxy-modes)；有关其设置的更多信息，请参阅[嗅探模式远程集群设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-settings.html#remote-cluster-sniff-settings)和[代理模式远程集群设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-settings.html#remote-cluster-proxy-settings)。

- `cluster.remote.initial_connect_timeout`

  The time to wait for remote connections to be established when the node starts. The default is `30s`.  节点启动时等待建立远程连接的时间。默认值为`30s` 。

- `remote_cluster_client` [role](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#node-roles) `remote_cluster_client`[角色](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#node-roles)

  By default, any node in the cluster can act as a cross-cluster client and connect to remote clusters. To prevent a node from connecting to remote clusters, specify the [node.roles](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#node-roles) setting in `elasticsearch.yml` and exclude `remote_cluster_client` from the listed roles. Search requests targeting remote clusters must be sent to a node that is allowed to act as a cross-cluster client. Other features such as machine learning [data feeds](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-settings.html#general-ml-settings), [transforms](https://www.elastic.co/guide/en/elasticsearch/reference/current/transform-settings.html#general-transform-settings), and [cross-cluster replication](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-getting-started-tutorial.html) require the `remote_cluster_client` role.  默认情况下，集群中的任何节点都可以充当跨集群客户端并连接到远程集群。要阻止节点连接到远程集群，请在`elasticsearch.yml`中指定[node.roles](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#node-roles)设置并从列出的角色中排除`remote_cluster_client` 。针对远程集群的搜索请求必须发送到允许充当跨集群客户端的节点。其他功能（例如机器学习[数据源](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-settings.html#general-ml-settings)、[转换](https://www.elastic.co/guide/en/elasticsearch/reference/current/transform-settings.html#general-transform-settings)和[跨集群复制）](https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-getting-started-tutorial.html)需要`remote_cluster_client`角色。

- `cluster.remote.<cluster_alias>.skip_unavailable`

  Per cluster boolean setting that allows to skip specific clusters when no nodes belonging to them are available and they are the target of a remote cluster request.  每个集群的布尔设置允许在没有属于特定集群的节点可用且它们是远程集群请求的目标时跳过特定集群。

In Elasticsearch 8.15, the default value for `skip_unavailable` was changed from `false` to `true`. Before Elasticsearch 8.15, if you want a cluster to be treated as optional for a cross-cluster search, then you need to set that configuration. From Elasticsearch 8.15 forward, you need to set the configuration in order to make a cluster required for the cross-cluster search. Once you upgrade the local ("querying") cluster search coordinator node (the node you send CCS requests to) to 8.15 or later, any remote clusters that do not have an explicit setting for `skip_unavailable` will immediately change over to using the new default of true. This is true regardless of whether you have upgraded the remote clusters to 8.15, as the `skip_unavailable` search behavior is entirely determined by the setting on the local cluster where you configure the remotes.
在 Elasticsearch 8.15 中， `skip_unavailable`的默认值从`false`更改为`true` 。在 Elasticsearch 8.15 之前，如果您希望将某个集群视为跨集群搜索的可选集群，则需要设置该配置。从Elasticsearch 8.15开始，您需要设置配置才能使跨集群搜索所需的集群。将本地（“查询”）集群搜索协调器节点（向其发送 CCS 请求的节点）升级到 8.15  或更高版本后，任何没有明确设置`skip_unavailable`的远程集群将立即切换为使用新的默认值真的。无论您是否已将远程集群升级到 8.15，情况都是如此，因为`skip_unavailable`搜索行为完全由您配置远程集群的本地集群上的设置决定。

- `cluster.remote.<cluster_alias>.transport.ping_schedule`

  Sets the time interval between regular application-level ping messages that are sent to try and keep remote cluster connections alive. If set to `-1`, application-level ping messages to this remote cluster are not sent. If unset, application-level ping messages are sent according to the global `transport.ping_schedule` setting, which defaults to `-1` meaning that pings are not sent. It is preferable to correctly configure TCP keep-alives instead of configuring a `ping_schedule`, because TCP keep-alives are handled by the operating system and not by Elasticsearch. By default Elasticsearch enables TCP keep-alives on remote cluster connections. Remote cluster connections are transport connections so the `transport.tcp.*` [advanced settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#transport-settings) regarding TCP keep-alives apply to them.  设置发送以尝试保持远程集群连接活动的常规应用程序级 ping 消息之间的时间间隔。如果设置为`-1` ，则不会向此远程集群发送应用程序级 ping 消息。如果未设置，则根据全局`transport.ping_schedule`设置发送应用程序级 ping 消息，默认为`-1`表示不发送 ping。最好正确配置 TCP keep-alive，而不是配置`ping_schedule` ，因为 TCP keep-alive 是由操作系统处理的，而不是由 Elasticsearch 处理的。默认情况下，Elasticsearch 在远程集群连接上启用 TCP 保持活动状态。远程集群连接是传输连接，因此有关 TCP 保持活动的`transport.tcp.*`[高级设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#transport-settings)适用于它们。

- `cluster.remote.<cluster_alias>.transport.compress`

  Per-cluster setting that enables you to configure compression for requests to a specific remote cluster. The handling cluster will automatically compress responses to compressed requests. The setting options are `true`, `indexing_data`, and `false`. If unset, defaults to the behaviour specified by the node-wide `transport.compress` setting. See the [documentation for the `transport.compress` setting](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#transport-settings-compress) for further information.  每个集群设置使您能够为特定远程集群的请求配置压缩。处理集群将自动压缩对压缩请求的响应。设置选项为`true` 、 `indexing_data`和`false` 。如果未设置，则默认为节点范围内的`transport.compress`设置指定的行为。有关详细信息，请参阅[`transport.compress`设置的文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#transport-settings-compress)。

- `cluster.remote.<cluster_alias>.transport.compression_scheme`

  Per-cluster setting that enables you to configure the compression scheme for requests to a specific cluster if those requests are selected to be compressed by to the `cluster.remote.<cluster_alias>.transport.compress` setting. The handling cluster will automatically use the same compression scheme for responses as for the corresponding requests. The setting options are `deflate` and `lz4`. If unset, defaults to the behaviour specified by the node-wide `transport.compression_scheme` setting. See the [documentation for the `transport.compression_scheme` setting](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#transport-settings-compression-scheme) for further information.  每个集群设置使您能够为特定集群的请求配置压缩方案（如果选择将这些请求压缩到 `cluster.remote.<cluster_alias>.transport.compress` 环境。处理集群将自动使用与相应请求相同的压缩方案来进行响应。设置选项为`deflate`和`lz4` 。如果未设置，则默认为节点范围内的`transport.compression_scheme`设置指定的行为。有关更多信息，请参阅[`transport.compression_scheme`设置的文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#transport-settings-compression-scheme)。



- `cluster.remote.<cluster_alias>.credentials`

  ([Secure](https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-settings.html), [Reloadable](https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-settings.html#reloadable-secure-settings)) Per-cluster setting for configuring [remote clusters with the API Key based model](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html). This setting takes the encoded value of a [cross-cluster API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html) and must be set in the [Elasticsearch keystore](https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-settings.html) on each node in the cluster. The presence (or not) of this setting determines which model a remote cluster uses. If present, the remote cluster uses the API key based model. Otherwise, it uses the certificate based model. If the setting is added, removed, or updated in the [Elasticsearch keystore](https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-settings.html) and reloaded via the [Nodes reload secure settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html) API, the cluster will automatically rebuild its connection to the remote.  （[安全](https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-settings.html)、[可重新加载](https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-settings.html#reloadable-secure-settings)）每个集群设置，用于[使用基于 API 密钥的模型配置远程集群](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html)。此设置采用[跨集群 API 密钥](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html)的编码值，并且必须在集群中每个节点上的[Elasticsearch 密钥库](https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-settings.html)中进行设置。此设置的存在（或不存在）决定远程集群使用哪种模型。如果存在，远程集群将使用基于 API 密钥的模型。否则，它使用基于证书的模型。如果在[Elasticsearch 密钥库](https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-settings.html)中添加、删除或更新设置并通过[节点重新加载安全设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html)API 重新加载，集群将自动重建与远程的连接。

## Sniff mode remote cluster settings 嗅探模式远程集群设置

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-settings.asciidoc)

To use [sniff mode](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-mode) to connect to a remote cluster, set `cluster.remote.<cluster_alias>.mode: sniff` and then configure the following settings. You may also leave `cluster.remote.<cluster_alias>.mode` unset since `sniff` is the default mode.
要使用[嗅探模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#sniff-mode)连接到远程集群，请设置 `cluster.remote.<cluster_alias>.mode: sniff` 然后配置以下设置。你也可以离开 `cluster.remote.<cluster_alias>.mode` 未设置，因为`sniff`是默认模式。

- `cluster.remote.<cluster_alias>.seeds`

  The list of seed nodes used to sniff the remote cluster state.  用于嗅探远程集群状态的种子节点列表。

- `cluster.remote.<cluster_alias>.node_connections`

  The number of gateway nodes to connect to for this remote cluster. The default is `3`.  此远程集群要连接到的网关节点的数量。默认值为`3` 。



- `cluster.remote.node.attr`

  A node attribute to filter out nodes that are eligible as a gateway node in the remote cluster. For instance a node can have a node attribute `node.attr.gateway: true` such that only nodes with this attribute will be connected to if `cluster.remote.node.attr` is set to `gateway`.  用于过滤出有资格作为远程集群中网关节点的节点的节点属性。例如，节点可以具有节点属性`node.attr.gateway: true` ，这样，如果`cluster.remote.node.attr`设置为`gateway` ，则只有具有此属性的节点才会连接到。

## Proxy mode remote cluster settings 代理模式远程集群设置

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-settings.asciidoc)

To use [proxy mode](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#proxy-mode) to connect to a remote cluster, set `cluster.remote.<cluster_alias>.mode: proxy` and then configure the following settings.
要使用[代理模式](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters.html#proxy-mode)连接到远程集群，请设置 `cluster.remote.<cluster_alias>.mode: proxy` 然后配置以下设置。

- `cluster.remote.<cluster_alias>.proxy_address`

  The address used for all remote connections.  用于所有远程连接的地址。

- `cluster.remote.<cluster_alias>.proxy_socket_connections`

  The number of socket connections to open per remote cluster. The default is `18`.  每个远程集群打开的套接字连接数。默认值为`18` 。

- `cluster.remote.<cluster_alias>.server_name`

  An optional hostname string which is sent in the `server_name` field of the TLS Server Name Indication extension if [TLS is enabled](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup.html#encrypt-internode-communication). The TLS transport will fail to open remote connections if this field is not a valid hostname as defined by the TLS SNI specification.  如果[启用了 TLS](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup.html#encrypt-internode-communication) ，则在 TLS 服务器名称指示扩展的`server_name`字段中发送可选的主机名字符串。如果此字段不是 TLS SNI 规范定义的有效主机名，则 TLS 传输将无法打开远程连接。

# Troubleshooting remote clusters 远程集群故障排除

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

You may encounter several issues when setting up a remote cluster for cross-cluster replication or cross-cluster search.
设置远程集群以进行跨集群复制或跨集群搜索时，您可能会遇到几个问题。

## General troubleshooting 一般故障排除

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

### Checking whether a remote cluster has connected successfully 检查远程集群是否连接成功

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

A successful call to the cluster settings update API for adding or updating remote clusters does not necessarily mean the configuration is successful. Use the [remote cluster info API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html) to verify that a local cluster is successfully connected to a remote cluster.
成功调用集群设置更新API来添加或更新远程集群并不一定意味着配置成功。使用[远程集群信息API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html)验证本地集群是否成功连接到远程集群。



```console
GET /_remote/info
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/77.console) 

The API should return `"connected" : true`. When using [API key authentication](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html), it should also return `"cluster_credentials": "::es_redacted::"`.
API 应返回`"connected" : true` 。当使用[API​​密钥认证](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html)时，它还应该返回 `"cluster_credentials": "::es_redacted::"` 。



```console-result
{
  "cluster_one" : {
    "seeds" : [
      "127.0.0.1:9443"
    ],
    "connected" : true, 
    "num_nodes_connected" : 1,
    "max_connections_per_cluster" : 3,
    "initial_connect_timeout" : "30s",
    "skip_unavailable" : false,
    "cluster_credentials": "::es_redacted::", 
    "mode" : "sniff"
  }
}
```

|      | The remote cluster has connected successfully. 远程集群已连接成功。 |
| ---- | ------------------------------------------------------------ |
|      | If present, indicates the remote cluster has connected using [API key authentication](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html) instead of [certificate based authentication](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-cert.html). 如果存在，则表示远程集群已使用[API 密钥身份验证](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html)而不是[基于证书的身份验证](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-cert.html)进行连接。 |

### Enabling the remote cluster server 启用远程集群服务器

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

When using API key authentication, cross-cluster traffic happens on the remote cluster interface, instead of the transport interface. The remote cluster interface is not enabled by default. This means a node is not ready to accept incoming cross-cluster requests by default, while it is ready to send outgoing cross-cluster requests. Ensure you’ve enabled the remote cluster server on every node of the remote cluster. In `elasticsearch.yml`:
使用 API 密钥身份验证时，跨集群流量发生在远程集群接口上，而不是传输接口上。默认情况下，远程集群接口未启用。这意味着默认情况下节点未准备好接受传入的跨集群请求，但已准备好发送传出的跨集群请求。确保您已在远程集群的每个节点上启用远程集群服务器。在`elasticsearch.yml`中：

- Set [`remote_cluster_server.enabled`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings) to `true`. 
  将[`remote_cluster_server.enabled`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings)设置为`true` 。
- Configure the bind and publish address for remote cluster server traffic, for example using [`remote_cluster.host`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings). Without configuring the address, remote cluster traffic may be bound to the local interface, and remote clusters running on other machines can’t connect. 
  配置远程集群服务器流量的绑定和发布地址，例如使用[`remote_cluster.host`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote-cluster-network-settings) 。如果不配置地址，远程集群流量可能会绑定到本地接口，而运行在其他机器上的远程集群无法连接。
- Optionally, configure the remote server port using [`remote_cluster.port`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote_cluster.port) (defaults to `9443`). 
  （可选）使用[`remote_cluster.port`](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#remote_cluster.port) （默认为`9443` ）配置远程服务器端口。

## Common issues 常见问题

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

The following issues are listed in the order they may occur while setting up a remote cluster.
以下问题按设置远程集群时可能发生的顺序列出。

### Remote cluster not reachable 远程集群无法访问

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

#### Symptom 症状

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

A local cluster may not be able to reach a remote cluster for many reasons. For example, the remote cluster server may not be enabled, an incorrect host or port may be configured, or a firewall may be blocking traffic. When a remote cluster is not reachable, check the logs of the local cluster for a `connect_exception`.
由于多种原因，本地集群可能无法访问远程集群。例如，远程集群服务器可能未启用，可能配置了不正确的主机或端口，或者防火墙可能阻止流量。当无法访问远程集群时，请检查本地集群的日志中是否有`connect_exception` 。

When the remote cluster is configured using proxy mode:
当远程集群配置为代理模式时：

```txt
[2023-06-28T16:36:47,264][WARN ][o.e.t.ProxyConnectionStrategy] [local-node] failed to open any proxy connections to cluster [my]
org.elasticsearch.transport.ConnectTransportException: [][192.168.0.42:9443] connect_exception
```

When the remote cluster is configured using sniff mode:
当远程集群配置为使用嗅探模式时：

```txt
[2023-06-28T16:38:37,731][WARN ][o.e.t.SniffConnectionStrategy] [local-node] fetching nodes from external cluster [my] failed
org.elasticsearch.transport.ConnectTransportException: [][192.168.0.42:9443] connect_exception
```

#### Resolution 解决

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

- Check the host and port for the remote cluster are correct. 
  检查远程集群的主机和端口是否正确。
- Ensure the [remote cluster server is enabled](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-troubleshooting.html#remote-clusters-troubleshooting-enable-server) on the remote cluster. 
  确保远程集群上[启用了远程集群服务器](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-troubleshooting.html#remote-clusters-troubleshooting-enable-server)。
- Ensure no firewall is blocking the communication. 
  确保没有防火墙阻止通信。

### Remote cluster connection is unreliable 远程集群连接不可靠

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

#### Symptom 症状

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

The local cluster can connect to the remote cluster, but the connection does not work reliably. For example, some cross-cluster requests may succeed while others report connection errors, time out, or appear to be stuck waiting for the remote cluster to respond.
本地集群可以连接到远程集群，但连接不可靠。例如，某些跨集群请求可能会成功，而其他跨集群请求可能会报告连接错误、超时或似乎陷入等待远程集群响应的状态。

When Elasticsearch detects that the remote cluster connection is not working, it will report the following message in its logs:
当Elasticsearch检测到远程集群连接不工作时，它会在日志中报告以下消息：

```txt
[2023-06-28T16:36:47,264][INFO ][o.e.t.ClusterConnectionManager] [local-node] transport connection to [{my-remote#192.168.0.42:9443}{...}] closed by remote
```

This message will also be logged if the node of the remote cluster to which Elasticsearch is connected is shut down or restarted.
如果 Elasticsearch 连接的远程集群的节点关闭或重新启动，也会记录此消息。

Note that with some network configurations it could take minutes or hours for the operating system to detect that a connection has stopped working. Until the failure is detected and reported to Elasticsearch, requests involving the remote cluster may time out or may appear to be stuck.
请注意，对于某些网络配置，操作系统可能需要几分钟或几小时才能检测到连接已停止工作。在检测到故障并将其报告给 Elasticsearch 之前，涉及远程集群的请求可能会超时或可能会被卡住。

#### Resolution 解决

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

- Ensure that the network between the clusters is as reliable as possible. 
  确保集群之间的网络尽可能可靠。
- Ensure that the network is configured to permit [Long-lived idle connections](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections). 
  确保网络配置为允许[长期空闲连接](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html#long-lived-connections)。
- Ensure that the network is configured to detect faulty connections quickly. In particular, you must enable and fully support TCP keepalives, and set a short [retransmission timeout](https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config-tcpretries.html). 
  确保网络配置为快速检测故障连接。特别是，您必须启用并完全支持 TCP keepalive，并设置较短的[重传超时](https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config-tcpretries.html)。
- On Linux systems, execute `ss -tonie` to verify the details of the configuration of each network connection between the clusters. 
  在 Linux 系统上，执行`ss -tonie`来验证集群之间每个网络连接的配置详细信息。
- If the problems persist, capture network packets at both ends of the connection and analyse the traffic to look for delays and lost messages. 
  如果问题仍然存在，请捕获连接两端的网络数据包并分析流量以查找延迟和丢失的消息。

### TLS trust not established 未建立 TLS 信任

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

TLS can be misconfigured on the local or the remote cluster. The result is that the local cluster does not trust the certificate presented by the remote cluster.
本地或远程集群上的 TLS 可能配置错误。结果是本地集群不信任远程集群提供的证书。

#### Symptom 症状

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

The local cluster logs `failed to establish trust with server`:
本地集群日志 `failed to establish trust with server` ：

```txt
[2023-06-29T09:40:55,465][WARN ][o.e.c.s.DiagnosticTrustManager] [local-node] failed to establish trust with server at [192.168.0.42]; the server provided a certificate with subject name [CN=remote_cluster], fingerprint [529de35e15666ffaa26afa50876a2a48119db03a], no keyUsage and no extendedKeyUsage; the certificate is valid between [2023-01-29T12:08:37Z] and [2032-08-29T12:08:37Z] (current time is [2023-08-16T23:40:55.464275Z], certificate dates are valid); the session uses cipher suite [TLS_AES_256_GCM_SHA384] and protocol [TLSv1.3]; the certificate has subject alternative names [DNS:localhost,DNS:localhost6.localdomain6,IP:127.0.0.1,IP:0:0:0:0:0:0:0:1,DNS:localhost4,DNS:localhost6,DNS:localhost.localdomain,DNS:localhost4.localdomain4,IP:192.168.0.42]; the certificate is issued by [CN=Elastic Auto RemoteCluster CA] but the server did not provide a copy of the issuing certificate in the certificate chain; this ssl context ([(shared) (with trust configuration: JDK-trusted-certs)]) is not configured to trust that issuer but trusts [97] other issuers
sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target
```

The remote cluster logs `client did not trust this server's certificate`:
远程集群日志 `client did not trust this server's certificate` ：

```txt
[2023-06-29T09:40:55,478][WARN ][o.e.x.c.s.t.n.SecurityNetty4Transport] [remote-node] client did not trust this server's certificate, closing connection Netty4TcpChannel{localAddress=/192.168.0.42:9443, remoteAddress=/192.168.0.84:57305, profile=_remote_cluster}
```

#### Resolution 解决

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

Read the warn log message on the local cluster carefully to determine the exact cause of the failure. For example:
仔细阅读本地集群上的警告日志消息，以确定失败的确切原因。例如：

- Is the remote cluster certificate not signed by a trusted CA? This is the most likely cause. 
  远程集群证书是否未经可信 CA 签名？这是最有可能的原因。
- Is hostname verification failing? 
  主机名验证失败？
- Is the certificate expired? 
  证书过期了吗？

Once you know the cause, you should be able to fix it by adjusting the remote cluster related SSL settings on either the local cluster or the remote cluster.
一旦知道原因，您应该能够通过调整本地集群或远程集群上与远程集群相关的 SSL 设置来修复它。

Often, the issue is on the local cluster. For example, fix it by configuring necessary trusted CAs (`xpack.security.remote_cluster_client.ssl.certificate_authorities`).
通常，问题出在本地集群上。例如，通过配置必要的可信 CA 来修复它（ `xpack.security.remote_cluster_client.ssl.certificate_authorities` ）。

If you change the `elasticsearch.yml` file, the associated cluster needs to be restarted for the changes to take effect.
如果更改`elasticsearch.yml`文件，则需要重新启动关联的集群才能使更改生效。

## API key authentication issues API密钥认证问题

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

### Connecting to transport port when using API key authentication 使用 API 密钥身份验证时连接到传输端口

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

When using API key authentication, a local cluster should connect to a remote cluster’s remote cluster server port (defaults to `9443`) instead of the transport port (defaults to `9300`). A misconfiguration can lead to a number of symptoms:
使用 API 密钥身份验证时，本地集群应连接到远程集群的远程集群服务器端口（默认为`9443` ）而不是传输端口（默认为`9300` ）。配置错误可能会导致许多症状：

#### Symptom 1 症状1

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

It’s recommended to use different CAs and certificates for the transport interface and the remote cluster server interface. If this recommendation is followed, a remote cluster client node does not trust the server certificate presented by a remote cluster on the transport interface.
建议对传输接口和远程集群服务器接口使用不同的 CA 和证书。如果遵循此建议，远程集群客户端节点将不信任远程集群在传输接口上提供的服务器证书。

The local cluster logs `failed to establish trust with server`:
本地集群日志 `failed to establish trust with server` ：

```txt
[2023-06-28T12:48:46,575][WARN ][o.e.c.s.DiagnosticTrustManager] [local-node] failed to establish trust with server at [1192.168.0.42]; the server provided a certificate with subject name [CN=transport], fingerprint [c43e628be2a8aaaa4092b82d78f2bc206c492322], no keyUsage and no extendedKeyUsage; the certificate is valid between [2023-01-29T12:05:53Z] and [2032-08-29T12:05:53Z] (current time is [2023-06-28T02:48:46.574738Z], certificate dates are valid); the session uses cipher suite [TLS_AES_256_GCM_SHA384] and protocol [TLSv1.3]; the certificate has subject alternative names [DNS:localhost,DNS:localhost6.localdomain6,IP:127.0.0.1,IP:0:0:0:0:0:0:0:1,DNS:localhost4,DNS:localhost6,DNS:localhost.localdomain,DNS:localhost4.localdomain4,IP:192.168.0.42]; the certificate is issued by [CN=Elastic Auto Transport CA] but the server did not provide a copy of the issuing certificate in the certificate chain; this ssl context ([xpack.security.remote_cluster_client.ssl (with trust configuration: PEM-trust{/rcs2/ssl/remote-cluster-ca.crt})]) is not configured to trust that issuer, it only trusts the issuer [CN=Elastic Auto RemoteCluster CA] with fingerprint [ba2350661f66e46c746c1629f0c4b645a2587ff4]
sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target
```

The remote cluster logs `client did not trust this server's certificate`:
远程集群日志 `client did not trust this server's certificate` ：

```txt
[2023-06-28T12:48:46,584][WARN ][o.e.x.c.s.t.n.SecurityNetty4Transport] [remote-node] client did not trust this server's certificate, closing connection Netty4TcpChannel{localAddress=/192.168.0.42:9309, remoteAddress=/192.168.0.84:60810, profile=default}
```

#### Symptom 2 症状2

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

The CA and certificate can be shared between the transport and remote cluster server interface. Since a remote cluster client does not have a client certificate by default, the server will fail to verify the client certificate.
CA 和证书可以在传输和远程集群服务器接口之间共享。由于远程集群客户端默认没有客户端证书，因此服务器将无法验证客户端证书。

The local cluster logs `Received fatal alert: bad_certificate`:
本地集群日志 `Received fatal alert: bad_certificate` ：

```txt
[2023-06-28T12:43:30,705][WARN ][o.e.t.TcpTransport       ] [local-node] exception caught on transport layer [Netty4TcpChannel{localAddress=/192.168.0.84:60738, remoteAddress=/192.168.0.42:9309, profile=_remote_cluster}], closing connection
io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate
```

The remote cluster logs `Empty client certificate chain`:
远程集群日志 `Empty client certificate chain` ：

```txt
[2023-06-28T12:43:30,772][WARN ][o.e.t.TcpTransport       ] [remote-node] exception caught on transport layer [Netty4TcpChannel{localAddress=/192.168.0.42:9309, remoteAddress=/192.168.0.84:60783, profile=default}], closing connection
io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: Empty client certificate chain
```

#### Symptom 3 症状3

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

If the remote cluster client is configured for mTLS and provides a valid client certificate, the connection fails because the client does not send the expected authentication header.
如果远程集群客户端配置了 mTLS 并提供了有效的客户端证书，则连接会失败，因为客户端未发送预期的身份验证标头。

The local cluster logs `missing authentication`:
本地集群记录`missing authentication` ：

```txt
[2023-06-28T13:04:52,710][WARN ][o.e.t.ProxyConnectionStrategy] [local-node] failed to open any proxy connections to cluster [my]
org.elasticsearch.transport.RemoteTransportException: [remote-node][192.168.0.42:9309][cluster:internal/remote_cluster/handshake]
Caused by: org.elasticsearch.ElasticsearchSecurityException: missing authentication credentials for action [cluster:internal/remote_cluster/handshake]
```

This does not show up in the logs of the remote cluster.
这不会显示在远程集群的日志中。

#### Symptom 4 症状4

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

If anonymous access is enabled on the remote cluster and it does not require authentication, depending on the privileges of the anonymous user, the local cluster may log the following.
如果在远程集群上启用了匿名访问并且不需要身份验证，则根据匿名用户的权限，本地集群可能会记录以下内容。

If the anonymous user does not the have necessary privileges to make a connection, the local cluster logs `unauthorized`:
如果匿名用户没有建立连接所需的权限，则本地集群会记录`unauthorized` ：

```txt
org.elasticsearch.transport.RemoteTransportException: [remote-node][192.168.0.42:9309][cluster:internal/remote_cluster/handshake]
Caused by: org.elasticsearch.ElasticsearchSecurityException: action [cluster:internal/remote_cluster/handshake] is unauthorized for user [anonymous_foo] with effective roles [reporting_user], this action is granted by the cluster privileges [cross_cluster_search,cross_cluster_replication,manage,all]
```

If the anonymous user has necessary privileges, for example it is a superuser, the local cluster logs `requires channel profile to be [_remote_cluster], but got [default]`:
如果匿名用户具有必要的权限，例如它是超级用户， 本地集群日志 `requires channel profile to be [_remote_cluster], but got [default]` ：

```txt
[2023-06-28T13:09:52,031][WARN ][o.e.t.ProxyConnectionStrategy] [local-node] failed to open any proxy connections to cluster [my]
org.elasticsearch.transport.RemoteTransportException: [remote-node][192.168.0.42:9309][cluster:internal/remote_cluster/handshake]
Caused by: java.lang.IllegalArgumentException: remote cluster handshake action requires channel profile to be [_remote_cluster], but got [default]
```

#### Resolution 解决

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

Check the port number and ensure you are indeed connecting to the remote cluster server instead of the transport interface.
检查端口号并确保您确实连接到远程集群服务器而不是传输接口。

### Connecting without a cross-cluster API key 无需跨集群 API 密钥即可连接

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

A local cluster uses the presence of a cross-cluster API key to determine the model with which it connects to a remote cluster. If a cross-cluster API key is present, it uses API key based authentication. Otherwise, it uses certificate based authentication. You can check what model is being used with the [remote cluster info API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html) on the local cluster:
本地集群使用跨集群 API 密钥来确定连接到远程集群所使用的模型。如果存在跨集群 API 密钥，它将使用基于 API 密钥的身份验证。否则，它使用基于证书的身份验证。您可以通过本地集群上的[远程集群信息 API](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html)检查正在使用什么模型：



```console
GET /_remote/info
```

Copy as curl 复制为卷曲[Try in Elastic 尝试使用弹性](http://localhost:5601/zzz/app/kibana#/dev_tools/console?load_from=https://www.elastic.co/guide/en/elasticsearch/reference/current/snippets/78.console) 

The API should return `"connected" : true`. When using [API key authentication](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html), it should also return `"cluster_credentials": "::es_redacted::"`.
API 应返回`"connected" : true` 。当使用[API​​密钥认证](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html)时，它还应该返回 `"cluster_credentials": "::es_redacted::"` 。



```console-result
{
  "cluster_one" : {
    "seeds" : [
      "127.0.0.1:9443"
    ],
    "connected" : true, 
    "num_nodes_connected" : 1,
    "max_connections_per_cluster" : 3,
    "initial_connect_timeout" : "30s",
    "skip_unavailable" : false,
    "cluster_credentials": "::es_redacted::", 
    "mode" : "sniff"
  }
}
```

|      | The remote cluster has connected successfully. 远程集群已连接成功。 |
| ---- | ------------------------------------------------------------ |
|      | If present, indicates the remote cluster has connected using [API key authentication](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html) instead of [certificate based authentication](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-cert.html). 如果存在，则表示远程集群已使用[API 密钥身份验证](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-api-key.html)而不是[基于证书的身份验证](https://www.elastic.co/guide/en/elasticsearch/reference/current/remote-clusters-cert.html)进行连接。 |

Besides checking the response of the remote cluster info API, you can also check the logs.
除了检查远程集群信息 API 的响应之外，您还可以检查日志。

#### Symptom 1 症状1

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

If no cross-cluster API key is used, the local cluster uses the certificate based authentication method, and connects to the remote cluster using the TLS configuration of the transport interface. If the remote cluster has different TLS CA and certificate for transport and remote cluster server interfaces (which is the recommendation), TLS verification will fail.
如果不使用跨集群 API 密钥，本地集群将使用基于证书的身份验证方法，并使用传输接口的 TLS 配置连接到远程集群。如果远程集群对于传输和远程集群服务器接口具有不同的 TLS CA 和证书（这是建议），则 TLS 验证将失败。

The local cluster logs `failed to establish trust with server`:
本地集群日志 `failed to establish trust with server` ：

```txt
[2023-06-28T12:51:06,452][WARN ][o.e.c.s.DiagnosticTrustManager] [local-node] failed to establish trust with server at [<unknown host>]; the server provided a certificate with subject name [CN=remote_cluster], fingerprint [529de35e15666ffaa26afa50876a2a48119db03a], no keyUsage and no extendedKeyUsage; the certificate is valid between [2023-01-29T12:08:37Z] and [2032-08-29T12:08:37Z] (current time is [2023-06-28T02:51:06.451581Z], certificate dates are valid); the session uses cipher suite [TLS_AES_256_GCM_SHA384] and protocol [TLSv1.3]; the certificate has subject alternative names [DNS:localhost,DNS:localhost6.localdomain6,IP:127.0.0.1,IP:0:0:0:0:0:0:0:1,DNS:localhost4,DNS:localhost6,DNS:localhost.localdomain,DNS:localhost4.localdomain4,IP:192.168.0.42]; the certificate is issued by [CN=Elastic Auto RemoteCluster CA] but the server did not provide a copy of the issuing certificate in the certificate chain; this ssl context ([xpack.security.transport.ssl (with trust configuration: PEM-trust{/rcs2/ssl/transport-ca.crt})]) is not configured to trust that issuer, it only trusts the issuer [CN=Elastic Auto Transport CA] with fingerprint [bbe49e3f986506008a70ab651b188c70df104812]
sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target
```

The remote cluster logs `client did not trust this server's certificate`:
远程集群日志 `client did not trust this server's certificate` ：

```txt
[2023-06-28T12:52:16,914][WARN ][o.e.x.c.s.t.n.SecurityNetty4Transport] [remote-node] client did not trust this server's certificate, closing connection Netty4TcpChannel{localAddress=/192.168.0.42:9443, remoteAddress=/192.168.0.84:60981, profile=_remote_cluster}
```

#### Symptom 2 症状2

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

Even if TLS verification is not an issue, the connection fails due to missing credentials.
即使 TLS 验证不是问题，连接也会因缺少凭据而失败。

The local cluster logs `Please ensure you have configured remote cluster credentials`:
本地集群日志 `Please ensure you have configured remote cluster credentials` ：

```txt
Caused by: java.lang.IllegalArgumentException: Cross cluster requests through the dedicated remote cluster server port require transport header [_cross_cluster_access_credentials] but none found. Please ensure you have configured remote cluster credentials on the cluster originating the request.
```

This does not show up in the logs of the remote cluster.
这不会显示在远程集群的日志中。

#### Resolution 解决

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

Add the cross-cluster API key to Elasticsearch keystore on every node of the local cluster. Use the [Nodes reload secure settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html) API to reload the keystore.
将跨集群 API 密钥添加到本地集群每个节点上的 Elasticsearch 密钥库。使用[节点重新加载安全设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html)API 来重新加载密钥库。

### Using the wrong API key type 使用错误的 API 密钥类型

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

API key based authentication requires [cross-cluster API keys](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html). It does not work with [REST API keys](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-api-key.html).
基于 API 密钥的身份验证需要[跨集群 API 密钥](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html)。它不适用于[REST API 密钥](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-api-key.html)。

#### Symptom 症状

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

The local cluster logs `authentication expected API key type of [cross_cluster]`:
本地集群日志 `authentication expected API key type of [cross_cluster]` ：

```txt
[2023-06-28T13:26:53,962][WARN ][o.e.t.ProxyConnectionStrategy] [local-node] failed to open any proxy connections to cluster [my]
org.elasticsearch.transport.RemoteTransportException: [remote-node][192.168.0.42:9443][cluster:internal/remote_cluster/handshake]
Caused by: org.elasticsearch.ElasticsearchSecurityException: authentication expected API key type of [cross_cluster], but API key [agZXJocBmA2beJfq2yKu] has type [rest]
```

This does not show up in the logs of the remote cluster.
这不会显示在远程集群的日志中。

#### Resolution 解决

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

Ask the remote cluster administrator to create and distribute a [cross-cluster API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html). Replace the existing API key in the Elasticsearch keystore with this cross-cluster API key on every node of the local cluster. Use the [Nodes reload secure settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html) API to reload the keystore.
要求远程集群管理员创建并分发[跨集群 API 密钥](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html)。在本地集群的每个节点上，将 Elasticsearch 密钥库中的现有 API 密钥替换为此跨集群 API 密钥。使用[节点重新加载安全设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html)API 来重新加载密钥库。

### Invalid API key API 密钥无效

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

A cross-cluster API can fail to authenticate. For example, when its credentials are incorrect, or if it’s invalidated or expired.
跨集群 API 可能无法进行身份验证。例如，当其凭据不正确，或者其无效或过期时。

#### Symptom 症状

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

The local cluster logs `unable to authenticate`:
本地集群日志`unable to authenticate` ：

```txt
[2023-06-28T13:22:58,264][WARN ][o.e.t.ProxyConnectionStrategy] [local-node] failed to open any proxy connections to cluster [my]
org.elasticsearch.transport.RemoteTransportException: [remote-node][192.168.0.42:9443][cluster:internal/remote_cluster/handshake]
Caused by: org.elasticsearch.ElasticsearchSecurityException: unable to authenticate user [agZXJocBmA2beJfq2yKu] for action [cluster:internal/remote_cluster/handshake]
```

The remote cluster logs `Authentication using apikey failed`:
远程集群日志 `Authentication using apikey failed` ：

```txt
[2023-06-28T13:24:38,744][WARN ][o.e.x.s.a.ApiKeyAuthenticator] [remote-node] Authentication using apikey failed - invalid credentials for API key [agZXJocBmA2beJfq2yKu]
```

#### Resolution 解决

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

Ask the remote cluster administrator to create and distribute a [cross-cluster API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html). Replace the existing API key in the Elasticsearch keystore with this cross-cluster API key on every node of the local cluster. Use the [Nodes reload secure settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html) API to reload the keystore.
要求远程集群管理员创建并分发[跨集群 API 密钥](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html)。在本地集群的每个节点上，将 Elasticsearch 密钥库中的现有 API 密钥替换为此跨集群 API 密钥。使用[节点重新加载安全设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html)API 来重新加载密钥库。

### API key or local user has insufficient privileges API密钥或本地用户权限不足

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

The effective permission for a local user running requests on a remote cluster is determined by the intersection of the cross-cluster API key’s privileges and the local user’s `remote_indices` privileges.
本地用户在远程集群上运行请求的有效权限由跨集群API密钥的权限和本地用户的`remote_indices`权限的交集确定。

#### Symptom 症状

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

Request failures due to insufficient privileges result in API responses like:
由于权限不足而导致请求失败，会导致 API 响应如下：

```js
{
    "type": "security_exception",
    "reason": "action [indices:data/read/search] towards remote cluster is unauthorized for user [foo] with assigned roles [foo-role] authenticated by API key id [agZXJocBmA2beJfq2yKu] of user [elastic-admin] on indices [cd], this action is granted by the index privileges [read,all]"
}
```

This does not show up in any logs.
这不会显示在任何日志中。

#### Resolution 解决

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

1. Check that the local user has the necessary `remote_indices` privileges. Grant sufficient `remote_indices` privileges if necessary. 
   检查本地用户是否具有必要的`remote_indices`权限。如有必要，请授予足够的`remote_indices`权限。
2. If permission is not an issue locally, ask the remote cluster administrator to create and distribute a [cross-cluster API key](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html). Replace the existing API key in the Elasticsearch keystore with this cross-cluster API key on every node of the local cluster. Use the [Nodes reload secure settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html) API to reload the keystore. 
   如果本地权限不是问题，请要求远程集群管理员创建并分发[跨集群 API 密钥](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-cross-cluster-api-key.html)。在本地集群的每个节点上，将 Elasticsearch 密钥库中的现有 API 密钥替换为此跨集群 API 密钥。使用[节点重新加载安全设置](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-reload-secure-settings.html)API 来重新加载密钥库。

### Local user has no `remote_indices` privileges 本地用户没有`remote_indices`权限

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

This is a special case of insufficient privileges. In this case, the local user has no `remote_indices` privileges at all for the target remote cluster. Elasticsearch can detect that and issue a more explicit error response.
这是权限不足的特例。在这种情况下，本地用户对于目标远程集群根本没有`remote_indices`权限。 Elasticsearch 可以检测到这一点并发出更明确的错误响应。

#### Symptom 症状

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

This results in API responses like:
这会导致 API 响应如下：

```js
{
    "type": "security_exception",
    "reason": "action [indices:data/read/search] towards remote cluster [my] is unauthorized for user [foo] with effective roles [] (assigned roles [foo-role] were not found) because no remote indices privileges apply for the target cluster"
}
```

#### Resolution 解决

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc)

Grant sufficient `remote_indices` privileges to the local user.
向本地用户授予足够的`remote_indices`权限。

# Plugins 插件

[edit 编辑](https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/modules/plugins.asciidoc)

Plugins are a way to enhance the basic Elasticsearch functionality in a custom manner. They range from adding custom mapping types, custom analyzers (in a more built in fashion), custom script engines, custom discovery and more.
插件是一种以自定义方式增强基本 Elasticsearch 功能的方法。它们的范围包括添加自定义映射类型、自定义分析器（以更内置的方式）、自定义脚本引擎、自定义发现等等。

For information about selecting and installing plugins, see [Elasticsearch Plugins and Integrations](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/index.html).
有关选择和安装插件的信息，请参阅[Elasticsearch 插件和集成](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/index.html)。

For information about developing your own plugin, see [Help for plugin authors](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/plugin-authors.html).
有关开发您自己的插件的信息，请参阅[插件作者帮助](https://www.elastic.co/guide/en/elasticsearch/plugins/8.15/plugin-authors.html)。